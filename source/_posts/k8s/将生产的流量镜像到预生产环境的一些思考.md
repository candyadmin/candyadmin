---
title: 将生产的流量镜像到预生产环境的一些思考
date: 2025-06-24 15:06:47
tags: k8s
categories: 生产环境
---
在生产环境中将流量复制（或称**流量镜像**、**shadow traffic / traffic mirroring**）到预生产环境，是一种非常常见的**预发布验证、压测、安全测试手段**。

下面是一个完整的实现方案，包含多个常见做法、工具和注意事项。

---

## 🧭 一、核心目标

* **从生产环境获取真实请求流量**
* **将流量同时复制一份（不影响真实用户）**
* **发送到预生产环境的服务进行验证或压测**
* **预生产环境的返回值不影响真实用户**

---

## 🧰 二、可选方案汇总（推荐方式在前）

| 方法                                          | 是否推荐 | 说明                  |
| ------------------------------------------- | ---- | ------------------- |
| ✅ **使用服务网关流量镜像功能（如 Envoy、Istio）**           | ⭐⭐⭐⭐ | 自动镜像请求，业界主流做法       |
| ✅ **使用 Nginx + mirror 模块**                  | ⭐⭐⭐  | 简单可靠，适用于中小项目        |
| ✅ **代码层拦截 & 异步复制（如 Spring Gateway Filter）** | ⭐⭐   | 可控性强，但开发成本高         |
| ❌ **通过日志回放/抓包再重放**                          | ⭐    | 不是真实“实时”流量，仅适用于离线分析 |

---

## 🧩 三、主流方式详解

---

### ✅ 方式一：**Envoy / Istio 流量镜像（推荐）**

适用于微服务、Kubernetes、服务网格环境。

#### 示例配置（Envoy）

```yaml
http_filters:
- name: envoy.filters.http.router
  typed_config:
    "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
    shadow_policy:
      cluster: mirror-preprod
      runtime_fraction:
        default_value:
          numerator: 100
          denominator: HUNDRED
```

说明：

* 请求发往主 cluster（生产）
* 同时 shadow 一份给 `mirror-preprod`（预发布）

---

### ✅ 方式二：**Nginx `mirror` 模块**

适合非服务网格场景，只要你在入口使用的是 Nginx 就能支持。

#### 示例配置：

```nginx
server {
    listen 80;

    location / {
        mirror /mirror;
        mirror_request_body on;

        proxy_pass http://prod_backend;
    }

    location = /mirror {
        internal;
        proxy_pass http://preprod_backend;
    }
}
```

说明：

* `mirror` 指令会将请求复制给 `/mirror` 路径
* 通过 `internal` 不影响正常响应

---

### ✅ 方式三：**代码层拦截 + 异步复制（Spring Gateway、Filter等）**

适合你自己控制网关/服务逻辑时使用。

#### Spring Gateway 示例（伪代码）：

```java
public class TrafficMirrorFilter implements GlobalFilter {
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 复制请求
        HttpRequest originalRequest = exchange.getRequest();
        sendAsyncToPreProd(originalRequest);
        return chain.filter(exchange);
    }
}
```

注意：

* 要 **异步发送**，不能阻塞主请求
* 可使用 `WebClient`、`HttpClient` 等发往预发布地址

---

## 🛑 注意事项

| 事项         | 说明                            |
| ---------- | ----------------------------- |
| 不应影响主业务    | 镜像流量**不能影响**生产系统响应            |
| 不应对预发布写入数据 | 如果是下单/删除类操作，要避免在预发布环境**真的执行** |
| 考虑敏感信息保护   | 请求中可能包含用户 token、手机号等，要做脱敏或隔离  |
| QPS 限流     | 预发布环境性能较低，需做限流或镜像比例控制         |
| 日志区分       | 镜像请求日志要能明显区分，以免干扰监控/告警        |

---

## ✅ 推荐实施步骤

1. **网关接入层选型**

    * 如果你有 API Gateway（如 Kong、Nginx、Istio、Envoy）→ 推荐用网关层做镜像
2. **选定目标镜像路径**

    * 一般是 `/api/**` 类接口，但不包括登录、上传大文件等
3. **开启灰度镜像（比例复制）**

    * 初期可设置 10% 流量镜像，避免打垮预发布
4. **在预发布环境配置完整监控**

    * 确保响应时间、错误率、业务一致性能追踪
5. **观察一段时间后扩大镜像比例或做回归测试**

---

## 🎯 实战建议

* 如果你在使用 **K8s** 或微服务架构：优先考虑 Envoy / Istio 实现
* 如果你用的是 **Nginx 接入层**：可优先尝试 `mirror` 模块
* 如果你想要 **精细控制、低流量镜像**：代码级实现最灵活

---

如你告诉我你当前系统是基于什么架构（Spring Boot？K8s？Nginx？API Gateway？），我可以为你定制一套镜像流量配置模板或代码方案。是否需要？
