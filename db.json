{"meta":{"version":1,"warehouse":"5.0.1"},"models":{"Asset":[{"_id":"themes/anzhiyu/source/favicon.ico","path":"favicon.ico","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/404.jpg","path":"img/404.jpg","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/512.png","path":"img/512.png","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/algolia.svg","path":"img/algolia.svg","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/comment_bg.png","path":"img/comment_bg.png","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/default_cover.jpg","path":"img/default_cover.jpg","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/favicon.ico","path":"img/favicon.ico","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/friend_404.gif","path":"img/friend_404.gif","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/loading.gif","path":"img/loading.gif","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/css/var.styl","path":"css/var.styl","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/css/index.styl","path":"css/index.styl","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/tw_cn.js","path":"js/tw_cn.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/siteicon/16.png","path":"img/siteicon/16.png","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/siteicon/apple-icon-180.png","path":"img/siteicon/apple-icon-180.png","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/siteicon/manifest-icon-192.maskable.png","path":"img/siteicon/manifest-icon-192.maskable.png","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/siteicon/manifest-icon-512.maskable.png","path":"img/siteicon/manifest-icon-512.maskable.png","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/img/siteicon/32.png","path":"img/siteicon/32.png","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/search/algolia.js","path":"js/search/algolia.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/search/local-search.js","path":"js/search/local-search.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/anzhiyu/ai_abstract.js","path":"js/anzhiyu/ai_abstract.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/anzhiyu/comment_barrage.js","path":"js/anzhiyu/comment_barrage.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/anzhiyu/people.js","path":"js/anzhiyu/people.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/anzhiyu/random_friends_post.js","path":"js/anzhiyu/random_friends_post.js","modified":0,"renderable":1},{"_id":"themes/anzhiyu/source/js/anzhiyu/right_click_menu.js","path":"js/anzhiyu/right_click_menu.js","modified":0,"renderable":1},{"_id":"source/resource/logstash.conf","path":"resource/logstash.conf","modified":0,"renderable":0},{"_id":"source/resource/openvpn.sh","path":"resource/openvpn.sh","modified":0,"renderable":0},{"_id":"source/resource/安卓逆向｜高版本安卓（7.0+）用 Fiddler 无法抓到 HTTPS 包问题解决方案刚开始学习安卓逆向的小伙伴肯定都 - 掘金.html","path":"resource/安卓逆向｜高版本安卓（7.0+）用 Fiddler 无法抓到 HTTPS 包问题解决方案刚开始学习安卓逆向的小伙伴肯定都 - 掘金.html","modified":0,"renderable":0},{"_id":"source/resource/mihomo-linux-amd64-v1.18.6.deb","path":"resource/mihomo-linux-amd64-v1.18.6.deb","modified":0,"renderable":0},{"_id":"source/resource/49172c7d-e632-47b4-9bc4-f792ae82b980.jpeg","path":"resource/49172c7d-e632-47b4-9bc4-f792ae82b980.jpeg","modified":0,"renderable":0}],"Cache":[{"_id":"source/about/index.md","hash":"3577e59d048ecdfa83f9d1b09a14ea50be1d74bf","modified":1719471059998},{"_id":"source/categories/index.md","hash":"68b2a0f13693c21cebe78abcef95bd75f8bd96c8","modified":1739859597546},{"_id":"source/resource/logstash.conf","hash":"fe299068c6a2c1dacddec164ea613f9ffe70dac9","modified":1730267970300},{"_id":"source/tags/index.md","hash":"b3200194dcaa3b5da90c0a8bb6ae23d51baa9b9d","modified":1739859753979},{"_id":"source/resource/openvpn.sh","hash":"87de7e0b919a17c8192e6f57c2ce55f23f216714","modified":1723017349544},{"_id":"source/_posts/.DS_Store","hash":"b846e41e7a59c53aa20984a4b9c25c2a2f40b8da","modified":1760494699058},{"_id":"source/_posts/elasticsearch/es常用命令.md","hash":"d0f4d0bbe1f97e6e693c2958579c32aec7b4775f","modified":1740648321655},{"_id":"source/_posts/java/Application-toolkit-trace-cross-thread.md","hash":"2fdc545353b40c9aab63da97e53ca2e22b5f38df","modified":1739860260542},{"_id":"source/_posts/elasticsearch/logstach安装和导入数据.md","hash":"64e5e8b5a9c60129767556906bb00d493446a240","modified":1740637518049},{"_id":"source/_posts/elasticsearch/在Docker容器中运行Elasticsearch-Kibana和Cerebro.md","hash":"cbf04cc0234b0e62fccbfd38bb9eb1a2851b1923","modified":1740635901489},{"_id":"source/_posts/java/Java通过JNI调用C-C.md","hash":"85dae32686da0ba94a11bd853793706b2ea5b2c2","modified":1745545709358},{"_id":"source/_posts/docker/docker中运行chrome并使用代码控制.md","hash":"d5d43b43379232e9335320eb3959e9d924e89586","modified":1742439512717},{"_id":"source/_posts/docker/docker常用命令.md","hash":"264d1ff13084b51f5c92441d072b11ea276132ef","modified":1740036442473},{"_id":"source/_posts/mysql/mysql-数据备份脚本.md","hash":"0c8cce143bb9684f7d34b83596edb6038db8920c","modified":1740036442479},{"_id":"source/_posts/k8s/将生产的流量镜像到预生产环境的一些思考.md","hash":"14d462dde6469ec368806a1313b70b3d83d347d0","modified":1750748855789},{"_id":"source/_posts/mysql/select-for-update用法的好处.md","hash":"41b930e730fab5fe47160c767eb428a11a16aa22","modified":1739860110279},{"_id":"source/_posts/docker/基于k8s实现优雅停机.md","hash":"9b68b4a94d092aff2c3b6708ba9bdc0d2b26f14a","modified":1763976027899},{"_id":"source/_posts/linux/docker修改应用为自动启动.md","hash":"7ceb9b6af02d29dd7e8229e846ec65d22eb09f21","modified":1739860260549},{"_id":"source/_posts/linux/UNIX操作系统采用i结点管理文件的存储空间.md","hash":"5b9d77afb2d297153de68162df53c1fba9bbcab1","modified":1743069427805},{"_id":"source/_posts/mysql/mysql异常排查sql.md","hash":"d40645a185b8b8c8884ef018d310a308a4c41791","modified":1750042553802},{"_id":"source/_posts/mysql/通过excel文档快速生成表设计.md","hash":"8ff8d74991ae93128a230e16b5c74a0d7331f198","modified":1764212918474},{"_id":"source/_posts/linux/linux下实现钉钉告警.md","hash":"02a39f163bbb1ec9be76556c7f37160aa5813039","modified":1739860260569},{"_id":"source/_posts/linux/linux-配置开机自启.md","hash":"d598345e638a6a47a81acc5cd812d78c42e8e8f8","modified":1740573317628},{"_id":"source/_posts/linux/github-将远程仓库更新到自己的仓库中.md","hash":"3766afd6630d4305a15e3aefa8f8e9109df8a58b","modified":1739860260556},{"_id":"source/_posts/linux/linux-常用命令.md","hash":"a4b794066f6d86ec5e917ebf1cd8c17ba55b9c27","modified":1740638561626},{"_id":"source/_posts/linux/linux下通过端口找到进程.md","hash":"be6e54a6ee19174844428a0c844af67b77dfd106","modified":1739860260562},{"_id":"source/_posts/linux/nginx配置https.md","hash":"7525b81a42ca1601025a2b6f71c17e6b041489c8","modified":1740570791577},{"_id":"source/_posts/linux/nginx配置上传文件大小.md","hash":"1c8fb6a8d2e36d7595312505e768f8fb6fdf2f40","modified":1739860152455},{"_id":"source/_posts/linux/tcp6-如何-改成tcp4.md","hash":"186c75e01df9906083f376c59a25ddca562958ef","modified":1739860080123},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容.md","hash":"7da506ff5879263c882a4de74e177e1a942bdc88","modified":1739860007395},{"_id":"source/_posts/linux/openvpn中使用client1访问xxx域名时，走client2的网络流量来访问.md","hash":"8490a9048f7220859f595218be6c6298377c83d2","modified":1739860121773},{"_id":"source/_posts/linux/openvpn-部署脚本.md","hash":"18d714937de1cf37d2ed55c1534bc5eef75f7887","modified":1740216991520},{"_id":"source/_posts/linux/对linux磁盘进行无损扩容.md","hash":"6442714735bf0d19a4bfcdffe1031bc00767db89","modified":1739859913114},{"_id":"source/_posts/linux/linux下修复网卡出入口策略.md","hash":"1d8498eaf267c9faa8e1594edf632c3fbb68d31a","modified":1760682460473},{"_id":"themes/anzhiyu/source/css/_extra/home_top/random-banner.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1763976519463},{"_id":"source/_posts/redis/解读redis分布式锁核心逻辑.md","hash":"b9040ed1a8fe2dca4e9e49ef235c0ba9650a32e2","modified":1739859880765},{"_id":"source/_posts/linux/在linux上使用代理.md","hash":"4e35f5b10e669ffce850c3f579ba47d248e5e4d6","modified":1740217194462},{"_id":"source/_posts/交易/交易策略总结.md","hash":"787c78a6a40056ddeec35a55e22b37fed2ae22b9","modified":1741919410758},{"_id":"source/_posts/交易/交易下单时金额变化.md","hash":"a8c2f0177708c73940d89b54e265efb188c6fcde","modified":1739860053022},{"_id":"source/_posts/spring-boot/spring-state-machine.md","hash":"3b570f14fe6aa4b11143e8c2202eb94f40662690","modified":1739860080116},{"_id":"source/_posts/spring-boot/使用切面或拦截器打印异常日志.md","hash":"c6553d5557c2d035a4e7af381ea373db94682a0c","modified":1739860007387},{"_id":"source/_posts/分享/学习it网站推荐.md","hash":"e7261ce540646cc0d21028f9f37ef729676b4d2b","modified":1739859933700},{"_id":"source/_posts/java/Java通过JNI调用C-C/jar_cmd.png","hash":"05f0fa08286f8bfad1ebf31a60aa2bdbc0f8838a","modified":1745545457783},{"_id":"source/_posts/黑客/亿赛通电子文档安全管理系统XStream反序列化漏洞任意文件上传利用.md","hash":"e27d1b450cfe0c33a51d90520b850426bdab97bc","modified":1739860028573},{"_id":"source/_posts/计算机考试/设信道带宽为16kHz-信噪比为30dB-则该信道的信道容量大约为.md","hash":"f7b08d6b83d7a59e8f2870369b55cad640c065d1","modified":1739859880777},{"_id":"source/_posts/数学/向量与坐标轴的夹角余弦值.md","hash":"24a648bacb26d4f663e41d01b645e22411713fd6","modified":1742366163009},{"_id":"source/_posts/java/Java通过JNI调用C-C/file.png","hash":"b46d1ce43549ee81aba9f4da442acf825be04375","modified":1745545457783},{"_id":"source/_posts/java/Java通过JNI调用C-C/jna_step.png","hash":"ece3ded5190c21090f514149b5889b2863f48078","modified":1745545457783},{"_id":"source/_posts/java/Java通过JNI调用C-C/jni_h.png","hash":"484349020a0d29193de0a329b93addef13693b3b","modified":1745545457783},{"_id":"source/_posts/java/Java通过JNI调用C-C/jni_step.png","hash":"c93dee3581e4a8d9a2868d4ec8b456a2be590177","modified":1745545457784},{"_id":"source/_posts/java/Java通过JNI调用C-C/jni_md_h.png","hash":"ed065aa68f4f4606516012def6bcdf5c3d8ac835","modified":1745545457783},{"_id":"source/_posts/mysql/通过excel文档快速生成表设计/pdm_excel_template.xlsx","hash":"e854f4f7e614dbbfe7717128374d54473d6463ce","modified":1764208069001},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/微信截图_20240806200410.png","hash":"f33b4b69c8133bb6f7522812a7f594ff854c9ce3","modified":1722945851808},{"_id":"themes/anzhiyu/README.md","hash":"46c4c8c308bd18c813da6b37356c7953f0d2e4af","modified":1763976519372},{"_id":"themes/anzhiyu/package.json","hash":"b1bd6fd513cd4d1a98a904b37c6cd28296af7ee7","modified":1763976519438},{"_id":"themes/anzhiyu/README_EN.md","hash":"3b27231432adf2bd180857fc6d3de646dfd444bf","modified":1763976519372},{"_id":"themes/anzhiyu/LICENSE","hash":"31a3d460bb3c7d98845187c716a30db81c44b615","modified":1763976519371},{"_id":"themes/anzhiyu/.gitignore","hash":"d507747699b68b0ec536b91d8be526c71ccf5c74","modified":1763976519371},{"_id":"themes/anzhiyu/languages/default.yml","hash":"be22c8d1730408a2ac3ec9a57406e297fc1f7ce6","modified":1763976519373},{"_id":"themes/anzhiyu/_config.yml","hash":"39ef89d62ff14cad0e3e585f5e618b2f05939151","modified":1767517911443},{"_id":"themes/anzhiyu/sw-rules.js","hash":"0dc0fbe4d5e9acad4fffe69355830dcd41f89da6","modified":1763976519495},{"_id":"themes/anzhiyu/languages/en.yml","hash":"4c46ef35360b8322269417bcae68e609ca8f85be","modified":1763976519374},{"_id":"themes/anzhiyu/plugins.yml","hash":"23296290f36523e41926e22888f3d87b236dfbf0","modified":1763976519439},{"_id":"themes/anzhiyu/languages/zh-CN.yml","hash":"dbd5b387322693ed53df84eab709bf04ffeb8b81","modified":1763976519374},{"_id":"themes/anzhiyu/languages/zh-TW.yml","hash":"0e0b432912390e3de9d99bc54add99e4d265d3d1","modified":1763976519374},{"_id":"themes/anzhiyu/layout/archive.pug","hash":"b8778e55f1aab2431daa4a64cba991ef40e33224","modified":1763976519375},{"_id":"themes/anzhiyu/layout/category.pug","hash":"1d55b22a50675d1ecfb95d031ea011245c7c6511","modified":1763976519375},{"_id":"themes/anzhiyu/layout/tag.pug","hash":"354b85519feab71c0233eb240655d0e0ec67021c","modified":1763976519437},{"_id":"themes/anzhiyu/layout/index.pug","hash":"cf1b756e06864a47352bb9890519eafcf5d0340d","modified":1763976519434},{"_id":"themes/anzhiyu/source/favicon.ico","hash":"14310db268ea8d3b2096f434c6e293fc207f5f09","modified":1763976519483},{"_id":"themes/anzhiyu/.github/workflows/issue_close_stale.yml","hash":"6151bdec23ded908adf01ba5ecdf3c0da573449d","modified":1763976519369},{"_id":"themes/anzhiyu/.github/workflows/issue_question.yml","hash":"72ce6e36847f20952d8f8742e4fd1969cd086320","modified":1763976519370},{"_id":"themes/anzhiyu/.github/workflows/issue_close_question.yml","hash":"a7f1bf4578faa6092898a9a44bfd467cbb1788dd","modified":1763976519368},{"_id":"themes/anzhiyu/.github/workflows/issue_duplicate.yml","hash":"42a8e022434604081fe443d416bd443efd887015","modified":1763976519369},{"_id":"themes/anzhiyu/.github/workflows/issue_invalid.yml","hash":"8cdde230c8f9330cc7cd5c149ea5fc258ffb0b8b","modified":1763976519369},{"_id":"themes/anzhiyu/.github/workflows/stale.yml","hash":"ac62b989b5550c756e1986fcc68f243170705383","modified":1763976519371},{"_id":"themes/anzhiyu/.github/workflows/publish.yml","hash":"05857c2f265246d8de00e31037f2720709540c09","modified":1763976519371},{"_id":"themes/anzhiyu/.github/workflows/issue_wontfix.yml","hash":"3b498c22281bb454f8ee1135a4becee0adc5b9ae","modified":1763976519370},{"_id":"themes/anzhiyu/.github/ISSUE_TEMPLATE/config.yml","hash":"a23b745378bc745b15f2dfefcc6a203d5d1d5fcd","modified":1763976519366},{"_id":"themes/anzhiyu/.github/ISSUE_TEMPLATE/bug_report.yml","hash":"3978be1ecdd21be564aa590b17eda6f03cd77e19","modified":1763976519365},{"_id":"themes/anzhiyu/scripts/events/404.js","hash":"170e72e851257365468024557c767360c3deafbf","modified":1763976519440},{"_id":"themes/anzhiyu/scripts/events/comment.js","hash":"a3d1f417965ca20253c36f9e93429f3df6268856","modified":1763976519441},{"_id":"themes/anzhiyu/scripts/events/cdn.js","hash":"39aaf1d4fed1382c85776581225747285b7b388c","modified":1763976519441},{"_id":"themes/anzhiyu/scripts/events/merge_config.js","hash":"4bc10659ac9b483032a13bd3d7bce9094fd7c58b","modified":1763976519442},{"_id":"themes/anzhiyu/scripts/events/welcome.js","hash":"3177e070519a10fff904595e152a329115d22c61","modified":1763976519442},{"_id":"themes/anzhiyu/scripts/events/stylus.js","hash":"675eee74f9efcbc846b89eb9ba41f130a95310ee","modified":1763976519442},{"_id":"themes/anzhiyu/scripts/helpers/catalog_list.js","hash":"aa38fd791d58df3fd518adf144578f160073d06e","modified":1763976519444},{"_id":"themes/anzhiyu/scripts/filters/post_lazyload.js","hash":"61f06b25c09434340e81c8c3dbbd1a0d58406652","modified":1763976519442},{"_id":"themes/anzhiyu/scripts/helpers/aside_archives.js","hash":"ca03ba2a0a7f2132ac5d3f66cb1bbd9e078aed3f","modified":1763976519443},{"_id":"themes/anzhiyu/scripts/helpers/aside_categories.js","hash":"19244d6a9e42c34b9df2250be2467c352fa5fd41","modified":1763976519443},{"_id":"themes/anzhiyu/.github/ISSUE_TEMPLATE/feature_request.yml","hash":"53260c55a97ed93e6a1f9acc23b9d21193cae6ef","modified":1763976519367},{"_id":"themes/anzhiyu/scripts/filters/random_cover.js","hash":"98275d777b3c388345de3ee8caf5d16900388925","modified":1763976519443},{"_id":"themes/anzhiyu/scripts/events/init.js","hash":"006401bd6f4bb3fc8756e752d6ab93bf770bb77f","modified":1763976519441},{"_id":"themes/anzhiyu/scripts/helpers/findArchiveLength.js","hash":"d8aa1a4824ba6b0df911af563ae5fb361257a88a","modified":1763976519444},{"_id":"themes/anzhiyu/scripts/helpers/inject_head_js.js","hash":"847bc24452bc23dfc860b219588cfb2bff84cfbf","modified":1763976519444},{"_id":"themes/anzhiyu/scripts/helpers/page.js","hash":"dff1124a8825479606e45e69e329a3ad1903ec87","modified":1763976519445},{"_id":"themes/anzhiyu/scripts/helpers/tags_page_list.js","hash":"35d71c025a3289be188371cc56320c563213c4af","modified":1763976519446},{"_id":"themes/anzhiyu/scripts/helpers/sort_attr_post.js","hash":"6b6e9fb0d0dc38e8d7136dc7720c70f0c29619ab","modified":1763976519445},{"_id":"themes/anzhiyu/scripts/helpers/random.js","hash":"d659d1d05c919d1abba2dc55439749e6e5b6e707","modified":1763976519445},{"_id":"themes/anzhiyu/scripts/helpers/get_version.js","hash":"f2b7364706fc4d039da4a486e133baf7accf6836","modified":1763976519444},{"_id":"themes/anzhiyu/scripts/helpers/related_post.js","hash":"c5f70efdbfd733f4dfec0ca8fe4aded0eec394cf","modified":1763976519445},{"_id":"themes/anzhiyu/scripts/helpers/year.js","hash":"94f15ddba7d29cdcc4dd52ed6c35c9c29cc19d37","modified":1763976519446},{"_id":"themes/anzhiyu/layout/includes/404.pug","hash":"aa158d5a661aa2fab4737b9460ce34f6784fdee5","modified":1763976519376},{"_id":"themes/anzhiyu/layout/includes/footer.pug","hash":"50131aa8ad85fd6c08d8e1cb2d3dcfceb5964abe","modified":1763976519379},{"_id":"themes/anzhiyu/layout/includes/additional-js.pug","hash":"d7e42261a79651ce13ff2213947ecb3e4c41ee81","modified":1763976519376},{"_id":"themes/anzhiyu/layout/includes/categoryGroup.pug","hash":"243f63820db5f3241e682ae8f3baffd6501df3de","modified":1763976519379},{"_id":"themes/anzhiyu/layout/includes/bbTimeList.pug","hash":"0a0c4cdf69314c3a9ecb078f4213c76129a9ac06","modified":1763976519378},{"_id":"themes/anzhiyu/layout/includes/layout.pug","hash":"3bc51657414be0c94bd27752616cc7f7d54f20cd","modified":1763976519391},{"_id":"themes/anzhiyu/layout/includes/music.pug","hash":"163f5bbeadbe481a809652e6ce453022db26694a","modified":1763976519393},{"_id":"themes/anzhiyu/layout/includes/head.pug","hash":"8db5b7382011745f53b99b5b5577ae28140068e2","modified":1763976519382},{"_id":"themes/anzhiyu/layout/includes/pagination.pug","hash":"1e0be343f9bdc6cefc5ff0dd3c2936ed91d5be86","modified":1763976519402},{"_id":"themes/anzhiyu/layout/post.pug","hash":"0d8d8cfd31e97053c908dac3ee19072825a6a2dc","modified":1763976519436},{"_id":"themes/anzhiyu/scripts/tag/btns.js","hash":"200e1ce72f335caa71dc8423f5c5e2aba1195b61","modified":1763976519447},{"_id":"themes/anzhiyu/layout/includes/rightside.pug","hash":"d865835bc5432d8ec15fd0cb168643f3e9b77a18","modified":1763976519404},{"_id":"themes/anzhiyu/layout/page.pug","hash":"98e81d10e6caab2ff79b4a2788d2312acded36ef","modified":1763976519435},{"_id":"themes/anzhiyu/scripts/tag/bilibili.js","hash":"085e033cb359e8f109968748cedbd0079515e7c6","modified":1763976519446},{"_id":"themes/anzhiyu/scripts/tag/button.js","hash":"430c31584930bc5407811c3dbc01be92473cfcbf","modified":1763976519447},{"_id":"themes/anzhiyu/scripts/tag/checkbox.js","hash":"fa93b169fe74bced502b0d16fe3d6bd17434b8f3","modified":1763976519447},{"_id":"themes/anzhiyu/scripts/tag/dogeplayer.js","hash":"e9b0d88e38d3caf88b66ea39ca704d45c643ba51","modified":1763976519447},{"_id":"themes/anzhiyu/scripts/tag/folding.js","hash":"dc4e409eabebf5769b50c12c9e8c66b749d0ae85","modified":1763976519448},{"_id":"themes/anzhiyu/scripts/tag/flink.js","hash":"5b0086d1b726d1068b3d8ee0563ae31485896c4b","modified":1763976519447},{"_id":"themes/anzhiyu/scripts/tag/gallery.js","hash":"0364b021f2519a937464e585a7e2cbdde57ca412","modified":1763976519448},{"_id":"themes/anzhiyu/layout/includes/shortcutKey.pug","hash":"dcf8fb7bbddd4a64626f4fcf2523ace2dfce879f","modified":1763976519405},{"_id":"themes/anzhiyu/scripts/tag/hide.js","hash":"37b81ff46d104554b9a5934bfd434dbfd6a84958","modified":1763976519448},{"_id":"themes/anzhiyu/scripts/tag/iconfont.js","hash":"ea983f7c8dd060ed411044df1c10aa6b72dec34f","modified":1763976519448},{"_id":"themes/anzhiyu/layout/includes/sidebar.pug","hash":"fd6d7873df74994ed6a36bd07a438c427db97e18","modified":1763976519405},{"_id":"themes/anzhiyu/scripts/tag/inline-labels.js","hash":"08fbdc0ea622270e1236a28778f875c8ad2e5516","modified":1763976519448},{"_id":"themes/anzhiyu/scripts/tag/image.js","hash":"0b7051574af6cf28c378db65f6c6dab722a8e118","modified":1763976519448},{"_id":"themes/anzhiyu/scripts/tag/link.js","hash":"a5d49f1d0e4602b0fce158efd0b1ec02c0bfd3e3","modified":1763976519449},{"_id":"themes/anzhiyu/scripts/tag/label.js","hash":"87acd7d5615dd8034c51ba28d4964992d2ffed37","modified":1763976519449},{"_id":"themes/anzhiyu/scripts/tag/inlineImg.js","hash":"a43ee2c7871bdd93cb6beb804429e404570f7929","modified":1763976519449},{"_id":"themes/anzhiyu/scripts/tag/mermaid.js","hash":"d3d6c8a23ddfecac35f7022eecd4ffc6171a37fa","modified":1763976519451},{"_id":"themes/anzhiyu/scripts/tag/site.js","hash":"bc34bfab53f520bec33d273ee599de5905ca19a9","modified":1763976519451},{"_id":"themes/anzhiyu/scripts/tag/note.js","hash":"d51812b43924f1bbf413c67499510dd125022005","modified":1763976519451},{"_id":"themes/anzhiyu/scripts/tag/media.js","hash":"76efb072e0716e55deedb044fed1ad585871335b","modified":1763976519450},{"_id":"themes/anzhiyu/scripts/tag/span.js","hash":"0a2188be1e3ee6ed183c0f16d24795ef31116e10","modified":1763976519451},{"_id":"themes/anzhiyu/scripts/tag/timeline.js","hash":"300eb779588bf35a1b687d9f829d866074b707e3","modified":1763976519452},{"_id":"themes/anzhiyu/scripts/tag/tip.js","hash":"e45a0955439dfbe6c0b4d27f8403896a0fb1d33b","modified":1763976519452},{"_id":"themes/anzhiyu/scripts/tag/tabs.js","hash":"dea5cd52bb9fd658bc03074b2388d91ea528fc2b","modified":1763976519452},{"_id":"themes/anzhiyu/scripts/tag/Introduction-card.js","hash":"61a55f9b1f5f576e6900d2900cb42754575a4cb7","modified":1763976519446},{"_id":"themes/anzhiyu/source/img/512.png","hash":"6988b23a31304d9de45b95a1e7c05dd42024e560","modified":1763976519484},{"_id":"themes/anzhiyu/source/img/algolia.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1763976519484},{"_id":"themes/anzhiyu/source/img/favicon.ico","hash":"14310db268ea8d3b2096f434c6e293fc207f5f09","modified":1763976519484},{"_id":"themes/anzhiyu/source/img/comment_bg.png","hash":"91612a887446fb436e9151981e2289f2a426a3e5","modified":1763976519484},{"_id":"themes/anzhiyu/layout/includes/mourn.pug","hash":"d114b9493fbe6551b0c4ad1c1d8886b7f98a0d60","modified":1763976519393},{"_id":"themes/anzhiyu/source/img/default_cover.jpg","hash":"455fa65e2736f61ac36360dd4f76fc1ab6a1cdd5","modified":1763976519484},{"_id":"themes/anzhiyu/source/css/index.styl","hash":"ddded5cd1da248fdc30556a33877579ff8379a48","modified":1763976519481},{"_id":"themes/anzhiyu/source/css/var.styl","hash":"7bdedada1176e55d5fb72e3cc9f46e01d03b704a","modified":1763976519481},{"_id":"themes/anzhiyu/layout/includes/anzhiyu/ai-info.pug","hash":"0c2e9e58069880c0617208840cf2f0712339ddf0","modified":1763976519376},{"_id":"themes/anzhiyu/layout/includes/anzhiyu/clock.pug","hash":"c13b21cdcbc5280deb26537c58af5443cb66c62f","modified":1763976519377},{"_id":"themes/anzhiyu/source/js/main.js","hash":"888563ad7324e565e6f5060ca126d69c7309bef1","modified":1763976519493},{"_id":"themes/anzhiyu/source/js/tw_cn.js","hash":"6cbec565e98cbd49aa75e6161d8fa996ae3be91a","modified":1763976519494},{"_id":"themes/anzhiyu/layout/includes/anzhiyu/log-js.pug","hash":"a44b4f89f39d1e32889849c3dd1403dffa2786a4","modified":1763976519377},{"_id":"themes/anzhiyu/layout/includes/anzhiyu/console.pug","hash":"d46c93a7a22129795cc856045967b0e07c5e53c2","modified":1763976519377},{"_id":"themes/anzhiyu/layout/includes/anzhiyu/rightmenu.pug","hash":"2747252c6337d8fb7ba773cdb466611607f9a23b","modified":1763976519377},{"_id":"themes/anzhiyu/layout/includes/anzhiyu/tags-group-all.pug","hash":"bc16fa91883895544273161cc8672bfe5c010e5e","modified":1763976519378},{"_id":"themes/anzhiyu/layout/includes/bili-banner/index.pug","hash":"8cb1c404adc6fe188bdceca3c09d3f215048e9bd","modified":1763976519378},{"_id":"themes/anzhiyu/source/js/utils.js","hash":"68e7f87c38365ef1271b69943395aa5fdb5417ea","modified":1763976519495},{"_id":"themes/anzhiyu/layout/includes/head/Open_Graph.pug","hash":"dff5b967a641f385c4661fe66ad62d53cabf857a","modified":1763976519383},{"_id":"themes/anzhiyu/layout/includes/head/analytics.pug","hash":"15530d9ac59c576d79af75dd687efe71e8d261b0","modified":1763976519384},{"_id":"themes/anzhiyu/layout/includes/head/config.pug","hash":"068b2fe70e7f26cdd1f0ee6c75d79266ceed89dd","modified":1763976519385},{"_id":"themes/anzhiyu/layout/includes/head/google_adsense.pug","hash":"95a37e92b39c44bcbea4be7e29ddb3921c5b8220","modified":1763976519386},{"_id":"themes/anzhiyu/layout/includes/head/preconnect.pug","hash":"56ef61e74598cf60551d363a15fc53842b8dc41b","modified":1763976519387},{"_id":"themes/anzhiyu/layout/includes/head/config_site.pug","hash":"3038adec24b17f019bdd7d6aa15ebe091b11397d","modified":1763976519385},{"_id":"themes/anzhiyu/layout/includes/head/noscript.pug","hash":"d16ad2ee0ff5751fd7f8a5ce1b83935518674977","modified":1763976519386},{"_id":"themes/anzhiyu/layout/includes/head/pwa.pug","hash":"a4cc65381275e09f3f54f6e958d359c89c7b2c4e","modified":1763976519388},{"_id":"themes/anzhiyu/layout/includes/head/site_verification.pug","hash":"e2e8d681f183f00ce5ee239c42d2e36b3744daad","modified":1763976519388},{"_id":"themes/anzhiyu/layout/includes/header/menu_item.pug","hash":"4537154b8830310ce5dff3c9cfd558f0ec1311a5","modified":1763976519389},{"_id":"themes/anzhiyu/layout/includes/header/nav.pug","hash":"e567624b78d723346193a9b0d28032031997b865","modified":1763976519390},{"_id":"themes/anzhiyu/layout/includes/header/post-info.pug","hash":"0f1503c88d05ada69919e0bdbbf7b2ea1603d20b","modified":1763976519390},{"_id":"themes/anzhiyu/layout/includes/header/index.pug","hash":"c865d51436cfd5413df6c691a7ab1f0eb600e79c","modified":1763976519389},{"_id":"themes/anzhiyu/layout/includes/header/social.pug","hash":"2185b69eb54656ed9e401bc47ca3cd9905b022f3","modified":1763976519390},{"_id":"themes/anzhiyu/layout/includes/loading/fullpage-loading.pug","hash":"39977280dd32f1435a97f285a75f2a02902472d6","modified":1763976519391},{"_id":"themes/anzhiyu/layout/includes/loading/index.pug","hash":"f86b0c45874ae1335ab575c29d4f9c8ea09ab92a","modified":1763976519391},{"_id":"themes/anzhiyu/layout/includes/loading/pace.pug","hash":"7f04cabd68f75d7f953503283316e1594bbec45f","modified":1763976519392},{"_id":"themes/anzhiyu/layout/includes/mixins/article-sort.pug","hash":"7a06f5f24f8e32b3025cf43474db9519d48517e5","modified":1763976519392},{"_id":"themes/anzhiyu/layout/includes/mixins/post-ui.pug","hash":"80858e19caf57c275cb7d6acf3bfff7d0c90c774","modified":1763976519393},{"_id":"themes/anzhiyu/layout/includes/page/album.pug","hash":"0ca70f1ec4757d6127048d71762752dabf1af2ea","modified":1763976519395},{"_id":"themes/anzhiyu/layout/includes/page/album_detail.pug","hash":"c735533f7671905d06bae5645306cd08abb0b43c","modified":1763976519395},{"_id":"themes/anzhiyu/layout/includes/page/categories.pug","hash":"f23d074ef6875311e74169da7592ecf667539775","modified":1763976519396},{"_id":"themes/anzhiyu/layout/includes/page/default-page.pug","hash":"12c65c174d26a41821df9bad26cdf1087ec5b0ca","modified":1763976519396},{"_id":"themes/anzhiyu/layout/includes/page/equipment.pug","hash":"87ca40c49ddfe9c266cd96b4eb3594d7c64c1d55","modified":1763976519396},{"_id":"themes/anzhiyu/layout/includes/page/essay.pug","hash":"b0a25ded52c72c84bd29593bd7a57046c4b36195","modified":1763976519397},{"_id":"themes/anzhiyu/layout/includes/page/fcircle.pug","hash":"a4bfc9855bcfc859f0c04e869e0ec8cb8d2a1357","modified":1763976519397},{"_id":"themes/anzhiyu/layout/includes/page/music.pug","hash":"3cbec3b3dc0f0e812f29c222ebb2d2a3d8c2719f","modified":1763976519398},{"_id":"themes/anzhiyu/layout/includes/page/room.pug","hash":"c35a2fb076e0196ba28389b5309dde33a2add576","modified":1763976519399},{"_id":"themes/anzhiyu/layout/includes/page/tags.pug","hash":"62882d8a699254486add2f7b0f089521732e4869","modified":1763976519401},{"_id":"themes/anzhiyu/layout/includes/post/post-copyright.pug","hash":"10638ede3b9ea1ef4e336f5c4d690239ef353843","modified":1763976519403},{"_id":"themes/anzhiyu/layout/includes/post/ptool.pug","hash":"173d1a63099109bd909de919281db9f2b2a023f0","modified":1763976519404},{"_id":"themes/anzhiyu/layout/includes/page/about.pug","hash":"fa529ca6b5ab9001822668697f410cc3020980ad","modified":1763976519394},{"_id":"themes/anzhiyu/layout/includes/popup/index.pug","hash":"3ac8714556f94a614100aeddeb7f7e0cdff2fb9c","modified":1763976519403},{"_id":"themes/anzhiyu/layout/includes/post/reward.pug","hash":"cdf5ff34ba8efe526cfe77ddf3277d997d172d41","modified":1763976519404},{"_id":"themes/anzhiyu/layout/includes/third-party/aplayer.pug","hash":"c7cfade2b160380432c47eef4cd62273b6508c58","modified":1763976519406},{"_id":"themes/anzhiyu/layout/includes/page/flink.pug","hash":"3756dfd0ad97968c02a9be662dc5e9253cbc33b9","modified":1763976519398},{"_id":"themes/anzhiyu/layout/includes/third-party/pjax.pug","hash":"4ee026b34e6ecc2c03cf04933973b496472309c2","modified":1763976519423},{"_id":"themes/anzhiyu/layout/includes/third-party/effect.pug","hash":"6528e86656906117a1af6b90e0349c2c4651d5e1","modified":1763976519417},{"_id":"themes/anzhiyu/layout/includes/third-party/prismjs.pug","hash":"ffb9ea15a2b54423cd4cd441e2d061b8233e9b58","modified":1763976519423},{"_id":"themes/anzhiyu/layout/includes/widget/card_ad.pug","hash":"60dc48a7b5d89c2a49123c3fc5893ab9c57dd225","modified":1763976519429},{"_id":"themes/anzhiyu/layout/includes/third-party/subtitle.pug","hash":"142621f70bedcb5033ee99a988f7bb6c5eea3493","modified":1763976519429},{"_id":"themes/anzhiyu/layout/includes/top/top.pug","hash":"9f849b05e220efa72d56f524a27ab2877e27e9e3","modified":1763976519429},{"_id":"themes/anzhiyu/layout/includes/widget/card_announcement.pug","hash":"ed8796dd3c5710d745fdcc0021b02a3cda07fd1b","modified":1763976519430},{"_id":"themes/anzhiyu/layout/includes/widget/card_bottom_self.pug","hash":"13dc8ce922e2e2332fe6ad5856ebb5dbf9ea4444","modified":1763976519431},{"_id":"themes/anzhiyu/layout/includes/widget/card_author.pug","hash":"b7e11bcd199f343a844315e5d16735205dded9d2","modified":1763976519430},{"_id":"themes/anzhiyu/layout/includes/widget/card_categories.pug","hash":"d1a416d0a8a7916d0b1a41d73adc66f8c811e493","modified":1763976519431},{"_id":"themes/anzhiyu/layout/includes/third-party/footerBarSubtitle.pug","hash":"bb2df2fbbdc9fe0f4b9d66928247faa49f70e2e5","modified":1763976519418},{"_id":"themes/anzhiyu/layout/includes/third-party/pangu.pug","hash":"0f024e36b8116118233e10118714bde304e01e12","modified":1763976519422},{"_id":"themes/anzhiyu/layout/includes/widget/card_newest_comment.pug","hash":"419eed9a771299c9ffb85fdf38073bbd5bd7775c","modified":1763976519432},{"_id":"themes/anzhiyu/layout/includes/widget/card_archives.pug","hash":"9ca97d85cc7b214e1107d0b4feac4d8ad2fd0ac8","modified":1763976519430},{"_id":"themes/anzhiyu/layout/includes/widget/card_console_archives.pug","hash":"8c095ae91183d6a2aeed64f378e60baaa29d4065","modified":1763976519431},{"_id":"themes/anzhiyu/layout/includes/widget/card_console_tags.pug","hash":"d723516d48cd94a68819df5c61087c9e7339e2af","modified":1763976519431},{"_id":"themes/anzhiyu/layout/includes/widget/card_top_self.pug","hash":"ae67c6d4130a6c075058a9c1faea1648bcc6f83e","modified":1763976519433},{"_id":"themes/anzhiyu/layout/includes/widget/card_webinfo.pug","hash":"5ddf285ca0ecbb57cbbbc36a4e9eaaca40406257","modified":1763976519434},{"_id":"themes/anzhiyu/layout/includes/widget/card_weixin.pug","hash":"28f11437bcba4df1e53fc1e32df213392b9ca4b6","modified":1763976519434},{"_id":"themes/anzhiyu/layout/includes/widget/index.pug","hash":"e33c360217b11a7980e780a5bc20e9d31f5dacf5","modified":1763976519434},{"_id":"themes/anzhiyu/source/img/siteicon/manifest-icon-512.maskable.png","hash":"6f8b4b3df8d1498db55a559f7106dc9b6e6af647","modified":1763976519492},{"_id":"themes/anzhiyu/source/img/siteicon/16.png","hash":"8dc6ca32ff1264f7c1c3a8f62727a8c96ea7525b","modified":1763976519491},{"_id":"themes/anzhiyu/source/img/siteicon/apple-icon-180.png","hash":"7f580ec4819c9ef10b1306102152f4473f037a98","modified":1763976519491},{"_id":"themes/anzhiyu/source/css/_highlight/highlight.styl","hash":"4a1f547d921d1b44f1221e60a42666a63a19e5a1","modified":1763976519468},{"_id":"themes/anzhiyu/layout/includes/widget/card_post_toc.pug","hash":"638417324111b66c834314b96cbf02e959be58f4","modified":1763976519432},{"_id":"themes/anzhiyu/source/css/_global/function.styl","hash":"e91b257ce982b670eb911c7120f379960083c959","modified":1763976519467},{"_id":"themes/anzhiyu/source/img/siteicon/manifest-icon-192.maskable.png","hash":"528b94ebcd34fb55436d64fdda76ef43ccbf031f","modified":1763976519491},{"_id":"themes/anzhiyu/source/img/siteicon/32.png","hash":"147aae33224066ef2a5987c3cbbfa4309c49cef4","modified":1763976519491},{"_id":"themes/anzhiyu/source/css/_highlight/theme.styl","hash":"c074efc93f4f118c3fc3b3d3c9f9abc42e4858b4","modified":1763976519469},{"_id":"themes/anzhiyu/layout/includes/widget/card_recent_post.pug","hash":"544272cb0977b8a941de22f1f58f76d370b2cbbd","modified":1763976519433},{"_id":"themes/anzhiyu/layout/includes/widget/card_tags.pug","hash":"3475134643b70cbf0e806806bd2e0d2a7371f8a5","modified":1763976519433},{"_id":"themes/anzhiyu/source/css/_global/icon.styl","hash":"da488461e8c5e504961c0a8f44b1e3605f72f956","modified":1763976519467},{"_id":"themes/anzhiyu/source/css/_global/loading.styl","hash":"734c69c16135543267794e12b43e776d501fb6ca","modified":1763976519467},{"_id":"themes/anzhiyu/source/css/_layout/404.styl","hash":"02a8df2e9734848cc4670a4b9f6e9a776e995644","modified":1763976519469},{"_id":"themes/anzhiyu/source/css/_layout/banner.styl","hash":"62f4202467cc9f313361911ed2a2005e66b3b2ca","modified":1763976519469},{"_id":"themes/anzhiyu/source/css/_layout/comments.styl","hash":"3dbb4c0e1ef79eab1f327d303c3aed61ddc3f58c","modified":1763976519470},{"_id":"themes/anzhiyu/source/css/_layout/chat.styl","hash":"29f48f9370f245e6e575b5836bccf47eb5688d8b","modified":1763976519470},{"_id":"themes/anzhiyu/source/css/_layout/footer.styl","hash":"ce21052dd27e752c3734083ec1401b96c542bfda","modified":1763976519470},{"_id":"themes/anzhiyu/source/css/_layout/oneGraphFlow.styl","hash":"1e5843caf8674429a5782712879c4a532074514d","modified":1763976519471},{"_id":"themes/anzhiyu/source/css/_layout/head.styl","hash":"960ca89ac2456f165e0b71214ef0b1519e1690ad","modified":1763976519470},{"_id":"themes/anzhiyu/source/css/_layout/pagination.styl","hash":"88f2fbb0ccb061410b07e1ed6303583230e96d4e","modified":1763976519471},{"_id":"themes/anzhiyu/source/css/_layout/nav.styl","hash":"200ddfe40c4a820af25fcfa71aa450b22741f6df","modified":1763976519470},{"_id":"themes/anzhiyu/source/css/_layout/ptool.styl","hash":"2ffeca0499c6ad1c4ea2ef783d7493b713b24569","modified":1763976519471},{"_id":"themes/anzhiyu/source/css/_global/index.styl","hash":"55850e21e138a0ad8250f4b2ff38412fdb343d1d","modified":1763976519467},{"_id":"themes/anzhiyu/source/css/_layout/relatedposts.styl","hash":"c67558ba609b59375f8ee6ad479fcb16ddda9cb6","modified":1763976519471},{"_id":"themes/anzhiyu/source/css/_layout/reward.styl","hash":"152b802a38f029dece2b8f8812404cec25975212","modified":1763976519472},{"_id":"themes/anzhiyu/source/css/_layout/rightmenu.styl","hash":"cc622c70ff61ef70dfa6445b5b4b09eb92cf9994","modified":1763976519472},{"_id":"themes/anzhiyu/source/css/_layout/shortcutKey.styl","hash":"ca7674768558396a8e2f9eaa452575bff099e4e8","modified":1763976519472},{"_id":"themes/anzhiyu/source/css/_layout/aside.styl","hash":"b62fbde63342f779b4dd27492e6da878c25f7dfb","modified":1763976519469},{"_id":"themes/anzhiyu/source/css/_layout/home_top.styl","hash":"c975f539ae6bed3b24c9dc3914b412f179ee2543","modified":1763976519470},{"_id":"themes/anzhiyu/source/css/_layout/post.styl","hash":"2a4a8af05bc24edbd14c4160b17489242164727f","modified":1763976519471},{"_id":"themes/anzhiyu/source/css/_layout/third-party.styl","hash":"a6b708dfeda4ad837bbfc76bd74810805ca521a0","modified":1763976519472},{"_id":"themes/anzhiyu/source/css/_page/archives.styl","hash":"8652be12d88083f71a1efb88a2482a0aeda2c65f","modified":1763976519474},{"_id":"themes/anzhiyu/source/css/_layout/rightside.styl","hash":"bebc753a414d3fb807b5bf8dfeb87fe602e92e73","modified":1763976519472},{"_id":"themes/anzhiyu/source/css/_page/categories.styl","hash":"f01ee74948cedb44e53cd3bb1ef36b7d2778ede7","modified":1763976519474},{"_id":"themes/anzhiyu/source/css/_page/404.styl","hash":"50dbb9e6d98c71ffe16741b8c1b0c1b9771efd2b","modified":1763976519473},{"_id":"themes/anzhiyu/source/css/_page/common.styl","hash":"99ca9cb011349c045ed779bd5db9763c2073bbfe","modified":1763976519474},{"_id":"themes/anzhiyu/source/css/_page/equipment.styl","hash":"8ed450c37e8b5b5d6ce04245b54fc0877b0ad0d9","modified":1763976519474},{"_id":"themes/anzhiyu/source/css/_layout/sidebar.styl","hash":"57d6857a1209dacb6f3fd0eb3c3f539fef3a2daf","modified":1763976519472},{"_id":"themes/anzhiyu/source/css/_page/reward.styl","hash":"3a6e95f58b1692c6ee67a669fc965d9dea026186","modified":1763976519475},{"_id":"themes/anzhiyu/source/css/_page/about.styl","hash":"72a3345b9791fcf51bb74ff6eebfda4674e8f60d","modified":1763976519473},{"_id":"themes/anzhiyu/source/css/_page/homepage.styl","hash":"7b2b2b4a7f3139f7db2d535b2ed7167db8bfd0ed","modified":1763976519475},{"_id":"themes/anzhiyu/source/css/_page/tag_page.styl","hash":"704a74185d0e872ca3358567a2ecede5c2d35910","modified":1763976519475},{"_id":"themes/anzhiyu/source/css/_page/music.styl","hash":"290dd82c05bc21a0f22a7b666f2af233e9e8bbb2","modified":1763976519475},{"_id":"themes/anzhiyu/source/css/_page/flink.styl","hash":"990a1b5d937980ec1f6f764f4b5ce371279cc451","modified":1763976519474},{"_id":"themes/anzhiyu/source/css/_page/tags.styl","hash":"580feb7e8b0822a1be48ac380f8c5c53b1523321","modified":1763976519475},{"_id":"themes/anzhiyu/source/css/_mode/darkmode.styl","hash":"43391bb6a4d1908c87515851c41b8d97b847b49b","modified":1763976519473},{"_id":"themes/anzhiyu/source/css/_tags/bilbili.styl","hash":"081833e071be562201c56ec4db000b7ac144a39a","modified":1763976519477},{"_id":"themes/anzhiyu/source/css/_tags/Introduction-card.styl","hash":"ec70e67c2a8bc1a0ebe536091d97bc326faf9973","modified":1763976519477},{"_id":"themes/anzhiyu/source/css/_mode/readmode.styl","hash":"a5a27dea73ed993ce81ca691eff9eb71c2b311a7","modified":1763976519473},{"_id":"themes/anzhiyu/source/css/_tags/button.styl","hash":"af1840996356aeae6ffbee49ab86aa7834ab18a0","modified":1763976519477},{"_id":"themes/anzhiyu/source/css/_tags/checkbox.styl","hash":"2a31f4c0cd31f67342564ef22254eb317d82f331","modified":1763976519478},{"_id":"themes/anzhiyu/source/css/_tags/gallery.styl","hash":"697408d915056ae6e6814e0f24ca013f68227f74","modified":1763976519478},{"_id":"themes/anzhiyu/source/css/_tags/hexo.styl","hash":"d76c38adf1d9c1279ef4241835667789f5b736e0","modified":1763976519478},{"_id":"themes/anzhiyu/source/css/_tags/folding.styl","hash":"537320d4762bef842beabfbde9b27f0e2ece2ba6","modified":1763976519478},{"_id":"themes/anzhiyu/source/css/_tags/hide.styl","hash":"810c54530d3799fe492d9c3d4842ab5ca4243092","modified":1763976519478},{"_id":"themes/anzhiyu/source/css/_tags/inline-labels.styl","hash":"d9bdac4ca48b19cc028efc1a084ebf99c38bb8ec","modified":1763976519479},{"_id":"themes/anzhiyu/source/css/_tags/image.styl","hash":"4cf305b1d57d0c9bfe948f916fe9b124ee62fc0a","modified":1763976519478},{"_id":"themes/anzhiyu/source/css/_tags/btns.styl","hash":"903b571a6e352e5014e35e9a675b7d2d6e5b82bd","modified":1763976519477},{"_id":"themes/anzhiyu/source/css/_tags/inlineImg.styl","hash":"df9d405c33a9a68946b530410f64096bcb72560c","modified":1763976519479},{"_id":"themes/anzhiyu/source/css/_tags/label.styl","hash":"66c59e193d794cdb02cca7bd1dc4aea5a19d7e84","modified":1763976519479},{"_id":"themes/anzhiyu/source/css/_tags/media.styl","hash":"05a249c807cd7760492a9ef5914b3e363d7d1028","modified":1763976519479},{"_id":"themes/anzhiyu/source/css/_tags/site-card.styl","hash":"5ff77bfa663aca406e3a0bd822da0d6e3c3c2c8b","modified":1763976519479},{"_id":"themes/anzhiyu/source/css/_tags/note.styl","hash":"3b357c94cb8e80039cc1689161637d5b9690ff18","modified":1763976519479},{"_id":"themes/anzhiyu/source/css/_tags/span.styl","hash":"f75112e431fcbef352a7ee7f0aa85e8b2f0b4a26","modified":1763976519480},{"_id":"themes/anzhiyu/source/css/_tags/tabs.styl","hash":"b0dc66d3daafe8c3a022f7235de3d8224cb56ec9","modified":1763976519480},{"_id":"themes/anzhiyu/source/css/_tags/timeline.styl","hash":"3076b68fece8ef394cbd44570037e5e479fdd277","modified":1763976519480},{"_id":"themes/anzhiyu/source/css/_search/index.styl","hash":"fd2833ec664a9de9a7b3dd1cade7d65e3ad80ddd","modified":1763976519476},{"_id":"themes/anzhiyu/source/css/_search/local-search.styl","hash":"25e58a7a8bda4b73d0a0e551643ca01b09ccd7e5","modified":1763976519476},{"_id":"themes/anzhiyu/source/css/_search/algolia.styl","hash":"f7cb2effef6b4e587fad385d7c11b4b23c110589","modified":1763976519476},{"_id":"themes/anzhiyu/source/css/_third-party/normalize.min.css","hash":"007ada04a97d0fcaf55ee840a03f2f10b9abcbff","modified":1763976519481},{"_id":"themes/anzhiyu/source/css/_third-party/snackbar.styl","hash":"47a90d6a87744c6e4ced18b95220debef8f278d0","modified":1763976519481},{"_id":"themes/anzhiyu/source/css/_third-party/twikoo.styl","hash":"51475a99ec3281fb98ca8707e28064f91dd9c68a","modified":1763976519481},{"_id":"themes/anzhiyu/source/js/search/local-search.js","hash":"3ad66c75b4a0fc28a14a5478ee8a19fde72f837f","modified":1763976519494},{"_id":"themes/anzhiyu/source/css/_tags/tip.styl","hash":"0f712be285681bac71e96c48d0836b8fea52bf6f","modified":1763976519480},{"_id":"themes/anzhiyu/source/js/search/algolia.js","hash":"5c2a0d0489c51c6d9e54f5a3b0c6e66a5f649450","modified":1763976519494},{"_id":"themes/anzhiyu/source/js/anzhiyu/comment_barrage.js","hash":"1b30f922238f626c6a90ce2705789ba2362a2a9e","modified":1763976519492},{"_id":"themes/anzhiyu/source/js/anzhiyu/people.js","hash":"f3d2a3d0c730124d9f64dbf59486145c05a42ac6","modified":1763976519492},{"_id":"themes/anzhiyu/source/js/anzhiyu/random_friends_post.js","hash":"1548fdc0a8cb4291bc8793dc8d321c59c097c08e","modified":1763976519493},{"_id":"themes/anzhiyu/source/js/anzhiyu/ai_abstract.js","hash":"be52eb13a416b18337d3b1142277920072e698c3","modified":1763976519492},{"_id":"themes/anzhiyu/source/js/anzhiyu/right_click_menu.js","hash":"d605ee0cab24604f97ccef5747bfacaa108645ba","modified":1763976519493},{"_id":"themes/anzhiyu/layout/includes/third-party/card-post-count/twikoo.pug","hash":"56c028ba0ea8fac19f0125114d765dfc56ce2b48","modified":1763976519407},{"_id":"themes/anzhiyu/layout/includes/third-party/card-post-count/valine.pug","hash":"39427e107230a10790972349c9dd4c4f31d55eb7","modified":1763976519407},{"_id":"themes/anzhiyu/layout/includes/third-party/card-post-count/artalk.pug","hash":"6b8e29a8ad921ae50f8c43b8b7459ddc152b05ed","modified":1763976519406},{"_id":"themes/anzhiyu/layout/includes/third-party/card-post-count/index.pug","hash":"a20dd36c318c7a37870fbc9dcecbc03f94ade817","modified":1763976519406},{"_id":"themes/anzhiyu/layout/includes/third-party/comments/artalk.pug","hash":"a486578b5b9cd130dbe22e7b4ad5cbe724dc4678","modified":1763976519415},{"_id":"themes/anzhiyu/layout/includes/third-party/card-post-count/waline.pug","hash":"b40b0cbd0389f03fed5ddf624fa598613135046a","modified":1763976519408},{"_id":"themes/anzhiyu/layout/includes/third-party/comments/twikoo.pug","hash":"1582986ede8a9c727004d1dc114bd7ee92880641","modified":1763976519416},{"_id":"themes/anzhiyu/layout/includes/third-party/comments/index.pug","hash":"d5bb2cd8d96523a6693fa1bfa68c307f6c63f325","modified":1763976519415},{"_id":"themes/anzhiyu/layout/includes/third-party/comments/js.pug","hash":"29539a0f6c5622efba25805c8ff3252a70e1a2b7","modified":1763976519416},{"_id":"themes/anzhiyu/layout/includes/third-party/comments/giscus.pug","hash":"1359563b73f3ce1629be49dc7780b4670f370995","modified":1763976519415},{"_id":"themes/anzhiyu/layout/includes/third-party/comments/valine.pug","hash":"e54a60b1795721153faaa887b46a68b68bcd3abc","modified":1763976519416},{"_id":"themes/anzhiyu/layout/includes/third-party/chat/chatra.pug","hash":"ddce8352b371a1fb426bdb6c33f587eb37a69647","modified":1763976519408},{"_id":"themes/anzhiyu/layout/includes/third-party/chat/crisp.pug","hash":"2fb098a7aa45010a8cd212dc0bd5308c6e7c63e3","modified":1763976519409},{"_id":"themes/anzhiyu/layout/includes/third-party/chat/daovoice.pug","hash":"9b57a8e13de8fc51a5f550854e47164fd8ac1be8","modified":1763976519410},{"_id":"themes/anzhiyu/layout/includes/third-party/chat/index.pug","hash":"9eff7757c825d776edde1c1dd09623a91d891e6b","modified":1763976519411},{"_id":"themes/anzhiyu/layout/includes/third-party/comments/waline.pug","hash":"612ab49a4a2e676c7c1110b5f618726b2dc7ddf7","modified":1763976519417},{"_id":"themes/anzhiyu/layout/includes/third-party/chat/tidio.pug","hash":"76b08a6da3eed8f90304fa6546783e5c04a792fb","modified":1763976519412},{"_id":"themes/anzhiyu/layout/includes/third-party/math/index.pug","hash":"b8ae5fd7d74e1edcef21f5004fc96147e064d219","modified":1763976519419},{"_id":"themes/anzhiyu/layout/includes/third-party/math/mathjax.pug","hash":"fc072ac839401174b5d3cf9acd3b694246c23a55","modified":1763976519419},{"_id":"themes/anzhiyu/layout/includes/third-party/runtime/runtime-js.pug","hash":"63391ff01fd55d8c48b3a9e46d83d4af75908ffb","modified":1763976519425},{"_id":"themes/anzhiyu/layout/includes/third-party/math/katex.pug","hash":"235fb3c8b4da8ec6b010d4d30d3594d3dbfd0bbe","modified":1763976519419},{"_id":"themes/anzhiyu/layout/includes/third-party/share/addtoany.pug","hash":"85c92f8a7e44d7cd1c86f089a05be438535e5362","modified":1763976519427},{"_id":"themes/anzhiyu/layout/includes/third-party/share/index.pug","hash":"b0e932171cbdfeb8a98bc1e8b78172f672f5fdfd","modified":1763976519428},{"_id":"themes/anzhiyu/layout/includes/third-party/search/algolia.pug","hash":"fbdeb32013088e8f7f4c8a6a1f20622e58dc09c2","modified":1763976519426},{"_id":"themes/anzhiyu/layout/includes/third-party/search/docsearch.pug","hash":"cb42537ea530d6679a46a1db092da0e91756b2c3","modified":1763976519426},{"_id":"themes/anzhiyu/layout/includes/third-party/math/mermaid.pug","hash":"10f3949da0889c1ec3e3617da290927d834d1f6d","modified":1763976519420},{"_id":"themes/anzhiyu/layout/includes/third-party/search/local-search.pug","hash":"d3f133564dda5e2c51661a914ae5aab8fb9dbaf6","modified":1763976519427},{"_id":"themes/anzhiyu/layout/includes/third-party/share/share-js.pug","hash":"f61d63724ea5c5f352568b3a16bde023affefbe5","modified":1763976519428},{"_id":"themes/anzhiyu/layout/includes/third-party/newest-comments/artalk.pug","hash":"bbaaa94d99c345f7412803a98bf3d83722743dfb","modified":1763976519420},{"_id":"themes/anzhiyu/layout/includes/third-party/search/index.pug","hash":"a99a41334387ee9a46c6f8e8212331a29a10d159","modified":1763976519426},{"_id":"themes/anzhiyu/layout/includes/third-party/newest-comments/waline.pug","hash":"3fbf5700aedaa63ea09e8f68c063961db785fa44","modified":1763976519422},{"_id":"themes/anzhiyu/layout/includes/third-party/newest-comments/index.pug","hash":"6dafa98f6082e909c00396a4793ed3e7c866f824","modified":1763976519421},{"_id":"themes/anzhiyu/source/css/_extra/album/album_detail.css","hash":"b75189ece986fa6b645751791a72d2783fbae05f","modified":1763976519454},{"_id":"themes/anzhiyu/layout/includes/third-party/newest-comments/twikoo-comment.pug","hash":"3b20540a0e687cb05fd71a716e78f16a175a7d58","modified":1763976519421},{"_id":"themes/anzhiyu/layout/includes/third-party/newest-comments/valine.pug","hash":"3de61f1b229f2928ae120ecfa6166862c1735d18","modified":1763976519421},{"_id":"themes/anzhiyu/source/css/_extra/aside_weixin/aside_weixin.css","hash":"17015ed4c296ea890e807716c6abe0a11ddcb906","modified":1763976519455},{"_id":"themes/anzhiyu/source/css/_extra/album/album.css","hash":"d3938a8e6edcf2be0dff02728f605406feba800d","modified":1763976519454},{"_id":"themes/anzhiyu/source/css/_extra/catalog_list/catalog_list.css","hash":"77526a3317c058a965ca44e446412f1d74b97c96","modified":1763976519455},{"_id":"themes/anzhiyu/source/css/_extra/clock/clock.css","hash":"b91f3216c6e859f89d9348bd9517c764e607402d","modified":1763976519456},{"_id":"themes/anzhiyu/source/css/_extra/anzhiyu/custom.css","hash":"262291db00a343991c5472131804a4fd00deed4f","modified":1763976519454},{"_id":"themes/anzhiyu/source/css/_extra/categoryBar/categoryBar.css","hash":"b9ab5612f4d24092388defcb8db7399445a10710","modified":1763976519456},{"_id":"themes/anzhiyu/source/css/_extra/code/code.css","hash":"976b68722d6698d7687f362532d7a0e6b6050d3e","modified":1763976519456},{"_id":"themes/anzhiyu/source/css/_extra/code/details_summary.css","hash":"30b01d74157aaccea84c4c0d7e0ebb65f5a7f9c9","modified":1763976519456},{"_id":"themes/anzhiyu/source/css/_extra/essay_page/essay_page.css","hash":"0d62e0d6b6f57fce49d347c8ce969071933dcd45","modified":1763976519458},{"_id":"themes/anzhiyu/source/css/_extra/commentBarrage/commentBarrage.css","hash":"a1355fe5e03c5e5dbd17761cc7a80fa9758c5891","modified":1763976519457},{"_id":"themes/anzhiyu/source/css/_extra/fix/aplayer.css","hash":"00aee0451ccb5b2f402ecb7f358acf78c53cee60","modified":1763976519458},{"_id":"themes/anzhiyu/source/css/_extra/essay_page/home_essay_bar.css","hash":"bfb259092223dcdfcb1a652330dc8ea1236fe76c","modified":1763976519458},{"_id":"themes/anzhiyu/source/css/_extra/fix/categories.css","hash":"563bd4583007329c6e34c28883ee26a39af6c8f3","modified":1763976519459},{"_id":"themes/anzhiyu/source/css/_extra/fix/bilibili-ratio.css","hash":"ad6edf2b75dd717e9dff9fe4ca4db79c1599a6f9","modified":1763976519458},{"_id":"themes/anzhiyu/source/css/_extra/console/console.css","hash":"f61b9504a5f7b33d7508c9c5201c0c21ae9f8d53","modified":1763976519457},{"_id":"themes/anzhiyu/source/css/_extra/fix/bilibili-bangumi.css","hash":"81567514e32d5c2cc647aff121f405c7a7b50897","modified":1763976519458},{"_id":"themes/anzhiyu/source/css/_extra/fix/dark.css","hash":"febe18af9e0cc45c6a35f0e0ef085c182985afa6","modified":1763976519459},{"_id":"themes/anzhiyu/source/css/_extra/fix/clock.css","hash":"90e0bce1341d9e01aa0efaf9c70256ef5fe6139b","modified":1763976519459},{"_id":"themes/anzhiyu/source/css/_extra/fix/fcircle_page.css","hash":"02ce333e7f9ed6b9756a6706475192e2fd3fbd4b","modified":1763976519460},{"_id":"themes/anzhiyu/source/css/_extra/fix/hexo-tag-dplayer.css","hash":"90e6ba180e0b9267aa0bf27eb9f0a1d2e9cb3ecc","modified":1763976519460},{"_id":"themes/anzhiyu/source/css/_extra/fix/gitcalendar.css","hash":"f99c63423cbedb8f12ccea673d8e79e10a4cfb6c","modified":1763976519460},{"_id":"themes/anzhiyu/source/css/_extra/fix/comments.css","hash":"667a4182d046cb6bf0561bdb7fe8c788ae79438f","modified":1763976519459},{"_id":"themes/anzhiyu/source/css/_extra/fix/hide-block.css","hash":"15e0c13f8451bfe36fa5e464b86767bd98cab70b","modified":1763976519460},{"_id":"themes/anzhiyu/source/css/_extra/fix/link_page.css","hash":"69e5ed458c0dc10d93ebb7e4943196be1167ed5a","modified":1763976519460},{"_id":"themes/anzhiyu/source/css/_extra/fix/overflow.css","hash":"71e3bd9905684e6e2ba6e18282e982d96dc4d61d","modified":1763976519461},{"_id":"themes/anzhiyu/source/css/_extra/fix/radius.css","hash":"6ef242f7a79427da9651a26c8a07e4e56ac56a42","modified":1763976519461},{"_id":"themes/anzhiyu/source/css/_extra/footer/footer.css","hash":"d94ed305398eb831b9e7160ce54510b0d25fcf67","modified":1763976519461},{"_id":"themes/anzhiyu/source/css/_extra/fix/site-card.css","hash":"0a662f62c69d36ac583528c02346d848aa1d026a","modified":1763976519461},{"_id":"themes/anzhiyu/source/css/_extra/greeting_box/greeting_box.css","hash":"208ba729979dffdaa2f82639027a09b8c64fc5c2","modified":1763976519462},{"_id":"themes/anzhiyu/source/css/_extra/friends/friends.css","hash":"a2e50f529aa1fd60732d9a892166bb1d3ae725d7","modified":1763976519462},{"_id":"themes/anzhiyu/source/css/_extra/home_top/categorygroup.css","hash":"bc5b8a6cddca8c36a96ea5ecd1e56a5860bbb09a","modified":1763976519462},{"_id":"themes/anzhiyu/source/css/_extra/home_top/home_top.css","hash":"4bf724bd2f1a0447532456c60701e79b906c8dd0","modified":1763976519462},{"_id":"themes/anzhiyu/source/css/_extra/home_top/home_top_post_group.css","hash":"04d9a3bd9cb247f4c391af0cd7cb47206974ceaf","modified":1763976519463},{"_id":"themes/anzhiyu/source/css/_extra/home_top/swiperstyle.css","hash":"ea249de8cebc68cda7e62705df2acd7c78d13f37","modified":1763976519463},{"_id":"themes/anzhiyu/source/css/_extra/home_top/top_group_banner.css","hash":"909b63f4b66c1c324ea302e93b3cb7c038306d0b","modified":1763976519463},{"_id":"themes/anzhiyu/source/css/_extra/reset/reset.css","hash":"0617cd338ebe4be2820d03d88376b30e0f378c1c","modified":1763976519464},{"_id":"themes/anzhiyu/source/css/_extra/reward/about-reward.css","hash":"f95871737b0e883ab70b30948b2cd4339bf36756","modified":1763976519465},{"_id":"themes/anzhiyu/source/css/_extra/local_search/local_search.css","hash":"d3bc30e147897fb3026284d4244c4cf195d4588a","modified":1763976519464},{"_id":"themes/anzhiyu/source/css/_extra/runtime/runtime.css","hash":"7fd033212b0dcdb06ca7f7a83343ea1b6044d59c","modified":1763976519465},{"_id":"themes/anzhiyu/source/css/_extra/skills/skills.css","hash":"6dcf742c38dcdf988e3d6f545fbfa0227d3155ea","modified":1763976519466},{"_id":"themes/anzhiyu/source/css/_extra/room/room.css","hash":"82eb83dc296c045b0388cd9417ff1bc822e46f41","modified":1763976519465},{"_id":"themes/anzhiyu/source/css/_extra/single_card/single_card.css","hash":"1559219f059389933e435dd081af5e6e17ef4b75","modified":1763976519466},{"_id":"themes/anzhiyu/source/css/_extra/tag/link.css","hash":"dbc87df28d7dfa366ab3c91ac61967ac48d7877c","modified":1763976519466},{"_id":"themes/anzhiyu/source/css/_highlight/highlight/diff.styl","hash":"cf1fae641c927621a4df1be5ca4a853b9b526e23","modified":1763976519468},{"_id":"themes/anzhiyu/source/css/_highlight/highlight/index.styl","hash":"75b01603cacde3b58cc2719dce1f72458ecf3842","modified":1763976519468},{"_id":"themes/anzhiyu/source/css/_extra/tag/site.css","hash":"631a068d827a84a46fa03282b4ca38936c4bc4f3","modified":1763976519466},{"_id":"themes/anzhiyu/source/css/_highlight/prismjs/index.styl","hash":"7751de787861a9b45cf3879fb18601abc8935bde","modified":1763976519468},{"_id":"themes/anzhiyu/source/css/_highlight/prismjs/line-number.styl","hash":"8970cc1916c982b64a1478792b2822d1d31e276d","modified":1763976519469},{"_id":"themes/anzhiyu/source/css/_highlight/prismjs/diff.styl","hash":"5972c61f5125068cbe0af279a0c93a54847fdc3b","modified":1763976519468},{"_id":"source/_posts/mysql/通过excel文档快速生成表设计/1edf348b-0d13-4496-9743-dc09003846d1.png","hash":"f21ba9341f9ddcdd31258e5d6c4c3652206382d1","modified":1764207898380},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/微信截图_20240806195901.png","hash":"73207df7ab09af55aee8c66a9f9a9816c5f0420e","modified":1722945546325},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/微信截图_20240806200518.png","hash":"6e0ab0e5b70c7856073043ae78573bf39d993af3","modified":1722945920307},{"_id":"source/_posts/分享/学习it网站推荐/image_-m-m1AZh7M.png","hash":"06326b2f927af11f2f6b92c74a8c0a927dcd1c77","modified":1719370387878},{"_id":"source/_posts/分享/学习it网站推荐/image_bUw4GOE3i3.png","hash":"971882befb7ce49cdc0b9b35141c78f28f1b57a5","modified":1719370387965},{"_id":"source/_posts/分享/学习it网站推荐/image_RtiUPlWbme.png","hash":"0facd847ec0640c285287074d407aa7321a6841a","modified":1719370387919},{"_id":"source/_posts/分享/学习it网站推荐/image_tMLd_Cap6a.png","hash":"ef3b3bf0189dd4e5fc0b0e0fcdde2d5d7f38d0b3","modified":1719370387998},{"_id":"source/_posts/分享/学习it网站推荐/image_qBL4LWSs2U.png","hash":"8cb6d4fc5c472da02a61a45a2effc3e70d890f1d","modified":1719370387981},{"_id":"source/_posts/mysql/通过excel文档快速生成表设计/bbe82095-e9ee-4c41-969c-0a70a9c6f9f2.png","hash":"cb7171c5c2c4f59e367d529d93545666c0a41e3a","modified":1764207770544},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/微信截图_20240806200853.png","hash":"934df7f58206364d1129777a1e317f357e0b4056","modified":1722946134988},{"_id":"source/_posts/分享/学习it网站推荐/image_PEAqPgamQe.png","hash":"251aee9da55d0cf769bc29e54fbf659c06b1051c","modified":1719370387896},{"_id":"source/_posts/分享/学习it网站推荐/image_zZOb0Uu1MN.png","hash":"8872b7055947069ca0a107a046adb3e21e675d33","modified":1719370388013},{"_id":"source/_posts/elasticsearch/es高级命令.md","hash":"e7123eb8f7937505c2f7a50684922b33f3b14ea4","modified":1740645774317},{"_id":"themes/anzhiyu/source/img/404.jpg","hash":"030b9c7c9d654b3d67c1249a6e5900bf40c79373","modified":1763976519483},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/img.png","hash":"f365826c725e6f50d07f8cb29615e8d4a259d58c","modified":1722946018310},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/微信截图_20240806200831.png","hash":"c754552bfa50ed9de26bcf12bb37a75ca139626d","modified":1722946114203},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/微信截图_20240806200924.png","hash":"262fe8b58283ec1070ba000ff1732e04b028a346","modified":1722946166462},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/微信截图_20240806200913.png","hash":"60bceb6c601ccdd49ad3b4c679511a9b16b30aea","modified":1722946155289},{"_id":"source/_posts/linux/使用图形化对linux磁盘进行扩容/微信截图_20240806200751.png","hash":"3e549a4f07a3b94277edc03d6d04ae7ae673d6da","modified":1722946085151},{"_id":"source/_posts/mysql/通过excel文档快速生成表设计/ae4eaa42-ca46-4d69-9cef-068878d45872 (1).png","hash":"49cc07194c6d8621571ab4be7ab57030ee0dfc4c","modified":1764207862295},{"_id":"themes/anzhiyu/source/img/friend_404.gif","hash":"4c0a482bce3710942aff900d62c48333827e5a53","modified":1763976519486},{"_id":"themes/anzhiyu/source/img/loading.gif","hash":"b9e8d78b86bc48d565e26c8c1ea275c2c758fb0d","modified":1763976519490},{"_id":"source/_posts/分享/学习it网站推荐/image_SOZXE0ImbY.png","hash":"e72edf2eb3099761c51818c99464bbf5d2812395","modified":1719370387945},{"_id":"source/resource/安卓逆向｜高版本安卓（7.0+）用 Fiddler 无法抓到 HTTPS 包问题解决方案刚开始学习安卓逆向的小伙伴肯定都 - 掘金.html","hash":"e4702391c782a82dfabaccac4b932539327a5735","modified":1727170637506},{"_id":"source/resource/mihomo-linux-amd64-v1.18.6.deb","hash":"bc855430f0b8f7b2637a13f6e8d5e75f39070ab1","modified":1721912142425},{"_id":"public/anzhiyu/random.js","hash":"531b084c0806412c35665e334a9e7041ec4a8c36","modified":1767928602030},{"_id":"public/404.html","hash":"49efd3d9e66bba2b29374bfd161b47ee13a65a91","modified":1767928602030},{"_id":"public/about/index.html","hash":"314da051d433f7a7d9d21e3acd24daf57c802819","modified":1767928602030},{"_id":"public/tags/index.html","hash":"c4690d7f3409239045a5697d25c822567f660bec","modified":1767928602030},{"_id":"public/linux/linux下修复网卡出入口策略/index.html","hash":"5ecf8aedb9ca29c4119e13a1f7578277ff6cfb95","modified":1767928602030},{"_id":"public/categories/index.html","hash":"d4b1ea73331b3596191a6863e317c18fb5d858f4","modified":1767928602030},{"_id":"public/k8s/将生产的流量镜像到预生产环境的一些思考/index.html","hash":"72b894bb52a9e90daad78fc71d17869318f075f5","modified":1767928602030},{"_id":"public/docker/基于k8s实现优雅停机/index.html","hash":"d9f5df08fa6441b47956816a1979af07bc1d28aa","modified":1767928602030},{"_id":"public/mysql/通过excel文档快速生成表设计/index.html","hash":"a088ed22c17e95bfb6a3c8edbeaf0db275caecd9","modified":1767928602030},{"_id":"public/java/Java通过JNI调用C-C/index.html","hash":"dabf0ef556f7941d543f49cbeef9e62a73b84849","modified":1767928602030},{"_id":"public/linux/UNIX操作系统采用i结点管理文件的存储空间/index.html","hash":"71de33798874bfbddd55d4ccf6c0922bbe03989f","modified":1767928602030},{"_id":"public/mysql/mysql异常排查sql/index.html","hash":"05aafe81ff185f6a4641e2166fee63e97c14da0f","modified":1767928602030},{"_id":"public/数学/向量与坐标轴的夹角余弦值/index.html","hash":"3f077ed51383c2b2223dce3ded36fc7dde086907","modified":1767928602030},{"_id":"public/docker/docker中运行chrome并使用代码控制/index.html","hash":"fec0b5b1148ef004aa7bce5f620d8300978c62b0","modified":1767928602030},{"_id":"public/交易/交易策略总结/index.html","hash":"b42297c237472eb2bc683dcac1e19a5e7fd8666b","modified":1767928602030},{"_id":"public/elasticsearch/es高级命令/index.html","hash":"d6b753ffdbd3ce1f81422da63923f001720dc515","modified":1767928602030},{"_id":"public/elasticsearch/es常用命令/index.html","hash":"5b5bcd1d7a352216ab4151c7deb862de0402ce3d","modified":1767928602030},{"_id":"public/elasticsearch/logstach安装和导入数据/index.html","hash":"38d1ff1cb2326284079e6c8fe96331b5da1625d4","modified":1767928602030},{"_id":"public/elasticsearch/在Docker容器中运行Elasticsearch-Kibana和Cerebro/index.html","hash":"8a66599a888b01c88ea25799656e9c49404fb917","modified":1767928602030},{"_id":"public/linux/nginx配置https/index.html","hash":"7b32205b1b0d5ce31810c86e05e0d0c598a83923","modified":1767928602030},{"_id":"public/linux/linux-配置开机自启/index.html","hash":"90ea0f17cf9469a60960f45b72fa545f8f2083e1","modified":1767928602030},{"_id":"public/linux/linux-常用命令/index.html","hash":"bc50a3d78547f6e9c0a559add35e182803537e7c","modified":1767928602030},{"_id":"public/docker/docker常用命令/index.html","hash":"8d0e07432a3d8fa3f4c89af72a61952d739cbb91","modified":1767928602030},{"_id":"public/mysql/mysql-数据备份脚本/index.html","hash":"459259fd2e16ada07981a53fc08903bf9bd6dc63","modified":1767928602030},{"_id":"public/计算机考试/设信道带宽为16kHz-信噪比为30dB-则该信道的信道容量大约为/index.html","hash":"09d1b13e6bf8f0971856cfa6f482aad34cd2140a","modified":1767928602030},{"_id":"public/linux/openvpn中使用client1访问xxx域名时，走client2的网络流量来访问/index.html","hash":"faa865109932760e113c17eeb1c219cd07a996af","modified":1767928602030},{"_id":"public/黑客/亿赛通电子文档安全管理系统XStream反序列化漏洞任意文件上传利用/index.html","hash":"dae951e696a68d67a876a1e0705487c4cea7955b","modified":1767928602030},{"_id":"public/spring-boot/spring-state-machine/index.html","hash":"9a004cf5129a63da5e9fe04b1d81fe66d6d7d4ae","modified":1767928602030},{"_id":"public/java/Application-toolkit-trace-cross-thread/index.html","hash":"bd6b6d569be4ee20c42505ff9e67d69fa4bbae05","modified":1767928602030},{"_id":"public/交易/交易下单时金额变化/index.html","hash":"942b9b5e2966c597890eccd6008e8fcc8d712db2","modified":1767928602030},{"_id":"public/linux/github-将远程仓库更新到自己的仓库中/index.html","hash":"a731543efa286e673fb4b2d195662d0532f36b7f","modified":1767928602030},{"_id":"public/linux/linux下通过端口找到进程/index.html","hash":"d76746f02427e390807c612591f6aac4464d39d4","modified":1767928602030},{"_id":"public/linux/openvpn-部署脚本/index.html","hash":"68c4b7a731b3bffe11557b70aa94ffa6b31caf6e","modified":1767928602030},{"_id":"public/linux/使用图形化对linux磁盘进行扩容/index.html","hash":"6e84cfb393d4eeee6aca54400ae70c11a7aed567","modified":1767928602030},{"_id":"public/linux/对linux磁盘进行无损扩容/index.html","hash":"076a4c60ed063b8cd48231efc36adda00cba6690","modified":1767928602030},{"_id":"public/redis/解读redis分布式锁核心逻辑/index.html","hash":"bf858e8e198d9b5a29186d4987e0f99f5d2e3110","modified":1767928602030},{"_id":"public/spring-boot/使用切面或拦截器打印异常日志/index.html","hash":"56c8d89bfbe63e7eb73aeda903732bf489b9a2c6","modified":1767928602030},{"_id":"public/linux/在linux上使用代理/index.html","hash":"d002e369fe99104645031f1f7699f12dfc86e535","modified":1767928602030},{"_id":"public/mysql/select-for-update用法的好处/index.html","hash":"cab86b06d241d4af8dc02605b0f1a6bd3503c048","modified":1767928602030},{"_id":"public/linux/tcp6-如何-改成tcp4/index.html","hash":"feca119e6827d3cf2b0ee3f6e43363653fade6bf","modified":1767928602030},{"_id":"public/linux/nginx配置上传文件大小/index.html","hash":"b550f3d17f84472c92ad1ec3af6aa1a06e67c582","modified":1767928602030},{"_id":"public/linux/docker修改应用为自动启动/index.html","hash":"4eb8a2de0248ff7d58bc0e01f1239275e38e62f8","modified":1767928602030},{"_id":"public/linux/linux下实现钉钉告警/index.html","hash":"019241b468f078458a2cf7cc4b15f04259bb604e","modified":1767928602030},{"_id":"public/comments/index.html","hash":"765d873c458b12ea603a1d2e06c038f8134050c5","modified":1767928602030},{"_id":"public/分享/学习it网站推荐/index.html","hash":"9dcba493b3f5e049019786de37e421cda0a247e5","modified":1767928602030},{"_id":"public/archives/index.html","hash":"1c0d4120c145d76dcda592d21e8499fac8cf59a3","modified":1767928602030},{"_id":"public/archives/page/2/index.html","hash":"e39b9a2d163680adb052199685f1fedd70dc9e51","modified":1767928602030},{"_id":"public/archives/page/3/index.html","hash":"63a43e4288e2c0fc535062a1471948753105f746","modified":1767928602030},{"_id":"public/archives/page/4/index.html","hash":"c7d12b638d52d69ec5638dc944ca6931b968546f","modified":1767928602030},{"_id":"public/archives/2024/index.html","hash":"555cffb703ee2b3356d6dcd42a2c85db542f2424","modified":1767928602030},{"_id":"public/archives/2024/page/2/index.html","hash":"cd38787589b1c78fcd5fbbdb432f0e3f9683f4c5","modified":1767928602030},{"_id":"public/archives/2024/06/index.html","hash":"4cabaa7fd1f228d6554121cab7af87c341eca2a3","modified":1767928602030},{"_id":"public/archives/2024/07/index.html","hash":"e2457765376e08922424869632e2a191f9ad0bc6","modified":1767928602030},{"_id":"public/archives/2024/08/index.html","hash":"f913ec4534ba371d7444a5d8a55881ebb0575b37","modified":1767928602030},{"_id":"public/archives/2024/09/index.html","hash":"ad922d3d3075d66a050d5e5e09d0ca2949f22d46","modified":1767928602030},{"_id":"public/archives/2024/10/index.html","hash":"4738c2d075bf67a986905ea6499f1df0965b5b33","modified":1767928602030},{"_id":"public/archives/2025/page/2/index.html","hash":"45f2dd6c4448b6ad29fdb5e4d6aaaebeda9fc3b6","modified":1767928602030},{"_id":"public/archives/2025/02/index.html","hash":"be15bc493b113634a35ebf2fd82239badf00ed36","modified":1767928602030},{"_id":"public/archives/2025/03/index.html","hash":"f80c5057f800e719690ac5edbb998abb912f2d79","modified":1767928602030},{"_id":"public/archives/2025/index.html","hash":"2d3ea3a2fb86675bba2e2cee1b4a2ed401b84127","modified":1767928602030},{"_id":"public/archives/2025/04/index.html","hash":"5397fd8cabd30682fe8443af3d198495344c31c9","modified":1767928602030},{"_id":"public/archives/2025/10/index.html","hash":"d937db648efac433f393fb01d1c4019f9276dc2a","modified":1767928602030},{"_id":"public/archives/2025/06/index.html","hash":"b669a88a28938b47302c6cc59a7cf7c6744aed37","modified":1767928602030},{"_id":"public/archives/2025/11/index.html","hash":"a99d521d1bd12adb5a5e2a80268b5ca7c09dc551","modified":1767928602030},{"_id":"public/index.html","hash":"0714e61ad3fb1a0a9d1062c39902740a47f5a8a8","modified":1767928602030},{"_id":"public/page/3/index.html","hash":"e75209a954c35623eddedd785c8468f3ff13db2f","modified":1767928602030},{"_id":"public/page/2/index.html","hash":"586466889ad3e8a01ddd47c6c018fabb8fa910c6","modified":1767928602030},{"_id":"public/page/4/index.html","hash":"aa8a15253ff71abc78be9a49669ef6c8f775fef4","modified":1767928602030},{"_id":"public/categories/Java/index.html","hash":"39501ab85f13fa8cd63302c1d697d7b5daab812d","modified":1767928602030},{"_id":"public/categories/elasticsearch/index.html","hash":"2a4c93bac1d7b38e81be2a148b54636de3938732","modified":1767928602030},{"_id":"public/categories/生产环境/index.html","hash":"91efa622ab58c88ef787fc2a750e2d4cb2714b1e","modified":1767928602030},{"_id":"public/categories/docker/index.html","hash":"6f072ea8aa300b32d30a273add6013c327111ada","modified":1767928602030},{"_id":"public/categories/k8s/index.html","hash":"b864d7bf35213cae8315d96392bd1f4bd69ed7b8","modified":1767928602030},{"_id":"public/categories/mysql/index.html","hash":"477ed63ae651f38cd3655b32025a0a1f5213ba76","modified":1767928602030},{"_id":"public/categories/linux/index.html","hash":"3ec7657e9331c02ef79257fe10c10a2fadadd1bb","modified":1767928602030},{"_id":"public/categories/linux/page/2/index.html","hash":"ecb221baac97b4f4c94a3df995213472c8c3263c","modified":1767928602030},{"_id":"public/categories/clash/index.html","hash":"9bdf33a8ba87fd64ef5a43b66b20b168aed33e57","modified":1767928602030},{"_id":"public/categories/交易/index.html","hash":"8dec55c8a261d83964b2ed4ce03b3214f921a16d","modified":1767928602030},{"_id":"public/categories/redis/index.html","hash":"60e72809974f6b3209e760bf54a6759ee830168f","modified":1767928602030},{"_id":"public/categories/spring-boot/index.html","hash":"15eba185358ac453c391fcacfd5de1ad36a2e24a","modified":1767928602030},{"_id":"public/categories/分享/index.html","hash":"592ca96db88ffedde8cde3d255bc5a83cf52a7b3","modified":1767928602030},{"_id":"public/categories/黑客/index.html","hash":"cb420b087680f2696b8c069390053ad7ff3027e7","modified":1767928602030},{"_id":"public/categories/计算机考试/index.html","hash":"dc0c379ebf871b661c8aca038631b1bd0fc8ab92","modified":1767928602030},{"_id":"public/tags/并发/index.html","hash":"b6988a639577fb7181ed94bf0aa31cad0a7ce75b","modified":1767928602030},{"_id":"public/tags/JNI/index.html","hash":"2988c415184c9bfd1bfc91de423c786607e38827","modified":1767928602030},{"_id":"public/tags/学习笔记/index.html","hash":"b5fc3ae1f1c199129a806076545a3b0999e85836","modified":1767928602030},{"_id":"public/tags/docker部署/index.html","hash":"be2b1deff70626008141a15acdc3925b8ba9063c","modified":1767928602030},{"_id":"public/tags/k8s/index.html","hash":"5c230f7a182c3b527178025aebd9b73d350f1519","modified":1767928602030},{"_id":"public/tags/chrome/index.html","hash":"eb4875f983d318a57b0d75da841ad53815e98f39","modified":1767928602030},{"_id":"public/tags/命令/index.html","hash":"8d945ed256152864b27d3a22d4f1b9e55f5acea1","modified":1767928602030},{"_id":"public/tags/备份/index.html","hash":"c865c3730c68eea3b3bc143000e970bc28f6b5fc","modified":1767928602030},{"_id":"public/tags/事务/index.html","hash":"51d400c6781c5c740ee5ed73f253e507740897d5","modified":1767928602030},{"_id":"public/tags/docker/index.html","hash":"fa9d6910851f5a9adf5909a9fcf09575776457c2","modified":1767928602030},{"_id":"public/tags/表设计/index.html","hash":"759c129e334d6b62f55837bb8ffe5bfb91afd464","modified":1767928602030},{"_id":"public/tags/git/index.html","hash":"7df8467f2a437ede556fdd1c8ca94961ced3cf39","modified":1767928602030},{"_id":"public/tags/常用命令/index.html","hash":"c25fdc0ace8c954baf6b284b0c9ffa597ee6c097","modified":1767928602030},{"_id":"public/tags/开机自启/index.html","hash":"ee07e32391f238d4741357536e5323c627383500","modified":1767928602030},{"_id":"public/tags/报警/index.html","hash":"d070559767265baf4d5ca0900a4ef438dd05996e","modified":1767928602030},{"_id":"public/tags/查找进程/index.html","hash":"c04f18f47b999c126e2ea7bbc0e0cdcb9628055a","modified":1767928602030},{"_id":"public/tags/nginx/index.html","hash":"dac588eedf77500154ec9835970a34c66bda8531","modified":1767928602030},{"_id":"public/tags/网络/index.html","hash":"c0fc1f86687bbb14f13fe80c349cbe051b8e5983","modified":1767928602030},{"_id":"public/tags/openvpn/index.html","hash":"e1d1a58bc7f727a7b568cfeba1c99e8569a3f05e","modified":1767928602030},{"_id":"public/tags/扩容磁盘/index.html","hash":"73acf706bd48321a625f352fddb772a8f8be0774","modified":1767928602030},{"_id":"public/tags/翻墙/index.html","hash":"9df375129aedfe4dc46fbead468e92aecc884807","modified":1767928602030},{"_id":"public/tags/账户资金/index.html","hash":"12639f9509b6e4938932a9cee15d3fa0bdd89c5b","modified":1767928602030},{"_id":"public/tags/lua表达式/index.html","hash":"aeed4866a2fcc8190aa7cbce96533baff8dcb27d","modified":1767928602030},{"_id":"public/tags/交易策略/index.html","hash":"23bbb57b82eee15274ba2ca879caa87a011e6f1b","modified":1767928602030},{"_id":"public/tags/状态机/index.html","hash":"7ca232e2ac0f3600197f7aaa7ac2bf5a38b3f948","modified":1767928602030},{"_id":"public/tags/网站资源/index.html","hash":"7d18493f5844381497e721d856c7d446584b127c","modified":1767928602030},{"_id":"public/tags/打印异常日志/index.html","hash":"100c9aead17b3d11f4a3e83640c41cab81ffc67e","modified":1767928602030},{"_id":"public/tags/漏洞/index.html","hash":"e7b33573029ee37ec65e4dca9f763e705cf4f5ca","modified":1767928602030},{"_id":"public/tags/自学公式/index.html","hash":"f7c895e5d32217463cb99b97efcd78a485c19e52","modified":1767928602030},{"_id":"public/img/algolia.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1764212980219},{"_id":"public/favicon.ico","hash":"14310db268ea8d3b2096f434c6e293fc207f5f09","modified":1764212980219},{"_id":"public/img/512.png","hash":"6988b23a31304d9de45b95a1e7c05dd42024e560","modified":1764212980219},{"_id":"public/img/favicon.ico","hash":"14310db268ea8d3b2096f434c6e293fc207f5f09","modified":1764212980219},{"_id":"public/img/comment_bg.png","hash":"91612a887446fb436e9151981e2289f2a426a3e5","modified":1764212980219},{"_id":"public/img/default_cover.jpg","hash":"455fa65e2736f61ac36360dd4f76fc1ab6a1cdd5","modified":1764212980219},{"_id":"public/img/siteicon/16.png","hash":"8dc6ca32ff1264f7c1c3a8f62727a8c96ea7525b","modified":1764212980219},{"_id":"public/img/siteicon/manifest-icon-192.maskable.png","hash":"528b94ebcd34fb55436d64fdda76ef43ccbf031f","modified":1764212980219},{"_id":"public/img/siteicon/manifest-icon-512.maskable.png","hash":"6f8b4b3df8d1498db55a559f7106dc9b6e6af647","modified":1764212980219},{"_id":"public/resource/logstash.conf","hash":"fe299068c6a2c1dacddec164ea613f9ffe70dac9","modified":1764212980219},{"_id":"public/img/siteicon/apple-icon-180.png","hash":"7f580ec4819c9ef10b1306102152f4473f037a98","modified":1764212980219},{"_id":"public/img/siteicon/32.png","hash":"147aae33224066ef2a5987c3cbbfa4309c49cef4","modified":1764212980219},{"_id":"public/resource/openvpn.sh","hash":"87de7e0b919a17c8192e6f57c2ce55f23f216714","modified":1764212980219},{"_id":"public/css/index.css","hash":"1efacc7c6fff332251528c8cf07a11d62910bc08","modified":1764212980219},{"_id":"public/css/var.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1764212980219},{"_id":"public/js/tw_cn.js","hash":"6cbec565e98cbd49aa75e6161d8fa996ae3be91a","modified":1764212980219},{"_id":"public/js/main.js","hash":"888563ad7324e565e6f5060ca126d69c7309bef1","modified":1764212980219},{"_id":"public/js/search/algolia.js","hash":"5c2a0d0489c51c6d9e54f5a3b0c6e66a5f649450","modified":1764212980219},{"_id":"public/js/anzhiyu/comment_barrage.js","hash":"1b30f922238f626c6a90ce2705789ba2362a2a9e","modified":1764212980219},{"_id":"public/js/anzhiyu/people.js","hash":"f3d2a3d0c730124d9f64dbf59486145c05a42ac6","modified":1764212980219},{"_id":"public/js/utils.js","hash":"68e7f87c38365ef1271b69943395aa5fdb5417ea","modified":1764212980219},{"_id":"public/js/search/local-search.js","hash":"3ad66c75b4a0fc28a14a5478ee8a19fde72f837f","modified":1764212980219},{"_id":"public/js/anzhiyu/random_friends_post.js","hash":"1548fdc0a8cb4291bc8793dc8d321c59c097c08e","modified":1764212980219},{"_id":"public/js/anzhiyu/ai_abstract.js","hash":"be52eb13a416b18337d3b1142277920072e698c3","modified":1764212980219},{"_id":"public/js/anzhiyu/right_click_menu.js","hash":"d605ee0cab24604f97ccef5747bfacaa108645ba","modified":1764212980219},{"_id":"public/img/404.jpg","hash":"030b9c7c9d654b3d67c1249a6e5900bf40c79373","modified":1764212980219},{"_id":"public/img/friend_404.gif","hash":"4c0a482bce3710942aff900d62c48333827e5a53","modified":1764212980219},{"_id":"public/img/loading.gif","hash":"b9e8d78b86bc48d565e26c8c1ea275c2c758fb0d","modified":1764212980219},{"_id":"public/resource/安卓逆向｜高版本安卓（7.0+）用 Fiddler 无法抓到 HTTPS 包问题解决方案刚开始学习安卓逆向的小伙伴肯定都 - 掘金.html","hash":"e4702391c782a82dfabaccac4b932539327a5735","modified":1764212980219},{"_id":"public/resource/mihomo-linux-amd64-v1.18.6.deb","hash":"bc855430f0b8f7b2637a13f6e8d5e75f39070ab1","modified":1764212980219},{"_id":"source/resource/49172c7d-e632-47b4-9bc4-f792ae82b980.jpeg","hash":"5d482004a4ded0cb04c3cfce579bddf58b9c9b84","modified":1764213403309},{"_id":"source/_posts/spring-boot/grafana-prometheus-springboot监控平台.md","hash":"7ef83013a3880c0a1354a17790b1c9bea0729763","modified":1764731545297},{"_id":"source/_posts/java/java中傲人的写法.md","hash":"f2940d9985c0a7b7cd9ddac2fccefe0d1687edcd","modified":1764408174240},{"_id":"source/_posts/flink/异构系统实时数据同步方案.md","hash":"11228d2788287925bd815885924699779d7f0745","modified":1766396479360},{"_id":"public/flink/异构系统实时数据同步方案/index.html","hash":"2f6edd49cd48c56aeb4ebeefd88beb617bd9a6b0","modified":1767928602030},{"_id":"public/spring-boot/grafana-prometheus-springboot监控平台/index.html","hash":"99fb931082014613ecc1c62ca8ef3bf298ee9bf7","modified":1767928602030},{"_id":"public/java/java中傲人的写法/index.html","hash":"970ec58efb7cfc3cbb110911e73aef0917e7e2d2","modified":1767928602030},{"_id":"public/page/5/index.html","hash":"bf60fd273741aab24972d98f8e543db002f25ca6","modified":1767928602030},{"_id":"public/categories/flink/index.html","hash":"2607d8cb1beb8598a12c4c7c3bd4351e752142fd","modified":1767928602030},{"_id":"public/tags/傲人的写法/index.html","hash":"dbe1f4d90ed096ae07def810f03beebc63122164","modified":1767928602030},{"_id":"public/tags/实时数据同步/index.html","hash":"cebe8e5128808320513b5f19a443b821f8e2f4a7","modified":1767928602030},{"_id":"public/tags/grafana-prometheus-springboot/index.html","hash":"edf5d1ecf483759755e4daf63d8d75396a4553bc","modified":1767928602030},{"_id":"public/archives/page/5/index.html","hash":"e40b76decc660e872d86bfcf5731d9d54fb26a41","modified":1767928602030},{"_id":"public/archives/2025/page/3/index.html","hash":"7e4d499d961152bcac08485fb5a5c8e3026f244e","modified":1767928602030},{"_id":"public/archives/2025/12/index.html","hash":"298e370dc593bd6f82b02a2b30dd6dc04fe809b3","modified":1767928602030},{"_id":"public/resource/49172c7d-e632-47b4-9bc4-f792ae82b980.jpeg","hash":"5d482004a4ded0cb04c3cfce579bddf58b9c9b84","modified":1766396521163},{"_id":"source/_posts/mac/mac冷知识.md","hash":"c9bd102d03f510b90437dbb8c3f4100c317bd89b","modified":1766628528017},{"_id":"public/mac/mac冷知识/index.html","hash":"8a4e40077d3bbda77f70bf91502f4ff3231cef6f","modified":1767928602030},{"_id":"public/categories/mac/index.html","hash":"262773ad7937a1b42d2fc4399cc14d4a8918d277","modified":1767928602030},{"_id":"public/tags/冷知识/index.html","hash":"5bb7c430330a38b8c65cf97c9b8033db5731ae24","modified":1767928602030},{"_id":"source/_posts/spring-boot/Spring-Cloud集成RSocket.md","hash":"c8f9bfd660119caa4a84a7119437965992832030","modified":1767928592937},{"_id":"public/spring-boot/Spring-Cloud集成RSocket/index.html","hash":"e0d5374069e4a2b5171a0ab1fd213e31f919f202","modified":1767928602030},{"_id":"public/archives/2026/index.html","hash":"1dd70d21b1131be5a0d1e1ffa00d98a757240a0b","modified":1767928602030},{"_id":"public/archives/2026/01/index.html","hash":"62581b10aab42455e54fb23cd5804e9fb5ee377a","modified":1767928602030},{"_id":"public/categories/spring-cloud/index.html","hash":"9de164cd27107d038df1fe6765ee461fe0c3bfbe","modified":1767928602030},{"_id":"public/tags/RSocket高性能TCP多路复用/index.html","hash":"8273471e8f4405c04f2f7e0eae6108a21be70f9a","modified":1767928602030}],"Category":[{"name":"Java","_id":"cmiguul8r0004ujz3hx7p5yy1"},{"name":"elasticsearch","_id":"cmiguul8t000fujz3bzxs3h8c"},{"name":"生产环境","_id":"cmiguul8u000rujz33syn0fsa"},{"name":"docker","_id":"cmiguul8u000yujz3hw052vx4"},{"name":"k8s","_id":"cmiguul8v001bujz3hsae3e8l"},{"name":"mysql","_id":"cmiguul8v001jujz3enh4fvtk"},{"name":"linux","_id":"cmiguul8w001uujz379ppgnoz"},{"name":"clash","_id":"cmiguul8y0037ujz3958wh7t8"},{"name":"交易","_id":"cmiguul90003sujz35hexfwfu"},{"name":"redis","_id":"cmiguul90003xujz3dmc94s2y"},{"name":"spring-boot","_id":"cmiguul910048ujz3dpn3e4h5"},{"name":"分享","_id":"cmiguul91004gujz36aujff26"},{"name":"黑客","_id":"cmiguul91004lujz31s6paruo"},{"name":"计算机考试","_id":"cmiguul91004pujz3hnnk3zrb"},{"name":"flink","_id":"cmjgyvrny0006kd0vh83529uf"},{"name":"mac","_id":"cmjjms6610001m20v54rk2ldo"},{"name":"spring-cloud","_id":"cmk6b1k2x0001qg0v7jju56s8"}],"Data":[],"Page":[{"title":"分类","date":"2025-02-18T06:19:20.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2025-02-18 14:19:20\ntype: categories\n---\n","updated":"2025-02-18T06:19:57.546Z","path":"categories/index.html","comments":1,"layout":"page","_id":"cmiguul8p0000ujz39itt3hnb","content":"","cover":false,"excerpt":"","more":""},{"title":"about","date":"2020-02-23T11:20:33.000Z","layout":"about","_content":"\n一刹牵着你 一瞬飞万里\n一秒心动过 一世不忘记\n\n一息间妳的吻幻化我的发肤\n一息间妳的爱让我找到转机\n\n成就这一躺生命旅程不舍不弃\n成就这一个心愿准我跟着妳\n然后找一个境地跟妳相伴一起\n无惧这一切崩坏黑暗 跨越生死\n\n飞过千万里 天已经渐晚\n衰退的视觉 倒退的时间\n\n看不到 靠感觉亦会捉紧你手\n想不起你的脸 但我心跟着走\n\n延续这一躺生命旅程不舍不弃\n延续这一个心愿准我跟着妳\n然后找一个境地跟妳相伴一起\n无惧这一切崩坏黑暗 让我守着妳\n\n忘掉这一切生命色相都认得妳\n能用心于记忆内搜索 感受妳\n明白我跟妳生命线已相连不死\n能在远方再生没了期又再一～起\n\n今世 因为妳来","source":"about/index.md","raw":"---\ntitle: about\ndate: 2020-02-23 19:20:33\nlayout: about\n---\n\n一刹牵着你 一瞬飞万里\n一秒心动过 一世不忘记\n\n一息间妳的吻幻化我的发肤\n一息间妳的爱让我找到转机\n\n成就这一躺生命旅程不舍不弃\n成就这一个心愿准我跟着妳\n然后找一个境地跟妳相伴一起\n无惧这一切崩坏黑暗 跨越生死\n\n飞过千万里 天已经渐晚\n衰退的视觉 倒退的时间\n\n看不到 靠感觉亦会捉紧你手\n想不起你的脸 但我心跟着走\n\n延续这一躺生命旅程不舍不弃\n延续这一个心愿准我跟着妳\n然后找一个境地跟妳相伴一起\n无惧这一切崩坏黑暗 让我守着妳\n\n忘掉这一切生命色相都认得妳\n能用心于记忆内搜索 感受妳\n明白我跟妳生命线已相连不死\n能在远方再生没了期又再一～起\n\n今世 因为妳来","updated":"2024-06-27T06:50:59.998Z","path":"about/index.html","comments":1,"_id":"cmiguul8q0002ujz3e5fqajtu","content":"<p>一刹牵着你 一瞬飞万里<br>一秒心动过 一世不忘记</p>\n<p>一息间妳的吻幻化我的发肤<br>一息间妳的爱让我找到转机</p>\n<p>成就这一躺生命旅程不舍不弃<br>成就这一个心愿准我跟着妳<br>然后找一个境地跟妳相伴一起<br>无惧这一切崩坏黑暗 跨越生死</p>\n<p>飞过千万里 天已经渐晚<br>衰退的视觉 倒退的时间</p>\n<p>看不到 靠感觉亦会捉紧你手<br>想不起你的脸 但我心跟着走</p>\n<p>延续这一躺生命旅程不舍不弃<br>延续这一个心愿准我跟着妳<br>然后找一个境地跟妳相伴一起<br>无惧这一切崩坏黑暗 让我守着妳</p>\n<p>忘掉这一切生命色相都认得妳<br>能用心于记忆内搜索 感受妳<br>明白我跟妳生命线已相连不死<br>能在远方再生没了期又再一～起</p>\n<p>今世 因为妳来</p>\n","cover":false,"excerpt":"","more":"<p>一刹牵着你 一瞬飞万里<br>一秒心动过 一世不忘记</p>\n<p>一息间妳的吻幻化我的发肤<br>一息间妳的爱让我找到转机</p>\n<p>成就这一躺生命旅程不舍不弃<br>成就这一个心愿准我跟着妳<br>然后找一个境地跟妳相伴一起<br>无惧这一切崩坏黑暗 跨越生死</p>\n<p>飞过千万里 天已经渐晚<br>衰退的视觉 倒退的时间</p>\n<p>看不到 靠感觉亦会捉紧你手<br>想不起你的脸 但我心跟着走</p>\n<p>延续这一躺生命旅程不舍不弃<br>延续这一个心愿准我跟着妳<br>然后找一个境地跟妳相伴一起<br>无惧这一切崩坏黑暗 让我守着妳</p>\n<p>忘掉这一切生命色相都认得妳<br>能用心于记忆内搜索 感受妳<br>明白我跟妳生命线已相连不死<br>能在远方再生没了期又再一～起</p>\n<p>今世 因为妳来</p>\n"},{"title":"标签","date":"2025-02-18T06:21:40.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2025-02-18 14:21:40\ntype: tags\n---\n","updated":"2025-02-18T06:22:33.979Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cmiguul8s0006ujz3edrg892c","content":"","cover":false,"excerpt":"","more":""}],"Post":[{"title":"Application-toolkit-trace-cross-thread","date":"2024-09-11T07:14:06.000Z","_content":"# Trace Cross Thread\nThese APIs provide ways to continuous tracing in the cross thread scenario with minimal code changes.\nAll following are sample codes only to demonstrate how to adopt cross thread cases easier.\n\n* Case 1.\n```java\n    @TraceCrossThread\n    public static class MyCallable<String> implements Callable<String> {\n        @Override\n        public String call() throws Exception {\n            return null;\n        }\n    }\n...\n    ExecutorService executorService = Executors.newFixedThreadPool(1);\n    executorService.submit(new MyCallable());\n```\n* Case 2.\n```java\n    ExecutorService executorService = Executors.newFixedThreadPool(1);\n    executorService.submit(CallableWrapper.of(new Callable<String>() {\n        @Override public String call() throws Exception {\n            return null;\n        }\n    }));\n```\nor\n```java\n    ExecutorService executorService = Executors.newFixedThreadPool(1);\n    executorService.execute(RunnableWrapper.of(new Runnable() {\n        @Override public void run() {\n            //your code\n        }\n    }));\n```\n* Case 3.\n```java\n    @TraceCrossThread\n    public class MySupplier<String> implements Supplier<String> {\n        @Override\n        public String get() {\n            return null;\n        }\n    }\n...\n    CompletableFuture.supplyAsync(new MySupplier<String>());\n```\nor\n```java\n    CompletableFuture.supplyAsync(SupplierWrapper.of(()->{\n            return \"SupplierWrapper\";\n    })).thenAccept(System.out::println);\n```\n* Case 4.\n```java\n    CompletableFuture.supplyAsync(SupplierWrapper.of(() -> {\n        return \"SupplierWrapper\";\n    })).thenAcceptAsync(ConsumerWrapper.of(c -> {\n        // your code visit(url)\n        System.out.println(\"ConsumerWrapper\");\n    }));\n```\nor\n```java\n    CompletableFuture.supplyAsync(SupplierWrapper.of(() -> {\n        return \"SupplierWrapper\";\n    })).thenApplyAsync(FunctionWrapper.of(f -> {\n        // your code visit(url)\n        return \"FunctionWrapper\";\n    }));\n```\n\n\n\n","source":"_posts/java/Application-toolkit-trace-cross-thread.md","raw":"---\ntitle: Application-toolkit-trace-cross-thread\ndate: 2024-09-11 15:14:06\ncategories: Java\ntag: 并发\n---\n# Trace Cross Thread\nThese APIs provide ways to continuous tracing in the cross thread scenario with minimal code changes.\nAll following are sample codes only to demonstrate how to adopt cross thread cases easier.\n\n* Case 1.\n```java\n    @TraceCrossThread\n    public static class MyCallable<String> implements Callable<String> {\n        @Override\n        public String call() throws Exception {\n            return null;\n        }\n    }\n...\n    ExecutorService executorService = Executors.newFixedThreadPool(1);\n    executorService.submit(new MyCallable());\n```\n* Case 2.\n```java\n    ExecutorService executorService = Executors.newFixedThreadPool(1);\n    executorService.submit(CallableWrapper.of(new Callable<String>() {\n        @Override public String call() throws Exception {\n            return null;\n        }\n    }));\n```\nor\n```java\n    ExecutorService executorService = Executors.newFixedThreadPool(1);\n    executorService.execute(RunnableWrapper.of(new Runnable() {\n        @Override public void run() {\n            //your code\n        }\n    }));\n```\n* Case 3.\n```java\n    @TraceCrossThread\n    public class MySupplier<String> implements Supplier<String> {\n        @Override\n        public String get() {\n            return null;\n        }\n    }\n...\n    CompletableFuture.supplyAsync(new MySupplier<String>());\n```\nor\n```java\n    CompletableFuture.supplyAsync(SupplierWrapper.of(()->{\n            return \"SupplierWrapper\";\n    })).thenAccept(System.out::println);\n```\n* Case 4.\n```java\n    CompletableFuture.supplyAsync(SupplierWrapper.of(() -> {\n        return \"SupplierWrapper\";\n    })).thenAcceptAsync(ConsumerWrapper.of(c -> {\n        // your code visit(url)\n        System.out.println(\"ConsumerWrapper\");\n    }));\n```\nor\n```java\n    CompletableFuture.supplyAsync(SupplierWrapper.of(() -> {\n        return \"SupplierWrapper\";\n    })).thenApplyAsync(FunctionWrapper.of(f -> {\n        // your code visit(url)\n        return \"FunctionWrapper\";\n    }));\n```\n\n\n\n","slug":"java/Application-toolkit-trace-cross-thread","published":1,"updated":"2025-02-18T06:31:00.542Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8q0001ujz3g2zy32ge","content":"<h1 id=\"Trace-Cross-Thread\"><a href=\"#Trace-Cross-Thread\" class=\"headerlink\" title=\"Trace Cross Thread\"></a>Trace Cross Thread</h1><p>These APIs provide ways to continuous tracing in the cross thread scenario with minimal code changes.<br>All following are sample codes only to demonstrate how to adopt cross thread cases easier.</p>\n<ul>\n<li>Case 1.<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"meta\">@TraceCrossThread</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyCallable</span>&lt;String&gt; <span class=\"keyword\">implements</span> <span class=\"title class_\">Callable</span>&lt;String&gt; &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"type\">ExecutorService</span> <span class=\"variable\">executorService</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"number\">1</span>);</span><br><span class=\"line\">    executorService.submit(<span class=\"keyword\">new</span> <span class=\"title class_\">MyCallable</span>());</span><br></pre></td></tr></table></figure></li>\n<li>Case 2.<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ExecutorService</span> <span class=\"variable\">executorService</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"number\">1</span>);</span><br><span class=\"line\">executorService.submit(CallableWrapper.of(<span class=\"keyword\">new</span> <span class=\"title class_\">Callable</span>&lt;String&gt;() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span> <span class=\"keyword\">public</span> String <span class=\"title function_\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure>\nor<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ExecutorService</span> <span class=\"variable\">executorService</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"number\">1</span>);</span><br><span class=\"line\">executorService.execute(RunnableWrapper.of(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span> <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//your code</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure></li>\n<li>Case 3.<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"meta\">@TraceCrossThread</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MySupplier</span>&lt;String&gt; <span class=\"keyword\">implements</span> <span class=\"title class_\">Supplier</span>&lt;String&gt; &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">get</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">...</span><br><span class=\"line\">    CompletableFuture.supplyAsync(<span class=\"keyword\">new</span> <span class=\"title class_\">MySupplier</span>&lt;String&gt;());</span><br></pre></td></tr></table></figure>\nor<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CompletableFuture.supplyAsync(SupplierWrapper.of(()-&gt;&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;SupplierWrapper&quot;</span>;</span><br><span class=\"line\">&#125;)).thenAccept(System.out::println);</span><br></pre></td></tr></table></figure></li>\n<li>Case 4.<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CompletableFuture.supplyAsync(SupplierWrapper.of(() -&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;SupplierWrapper&quot;</span>;</span><br><span class=\"line\">&#125;)).thenAcceptAsync(ConsumerWrapper.of(c -&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// your code visit(url)</span></span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;ConsumerWrapper&quot;</span>);</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure>\nor<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CompletableFuture.supplyAsync(SupplierWrapper.of(() -&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;SupplierWrapper&quot;</span>;</span><br><span class=\"line\">&#125;)).thenApplyAsync(FunctionWrapper.of(f -&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// your code visit(url)</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;FunctionWrapper&quot;</span>;</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure></li>\n</ul>\n","cover":false,"excerpt":"","more":"<h1 id=\"Trace-Cross-Thread\"><a href=\"#Trace-Cross-Thread\" class=\"headerlink\" title=\"Trace Cross Thread\"></a>Trace Cross Thread</h1><p>These APIs provide ways to continuous tracing in the cross thread scenario with minimal code changes.<br>All following are sample codes only to demonstrate how to adopt cross thread cases easier.</p>\n<ul>\n<li>Case 1.<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"meta\">@TraceCrossThread</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyCallable</span>&lt;String&gt; <span class=\"keyword\">implements</span> <span class=\"title class_\">Callable</span>&lt;String&gt; &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"type\">ExecutorService</span> <span class=\"variable\">executorService</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"number\">1</span>);</span><br><span class=\"line\">    executorService.submit(<span class=\"keyword\">new</span> <span class=\"title class_\">MyCallable</span>());</span><br></pre></td></tr></table></figure></li>\n<li>Case 2.<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ExecutorService</span> <span class=\"variable\">executorService</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"number\">1</span>);</span><br><span class=\"line\">executorService.submit(CallableWrapper.of(<span class=\"keyword\">new</span> <span class=\"title class_\">Callable</span>&lt;String&gt;() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span> <span class=\"keyword\">public</span> String <span class=\"title function_\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure>\nor<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ExecutorService</span> <span class=\"variable\">executorService</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"number\">1</span>);</span><br><span class=\"line\">executorService.execute(RunnableWrapper.of(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span> <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//your code</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure></li>\n<li>Case 3.<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"meta\">@TraceCrossThread</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MySupplier</span>&lt;String&gt; <span class=\"keyword\">implements</span> <span class=\"title class_\">Supplier</span>&lt;String&gt; &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">get</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">...</span><br><span class=\"line\">    CompletableFuture.supplyAsync(<span class=\"keyword\">new</span> <span class=\"title class_\">MySupplier</span>&lt;String&gt;());</span><br></pre></td></tr></table></figure>\nor<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CompletableFuture.supplyAsync(SupplierWrapper.of(()-&gt;&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;SupplierWrapper&quot;</span>;</span><br><span class=\"line\">&#125;)).thenAccept(System.out::println);</span><br></pre></td></tr></table></figure></li>\n<li>Case 4.<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CompletableFuture.supplyAsync(SupplierWrapper.of(() -&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;SupplierWrapper&quot;</span>;</span><br><span class=\"line\">&#125;)).thenAcceptAsync(ConsumerWrapper.of(c -&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// your code visit(url)</span></span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;ConsumerWrapper&quot;</span>);</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure>\nor<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CompletableFuture.supplyAsync(SupplierWrapper.of(() -&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;SupplierWrapper&quot;</span>;</span><br><span class=\"line\">&#125;)).thenApplyAsync(FunctionWrapper.of(f -&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// your code visit(url)</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;FunctionWrapper&quot;</span>;</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure></li>\n</ul>\n"},{"title":"Java通过JNI调用C/C++","date":"2025-04-25T01:47:01.000Z","_content":"\n#### 1 JNI\n\nJNI，全名 Java Native Interface，是Java本地接口，JNI是Java调用Native 语言的一种特性，通过JNI可以使得Java与C/C++机型交互。简单点说就是JNI是Java中调用C/C++的统称。\n\n- Java程序中的函数可以调用Native语言写的函数，Native一般指的是C/C++编写的函数。\n- Native程序中的函数可以调用Java层的函数，也就是在C/C++程序中可以调用Java的函数。\n\n![](./Java通过JNI调用C-C/jni_step.png)\n\n##### 1.1 JNI使用\n\n###### 1.1.1 声明Native方法\n\n```java\npackage TestJNI;\n// 带包名\n\npublic class JNICallCpp {\n\t// 声明为native，表明是有外部来实现的\n\tpublic native void HannoTower(int topN, char from, char inter, char to);\n\tpublic native void HellCpp();\n\n}\n```\n\n###### 1.1.2 编译生成头文件\n\n- 带包名编译\n\n如果`.java`文件中带有包名，则编译时需要切换到`包文件所在同级目录`，适用命令`javah 包名.类名`。如，在E:\\JavaProject\\LearnJava\\src目录下，打开cmd，输入\njavah TestJNI.JNICallCpp。\n\n```shell\nE:\ncd E:\\JavaProject\\LearnJava\\src\njavah TestJNI.JNICallCpp\n```\n\n- 不带包名编译\n\n如果`.java`文件中没有包名，则编译时需要切换到`.java文件所在同级目录`，适用命令`javah 类名`。如，在E:\\JavaProject\\LearnJava\\src\\TestJNI\\目录下，打开cmd，输入javah JNICallCpp。\n\n```shell\nE:\ncd E:\\JavaProject\\LearnJava\\src\\TestJNI\\\njavah JNICallCpp\n```\n\n###### 1.1.3 实现Native方法\n\n将编译生成的头文件引入C++工程的头文件中，以及`jni.h、jni_md.h`并在新建源文件实现头文件中定义的JNI格式的的函数，由于JNI的数据类型与C++数据类型并不完全相同，因此需要进行数据类型转换，实现定义的函数后，编译为`dll、so`格式库文件，该文件中即包含该接口。\n\n- `jni.h`：C:\\\\Program Files\\\\Java\\\\jdk1.8.0_291\\\\include\\\\jni.h\n- `jni_md.h`：C:\\\\Program Files\\\\Java\\\\jdk1.8.0_291\\\\include\\\\win32\\\\jni_md\n\n```c++\n/* DO NOT EDIT THIS FILE - it is machine generated */\n#include <jni.h>\n/* Header for class TestJNI_JNICallCpp */\n\n#ifndef _Included_TestJNI_JNICallCpp\n#define _Included_TestJNI_JNICallCpp\n#ifdef __cplusplus\nextern \"C\" {\n#endif\n/*\n * Class:     TestJNI_JNICallCpp\n * Method:    HannoTower\n * Signature: (ICCC)V\n */\nJNIEXPORT void JNICALL Java_TestJNI_JNICallCpp_HannoTower\n  (JNIEnv *, jobject, jint, jchar, jchar, jchar);\n\n/*\n * Class:     TestJNI_JNICallCpp\n * Method:    HellCpp\n * Signature: ()V\n */\nJNIEXPORT void JNICALL Java_TestJNI_JNICallCpp_HellCpp\n  (JNIEnv *, jobject);\n\n#ifdef __cplusplus\n}\n#endif\n#endif\n\n```\n\n![](./Java通过JNI调用C-C/jni_h.png)\n\n![jni_md](./Java通过JNI调用C-C/jni_md_h.png)\n\n\n\n```c++\n#include \"TestJNI_JNICallCpp.h\"\n#include<string>\n#include<iostream>\n//using namespace std;\n\n#ifdef __cplusplus\nextern \"C\" {\n#endif\n\n\tJNIEXPORT void JNICALL Java_TestJNI_JNICallCpp_HannoTower\n\t(JNIEnv *jni_env, jobject jobj, jint layer, jchar from, jchar inter, jchar to) {\n\t\tif (layer == 1) {\n\t\t\t//从Java传过来的参数jchar为unsigned int 16,不是char类型，需要强转\n\t\t\tstd::cout << \"Disk 1 from \" << char(from) << \" to \" << char(to) << std::endl;\n\t\t}\n\t\telse {\n\t\t\tJava_TestJNI_JNICallCpp_HannoTower(jni_env, jobj, layer - 1, from, to, inter);\n\t\t\tstd::cout << \"Disk \" << layer << \" from \" << char(from) << \" to \" << char(to) << std::endl;\n\t\t\tJava_TestJNI_JNICallCpp_HannoTower(jni_env, jobj, layer - 1, inter, from, to);\n\t\t}\n\t}\n\n\tJNIEXPORT void JNICALL Java_TestJNI_JNICallCpp_HellCpp\n\t(JNIEnv *, jobject) {\n\t\tstd::cout << \"Call Invoke JNI Func Success\" << std::endl;\n\t}\n\n#ifdef __cplusplus\n}\n#endif\n```\n\n###### 1.1.4 调用C/C++函数\n\n```java\nimport java.nio.file.FileSystems;\n\npublic class CallJNIFunc {\n\t//\t一般在类的静态（static）代码块中加载动态库最合适，因为在创建类的实例时，类会被 ClassLoader 先加载到虚拟机，\n\t//\t随后立马调用类的 static 静态代码块。这时再去调用 native 方法就万无一失了。加载动态库的两种方式：\n\t//\tSystem.loadLibrary(\"HelloWorld\");  \n\t//\tSystem.load(\"/Users/yangxin/Desktop/libHelloWorld.jnilib\"); \n\t//\tCan't load IA 32-bit .dll on a AMD 64-bit platform解决\n\t//\t64位JVM不能调用32位动态库\n\tstatic {\n\t//\t获取当前系统分隔符路径\n\t\tString separator = FileSystems.getDefault().getSeparator();\n\t\tString path = System.getProperty(\"user.dir\");\n\t\tSystem.out.println(separator);\n\t\tif (separator == \"\\\\\") {\n\t\t\tpath += \"\\\\CLibs\\\\InvokeJNIFunc.dll\";\n\t\t}\n\t\telse {\n\t\t\tpath += \"/CLibs/InvokeJNIFunc.dll\";\n\t\t}\n\t\tSystem.out.println(path);\n\t\tSystem.load(path);\n\t}\n\tpublic static void main(String[] args) {\n\t\t// TODO Auto-generated method stub\n\t\t// String path = System.getProperty(\"java.library.path\");\n\t\t\n\t\tJNICallCpp jniCallCpp = new JNICallCpp();\n\t\tjniCallCpp.HellCpp();\n\t\tjniCallCpp.HannoTower(5, 'A', 'B', 'C');\n\t}\n}\n```\n\n##### 1.2 JNI头文件介绍\n\n###### 1.2.1 JNIEnv 类型和jobject类型\n\n在上面的`TestJNI_JNICallCpp.cpp`文件中，`Java_TestJNI_JNICallCpp_HannoTower`方法中有两个参数，分别是`JNIEnv *env`,一个是`jobjet jobj`。下面简单介绍下这两个类型的作用。\n\n###### 1.2.1.1 JNIEnv 类型\n\n**JNIEnv**类型实际上代表了Java环境，通过JNIEnv*指针就可以对**Java端的代码**进行操作。比如可以使用JNIEnv来创建Java类中的对象，调用Java对象的方法，获取Java对象中的属性等。JNIEnv类中有很多函数可以用，如下所示:\n\n- NewObject: 创建Java类中的对象。\n- NewString: 创建Java类中的String对象。\n- NewArray: 创建类型为Type的数组对象。\n- GetField: 获取类型为Type的字段。\n- SetField: 设置类型为Type的字段的值。\n- GetStaticField: 获取类型为Type的static的字段。\n- SetStaticField: 设置类型为Type的static的字段的值。\n- CallMethod: 调用返回类型为Type的方法。\n- CallStaticMethod: 调用返回值类型为Type的static 方法。\n\n```c++\n// 如，要调用Java中的Date类的getTime方法\n// FindClass方法参数name是某个类的完整路径\n(JNIEnv *env, jobject instance){\n\tjclass  class_date = env->FindClass(\"java/util/Date\");\n\t//注意这里路径要换成/,不然会报illegal class name\n\tjmethodID  a_method = env->GetMethodID(class_date,\"<init>\",\"()V\");\n\tjobject  a_date_obj = env->NewObject(class_date,a_method);\n\tjmethodID  date_get_time = env->GetMethodID(class_date,\"getTime\",\"()J\");\n\tjlong get_time = env->CallLongMethod(a_date_obj,date_get_time);\n\treturn get_time; \n}\n```\n\n###### 1.2.1.1 Jobject 类型\n\n**Jobject**可以看做是java中的类实例的引用。当然，情况不同，意义也不一样。如果native方法不是static, jobjet 就代表native方法的类实例。如果native方法是static, jobjet 就代表native方法的类的class 对象实例(static 方法不需要类实例的，所以就代表这个类的class对象)。\n\n- jclass GetObjectClass(jobject obj) 根据一个对象，获取该对象的类\n- jclass GetSuperClass(jclass obj) 获取一个传入的对象获取他的父类的jclass\n- GetMethodID: 获取非静态方法的ID\n- GetStaticMethodID: 获取静态方法的ID\n\n```c++\n// 根据jobject的类型，在JNI中写方法的时候如果是非静态的都会传一个jobject的对象\n// 可以根据传入的来获取当前对象的类\n\n(JNIEnv *env, jobject instance) {\n\tjclass  a_class = env->GetObjectClass(instance);\n    //这里的a_class就是通过instance获取到的\n\t……\n}\n```\n\n###### 1.2.1.1 C++调用Java方法\n\n```C++\n(JNIEnv *env, jclass type) {\n\tjmethodID  a_method = env->GetMethodID(type,\"describe\",\"()Ljava/lang/String;\"); \n    // 通过GetMethod方法获取方法的methodId.\n\tjobject jobj = env->AllocObject(type);                                          \n    // 对jclass进行实例，相当于java中的new\n\tjstring pring= (jstring)(env)->CallObjectMethod(jobj,a_method);                \n    // 类调用类中的方法\n\tchar *print=(char*)(env)->GetStringUTFChars(pring,0);                           \n    // 转换格式输出。\n\treturn env->NewStringUTF(print);\n}\n```\n\n##### 1.3 JNI数据类型映射\n\n- 基本的数据类型\n\n| Java类型 | Native类型 | 域描述符 |\n| -------- | ---------- | -------- |\n| boolean  | jboolean   | Z        |\n| byte     | jbyte      | B        |\n| char     | jchar      | C        |\n| short    | jshort     | S        |\n| int      | jnit       | I        |\n| long     | jlong      | J        |\n| float    | jfloat     | F        |\n| double   | jdouble    | D        |\n| void     | void       | V        |\n\n- 数组引用类型\n\n如果是一维数组则遵循下表，如果是二维数组或更高维数组则对应的 Natvie类型为 jobjectArray，域描述符中使用 ‘[’ 的个数表示维数：\n\n| Java类型  | Native类型    | 域描述符 |\n| --------- | ------------- | -------- |\n| int[]     | jintArray     | [I       |\n| float[]   | jfloatArray   | [f       |\n| byte[]    | jbyteArray    | [B       |\n| char[]    | jcharArray    | [C       |\n| short[]   | jshortArray   | [S       |\n| double[]  | jdoubleArray  | [D       |\n| long[]    | jlongArray    | [F       |\n| boolean[] | jbooleanArray | [Z       |\n\n-  对象引用类型\n\n对于其它引用类型，即 java 中的对象，其映射规则为：\n\n| Java类型           | Native类型                                                   | 域描述符                                                     |\n| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| 类名（如 Surface） | 通常是 jobject，仅有一种例外，如果 java 类型是 String，则对应的native 类型是 jstring | 以”L”开头，以”;”结尾中间是用”/” 隔开的包及类名（如 Landroid/view/Surface;）如果内部类则使用$连接内部类； |\n\n- 对象数组引用类型\n\n如果是一维数组则遵循下表，如果是二维数组或更高维数组则对应的 native 类型为 jobjectArray，域描述符中使用 ‘[’ 的个数表示维数：\n\n| Java类型           | Native类型                                                   | 域描述符                                          |\n| ------------------ | ------------------------------------------------------------ | ------------------------------------------------- |\n| 类名（如 Surface） | 通常是 jobject，仅有一种例外，如果 java 类型是 String，则对应的native 类型是 jstring | 在对象引用类型的域描述符的基础上在左边添加’[‘字符 |\n\n##### 1.4 参考文献\n\n- Java文档：[Contents (oracle.com)](https://docs.oracle.com/javase/6/docs/technotes/guides/jni/spec/jniTOC.html)\n- JNI使用全面讲解：[Android JNI使用全面讲解 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/97691316)\n\n#### 2  JNA\n\nJNA，全名Java Native Access是建立在JNI技术基础之上的一个Java类库，可以方便地使用java直接访问动态链接库中的函数。不需要使用JNI重写动态链接库文件，而是有直接调用的API，大大简化了工作量。JNA将自动实现Java接口到native function的映射，但是JNA一般只适用于较为简单的C/C++库，如果接口、数据结构复杂的话就不推荐。而且JNA也只提供了C/C++对Java的接口转化。\n\n![](./Java通过JNI调用C-C/jna_step.png)\n\nJNA使用一个小型的JNI库插桩程序来动态调用本地代码。开发者使用Java接口描述目标本地库的功能和结构，这使得它很容易利用本机平台的功能，而不会产生多平台配置和生成JNI代码的高开销。这样的性能、准确性和易用性显然受到很大的重视。\n\n##### 2 .1 JNA使用\n\n###### 2.1.1 引入jar包\n\n使用Maven配置或者从github下载最新的`jna.jar`文件([jna/GettingStarted.md at master · java-native-access/jna · GitHub](https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md))，并将`jna.jar`引入到工程文件中。\n\n###### 2.1.2 声明API接口\n\n- 定义了一个接口，继承自Library 或StdCallLibrary，默认的是继承Library ， 如果动态链接库里的函数是以stdcall方式输出的，那么就继承StdCallLibrary，比如众所周知的kernel32库。\n\n- 接口内部需要一个公共静态常量：INSTANCE，通过这个常量，就可以获得这个接口的实例，从而使用接口的方法，也就是调用外部dll/so的函数。 该常量通过Native.loadLibrary()这个API函数获得，该函数有2个参数：\n    - 第一个参数是动态链接库dll/so的名称，但不带.dll或.so这样的后缀，这符合JNI的规范，因为带了后缀名就不可以跨操作系统平台了。搜索动态链 接库路径的顺序是：先从当前类的当前文件夹找，如果没有找到，再在工程当前文件夹下面找win32/win64文件夹，找到后搜索对应的dll文件，如果找不到再到WINDOWS下面去搜索，再找不到就会抛异常了。比如上例中printf函数在Windows平台下所在的dll库名称是msvcrt，而在 其它平台如Linux下的so库名称是c。\n    - 第二个参数是本接口的Class类型。JNA通过这个Class类型，根据指定的.dll/.so文件，动态创建接口的实例。该实例由JNA通过反射自动生成。 然后在MainActivity中调用sayHello方法。\n\n- 接口中只需要定义你要用到的函数或者公共变量，不需要的可以不定义，注意参数和返回值的类型，应该和链接库中的函数类型保持一致。\n\n```java\n// This is the standard, stable way of mapping, which supports extensive\n// customization and mapping of Java to native types\n// 声明接口，继承Library，用于加载库文件\n\n//继承Library，用于加载库文件\npublic interface CLibrary extends Library {\n\tString dllName = \"/Clibs/CompileDLL.dll\";\n\t@SuppressWarnings(\"deprecation\")\n\t// 加载动态链接库\n\t// 直接写动态库名称，动态库需要到为source或者代码添加动态库路径为source\n\t// CLibrary instance = (CLibrary) Native.loadLibrary(dllName, CLibrary.class);\n\n\tCLibrary instance = (CLibrary) Native.loadLibrary(dllName, CLibrary.class);\n\n\t// 链接动态库中的方法\n\tdouble seekArea(int a, int b);\n}\n```\n\n###### 2.1.3 调用C/C++函数\n\n定义好接口后，就可以使用接口中的函数即相应dll/so中的函数了。通过接口中的实例进行调用，非常简单。\n\n```java\npackage TestJNA;\n\npublic class JNACallCpp {\n\n\tpublic static void main(String[] args) {\n\t\t// TODO Auto-generated method stub\n\n\t\tdouble res = CLibrary.instance.seekArea(2, 2);\n\t\tSystem.out.println(\"the area is:\" + res);\n\t}\n\n}\n```\n\n##### 2.2  JNA数据类型映射\n\n- 基本的数据类型\n\n| Native Type | Size                | Java Type  | Common Windows Types    |\n| ----------- | ------------------- | ---------- | ----------------------- |\n| char        | 8-bit integer       | byte       | BYTE, TCHAR             |\n| short       | 16-bit integer      | short      | WORD                    |\n| wchar_t     | 16/32-bit character | char       | TCHAR                   |\n| int         | 32-bit integer      | int        | DWORD                   |\n| int         | boolean value       | boolean    | BOOL                    |\n| long        | 32/64-bit integer   | NativeLong | LONG                    |\n| long long   | 64-bit integer      | long       | __int64                 |\n| float       | 32-bit FP           | float      |                         |\n| double      | 64-bit FP           | double     |                         |\n| char*       | C string            | String     | LPCSTR                  |\n| void*       | pointer             | Pointer    | LPVOID, HANDLE, LP*XXX* |\n\n- 复杂的数据类型\n\n| **Java 类型**          | **C 类型**         | **原生表现**                                                 |\n| ---------------------- | ------------------ | ------------------------------------------------------------ |\n| boolean                | int                | 32位整数(可定制)                                             |\n| byte                   | char               | 8位整数                                                      |\n| char                   | wchar_t            | 平台依赖                                                     |\n| short                  | short              | 16位整数                                                     |\n| int                    | int                | 32位整数                                                     |\n| long                   | long long, __int64 | 64位整数                                                     |\n| float                  | float              | 32位浮点数                                                   |\n| double                 | double             | 64位浮点数                                                   |\n| Buffer/Pointer         | pointer            | 平台依赖(32或64位指针)                                       |\n| <T>[] (基本类型的数组) | pointer/array      | 32或64位指针(参数/返回值)邻接内存(结构体成员)                |\n| String                 | char*              | /0结束的数组 (native encoding or jna.encoding)               |\n| WString                | wchar_t*           | /0结束的数组(unicode)                                        |\n| String[]               | char**             | /0结束的数组的数组                                           |\n| WString[]              | wchar_t**          | /0结束的宽字符数组的数组                                     |\n| Structure              | struct*/struct     | 指向结构体的指针(参数或返回值) (或者明确指定是结构体指针)结构体(结构体的成员) (或者明确指定是结构体) |\n| Union                  | union              | 等同于结构体                                                 |\n| Structure[]            | struct[]           | 结构体的数组，邻接内存                                       |\n| Callback               | <T> (*fp)()        | Java函数指针或原生函数指针                                   |\n| NativeMapped           | varies             | 依赖于定义                                                   |\n| NativeLong             | long               | 平台依赖(32或64位整数)                                       |\n| PointerType            | pointer            | 和Pointer相同                                                |\n\n- 结构体数据类型\n\n**Structure 子类中的公共字段的顺序，必须与C 语言中的结构的顺序一致。否则会报错！**因为，Java 调用动态链接库中的C 函数，实际上就是一段内存作为函数的参数传递给C函数。动态链接库以为这个参数就是C 语言传过来的参数。同时，C 语言的结构体是一个严格的规范，它定义了内存的次序。因此，JNA 中模拟的结构体的变量顺序绝对不能错。\n\n```c\n// C语言结构体\nstruct UserStruct{\n    long id;\n    wchar_t* name;\n    int age;\n};\n```\n\n```c\n#define MYLIBAPI extern \"C\" __declspec( dllexport )\nMYLIBAPI void sayUser(UserStruct* pUserStruct);\n```\n\n```java\n// Java构造\npublic static class UserStruct extends Structure{\n    public NativeLong id;\n    public WString name;\n    public int age;\n    public static class ByReference extends UserStruct implements Structure.ByReference {}\n    public static class ByValue extends UserStruct implements Structure.ByValue {}\n    @Override\n    protected List getFieldOrder() {\n\treturn Arrays.asList(new String[] { \"id\", \"name\", \"age\"});\n    }\n\n}\n// 定义C++函数接口\npublic void sayUser(UserStruct.ByReference struct);\n```\n\n```java\n// Java调用\nUserStruct userStruct=new UserStruct ();\nuserStruct.id=new NativeLong(100);\nuserStruct.age=30;\nuserStruct.name=new WString(\"奥巴马\");\nTestDll1.INSTANCE.sayUser(userStruct);\n```\n\n##### 2.3  参考文献\n\n- JNA官方文档：[Overview (JNA API) (java-native-access.github.io)](http://java-native-access.github.io/jna/4.4.0/javadoc/)\n- Github：[jna/GettingStarted.md at master · java-native-access/jna · GitHub](https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md)\n\n- JNA实战笔记汇总：[JNA实战笔记汇总<一> 简单认识JNA|成功调用JNA - 简书 (jianshu.com)](https://www.jianshu.com/p/164443701574)\n- JNA使用示例：[Java JNA （三）—— 结构体使用及简单示例 - 疯狂的小萝卜头 - 博客园 (cnblogs.com)](\n\n#### 3 文件说明\n\n![](Java通过JNI调用C-C/file.png)\n\n| 名称          | 说明                                                 |\n| ------------- | ---------------------------------------------------- |\n| CLibs         | 编译好的DLL文件，`CompileDLL.dll、InvokeJNIFunc.dll` |\n| CompileDLL    | JNA调用`CompileDLL.dl`l的C++源文件                   |\n| InvokeJNIFunc | JNI调用`InvokeJNIFunc.dll`的C++源文件                |\n| Jar           | jna的jar包                                           |\n| src           | java调用测试源文件                                   |\n\n\n","source":"_posts/java/Java通过JNI调用C-C.md","raw":"---\ntitle: Java通过JNI调用C/C++\ndate: 2025-04-25 09:47:01\ncategories: Java\ntag: JNI\n---\n\n#### 1 JNI\n\nJNI，全名 Java Native Interface，是Java本地接口，JNI是Java调用Native 语言的一种特性，通过JNI可以使得Java与C/C++机型交互。简单点说就是JNI是Java中调用C/C++的统称。\n\n- Java程序中的函数可以调用Native语言写的函数，Native一般指的是C/C++编写的函数。\n- Native程序中的函数可以调用Java层的函数，也就是在C/C++程序中可以调用Java的函数。\n\n![](./Java通过JNI调用C-C/jni_step.png)\n\n##### 1.1 JNI使用\n\n###### 1.1.1 声明Native方法\n\n```java\npackage TestJNI;\n// 带包名\n\npublic class JNICallCpp {\n\t// 声明为native，表明是有外部来实现的\n\tpublic native void HannoTower(int topN, char from, char inter, char to);\n\tpublic native void HellCpp();\n\n}\n```\n\n###### 1.1.2 编译生成头文件\n\n- 带包名编译\n\n如果`.java`文件中带有包名，则编译时需要切换到`包文件所在同级目录`，适用命令`javah 包名.类名`。如，在E:\\JavaProject\\LearnJava\\src目录下，打开cmd，输入\njavah TestJNI.JNICallCpp。\n\n```shell\nE:\ncd E:\\JavaProject\\LearnJava\\src\njavah TestJNI.JNICallCpp\n```\n\n- 不带包名编译\n\n如果`.java`文件中没有包名，则编译时需要切换到`.java文件所在同级目录`，适用命令`javah 类名`。如，在E:\\JavaProject\\LearnJava\\src\\TestJNI\\目录下，打开cmd，输入javah JNICallCpp。\n\n```shell\nE:\ncd E:\\JavaProject\\LearnJava\\src\\TestJNI\\\njavah JNICallCpp\n```\n\n###### 1.1.3 实现Native方法\n\n将编译生成的头文件引入C++工程的头文件中，以及`jni.h、jni_md.h`并在新建源文件实现头文件中定义的JNI格式的的函数，由于JNI的数据类型与C++数据类型并不完全相同，因此需要进行数据类型转换，实现定义的函数后，编译为`dll、so`格式库文件，该文件中即包含该接口。\n\n- `jni.h`：C:\\\\Program Files\\\\Java\\\\jdk1.8.0_291\\\\include\\\\jni.h\n- `jni_md.h`：C:\\\\Program Files\\\\Java\\\\jdk1.8.0_291\\\\include\\\\win32\\\\jni_md\n\n```c++\n/* DO NOT EDIT THIS FILE - it is machine generated */\n#include <jni.h>\n/* Header for class TestJNI_JNICallCpp */\n\n#ifndef _Included_TestJNI_JNICallCpp\n#define _Included_TestJNI_JNICallCpp\n#ifdef __cplusplus\nextern \"C\" {\n#endif\n/*\n * Class:     TestJNI_JNICallCpp\n * Method:    HannoTower\n * Signature: (ICCC)V\n */\nJNIEXPORT void JNICALL Java_TestJNI_JNICallCpp_HannoTower\n  (JNIEnv *, jobject, jint, jchar, jchar, jchar);\n\n/*\n * Class:     TestJNI_JNICallCpp\n * Method:    HellCpp\n * Signature: ()V\n */\nJNIEXPORT void JNICALL Java_TestJNI_JNICallCpp_HellCpp\n  (JNIEnv *, jobject);\n\n#ifdef __cplusplus\n}\n#endif\n#endif\n\n```\n\n![](./Java通过JNI调用C-C/jni_h.png)\n\n![jni_md](./Java通过JNI调用C-C/jni_md_h.png)\n\n\n\n```c++\n#include \"TestJNI_JNICallCpp.h\"\n#include<string>\n#include<iostream>\n//using namespace std;\n\n#ifdef __cplusplus\nextern \"C\" {\n#endif\n\n\tJNIEXPORT void JNICALL Java_TestJNI_JNICallCpp_HannoTower\n\t(JNIEnv *jni_env, jobject jobj, jint layer, jchar from, jchar inter, jchar to) {\n\t\tif (layer == 1) {\n\t\t\t//从Java传过来的参数jchar为unsigned int 16,不是char类型，需要强转\n\t\t\tstd::cout << \"Disk 1 from \" << char(from) << \" to \" << char(to) << std::endl;\n\t\t}\n\t\telse {\n\t\t\tJava_TestJNI_JNICallCpp_HannoTower(jni_env, jobj, layer - 1, from, to, inter);\n\t\t\tstd::cout << \"Disk \" << layer << \" from \" << char(from) << \" to \" << char(to) << std::endl;\n\t\t\tJava_TestJNI_JNICallCpp_HannoTower(jni_env, jobj, layer - 1, inter, from, to);\n\t\t}\n\t}\n\n\tJNIEXPORT void JNICALL Java_TestJNI_JNICallCpp_HellCpp\n\t(JNIEnv *, jobject) {\n\t\tstd::cout << \"Call Invoke JNI Func Success\" << std::endl;\n\t}\n\n#ifdef __cplusplus\n}\n#endif\n```\n\n###### 1.1.4 调用C/C++函数\n\n```java\nimport java.nio.file.FileSystems;\n\npublic class CallJNIFunc {\n\t//\t一般在类的静态（static）代码块中加载动态库最合适，因为在创建类的实例时，类会被 ClassLoader 先加载到虚拟机，\n\t//\t随后立马调用类的 static 静态代码块。这时再去调用 native 方法就万无一失了。加载动态库的两种方式：\n\t//\tSystem.loadLibrary(\"HelloWorld\");  \n\t//\tSystem.load(\"/Users/yangxin/Desktop/libHelloWorld.jnilib\"); \n\t//\tCan't load IA 32-bit .dll on a AMD 64-bit platform解决\n\t//\t64位JVM不能调用32位动态库\n\tstatic {\n\t//\t获取当前系统分隔符路径\n\t\tString separator = FileSystems.getDefault().getSeparator();\n\t\tString path = System.getProperty(\"user.dir\");\n\t\tSystem.out.println(separator);\n\t\tif (separator == \"\\\\\") {\n\t\t\tpath += \"\\\\CLibs\\\\InvokeJNIFunc.dll\";\n\t\t}\n\t\telse {\n\t\t\tpath += \"/CLibs/InvokeJNIFunc.dll\";\n\t\t}\n\t\tSystem.out.println(path);\n\t\tSystem.load(path);\n\t}\n\tpublic static void main(String[] args) {\n\t\t// TODO Auto-generated method stub\n\t\t// String path = System.getProperty(\"java.library.path\");\n\t\t\n\t\tJNICallCpp jniCallCpp = new JNICallCpp();\n\t\tjniCallCpp.HellCpp();\n\t\tjniCallCpp.HannoTower(5, 'A', 'B', 'C');\n\t}\n}\n```\n\n##### 1.2 JNI头文件介绍\n\n###### 1.2.1 JNIEnv 类型和jobject类型\n\n在上面的`TestJNI_JNICallCpp.cpp`文件中，`Java_TestJNI_JNICallCpp_HannoTower`方法中有两个参数，分别是`JNIEnv *env`,一个是`jobjet jobj`。下面简单介绍下这两个类型的作用。\n\n###### 1.2.1.1 JNIEnv 类型\n\n**JNIEnv**类型实际上代表了Java环境，通过JNIEnv*指针就可以对**Java端的代码**进行操作。比如可以使用JNIEnv来创建Java类中的对象，调用Java对象的方法，获取Java对象中的属性等。JNIEnv类中有很多函数可以用，如下所示:\n\n- NewObject: 创建Java类中的对象。\n- NewString: 创建Java类中的String对象。\n- NewArray: 创建类型为Type的数组对象。\n- GetField: 获取类型为Type的字段。\n- SetField: 设置类型为Type的字段的值。\n- GetStaticField: 获取类型为Type的static的字段。\n- SetStaticField: 设置类型为Type的static的字段的值。\n- CallMethod: 调用返回类型为Type的方法。\n- CallStaticMethod: 调用返回值类型为Type的static 方法。\n\n```c++\n// 如，要调用Java中的Date类的getTime方法\n// FindClass方法参数name是某个类的完整路径\n(JNIEnv *env, jobject instance){\n\tjclass  class_date = env->FindClass(\"java/util/Date\");\n\t//注意这里路径要换成/,不然会报illegal class name\n\tjmethodID  a_method = env->GetMethodID(class_date,\"<init>\",\"()V\");\n\tjobject  a_date_obj = env->NewObject(class_date,a_method);\n\tjmethodID  date_get_time = env->GetMethodID(class_date,\"getTime\",\"()J\");\n\tjlong get_time = env->CallLongMethod(a_date_obj,date_get_time);\n\treturn get_time; \n}\n```\n\n###### 1.2.1.1 Jobject 类型\n\n**Jobject**可以看做是java中的类实例的引用。当然，情况不同，意义也不一样。如果native方法不是static, jobjet 就代表native方法的类实例。如果native方法是static, jobjet 就代表native方法的类的class 对象实例(static 方法不需要类实例的，所以就代表这个类的class对象)。\n\n- jclass GetObjectClass(jobject obj) 根据一个对象，获取该对象的类\n- jclass GetSuperClass(jclass obj) 获取一个传入的对象获取他的父类的jclass\n- GetMethodID: 获取非静态方法的ID\n- GetStaticMethodID: 获取静态方法的ID\n\n```c++\n// 根据jobject的类型，在JNI中写方法的时候如果是非静态的都会传一个jobject的对象\n// 可以根据传入的来获取当前对象的类\n\n(JNIEnv *env, jobject instance) {\n\tjclass  a_class = env->GetObjectClass(instance);\n    //这里的a_class就是通过instance获取到的\n\t……\n}\n```\n\n###### 1.2.1.1 C++调用Java方法\n\n```C++\n(JNIEnv *env, jclass type) {\n\tjmethodID  a_method = env->GetMethodID(type,\"describe\",\"()Ljava/lang/String;\"); \n    // 通过GetMethod方法获取方法的methodId.\n\tjobject jobj = env->AllocObject(type);                                          \n    // 对jclass进行实例，相当于java中的new\n\tjstring pring= (jstring)(env)->CallObjectMethod(jobj,a_method);                \n    // 类调用类中的方法\n\tchar *print=(char*)(env)->GetStringUTFChars(pring,0);                           \n    // 转换格式输出。\n\treturn env->NewStringUTF(print);\n}\n```\n\n##### 1.3 JNI数据类型映射\n\n- 基本的数据类型\n\n| Java类型 | Native类型 | 域描述符 |\n| -------- | ---------- | -------- |\n| boolean  | jboolean   | Z        |\n| byte     | jbyte      | B        |\n| char     | jchar      | C        |\n| short    | jshort     | S        |\n| int      | jnit       | I        |\n| long     | jlong      | J        |\n| float    | jfloat     | F        |\n| double   | jdouble    | D        |\n| void     | void       | V        |\n\n- 数组引用类型\n\n如果是一维数组则遵循下表，如果是二维数组或更高维数组则对应的 Natvie类型为 jobjectArray，域描述符中使用 ‘[’ 的个数表示维数：\n\n| Java类型  | Native类型    | 域描述符 |\n| --------- | ------------- | -------- |\n| int[]     | jintArray     | [I       |\n| float[]   | jfloatArray   | [f       |\n| byte[]    | jbyteArray    | [B       |\n| char[]    | jcharArray    | [C       |\n| short[]   | jshortArray   | [S       |\n| double[]  | jdoubleArray  | [D       |\n| long[]    | jlongArray    | [F       |\n| boolean[] | jbooleanArray | [Z       |\n\n-  对象引用类型\n\n对于其它引用类型，即 java 中的对象，其映射规则为：\n\n| Java类型           | Native类型                                                   | 域描述符                                                     |\n| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| 类名（如 Surface） | 通常是 jobject，仅有一种例外，如果 java 类型是 String，则对应的native 类型是 jstring | 以”L”开头，以”;”结尾中间是用”/” 隔开的包及类名（如 Landroid/view/Surface;）如果内部类则使用$连接内部类； |\n\n- 对象数组引用类型\n\n如果是一维数组则遵循下表，如果是二维数组或更高维数组则对应的 native 类型为 jobjectArray，域描述符中使用 ‘[’ 的个数表示维数：\n\n| Java类型           | Native类型                                                   | 域描述符                                          |\n| ------------------ | ------------------------------------------------------------ | ------------------------------------------------- |\n| 类名（如 Surface） | 通常是 jobject，仅有一种例外，如果 java 类型是 String，则对应的native 类型是 jstring | 在对象引用类型的域描述符的基础上在左边添加’[‘字符 |\n\n##### 1.4 参考文献\n\n- Java文档：[Contents (oracle.com)](https://docs.oracle.com/javase/6/docs/technotes/guides/jni/spec/jniTOC.html)\n- JNI使用全面讲解：[Android JNI使用全面讲解 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/97691316)\n\n#### 2  JNA\n\nJNA，全名Java Native Access是建立在JNI技术基础之上的一个Java类库，可以方便地使用java直接访问动态链接库中的函数。不需要使用JNI重写动态链接库文件，而是有直接调用的API，大大简化了工作量。JNA将自动实现Java接口到native function的映射，但是JNA一般只适用于较为简单的C/C++库，如果接口、数据结构复杂的话就不推荐。而且JNA也只提供了C/C++对Java的接口转化。\n\n![](./Java通过JNI调用C-C/jna_step.png)\n\nJNA使用一个小型的JNI库插桩程序来动态调用本地代码。开发者使用Java接口描述目标本地库的功能和结构，这使得它很容易利用本机平台的功能，而不会产生多平台配置和生成JNI代码的高开销。这样的性能、准确性和易用性显然受到很大的重视。\n\n##### 2 .1 JNA使用\n\n###### 2.1.1 引入jar包\n\n使用Maven配置或者从github下载最新的`jna.jar`文件([jna/GettingStarted.md at master · java-native-access/jna · GitHub](https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md))，并将`jna.jar`引入到工程文件中。\n\n###### 2.1.2 声明API接口\n\n- 定义了一个接口，继承自Library 或StdCallLibrary，默认的是继承Library ， 如果动态链接库里的函数是以stdcall方式输出的，那么就继承StdCallLibrary，比如众所周知的kernel32库。\n\n- 接口内部需要一个公共静态常量：INSTANCE，通过这个常量，就可以获得这个接口的实例，从而使用接口的方法，也就是调用外部dll/so的函数。 该常量通过Native.loadLibrary()这个API函数获得，该函数有2个参数：\n    - 第一个参数是动态链接库dll/so的名称，但不带.dll或.so这样的后缀，这符合JNI的规范，因为带了后缀名就不可以跨操作系统平台了。搜索动态链 接库路径的顺序是：先从当前类的当前文件夹找，如果没有找到，再在工程当前文件夹下面找win32/win64文件夹，找到后搜索对应的dll文件，如果找不到再到WINDOWS下面去搜索，再找不到就会抛异常了。比如上例中printf函数在Windows平台下所在的dll库名称是msvcrt，而在 其它平台如Linux下的so库名称是c。\n    - 第二个参数是本接口的Class类型。JNA通过这个Class类型，根据指定的.dll/.so文件，动态创建接口的实例。该实例由JNA通过反射自动生成。 然后在MainActivity中调用sayHello方法。\n\n- 接口中只需要定义你要用到的函数或者公共变量，不需要的可以不定义，注意参数和返回值的类型，应该和链接库中的函数类型保持一致。\n\n```java\n// This is the standard, stable way of mapping, which supports extensive\n// customization and mapping of Java to native types\n// 声明接口，继承Library，用于加载库文件\n\n//继承Library，用于加载库文件\npublic interface CLibrary extends Library {\n\tString dllName = \"/Clibs/CompileDLL.dll\";\n\t@SuppressWarnings(\"deprecation\")\n\t// 加载动态链接库\n\t// 直接写动态库名称，动态库需要到为source或者代码添加动态库路径为source\n\t// CLibrary instance = (CLibrary) Native.loadLibrary(dllName, CLibrary.class);\n\n\tCLibrary instance = (CLibrary) Native.loadLibrary(dllName, CLibrary.class);\n\n\t// 链接动态库中的方法\n\tdouble seekArea(int a, int b);\n}\n```\n\n###### 2.1.3 调用C/C++函数\n\n定义好接口后，就可以使用接口中的函数即相应dll/so中的函数了。通过接口中的实例进行调用，非常简单。\n\n```java\npackage TestJNA;\n\npublic class JNACallCpp {\n\n\tpublic static void main(String[] args) {\n\t\t// TODO Auto-generated method stub\n\n\t\tdouble res = CLibrary.instance.seekArea(2, 2);\n\t\tSystem.out.println(\"the area is:\" + res);\n\t}\n\n}\n```\n\n##### 2.2  JNA数据类型映射\n\n- 基本的数据类型\n\n| Native Type | Size                | Java Type  | Common Windows Types    |\n| ----------- | ------------------- | ---------- | ----------------------- |\n| char        | 8-bit integer       | byte       | BYTE, TCHAR             |\n| short       | 16-bit integer      | short      | WORD                    |\n| wchar_t     | 16/32-bit character | char       | TCHAR                   |\n| int         | 32-bit integer      | int        | DWORD                   |\n| int         | boolean value       | boolean    | BOOL                    |\n| long        | 32/64-bit integer   | NativeLong | LONG                    |\n| long long   | 64-bit integer      | long       | __int64                 |\n| float       | 32-bit FP           | float      |                         |\n| double      | 64-bit FP           | double     |                         |\n| char*       | C string            | String     | LPCSTR                  |\n| void*       | pointer             | Pointer    | LPVOID, HANDLE, LP*XXX* |\n\n- 复杂的数据类型\n\n| **Java 类型**          | **C 类型**         | **原生表现**                                                 |\n| ---------------------- | ------------------ | ------------------------------------------------------------ |\n| boolean                | int                | 32位整数(可定制)                                             |\n| byte                   | char               | 8位整数                                                      |\n| char                   | wchar_t            | 平台依赖                                                     |\n| short                  | short              | 16位整数                                                     |\n| int                    | int                | 32位整数                                                     |\n| long                   | long long, __int64 | 64位整数                                                     |\n| float                  | float              | 32位浮点数                                                   |\n| double                 | double             | 64位浮点数                                                   |\n| Buffer/Pointer         | pointer            | 平台依赖(32或64位指针)                                       |\n| <T>[] (基本类型的数组) | pointer/array      | 32或64位指针(参数/返回值)邻接内存(结构体成员)                |\n| String                 | char*              | /0结束的数组 (native encoding or jna.encoding)               |\n| WString                | wchar_t*           | /0结束的数组(unicode)                                        |\n| String[]               | char**             | /0结束的数组的数组                                           |\n| WString[]              | wchar_t**          | /0结束的宽字符数组的数组                                     |\n| Structure              | struct*/struct     | 指向结构体的指针(参数或返回值) (或者明确指定是结构体指针)结构体(结构体的成员) (或者明确指定是结构体) |\n| Union                  | union              | 等同于结构体                                                 |\n| Structure[]            | struct[]           | 结构体的数组，邻接内存                                       |\n| Callback               | <T> (*fp)()        | Java函数指针或原生函数指针                                   |\n| NativeMapped           | varies             | 依赖于定义                                                   |\n| NativeLong             | long               | 平台依赖(32或64位整数)                                       |\n| PointerType            | pointer            | 和Pointer相同                                                |\n\n- 结构体数据类型\n\n**Structure 子类中的公共字段的顺序，必须与C 语言中的结构的顺序一致。否则会报错！**因为，Java 调用动态链接库中的C 函数，实际上就是一段内存作为函数的参数传递给C函数。动态链接库以为这个参数就是C 语言传过来的参数。同时，C 语言的结构体是一个严格的规范，它定义了内存的次序。因此，JNA 中模拟的结构体的变量顺序绝对不能错。\n\n```c\n// C语言结构体\nstruct UserStruct{\n    long id;\n    wchar_t* name;\n    int age;\n};\n```\n\n```c\n#define MYLIBAPI extern \"C\" __declspec( dllexport )\nMYLIBAPI void sayUser(UserStruct* pUserStruct);\n```\n\n```java\n// Java构造\npublic static class UserStruct extends Structure{\n    public NativeLong id;\n    public WString name;\n    public int age;\n    public static class ByReference extends UserStruct implements Structure.ByReference {}\n    public static class ByValue extends UserStruct implements Structure.ByValue {}\n    @Override\n    protected List getFieldOrder() {\n\treturn Arrays.asList(new String[] { \"id\", \"name\", \"age\"});\n    }\n\n}\n// 定义C++函数接口\npublic void sayUser(UserStruct.ByReference struct);\n```\n\n```java\n// Java调用\nUserStruct userStruct=new UserStruct ();\nuserStruct.id=new NativeLong(100);\nuserStruct.age=30;\nuserStruct.name=new WString(\"奥巴马\");\nTestDll1.INSTANCE.sayUser(userStruct);\n```\n\n##### 2.3  参考文献\n\n- JNA官方文档：[Overview (JNA API) (java-native-access.github.io)](http://java-native-access.github.io/jna/4.4.0/javadoc/)\n- Github：[jna/GettingStarted.md at master · java-native-access/jna · GitHub](https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md)\n\n- JNA实战笔记汇总：[JNA实战笔记汇总<一> 简单认识JNA|成功调用JNA - 简书 (jianshu.com)](https://www.jianshu.com/p/164443701574)\n- JNA使用示例：[Java JNA （三）—— 结构体使用及简单示例 - 疯狂的小萝卜头 - 博客园 (cnblogs.com)](\n\n#### 3 文件说明\n\n![](Java通过JNI调用C-C/file.png)\n\n| 名称          | 说明                                                 |\n| ------------- | ---------------------------------------------------- |\n| CLibs         | 编译好的DLL文件，`CompileDLL.dll、InvokeJNIFunc.dll` |\n| CompileDLL    | JNA调用`CompileDLL.dl`l的C++源文件                   |\n| InvokeJNIFunc | JNI调用`InvokeJNIFunc.dll`的C++源文件                |\n| Jar           | jna的jar包                                           |\n| src           | java调用测试源文件                                   |\n\n\n","slug":"java/Java通过JNI调用C-C","published":1,"updated":"2025-04-25T01:48:29.358Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8r0003ujz3bl4z8g3f","content":"<h4 id=\"1-JNI\"><a href=\"#1-JNI\" class=\"headerlink\" title=\"1 JNI\"></a>1 JNI</h4><p>JNI，全名 Java Native Interface，是Java本地接口，JNI是Java调用Native 语言的一种特性，通过JNI可以使得Java与C&#x2F;C++机型交互。简单点说就是JNI是Java中调用C&#x2F;C++的统称。</p>\n<ul>\n<li>Java程序中的函数可以调用Native语言写的函数，Native一般指的是C&#x2F;C++编写的函数。</li>\n<li>Native程序中的函数可以调用Java层的函数，也就是在C&#x2F;C++程序中可以调用Java的函数。</li>\n</ul>\n\n\n<h5 id=\"1-1-JNI使用\"><a href=\"#1-1-JNI使用\" class=\"headerlink\" title=\"1.1 JNI使用\"></a>1.1 JNI使用</h5><h6 id=\"1-1-1-声明Native方法\"><a href=\"#1-1-1-声明Native方法\" class=\"headerlink\" title=\"1.1.1 声明Native方法\"></a>1.1.1 声明Native方法</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> TestJNI;</span><br><span class=\"line\"><span class=\"comment\">// 带包名</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JNICallCpp</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 声明为native，表明是有外部来实现的</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title function_\">HannoTower</span><span class=\"params\">(<span class=\"type\">int</span> topN, <span class=\"type\">char</span> from, <span class=\"type\">char</span> inter, <span class=\"type\">char</span> to)</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title function_\">HellCpp</span><span class=\"params\">()</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-1-2-编译生成头文件\"><a href=\"#1-1-2-编译生成头文件\" class=\"headerlink\" title=\"1.1.2 编译生成头文件\"></a>1.1.2 编译生成头文件</h6><ul>\n<li>带包名编译</li>\n</ul>\n<p>如果<code>.java</code>文件中带有包名，则编译时需要切换到<code>包文件所在同级目录</code>，适用命令<code>javah 包名.类名</code>。如，在E:\\JavaProject\\LearnJava\\src目录下，打开cmd，输入<br>javah TestJNI.JNICallCpp。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">E:</span><br><span class=\"line\">cd E:\\JavaProject\\LearnJava\\src</span><br><span class=\"line\">javah TestJNI.JNICallCpp</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>不带包名编译</li>\n</ul>\n<p>如果<code>.java</code>文件中没有包名，则编译时需要切换到<code>.java文件所在同级目录</code>，适用命令<code>javah 类名</code>。如，在E:\\JavaProject\\LearnJava\\src\\TestJNI\\目录下，打开cmd，输入javah JNICallCpp。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">E:</span><br><span class=\"line\">cd E:\\JavaProject\\LearnJava\\src\\TestJNI\\</span><br><span class=\"line\">javah JNICallCpp</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-1-3-实现Native方法\"><a href=\"#1-1-3-实现Native方法\" class=\"headerlink\" title=\"1.1.3 实现Native方法\"></a>1.1.3 实现Native方法</h6><p>将编译生成的头文件引入C++工程的头文件中，以及<code>jni.h、jni_md.h</code>并在新建源文件实现头文件中定义的JNI格式的的函数，由于JNI的数据类型与C++数据类型并不完全相同，因此需要进行数据类型转换，实现定义的函数后，编译为<code>dll、so</code>格式库文件，该文件中即包含该接口。</p>\n<ul>\n<li><code>jni.h</code>：C:\\Program Files\\Java\\jdk1.8.0_291\\include\\jni.h</li>\n<li><code>jni_md.h</code>：C:\\Program Files\\Java\\jdk1.8.0_291\\include\\win32\\jni_md</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;jni.h&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">/* Header for class TestJNI_JNICallCpp */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> _Included_TestJNI_JNICallCpp</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _Included_TestJNI_JNICallCpp</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> __cplusplus</span></span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"string\">&quot;C&quot;</span> &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Class:     TestJNI_JNICallCpp</span></span><br><span class=\"line\"><span class=\"comment\"> * Method:    HannoTower</span></span><br><span class=\"line\"><span class=\"comment\"> * Signature: (ICCC)V</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\">JNIEXPORT <span class=\"type\">void</span> JNICALL <span class=\"title\">Java_TestJNI_JNICallCpp_HannoTower</span></span></span><br><span class=\"line\"><span class=\"function\">  <span class=\"params\">(JNIEnv *, jobject, jint, jchar, jchar, jchar)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Class:     TestJNI_JNICallCpp</span></span><br><span class=\"line\"><span class=\"comment\"> * Method:    HellCpp</span></span><br><span class=\"line\"><span class=\"comment\"> * Signature: ()V</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\">JNIEXPORT <span class=\"type\">void</span> JNICALL <span class=\"title\">Java_TestJNI_JNICallCpp_HellCpp</span></span></span><br><span class=\"line\"><span class=\"function\">  <span class=\"params\">(JNIEnv *, jobject)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> __cplusplus</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;TestJNI_JNICallCpp.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;string&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">//using namespace std;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> __cplusplus</span></span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"string\">&quot;C&quot;</span> &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\">JNIEXPORT <span class=\"type\">void</span> JNICALL <span class=\"title\">Java_TestJNI_JNICallCpp_HannoTower</span></span></span><br><span class=\"line\"><span class=\"function\">\t<span class=\"params\">(JNIEnv *jni_env, jobject jobj, jint layer, jchar from, jchar inter, jchar to)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (layer == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//从Java传过来的参数jchar为unsigned int 16,不是char类型，需要强转</span></span><br><span class=\"line\">\t\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;Disk 1 from &quot;</span> &lt;&lt; <span class=\"built_in\">char</span>(from) &lt;&lt; <span class=\"string\">&quot; to &quot;</span> &lt;&lt; <span class=\"built_in\">char</span>(to) &lt;&lt; std::endl;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">Java_TestJNI_JNICallCpp_HannoTower</span>(jni_env, jobj, layer - <span class=\"number\">1</span>, from, to, inter);</span><br><span class=\"line\">\t\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;Disk &quot;</span> &lt;&lt; layer &lt;&lt; <span class=\"string\">&quot; from &quot;</span> &lt;&lt; <span class=\"built_in\">char</span>(from) &lt;&lt; <span class=\"string\">&quot; to &quot;</span> &lt;&lt; <span class=\"built_in\">char</span>(to) &lt;&lt; std::endl;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">Java_TestJNI_JNICallCpp_HannoTower</span>(jni_env, jobj, layer - <span class=\"number\">1</span>, inter, from, to);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\">JNIEXPORT <span class=\"type\">void</span> JNICALL <span class=\"title\">Java_TestJNI_JNICallCpp_HellCpp</span></span></span><br><span class=\"line\"><span class=\"function\">\t<span class=\"params\">(JNIEnv *, jobject)</span> </span>&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;Call Invoke JNI Func Success&quot;</span> &lt;&lt; std::endl;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> __cplusplus</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-1-4-调用C-C-函数\"><a href=\"#1-1-4-调用C-C-函数\" class=\"headerlink\" title=\"1.1.4 调用C&#x2F;C++函数\"></a>1.1.4 调用C&#x2F;C++函数</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.FileSystems;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CallJNIFunc</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//\t一般在类的静态（static）代码块中加载动态库最合适，因为在创建类的实例时，类会被 ClassLoader 先加载到虚拟机，</span></span><br><span class=\"line\">\t<span class=\"comment\">//\t随后立马调用类的 static 静态代码块。这时再去调用 native 方法就万无一失了。加载动态库的两种方式：</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tSystem.loadLibrary(&quot;HelloWorld&quot;);  </span></span><br><span class=\"line\">\t<span class=\"comment\">//\tSystem.load(&quot;/Users/yangxin/Desktop/libHelloWorld.jnilib&quot;); </span></span><br><span class=\"line\">\t<span class=\"comment\">//\tCan&#x27;t load IA 32-bit .dll on a AMD 64-bit platform解决</span></span><br><span class=\"line\">\t<span class=\"comment\">//\t64位JVM不能调用32位动态库</span></span><br><span class=\"line\">\t<span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//\t获取当前系统分隔符路径</span></span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">separator</span> <span class=\"operator\">=</span> FileSystems.getDefault().getSeparator();</span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">path</span> <span class=\"operator\">=</span> System.getProperty(<span class=\"string\">&quot;user.dir&quot;</span>);</span><br><span class=\"line\">\t\tSystem.out.println(separator);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (separator == <span class=\"string\">&quot;\\\\&quot;</span>) &#123;</span><br><span class=\"line\">\t\t\tpath += <span class=\"string\">&quot;\\\\CLibs\\\\InvokeJNIFunc.dll&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tpath += <span class=\"string\">&quot;/CLibs/InvokeJNIFunc.dll&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tSystem.out.println(path);</span><br><span class=\"line\">\t\tSystem.load(path);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// String path = System.getProperty(&quot;java.library.path&quot;);</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"type\">JNICallCpp</span> <span class=\"variable\">jniCallCpp</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JNICallCpp</span>();</span><br><span class=\"line\">\t\tjniCallCpp.HellCpp();</span><br><span class=\"line\">\t\tjniCallCpp.HannoTower(<span class=\"number\">5</span>, <span class=\"string\">&#x27;A&#x27;</span>, <span class=\"string\">&#x27;B&#x27;</span>, <span class=\"string\">&#x27;C&#x27;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"1-2-JNI头文件介绍\"><a href=\"#1-2-JNI头文件介绍\" class=\"headerlink\" title=\"1.2 JNI头文件介绍\"></a>1.2 JNI头文件介绍</h5><h6 id=\"1-2-1-JNIEnv-类型和jobject类型\"><a href=\"#1-2-1-JNIEnv-类型和jobject类型\" class=\"headerlink\" title=\"1.2.1 JNIEnv 类型和jobject类型\"></a>1.2.1 JNIEnv 类型和jobject类型</h6><p>在上面的<code>TestJNI_JNICallCpp.cpp</code>文件中，<code>Java_TestJNI_JNICallCpp_HannoTower</code>方法中有两个参数，分别是<code>JNIEnv *env</code>,一个是<code>jobjet jobj</code>。下面简单介绍下这两个类型的作用。</p>\n<h6 id=\"1-2-1-1-JNIEnv-类型\"><a href=\"#1-2-1-1-JNIEnv-类型\" class=\"headerlink\" title=\"1.2.1.1 JNIEnv 类型\"></a>1.2.1.1 JNIEnv 类型</h6><p><strong>JNIEnv</strong>类型实际上代表了Java环境，通过JNIEnv*指针就可以对<strong>Java端的代码</strong>进行操作。比如可以使用JNIEnv来创建Java类中的对象，调用Java对象的方法，获取Java对象中的属性等。JNIEnv类中有很多函数可以用，如下所示:</p>\n<ul>\n<li>NewObject: 创建Java类中的对象。</li>\n<li>NewString: 创建Java类中的String对象。</li>\n<li>NewArray: 创建类型为Type的数组对象。</li>\n<li>GetField: 获取类型为Type的字段。</li>\n<li>SetField: 设置类型为Type的字段的值。</li>\n<li>GetStaticField: 获取类型为Type的static的字段。</li>\n<li>SetStaticField: 设置类型为Type的static的字段的值。</li>\n<li>CallMethod: 调用返回类型为Type的方法。</li>\n<li>CallStaticMethod: 调用返回值类型为Type的static 方法。</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 如，要调用Java中的Date类的getTime方法</span></span><br><span class=\"line\"><span class=\"comment\">// FindClass方法参数name是某个类的完整路径</span></span><br><span class=\"line\">(JNIEnv *env, jobject instance)&#123;</span><br><span class=\"line\">\tjclass  class_date = env-&gt;<span class=\"built_in\">FindClass</span>(<span class=\"string\">&quot;java/util/Date&quot;</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//注意这里路径要换成/,不然会报illegal class name</span></span><br><span class=\"line\">\tjmethodID  a_method = env-&gt;<span class=\"built_in\">GetMethodID</span>(class_date,<span class=\"string\">&quot;&lt;init&gt;&quot;</span>,<span class=\"string\">&quot;()V&quot;</span>);</span><br><span class=\"line\">\tjobject  a_date_obj = env-&gt;<span class=\"built_in\">NewObject</span>(class_date,a_method);</span><br><span class=\"line\">\tjmethodID  date_get_time = env-&gt;<span class=\"built_in\">GetMethodID</span>(class_date,<span class=\"string\">&quot;getTime&quot;</span>,<span class=\"string\">&quot;()J&quot;</span>);</span><br><span class=\"line\">\tjlong get_time = env-&gt;<span class=\"built_in\">CallLongMethod</span>(a_date_obj,date_get_time);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> get_time; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-2-1-1-Jobject-类型\"><a href=\"#1-2-1-1-Jobject-类型\" class=\"headerlink\" title=\"1.2.1.1 Jobject 类型\"></a>1.2.1.1 Jobject 类型</h6><p><strong>Jobject</strong>可以看做是java中的类实例的引用。当然，情况不同，意义也不一样。如果native方法不是static, jobjet 就代表native方法的类实例。如果native方法是static, jobjet 就代表native方法的类的class 对象实例(static 方法不需要类实例的，所以就代表这个类的class对象)。</p>\n<ul>\n<li>jclass GetObjectClass(jobject obj) 根据一个对象，获取该对象的类</li>\n<li>jclass GetSuperClass(jclass obj) 获取一个传入的对象获取他的父类的jclass</li>\n<li>GetMethodID: 获取非静态方法的ID</li>\n<li>GetStaticMethodID: 获取静态方法的ID</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 根据jobject的类型，在JNI中写方法的时候如果是非静态的都会传一个jobject的对象</span></span><br><span class=\"line\"><span class=\"comment\">// 可以根据传入的来获取当前对象的类</span></span><br><span class=\"line\"></span><br><span class=\"line\">(JNIEnv *env, jobject instance) &#123;</span><br><span class=\"line\">\tjclass  a_class = env-&gt;<span class=\"built_in\">GetObjectClass</span>(instance);</span><br><span class=\"line\">    <span class=\"comment\">//这里的a_class就是通过instance获取到的</span></span><br><span class=\"line\">\t……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-2-1-1-C-调用Java方法\"><a href=\"#1-2-1-1-C-调用Java方法\" class=\"headerlink\" title=\"1.2.1.1 C++调用Java方法\"></a>1.2.1.1 C++调用Java方法</h6><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(JNIEnv *env, jclass type) &#123;</span><br><span class=\"line\">\tjmethodID  a_method = env-&gt;<span class=\"built_in\">GetMethodID</span>(type,<span class=\"string\">&quot;describe&quot;</span>,<span class=\"string\">&quot;()Ljava/lang/String;&quot;</span>); </span><br><span class=\"line\">    <span class=\"comment\">// 通过GetMethod方法获取方法的methodId.</span></span><br><span class=\"line\">\tjobject jobj = env-&gt;<span class=\"built_in\">AllocObject</span>(type);                                          </span><br><span class=\"line\">    <span class=\"comment\">// 对jclass进行实例，相当于java中的new</span></span><br><span class=\"line\">\tjstring pring= (jstring)(env)-&gt;<span class=\"built_in\">CallObjectMethod</span>(jobj,a_method);                </span><br><span class=\"line\">    <span class=\"comment\">// 类调用类中的方法</span></span><br><span class=\"line\">\t<span class=\"type\">char</span> *print=(<span class=\"type\">char</span>*)(env)-&gt;<span class=\"built_in\">GetStringUTFChars</span>(pring,<span class=\"number\">0</span>);                           </span><br><span class=\"line\">    <span class=\"comment\">// 转换格式输出。</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> env-&gt;<span class=\"built_in\">NewStringUTF</span>(print);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"1-3-JNI数据类型映射\"><a href=\"#1-3-JNI数据类型映射\" class=\"headerlink\" title=\"1.3 JNI数据类型映射\"></a>1.3 JNI数据类型映射</h5><ul>\n<li>基本的数据类型</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Java类型</th>\n<th>Native类型</th>\n<th>域描述符</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>boolean</td>\n<td>jboolean</td>\n<td>Z</td>\n</tr>\n<tr>\n<td>byte</td>\n<td>jbyte</td>\n<td>B</td>\n</tr>\n<tr>\n<td>char</td>\n<td>jchar</td>\n<td>C</td>\n</tr>\n<tr>\n<td>short</td>\n<td>jshort</td>\n<td>S</td>\n</tr>\n<tr>\n<td>int</td>\n<td>jnit</td>\n<td>I</td>\n</tr>\n<tr>\n<td>long</td>\n<td>jlong</td>\n<td>J</td>\n</tr>\n<tr>\n<td>float</td>\n<td>jfloat</td>\n<td>F</td>\n</tr>\n<tr>\n<td>double</td>\n<td>jdouble</td>\n<td>D</td>\n</tr>\n<tr>\n<td>void</td>\n<td>void</td>\n<td>V</td>\n</tr>\n</tbody></table>\n<ul>\n<li>数组引用类型</li>\n</ul>\n<p>如果是一维数组则遵循下表，如果是二维数组或更高维数组则对应的 Natvie类型为 jobjectArray，域描述符中使用 ‘[’ 的个数表示维数：</p>\n<table>\n<thead>\n<tr>\n<th>Java类型</th>\n<th>Native类型</th>\n<th>域描述符</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>int[]</td>\n<td>jintArray</td>\n<td>[I</td>\n</tr>\n<tr>\n<td>float[]</td>\n<td>jfloatArray</td>\n<td>[f</td>\n</tr>\n<tr>\n<td>byte[]</td>\n<td>jbyteArray</td>\n<td>[B</td>\n</tr>\n<tr>\n<td>char[]</td>\n<td>jcharArray</td>\n<td>[C</td>\n</tr>\n<tr>\n<td>short[]</td>\n<td>jshortArray</td>\n<td>[S</td>\n</tr>\n<tr>\n<td>double[]</td>\n<td>jdoubleArray</td>\n<td>[D</td>\n</tr>\n<tr>\n<td>long[]</td>\n<td>jlongArray</td>\n<td>[F</td>\n</tr>\n<tr>\n<td>boolean[]</td>\n<td>jbooleanArray</td>\n<td>[Z</td>\n</tr>\n</tbody></table>\n<ul>\n<li>对象引用类型</li>\n</ul>\n<p>对于其它引用类型，即 java 中的对象，其映射规则为：</p>\n<table>\n<thead>\n<tr>\n<th>Java类型</th>\n<th>Native类型</th>\n<th>域描述符</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>类名（如 Surface）</td>\n<td>通常是 jobject，仅有一种例外，如果 java 类型是 String，则对应的native 类型是 jstring</td>\n<td>以”L”开头，以”;”结尾中间是用”&#x2F;” 隔开的包及类名（如 Landroid&#x2F;view&#x2F;Surface;）如果内部类则使用$连接内部类；</td>\n</tr>\n</tbody></table>\n<ul>\n<li>对象数组引用类型</li>\n</ul>\n<p>如果是一维数组则遵循下表，如果是二维数组或更高维数组则对应的 native 类型为 jobjectArray，域描述符中使用 ‘[’ 的个数表示维数：</p>\n<table>\n<thead>\n<tr>\n<th>Java类型</th>\n<th>Native类型</th>\n<th>域描述符</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>类名（如 Surface）</td>\n<td>通常是 jobject，仅有一种例外，如果 java 类型是 String，则对应的native 类型是 jstring</td>\n<td>在对象引用类型的域描述符的基础上在左边添加’[‘字符</td>\n</tr>\n</tbody></table>\n<h5 id=\"1-4-参考文献\"><a href=\"#1-4-参考文献\" class=\"headerlink\" title=\"1.4 参考文献\"></a>1.4 参考文献</h5><ul>\n<li>Java文档：<a href=\"https://docs.oracle.com/javase/6/docs/technotes/guides/jni/spec/jniTOC.html\">Contents (oracle.com)</a></li>\n<li>JNI使用全面讲解：<a href=\"https://zhuanlan.zhihu.com/p/97691316\">Android JNI使用全面讲解 - 知乎 (zhihu.com)</a></li>\n</ul>\n<h4 id=\"2-JNA\"><a href=\"#2-JNA\" class=\"headerlink\" title=\"2  JNA\"></a>2  JNA</h4><p>JNA，全名Java Native Access是建立在JNI技术基础之上的一个Java类库，可以方便地使用java直接访问动态链接库中的函数。不需要使用JNI重写动态链接库文件，而是有直接调用的API，大大简化了工作量。JNA将自动实现Java接口到native function的映射，但是JNA一般只适用于较为简单的C&#x2F;C++库，如果接口、数据结构复杂的话就不推荐。而且JNA也只提供了C&#x2F;C++对Java的接口转化。</p>\n\n\n<p>JNA使用一个小型的JNI库插桩程序来动态调用本地代码。开发者使用Java接口描述目标本地库的功能和结构，这使得它很容易利用本机平台的功能，而不会产生多平台配置和生成JNI代码的高开销。这样的性能、准确性和易用性显然受到很大的重视。</p>\n<h5 id=\"2-1-JNA使用\"><a href=\"#2-1-JNA使用\" class=\"headerlink\" title=\"2 .1 JNA使用\"></a>2 .1 JNA使用</h5><h6 id=\"2-1-1-引入jar包\"><a href=\"#2-1-1-引入jar包\" class=\"headerlink\" title=\"2.1.1 引入jar包\"></a>2.1.1 引入jar包</h6><p>使用Maven配置或者从github下载最新的<code>jna.jar</code>文件(<a href=\"https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md\">jna&#x2F;GettingStarted.md at master · java-native-access&#x2F;jna · GitHub</a>)，并将<code>jna.jar</code>引入到工程文件中。</p>\n<h6 id=\"2-1-2-声明API接口\"><a href=\"#2-1-2-声明API接口\" class=\"headerlink\" title=\"2.1.2 声明API接口\"></a>2.1.2 声明API接口</h6><ul>\n<li><p>定义了一个接口，继承自Library 或StdCallLibrary，默认的是继承Library ， 如果动态链接库里的函数是以stdcall方式输出的，那么就继承StdCallLibrary，比如众所周知的kernel32库。</p>\n</li>\n<li><p>接口内部需要一个公共静态常量：INSTANCE，通过这个常量，就可以获得这个接口的实例，从而使用接口的方法，也就是调用外部dll&#x2F;so的函数。 该常量通过Native.loadLibrary()这个API函数获得，该函数有2个参数：</p>\n<ul>\n<li>第一个参数是动态链接库dll&#x2F;so的名称，但不带.dll或.so这样的后缀，这符合JNI的规范，因为带了后缀名就不可以跨操作系统平台了。搜索动态链 接库路径的顺序是：先从当前类的当前文件夹找，如果没有找到，再在工程当前文件夹下面找win32&#x2F;win64文件夹，找到后搜索对应的dll文件，如果找不到再到WINDOWS下面去搜索，再找不到就会抛异常了。比如上例中printf函数在Windows平台下所在的dll库名称是msvcrt，而在 其它平台如Linux下的so库名称是c。</li>\n<li>第二个参数是本接口的Class类型。JNA通过这个Class类型，根据指定的.dll&#x2F;.so文件，动态创建接口的实例。该实例由JNA通过反射自动生成。 然后在MainActivity中调用sayHello方法。</li>\n</ul>\n</li>\n<li><p>接口中只需要定义你要用到的函数或者公共变量，不需要的可以不定义，注意参数和返回值的类型，应该和链接库中的函数类型保持一致。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This is the standard, stable way of mapping, which supports extensive</span></span><br><span class=\"line\"><span class=\"comment\">// customization and mapping of Java to native types</span></span><br><span class=\"line\"><span class=\"comment\">// 声明接口，继承Library，用于加载库文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//继承Library，用于加载库文件</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">CLibrary</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Library</span> &#123;</span><br><span class=\"line\">\t<span class=\"type\">String</span> <span class=\"variable\">dllName</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;/Clibs/CompileDLL.dll&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class=\"line\">\t<span class=\"comment\">// 加载动态链接库</span></span><br><span class=\"line\">\t<span class=\"comment\">// 直接写动态库名称，动态库需要到为source或者代码添加动态库路径为source</span></span><br><span class=\"line\">\t<span class=\"comment\">// CLibrary instance = (CLibrary) Native.loadLibrary(dllName, CLibrary.class);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">CLibrary</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> (CLibrary) Native.loadLibrary(dllName, CLibrary.class);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 链接动态库中的方法</span></span><br><span class=\"line\">\t<span class=\"type\">double</span> <span class=\"title function_\">seekArea</span><span class=\"params\">(<span class=\"type\">int</span> a, <span class=\"type\">int</span> b)</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"2-1-3-调用C-C-函数\"><a href=\"#2-1-3-调用C-C-函数\" class=\"headerlink\" title=\"2.1.3 调用C&#x2F;C++函数\"></a>2.1.3 调用C&#x2F;C++函数</h6><p>定义好接口后，就可以使用接口中的函数即相应dll&#x2F;so中的函数了。通过接口中的实例进行调用，非常简单。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> TestJNA;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JNACallCpp</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"type\">double</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> CLibrary.instance.seekArea(<span class=\"number\">2</span>, <span class=\"number\">2</span>);</span><br><span class=\"line\">\t\tSystem.out.println(<span class=\"string\">&quot;the area is:&quot;</span> + res);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"2-2-JNA数据类型映射\"><a href=\"#2-2-JNA数据类型映射\" class=\"headerlink\" title=\"2.2  JNA数据类型映射\"></a>2.2  JNA数据类型映射</h5><ul>\n<li>基本的数据类型</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Native Type</th>\n<th>Size</th>\n<th>Java Type</th>\n<th>Common Windows Types</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>char</td>\n<td>8-bit integer</td>\n<td>byte</td>\n<td>BYTE, TCHAR</td>\n</tr>\n<tr>\n<td>short</td>\n<td>16-bit integer</td>\n<td>short</td>\n<td>WORD</td>\n</tr>\n<tr>\n<td>wchar_t</td>\n<td>16&#x2F;32-bit character</td>\n<td>char</td>\n<td>TCHAR</td>\n</tr>\n<tr>\n<td>int</td>\n<td>32-bit integer</td>\n<td>int</td>\n<td>DWORD</td>\n</tr>\n<tr>\n<td>int</td>\n<td>boolean value</td>\n<td>boolean</td>\n<td>BOOL</td>\n</tr>\n<tr>\n<td>long</td>\n<td>32&#x2F;64-bit integer</td>\n<td>NativeLong</td>\n<td>LONG</td>\n</tr>\n<tr>\n<td>long long</td>\n<td>64-bit integer</td>\n<td>long</td>\n<td>__int64</td>\n</tr>\n<tr>\n<td>float</td>\n<td>32-bit FP</td>\n<td>float</td>\n<td></td>\n</tr>\n<tr>\n<td>double</td>\n<td>64-bit FP</td>\n<td>double</td>\n<td></td>\n</tr>\n<tr>\n<td>char*</td>\n<td>C string</td>\n<td>String</td>\n<td>LPCSTR</td>\n</tr>\n<tr>\n<td>void*</td>\n<td>pointer</td>\n<td>Pointer</td>\n<td>LPVOID, HANDLE, LP<em>XXX</em></td>\n</tr>\n</tbody></table>\n<ul>\n<li>复杂的数据类型</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th><strong>Java 类型</strong></th>\n<th><strong>C 类型</strong></th>\n<th><strong>原生表现</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>boolean</td>\n<td>int</td>\n<td>32位整数(可定制)</td>\n</tr>\n<tr>\n<td>byte</td>\n<td>char</td>\n<td>8位整数</td>\n</tr>\n<tr>\n<td>char</td>\n<td>wchar_t</td>\n<td>平台依赖</td>\n</tr>\n<tr>\n<td>short</td>\n<td>short</td>\n<td>16位整数</td>\n</tr>\n<tr>\n<td>int</td>\n<td>int</td>\n<td>32位整数</td>\n</tr>\n<tr>\n<td>long</td>\n<td>long long, __int64</td>\n<td>64位整数</td>\n</tr>\n<tr>\n<td>float</td>\n<td>float</td>\n<td>32位浮点数</td>\n</tr>\n<tr>\n<td>double</td>\n<td>double</td>\n<td>64位浮点数</td>\n</tr>\n<tr>\n<td>Buffer&#x2F;Pointer</td>\n<td>pointer</td>\n<td>平台依赖(32或64位指针)</td>\n</tr>\n<tr>\n<td><T>[] (基本类型的数组)</td>\n<td>pointer&#x2F;array</td>\n<td>32或64位指针(参数&#x2F;返回值)邻接内存(结构体成员)</td>\n</tr>\n<tr>\n<td>String</td>\n<td>char*</td>\n<td>&#x2F;0结束的数组 (native encoding or jna.encoding)</td>\n</tr>\n<tr>\n<td>WString</td>\n<td>wchar_t*</td>\n<td>&#x2F;0结束的数组(unicode)</td>\n</tr>\n<tr>\n<td>String[]</td>\n<td>char**</td>\n<td>&#x2F;0结束的数组的数组</td>\n</tr>\n<tr>\n<td>WString[]</td>\n<td>wchar_t**</td>\n<td>&#x2F;0结束的宽字符数组的数组</td>\n</tr>\n<tr>\n<td>Structure</td>\n<td>struct*&#x2F;struct</td>\n<td>指向结构体的指针(参数或返回值) (或者明确指定是结构体指针)结构体(结构体的成员) (或者明确指定是结构体)</td>\n</tr>\n<tr>\n<td>Union</td>\n<td>union</td>\n<td>等同于结构体</td>\n</tr>\n<tr>\n<td>Structure[]</td>\n<td>struct[]</td>\n<td>结构体的数组，邻接内存</td>\n</tr>\n<tr>\n<td>Callback</td>\n<td><T> (*fp)()</td>\n<td>Java函数指针或原生函数指针</td>\n</tr>\n<tr>\n<td>NativeMapped</td>\n<td>varies</td>\n<td>依赖于定义</td>\n</tr>\n<tr>\n<td>NativeLong</td>\n<td>long</td>\n<td>平台依赖(32或64位整数)</td>\n</tr>\n<tr>\n<td>PointerType</td>\n<td>pointer</td>\n<td>和Pointer相同</td>\n</tr>\n</tbody></table>\n<ul>\n<li>结构体数据类型</li>\n</ul>\n<p><strong>Structure 子类中的公共字段的顺序，必须与C 语言中的结构的顺序一致。否则会报错！</strong>因为，Java 调用动态链接库中的C 函数，实际上就是一段内存作为函数的参数传递给C函数。动态链接库以为这个参数就是C 语言传过来的参数。同时，C 语言的结构体是一个严格的规范，它定义了内存的次序。因此，JNA 中模拟的结构体的变量顺序绝对不能错。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// C语言结构体</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">UserStruct</span>&#123;</span></span><br><span class=\"line\">    <span class=\"type\">long</span> id;</span><br><span class=\"line\">    <span class=\"type\">wchar_t</span>* name;</span><br><span class=\"line\">    <span class=\"type\">int</span> age;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MYLIBAPI extern <span class=\"string\">&quot;C&quot;</span> __declspec( dllexport )</span></span><br><span class=\"line\">MYLIBAPI <span class=\"type\">void</span> <span class=\"title function_\">sayUser</span><span class=\"params\">(UserStruct* pUserStruct)</span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Java构造</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UserStruct</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Structure</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> NativeLong id;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> WString name;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> age;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ByReference</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">UserStruct</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Structure</span>.ByReference &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ByValue</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">UserStruct</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Structure</span>.ByValue &#123;&#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> List <span class=\"title function_\">getFieldOrder</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> Arrays.asList(<span class=\"keyword\">new</span> <span class=\"title class_\">String</span>[] &#123; <span class=\"string\">&quot;id&quot;</span>, <span class=\"string\">&quot;name&quot;</span>, <span class=\"string\">&quot;age&quot;</span>&#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 定义C++函数接口</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sayUser</span><span class=\"params\">(UserStruct.ByReference struct)</span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Java调用</span></span><br><span class=\"line\">UserStruct userStruct=<span class=\"keyword\">new</span> <span class=\"title class_\">UserStruct</span> ();</span><br><span class=\"line\">userStruct.id=<span class=\"keyword\">new</span> <span class=\"title class_\">NativeLong</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">userStruct.age=<span class=\"number\">30</span>;</span><br><span class=\"line\">userStruct.name=<span class=\"keyword\">new</span> <span class=\"title class_\">WString</span>(<span class=\"string\">&quot;奥巴马&quot;</span>);</span><br><span class=\"line\">TestDll1.INSTANCE.sayUser(userStruct);</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"2-3-参考文献\"><a href=\"#2-3-参考文献\" class=\"headerlink\" title=\"2.3  参考文献\"></a>2.3  参考文献</h5><ul>\n<li><p>JNA官方文档：<a href=\"http://java-native-access.github.io/jna/4.4.0/javadoc/\">Overview (JNA API) (java-native-access.github.io)</a></p>\n</li>\n<li><p>Github：<a href=\"https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md\">jna&#x2F;GettingStarted.md at master · java-native-access&#x2F;jna · GitHub</a></p>\n</li>\n<li><p>JNA实战笔记汇总：<a href=\"https://www.jianshu.com/p/164443701574\">JNA实战笔记汇总&lt;一&gt; 简单认识JNA|成功调用JNA - 简书 (jianshu.com)</a></p>\n</li>\n<li><p>JNA使用示例：[Java JNA （三）—— 结构体使用及简单示例 - 疯狂的小萝卜头 - 博客园 (cnblogs.com)](</p>\n</li>\n</ul>\n<h4 id=\"3-文件说明\"><a href=\"#3-文件说明\" class=\"headerlink\" title=\"3 文件说明\"></a>3 文件说明</h4>\n\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CLibs</td>\n<td>编译好的DLL文件，<code>CompileDLL.dll、InvokeJNIFunc.dll</code></td>\n</tr>\n<tr>\n<td>CompileDLL</td>\n<td>JNA调用<code>CompileDLL.dl</code>l的C++源文件</td>\n</tr>\n<tr>\n<td>InvokeJNIFunc</td>\n<td>JNI调用<code>InvokeJNIFunc.dll</code>的C++源文件</td>\n</tr>\n<tr>\n<td>Jar</td>\n<td>jna的jar包</td>\n</tr>\n<tr>\n<td>src</td>\n<td>java调用测试源文件</td>\n</tr>\n</tbody></table>\n","cover":false,"excerpt":"","more":"<h4 id=\"1-JNI\"><a href=\"#1-JNI\" class=\"headerlink\" title=\"1 JNI\"></a>1 JNI</h4><p>JNI，全名 Java Native Interface，是Java本地接口，JNI是Java调用Native 语言的一种特性，通过JNI可以使得Java与C&#x2F;C++机型交互。简单点说就是JNI是Java中调用C&#x2F;C++的统称。</p>\n<ul>\n<li>Java程序中的函数可以调用Native语言写的函数，Native一般指的是C&#x2F;C++编写的函数。</li>\n<li>Native程序中的函数可以调用Java层的函数，也就是在C&#x2F;C++程序中可以调用Java的函数。</li>\n</ul>\n\n\n<h5 id=\"1-1-JNI使用\"><a href=\"#1-1-JNI使用\" class=\"headerlink\" title=\"1.1 JNI使用\"></a>1.1 JNI使用</h5><h6 id=\"1-1-1-声明Native方法\"><a href=\"#1-1-1-声明Native方法\" class=\"headerlink\" title=\"1.1.1 声明Native方法\"></a>1.1.1 声明Native方法</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> TestJNI;</span><br><span class=\"line\"><span class=\"comment\">// 带包名</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JNICallCpp</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 声明为native，表明是有外部来实现的</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title function_\">HannoTower</span><span class=\"params\">(<span class=\"type\">int</span> topN, <span class=\"type\">char</span> from, <span class=\"type\">char</span> inter, <span class=\"type\">char</span> to)</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title function_\">HellCpp</span><span class=\"params\">()</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-1-2-编译生成头文件\"><a href=\"#1-1-2-编译生成头文件\" class=\"headerlink\" title=\"1.1.2 编译生成头文件\"></a>1.1.2 编译生成头文件</h6><ul>\n<li>带包名编译</li>\n</ul>\n<p>如果<code>.java</code>文件中带有包名，则编译时需要切换到<code>包文件所在同级目录</code>，适用命令<code>javah 包名.类名</code>。如，在E:\\JavaProject\\LearnJava\\src目录下，打开cmd，输入<br>javah TestJNI.JNICallCpp。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">E:</span><br><span class=\"line\">cd E:\\JavaProject\\LearnJava\\src</span><br><span class=\"line\">javah TestJNI.JNICallCpp</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>不带包名编译</li>\n</ul>\n<p>如果<code>.java</code>文件中没有包名，则编译时需要切换到<code>.java文件所在同级目录</code>，适用命令<code>javah 类名</code>。如，在E:\\JavaProject\\LearnJava\\src\\TestJNI\\目录下，打开cmd，输入javah JNICallCpp。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">E:</span><br><span class=\"line\">cd E:\\JavaProject\\LearnJava\\src\\TestJNI\\</span><br><span class=\"line\">javah JNICallCpp</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-1-3-实现Native方法\"><a href=\"#1-1-3-实现Native方法\" class=\"headerlink\" title=\"1.1.3 实现Native方法\"></a>1.1.3 实现Native方法</h6><p>将编译生成的头文件引入C++工程的头文件中，以及<code>jni.h、jni_md.h</code>并在新建源文件实现头文件中定义的JNI格式的的函数，由于JNI的数据类型与C++数据类型并不完全相同，因此需要进行数据类型转换，实现定义的函数后，编译为<code>dll、so</code>格式库文件，该文件中即包含该接口。</p>\n<ul>\n<li><code>jni.h</code>：C:\\Program Files\\Java\\jdk1.8.0_291\\include\\jni.h</li>\n<li><code>jni_md.h</code>：C:\\Program Files\\Java\\jdk1.8.0_291\\include\\win32\\jni_md</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;jni.h&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">/* Header for class TestJNI_JNICallCpp */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> _Included_TestJNI_JNICallCpp</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _Included_TestJNI_JNICallCpp</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> __cplusplus</span></span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"string\">&quot;C&quot;</span> &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Class:     TestJNI_JNICallCpp</span></span><br><span class=\"line\"><span class=\"comment\"> * Method:    HannoTower</span></span><br><span class=\"line\"><span class=\"comment\"> * Signature: (ICCC)V</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\">JNIEXPORT <span class=\"type\">void</span> JNICALL <span class=\"title\">Java_TestJNI_JNICallCpp_HannoTower</span></span></span><br><span class=\"line\"><span class=\"function\">  <span class=\"params\">(JNIEnv *, jobject, jint, jchar, jchar, jchar)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Class:     TestJNI_JNICallCpp</span></span><br><span class=\"line\"><span class=\"comment\"> * Method:    HellCpp</span></span><br><span class=\"line\"><span class=\"comment\"> * Signature: ()V</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\">JNIEXPORT <span class=\"type\">void</span> JNICALL <span class=\"title\">Java_TestJNI_JNICallCpp_HellCpp</span></span></span><br><span class=\"line\"><span class=\"function\">  <span class=\"params\">(JNIEnv *, jobject)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> __cplusplus</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;TestJNI_JNICallCpp.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;string&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">//using namespace std;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> __cplusplus</span></span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"string\">&quot;C&quot;</span> &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\">JNIEXPORT <span class=\"type\">void</span> JNICALL <span class=\"title\">Java_TestJNI_JNICallCpp_HannoTower</span></span></span><br><span class=\"line\"><span class=\"function\">\t<span class=\"params\">(JNIEnv *jni_env, jobject jobj, jint layer, jchar from, jchar inter, jchar to)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (layer == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//从Java传过来的参数jchar为unsigned int 16,不是char类型，需要强转</span></span><br><span class=\"line\">\t\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;Disk 1 from &quot;</span> &lt;&lt; <span class=\"built_in\">char</span>(from) &lt;&lt; <span class=\"string\">&quot; to &quot;</span> &lt;&lt; <span class=\"built_in\">char</span>(to) &lt;&lt; std::endl;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">Java_TestJNI_JNICallCpp_HannoTower</span>(jni_env, jobj, layer - <span class=\"number\">1</span>, from, to, inter);</span><br><span class=\"line\">\t\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;Disk &quot;</span> &lt;&lt; layer &lt;&lt; <span class=\"string\">&quot; from &quot;</span> &lt;&lt; <span class=\"built_in\">char</span>(from) &lt;&lt; <span class=\"string\">&quot; to &quot;</span> &lt;&lt; <span class=\"built_in\">char</span>(to) &lt;&lt; std::endl;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">Java_TestJNI_JNICallCpp_HannoTower</span>(jni_env, jobj, layer - <span class=\"number\">1</span>, inter, from, to);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\">JNIEXPORT <span class=\"type\">void</span> JNICALL <span class=\"title\">Java_TestJNI_JNICallCpp_HellCpp</span></span></span><br><span class=\"line\"><span class=\"function\">\t<span class=\"params\">(JNIEnv *, jobject)</span> </span>&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;Call Invoke JNI Func Success&quot;</span> &lt;&lt; std::endl;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> __cplusplus</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-1-4-调用C-C-函数\"><a href=\"#1-1-4-调用C-C-函数\" class=\"headerlink\" title=\"1.1.4 调用C&#x2F;C++函数\"></a>1.1.4 调用C&#x2F;C++函数</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.FileSystems;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CallJNIFunc</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//\t一般在类的静态（static）代码块中加载动态库最合适，因为在创建类的实例时，类会被 ClassLoader 先加载到虚拟机，</span></span><br><span class=\"line\">\t<span class=\"comment\">//\t随后立马调用类的 static 静态代码块。这时再去调用 native 方法就万无一失了。加载动态库的两种方式：</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tSystem.loadLibrary(&quot;HelloWorld&quot;);  </span></span><br><span class=\"line\">\t<span class=\"comment\">//\tSystem.load(&quot;/Users/yangxin/Desktop/libHelloWorld.jnilib&quot;); </span></span><br><span class=\"line\">\t<span class=\"comment\">//\tCan&#x27;t load IA 32-bit .dll on a AMD 64-bit platform解决</span></span><br><span class=\"line\">\t<span class=\"comment\">//\t64位JVM不能调用32位动态库</span></span><br><span class=\"line\">\t<span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//\t获取当前系统分隔符路径</span></span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">separator</span> <span class=\"operator\">=</span> FileSystems.getDefault().getSeparator();</span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">path</span> <span class=\"operator\">=</span> System.getProperty(<span class=\"string\">&quot;user.dir&quot;</span>);</span><br><span class=\"line\">\t\tSystem.out.println(separator);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (separator == <span class=\"string\">&quot;\\\\&quot;</span>) &#123;</span><br><span class=\"line\">\t\t\tpath += <span class=\"string\">&quot;\\\\CLibs\\\\InvokeJNIFunc.dll&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tpath += <span class=\"string\">&quot;/CLibs/InvokeJNIFunc.dll&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tSystem.out.println(path);</span><br><span class=\"line\">\t\tSystem.load(path);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// String path = System.getProperty(&quot;java.library.path&quot;);</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"type\">JNICallCpp</span> <span class=\"variable\">jniCallCpp</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JNICallCpp</span>();</span><br><span class=\"line\">\t\tjniCallCpp.HellCpp();</span><br><span class=\"line\">\t\tjniCallCpp.HannoTower(<span class=\"number\">5</span>, <span class=\"string\">&#x27;A&#x27;</span>, <span class=\"string\">&#x27;B&#x27;</span>, <span class=\"string\">&#x27;C&#x27;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"1-2-JNI头文件介绍\"><a href=\"#1-2-JNI头文件介绍\" class=\"headerlink\" title=\"1.2 JNI头文件介绍\"></a>1.2 JNI头文件介绍</h5><h6 id=\"1-2-1-JNIEnv-类型和jobject类型\"><a href=\"#1-2-1-JNIEnv-类型和jobject类型\" class=\"headerlink\" title=\"1.2.1 JNIEnv 类型和jobject类型\"></a>1.2.1 JNIEnv 类型和jobject类型</h6><p>在上面的<code>TestJNI_JNICallCpp.cpp</code>文件中，<code>Java_TestJNI_JNICallCpp_HannoTower</code>方法中有两个参数，分别是<code>JNIEnv *env</code>,一个是<code>jobjet jobj</code>。下面简单介绍下这两个类型的作用。</p>\n<h6 id=\"1-2-1-1-JNIEnv-类型\"><a href=\"#1-2-1-1-JNIEnv-类型\" class=\"headerlink\" title=\"1.2.1.1 JNIEnv 类型\"></a>1.2.1.1 JNIEnv 类型</h6><p><strong>JNIEnv</strong>类型实际上代表了Java环境，通过JNIEnv*指针就可以对<strong>Java端的代码</strong>进行操作。比如可以使用JNIEnv来创建Java类中的对象，调用Java对象的方法，获取Java对象中的属性等。JNIEnv类中有很多函数可以用，如下所示:</p>\n<ul>\n<li>NewObject: 创建Java类中的对象。</li>\n<li>NewString: 创建Java类中的String对象。</li>\n<li>NewArray: 创建类型为Type的数组对象。</li>\n<li>GetField: 获取类型为Type的字段。</li>\n<li>SetField: 设置类型为Type的字段的值。</li>\n<li>GetStaticField: 获取类型为Type的static的字段。</li>\n<li>SetStaticField: 设置类型为Type的static的字段的值。</li>\n<li>CallMethod: 调用返回类型为Type的方法。</li>\n<li>CallStaticMethod: 调用返回值类型为Type的static 方法。</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 如，要调用Java中的Date类的getTime方法</span></span><br><span class=\"line\"><span class=\"comment\">// FindClass方法参数name是某个类的完整路径</span></span><br><span class=\"line\">(JNIEnv *env, jobject instance)&#123;</span><br><span class=\"line\">\tjclass  class_date = env-&gt;<span class=\"built_in\">FindClass</span>(<span class=\"string\">&quot;java/util/Date&quot;</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//注意这里路径要换成/,不然会报illegal class name</span></span><br><span class=\"line\">\tjmethodID  a_method = env-&gt;<span class=\"built_in\">GetMethodID</span>(class_date,<span class=\"string\">&quot;&lt;init&gt;&quot;</span>,<span class=\"string\">&quot;()V&quot;</span>);</span><br><span class=\"line\">\tjobject  a_date_obj = env-&gt;<span class=\"built_in\">NewObject</span>(class_date,a_method);</span><br><span class=\"line\">\tjmethodID  date_get_time = env-&gt;<span class=\"built_in\">GetMethodID</span>(class_date,<span class=\"string\">&quot;getTime&quot;</span>,<span class=\"string\">&quot;()J&quot;</span>);</span><br><span class=\"line\">\tjlong get_time = env-&gt;<span class=\"built_in\">CallLongMethod</span>(a_date_obj,date_get_time);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> get_time; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-2-1-1-Jobject-类型\"><a href=\"#1-2-1-1-Jobject-类型\" class=\"headerlink\" title=\"1.2.1.1 Jobject 类型\"></a>1.2.1.1 Jobject 类型</h6><p><strong>Jobject</strong>可以看做是java中的类实例的引用。当然，情况不同，意义也不一样。如果native方法不是static, jobjet 就代表native方法的类实例。如果native方法是static, jobjet 就代表native方法的类的class 对象实例(static 方法不需要类实例的，所以就代表这个类的class对象)。</p>\n<ul>\n<li>jclass GetObjectClass(jobject obj) 根据一个对象，获取该对象的类</li>\n<li>jclass GetSuperClass(jclass obj) 获取一个传入的对象获取他的父类的jclass</li>\n<li>GetMethodID: 获取非静态方法的ID</li>\n<li>GetStaticMethodID: 获取静态方法的ID</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 根据jobject的类型，在JNI中写方法的时候如果是非静态的都会传一个jobject的对象</span></span><br><span class=\"line\"><span class=\"comment\">// 可以根据传入的来获取当前对象的类</span></span><br><span class=\"line\"></span><br><span class=\"line\">(JNIEnv *env, jobject instance) &#123;</span><br><span class=\"line\">\tjclass  a_class = env-&gt;<span class=\"built_in\">GetObjectClass</span>(instance);</span><br><span class=\"line\">    <span class=\"comment\">//这里的a_class就是通过instance获取到的</span></span><br><span class=\"line\">\t……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"1-2-1-1-C-调用Java方法\"><a href=\"#1-2-1-1-C-调用Java方法\" class=\"headerlink\" title=\"1.2.1.1 C++调用Java方法\"></a>1.2.1.1 C++调用Java方法</h6><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(JNIEnv *env, jclass type) &#123;</span><br><span class=\"line\">\tjmethodID  a_method = env-&gt;<span class=\"built_in\">GetMethodID</span>(type,<span class=\"string\">&quot;describe&quot;</span>,<span class=\"string\">&quot;()Ljava/lang/String;&quot;</span>); </span><br><span class=\"line\">    <span class=\"comment\">// 通过GetMethod方法获取方法的methodId.</span></span><br><span class=\"line\">\tjobject jobj = env-&gt;<span class=\"built_in\">AllocObject</span>(type);                                          </span><br><span class=\"line\">    <span class=\"comment\">// 对jclass进行实例，相当于java中的new</span></span><br><span class=\"line\">\tjstring pring= (jstring)(env)-&gt;<span class=\"built_in\">CallObjectMethod</span>(jobj,a_method);                </span><br><span class=\"line\">    <span class=\"comment\">// 类调用类中的方法</span></span><br><span class=\"line\">\t<span class=\"type\">char</span> *print=(<span class=\"type\">char</span>*)(env)-&gt;<span class=\"built_in\">GetStringUTFChars</span>(pring,<span class=\"number\">0</span>);                           </span><br><span class=\"line\">    <span class=\"comment\">// 转换格式输出。</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> env-&gt;<span class=\"built_in\">NewStringUTF</span>(print);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"1-3-JNI数据类型映射\"><a href=\"#1-3-JNI数据类型映射\" class=\"headerlink\" title=\"1.3 JNI数据类型映射\"></a>1.3 JNI数据类型映射</h5><ul>\n<li>基本的数据类型</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Java类型</th>\n<th>Native类型</th>\n<th>域描述符</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>boolean</td>\n<td>jboolean</td>\n<td>Z</td>\n</tr>\n<tr>\n<td>byte</td>\n<td>jbyte</td>\n<td>B</td>\n</tr>\n<tr>\n<td>char</td>\n<td>jchar</td>\n<td>C</td>\n</tr>\n<tr>\n<td>short</td>\n<td>jshort</td>\n<td>S</td>\n</tr>\n<tr>\n<td>int</td>\n<td>jnit</td>\n<td>I</td>\n</tr>\n<tr>\n<td>long</td>\n<td>jlong</td>\n<td>J</td>\n</tr>\n<tr>\n<td>float</td>\n<td>jfloat</td>\n<td>F</td>\n</tr>\n<tr>\n<td>double</td>\n<td>jdouble</td>\n<td>D</td>\n</tr>\n<tr>\n<td>void</td>\n<td>void</td>\n<td>V</td>\n</tr>\n</tbody></table>\n<ul>\n<li>数组引用类型</li>\n</ul>\n<p>如果是一维数组则遵循下表，如果是二维数组或更高维数组则对应的 Natvie类型为 jobjectArray，域描述符中使用 ‘[’ 的个数表示维数：</p>\n<table>\n<thead>\n<tr>\n<th>Java类型</th>\n<th>Native类型</th>\n<th>域描述符</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>int[]</td>\n<td>jintArray</td>\n<td>[I</td>\n</tr>\n<tr>\n<td>float[]</td>\n<td>jfloatArray</td>\n<td>[f</td>\n</tr>\n<tr>\n<td>byte[]</td>\n<td>jbyteArray</td>\n<td>[B</td>\n</tr>\n<tr>\n<td>char[]</td>\n<td>jcharArray</td>\n<td>[C</td>\n</tr>\n<tr>\n<td>short[]</td>\n<td>jshortArray</td>\n<td>[S</td>\n</tr>\n<tr>\n<td>double[]</td>\n<td>jdoubleArray</td>\n<td>[D</td>\n</tr>\n<tr>\n<td>long[]</td>\n<td>jlongArray</td>\n<td>[F</td>\n</tr>\n<tr>\n<td>boolean[]</td>\n<td>jbooleanArray</td>\n<td>[Z</td>\n</tr>\n</tbody></table>\n<ul>\n<li>对象引用类型</li>\n</ul>\n<p>对于其它引用类型，即 java 中的对象，其映射规则为：</p>\n<table>\n<thead>\n<tr>\n<th>Java类型</th>\n<th>Native类型</th>\n<th>域描述符</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>类名（如 Surface）</td>\n<td>通常是 jobject，仅有一种例外，如果 java 类型是 String，则对应的native 类型是 jstring</td>\n<td>以”L”开头，以”;”结尾中间是用”&#x2F;” 隔开的包及类名（如 Landroid&#x2F;view&#x2F;Surface;）如果内部类则使用$连接内部类；</td>\n</tr>\n</tbody></table>\n<ul>\n<li>对象数组引用类型</li>\n</ul>\n<p>如果是一维数组则遵循下表，如果是二维数组或更高维数组则对应的 native 类型为 jobjectArray，域描述符中使用 ‘[’ 的个数表示维数：</p>\n<table>\n<thead>\n<tr>\n<th>Java类型</th>\n<th>Native类型</th>\n<th>域描述符</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>类名（如 Surface）</td>\n<td>通常是 jobject，仅有一种例外，如果 java 类型是 String，则对应的native 类型是 jstring</td>\n<td>在对象引用类型的域描述符的基础上在左边添加’[‘字符</td>\n</tr>\n</tbody></table>\n<h5 id=\"1-4-参考文献\"><a href=\"#1-4-参考文献\" class=\"headerlink\" title=\"1.4 参考文献\"></a>1.4 参考文献</h5><ul>\n<li>Java文档：<a href=\"https://docs.oracle.com/javase/6/docs/technotes/guides/jni/spec/jniTOC.html\">Contents (oracle.com)</a></li>\n<li>JNI使用全面讲解：<a href=\"https://zhuanlan.zhihu.com/p/97691316\">Android JNI使用全面讲解 - 知乎 (zhihu.com)</a></li>\n</ul>\n<h4 id=\"2-JNA\"><a href=\"#2-JNA\" class=\"headerlink\" title=\"2  JNA\"></a>2  JNA</h4><p>JNA，全名Java Native Access是建立在JNI技术基础之上的一个Java类库，可以方便地使用java直接访问动态链接库中的函数。不需要使用JNI重写动态链接库文件，而是有直接调用的API，大大简化了工作量。JNA将自动实现Java接口到native function的映射，但是JNA一般只适用于较为简单的C&#x2F;C++库，如果接口、数据结构复杂的话就不推荐。而且JNA也只提供了C&#x2F;C++对Java的接口转化。</p>\n\n\n<p>JNA使用一个小型的JNI库插桩程序来动态调用本地代码。开发者使用Java接口描述目标本地库的功能和结构，这使得它很容易利用本机平台的功能，而不会产生多平台配置和生成JNI代码的高开销。这样的性能、准确性和易用性显然受到很大的重视。</p>\n<h5 id=\"2-1-JNA使用\"><a href=\"#2-1-JNA使用\" class=\"headerlink\" title=\"2 .1 JNA使用\"></a>2 .1 JNA使用</h5><h6 id=\"2-1-1-引入jar包\"><a href=\"#2-1-1-引入jar包\" class=\"headerlink\" title=\"2.1.1 引入jar包\"></a>2.1.1 引入jar包</h6><p>使用Maven配置或者从github下载最新的<code>jna.jar</code>文件(<a href=\"https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md\">jna&#x2F;GettingStarted.md at master · java-native-access&#x2F;jna · GitHub</a>)，并将<code>jna.jar</code>引入到工程文件中。</p>\n<h6 id=\"2-1-2-声明API接口\"><a href=\"#2-1-2-声明API接口\" class=\"headerlink\" title=\"2.1.2 声明API接口\"></a>2.1.2 声明API接口</h6><ul>\n<li><p>定义了一个接口，继承自Library 或StdCallLibrary，默认的是继承Library ， 如果动态链接库里的函数是以stdcall方式输出的，那么就继承StdCallLibrary，比如众所周知的kernel32库。</p>\n</li>\n<li><p>接口内部需要一个公共静态常量：INSTANCE，通过这个常量，就可以获得这个接口的实例，从而使用接口的方法，也就是调用外部dll&#x2F;so的函数。 该常量通过Native.loadLibrary()这个API函数获得，该函数有2个参数：</p>\n<ul>\n<li>第一个参数是动态链接库dll&#x2F;so的名称，但不带.dll或.so这样的后缀，这符合JNI的规范，因为带了后缀名就不可以跨操作系统平台了。搜索动态链 接库路径的顺序是：先从当前类的当前文件夹找，如果没有找到，再在工程当前文件夹下面找win32&#x2F;win64文件夹，找到后搜索对应的dll文件，如果找不到再到WINDOWS下面去搜索，再找不到就会抛异常了。比如上例中printf函数在Windows平台下所在的dll库名称是msvcrt，而在 其它平台如Linux下的so库名称是c。</li>\n<li>第二个参数是本接口的Class类型。JNA通过这个Class类型，根据指定的.dll&#x2F;.so文件，动态创建接口的实例。该实例由JNA通过反射自动生成。 然后在MainActivity中调用sayHello方法。</li>\n</ul>\n</li>\n<li><p>接口中只需要定义你要用到的函数或者公共变量，不需要的可以不定义，注意参数和返回值的类型，应该和链接库中的函数类型保持一致。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This is the standard, stable way of mapping, which supports extensive</span></span><br><span class=\"line\"><span class=\"comment\">// customization and mapping of Java to native types</span></span><br><span class=\"line\"><span class=\"comment\">// 声明接口，继承Library，用于加载库文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//继承Library，用于加载库文件</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">CLibrary</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Library</span> &#123;</span><br><span class=\"line\">\t<span class=\"type\">String</span> <span class=\"variable\">dllName</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;/Clibs/CompileDLL.dll&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class=\"line\">\t<span class=\"comment\">// 加载动态链接库</span></span><br><span class=\"line\">\t<span class=\"comment\">// 直接写动态库名称，动态库需要到为source或者代码添加动态库路径为source</span></span><br><span class=\"line\">\t<span class=\"comment\">// CLibrary instance = (CLibrary) Native.loadLibrary(dllName, CLibrary.class);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">CLibrary</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> (CLibrary) Native.loadLibrary(dllName, CLibrary.class);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 链接动态库中的方法</span></span><br><span class=\"line\">\t<span class=\"type\">double</span> <span class=\"title function_\">seekArea</span><span class=\"params\">(<span class=\"type\">int</span> a, <span class=\"type\">int</span> b)</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"2-1-3-调用C-C-函数\"><a href=\"#2-1-3-调用C-C-函数\" class=\"headerlink\" title=\"2.1.3 调用C&#x2F;C++函数\"></a>2.1.3 调用C&#x2F;C++函数</h6><p>定义好接口后，就可以使用接口中的函数即相应dll&#x2F;so中的函数了。通过接口中的实例进行调用，非常简单。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> TestJNA;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JNACallCpp</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"type\">double</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> CLibrary.instance.seekArea(<span class=\"number\">2</span>, <span class=\"number\">2</span>);</span><br><span class=\"line\">\t\tSystem.out.println(<span class=\"string\">&quot;the area is:&quot;</span> + res);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"2-2-JNA数据类型映射\"><a href=\"#2-2-JNA数据类型映射\" class=\"headerlink\" title=\"2.2  JNA数据类型映射\"></a>2.2  JNA数据类型映射</h5><ul>\n<li>基本的数据类型</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Native Type</th>\n<th>Size</th>\n<th>Java Type</th>\n<th>Common Windows Types</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>char</td>\n<td>8-bit integer</td>\n<td>byte</td>\n<td>BYTE, TCHAR</td>\n</tr>\n<tr>\n<td>short</td>\n<td>16-bit integer</td>\n<td>short</td>\n<td>WORD</td>\n</tr>\n<tr>\n<td>wchar_t</td>\n<td>16&#x2F;32-bit character</td>\n<td>char</td>\n<td>TCHAR</td>\n</tr>\n<tr>\n<td>int</td>\n<td>32-bit integer</td>\n<td>int</td>\n<td>DWORD</td>\n</tr>\n<tr>\n<td>int</td>\n<td>boolean value</td>\n<td>boolean</td>\n<td>BOOL</td>\n</tr>\n<tr>\n<td>long</td>\n<td>32&#x2F;64-bit integer</td>\n<td>NativeLong</td>\n<td>LONG</td>\n</tr>\n<tr>\n<td>long long</td>\n<td>64-bit integer</td>\n<td>long</td>\n<td>__int64</td>\n</tr>\n<tr>\n<td>float</td>\n<td>32-bit FP</td>\n<td>float</td>\n<td></td>\n</tr>\n<tr>\n<td>double</td>\n<td>64-bit FP</td>\n<td>double</td>\n<td></td>\n</tr>\n<tr>\n<td>char*</td>\n<td>C string</td>\n<td>String</td>\n<td>LPCSTR</td>\n</tr>\n<tr>\n<td>void*</td>\n<td>pointer</td>\n<td>Pointer</td>\n<td>LPVOID, HANDLE, LP<em>XXX</em></td>\n</tr>\n</tbody></table>\n<ul>\n<li>复杂的数据类型</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th><strong>Java 类型</strong></th>\n<th><strong>C 类型</strong></th>\n<th><strong>原生表现</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>boolean</td>\n<td>int</td>\n<td>32位整数(可定制)</td>\n</tr>\n<tr>\n<td>byte</td>\n<td>char</td>\n<td>8位整数</td>\n</tr>\n<tr>\n<td>char</td>\n<td>wchar_t</td>\n<td>平台依赖</td>\n</tr>\n<tr>\n<td>short</td>\n<td>short</td>\n<td>16位整数</td>\n</tr>\n<tr>\n<td>int</td>\n<td>int</td>\n<td>32位整数</td>\n</tr>\n<tr>\n<td>long</td>\n<td>long long, __int64</td>\n<td>64位整数</td>\n</tr>\n<tr>\n<td>float</td>\n<td>float</td>\n<td>32位浮点数</td>\n</tr>\n<tr>\n<td>double</td>\n<td>double</td>\n<td>64位浮点数</td>\n</tr>\n<tr>\n<td>Buffer&#x2F;Pointer</td>\n<td>pointer</td>\n<td>平台依赖(32或64位指针)</td>\n</tr>\n<tr>\n<td><T>[] (基本类型的数组)</td>\n<td>pointer&#x2F;array</td>\n<td>32或64位指针(参数&#x2F;返回值)邻接内存(结构体成员)</td>\n</tr>\n<tr>\n<td>String</td>\n<td>char*</td>\n<td>&#x2F;0结束的数组 (native encoding or jna.encoding)</td>\n</tr>\n<tr>\n<td>WString</td>\n<td>wchar_t*</td>\n<td>&#x2F;0结束的数组(unicode)</td>\n</tr>\n<tr>\n<td>String[]</td>\n<td>char**</td>\n<td>&#x2F;0结束的数组的数组</td>\n</tr>\n<tr>\n<td>WString[]</td>\n<td>wchar_t**</td>\n<td>&#x2F;0结束的宽字符数组的数组</td>\n</tr>\n<tr>\n<td>Structure</td>\n<td>struct*&#x2F;struct</td>\n<td>指向结构体的指针(参数或返回值) (或者明确指定是结构体指针)结构体(结构体的成员) (或者明确指定是结构体)</td>\n</tr>\n<tr>\n<td>Union</td>\n<td>union</td>\n<td>等同于结构体</td>\n</tr>\n<tr>\n<td>Structure[]</td>\n<td>struct[]</td>\n<td>结构体的数组，邻接内存</td>\n</tr>\n<tr>\n<td>Callback</td>\n<td><T> (*fp)()</td>\n<td>Java函数指针或原生函数指针</td>\n</tr>\n<tr>\n<td>NativeMapped</td>\n<td>varies</td>\n<td>依赖于定义</td>\n</tr>\n<tr>\n<td>NativeLong</td>\n<td>long</td>\n<td>平台依赖(32或64位整数)</td>\n</tr>\n<tr>\n<td>PointerType</td>\n<td>pointer</td>\n<td>和Pointer相同</td>\n</tr>\n</tbody></table>\n<ul>\n<li>结构体数据类型</li>\n</ul>\n<p><strong>Structure 子类中的公共字段的顺序，必须与C 语言中的结构的顺序一致。否则会报错！</strong>因为，Java 调用动态链接库中的C 函数，实际上就是一段内存作为函数的参数传递给C函数。动态链接库以为这个参数就是C 语言传过来的参数。同时，C 语言的结构体是一个严格的规范，它定义了内存的次序。因此，JNA 中模拟的结构体的变量顺序绝对不能错。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// C语言结构体</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">UserStruct</span>&#123;</span></span><br><span class=\"line\">    <span class=\"type\">long</span> id;</span><br><span class=\"line\">    <span class=\"type\">wchar_t</span>* name;</span><br><span class=\"line\">    <span class=\"type\">int</span> age;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MYLIBAPI extern <span class=\"string\">&quot;C&quot;</span> __declspec( dllexport )</span></span><br><span class=\"line\">MYLIBAPI <span class=\"type\">void</span> <span class=\"title function_\">sayUser</span><span class=\"params\">(UserStruct* pUserStruct)</span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Java构造</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UserStruct</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Structure</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> NativeLong id;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> WString name;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> age;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ByReference</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">UserStruct</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Structure</span>.ByReference &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ByValue</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">UserStruct</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Structure</span>.ByValue &#123;&#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> List <span class=\"title function_\">getFieldOrder</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> Arrays.asList(<span class=\"keyword\">new</span> <span class=\"title class_\">String</span>[] &#123; <span class=\"string\">&quot;id&quot;</span>, <span class=\"string\">&quot;name&quot;</span>, <span class=\"string\">&quot;age&quot;</span>&#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 定义C++函数接口</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sayUser</span><span class=\"params\">(UserStruct.ByReference struct)</span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Java调用</span></span><br><span class=\"line\">UserStruct userStruct=<span class=\"keyword\">new</span> <span class=\"title class_\">UserStruct</span> ();</span><br><span class=\"line\">userStruct.id=<span class=\"keyword\">new</span> <span class=\"title class_\">NativeLong</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">userStruct.age=<span class=\"number\">30</span>;</span><br><span class=\"line\">userStruct.name=<span class=\"keyword\">new</span> <span class=\"title class_\">WString</span>(<span class=\"string\">&quot;奥巴马&quot;</span>);</span><br><span class=\"line\">TestDll1.INSTANCE.sayUser(userStruct);</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"2-3-参考文献\"><a href=\"#2-3-参考文献\" class=\"headerlink\" title=\"2.3  参考文献\"></a>2.3  参考文献</h5><ul>\n<li><p>JNA官方文档：<a href=\"http://java-native-access.github.io/jna/4.4.0/javadoc/\">Overview (JNA API) (java-native-access.github.io)</a></p>\n</li>\n<li><p>Github：<a href=\"https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md\">jna&#x2F;GettingStarted.md at master · java-native-access&#x2F;jna · GitHub</a></p>\n</li>\n<li><p>JNA实战笔记汇总：<a href=\"https://www.jianshu.com/p/164443701574\">JNA实战笔记汇总&lt;一&gt; 简单认识JNA|成功调用JNA - 简书 (jianshu.com)</a></p>\n</li>\n<li><p>JNA使用示例：[Java JNA （三）—— 结构体使用及简单示例 - 疯狂的小萝卜头 - 博客园 (cnblogs.com)](</p>\n</li>\n</ul>\n<h4 id=\"3-文件说明\"><a href=\"#3-文件说明\" class=\"headerlink\" title=\"3 文件说明\"></a>3 文件说明</h4>\n\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CLibs</td>\n<td>编译好的DLL文件，<code>CompileDLL.dll、InvokeJNIFunc.dll</code></td>\n</tr>\n<tr>\n<td>CompileDLL</td>\n<td>JNA调用<code>CompileDLL.dl</code>l的C++源文件</td>\n</tr>\n<tr>\n<td>InvokeJNIFunc</td>\n<td>JNI调用<code>InvokeJNIFunc.dll</code>的C++源文件</td>\n</tr>\n<tr>\n<td>Jar</td>\n<td>jna的jar包</td>\n</tr>\n<tr>\n<td>src</td>\n<td>java调用测试源文件</td>\n</tr>\n</tbody></table>\n"},{"title":"es常用命令","date":"2025-02-27T07:00:37.000Z","_content":"\n以下是 Elasticsearch (ES) 常用命令的总结和笔记：\n\n### 1. 查看索引相关信息\n\n- **查看指定索引的映射信息**\n  ```bash\n  GET kibana_sample_data_ecommerce\n  ```\n\n- **查看指定索引的文档总数**\n  ```bash\n  GET kibana_sample_data_ecommerce/_count\n  ```\n\n- **查看前10条文档**\n  ```bash\n  POST kibana_sample_data_ecommerce/_search\n  {\n  }\n  ```\n\n### 2. 查看索引状态与信息\n\n- **查看索引信息**\n  ```bash\n  GET /_cat/indices/kibana*?v&s=index\n  ```\n\n- **查看状态为绿的索引**\n  ```bash\n  GET /_cat/indices?v&health=green\n  ```\n\n- **按文档个数排序查看索引**\n  ```bash\n  GET /_cat/indices?v&s=docs.count:desc\n  ```\n\n- **查看具体的索引字段（健康、主分片、复制分片、文档数等）**\n  ```bash\n  GET /_cat/indices/kibana*?pri&v&h=health,index,pri,rep,docs.count,mt\n  ```\n\n- **查看每个索引使用的内存量**\n  ```bash\n  GET /_cat/indices?v&h=i,tm&s=tm:desc\n  ```\n\n### 3. 查看节点信息\n\n- **查看所有节点信息**\n  ```bash\n  GET _cat/nodes?v\n  ```\n\n- **查看特定节点信息**\n  ```bash\n  GET /_nodes/es7_01,es7_02\n  ```\n\n- **查看节点信息并显示特定字段**\n  ```bash\n  GET /_cat/nodes?v&h=id,ip,port,v,m\n  ```\n\n### 4. 查看集群健康状况\n\n- **查看集群健康状况**\n  ```bash\n  GET _cluster/health\n  ```\n\n- **查看集群健康状况，并按分片级别显示**\n  ```bash\n  GET _cluster/health?level=shards\n  ```\n\n- **查看特定索引的集群健康状况**\n  ```bash\n  GET /_cluster/health/kibana_sample_data_ecommerce,kibana_sample_data_flights\n  ```\n\n- **查看特定索引的集群健康状况，并按分片级别显示**\n  ```bash\n  GET /_cluster/health/kibana_sample_data_flights?level=shards\n  ```\n\n### 5. 查看集群状态\n\n- **查看集群状态**\n  ```bash\n  GET /_cluster/state\n  ```\n\n### 6. 查看集群设置\n\n- **查看集群设置**\n  ```bash\n  GET /_cluster/settings\n  ```\n\n- **查看集群设置，包括默认设置**\n  ```bash\n  GET /_cluster/settings?include_defaults=true\n  ```\n\n### 7. 查看分片信息\n\n- **查看集群的所有分片信息**\n  ```bash\n  GET /_cat/shards\n  ```\n\n- **查看特定的分片信息（包括状态、主分片/副本分片等）**\n  ```bash\n  GET /_cat/shards?h=index,shard,prirep,state,unassigned.reason\n  ```\n\n\n\n### 1. 创建文档\n\n- **自动生成 `_id` 创建文档**\n  ```bash\n  POST users/_doc\n  {\n    \"user\" : \"Mike\",\n    \"post_date\" : \"2019-04-15T14:12:12\",\n    \"message\" : \"trying out Kibana\"\n  }\n  ```\n\n- **指定 ID 创建文档（如果 ID 已存在则报错）**\n  ```bash\n  PUT users/_doc/1?op_type=create\n  {\n    \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n  }\n  ```\n\n- **指定 ID 创建文档（如果 ID 已存在则报错）**\n  ```bash\n  PUT users/_create/1\n  {\n    \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n  }\n  ```\n\n### 2. 根据 ID 获取文档\n\n- **获取指定 ID 的文档**\n  ```bash\n  GET users/_doc/1\n  ```\n\n### 3. 更新文档\n\n- **更新指定 ID 的文档（先删除再写入）**\n  ```bash\n  PUT users/_doc/1\n  {\n    \"user\" : \"Mike\"\n  }\n  ```\n\n- **在原文档上增加字段**\n  ```bash\n  POST users/_update/1/\n  {\n    \"doc\": {\n      \"post_date\" : \"2019-05-15T14:12:12\",\n      \"message\" : \"trying out Elasticsearch\"\n    }\n  }\n  ```\n\n### 4. 删除文档\n\n- **根据 ID 删除文档**\n  ```bash\n  DELETE users/_doc/1\n  ```\n\n### 5. 批量操作 (Bulk API)\n\n- **执行批量操作**  \n  第一次执行批量操作：\n  ```bash\n  POST _bulk\n  { \"index\" : { \"_index\" : \"test\", \"_id\" : \"1\" } }\n  { \"field1\" : \"value1\" }\n  { \"delete\" : { \"_index\" : \"test\", \"_id\" : \"2\" } }\n  { \"create\" : { \"_index\" : \"test2\", \"_id\" : \"3\" } }\n  { \"field1\" : \"value3\" }\n  { \"update\" : {\"_id\" : \"1\", \"_index\" : \"test\"} }\n  { \"doc\" : {\"field2\" : \"value2\"} }\n  ```\n\n  第二次执行批量操作：\n  ```bash\n  POST _bulk\n  { \"index\" : { \"_index\" : \"test\", \"_id\" : \"1\" } }\n  { \"field1\" : \"value1\" }\n  { \"delete\" : { \"_index\" : \"test\", \"_id\" : \"2\" } }\n  { \"create\" : { \"_index\" : \"test2\", \"_id\" : \"3\" } }\n  { \"field1\" : \"value3\" }\n  { \"update\" : {\"_id\" : \"1\", \"_index\" : \"test\"} }\n  { \"doc\" : {\"field2\" : \"value2\"} }\n  ```\n\n### 6. 多文档获取 (MGET)\n\n- **获取多个文档**\n  ```bash\n  GET /_mget\n  {\n    \"docs\" : [\n      { \"_index\" : \"test\", \"_id\" : \"1\" },\n      { \"_index\" : \"test\", \"_id\" : \"2\" }\n    ]\n  }\n  ```\n\n- **URI中指定索引**\n  ```bash\n  GET /test/_mget\n  {\n    \"docs\" : [\n      { \"_id\" : \"1\" },\n      { \"_id\" : \"2\" }\n    ]\n  }\n  ```\n\n- **使用 `_source` 参数指定返回的字段**\n  ```bash\n  GET /_mget\n  {\n    \"docs\" : [\n      { \"_index\" : \"test\", \"_id\" : \"1\", \"_source\" : false },\n      { \"_index\" : \"test\", \"_id\" : \"2\", \"_source\" : [\"field3\", \"field4\"] },\n      { \"_index\" : \"test\", \"_id\" : \"3\", \"_source\" : { \"include\": [\"user\"], \"exclude\": [\"user.location\"] } }\n    ]\n  }\n  ```\n\n### 7. 多查询操作 (MSEARCH)\n\n- **执行多个查询**\n  ```bash\n  POST kibana_sample_data_ecommerce/_msearch\n  {}\n  {\"query\" : {\"match_all\" : {}},\"size\":1}\n  {\"index\" : \"kibana_sample_data_flights\"}\n  {\"query\" : {\"match_all\" : {}},\"size\":2}\n  ```\n\n### 8. 清除测试数据\n\n- **删除索引（清除数据）**\n  ```bash\n  DELETE users\n  DELETE test\n  DELETE test2\n  ```\n\n[3.4-倒排索引入门]\n\nElasticsearch 的 `_analyze` API，它用于分析文本，查看在特定分析器下，文本是如何被分词和处理的。下面是每个请求的说明：\n\n### 1. **分析 \"Mastering Elasticsearch\"**\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Mastering Elasticsearch\"\n}\n```\n- **分析器**：使用默认的 `standard` 分析器。\n- **文本**：`\"Mastering Elasticsearch\"`。\n- **预期效果**：`standard` 分析器会将这段文本分割成单词，通常会根据空格和标点符号进行分词。\n\n### 2. **分析 \"Elasticsearch Server\"**\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Elasticsearch Server\"\n}\n```\n- **分析器**：同样使用 `standard` 分析器。\n- **文本**：`\"Elasticsearch Server\"`。\n- **预期效果**：分析器会分割文本为单词，可能会得到类似于 `[\"elasticsearch\", \"server\"]` 的分词结果。\n\n### 3. **分析 \"Elasticsearch Essentials\"**\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Elasticsearch Essentials\"\n}\n```\n- **分析器**：继续使用 `standard` 分析器。\n- **文本**：`\"Elasticsearch Essentials\"`。\n- **预期效果**：分析器会将文本分割成 `[\"elasticsearch\", \"essentials\"]`。\n\n### 结果\n每个请求的结果将显示由 `standard` 分析器生成的分词结果。通常，`standard` 分析器会去除大部分标点符号并将文本转换为小写。分词的具体结果如下：\n\n- `\"Mastering Elasticsearch\"` -> `[\"mastering\", \"elasticsearch\"]`\n- `\"Elasticsearch Server\"` -> `[\"elasticsearch\", \"server\"]`\n- `\"Elasticsearch Essentials\"` -> `[\"elasticsearch\", \"essentials\"]`\n\n\n以下是使用不同的分析器（Analyzer）对文本进行分词分析的示例：\n\n### 1. **Standard Analyzer**\n标准分析器会根据空格、标点符号等进行分词，并将所有文本转换为小写。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n\n{\n  \"tokens\" : [\n    {\n      \"token\" : \"2\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 1,\n      \"type\" : \"<NUM>\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"running\",\n      \"start_offset\" : 2,\n      \"end_offset\" : 9,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"quick\",\n      \"start_offset\" : 10,\n      \"end_offset\" : 15,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"brown\",\n      \"start_offset\" : 16,\n      \"end_offset\" : 21,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 3\n    },\n    {\n      \"token\" : \"foxes\",\n      \"start_offset\" : 22,\n      \"end_offset\" : 27,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 4\n    },\n    {\n      \"token\" : \"leap\",\n      \"start_offset\" : 28,\n      \"end_offset\" : 32,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 5\n    },\n    {\n      \"token\" : \"over\",\n      \"start_offset\" : 33,\n      \"end_offset\" : 37,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 6\n    },\n    {\n      \"token\" : \"lazy\",\n      \"start_offset\" : 38,\n      \"end_offset\" : 42,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 7\n    },\n    {\n      \"token\" : \"dogs\",\n      \"start_offset\" : 43,\n      \"end_offset\" : 47,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 8\n    },\n    {\n      \"token\" : \"in\",\n      \"start_offset\" : 48,\n      \"end_offset\" : 50,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 9\n    },\n    {\n      \"token\" : \"the\",\n      \"start_offset\" : 51,\n      \"end_offset\" : 54,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 10\n    },\n    {\n      \"token\" : \"summer\",\n      \"start_offset\" : 55,\n      \"end_offset\" : 61,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 11\n    },\n    {\n      \"token\" : \"evening\",\n      \"start_offset\" : 62,\n      \"end_offset\" : 69,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 12\n    }\n  ]\n}\n\n```\n- **分词结果**：`[\"2\", \"running\", \"quick\", \"brown\", \"foxes\", \"leap\", \"over\", \"lazy\", \"dogs\", \"in\", \"the\", \"summer\", \"evening\"]`\n\n\n### 2. **Simple Analyzer**\n简单分析器按非字母字符切分，符号会被过滤，文本会转换为小写。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"simple\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"quick\", \"brown\", \"foxes\", \"leap\", \"over\", \"lazy\", \"dogs\", \"in\", \"the\", \"summer\", \"evening\"]`\n\n### 3. **Stop Analyzer**\n停用词分析器会将文本转换为小写，并过滤掉常见的停用词（如 \"the\", \"a\", \"is\"）。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"stop\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"quick\", \"brown\", \"foxes\", \"leap\", \"lazy\", \"dogs\", \"summer\", \"evening\"]`\n\n### 4. **Whitespace Analyzer**\n空格分析器会按空格切分文本，并且不会转换为小写。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"whitespace\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"Quick\", \"brown-foxes\", \"leap\", \"over\", \"lazy\", \"dogs\", \"in\", \"the\", \"summer\", \"evening.\"]`\n\n### 5. **Keyword Analyzer**\n关键字分析器不进行分词，直接返回原始文本。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"keyword\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"]`\n\n### 6. **Pattern Analyzer**\n模式分析器使用正则表达式进行分词，默认使用 `\\W+`（非字母字符）作为分隔符。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"pattern\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"Quick\", \"brown\", \"foxes\", \"leap\", \"over\", \"lazy\", \"dogs\", \"in\", \"the\", \"summer\", \"evening\"]`\n\n### 7. **English Analyzer**\n英语分析器针对英语语言进行分词，去除停用词等。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"english\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"quick\", \"brown\", \"foxes\", \"leap\", \"lazy\", \"dogs\", \"summer\", \"evening\"]`\n\n### 8. **ICU Analyzer for Chinese Text**\n使用 `icu_analyzer` 来处理中文文本，适用于多语言环境中的分词。\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"icu_analyzer\",\n  \"text\": \"他说的确实在理\"\n}\n```\n- **分词结果**：`[\"他说\", \"的\", \"确实\", \"在理\"]`\n\n### 9. **Standard Analyzer for Chinese Text**\n使用标准分析器处理中文文本，通常处理中文时可能不会像中文专用分析器那样精确。\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"他说的确实在理\"\n}\n```\n- **分词结果**：`[\"他说\", \"的\", \"确实\", \"在理\"]`\n\n### 10. **ICU Analyzer for Another Chinese Sentence**\n处理另一个中文句子 `\"这个苹果不大好吃\"`。\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"icu_analyzer\",\n  \"text\": \"这个苹果不大好吃\"\n}\n```\n- **分词结果**：`[\"这个\", \"苹果\", \"不大\", \"好吃\"]`\n\n### 总结\n每种分析器具有不同的分词行为：\n- **Standard**：根据空格和标点符号分词并小写化。\n- **Simple**：过滤非字母字符并小写化。\n- **Stop**：去除停用词并小写化。\n- **Whitespace**：仅按空格分词，不进行大小写转换。\n- **Keyword**：不进行分词，返回整个文本。\n- **Pattern**：使用正则表达式分词，默认 `\\W+` 分割。\n- **English**：为英语文本设计的分析器，去除停用词。\n- **ICU Analyzer**：适合多语言的分词，特别适用于中文等非拉丁字母语言。\n\n这些分析器可以根据不同的语言和需求来优化索引和搜索。\n\n\n以下是您提供的一些 Elasticsearch 查询示例，涵盖了基本查询、带有分析的查询、布尔查询、范围查询、通配符查询、模糊查询等操作。下面是每种查询的详细解释和用法：\n\n### 1. **基本查询**\n查询 `movies` 索引中标题为 `2012` 的电影，并根据 `year` 字段降序排序，返回前 10 条结果：\n```bash\nGET /movies/_search?q=2012&df=title&sort=year:desc&from=0&size=10&timeout=1s\n```\n- **`q=2012`**：查询内容为 `2012`。\n- **`df=title`**：指定查询字段为 `title`。\n- **`sort=year:desc`**：按 `year` 字段降序排序。\n- **`from=0&size=10`**：分页，返回前 10 条数据。\n- **`timeout=1s`**：查询超时限制为 1 秒。\n\n### 2. **带 Profile 的查询**\n启用 `profile` 可以帮助分析查询性能，查看查询的每个阶段的时间。\n```bash\nGET /movies/_search?q=2012&df=title\n{\n\t\"profile\":\"true\"\n}\n```\n- **`\"profile\": \"true\"`**：启用查询性能分析。\n\n### 3. **泛查询，对所有字段进行查询**\n使用 `_all` 字段进行泛查询，查询所有字段。\n```bash\nGET /movies/_search?q=2012\n{\n\t\"profile\":\"true\"\n}\n```\n- **`q=2012`**：查询所有字段中包含 `2012` 的数据。\n\n### 4. **指定字段查询**\n查询 `title` 字段中包含 `2012` 的记录，并按照 `year` 字段降序排序：\n```bash\nGET /movies/_search?q=title:2012&sort=year:desc&from=0&size=10&timeout=1s\n{\n\t\"profile\":\"true\"\n}\n```\n- **`q=title:2012`**：指定查询字段为 `title`，查询内容为 `2012`。\n\n### 5. **查找美丽心灵**\n查询 `title` 字段包含 `\"Beautiful Mind\"` 的记录：\n```bash\nGET /movies/_search?q=title:Beautiful Mind\n{\n\t\"profile\":\"true\"\n}\n```\n\n### 6. **泛查询**\n查询 `title` 字段包含 `2012` 的记录：\n```bash\nGET /movies/_search?q=title:2012\n{\n\t\"profile\":\"true\"\n}\n```\n\n### 7. **Phrase 查询（短语查询）**\n查询 `title` 字段精确匹配 `\"Beautiful Mind\"`：\n```bash\nGET /movies/_search?q=title:\"Beautiful Mind\"\n{\n\t\"profile\":\"true\"\n}\n```\n- 使用引号表示精确短语匹配，要求字段内容必须完全匹配短语 `\"Beautiful Mind\"`。\n\n### 8. **分组查询（使用括号）**\n查询 `title` 字段中包含 `Beautiful Mind` 的记录：\n```bash\nGET /movies/_search?q=title:(Beautiful Mind)\n{\n\t\"profile\":\"true\"\n}\n```\n- 使用括号可以进行分组查询，类似逻辑上的括号优先级。\n\n### 9. **布尔操作符查询**\n- **AND 查询：**\n  查询 `title` 字段同时包含 `Beautiful` 和 `Mind` 的记录：\n  ```bash\n  GET /movies/_search?q=title:(Beautiful AND Mind)\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n- **NOT 查询：**\n  查询 `title` 字段包含 `Beautiful` 但不包含 `Mind` 的记录：\n  ```bash\n  GET /movies/_search?q=title:(Beautiful NOT Mind)\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n- **OR 查询：**\n  查询 `title` 字段包含 `Beautiful` 或 `Mind` 的记录：\n  ```bash\n  GET /movies/_search?q=title:(Beautiful %2BMind)\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n\n### 10. **范围查询**\n查询 `title` 字段包含 `beautiful` 且 `year` 在 2002 到 2018 年之间的记录：\n```bash\nGET /movies/_search?q=title:beautiful AND year:[2002 TO 2018%7D\n{\n\t\"profile\":\"true\"\n}\n```\n- **`year:[2002 TO 2018]`**：指定 `year` 字段的范围查询。\n\n### 11. **通配符查询**\n查询 `title` 字段以 `b` 开头的所有记录：\n```bash\nGET /movies/_search?q=title:b*\n{\n\t\"profile\":\"true\"\n}\n```\n- **`b*`**：使用通配符查询以 `b` 开头的字符串。\n\n### 12. **模糊查询 & 近似度匹配**\n- **模糊匹配**：查询 `title` 字段中的词语 `beautifl`，允许有 1 个字符的错误：\n  ```bash\n  GET /movies/_search?q=title:beautifl~1\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n- **近似度匹配**：查询 `title` 字段中的短语 `\"Lord Rings\"`，允许 2 个字符的误差：\n  ```bash\n  GET /movies/_search?q=title:\"Lord Rings\"~2\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n\n### 总结\n这些查询展示了如何使用 Elasticsearch 提供的强大查询能力来根据不同的需求筛选和搜索数据。常见的查询类型包括：\n- **基本查询**：用于查找单一词汇。\n- **布尔查询**：组合多个查询条件。\n- **范围查询**：查找特定范围内的记录。\n- **通配符查询**：模糊匹配。\n- **短语查询**：精确匹配整个短语。\n\n同时，`profile` 参数可以帮助分析查询性能，优化查询响应。\n\n\n3.8-RequestBody与QueryDSL简介\n\n以下是您提供的 Elasticsearch 查询操作，包括分页、日期排序、源过滤、脚本字段、以及不同的查询类型（如 `match`、`match_phrase`）。这些操作展示了如何在 Elasticsearch 中进行更精细的查询和数据处理。\n\n### 1. **忽略不存在的索引（`ignore_unavailable=true`）**\n在查询时，如果访问的索引不存在，使用 `ignore_unavailable=true` 可以避免报错：\n```bash\nPOST /movies,404_idx/_search?ignore_unavailable=true\n{\n  \"profile\": true,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`ignore_unavailable=true`**：在访问不存在的索引时，忽略错误。\n\n### 2. **分页查询**\n查询 `kibana_sample_data_ecommerce` 索引并分页返回数据（从第 10 条开始，返回 20 条记录）：\n```bash\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"from\": 10,\n  \"size\": 20,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`from=10`** 和 **`size=20`**：分页，跳过前 10 条，返回接下来的 20 条。\n\n### 3. **日期排序**\n按 `order_date` 字段降序排序：\n```bash\nPOST kibana_sample_data_ecommerce/_search\n{\n  \"sort\": [{\"order_date\": \"desc\"}],\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`sort`**：按照 `order_date` 字段降序排序。\n\n### 4. **源过滤**\n只返回文档中的 `order_date` 字段，不返回其他字段：\n```bash\nPOST kibana_sample_data_ecommerce/_search\n{\n  \"_source\": [\"order_date\"],\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`_source`**：指定只返回 `order_date` 字段的数据。\n\n### 5. **脚本字段**\n使用脚本字段计算新的字段（例如，拼接 `order_date` 和 `\"hello\"`）：\n```bash\nGET kibana_sample_data_ecommerce/_search\n{\n  \"script_fields\": {\n    \"new_field\": {\n      \"script\": {\n        \"lang\": \"painless\",\n        \"source\": \"doc['order_date'].value+'hello'\"\n      }\n    }\n  },\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`script_fields`**：使用 `painless` 脚本创建新的字段 `new_field`，将 `order_date` 字段与字符串 `\"hello\"` 拼接。\n\n### 6. **`match` 查询**\n查询 `movies` 索引中 `title` 字段包含 `\"last christmas\"` 的记录：\n```bash\nPOST movies/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"last christmas\"\n    }\n  }\n}\n```\n- **`match`**：进行标准的全文匹配查询。\n\n### 7. **`match` 查询并使用 AND 操作符**\n查询 `title` 包含 `\"last christmas\"` 且两个词都必须出现的记录（使用 AND 操作符）：\n```bash\nPOST movies/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"last christmas\",\n        \"operator\": \"and\"\n      }\n    }\n  }\n}\n```\n- **`operator: \"and\"`**：两个词必须同时出现在字段中。\n\n### 8. **`match_phrase` 查询（短语匹配）**\n查询 `title` 字段精确匹配 `\"one love\"` 作为一个短语：\n```bash\nPOST movies/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"title\": {\n        \"query\": \"one love\"\n      }\n    }\n  }\n}\n```\n- **`match_phrase`**：精确匹配整个短语，必须按照指定的顺序。\n\n### 9. **`match_phrase` 查询并使用 `slop`**\n查询 `title` 字段中的短语 `\"one love\"`，并允许 1 个词语的偏移（即词语可以有一定的顺序变化）：\n```bash\nPOST movies/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"title\": {\n        \"query\": \"one love\",\n        \"slop\": 1\n      }\n    }\n  }\n}\n```\n- **`slop: 1`**：允许最多 1 个词语的顺序偏移（例如，`love one` 也可以匹配）。\n\n### 总结\n这些查询展示了 Elasticsearch 中常用的查询类型：\n- **分页查询**：使用 `from` 和 `size` 来实现分页。\n- **日期排序**：使用 `sort` 来对结果进行排序。\n- **源过滤**：通过 `_source` 限制返回的字段。\n- **脚本字段**：使用 `painless` 脚本来计算新字段。\n- **布尔操作符**：通过 `operator` 来定义 `match` 查询的逻辑。\n- **短语匹配和偏移**：通过 `match_phrase` 和 `slop` 来进行更灵活的查询。\n\n这些查询可以帮助你在 Elasticsearch 中实现复杂的搜索需求。\n\n[3.9-QueryString&SimpleQueryString查询]\n\n以下是您提供的 Elasticsearch 查询操作，涉及到 `query_string` 和 `simple_query_string` 查询的使用，以及如何通过不同的字段和操作符执行复杂查询。这里的查询包括布尔操作符、字段匹配、以及指定默认操作符等。\n\n### 1. **向索引添加文档**\n首先，向 `users` 索引添加两个用户文档：\n```bash\nPUT /users/_doc/1\n{\n  \"name\": \"Ruan Yiming\",\n  \"about\": \"java, golang, node, swift, elasticsearch\"\n}\n\nPUT /users/_doc/2\n{\n  \"name\": \"Li Yiming\",\n  \"about\": \"Hadoop\"\n}\n```\n\n### 2. **`query_string` 查询：查询名称中包含 \"Ruan\" 和 \"Yiming\" 的文档**\n使用 `query_string` 查询，指定默认字段为 `name`，查询条件为 `\"Ruan AND Yiming\"`：\n```bash\nPOST users/_search\n{\n  \"query\": {\n    \"query_string\": {\n      \"default_field\": \"name\",\n      \"query\": \"Ruan AND Yiming\"\n    }\n  }\n}\n```\n- **`query_string`**：用于执行复杂的查询，可以使用逻辑操作符（如 AND、OR）。\n\n### 3. **`query_string` 查询：多个字段和复杂查询**\n查询名称或简介字段包含 `\"Ruan AND Yiming\"` 或 `\"Java AND Elasticsearch\"` 的文档：\n```bash\nPOST users/_search\n{\n  \"query\": {\n    \"query_string\": {\n      \"fields\": [\"name\", \"about\"],\n      \"query\": \"(Ruan AND Yiming) OR (Java AND Elasticsearch)\"\n    }\n  }\n}\n```\n- **`fields`**：可以指定多个字段进行查询。\n- **`query`**：包含布尔操作符（如 AND、OR）。\n\n### 4. **`simple_query_string` 查询（默认操作符为 OR）**\n执行一个简单查询，默认操作符为 `OR`，查询 `name` 字段中包含 `\"Ruan\"` 或 `\"Yiming\"` 的文档：\n```bash\nPOST users/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Ruan AND Yiming\",\n      \"fields\": [\"name\"]\n    }\n  }\n}\n```\n- **`simple_query_string`**：适用于较简单的查询，避免了复杂的查询语法。\n\n### 5. **`simple_query_string` 查询（默认操作符为 AND）**\n查询 `name` 字段中包含 `\"Ruan\"` 且 `\"Yiming\"` 的文档，使用 `AND` 作为默认操作符：\n```bash\nPOST users/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Ruan Yiming\",\n      \"fields\": [\"name\"],\n      \"default_operator\": \"AND\"\n    }\n  }\n}\n```\n- **`default_operator`**：设置默认操作符（`AND` 或 `OR`）。在此示例中，`AND` 用于要求 `\"Ruan\"` 和 `\"Yiming\"` 必须同时出现在 `name` 字段中。\n\n### 6. **`query_string` 查询：查询电影标题包含 \"Beautiful\" 和 \"Mind\"**\n执行 `query_string` 查询，查询电影标题中包含 `\"Beautiful\"` 和 `\"Mind\"` 的文档：\n```bash\nGET /movies/_search\n{\n  \"profile\": true,\n  \"query\": {\n    \"query_string\": {\n      \"default_field\": \"title\",\n      \"query\": \"Beautiful AND Mind\"\n    }\n  }\n}\n```\n- **`query_string`**：执行复杂查询，可以使用布尔操作符（如 `AND`）。\n\n### 7. **`query_string` 查询：多个字段查询**\n查询电影的 `title` 或 `year` 字段包含 `\"2012\"` 的文档：\n```bash\nGET /movies/_search\n{\n  \"profile\": true,\n  \"query\": {\n    \"query_string\": {\n      \"fields\": [\"title\", \"year\"],\n      \"query\": \"2012\"\n    }\n  }\n}\n```\n- **`fields`**：指定多个字段进行查询，这里同时查询 `title` 和 `year` 字段。\n\n### 8. **`simple_query_string` 查询：使用 `+` 进行短语匹配**\n查询电影标题中包含 `\"Beautiful\"` 和 `\"mind\"` 的文档，使用 `+` 确保两个词都出现在查询中：\n```bash\nGET /movies/_search\n{\n  \"profile\": true,\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Beautiful +mind\",\n      \"fields\": [\"title\"]\n    }\n  }\n}\n```\n- **`+` 操作符**：用于强制要求某个词出现在查询结果中。\n\n---\n\n### 总结\n这些查询展示了如何在 Elasticsearch 中使用不同类型的查询：\n\n- **`query_string`** 查询：用于执行复杂的查询，可以包含多个字段、布尔操作符（AND、OR、NOT）以及通配符等。\n- **`simple_query_string`** 查询：比 `query_string` 更简单，适用于不需要复杂语法的查询，并且支持默认操作符的配置。\n- **字段查询**：可以针对多个字段同时查询，指定多个字段使用 `fields` 参数。\n- **布尔操作符**：如 `AND`、`OR`、`NOT`，控制查询的逻辑。\n\n这些查询方式非常适合处理复杂的检索需求。\n\n[3.10-DynamicMapping和常见字段类型]\n\n您的示例展示了如何在 Elasticsearch 中管理映射（Mapping）以及如何处理动态字段和映射更新。以下是总结和解释：\n\n### **映射和字段定义**\n\n映射在 Elasticsearch 中类似于关系数据库中的表结构定义，主要用于：\n- **定义字段的名称**：指定文档中的字段名。\n- **定义字段的类型**：比如文本（`text`）、关键字（`keyword`）、日期（`date`）等。\n- **定义倒排索引相关配置**：比如是否需要索引字段，以及字段的 `Analyzer` 配置。\n\n### **动态映射（Dynamic Mapping）**\n\n动态映射允许 Elasticsearch 根据新文档自动推断字段的类型。可以通过 `dynamic` 属性来配置动态行为：\n- **`true`**（默认）：允许新字段自动被索引和映射。\n- **`false`**：禁止自动创建新字段，但已存在字段可以继续使用。\n- **`strict`**：禁止任何新的字段。如果文档包含未定义的字段，将导致错误。\n\n### **操作演示**\n\n1. **写入文档并查看映射**\n    - 向 `mapping_test` 索引中添加一个文档，查看映射：\n   ```bash\n   PUT mapping_test/_doc/1\n   {\n     \"firstName\": \"Chan\",\n     \"lastName\": \"Jackie\",\n     \"loginDate\": \"2018-07-24T10:29:48.103Z\"\n   }\n\n   GET mapping_test/_mapping\n   ```\n\n2. **动态映射：推断字段类型**\n    - 新字段 `uid`, `isVip`, `age` 等被自动推断并加入映射：\n   ```bash\n   PUT mapping_test/_doc/1\n   {\n     \"uid\": \"123\",\n     \"isVip\": false,\n     \"isAdmin\": \"true\",\n     \"age\": 19,\n     \"height\": 180\n   }\n\n   GET mapping_test/_mapping\n   ```\n\n3. **新增字段（默认动态）**\n    - 如果动态映射为 `true`（默认），可以动态添加新的字段：\n   ```bash\n   PUT dynamic_mapping_test/_doc/1\n   {\n     \"newField\": \"someValue\"\n   }\n\n   POST dynamic_mapping_test/_search\n   {\n     \"query\": {\n       \"match\": {\n         \"newField\": \"someValue\"\n       }\n     }\n   }\n   ```\n\n4. **修改动态设置为 `false`**\n    - 修改 `dynamic` 设置为 `false`，禁止自动推断新字段：\n   ```bash\n   PUT dynamic_mapping_test/_mapping\n   {\n     \"dynamic\": false\n   }\n\n   PUT dynamic_mapping_test/_doc/10\n   {\n     \"anotherField\": \"someValue\"\n   }\n\n   POST dynamic_mapping_test/_search\n   {\n     \"query\": {\n       \"match\": {\n         \"anotherField\": \"someValue\"\n       }\n     }\n   }\n   ```\n\n   在此示例中，`anotherField` 将不会被索引或搜索，因为动态映射已设置为 `false`。\n\n5. **修改为 `strict` 模式**\n    - 如果将 `dynamic` 设置为 `strict`，任何新的字段都会导致错误：\n   ```bash\n   PUT dynamic_mapping_test/_mapping\n   {\n     \"dynamic\": \"strict\"\n   }\n\n   PUT dynamic_mapping_test/_doc/12\n   {\n     \"lastField\": \"value\"\n   }\n   ```\n   此时，写入新字段 `lastField` 会导致错误，HTTP 返回 `400` 错误码。\n\n6. **删除索引**\n    - 删除索引：\n   ```bash\n   DELETE dynamic_mapping_test\n   ```\n\n### **总结**\n\n- **动态映射（Dynamic Mapping）**：允许 Elasticsearch 自动推断并添加新的字段，方便快速处理未知数据。\n- **`dynamic` 配置**：控制是否允许 Elasticsearch 自动映射新字段：\n    - `true`：默认允许动态字段；\n    - `false`：禁止自动映射新字段；\n    - `strict`：禁止所有未知字段，如果有未定义字段则会报错。\n- **更改映射**：映射一旦建立后不能直接修改字段类型，要修改字段配置或添加新字段需要使用 `reindex` 操作。\n\n这些操作有助于管理索引和字段的生命周期，确保数据能够根据业务需求灵活适应。\n\n\n您的示例展示了 Elasticsearch 中显式设置映射（Mapping）的一些常见操作和参数。以下是各个设置项的详细介绍和使用案例。\n\n### **1. `index: false` 设置**\n通过设置字段的 `index: false`，可以阻止某些字段被索引。这样可以避免该字段参与倒排索引，也不会进行搜索。\n\n**示例**:\n```bash\nDELETE users\nPUT users\n{\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\"\n        },\n        \"lastName\" : {\n          \"type\" : \"text\"\n        },\n        \"mobile\" : {\n          \"type\" : \"text\",\n          \"index\": false  # 禁止索引该字段\n        }\n      }\n    }\n}\n\nPUT users/_doc/1\n{\n  \"firstName\": \"Ruan\",\n  \"lastName\": \"Yiming\",\n  \"mobile\": \"12345678\"\n}\n\nPOST /users/_search\n{\n  \"query\": {\n    \"match\": {\n      \"mobile\": \"12345678\"  # 搜索时不会命中mobile字段\n    }\n  }\n}\n```\n在上面的示例中，`mobile` 字段被设置为 `index: false`，因此无法用于搜索查询。\n\n### **2. `null_value` 设置**\n通过设置 `null_value`，可以在文档中存储 `null` 值，并用指定的替代值替换 `null`。这对于查询时需要处理 `null` 数据特别有用。\n\n**示例**:\n```bash\nDELETE users\nPUT users\n{\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\"\n        },\n        \"lastName\" : {\n          \"type\" : \"text\"\n        },\n        \"mobile\" : {\n          \"type\" : \"keyword\",\n          \"null_value\": \"NULL\"  # null值替代为\"NULL\"\n        }\n      }\n    }\n}\n\nPUT users/_doc/1\n{\n  \"firstName\": \"Ruan\",\n  \"lastName\": \"Yiming\",\n  \"mobile\": null  # 实际值是null\n}\n\nPUT users/_doc/2\n{\n  \"firstName\": \"Ruan2\",\n  \"lastName\": \"Yiming2\"  # 没有mobile字段\n}\n\nGET users/_search\n{\n  \"query\": {\n    \"match\": {\n      \"mobile\": \"NULL\"  # 搜索时会匹配到null值字段\n    }\n  }\n}\n```\n此设置可以确保查询时用 `NULL` 代替存储的 `null` 值。\n\n### **3. `copy_to` 设置**\n`copy_to` 可以将多个字段的内容复制到另一个字段，方便进行联合查询或索引。\n\n**示例**:\n```bash\nDELETE users\nPUT users\n{\n  \"mappings\": {\n    \"properties\": {\n      \"firstName\": {\n        \"type\": \"text\",\n        \"copy_to\": \"fullName\"  # 将firstName复制到fullName字段\n      },\n      \"lastName\": {\n        \"type\": \"text\",\n        \"copy_to\": \"fullName\"  # 将lastName复制到fullName字段\n      }\n    }\n  }\n}\n\nPUT users/_doc/1\n{\n  \"firstName\": \"Ruan\",\n  \"lastName\": \"Yiming\"\n}\n\nGET users/_search?q=fullName:(Ruan Yiming)\n\nPOST users/_search\n{\n  \"query\": {\n    \"match\": {\n      \"fullName\": {\n        \"query\": \"Ruan Yiming\",\n        \"operator\": \"and\"  # 联合查询fullName字段\n      }\n    }\n  }\n}\n```\n这里，`firstName` 和 `lastName` 字段的内容会被复制到 `fullName` 字段，从而使得查询变得更加方便。\n\n### **4. 数组类型处理**\nElasticsearch 支持数组字段。数组中的每个元素会被视为一个单独的值，这对于多值字段非常有用。\n\n**示例**:\n```bash\nPUT users/_doc/1\n{\n  \"name\": \"onebird\",\n  \"interests\": \"reading\"  # 字段为单一值\n}\n\nPUT users/_doc/2\n{\n  \"name\": \"twobirds\",\n  \"interests\": [\"reading\", \"music\"]  # 字段为数组\n}\n\nPOST users/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\nGET users/_mapping\n```\n在此示例中，`interests` 字段既可以是单个值也可以是数组，Elasticsearch 会将每个数组元素视为独立的值进行索引。\n\n---\n\n### **总结常见的 Mapping 参数**\n\n- **`type`**: 字段的数据类型，如 `text`, `keyword`, `date` 等。\n- **`index`**: 控制是否索引该字段，`false` 表示不索引，默认为 `true`。\n- **`null_value`**: 控制 `null` 值的替代值。可以设置为任何替代值，如 `\"NULL\"`。\n- **`copy_to`**: 将多个字段的内容复制到一个目标字段中，便于联合查询。\n- **`dynamic`**: 控制动态映射，`true` 表示允许自动推断新字段，`false` 表示禁止新字段自动映射，`strict` 则表示严格模式下不允许任何新字段。\n\n通过这些映射设置，可以更好地控制数据如何存储和索引，以及如何在查询时处理和优化字段。\n\n\n您的示例展示了 Elasticsearch 中关于多字段特性以及自定义分析器（Analyzer）的配置。以下是对各个分析器和相关配置的详细解释。\n\n### **1. 自定义 Analyzer 和 Char Filter**\nElasticsearch 提供了灵活的机制来配置分词器（Tokenizer）和字符过滤器（Char Filter）。这些配置用于在索引和搜索过程中控制文本的处理方式。\n\n#### **自定义 Tokenizer 和 Char Filter 示例**\n- **Keyword Tokenizer**: `keyword` tokenizer 将整个文本当作一个单独的 token 进行处理。\n- **HTML Strip Char Filter**: `html_strip` char filter 用于从文本中去除 HTML 标签。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"keyword\",  # 使用关键词分词器\n  \"char_filter\": [\"html_strip\"],  # 使用html_strip字符过滤器\n  \"text\": \"<b>hello world</b>\"  # 输入带有HTML标签的文本\n}\n```\n输出将会是：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"hello world\",\n      \"start_offset\": 3,\n      \"end_offset\": 15,\n      \"type\": \"word\",\n      \"position\": 0\n    }\n  ]\n}\n```\n此配置移除了文本中的 `<b></b>` HTML 标签，只保留了纯文本 \"hello world\"。\n\n#### **Path Hierarchy Tokenizer**\n`path_hierarchy` tokenizer 用于处理文件路径等层级结构的数据，将路径按分隔符（如 `/`）切割。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"path_hierarchy\",  # 使用路径层级分词器\n  \"text\": \"/user/ymruan/a/b/c/d/e\"\n}\n```\n输出会将路径按 `/` 切分：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"/user/ymruan/a/b/c/d/e\",\n      \"start_offset\": 0,\n      \"end_offset\": 21,\n      \"type\": \"word\",\n      \"position\": 0\n    },\n    {\n      \"token\": \"/user/ymruan/a/b/c/d\",\n      \"start_offset\": 0,\n      \"end_offset\": 16,\n      \"type\": \"word\",\n      \"position\": 1\n    },\n    ...\n  ]\n}\n```\n\n### **2. Char Filter 替换符号**\n字符过滤器可以用于替换文本中的特定符号或字符。例如，使用 `mapping` 类型的 `char_filter`，可以替换文本中的字符（如将 `-` 替换为 `_`）。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",  # 使用标准分词器\n  \"char_filter\": [\n    {\n      \"type\": \"mapping\",  # 使用字符映射过滤器\n      \"mappings\": [\"- => _\"]\n    }\n  ],\n  \"text\": \"123-456, I-test! test-990 650-555-1234\"\n}\n```\n此配置将文本中的 `-` 替换为 `_`，输出将是：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"123_456\",\n      \"start_offset\": 0,\n      \"end_offset\": 7,\n      \"type\": \"word\",\n      \"position\": 0\n    },\n    ...\n  ]\n}\n```\n\n### **3. Char Filter 替换表情符号**\n你还可以使用字符过滤器将表情符号替换为特定的文本（如将 `:)` 替换为 `happy`，`:(` 替换为 `sad`）。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n    {\n      \"type\": \"mapping\",\n      \"mappings\": [\":) => happy\", \":( => sad\"]\n    }\n  ],\n  \"text\": [\"I am felling :)\", \"Feeling :( today\"]\n}\n```\n输出：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"I\",\n      \"start_offset\": 0,\n      \"end_offset\": 1,\n      \"type\": \"word\",\n      \"position\": 0\n    },\n    {\n      \"token\": \"am\",\n      \"start_offset\": 2,\n      \"end_offset\": 4,\n      \"type\": \"word\",\n      \"position\": 1\n    },\n    {\n      \"token\": \"felling\",\n      \"start_offset\": 5,\n      \"end_offset\": 12,\n      \"type\": \"word\",\n      \"position\": 2\n    },\n    {\n      \"token\": \"happy\",  # 替换表情符号:) 为 happy\n      \"start_offset\": 13,\n      \"end_offset\": 18,\n      \"type\": \"word\",\n      \"position\": 3\n    }\n  ]\n}\n```\n\n### **4. 使用 Stop 和 Snowball 过滤器**\n使用 `stop` 过滤器来删除常见的停用词，使用 `snowball` 过滤器进行词干提取（如将 \"playing\" 转换为 \"play\"）。\n\n```bash\nGET _analyze\n{\n  \"tokenizer\": \"whitespace\",  # 使用空格分词器\n  \"filter\": [\"stop\", \"snowball\"],  # 使用停用词和词干提取\n  \"text\": [\"The girls in China are playing this game!\"]\n}\n```\n输出：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"girl\",\n      \"start_offset\": 4,\n      \"end_offset\": 9,\n      \"type\": \"word\",\n      \"position\": 0\n    },\n    {\n      \"token\": \"china\",\n      \"start_offset\": 14,\n      \"end_offset\": 19,\n      \"type\": \"word\",\n      \"position\": 1\n    },\n    ...\n  ]\n}\n```\n\n### **5. 正则表达式替换**\n通过 `pattern_replace` 字符过滤器，您可以根据正则表达式来替换文本中的特定部分。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n    {\n      \"type\": \"pattern_replace\",\n      \"pattern\": \"http://(.*)\",\n      \"replacement\": \"$1\"\n    }\n  ],\n  \"text\": \"http://www.elastic.co\"\n}\n```\n此配置将 `http://` 替换为一个空字符串，结果为：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"www.elastic.co\",\n      \"start_offset\": 7,\n      \"end_offset\": 23,\n      \"type\": \"word\",\n      \"position\": 0\n    }\n  ]\n}\n```\n\n### **总结：**\n- **Tokenizer**: 负责将输入文本切割成词条（token）。如 `keyword`, `standard`, `path_hierarchy`。\n- **Char Filter**: 处理文本中的字符替换、去除特殊符号或HTML标签等，如 `html_strip`, `mapping`, `pattern_replace`。\n- **Filter**: 用于文本处理，如去除停用词（`stop`）或词干提取（`snowball`）。\n\n这些工具的组合允许您灵活地处理和分析文本数据，并针对特定的业务需求优化索引和搜索行为。\n\n在 Elasticsearch 中，**Index Templates** 和 **Dynamic Templates** 是两种强大的工具，用于控制如何定义和管理索引的映射和设置。以下是这两者的详细解释和示例。\n\n### **1. Index Templates (索引模板)**\n\n**Index Templates** 是一种配置模板，用于为匹配特定模式的索引自动配置设置、映射和其他配置。当创建一个新索引时，如果该索引匹配模板中的 `index_patterns` 配置，模板中的设置、映射和其他配置就会自动应用到新索引上。\n\n#### **创建默认模板**\n下面是创建一个默认模板的示例：\n```bash\nPUT _template/template_default\n{\n  \"index_patterns\": [\"*\"],  # 匹配所有索引\n  \"order\": 0,\n  \"version\": 1,\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 1\n  }\n}\n```\n这会为所有索引设置一个模板，其中包含分片数量为1、副本数量为1。\n\n#### **为特定模式创建模板**\n另一个例子是为 `test*` 开头的索引创建模板：\n```bash\nPUT /_template/template_test\n{\n  \"index_patterns\": [\"test*\"],  # 匹配所有以test开头的索引\n  \"order\": 1,\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 2\n  },\n  \"mappings\": {\n    \"date_detection\": false,  # 禁止自动检测日期字段\n    \"numeric_detection\": true  # 自动检测数字字段\n  }\n}\n```\n\n#### **查看模板**\n你可以查看已定义的模板：\n```bash\nGET /_template/template_default\nGET /_template/temp*  # 查看所有模板\n```\n\n#### **删除模板**\n删除模板的命令如下：\n```bash\nDELETE /_template/template_default\nDELETE /_template/template_test\n```\n\n---\n\n### **2. Dynamic Templates (动态模板)**\n\n**Dynamic Templates** 用于在创建索引时自动匹配字段类型和名称，根据这些动态模板来生成字段的映射规则。可以根据字段的类型（例如字符串、数字）和字段名称（例如以某些字符开头的字段）来定义映射。\n\n#### **自动映射数字字符串和日期字符串**\n例如，数字字符串会被映射为 `text` 类型，日期字符串会被映射为日期类型：\n```bash\nPUT ttemplate/_doc/1\n{\n  \"someNumber\": \"1\",        # 字符串数字\n  \"someDate\": \"2019/01/01\"  # 字符串日期\n}\nGET ttemplate/_mapping\n```\n在这个例子中，`someNumber` 会被映射成 `text` 类型，而 `someDate` 会被映射成 `date` 类型。\n\n#### **定义动态模板映射规则**\n使用 `dynamic_templates` 可以根据字段类型和名称定义映射。例如，以下动态模板将以 `is*` 开头的字符串字段映射为 `boolean` 类型，其他字符串字段映射为 `keyword` 类型：\n```bash\nDELETE my_index\n\nPUT my_index\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"strings_as_boolean\": {\n          \"match_mapping_type\": \"string\",   # 匹配所有字符串类型\n          \"match\": \"is*\",  # 字段名称以is开头\n          \"mapping\": {\n            \"type\": \"boolean\"\n          }\n        }\n      },\n      {\n        \"strings_as_keywords\": {\n          \"match_mapping_type\": \"string\",   # 匹配所有字符串类型\n          \"mapping\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    ]\n  }\n}\n```\n在这个示例中，`isVIP` 字段会被映射为 `boolean` 类型，而其他字符串类型的字段则会被映射为 `keyword` 类型。\n\n#### **结合路径匹配**\n动态模板不仅可以基于字段名称，还可以基于字段的路径。例如，以下模板会将 `name.*` 路径下的所有字段映射为 `text` 类型，并将这些字段复制到 `full_name` 字段中：\n```bash\nPUT my_index\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"full_name\": {\n          \"path_match\": \"name.*\",  # 匹配name下的所有字段\n          \"path_unmatch\": \"*.middle\",  # 排除middle字段\n          \"mapping\": {\n            \"type\": \"text\",\n            \"copy_to\": \"full_name\"  # 将值复制到full_name字段\n          }\n        }\n      }\n    ]\n  }\n}\n```\n然后，插入以下数据：\n```bash\nPUT my_index/_doc/1\n{\n  \"name\": {\n    \"first\": \"John\",\n    \"middle\": \"Winston\",\n    \"last\": \"Lennon\"\n  }\n}\n```\n\n在这个例子中，`first` 和 `last` 字段将被映射为 `text` 类型，并且它们的内容会被复制到 `full_name` 字段中。\n\n#### **搜索字段**\n可以通过 `full_name` 字段来搜索：\n```bash\nGET my_index/_search?q=full_name:John\n```\n\n---\n\n### **总结：**\n- **Index Templates** 是为匹配特定索引模式（`index_patterns`）的所有索引自动配置设置和映射的模板。\n- **Dynamic Templates** 用于根据字段类型和字段名称自动映射索引字段。你可以根据字段类型（如 `string`）或字段路径（如 `name.*`）来定义映射规则。\n\n这些配置使得索引的创建和管理更加灵活，可以根据实际数据自动推断和调整映射，从而提高了 Elasticsearch 的可用性和效率。\n\n\n\nElasticsearch 提供了强大的 **聚合** 功能，用于对数据进行汇总和分析。聚合是 Elasticsearch 搜索的一个核心功能，允许你通过多种方式对数据进行分组、统计、求最大/最小值、计算平均值等操作。以下是一些常见的聚合分析操作和示例：\n\n### **1. 基本的聚合分析：按目的地分桶统计**\n在这个示例中，我们按航班的目的地（`DestCountry`）进行分桶统计，查看每个目的地的航班数量：\n```bash\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,  # 不返回实际的文档数据，只返回聚合结果\n  \"aggs\": {\n    \"flight_dest\": {\n      \"terms\": {\n        \"field\": \"DestCountry\"  # 按目的地国家分桶\n      }\n    }\n  }\n}\n```\n在这个聚合查询中，`terms` 聚合用于对 `DestCountry` 字段的值进行分桶，返回每个目的地国家的航班数量。\n\n### **2. 增加更多统计：平均、最大、最小价格**\n你可以在分桶内部添加更多聚合来获取其他统计信息，如每个目的地的平均票价、最高票价和最低票价：\n```bash\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"flight_dest\": {\n      \"terms\": {\n        \"field\": \"DestCountry\"\n      },\n      \"aggs\": {\n        \"avg_price\": {\n          \"avg\": {\n            \"field\": \"AvgTicketPrice\"  # 计算平均票价\n          }\n        },\n        \"max_price\": {\n          \"max\": {\n            \"field\": \"AvgTicketPrice\"  # 计算最高票价\n          }\n        },\n        \"min_price\": {\n          \"min\": {\n            \"field\": \"AvgTicketPrice\"  # 计算最低票价\n          }\n        }\n      }\n    }\n  }\n}\n```\n在这个查询中，我们为每个目的地添加了三个聚合：`avg_price`、`max_price` 和 `min_price`，分别计算每个目的地的平均票价、最大票价和最小票价。\n\n### **3. 聚合价格与天气信息：统计与多重聚合**\n如果你还想结合天气信息（如 `DestWeather` 字段）与航班价格统计一起进行聚合，可以使用嵌套聚合：\n```bash\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"flight_dest\": {\n      \"terms\": {\n        \"field\": \"DestCountry\"\n      },\n      \"aggs\": {\n        \"stats_price\": {\n          \"stats\": {\n            \"field\": \"AvgTicketPrice\"  # 计算票价的多项统计信息\n          }\n        },\n        \"weather\": {\n          \"terms\": {\n            \"field\": \"DestWeather\",  # 按天气类型分桶\n            \"size\": 5  # 只返回前5个天气类型\n          }\n        }\n      }\n    }\n  }\n}\n```\n在这个示例中，我们不仅计算了每个目的地的票价统计信息（如平均票价、最大票价等），还将天气信息作为另一个 `terms` 聚合，显示每个目的地的天气类型，并限制返回的天气类型数量为 5 个。\n\n---\n\n### **常见的聚合类型：**\n- **`terms` 聚合**：将文档按某个字段的值进行分桶，常用于统计词频或其他分类数据。\n- **`avg` 聚合**：计算某个数值字段的平均值。\n- **`sum` 聚合**：计算某个数值字段的总和。\n- **`min` 聚合**：返回某个数值字段的最小值。\n- **`max` 聚合**：返回某个数值字段的最大值。\n- **`stats` 聚合**：返回字段的统计信息（包括：最小值、最大值、平均值、总和和文档数量）。\n- **`date_histogram` 聚合**：按日期进行分桶，适用于时间序列数据。\n- **`histogram` 聚合**：按数值区间进行分桶，常用于数值数据的统计。\n\n---\n\n### **相关阅读：**\n- [Elasticsearch 聚合文档](https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations.html) 详细介绍了各种聚合的使用方式和示例。\n\n聚合功能非常强大，能帮助你从海量数据中提取有价值的信息，适用于各种数据分析场景。\n\n\n","source":"_posts/elasticsearch/es常用命令.md","raw":"---\ntitle: es常用命令\ndate: 2025-02-27 15:00:37\ncategories: elasticsearch\ntag: 学习笔记\n---\n\n以下是 Elasticsearch (ES) 常用命令的总结和笔记：\n\n### 1. 查看索引相关信息\n\n- **查看指定索引的映射信息**\n  ```bash\n  GET kibana_sample_data_ecommerce\n  ```\n\n- **查看指定索引的文档总数**\n  ```bash\n  GET kibana_sample_data_ecommerce/_count\n  ```\n\n- **查看前10条文档**\n  ```bash\n  POST kibana_sample_data_ecommerce/_search\n  {\n  }\n  ```\n\n### 2. 查看索引状态与信息\n\n- **查看索引信息**\n  ```bash\n  GET /_cat/indices/kibana*?v&s=index\n  ```\n\n- **查看状态为绿的索引**\n  ```bash\n  GET /_cat/indices?v&health=green\n  ```\n\n- **按文档个数排序查看索引**\n  ```bash\n  GET /_cat/indices?v&s=docs.count:desc\n  ```\n\n- **查看具体的索引字段（健康、主分片、复制分片、文档数等）**\n  ```bash\n  GET /_cat/indices/kibana*?pri&v&h=health,index,pri,rep,docs.count,mt\n  ```\n\n- **查看每个索引使用的内存量**\n  ```bash\n  GET /_cat/indices?v&h=i,tm&s=tm:desc\n  ```\n\n### 3. 查看节点信息\n\n- **查看所有节点信息**\n  ```bash\n  GET _cat/nodes?v\n  ```\n\n- **查看特定节点信息**\n  ```bash\n  GET /_nodes/es7_01,es7_02\n  ```\n\n- **查看节点信息并显示特定字段**\n  ```bash\n  GET /_cat/nodes?v&h=id,ip,port,v,m\n  ```\n\n### 4. 查看集群健康状况\n\n- **查看集群健康状况**\n  ```bash\n  GET _cluster/health\n  ```\n\n- **查看集群健康状况，并按分片级别显示**\n  ```bash\n  GET _cluster/health?level=shards\n  ```\n\n- **查看特定索引的集群健康状况**\n  ```bash\n  GET /_cluster/health/kibana_sample_data_ecommerce,kibana_sample_data_flights\n  ```\n\n- **查看特定索引的集群健康状况，并按分片级别显示**\n  ```bash\n  GET /_cluster/health/kibana_sample_data_flights?level=shards\n  ```\n\n### 5. 查看集群状态\n\n- **查看集群状态**\n  ```bash\n  GET /_cluster/state\n  ```\n\n### 6. 查看集群设置\n\n- **查看集群设置**\n  ```bash\n  GET /_cluster/settings\n  ```\n\n- **查看集群设置，包括默认设置**\n  ```bash\n  GET /_cluster/settings?include_defaults=true\n  ```\n\n### 7. 查看分片信息\n\n- **查看集群的所有分片信息**\n  ```bash\n  GET /_cat/shards\n  ```\n\n- **查看特定的分片信息（包括状态、主分片/副本分片等）**\n  ```bash\n  GET /_cat/shards?h=index,shard,prirep,state,unassigned.reason\n  ```\n\n\n\n### 1. 创建文档\n\n- **自动生成 `_id` 创建文档**\n  ```bash\n  POST users/_doc\n  {\n    \"user\" : \"Mike\",\n    \"post_date\" : \"2019-04-15T14:12:12\",\n    \"message\" : \"trying out Kibana\"\n  }\n  ```\n\n- **指定 ID 创建文档（如果 ID 已存在则报错）**\n  ```bash\n  PUT users/_doc/1?op_type=create\n  {\n    \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n  }\n  ```\n\n- **指定 ID 创建文档（如果 ID 已存在则报错）**\n  ```bash\n  PUT users/_create/1\n  {\n    \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n  }\n  ```\n\n### 2. 根据 ID 获取文档\n\n- **获取指定 ID 的文档**\n  ```bash\n  GET users/_doc/1\n  ```\n\n### 3. 更新文档\n\n- **更新指定 ID 的文档（先删除再写入）**\n  ```bash\n  PUT users/_doc/1\n  {\n    \"user\" : \"Mike\"\n  }\n  ```\n\n- **在原文档上增加字段**\n  ```bash\n  POST users/_update/1/\n  {\n    \"doc\": {\n      \"post_date\" : \"2019-05-15T14:12:12\",\n      \"message\" : \"trying out Elasticsearch\"\n    }\n  }\n  ```\n\n### 4. 删除文档\n\n- **根据 ID 删除文档**\n  ```bash\n  DELETE users/_doc/1\n  ```\n\n### 5. 批量操作 (Bulk API)\n\n- **执行批量操作**  \n  第一次执行批量操作：\n  ```bash\n  POST _bulk\n  { \"index\" : { \"_index\" : \"test\", \"_id\" : \"1\" } }\n  { \"field1\" : \"value1\" }\n  { \"delete\" : { \"_index\" : \"test\", \"_id\" : \"2\" } }\n  { \"create\" : { \"_index\" : \"test2\", \"_id\" : \"3\" } }\n  { \"field1\" : \"value3\" }\n  { \"update\" : {\"_id\" : \"1\", \"_index\" : \"test\"} }\n  { \"doc\" : {\"field2\" : \"value2\"} }\n  ```\n\n  第二次执行批量操作：\n  ```bash\n  POST _bulk\n  { \"index\" : { \"_index\" : \"test\", \"_id\" : \"1\" } }\n  { \"field1\" : \"value1\" }\n  { \"delete\" : { \"_index\" : \"test\", \"_id\" : \"2\" } }\n  { \"create\" : { \"_index\" : \"test2\", \"_id\" : \"3\" } }\n  { \"field1\" : \"value3\" }\n  { \"update\" : {\"_id\" : \"1\", \"_index\" : \"test\"} }\n  { \"doc\" : {\"field2\" : \"value2\"} }\n  ```\n\n### 6. 多文档获取 (MGET)\n\n- **获取多个文档**\n  ```bash\n  GET /_mget\n  {\n    \"docs\" : [\n      { \"_index\" : \"test\", \"_id\" : \"1\" },\n      { \"_index\" : \"test\", \"_id\" : \"2\" }\n    ]\n  }\n  ```\n\n- **URI中指定索引**\n  ```bash\n  GET /test/_mget\n  {\n    \"docs\" : [\n      { \"_id\" : \"1\" },\n      { \"_id\" : \"2\" }\n    ]\n  }\n  ```\n\n- **使用 `_source` 参数指定返回的字段**\n  ```bash\n  GET /_mget\n  {\n    \"docs\" : [\n      { \"_index\" : \"test\", \"_id\" : \"1\", \"_source\" : false },\n      { \"_index\" : \"test\", \"_id\" : \"2\", \"_source\" : [\"field3\", \"field4\"] },\n      { \"_index\" : \"test\", \"_id\" : \"3\", \"_source\" : { \"include\": [\"user\"], \"exclude\": [\"user.location\"] } }\n    ]\n  }\n  ```\n\n### 7. 多查询操作 (MSEARCH)\n\n- **执行多个查询**\n  ```bash\n  POST kibana_sample_data_ecommerce/_msearch\n  {}\n  {\"query\" : {\"match_all\" : {}},\"size\":1}\n  {\"index\" : \"kibana_sample_data_flights\"}\n  {\"query\" : {\"match_all\" : {}},\"size\":2}\n  ```\n\n### 8. 清除测试数据\n\n- **删除索引（清除数据）**\n  ```bash\n  DELETE users\n  DELETE test\n  DELETE test2\n  ```\n\n[3.4-倒排索引入门]\n\nElasticsearch 的 `_analyze` API，它用于分析文本，查看在特定分析器下，文本是如何被分词和处理的。下面是每个请求的说明：\n\n### 1. **分析 \"Mastering Elasticsearch\"**\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Mastering Elasticsearch\"\n}\n```\n- **分析器**：使用默认的 `standard` 分析器。\n- **文本**：`\"Mastering Elasticsearch\"`。\n- **预期效果**：`standard` 分析器会将这段文本分割成单词，通常会根据空格和标点符号进行分词。\n\n### 2. **分析 \"Elasticsearch Server\"**\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Elasticsearch Server\"\n}\n```\n- **分析器**：同样使用 `standard` 分析器。\n- **文本**：`\"Elasticsearch Server\"`。\n- **预期效果**：分析器会分割文本为单词，可能会得到类似于 `[\"elasticsearch\", \"server\"]` 的分词结果。\n\n### 3. **分析 \"Elasticsearch Essentials\"**\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Elasticsearch Essentials\"\n}\n```\n- **分析器**：继续使用 `standard` 分析器。\n- **文本**：`\"Elasticsearch Essentials\"`。\n- **预期效果**：分析器会将文本分割成 `[\"elasticsearch\", \"essentials\"]`。\n\n### 结果\n每个请求的结果将显示由 `standard` 分析器生成的分词结果。通常，`standard` 分析器会去除大部分标点符号并将文本转换为小写。分词的具体结果如下：\n\n- `\"Mastering Elasticsearch\"` -> `[\"mastering\", \"elasticsearch\"]`\n- `\"Elasticsearch Server\"` -> `[\"elasticsearch\", \"server\"]`\n- `\"Elasticsearch Essentials\"` -> `[\"elasticsearch\", \"essentials\"]`\n\n\n以下是使用不同的分析器（Analyzer）对文本进行分词分析的示例：\n\n### 1. **Standard Analyzer**\n标准分析器会根据空格、标点符号等进行分词，并将所有文本转换为小写。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n\n{\n  \"tokens\" : [\n    {\n      \"token\" : \"2\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 1,\n      \"type\" : \"<NUM>\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"running\",\n      \"start_offset\" : 2,\n      \"end_offset\" : 9,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"quick\",\n      \"start_offset\" : 10,\n      \"end_offset\" : 15,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"brown\",\n      \"start_offset\" : 16,\n      \"end_offset\" : 21,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 3\n    },\n    {\n      \"token\" : \"foxes\",\n      \"start_offset\" : 22,\n      \"end_offset\" : 27,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 4\n    },\n    {\n      \"token\" : \"leap\",\n      \"start_offset\" : 28,\n      \"end_offset\" : 32,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 5\n    },\n    {\n      \"token\" : \"over\",\n      \"start_offset\" : 33,\n      \"end_offset\" : 37,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 6\n    },\n    {\n      \"token\" : \"lazy\",\n      \"start_offset\" : 38,\n      \"end_offset\" : 42,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 7\n    },\n    {\n      \"token\" : \"dogs\",\n      \"start_offset\" : 43,\n      \"end_offset\" : 47,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 8\n    },\n    {\n      \"token\" : \"in\",\n      \"start_offset\" : 48,\n      \"end_offset\" : 50,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 9\n    },\n    {\n      \"token\" : \"the\",\n      \"start_offset\" : 51,\n      \"end_offset\" : 54,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 10\n    },\n    {\n      \"token\" : \"summer\",\n      \"start_offset\" : 55,\n      \"end_offset\" : 61,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 11\n    },\n    {\n      \"token\" : \"evening\",\n      \"start_offset\" : 62,\n      \"end_offset\" : 69,\n      \"type\" : \"<ALPHANUM>\",\n      \"position\" : 12\n    }\n  ]\n}\n\n```\n- **分词结果**：`[\"2\", \"running\", \"quick\", \"brown\", \"foxes\", \"leap\", \"over\", \"lazy\", \"dogs\", \"in\", \"the\", \"summer\", \"evening\"]`\n\n\n### 2. **Simple Analyzer**\n简单分析器按非字母字符切分，符号会被过滤，文本会转换为小写。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"simple\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"quick\", \"brown\", \"foxes\", \"leap\", \"over\", \"lazy\", \"dogs\", \"in\", \"the\", \"summer\", \"evening\"]`\n\n### 3. **Stop Analyzer**\n停用词分析器会将文本转换为小写，并过滤掉常见的停用词（如 \"the\", \"a\", \"is\"）。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"stop\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"quick\", \"brown\", \"foxes\", \"leap\", \"lazy\", \"dogs\", \"summer\", \"evening\"]`\n\n### 4. **Whitespace Analyzer**\n空格分析器会按空格切分文本，并且不会转换为小写。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"whitespace\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"Quick\", \"brown-foxes\", \"leap\", \"over\", \"lazy\", \"dogs\", \"in\", \"the\", \"summer\", \"evening.\"]`\n\n### 5. **Keyword Analyzer**\n关键字分析器不进行分词，直接返回原始文本。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"keyword\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"]`\n\n### 6. **Pattern Analyzer**\n模式分析器使用正则表达式进行分词，默认使用 `\\W+`（非字母字符）作为分隔符。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"pattern\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"Quick\", \"brown\", \"foxes\", \"leap\", \"over\", \"lazy\", \"dogs\", \"in\", \"the\", \"summer\", \"evening\"]`\n\n### 7. **English Analyzer**\n英语分析器针对英语语言进行分词，去除停用词等。\n```bash\nGET _analyze\n{\n  \"analyzer\": \"english\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n```\n- **分词结果**：`[\"2\", \"running\", \"quick\", \"brown\", \"foxes\", \"leap\", \"lazy\", \"dogs\", \"summer\", \"evening\"]`\n\n### 8. **ICU Analyzer for Chinese Text**\n使用 `icu_analyzer` 来处理中文文本，适用于多语言环境中的分词。\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"icu_analyzer\",\n  \"text\": \"他说的确实在理\"\n}\n```\n- **分词结果**：`[\"他说\", \"的\", \"确实\", \"在理\"]`\n\n### 9. **Standard Analyzer for Chinese Text**\n使用标准分析器处理中文文本，通常处理中文时可能不会像中文专用分析器那样精确。\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"他说的确实在理\"\n}\n```\n- **分词结果**：`[\"他说\", \"的\", \"确实\", \"在理\"]`\n\n### 10. **ICU Analyzer for Another Chinese Sentence**\n处理另一个中文句子 `\"这个苹果不大好吃\"`。\n```bash\nPOST _analyze\n{\n  \"analyzer\": \"icu_analyzer\",\n  \"text\": \"这个苹果不大好吃\"\n}\n```\n- **分词结果**：`[\"这个\", \"苹果\", \"不大\", \"好吃\"]`\n\n### 总结\n每种分析器具有不同的分词行为：\n- **Standard**：根据空格和标点符号分词并小写化。\n- **Simple**：过滤非字母字符并小写化。\n- **Stop**：去除停用词并小写化。\n- **Whitespace**：仅按空格分词，不进行大小写转换。\n- **Keyword**：不进行分词，返回整个文本。\n- **Pattern**：使用正则表达式分词，默认 `\\W+` 分割。\n- **English**：为英语文本设计的分析器，去除停用词。\n- **ICU Analyzer**：适合多语言的分词，特别适用于中文等非拉丁字母语言。\n\n这些分析器可以根据不同的语言和需求来优化索引和搜索。\n\n\n以下是您提供的一些 Elasticsearch 查询示例，涵盖了基本查询、带有分析的查询、布尔查询、范围查询、通配符查询、模糊查询等操作。下面是每种查询的详细解释和用法：\n\n### 1. **基本查询**\n查询 `movies` 索引中标题为 `2012` 的电影，并根据 `year` 字段降序排序，返回前 10 条结果：\n```bash\nGET /movies/_search?q=2012&df=title&sort=year:desc&from=0&size=10&timeout=1s\n```\n- **`q=2012`**：查询内容为 `2012`。\n- **`df=title`**：指定查询字段为 `title`。\n- **`sort=year:desc`**：按 `year` 字段降序排序。\n- **`from=0&size=10`**：分页，返回前 10 条数据。\n- **`timeout=1s`**：查询超时限制为 1 秒。\n\n### 2. **带 Profile 的查询**\n启用 `profile` 可以帮助分析查询性能，查看查询的每个阶段的时间。\n```bash\nGET /movies/_search?q=2012&df=title\n{\n\t\"profile\":\"true\"\n}\n```\n- **`\"profile\": \"true\"`**：启用查询性能分析。\n\n### 3. **泛查询，对所有字段进行查询**\n使用 `_all` 字段进行泛查询，查询所有字段。\n```bash\nGET /movies/_search?q=2012\n{\n\t\"profile\":\"true\"\n}\n```\n- **`q=2012`**：查询所有字段中包含 `2012` 的数据。\n\n### 4. **指定字段查询**\n查询 `title` 字段中包含 `2012` 的记录，并按照 `year` 字段降序排序：\n```bash\nGET /movies/_search?q=title:2012&sort=year:desc&from=0&size=10&timeout=1s\n{\n\t\"profile\":\"true\"\n}\n```\n- **`q=title:2012`**：指定查询字段为 `title`，查询内容为 `2012`。\n\n### 5. **查找美丽心灵**\n查询 `title` 字段包含 `\"Beautiful Mind\"` 的记录：\n```bash\nGET /movies/_search?q=title:Beautiful Mind\n{\n\t\"profile\":\"true\"\n}\n```\n\n### 6. **泛查询**\n查询 `title` 字段包含 `2012` 的记录：\n```bash\nGET /movies/_search?q=title:2012\n{\n\t\"profile\":\"true\"\n}\n```\n\n### 7. **Phrase 查询（短语查询）**\n查询 `title` 字段精确匹配 `\"Beautiful Mind\"`：\n```bash\nGET /movies/_search?q=title:\"Beautiful Mind\"\n{\n\t\"profile\":\"true\"\n}\n```\n- 使用引号表示精确短语匹配，要求字段内容必须完全匹配短语 `\"Beautiful Mind\"`。\n\n### 8. **分组查询（使用括号）**\n查询 `title` 字段中包含 `Beautiful Mind` 的记录：\n```bash\nGET /movies/_search?q=title:(Beautiful Mind)\n{\n\t\"profile\":\"true\"\n}\n```\n- 使用括号可以进行分组查询，类似逻辑上的括号优先级。\n\n### 9. **布尔操作符查询**\n- **AND 查询：**\n  查询 `title` 字段同时包含 `Beautiful` 和 `Mind` 的记录：\n  ```bash\n  GET /movies/_search?q=title:(Beautiful AND Mind)\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n- **NOT 查询：**\n  查询 `title` 字段包含 `Beautiful` 但不包含 `Mind` 的记录：\n  ```bash\n  GET /movies/_search?q=title:(Beautiful NOT Mind)\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n- **OR 查询：**\n  查询 `title` 字段包含 `Beautiful` 或 `Mind` 的记录：\n  ```bash\n  GET /movies/_search?q=title:(Beautiful %2BMind)\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n\n### 10. **范围查询**\n查询 `title` 字段包含 `beautiful` 且 `year` 在 2002 到 2018 年之间的记录：\n```bash\nGET /movies/_search?q=title:beautiful AND year:[2002 TO 2018%7D\n{\n\t\"profile\":\"true\"\n}\n```\n- **`year:[2002 TO 2018]`**：指定 `year` 字段的范围查询。\n\n### 11. **通配符查询**\n查询 `title` 字段以 `b` 开头的所有记录：\n```bash\nGET /movies/_search?q=title:b*\n{\n\t\"profile\":\"true\"\n}\n```\n- **`b*`**：使用通配符查询以 `b` 开头的字符串。\n\n### 12. **模糊查询 & 近似度匹配**\n- **模糊匹配**：查询 `title` 字段中的词语 `beautifl`，允许有 1 个字符的错误：\n  ```bash\n  GET /movies/_search?q=title:beautifl~1\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n- **近似度匹配**：查询 `title` 字段中的短语 `\"Lord Rings\"`，允许 2 个字符的误差：\n  ```bash\n  GET /movies/_search?q=title:\"Lord Rings\"~2\n  {\n  \t\"profile\":\"true\"\n  }\n  ```\n\n### 总结\n这些查询展示了如何使用 Elasticsearch 提供的强大查询能力来根据不同的需求筛选和搜索数据。常见的查询类型包括：\n- **基本查询**：用于查找单一词汇。\n- **布尔查询**：组合多个查询条件。\n- **范围查询**：查找特定范围内的记录。\n- **通配符查询**：模糊匹配。\n- **短语查询**：精确匹配整个短语。\n\n同时，`profile` 参数可以帮助分析查询性能，优化查询响应。\n\n\n3.8-RequestBody与QueryDSL简介\n\n以下是您提供的 Elasticsearch 查询操作，包括分页、日期排序、源过滤、脚本字段、以及不同的查询类型（如 `match`、`match_phrase`）。这些操作展示了如何在 Elasticsearch 中进行更精细的查询和数据处理。\n\n### 1. **忽略不存在的索引（`ignore_unavailable=true`）**\n在查询时，如果访问的索引不存在，使用 `ignore_unavailable=true` 可以避免报错：\n```bash\nPOST /movies,404_idx/_search?ignore_unavailable=true\n{\n  \"profile\": true,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`ignore_unavailable=true`**：在访问不存在的索引时，忽略错误。\n\n### 2. **分页查询**\n查询 `kibana_sample_data_ecommerce` 索引并分页返回数据（从第 10 条开始，返回 20 条记录）：\n```bash\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"from\": 10,\n  \"size\": 20,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`from=10`** 和 **`size=20`**：分页，跳过前 10 条，返回接下来的 20 条。\n\n### 3. **日期排序**\n按 `order_date` 字段降序排序：\n```bash\nPOST kibana_sample_data_ecommerce/_search\n{\n  \"sort\": [{\"order_date\": \"desc\"}],\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`sort`**：按照 `order_date` 字段降序排序。\n\n### 4. **源过滤**\n只返回文档中的 `order_date` 字段，不返回其他字段：\n```bash\nPOST kibana_sample_data_ecommerce/_search\n{\n  \"_source\": [\"order_date\"],\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`_source`**：指定只返回 `order_date` 字段的数据。\n\n### 5. **脚本字段**\n使用脚本字段计算新的字段（例如，拼接 `order_date` 和 `\"hello\"`）：\n```bash\nGET kibana_sample_data_ecommerce/_search\n{\n  \"script_fields\": {\n    \"new_field\": {\n      \"script\": {\n        \"lang\": \"painless\",\n        \"source\": \"doc['order_date'].value+'hello'\"\n      }\n    }\n  },\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n```\n- **`script_fields`**：使用 `painless` 脚本创建新的字段 `new_field`，将 `order_date` 字段与字符串 `\"hello\"` 拼接。\n\n### 6. **`match` 查询**\n查询 `movies` 索引中 `title` 字段包含 `\"last christmas\"` 的记录：\n```bash\nPOST movies/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"last christmas\"\n    }\n  }\n}\n```\n- **`match`**：进行标准的全文匹配查询。\n\n### 7. **`match` 查询并使用 AND 操作符**\n查询 `title` 包含 `\"last christmas\"` 且两个词都必须出现的记录（使用 AND 操作符）：\n```bash\nPOST movies/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"last christmas\",\n        \"operator\": \"and\"\n      }\n    }\n  }\n}\n```\n- **`operator: \"and\"`**：两个词必须同时出现在字段中。\n\n### 8. **`match_phrase` 查询（短语匹配）**\n查询 `title` 字段精确匹配 `\"one love\"` 作为一个短语：\n```bash\nPOST movies/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"title\": {\n        \"query\": \"one love\"\n      }\n    }\n  }\n}\n```\n- **`match_phrase`**：精确匹配整个短语，必须按照指定的顺序。\n\n### 9. **`match_phrase` 查询并使用 `slop`**\n查询 `title` 字段中的短语 `\"one love\"`，并允许 1 个词语的偏移（即词语可以有一定的顺序变化）：\n```bash\nPOST movies/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"title\": {\n        \"query\": \"one love\",\n        \"slop\": 1\n      }\n    }\n  }\n}\n```\n- **`slop: 1`**：允许最多 1 个词语的顺序偏移（例如，`love one` 也可以匹配）。\n\n### 总结\n这些查询展示了 Elasticsearch 中常用的查询类型：\n- **分页查询**：使用 `from` 和 `size` 来实现分页。\n- **日期排序**：使用 `sort` 来对结果进行排序。\n- **源过滤**：通过 `_source` 限制返回的字段。\n- **脚本字段**：使用 `painless` 脚本来计算新字段。\n- **布尔操作符**：通过 `operator` 来定义 `match` 查询的逻辑。\n- **短语匹配和偏移**：通过 `match_phrase` 和 `slop` 来进行更灵活的查询。\n\n这些查询可以帮助你在 Elasticsearch 中实现复杂的搜索需求。\n\n[3.9-QueryString&SimpleQueryString查询]\n\n以下是您提供的 Elasticsearch 查询操作，涉及到 `query_string` 和 `simple_query_string` 查询的使用，以及如何通过不同的字段和操作符执行复杂查询。这里的查询包括布尔操作符、字段匹配、以及指定默认操作符等。\n\n### 1. **向索引添加文档**\n首先，向 `users` 索引添加两个用户文档：\n```bash\nPUT /users/_doc/1\n{\n  \"name\": \"Ruan Yiming\",\n  \"about\": \"java, golang, node, swift, elasticsearch\"\n}\n\nPUT /users/_doc/2\n{\n  \"name\": \"Li Yiming\",\n  \"about\": \"Hadoop\"\n}\n```\n\n### 2. **`query_string` 查询：查询名称中包含 \"Ruan\" 和 \"Yiming\" 的文档**\n使用 `query_string` 查询，指定默认字段为 `name`，查询条件为 `\"Ruan AND Yiming\"`：\n```bash\nPOST users/_search\n{\n  \"query\": {\n    \"query_string\": {\n      \"default_field\": \"name\",\n      \"query\": \"Ruan AND Yiming\"\n    }\n  }\n}\n```\n- **`query_string`**：用于执行复杂的查询，可以使用逻辑操作符（如 AND、OR）。\n\n### 3. **`query_string` 查询：多个字段和复杂查询**\n查询名称或简介字段包含 `\"Ruan AND Yiming\"` 或 `\"Java AND Elasticsearch\"` 的文档：\n```bash\nPOST users/_search\n{\n  \"query\": {\n    \"query_string\": {\n      \"fields\": [\"name\", \"about\"],\n      \"query\": \"(Ruan AND Yiming) OR (Java AND Elasticsearch)\"\n    }\n  }\n}\n```\n- **`fields`**：可以指定多个字段进行查询。\n- **`query`**：包含布尔操作符（如 AND、OR）。\n\n### 4. **`simple_query_string` 查询（默认操作符为 OR）**\n执行一个简单查询，默认操作符为 `OR`，查询 `name` 字段中包含 `\"Ruan\"` 或 `\"Yiming\"` 的文档：\n```bash\nPOST users/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Ruan AND Yiming\",\n      \"fields\": [\"name\"]\n    }\n  }\n}\n```\n- **`simple_query_string`**：适用于较简单的查询，避免了复杂的查询语法。\n\n### 5. **`simple_query_string` 查询（默认操作符为 AND）**\n查询 `name` 字段中包含 `\"Ruan\"` 且 `\"Yiming\"` 的文档，使用 `AND` 作为默认操作符：\n```bash\nPOST users/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Ruan Yiming\",\n      \"fields\": [\"name\"],\n      \"default_operator\": \"AND\"\n    }\n  }\n}\n```\n- **`default_operator`**：设置默认操作符（`AND` 或 `OR`）。在此示例中，`AND` 用于要求 `\"Ruan\"` 和 `\"Yiming\"` 必须同时出现在 `name` 字段中。\n\n### 6. **`query_string` 查询：查询电影标题包含 \"Beautiful\" 和 \"Mind\"**\n执行 `query_string` 查询，查询电影标题中包含 `\"Beautiful\"` 和 `\"Mind\"` 的文档：\n```bash\nGET /movies/_search\n{\n  \"profile\": true,\n  \"query\": {\n    \"query_string\": {\n      \"default_field\": \"title\",\n      \"query\": \"Beautiful AND Mind\"\n    }\n  }\n}\n```\n- **`query_string`**：执行复杂查询，可以使用布尔操作符（如 `AND`）。\n\n### 7. **`query_string` 查询：多个字段查询**\n查询电影的 `title` 或 `year` 字段包含 `\"2012\"` 的文档：\n```bash\nGET /movies/_search\n{\n  \"profile\": true,\n  \"query\": {\n    \"query_string\": {\n      \"fields\": [\"title\", \"year\"],\n      \"query\": \"2012\"\n    }\n  }\n}\n```\n- **`fields`**：指定多个字段进行查询，这里同时查询 `title` 和 `year` 字段。\n\n### 8. **`simple_query_string` 查询：使用 `+` 进行短语匹配**\n查询电影标题中包含 `\"Beautiful\"` 和 `\"mind\"` 的文档，使用 `+` 确保两个词都出现在查询中：\n```bash\nGET /movies/_search\n{\n  \"profile\": true,\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Beautiful +mind\",\n      \"fields\": [\"title\"]\n    }\n  }\n}\n```\n- **`+` 操作符**：用于强制要求某个词出现在查询结果中。\n\n---\n\n### 总结\n这些查询展示了如何在 Elasticsearch 中使用不同类型的查询：\n\n- **`query_string`** 查询：用于执行复杂的查询，可以包含多个字段、布尔操作符（AND、OR、NOT）以及通配符等。\n- **`simple_query_string`** 查询：比 `query_string` 更简单，适用于不需要复杂语法的查询，并且支持默认操作符的配置。\n- **字段查询**：可以针对多个字段同时查询，指定多个字段使用 `fields` 参数。\n- **布尔操作符**：如 `AND`、`OR`、`NOT`，控制查询的逻辑。\n\n这些查询方式非常适合处理复杂的检索需求。\n\n[3.10-DynamicMapping和常见字段类型]\n\n您的示例展示了如何在 Elasticsearch 中管理映射（Mapping）以及如何处理动态字段和映射更新。以下是总结和解释：\n\n### **映射和字段定义**\n\n映射在 Elasticsearch 中类似于关系数据库中的表结构定义，主要用于：\n- **定义字段的名称**：指定文档中的字段名。\n- **定义字段的类型**：比如文本（`text`）、关键字（`keyword`）、日期（`date`）等。\n- **定义倒排索引相关配置**：比如是否需要索引字段，以及字段的 `Analyzer` 配置。\n\n### **动态映射（Dynamic Mapping）**\n\n动态映射允许 Elasticsearch 根据新文档自动推断字段的类型。可以通过 `dynamic` 属性来配置动态行为：\n- **`true`**（默认）：允许新字段自动被索引和映射。\n- **`false`**：禁止自动创建新字段，但已存在字段可以继续使用。\n- **`strict`**：禁止任何新的字段。如果文档包含未定义的字段，将导致错误。\n\n### **操作演示**\n\n1. **写入文档并查看映射**\n    - 向 `mapping_test` 索引中添加一个文档，查看映射：\n   ```bash\n   PUT mapping_test/_doc/1\n   {\n     \"firstName\": \"Chan\",\n     \"lastName\": \"Jackie\",\n     \"loginDate\": \"2018-07-24T10:29:48.103Z\"\n   }\n\n   GET mapping_test/_mapping\n   ```\n\n2. **动态映射：推断字段类型**\n    - 新字段 `uid`, `isVip`, `age` 等被自动推断并加入映射：\n   ```bash\n   PUT mapping_test/_doc/1\n   {\n     \"uid\": \"123\",\n     \"isVip\": false,\n     \"isAdmin\": \"true\",\n     \"age\": 19,\n     \"height\": 180\n   }\n\n   GET mapping_test/_mapping\n   ```\n\n3. **新增字段（默认动态）**\n    - 如果动态映射为 `true`（默认），可以动态添加新的字段：\n   ```bash\n   PUT dynamic_mapping_test/_doc/1\n   {\n     \"newField\": \"someValue\"\n   }\n\n   POST dynamic_mapping_test/_search\n   {\n     \"query\": {\n       \"match\": {\n         \"newField\": \"someValue\"\n       }\n     }\n   }\n   ```\n\n4. **修改动态设置为 `false`**\n    - 修改 `dynamic` 设置为 `false`，禁止自动推断新字段：\n   ```bash\n   PUT dynamic_mapping_test/_mapping\n   {\n     \"dynamic\": false\n   }\n\n   PUT dynamic_mapping_test/_doc/10\n   {\n     \"anotherField\": \"someValue\"\n   }\n\n   POST dynamic_mapping_test/_search\n   {\n     \"query\": {\n       \"match\": {\n         \"anotherField\": \"someValue\"\n       }\n     }\n   }\n   ```\n\n   在此示例中，`anotherField` 将不会被索引或搜索，因为动态映射已设置为 `false`。\n\n5. **修改为 `strict` 模式**\n    - 如果将 `dynamic` 设置为 `strict`，任何新的字段都会导致错误：\n   ```bash\n   PUT dynamic_mapping_test/_mapping\n   {\n     \"dynamic\": \"strict\"\n   }\n\n   PUT dynamic_mapping_test/_doc/12\n   {\n     \"lastField\": \"value\"\n   }\n   ```\n   此时，写入新字段 `lastField` 会导致错误，HTTP 返回 `400` 错误码。\n\n6. **删除索引**\n    - 删除索引：\n   ```bash\n   DELETE dynamic_mapping_test\n   ```\n\n### **总结**\n\n- **动态映射（Dynamic Mapping）**：允许 Elasticsearch 自动推断并添加新的字段，方便快速处理未知数据。\n- **`dynamic` 配置**：控制是否允许 Elasticsearch 自动映射新字段：\n    - `true`：默认允许动态字段；\n    - `false`：禁止自动映射新字段；\n    - `strict`：禁止所有未知字段，如果有未定义字段则会报错。\n- **更改映射**：映射一旦建立后不能直接修改字段类型，要修改字段配置或添加新字段需要使用 `reindex` 操作。\n\n这些操作有助于管理索引和字段的生命周期，确保数据能够根据业务需求灵活适应。\n\n\n您的示例展示了 Elasticsearch 中显式设置映射（Mapping）的一些常见操作和参数。以下是各个设置项的详细介绍和使用案例。\n\n### **1. `index: false` 设置**\n通过设置字段的 `index: false`，可以阻止某些字段被索引。这样可以避免该字段参与倒排索引，也不会进行搜索。\n\n**示例**:\n```bash\nDELETE users\nPUT users\n{\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\"\n        },\n        \"lastName\" : {\n          \"type\" : \"text\"\n        },\n        \"mobile\" : {\n          \"type\" : \"text\",\n          \"index\": false  # 禁止索引该字段\n        }\n      }\n    }\n}\n\nPUT users/_doc/1\n{\n  \"firstName\": \"Ruan\",\n  \"lastName\": \"Yiming\",\n  \"mobile\": \"12345678\"\n}\n\nPOST /users/_search\n{\n  \"query\": {\n    \"match\": {\n      \"mobile\": \"12345678\"  # 搜索时不会命中mobile字段\n    }\n  }\n}\n```\n在上面的示例中，`mobile` 字段被设置为 `index: false`，因此无法用于搜索查询。\n\n### **2. `null_value` 设置**\n通过设置 `null_value`，可以在文档中存储 `null` 值，并用指定的替代值替换 `null`。这对于查询时需要处理 `null` 数据特别有用。\n\n**示例**:\n```bash\nDELETE users\nPUT users\n{\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\"\n        },\n        \"lastName\" : {\n          \"type\" : \"text\"\n        },\n        \"mobile\" : {\n          \"type\" : \"keyword\",\n          \"null_value\": \"NULL\"  # null值替代为\"NULL\"\n        }\n      }\n    }\n}\n\nPUT users/_doc/1\n{\n  \"firstName\": \"Ruan\",\n  \"lastName\": \"Yiming\",\n  \"mobile\": null  # 实际值是null\n}\n\nPUT users/_doc/2\n{\n  \"firstName\": \"Ruan2\",\n  \"lastName\": \"Yiming2\"  # 没有mobile字段\n}\n\nGET users/_search\n{\n  \"query\": {\n    \"match\": {\n      \"mobile\": \"NULL\"  # 搜索时会匹配到null值字段\n    }\n  }\n}\n```\n此设置可以确保查询时用 `NULL` 代替存储的 `null` 值。\n\n### **3. `copy_to` 设置**\n`copy_to` 可以将多个字段的内容复制到另一个字段，方便进行联合查询或索引。\n\n**示例**:\n```bash\nDELETE users\nPUT users\n{\n  \"mappings\": {\n    \"properties\": {\n      \"firstName\": {\n        \"type\": \"text\",\n        \"copy_to\": \"fullName\"  # 将firstName复制到fullName字段\n      },\n      \"lastName\": {\n        \"type\": \"text\",\n        \"copy_to\": \"fullName\"  # 将lastName复制到fullName字段\n      }\n    }\n  }\n}\n\nPUT users/_doc/1\n{\n  \"firstName\": \"Ruan\",\n  \"lastName\": \"Yiming\"\n}\n\nGET users/_search?q=fullName:(Ruan Yiming)\n\nPOST users/_search\n{\n  \"query\": {\n    \"match\": {\n      \"fullName\": {\n        \"query\": \"Ruan Yiming\",\n        \"operator\": \"and\"  # 联合查询fullName字段\n      }\n    }\n  }\n}\n```\n这里，`firstName` 和 `lastName` 字段的内容会被复制到 `fullName` 字段，从而使得查询变得更加方便。\n\n### **4. 数组类型处理**\nElasticsearch 支持数组字段。数组中的每个元素会被视为一个单独的值，这对于多值字段非常有用。\n\n**示例**:\n```bash\nPUT users/_doc/1\n{\n  \"name\": \"onebird\",\n  \"interests\": \"reading\"  # 字段为单一值\n}\n\nPUT users/_doc/2\n{\n  \"name\": \"twobirds\",\n  \"interests\": [\"reading\", \"music\"]  # 字段为数组\n}\n\nPOST users/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\nGET users/_mapping\n```\n在此示例中，`interests` 字段既可以是单个值也可以是数组，Elasticsearch 会将每个数组元素视为独立的值进行索引。\n\n---\n\n### **总结常见的 Mapping 参数**\n\n- **`type`**: 字段的数据类型，如 `text`, `keyword`, `date` 等。\n- **`index`**: 控制是否索引该字段，`false` 表示不索引，默认为 `true`。\n- **`null_value`**: 控制 `null` 值的替代值。可以设置为任何替代值，如 `\"NULL\"`。\n- **`copy_to`**: 将多个字段的内容复制到一个目标字段中，便于联合查询。\n- **`dynamic`**: 控制动态映射，`true` 表示允许自动推断新字段，`false` 表示禁止新字段自动映射，`strict` 则表示严格模式下不允许任何新字段。\n\n通过这些映射设置，可以更好地控制数据如何存储和索引，以及如何在查询时处理和优化字段。\n\n\n您的示例展示了 Elasticsearch 中关于多字段特性以及自定义分析器（Analyzer）的配置。以下是对各个分析器和相关配置的详细解释。\n\n### **1. 自定义 Analyzer 和 Char Filter**\nElasticsearch 提供了灵活的机制来配置分词器（Tokenizer）和字符过滤器（Char Filter）。这些配置用于在索引和搜索过程中控制文本的处理方式。\n\n#### **自定义 Tokenizer 和 Char Filter 示例**\n- **Keyword Tokenizer**: `keyword` tokenizer 将整个文本当作一个单独的 token 进行处理。\n- **HTML Strip Char Filter**: `html_strip` char filter 用于从文本中去除 HTML 标签。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"keyword\",  # 使用关键词分词器\n  \"char_filter\": [\"html_strip\"],  # 使用html_strip字符过滤器\n  \"text\": \"<b>hello world</b>\"  # 输入带有HTML标签的文本\n}\n```\n输出将会是：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"hello world\",\n      \"start_offset\": 3,\n      \"end_offset\": 15,\n      \"type\": \"word\",\n      \"position\": 0\n    }\n  ]\n}\n```\n此配置移除了文本中的 `<b></b>` HTML 标签，只保留了纯文本 \"hello world\"。\n\n#### **Path Hierarchy Tokenizer**\n`path_hierarchy` tokenizer 用于处理文件路径等层级结构的数据，将路径按分隔符（如 `/`）切割。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"path_hierarchy\",  # 使用路径层级分词器\n  \"text\": \"/user/ymruan/a/b/c/d/e\"\n}\n```\n输出会将路径按 `/` 切分：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"/user/ymruan/a/b/c/d/e\",\n      \"start_offset\": 0,\n      \"end_offset\": 21,\n      \"type\": \"word\",\n      \"position\": 0\n    },\n    {\n      \"token\": \"/user/ymruan/a/b/c/d\",\n      \"start_offset\": 0,\n      \"end_offset\": 16,\n      \"type\": \"word\",\n      \"position\": 1\n    },\n    ...\n  ]\n}\n```\n\n### **2. Char Filter 替换符号**\n字符过滤器可以用于替换文本中的特定符号或字符。例如，使用 `mapping` 类型的 `char_filter`，可以替换文本中的字符（如将 `-` 替换为 `_`）。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",  # 使用标准分词器\n  \"char_filter\": [\n    {\n      \"type\": \"mapping\",  # 使用字符映射过滤器\n      \"mappings\": [\"- => _\"]\n    }\n  ],\n  \"text\": \"123-456, I-test! test-990 650-555-1234\"\n}\n```\n此配置将文本中的 `-` 替换为 `_`，输出将是：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"123_456\",\n      \"start_offset\": 0,\n      \"end_offset\": 7,\n      \"type\": \"word\",\n      \"position\": 0\n    },\n    ...\n  ]\n}\n```\n\n### **3. Char Filter 替换表情符号**\n你还可以使用字符过滤器将表情符号替换为特定的文本（如将 `:)` 替换为 `happy`，`:(` 替换为 `sad`）。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n    {\n      \"type\": \"mapping\",\n      \"mappings\": [\":) => happy\", \":( => sad\"]\n    }\n  ],\n  \"text\": [\"I am felling :)\", \"Feeling :( today\"]\n}\n```\n输出：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"I\",\n      \"start_offset\": 0,\n      \"end_offset\": 1,\n      \"type\": \"word\",\n      \"position\": 0\n    },\n    {\n      \"token\": \"am\",\n      \"start_offset\": 2,\n      \"end_offset\": 4,\n      \"type\": \"word\",\n      \"position\": 1\n    },\n    {\n      \"token\": \"felling\",\n      \"start_offset\": 5,\n      \"end_offset\": 12,\n      \"type\": \"word\",\n      \"position\": 2\n    },\n    {\n      \"token\": \"happy\",  # 替换表情符号:) 为 happy\n      \"start_offset\": 13,\n      \"end_offset\": 18,\n      \"type\": \"word\",\n      \"position\": 3\n    }\n  ]\n}\n```\n\n### **4. 使用 Stop 和 Snowball 过滤器**\n使用 `stop` 过滤器来删除常见的停用词，使用 `snowball` 过滤器进行词干提取（如将 \"playing\" 转换为 \"play\"）。\n\n```bash\nGET _analyze\n{\n  \"tokenizer\": \"whitespace\",  # 使用空格分词器\n  \"filter\": [\"stop\", \"snowball\"],  # 使用停用词和词干提取\n  \"text\": [\"The girls in China are playing this game!\"]\n}\n```\n输出：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"girl\",\n      \"start_offset\": 4,\n      \"end_offset\": 9,\n      \"type\": \"word\",\n      \"position\": 0\n    },\n    {\n      \"token\": \"china\",\n      \"start_offset\": 14,\n      \"end_offset\": 19,\n      \"type\": \"word\",\n      \"position\": 1\n    },\n    ...\n  ]\n}\n```\n\n### **5. 正则表达式替换**\n通过 `pattern_replace` 字符过滤器，您可以根据正则表达式来替换文本中的特定部分。\n\n```bash\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n    {\n      \"type\": \"pattern_replace\",\n      \"pattern\": \"http://(.*)\",\n      \"replacement\": \"$1\"\n    }\n  ],\n  \"text\": \"http://www.elastic.co\"\n}\n```\n此配置将 `http://` 替换为一个空字符串，结果为：\n```json\n{\n  \"tokens\": [\n    {\n      \"token\": \"www.elastic.co\",\n      \"start_offset\": 7,\n      \"end_offset\": 23,\n      \"type\": \"word\",\n      \"position\": 0\n    }\n  ]\n}\n```\n\n### **总结：**\n- **Tokenizer**: 负责将输入文本切割成词条（token）。如 `keyword`, `standard`, `path_hierarchy`。\n- **Char Filter**: 处理文本中的字符替换、去除特殊符号或HTML标签等，如 `html_strip`, `mapping`, `pattern_replace`。\n- **Filter**: 用于文本处理，如去除停用词（`stop`）或词干提取（`snowball`）。\n\n这些工具的组合允许您灵活地处理和分析文本数据，并针对特定的业务需求优化索引和搜索行为。\n\n在 Elasticsearch 中，**Index Templates** 和 **Dynamic Templates** 是两种强大的工具，用于控制如何定义和管理索引的映射和设置。以下是这两者的详细解释和示例。\n\n### **1. Index Templates (索引模板)**\n\n**Index Templates** 是一种配置模板，用于为匹配特定模式的索引自动配置设置、映射和其他配置。当创建一个新索引时，如果该索引匹配模板中的 `index_patterns` 配置，模板中的设置、映射和其他配置就会自动应用到新索引上。\n\n#### **创建默认模板**\n下面是创建一个默认模板的示例：\n```bash\nPUT _template/template_default\n{\n  \"index_patterns\": [\"*\"],  # 匹配所有索引\n  \"order\": 0,\n  \"version\": 1,\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 1\n  }\n}\n```\n这会为所有索引设置一个模板，其中包含分片数量为1、副本数量为1。\n\n#### **为特定模式创建模板**\n另一个例子是为 `test*` 开头的索引创建模板：\n```bash\nPUT /_template/template_test\n{\n  \"index_patterns\": [\"test*\"],  # 匹配所有以test开头的索引\n  \"order\": 1,\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 2\n  },\n  \"mappings\": {\n    \"date_detection\": false,  # 禁止自动检测日期字段\n    \"numeric_detection\": true  # 自动检测数字字段\n  }\n}\n```\n\n#### **查看模板**\n你可以查看已定义的模板：\n```bash\nGET /_template/template_default\nGET /_template/temp*  # 查看所有模板\n```\n\n#### **删除模板**\n删除模板的命令如下：\n```bash\nDELETE /_template/template_default\nDELETE /_template/template_test\n```\n\n---\n\n### **2. Dynamic Templates (动态模板)**\n\n**Dynamic Templates** 用于在创建索引时自动匹配字段类型和名称，根据这些动态模板来生成字段的映射规则。可以根据字段的类型（例如字符串、数字）和字段名称（例如以某些字符开头的字段）来定义映射。\n\n#### **自动映射数字字符串和日期字符串**\n例如，数字字符串会被映射为 `text` 类型，日期字符串会被映射为日期类型：\n```bash\nPUT ttemplate/_doc/1\n{\n  \"someNumber\": \"1\",        # 字符串数字\n  \"someDate\": \"2019/01/01\"  # 字符串日期\n}\nGET ttemplate/_mapping\n```\n在这个例子中，`someNumber` 会被映射成 `text` 类型，而 `someDate` 会被映射成 `date` 类型。\n\n#### **定义动态模板映射规则**\n使用 `dynamic_templates` 可以根据字段类型和名称定义映射。例如，以下动态模板将以 `is*` 开头的字符串字段映射为 `boolean` 类型，其他字符串字段映射为 `keyword` 类型：\n```bash\nDELETE my_index\n\nPUT my_index\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"strings_as_boolean\": {\n          \"match_mapping_type\": \"string\",   # 匹配所有字符串类型\n          \"match\": \"is*\",  # 字段名称以is开头\n          \"mapping\": {\n            \"type\": \"boolean\"\n          }\n        }\n      },\n      {\n        \"strings_as_keywords\": {\n          \"match_mapping_type\": \"string\",   # 匹配所有字符串类型\n          \"mapping\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    ]\n  }\n}\n```\n在这个示例中，`isVIP` 字段会被映射为 `boolean` 类型，而其他字符串类型的字段则会被映射为 `keyword` 类型。\n\n#### **结合路径匹配**\n动态模板不仅可以基于字段名称，还可以基于字段的路径。例如，以下模板会将 `name.*` 路径下的所有字段映射为 `text` 类型，并将这些字段复制到 `full_name` 字段中：\n```bash\nPUT my_index\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"full_name\": {\n          \"path_match\": \"name.*\",  # 匹配name下的所有字段\n          \"path_unmatch\": \"*.middle\",  # 排除middle字段\n          \"mapping\": {\n            \"type\": \"text\",\n            \"copy_to\": \"full_name\"  # 将值复制到full_name字段\n          }\n        }\n      }\n    ]\n  }\n}\n```\n然后，插入以下数据：\n```bash\nPUT my_index/_doc/1\n{\n  \"name\": {\n    \"first\": \"John\",\n    \"middle\": \"Winston\",\n    \"last\": \"Lennon\"\n  }\n}\n```\n\n在这个例子中，`first` 和 `last` 字段将被映射为 `text` 类型，并且它们的内容会被复制到 `full_name` 字段中。\n\n#### **搜索字段**\n可以通过 `full_name` 字段来搜索：\n```bash\nGET my_index/_search?q=full_name:John\n```\n\n---\n\n### **总结：**\n- **Index Templates** 是为匹配特定索引模式（`index_patterns`）的所有索引自动配置设置和映射的模板。\n- **Dynamic Templates** 用于根据字段类型和字段名称自动映射索引字段。你可以根据字段类型（如 `string`）或字段路径（如 `name.*`）来定义映射规则。\n\n这些配置使得索引的创建和管理更加灵活，可以根据实际数据自动推断和调整映射，从而提高了 Elasticsearch 的可用性和效率。\n\n\n\nElasticsearch 提供了强大的 **聚合** 功能，用于对数据进行汇总和分析。聚合是 Elasticsearch 搜索的一个核心功能，允许你通过多种方式对数据进行分组、统计、求最大/最小值、计算平均值等操作。以下是一些常见的聚合分析操作和示例：\n\n### **1. 基本的聚合分析：按目的地分桶统计**\n在这个示例中，我们按航班的目的地（`DestCountry`）进行分桶统计，查看每个目的地的航班数量：\n```bash\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,  # 不返回实际的文档数据，只返回聚合结果\n  \"aggs\": {\n    \"flight_dest\": {\n      \"terms\": {\n        \"field\": \"DestCountry\"  # 按目的地国家分桶\n      }\n    }\n  }\n}\n```\n在这个聚合查询中，`terms` 聚合用于对 `DestCountry` 字段的值进行分桶，返回每个目的地国家的航班数量。\n\n### **2. 增加更多统计：平均、最大、最小价格**\n你可以在分桶内部添加更多聚合来获取其他统计信息，如每个目的地的平均票价、最高票价和最低票价：\n```bash\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"flight_dest\": {\n      \"terms\": {\n        \"field\": \"DestCountry\"\n      },\n      \"aggs\": {\n        \"avg_price\": {\n          \"avg\": {\n            \"field\": \"AvgTicketPrice\"  # 计算平均票价\n          }\n        },\n        \"max_price\": {\n          \"max\": {\n            \"field\": \"AvgTicketPrice\"  # 计算最高票价\n          }\n        },\n        \"min_price\": {\n          \"min\": {\n            \"field\": \"AvgTicketPrice\"  # 计算最低票价\n          }\n        }\n      }\n    }\n  }\n}\n```\n在这个查询中，我们为每个目的地添加了三个聚合：`avg_price`、`max_price` 和 `min_price`，分别计算每个目的地的平均票价、最大票价和最小票价。\n\n### **3. 聚合价格与天气信息：统计与多重聚合**\n如果你还想结合天气信息（如 `DestWeather` 字段）与航班价格统计一起进行聚合，可以使用嵌套聚合：\n```bash\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"flight_dest\": {\n      \"terms\": {\n        \"field\": \"DestCountry\"\n      },\n      \"aggs\": {\n        \"stats_price\": {\n          \"stats\": {\n            \"field\": \"AvgTicketPrice\"  # 计算票价的多项统计信息\n          }\n        },\n        \"weather\": {\n          \"terms\": {\n            \"field\": \"DestWeather\",  # 按天气类型分桶\n            \"size\": 5  # 只返回前5个天气类型\n          }\n        }\n      }\n    }\n  }\n}\n```\n在这个示例中，我们不仅计算了每个目的地的票价统计信息（如平均票价、最大票价等），还将天气信息作为另一个 `terms` 聚合，显示每个目的地的天气类型，并限制返回的天气类型数量为 5 个。\n\n---\n\n### **常见的聚合类型：**\n- **`terms` 聚合**：将文档按某个字段的值进行分桶，常用于统计词频或其他分类数据。\n- **`avg` 聚合**：计算某个数值字段的平均值。\n- **`sum` 聚合**：计算某个数值字段的总和。\n- **`min` 聚合**：返回某个数值字段的最小值。\n- **`max` 聚合**：返回某个数值字段的最大值。\n- **`stats` 聚合**：返回字段的统计信息（包括：最小值、最大值、平均值、总和和文档数量）。\n- **`date_histogram` 聚合**：按日期进行分桶，适用于时间序列数据。\n- **`histogram` 聚合**：按数值区间进行分桶，常用于数值数据的统计。\n\n---\n\n### **相关阅读：**\n- [Elasticsearch 聚合文档](https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations.html) 详细介绍了各种聚合的使用方式和示例。\n\n聚合功能非常强大，能帮助你从海量数据中提取有价值的信息，适用于各种数据分析场景。\n\n\n","slug":"elasticsearch/es常用命令","published":1,"updated":"2025-02-27T09:25:21.655Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8s0007ujz36okt0kms","content":"<p>以下是 Elasticsearch (ES) 常用命令的总结和笔记：</p>\n<h3 id=\"1-查看索引相关信息\"><a href=\"#1-查看索引相关信息\" class=\"headerlink\" title=\"1. 查看索引相关信息\"></a>1. 查看索引相关信息</h3><ul>\n<li><p><strong>查看指定索引的映射信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_ecommerce</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看指定索引的文档总数</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_ecommerce/_count</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看前10条文档</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"2-查看索引状态与信息\"><a href=\"#2-查看索引状态与信息\" class=\"headerlink\" title=\"2. 查看索引状态与信息\"></a>2. 查看索引状态与信息</h3><ul>\n<li><p><strong>查看索引信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices/kibana*?v&amp;s=index</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看状态为绿的索引</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices?v&amp;health=green</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>按文档个数排序查看索引</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices?v&amp;s=docs.count:desc</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看具体的索引字段（健康、主分片、复制分片、文档数等）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices/kibana*?pri&amp;v&amp;h=health,index,pri,rep,docs.count,mt</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看每个索引使用的内存量</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices?v&amp;h=i,tm&amp;s=tm:desc</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"3-查看节点信息\"><a href=\"#3-查看节点信息\" class=\"headerlink\" title=\"3. 查看节点信息\"></a>3. 查看节点信息</h3><ul>\n<li><p><strong>查看所有节点信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cat/nodes?v</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看特定节点信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_nodes/es7_01,es7_02</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看节点信息并显示特定字段</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/nodes?v&amp;h=<span class=\"built_in\">id</span>,ip,port,v,m</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"4-查看集群健康状况\"><a href=\"#4-查看集群健康状况\" class=\"headerlink\" title=\"4. 查看集群健康状况\"></a>4. 查看集群健康状况</h3><ul>\n<li><p><strong>查看集群健康状况</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/health</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看集群健康状况，并按分片级别显示</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/health?level=shards</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看特定索引的集群健康状况</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/health/kibana_sample_data_ecommerce,kibana_sample_data_flights</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看特定索引的集群健康状况，并按分片级别显示</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/health/kibana_sample_data_flights?level=shards</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"5-查看集群状态\"><a href=\"#5-查看集群状态\" class=\"headerlink\" title=\"5. 查看集群状态\"></a>5. 查看集群状态</h3><ul>\n<li><strong>查看集群状态</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/state</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"6-查看集群设置\"><a href=\"#6-查看集群设置\" class=\"headerlink\" title=\"6. 查看集群设置\"></a>6. 查看集群设置</h3><ul>\n<li><p><strong>查看集群设置</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/settings</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看集群设置，包括默认设置</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/settings?include_defaults=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"7-查看分片信息\"><a href=\"#7-查看分片信息\" class=\"headerlink\" title=\"7. 查看分片信息\"></a>7. 查看分片信息</h3><ul>\n<li><p><strong>查看集群的所有分片信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/shards</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看特定的分片信息（包括状态、主分片&#x2F;副本分片等）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/shards?h=index,shard,prirep,state,unassigned.reason</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"1-创建文档\"><a href=\"#1-创建文档\" class=\"headerlink\" title=\"1. 创建文档\"></a>1. 创建文档</h3><ul>\n<li><p><strong>自动生成 <code>_id</code> 创建文档</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;user&quot;</span> : <span class=\"string\">&quot;Mike&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;post_date&quot;</span> : <span class=\"string\">&quot;2019-04-15T14:12:12&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span> : <span class=\"string\">&quot;trying out Kibana&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>指定 ID 创建文档（如果 ID 已存在则报错）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1?op_type=create</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;user&quot;</span> : <span class=\"string\">&quot;Jack&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;post_date&quot;</span> : <span class=\"string\">&quot;2019-05-15T14:12:12&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span> : <span class=\"string\">&quot;trying out Elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>指定 ID 创建文档（如果 ID 已存在则报错）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT <span class=\"built_in\">users</span>/_create/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;user&quot;</span> : <span class=\"string\">&quot;Jack&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;post_date&quot;</span> : <span class=\"string\">&quot;2019-05-15T14:12:12&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span> : <span class=\"string\">&quot;trying out Elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"2-根据-ID-获取文档\"><a href=\"#2-根据-ID-获取文档\" class=\"headerlink\" title=\"2. 根据 ID 获取文档\"></a>2. 根据 ID 获取文档</h3><ul>\n<li><strong>获取指定 ID 的文档</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET <span class=\"built_in\">users</span>/_doc/1</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"3-更新文档\"><a href=\"#3-更新文档\" class=\"headerlink\" title=\"3. 更新文档\"></a>3. 更新文档</h3><ul>\n<li><p><strong>更新指定 ID 的文档（先删除再写入）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;user&quot;</span> : <span class=\"string\">&quot;Mike&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在原文档上增加字段</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_update/1/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;doc&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;post_date&quot;</span> : <span class=\"string\">&quot;2019-05-15T14:12:12&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;message&quot;</span> : <span class=\"string\">&quot;trying out Elasticsearch&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"4-删除文档\"><a href=\"#4-删除文档\" class=\"headerlink\" title=\"4. 删除文档\"></a>4. 删除文档</h3><ul>\n<li><strong>根据 ID 删除文档</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span>/_doc/1</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"5-批量操作-Bulk-API\"><a href=\"#5-批量操作-Bulk-API\" class=\"headerlink\" title=\"5. 批量操作 (Bulk API)\"></a>5. 批量操作 (Bulk API)</h3><ul>\n<li><strong>执行批量操作</strong><br>第一次执行批量操作：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _bulk</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;index&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;field1&quot;</span> : <span class=\"string\">&quot;value1&quot;</span> &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;delete&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;create&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test2&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;3&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;field1&quot;</span> : <span class=\"string\">&quot;value3&quot;</span> &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;update&quot;</span> : &#123;<span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>&#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;doc&quot;</span> : &#123;<span class=\"string\">&quot;field2&quot;</span> : <span class=\"string\">&quot;value2&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure>\n\n第二次执行批量操作：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _bulk</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;index&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;field1&quot;</span> : <span class=\"string\">&quot;value1&quot;</span> &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;delete&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;create&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test2&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;3&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;field1&quot;</span> : <span class=\"string\">&quot;value3&quot;</span> &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;update&quot;</span> : &#123;<span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>&#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;doc&quot;</span> : &#123;<span class=\"string\">&quot;field2&quot;</span> : <span class=\"string\">&quot;value2&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"6-多文档获取-MGET\"><a href=\"#6-多文档获取-MGET\" class=\"headerlink\" title=\"6. 多文档获取 (MGET)\"></a>6. 多文档获取 (MGET)</h3><ul>\n<li><p><strong>获取多个文档</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_mget</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;docs&quot;</span> : [</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span> &#125;,</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span> &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>URI中指定索引</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /test/_mget</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;docs&quot;</span> : [</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span> &#125;,</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span> &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>使用 <code>_source</code> 参数指定返回的字段</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_mget</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;docs&quot;</span> : [</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;_source&quot;</span> : <span class=\"literal\">false</span> &#125;,</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span>, <span class=\"string\">&quot;_source&quot;</span> : [<span class=\"string\">&quot;field3&quot;</span>, <span class=\"string\">&quot;field4&quot;</span>] &#125;,</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;3&quot;</span>, <span class=\"string\">&quot;_source&quot;</span> : &#123; <span class=\"string\">&quot;include&quot;</span>: [<span class=\"string\">&quot;user&quot;</span>], <span class=\"string\">&quot;exclude&quot;</span>: [<span class=\"string\">&quot;user.location&quot;</span>] &#125; &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"7-多查询操作-MSEARCH\"><a href=\"#7-多查询操作-MSEARCH\" class=\"headerlink\" title=\"7. 多查询操作 (MSEARCH)\"></a>7. 多查询操作 (MSEARCH)</h3><ul>\n<li><strong>执行多个查询</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST kibana_sample_data_ecommerce/_msearch</span><br><span class=\"line\">&#123;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;query&quot;</span> : &#123;<span class=\"string\">&quot;match_all&quot;</span> : &#123;&#125;&#125;,<span class=\"string\">&quot;size&quot;</span>:1&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;index&quot;</span> : <span class=\"string\">&quot;kibana_sample_data_flights&quot;</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;query&quot;</span> : &#123;<span class=\"string\">&quot;match_all&quot;</span> : &#123;&#125;&#125;,<span class=\"string\">&quot;size&quot;</span>:2&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"8-清除测试数据\"><a href=\"#8-清除测试数据\" class=\"headerlink\" title=\"8. 清除测试数据\"></a>8. 清除测试数据</h3><ul>\n<li><strong>删除索引（清除数据）</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span></span><br><span class=\"line\">DELETE <span class=\"built_in\">test</span></span><br><span class=\"line\">DELETE test2</span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>[3.4-倒排索引入门]</p>\n<p>Elasticsearch 的 <code>_analyze</code> API，它用于分析文本，查看在特定分析器下，文本是如何被分词和处理的。下面是每个请求的说明：</p>\n<h3 id=\"1-分析-“Mastering-Elasticsearch”\"><a href=\"#1-分析-“Mastering-Elasticsearch”\" class=\"headerlink\" title=\"1. 分析 “Mastering Elasticsearch”\"></a>1. <strong>分析 “Mastering Elasticsearch”</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;Mastering Elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分析器</strong>：使用默认的 <code>standard</code> 分析器。</li>\n<li><strong>文本</strong>：<code>&quot;Mastering Elasticsearch&quot;</code>。</li>\n<li><strong>预期效果</strong>：<code>standard</code> 分析器会将这段文本分割成单词，通常会根据空格和标点符号进行分词。</li>\n</ul>\n<h3 id=\"2-分析-“Elasticsearch-Server”\"><a href=\"#2-分析-“Elasticsearch-Server”\" class=\"headerlink\" title=\"2. 分析 “Elasticsearch Server”\"></a>2. <strong>分析 “Elasticsearch Server”</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;Elasticsearch Server&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分析器</strong>：同样使用 <code>standard</code> 分析器。</li>\n<li><strong>文本</strong>：<code>&quot;Elasticsearch Server&quot;</code>。</li>\n<li><strong>预期效果</strong>：分析器会分割文本为单词，可能会得到类似于 <code>[&quot;elasticsearch&quot;, &quot;server&quot;]</code> 的分词结果。</li>\n</ul>\n<h3 id=\"3-分析-“Elasticsearch-Essentials”\"><a href=\"#3-分析-“Elasticsearch-Essentials”\" class=\"headerlink\" title=\"3. 分析 “Elasticsearch Essentials”\"></a>3. <strong>分析 “Elasticsearch Essentials”</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;Elasticsearch Essentials&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分析器</strong>：继续使用 <code>standard</code> 分析器。</li>\n<li><strong>文本</strong>：<code>&quot;Elasticsearch Essentials&quot;</code>。</li>\n<li><strong>预期效果</strong>：分析器会将文本分割成 <code>[&quot;elasticsearch&quot;, &quot;essentials&quot;]</code>。</li>\n</ul>\n<h3 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h3><p>每个请求的结果将显示由 <code>standard</code> 分析器生成的分词结果。通常，<code>standard</code> 分析器会去除大部分标点符号并将文本转换为小写。分词的具体结果如下：</p>\n<ul>\n<li><code>&quot;Mastering Elasticsearch&quot;</code> -&gt; <code>[&quot;mastering&quot;, &quot;elasticsearch&quot;]</code></li>\n<li><code>&quot;Elasticsearch Server&quot;</code> -&gt; <code>[&quot;elasticsearch&quot;, &quot;server&quot;]</code></li>\n<li><code>&quot;Elasticsearch Essentials&quot;</code> -&gt; <code>[&quot;elasticsearch&quot;, &quot;essentials&quot;]</code></li>\n</ul>\n<p>以下是使用不同的分析器（Analyzer）对文本进行分词分析的示例：</p>\n<h3 id=\"1-Standard-Analyzer\"><a href=\"#1-Standard-Analyzer\" class=\"headerlink\" title=\"1. Standard Analyzer\"></a>1. <strong>Standard Analyzer</strong></h3><p>标准分析器会根据空格、标点符号等进行分词，并将所有文本转换为小写。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokens&quot;</span> : [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;2&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 0,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 1,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;NUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 0</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;running&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 2,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 9,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 1</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;quick&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 10,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 15,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 2</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;brown&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 16,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 21,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 3</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;foxes&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 22,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 27,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 4</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;leap&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 28,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 32,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 5</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;over&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 33,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 37,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 6</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;lazy&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 38,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 42,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 7</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;dogs&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 43,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 47,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 8</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;in&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 48,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 50,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 9</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;the&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 51,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 54,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 10</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;summer&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 55,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 61,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 11</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;evening&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 62,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 69,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 12</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;over&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;in&quot;, &quot;the&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"2-Simple-Analyzer\"><a href=\"#2-Simple-Analyzer\" class=\"headerlink\" title=\"2. Simple Analyzer\"></a>2. <strong>Simple Analyzer</strong></h3><p>简单分析器按非字母字符切分，符号会被过滤，文本会转换为小写。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;simple&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;over&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;in&quot;, &quot;the&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"3-Stop-Analyzer\"><a href=\"#3-Stop-Analyzer\" class=\"headerlink\" title=\"3. Stop Analyzer\"></a>3. <strong>Stop Analyzer</strong></h3><p>停用词分析器会将文本转换为小写，并过滤掉常见的停用词（如 “the”, “a”, “is”）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;stop&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"4-Whitespace-Analyzer\"><a href=\"#4-Whitespace-Analyzer\" class=\"headerlink\" title=\"4. Whitespace Analyzer\"></a>4. <strong>Whitespace Analyzer</strong></h3><p>空格分析器会按空格切分文本，并且不会转换为小写。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;whitespace&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;Quick&quot;, &quot;brown-foxes&quot;, &quot;leap&quot;, &quot;over&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;in&quot;, &quot;the&quot;, &quot;summer&quot;, &quot;evening.&quot;]</code></li>\n</ul>\n<h3 id=\"5-Keyword-Analyzer\"><a href=\"#5-Keyword-Analyzer\" class=\"headerlink\" title=\"5. Keyword Analyzer\"></a>5. <strong>Keyword Analyzer</strong></h3><p>关键字分析器不进行分词，直接返回原始文本。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;keyword&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;]</code></li>\n</ul>\n<h3 id=\"6-Pattern-Analyzer\"><a href=\"#6-Pattern-Analyzer\" class=\"headerlink\" title=\"6. Pattern Analyzer\"></a>6. <strong>Pattern Analyzer</strong></h3><p>模式分析器使用正则表达式进行分词，默认使用 <code>\\W+</code>（非字母字符）作为分隔符。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;pattern&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;Quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;over&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;in&quot;, &quot;the&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"7-English-Analyzer\"><a href=\"#7-English-Analyzer\" class=\"headerlink\" title=\"7. English Analyzer\"></a>7. <strong>English Analyzer</strong></h3><p>英语分析器针对英语语言进行分词，去除停用词等。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;english&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"8-ICU-Analyzer-for-Chinese-Text\"><a href=\"#8-ICU-Analyzer-for-Chinese-Text\" class=\"headerlink\" title=\"8. ICU Analyzer for Chinese Text\"></a>8. <strong>ICU Analyzer for Chinese Text</strong></h3><p>使用 <code>icu_analyzer</code> 来处理中文文本，适用于多语言环境中的分词。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;icu_analyzer&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;他说的确实在理&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;他说&quot;, &quot;的&quot;, &quot;确实&quot;, &quot;在理&quot;]</code></li>\n</ul>\n<h3 id=\"9-Standard-Analyzer-for-Chinese-Text\"><a href=\"#9-Standard-Analyzer-for-Chinese-Text\" class=\"headerlink\" title=\"9. Standard Analyzer for Chinese Text\"></a>9. <strong>Standard Analyzer for Chinese Text</strong></h3><p>使用标准分析器处理中文文本，通常处理中文时可能不会像中文专用分析器那样精确。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;他说的确实在理&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;他说&quot;, &quot;的&quot;, &quot;确实&quot;, &quot;在理&quot;]</code></li>\n</ul>\n<h3 id=\"10-ICU-Analyzer-for-Another-Chinese-Sentence\"><a href=\"#10-ICU-Analyzer-for-Another-Chinese-Sentence\" class=\"headerlink\" title=\"10. ICU Analyzer for Another Chinese Sentence\"></a>10. <strong>ICU Analyzer for Another Chinese Sentence</strong></h3><p>处理另一个中文句子 <code>&quot;这个苹果不大好吃&quot;</code>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;icu_analyzer&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;这个苹果不大好吃&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;这个&quot;, &quot;苹果&quot;, &quot;不大&quot;, &quot;好吃&quot;]</code></li>\n</ul>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>每种分析器具有不同的分词行为：</p>\n<ul>\n<li><strong>Standard</strong>：根据空格和标点符号分词并小写化。</li>\n<li><strong>Simple</strong>：过滤非字母字符并小写化。</li>\n<li><strong>Stop</strong>：去除停用词并小写化。</li>\n<li><strong>Whitespace</strong>：仅按空格分词，不进行大小写转换。</li>\n<li><strong>Keyword</strong>：不进行分词，返回整个文本。</li>\n<li><strong>Pattern</strong>：使用正则表达式分词，默认 <code>\\W+</code> 分割。</li>\n<li><strong>English</strong>：为英语文本设计的分析器，去除停用词。</li>\n<li><strong>ICU Analyzer</strong>：适合多语言的分词，特别适用于中文等非拉丁字母语言。</li>\n</ul>\n<p>这些分析器可以根据不同的语言和需求来优化索引和搜索。</p>\n<p>以下是您提供的一些 Elasticsearch 查询示例，涵盖了基本查询、带有分析的查询、布尔查询、范围查询、通配符查询、模糊查询等操作。下面是每种查询的详细解释和用法：</p>\n<h3 id=\"1-基本查询\"><a href=\"#1-基本查询\" class=\"headerlink\" title=\"1. 基本查询\"></a>1. <strong>基本查询</strong></h3><p>查询 <code>movies</code> 索引中标题为 <code>2012</code> 的电影，并根据 <code>year</code> 字段降序排序，返回前 10 条结果：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=2012&amp;<span class=\"built_in\">df</span>=title&amp;<span class=\"built_in\">sort</span>=year:desc&amp;from=0&amp;size=10&amp;<span class=\"built_in\">timeout</span>=1s</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>q=2012</code>**：查询内容为 <code>2012</code>。</li>\n<li>**<code>df=title</code>**：指定查询字段为 <code>title</code>。</li>\n<li>**<code>sort=year:desc</code>**：按 <code>year</code> 字段降序排序。</li>\n<li>**<code>from=0&amp;size=10</code>**：分页，返回前 10 条数据。</li>\n<li>**<code>timeout=1s</code>**：查询超时限制为 1 秒。</li>\n</ul>\n<h3 id=\"2-带-Profile-的查询\"><a href=\"#2-带-Profile-的查询\" class=\"headerlink\" title=\"2. 带 Profile 的查询\"></a>2. <strong>带 Profile 的查询</strong></h3><p>启用 <code>profile</code> 可以帮助分析查询性能，查看查询的每个阶段的时间。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=2012&amp;<span class=\"built_in\">df</span>=title</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>&quot;profile&quot;: &quot;true&quot;</code>**：启用查询性能分析。</li>\n</ul>\n<h3 id=\"3-泛查询，对所有字段进行查询\"><a href=\"#3-泛查询，对所有字段进行查询\" class=\"headerlink\" title=\"3. 泛查询，对所有字段进行查询\"></a>3. <strong>泛查询，对所有字段进行查询</strong></h3><p>使用 <code>_all</code> 字段进行泛查询，查询所有字段。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=2012</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>q=2012</code>**：查询所有字段中包含 <code>2012</code> 的数据。</li>\n</ul>\n<h3 id=\"4-指定字段查询\"><a href=\"#4-指定字段查询\" class=\"headerlink\" title=\"4. 指定字段查询\"></a>4. <strong>指定字段查询</strong></h3><p>查询 <code>title</code> 字段中包含 <code>2012</code> 的记录，并按照 <code>year</code> 字段降序排序：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:2012&amp;<span class=\"built_in\">sort</span>=year:desc&amp;from=0&amp;size=10&amp;<span class=\"built_in\">timeout</span>=1s</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>q=title:2012</code>**：指定查询字段为 <code>title</code>，查询内容为 <code>2012</code>。</li>\n</ul>\n<h3 id=\"5-查找美丽心灵\"><a href=\"#5-查找美丽心灵\" class=\"headerlink\" title=\"5. 查找美丽心灵\"></a>5. <strong>查找美丽心灵</strong></h3><p>查询 <code>title</code> 字段包含 <code>&quot;Beautiful Mind&quot;</code> 的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:Beautiful Mind</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-泛查询\"><a href=\"#6-泛查询\" class=\"headerlink\" title=\"6. 泛查询\"></a>6. <strong>泛查询</strong></h3><p>查询 <code>title</code> 字段包含 <code>2012</code> 的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:2012</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-Phrase-查询（短语查询）\"><a href=\"#7-Phrase-查询（短语查询）\" class=\"headerlink\" title=\"7. Phrase 查询（短语查询）\"></a>7. <strong>Phrase 查询（短语查询）</strong></h3><p>查询 <code>title</code> 字段精确匹配 <code>&quot;Beautiful Mind&quot;</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:<span class=\"string\">&quot;Beautiful Mind&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用引号表示精确短语匹配，要求字段内容必须完全匹配短语 <code>&quot;Beautiful Mind&quot;</code>。</li>\n</ul>\n<h3 id=\"8-分组查询（使用括号）\"><a href=\"#8-分组查询（使用括号）\" class=\"headerlink\" title=\"8. 分组查询（使用括号）\"></a>8. <strong>分组查询（使用括号）</strong></h3><p>查询 <code>title</code> 字段中包含 <code>Beautiful Mind</code> 的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:(Beautiful Mind)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用括号可以进行分组查询，类似逻辑上的括号优先级。</li>\n</ul>\n<h3 id=\"9-布尔操作符查询\"><a href=\"#9-布尔操作符查询\" class=\"headerlink\" title=\"9. 布尔操作符查询\"></a>9. <strong>布尔操作符查询</strong></h3><ul>\n<li><strong>AND 查询：</strong><br>查询 <code>title</code> 字段同时包含 <code>Beautiful</code> 和 <code>Mind</code> 的记录：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:(Beautiful AND Mind)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><strong>NOT 查询：</strong><br>查询 <code>title</code> 字段包含 <code>Beautiful</code> 但不包含 <code>Mind</code> 的记录：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:(Beautiful NOT Mind)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><strong>OR 查询：</strong><br>查询 <code>title</code> 字段包含 <code>Beautiful</code> 或 <code>Mind</code> 的记录：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:(Beautiful %2BMind)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"10-范围查询\"><a href=\"#10-范围查询\" class=\"headerlink\" title=\"10. 范围查询\"></a>10. <strong>范围查询</strong></h3><p>查询 <code>title</code> 字段包含 <code>beautiful</code> 且 <code>year</code> 在 2002 到 2018 年之间的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:beautiful AND year:[2002 TO 2018%7D</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>year:[2002 TO 2018]</code>**：指定 <code>year</code> 字段的范围查询。</li>\n</ul>\n<h3 id=\"11-通配符查询\"><a href=\"#11-通配符查询\" class=\"headerlink\" title=\"11. 通配符查询\"></a>11. <strong>通配符查询</strong></h3><p>查询 <code>title</code> 字段以 <code>b</code> 开头的所有记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:b*</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>b*</code>**：使用通配符查询以 <code>b</code> 开头的字符串。</li>\n</ul>\n<h3 id=\"12-模糊查询-近似度匹配\"><a href=\"#12-模糊查询-近似度匹配\" class=\"headerlink\" title=\"12. 模糊查询 &amp; 近似度匹配\"></a>12. <strong>模糊查询 &amp; 近似度匹配</strong></h3><ul>\n<li><strong>模糊匹配</strong>：查询 <code>title</code> 字段中的词语 <code>beautifl</code>，允许有 1 个字符的错误：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:beautifl~1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><strong>近似度匹配</strong>：查询 <code>title</code> 字段中的短语 <code>&quot;Lord Rings&quot;</code>，允许 2 个字符的误差：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:<span class=\"string\">&quot;Lord Rings&quot;</span>~2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"总结-1\"><a href=\"#总结-1\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这些查询展示了如何使用 Elasticsearch 提供的强大查询能力来根据不同的需求筛选和搜索数据。常见的查询类型包括：</p>\n<ul>\n<li><strong>基本查询</strong>：用于查找单一词汇。</li>\n<li><strong>布尔查询</strong>：组合多个查询条件。</li>\n<li><strong>范围查询</strong>：查找特定范围内的记录。</li>\n<li><strong>通配符查询</strong>：模糊匹配。</li>\n<li><strong>短语查询</strong>：精确匹配整个短语。</li>\n</ul>\n<p>同时，<code>profile</code> 参数可以帮助分析查询性能，优化查询响应。</p>\n<p>3.8-RequestBody与QueryDSL简介</p>\n<p>以下是您提供的 Elasticsearch 查询操作，包括分页、日期排序、源过滤、脚本字段、以及不同的查询类型（如 <code>match</code>、<code>match_phrase</code>）。这些操作展示了如何在 Elasticsearch 中进行更精细的查询和数据处理。</p>\n<h3 id=\"1-忽略不存在的索引（ignore-unavailable-true）\"><a href=\"#1-忽略不存在的索引（ignore-unavailable-true）\" class=\"headerlink\" title=\"1. 忽略不存在的索引（ignore_unavailable=true）\"></a>1. <strong>忽略不存在的索引（<code>ignore_unavailable=true</code>）</strong></h3><p>在查询时，如果访问的索引不存在，使用 <code>ignore_unavailable=true</code> 可以避免报错：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /movies,404_idx/_search?ignore_unavailable=<span class=\"literal\">true</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;profile&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>ignore_unavailable=true</code>**：在访问不存在的索引时，忽略错误。</li>\n</ul>\n<h3 id=\"2-分页查询\"><a href=\"#2-分页查询\" class=\"headerlink\" title=\"2. 分页查询\"></a>2. <strong>分页查询</strong></h3><p>查询 <code>kibana_sample_data_ecommerce</code> 索引并分页返回数据（从第 10 条开始，返回 20 条记录）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;from&quot;</span>: 10,</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 20,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong><code>from=10</code></strong> 和 **<code>size=20</code>**：分页，跳过前 10 条，返回接下来的 20 条。</li>\n</ul>\n<h3 id=\"3-日期排序\"><a href=\"#3-日期排序\" class=\"headerlink\" title=\"3. 日期排序\"></a>3. <strong>日期排序</strong></h3><p>按 <code>order_date</code> 字段降序排序：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;sort&quot;</span>: [&#123;<span class=\"string\">&quot;order_date&quot;</span>: <span class=\"string\">&quot;desc&quot;</span>&#125;],</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>sort</code>**：按照 <code>order_date</code> 字段降序排序。</li>\n</ul>\n<h3 id=\"4-源过滤\"><a href=\"#4-源过滤\" class=\"headerlink\" title=\"4. 源过滤\"></a>4. <strong>源过滤</strong></h3><p>只返回文档中的 <code>order_date</code> 字段，不返回其他字段：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;_source&quot;</span>: [<span class=\"string\">&quot;order_date&quot;</span>],</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>_source</code>**：指定只返回 <code>order_date</code> 字段的数据。</li>\n</ul>\n<h3 id=\"5-脚本字段\"><a href=\"#5-脚本字段\" class=\"headerlink\" title=\"5. 脚本字段\"></a>5. <strong>脚本字段</strong></h3><p>使用脚本字段计算新的字段（例如，拼接 <code>order_date</code> 和 <code>&quot;hello&quot;</code>）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;script_fields&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;new_field&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;script&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;lang&quot;</span>: <span class=\"string\">&quot;painless&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;source&quot;</span>: <span class=\"string\">&quot;doc[&#x27;order_date&#x27;].value+&#x27;hello&#x27;&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>script_fields</code>**：使用 <code>painless</code> 脚本创建新的字段 <code>new_field</code>，将 <code>order_date</code> 字段与字符串 <code>&quot;hello&quot;</code> 拼接。</li>\n</ul>\n<h3 id=\"6-match-查询\"><a href=\"#6-match-查询\" class=\"headerlink\" title=\"6. match 查询\"></a>6. <strong><code>match</code> 查询</strong></h3><p>查询 <code>movies</code> 索引中 <code>title</code> 字段包含 <code>&quot;last christmas&quot;</code> 的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span>: <span class=\"string\">&quot;last christmas&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>match</code>**：进行标准的全文匹配查询。</li>\n</ul>\n<h3 id=\"7-match-查询并使用-AND-操作符\"><a href=\"#7-match-查询并使用-AND-操作符\" class=\"headerlink\" title=\"7. match 查询并使用 AND 操作符\"></a>7. <strong><code>match</code> 查询并使用 AND 操作符</strong></h3><p>查询 <code>title</code> 包含 <code>&quot;last christmas&quot;</code> 且两个词都必须出现的记录（使用 AND 操作符）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;last christmas&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;operator&quot;</span>: <span class=\"string\">&quot;and&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>operator: &quot;and&quot;</code>**：两个词必须同时出现在字段中。</li>\n</ul>\n<h3 id=\"8-match-phrase-查询（短语匹配）\"><a href=\"#8-match-phrase-查询（短语匹配）\" class=\"headerlink\" title=\"8. match_phrase 查询（短语匹配）\"></a>8. <strong><code>match_phrase</code> 查询（短语匹配）</strong></h3><p>查询 <code>title</code> 字段精确匹配 <code>&quot;one love&quot;</code> 作为一个短语：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_phrase&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;one love&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>match_phrase</code>**：精确匹配整个短语，必须按照指定的顺序。</li>\n</ul>\n<h3 id=\"9-match-phrase-查询并使用-slop\"><a href=\"#9-match-phrase-查询并使用-slop\" class=\"headerlink\" title=\"9. match_phrase 查询并使用 slop\"></a>9. <strong><code>match_phrase</code> 查询并使用 <code>slop</code></strong></h3><p>查询 <code>title</code> 字段中的短语 <code>&quot;one love&quot;</code>，并允许 1 个词语的偏移（即词语可以有一定的顺序变化）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_phrase&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;one love&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;slop&quot;</span>: 1</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>slop: 1</code>**：允许最多 1 个词语的顺序偏移（例如，<code>love one</code> 也可以匹配）。</li>\n</ul>\n<h3 id=\"总结-2\"><a href=\"#总结-2\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这些查询展示了 Elasticsearch 中常用的查询类型：</p>\n<ul>\n<li><strong>分页查询</strong>：使用 <code>from</code> 和 <code>size</code> 来实现分页。</li>\n<li><strong>日期排序</strong>：使用 <code>sort</code> 来对结果进行排序。</li>\n<li><strong>源过滤</strong>：通过 <code>_source</code> 限制返回的字段。</li>\n<li><strong>脚本字段</strong>：使用 <code>painless</code> 脚本来计算新字段。</li>\n<li><strong>布尔操作符</strong>：通过 <code>operator</code> 来定义 <code>match</code> 查询的逻辑。</li>\n<li><strong>短语匹配和偏移</strong>：通过 <code>match_phrase</code> 和 <code>slop</code> 来进行更灵活的查询。</li>\n</ul>\n<p>这些查询可以帮助你在 Elasticsearch 中实现复杂的搜索需求。</p>\n<p>[3.9-QueryString&amp;SimpleQueryString查询]</p>\n<p>以下是您提供的 Elasticsearch 查询操作，涉及到 <code>query_string</code> 和 <code>simple_query_string</code> 查询的使用，以及如何通过不同的字段和操作符执行复杂查询。这里的查询包括布尔操作符、字段匹配、以及指定默认操作符等。</p>\n<h3 id=\"1-向索引添加文档\"><a href=\"#1-向索引添加文档\" class=\"headerlink\" title=\"1. 向索引添加文档\"></a>1. <strong>向索引添加文档</strong></h3><p>首先，向 <code>users</code> 索引添加两个用户文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /users/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;Ruan Yiming&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;about&quot;</span>: <span class=\"string\">&quot;java, golang, node, swift, elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /users/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;Li Yiming&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;about&quot;</span>: <span class=\"string\">&quot;Hadoop&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-query-string-查询：查询名称中包含-“Ruan”-和-“Yiming”-的文档\"><a href=\"#2-query-string-查询：查询名称中包含-“Ruan”-和-“Yiming”-的文档\" class=\"headerlink\" title=\"2. query_string 查询：查询名称中包含 “Ruan” 和 “Yiming” 的文档\"></a>2. <strong><code>query_string</code> 查询：查询名称中包含 “Ruan” 和 “Yiming” 的文档</strong></h3><p>使用 <code>query_string</code> 查询，指定默认字段为 <code>name</code>，查询条件为 <code>&quot;Ruan AND Yiming&quot;</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;default_field&quot;</span>: <span class=\"string\">&quot;name&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Ruan AND Yiming&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>query_string</code>**：用于执行复杂的查询，可以使用逻辑操作符（如 AND、OR）。</li>\n</ul>\n<h3 id=\"3-query-string-查询：多个字段和复杂查询\"><a href=\"#3-query-string-查询：多个字段和复杂查询\" class=\"headerlink\" title=\"3. query_string 查询：多个字段和复杂查询\"></a>3. <strong><code>query_string</code> 查询：多个字段和复杂查询</strong></h3><p>查询名称或简介字段包含 <code>&quot;Ruan AND Yiming&quot;</code> 或 <code>&quot;Java AND Elasticsearch&quot;</code> 的文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;name&quot;</span>, <span class=\"string\">&quot;about&quot;</span>],</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;(Ruan AND Yiming) OR (Java AND Elasticsearch)&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>fields</code>**：可以指定多个字段进行查询。</li>\n<li>**<code>query</code>**：包含布尔操作符（如 AND、OR）。</li>\n</ul>\n<h3 id=\"4-simple-query-string-查询（默认操作符为-OR）\"><a href=\"#4-simple-query-string-查询（默认操作符为-OR）\" class=\"headerlink\" title=\"4. simple_query_string 查询（默认操作符为 OR）\"></a>4. <strong><code>simple_query_string</code> 查询（默认操作符为 OR）</strong></h3><p>执行一个简单查询，默认操作符为 <code>OR</code>，查询 <code>name</code> 字段中包含 <code>&quot;Ruan&quot;</code> 或 <code>&quot;Yiming&quot;</code> 的文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;simple_query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Ruan AND Yiming&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;name&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>simple_query_string</code>**：适用于较简单的查询，避免了复杂的查询语法。</li>\n</ul>\n<h3 id=\"5-simple-query-string-查询（默认操作符为-AND）\"><a href=\"#5-simple-query-string-查询（默认操作符为-AND）\" class=\"headerlink\" title=\"5. simple_query_string 查询（默认操作符为 AND）\"></a>5. <strong><code>simple_query_string</code> 查询（默认操作符为 AND）</strong></h3><p>查询 <code>name</code> 字段中包含 <code>&quot;Ruan&quot;</code> 且 <code>&quot;Yiming&quot;</code> 的文档，使用 <code>AND</code> 作为默认操作符：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;simple_query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Ruan Yiming&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;name&quot;</span>],</span><br><span class=\"line\">      <span class=\"string\">&quot;default_operator&quot;</span>: <span class=\"string\">&quot;AND&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>default_operator</code>**：设置默认操作符（<code>AND</code> 或 <code>OR</code>）。在此示例中，<code>AND</code> 用于要求 <code>&quot;Ruan&quot;</code> 和 <code>&quot;Yiming&quot;</code> 必须同时出现在 <code>name</code> 字段中。</li>\n</ul>\n<h3 id=\"6-query-string-查询：查询电影标题包含-“Beautiful”-和-“Mind”\"><a href=\"#6-query-string-查询：查询电影标题包含-“Beautiful”-和-“Mind”\" class=\"headerlink\" title=\"6. query_string 查询：查询电影标题包含 “Beautiful” 和 “Mind”\"></a>6. <strong><code>query_string</code> 查询：查询电影标题包含 “Beautiful” 和 “Mind”</strong></h3><p>执行 <code>query_string</code> 查询，查询电影标题中包含 <code>&quot;Beautiful&quot;</code> 和 <code>&quot;Mind&quot;</code> 的文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;profile&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;default_field&quot;</span>: <span class=\"string\">&quot;title&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Beautiful AND Mind&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>query_string</code>**：执行复杂查询，可以使用布尔操作符（如 <code>AND</code>）。</li>\n</ul>\n<h3 id=\"7-query-string-查询：多个字段查询\"><a href=\"#7-query-string-查询：多个字段查询\" class=\"headerlink\" title=\"7. query_string 查询：多个字段查询\"></a>7. <strong><code>query_string</code> 查询：多个字段查询</strong></h3><p>查询电影的 <code>title</code> 或 <code>year</code> 字段包含 <code>&quot;2012&quot;</code> 的文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;profile&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;title&quot;</span>, <span class=\"string\">&quot;year&quot;</span>],</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;2012&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>fields</code>**：指定多个字段进行查询，这里同时查询 <code>title</code> 和 <code>year</code> 字段。</li>\n</ul>\n<h3 id=\"8-simple-query-string-查询：使用-进行短语匹配\"><a href=\"#8-simple-query-string-查询：使用-进行短语匹配\" class=\"headerlink\" title=\"8. simple_query_string 查询：使用 + 进行短语匹配\"></a>8. <strong><code>simple_query_string</code> 查询：使用 <code>+</code> 进行短语匹配</strong></h3><p>查询电影标题中包含 <code>&quot;Beautiful&quot;</code> 和 <code>&quot;mind&quot;</code> 的文档，使用 <code>+</code> 确保两个词都出现在查询中：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;profile&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;simple_query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Beautiful +mind&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;title&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong><code>+</code> 操作符</strong>：用于强制要求某个词出现在查询结果中。</li>\n</ul>\n<hr>\n<h3 id=\"总结-3\"><a href=\"#总结-3\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这些查询展示了如何在 Elasticsearch 中使用不同类型的查询：</p>\n<ul>\n<li><strong><code>query_string</code></strong> 查询：用于执行复杂的查询，可以包含多个字段、布尔操作符（AND、OR、NOT）以及通配符等。</li>\n<li><strong><code>simple_query_string</code></strong> 查询：比 <code>query_string</code> 更简单，适用于不需要复杂语法的查询，并且支持默认操作符的配置。</li>\n<li><strong>字段查询</strong>：可以针对多个字段同时查询，指定多个字段使用 <code>fields</code> 参数。</li>\n<li><strong>布尔操作符</strong>：如 <code>AND</code>、<code>OR</code>、<code>NOT</code>，控制查询的逻辑。</li>\n</ul>\n<p>这些查询方式非常适合处理复杂的检索需求。</p>\n<p>[3.10-DynamicMapping和常见字段类型]</p>\n<p>您的示例展示了如何在 Elasticsearch 中管理映射（Mapping）以及如何处理动态字段和映射更新。以下是总结和解释：</p>\n<h3 id=\"映射和字段定义\"><a href=\"#映射和字段定义\" class=\"headerlink\" title=\"映射和字段定义\"></a><strong>映射和字段定义</strong></h3><p>映射在 Elasticsearch 中类似于关系数据库中的表结构定义，主要用于：</p>\n<ul>\n<li><strong>定义字段的名称</strong>：指定文档中的字段名。</li>\n<li><strong>定义字段的类型</strong>：比如文本（<code>text</code>）、关键字（<code>keyword</code>）、日期（<code>date</code>）等。</li>\n<li><strong>定义倒排索引相关配置</strong>：比如是否需要索引字段，以及字段的 <code>Analyzer</code> 配置。</li>\n</ul>\n<h3 id=\"动态映射（Dynamic-Mapping）\"><a href=\"#动态映射（Dynamic-Mapping）\" class=\"headerlink\" title=\"动态映射（Dynamic Mapping）\"></a><strong>动态映射（Dynamic Mapping）</strong></h3><p>动态映射允许 Elasticsearch 根据新文档自动推断字段的类型。可以通过 <code>dynamic</code> 属性来配置动态行为：</p>\n<ul>\n<li>**<code>true</code>**（默认）：允许新字段自动被索引和映射。</li>\n<li>**<code>false</code>**：禁止自动创建新字段，但已存在字段可以继续使用。</li>\n<li>**<code>strict</code>**：禁止任何新的字段。如果文档包含未定义的字段，将导致错误。</li>\n</ul>\n<h3 id=\"操作演示\"><a href=\"#操作演示\" class=\"headerlink\" title=\"操作演示\"></a><strong>操作演示</strong></h3><ol>\n<li><p><strong>写入文档并查看映射</strong></p>\n<ul>\n<li>向 <code>mapping_test</code> 索引中添加一个文档，查看映射：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT mapping_test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Chan&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Jackie&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;loginDate&quot;</span>: <span class=\"string\">&quot;2018-07-24T10:29:48.103Z&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET mapping_test/_mapping</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>动态映射：推断字段类型</strong></p>\n<ul>\n<li>新字段 <code>uid</code>, <code>isVip</code>, <code>age</code> 等被自动推断并加入映射：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT mapping_test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;uid&quot;</span>: <span class=\"string\">&quot;123&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;isVip&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;isAdmin&quot;</span>: <span class=\"string\">&quot;true&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;age&quot;</span>: 19,</span><br><span class=\"line\">  <span class=\"string\">&quot;height&quot;</span>: 180</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET mapping_test/_mapping</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>新增字段（默认动态）</strong></p>\n<ul>\n<li>如果动态映射为 <code>true</code>（默认），可以动态添加新的字段：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT dynamic_mapping_test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;newField&quot;</span>: <span class=\"string\">&quot;someValue&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST dynamic_mapping_test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;newField&quot;</span>: <span class=\"string\">&quot;someValue&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>修改动态设置为 <code>false</code></strong></p>\n<ul>\n<li>修改 <code>dynamic</code> 设置为 <code>false</code>，禁止自动推断新字段：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT dynamic_mapping_test/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;dynamic&quot;</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT dynamic_mapping_test/_doc/10</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;anotherField&quot;</span>: <span class=\"string\">&quot;someValue&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST dynamic_mapping_test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;anotherField&quot;</span>: <span class=\"string\">&quot;someValue&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>在此示例中，<code>anotherField</code> 将不会被索引或搜索，因为动态映射已设置为 <code>false</code>。</p>\n</li>\n<li><p><strong>修改为 <code>strict</code> 模式</strong></p>\n<ul>\n<li>如果将 <code>dynamic</code> 设置为 <code>strict</code>，任何新的字段都会导致错误：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT dynamic_mapping_test/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;dynamic&quot;</span>: <span class=\"string\">&quot;strict&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT dynamic_mapping_test/_doc/12</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;lastField&quot;</span>: <span class=\"string\">&quot;value&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n此时，写入新字段 <code>lastField</code> 会导致错误，HTTP 返回 <code>400</code> 错误码。</li>\n</ul>\n</li>\n<li><p><strong>删除索引</strong></p>\n<ul>\n<li>删除索引：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE dynamic_mapping_test</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"总结-4\"><a href=\"#总结-4\" class=\"headerlink\" title=\"总结\"></a><strong>总结</strong></h3><ul>\n<li><strong>动态映射（Dynamic Mapping）</strong>：允许 Elasticsearch 自动推断并添加新的字段，方便快速处理未知数据。</li>\n<li><strong><code>dynamic</code> 配置</strong>：控制是否允许 Elasticsearch 自动映射新字段：<ul>\n<li><code>true</code>：默认允许动态字段；</li>\n<li><code>false</code>：禁止自动映射新字段；</li>\n<li><code>strict</code>：禁止所有未知字段，如果有未定义字段则会报错。</li>\n</ul>\n</li>\n<li><strong>更改映射</strong>：映射一旦建立后不能直接修改字段类型，要修改字段配置或添加新字段需要使用 <code>reindex</code> 操作。</li>\n</ul>\n<p>这些操作有助于管理索引和字段的生命周期，确保数据能够根据业务需求灵活适应。</p>\n<p>您的示例展示了 Elasticsearch 中显式设置映射（Mapping）的一些常见操作和参数。以下是各个设置项的详细介绍和使用案例。</p>\n<h3 id=\"1-index-false-设置\"><a href=\"#1-index-false-设置\" class=\"headerlink\" title=\"1. index: false 设置\"></a><strong>1. <code>index: false</code> 设置</strong></h3><p>通过设置字段的 <code>index: false</code>，可以阻止某些字段被索引。这样可以避免该字段参与倒排索引，也不会进行搜索。</p>\n<p><strong>示例</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;firstName&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;lastName&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;mobile&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;index&quot;</span>: <span class=\"literal\">false</span>  <span class=\"comment\"># 禁止索引该字段</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Ruan&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Yiming&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;mobile&quot;</span>: <span class=\"string\">&quot;12345678&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;mobile&quot;</span>: <span class=\"string\">&quot;12345678&quot;</span>  <span class=\"comment\"># 搜索时不会命中mobile字段</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在上面的示例中，<code>mobile</code> 字段被设置为 <code>index: false</code>，因此无法用于搜索查询。</p>\n<h3 id=\"2-null-value-设置\"><a href=\"#2-null-value-设置\" class=\"headerlink\" title=\"2. null_value 设置\"></a><strong>2. <code>null_value</code> 设置</strong></h3><p>通过设置 <code>null_value</code>，可以在文档中存储 <code>null</code> 值，并用指定的替代值替换 <code>null</code>。这对于查询时需要处理 <code>null</code> 数据特别有用。</p>\n<p><strong>示例</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;firstName&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;lastName&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;mobile&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;null_value&quot;</span>: <span class=\"string\">&quot;NULL&quot;</span>  <span class=\"comment\"># null值替代为&quot;NULL&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Ruan&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Yiming&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;mobile&quot;</span>: null  <span class=\"comment\"># 实际值是null</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Ruan2&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Yiming2&quot;</span>  <span class=\"comment\"># 没有mobile字段</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;mobile&quot;</span>: <span class=\"string\">&quot;NULL&quot;</span>  <span class=\"comment\"># 搜索时会匹配到null值字段</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此设置可以确保查询时用 <code>NULL</code> 代替存储的 <code>null</code> 值。</p>\n<h3 id=\"3-copy-to-设置\"><a href=\"#3-copy-to-设置\" class=\"headerlink\" title=\"3. copy_to 设置\"></a><strong>3. <code>copy_to</code> 设置</strong></h3><p><code>copy_to</code> 可以将多个字段的内容复制到另一个字段，方便进行联合查询或索引。</p>\n<p><strong>示例</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;firstName&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;copy_to&quot;</span>: <span class=\"string\">&quot;fullName&quot;</span>  <span class=\"comment\"># 将firstName复制到fullName字段</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;lastName&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;copy_to&quot;</span>: <span class=\"string\">&quot;fullName&quot;</span>  <span class=\"comment\"># 将lastName复制到fullName字段</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Ruan&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Yiming&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET <span class=\"built_in\">users</span>/_search?q=fullName:(Ruan Yiming)</span><br><span class=\"line\"></span><br><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;fullName&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Ruan Yiming&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;operator&quot;</span>: <span class=\"string\">&quot;and&quot;</span>  <span class=\"comment\"># 联合查询fullName字段</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里，<code>firstName</code> 和 <code>lastName</code> 字段的内容会被复制到 <code>fullName</code> 字段，从而使得查询变得更加方便。</p>\n<h3 id=\"4-数组类型处理\"><a href=\"#4-数组类型处理\" class=\"headerlink\" title=\"4. 数组类型处理\"></a><strong>4. 数组类型处理</strong></h3><p>Elasticsearch 支持数组字段。数组中的每个元素会被视为一个单独的值，这对于多值字段非常有用。</p>\n<p><strong>示例</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;onebird&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;interests&quot;</span>: <span class=\"string\">&quot;reading&quot;</span>  <span class=\"comment\"># 字段为单一值</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;twobirds&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;interests&quot;</span>: [<span class=\"string\">&quot;reading&quot;</span>, <span class=\"string\">&quot;music&quot;</span>]  <span class=\"comment\"># 字段为数组</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET <span class=\"built_in\">users</span>/_mapping</span><br></pre></td></tr></table></figure>\n<p>在此示例中，<code>interests</code> 字段既可以是单个值也可以是数组，Elasticsearch 会将每个数组元素视为独立的值进行索引。</p>\n<hr>\n<h3 id=\"总结常见的-Mapping-参数\"><a href=\"#总结常见的-Mapping-参数\" class=\"headerlink\" title=\"总结常见的 Mapping 参数\"></a><strong>总结常见的 Mapping 参数</strong></h3><ul>\n<li><strong><code>type</code></strong>: 字段的数据类型，如 <code>text</code>, <code>keyword</code>, <code>date</code> 等。</li>\n<li><strong><code>index</code></strong>: 控制是否索引该字段，<code>false</code> 表示不索引，默认为 <code>true</code>。</li>\n<li><strong><code>null_value</code></strong>: 控制 <code>null</code> 值的替代值。可以设置为任何替代值，如 <code>&quot;NULL&quot;</code>。</li>\n<li><strong><code>copy_to</code></strong>: 将多个字段的内容复制到一个目标字段中，便于联合查询。</li>\n<li><strong><code>dynamic</code></strong>: 控制动态映射，<code>true</code> 表示允许自动推断新字段，<code>false</code> 表示禁止新字段自动映射，<code>strict</code> 则表示严格模式下不允许任何新字段。</li>\n</ul>\n<p>通过这些映射设置，可以更好地控制数据如何存储和索引，以及如何在查询时处理和优化字段。</p>\n<p>您的示例展示了 Elasticsearch 中关于多字段特性以及自定义分析器（Analyzer）的配置。以下是对各个分析器和相关配置的详细解释。</p>\n<h3 id=\"1-自定义-Analyzer-和-Char-Filter\"><a href=\"#1-自定义-Analyzer-和-Char-Filter\" class=\"headerlink\" title=\"1. 自定义 Analyzer 和 Char Filter\"></a><strong>1. 自定义 Analyzer 和 Char Filter</strong></h3><p>Elasticsearch 提供了灵活的机制来配置分词器（Tokenizer）和字符过滤器（Char Filter）。这些配置用于在索引和搜索过程中控制文本的处理方式。</p>\n<h4 id=\"自定义-Tokenizer-和-Char-Filter-示例\"><a href=\"#自定义-Tokenizer-和-Char-Filter-示例\" class=\"headerlink\" title=\"自定义 Tokenizer 和 Char Filter 示例\"></a><strong>自定义 Tokenizer 和 Char Filter 示例</strong></h4><ul>\n<li><strong>Keyword Tokenizer</strong>: <code>keyword</code> tokenizer 将整个文本当作一个单独的 token 进行处理。</li>\n<li><strong>HTML Strip Char Filter</strong>: <code>html_strip</code> char filter 用于从文本中去除 HTML 标签。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;keyword&quot;</span>,  <span class=\"comment\"># 使用关键词分词器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;char_filter&quot;</span>: [<span class=\"string\">&quot;html_strip&quot;</span>],  <span class=\"comment\"># 使用html_strip字符过滤器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;&lt;b&gt;hello world&lt;/b&gt;&quot;</span>  <span class=\"comment\"># 输入带有HTML标签的文本</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出将会是：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hello world&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">3</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>此配置移除了文本中的 <code>&lt;b&gt;&lt;/b&gt;</code> HTML 标签，只保留了纯文本 “hello world”。</p>\n<h4 id=\"Path-Hierarchy-Tokenizer\"><a href=\"#Path-Hierarchy-Tokenizer\" class=\"headerlink\" title=\"Path Hierarchy Tokenizer\"></a><strong>Path Hierarchy Tokenizer</strong></h4><p><code>path_hierarchy</code> tokenizer 用于处理文件路径等层级结构的数据，将路径按分隔符（如 <code>/</code>）切割。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;path_hierarchy&quot;</span>,  <span class=\"comment\"># 使用路径层级分词器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;/user/ymruan/a/b/c/d/e&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出会将路径按 <code>/</code> 切分：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/user/ymruan/a/b/c/d/e&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">21</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/user/ymruan/a/b/c/d&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">16</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-Char-Filter-替换符号\"><a href=\"#2-Char-Filter-替换符号\" class=\"headerlink\" title=\"2. Char Filter 替换符号\"></a><strong>2. Char Filter 替换符号</strong></h3><p>字符过滤器可以用于替换文本中的特定符号或字符。例如，使用 <code>mapping</code> 类型的 <code>char_filter</code>，可以替换文本中的字符（如将 <code>-</code> 替换为 <code>_</code>）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,  <span class=\"comment\"># 使用标准分词器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;char_filter&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;mapping&quot;</span>,  <span class=\"comment\"># 使用字符映射过滤器</span></span><br><span class=\"line\">      <span class=\"string\">&quot;mappings&quot;</span>: [<span class=\"string\">&quot;- =&gt; _&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;123-456, I-test! test-990 650-555-1234&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此配置将文本中的 <code>-</code> 替换为 <code>_</code>，输出将是：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;123_456&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">7</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-Char-Filter-替换表情符号\"><a href=\"#3-Char-Filter-替换表情符号\" class=\"headerlink\" title=\"3. Char Filter 替换表情符号\"></a><strong>3. Char Filter 替换表情符号</strong></h3><p>你还可以使用字符过滤器将表情符号替换为特定的文本（如将 <code>:)</code> 替换为 <code>happy</code>，<code>:(</code> 替换为 <code>sad</code>）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;char_filter&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;mapping&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;mappings&quot;</span>: [<span class=\"string\">&quot;:) =&gt; happy&quot;</span>, <span class=\"string\">&quot;:( =&gt; sad&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: [<span class=\"string\">&quot;I am felling :)&quot;</span>, <span class=\"string\">&quot;Feeling :( today&quot;</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;I&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;am&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">4</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;felling&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">12</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;happy&quot;</span><span class=\"punctuation\">,</span>  # 替换表情符号<span class=\"punctuation\">:</span>) 为 happy</span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">13</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">18</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">3</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-使用-Stop-和-Snowball-过滤器\"><a href=\"#4-使用-Stop-和-Snowball-过滤器\" class=\"headerlink\" title=\"4. 使用 Stop 和 Snowball 过滤器\"></a><strong>4. 使用 Stop 和 Snowball 过滤器</strong></h3><p>使用 <code>stop</code> 过滤器来删除常见的停用词，使用 <code>snowball</code> 过滤器进行词干提取（如将 “playing” 转换为 “play”）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;whitespace&quot;</span>,  <span class=\"comment\"># 使用空格分词器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;filter&quot;</span>: [<span class=\"string\">&quot;stop&quot;</span>, <span class=\"string\">&quot;snowball&quot;</span>],  <span class=\"comment\"># 使用停用词和词干提取</span></span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: [<span class=\"string\">&quot;The girls in China are playing this game!&quot;</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;girl&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">4</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">9</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;china&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">14</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">19</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-正则表达式替换\"><a href=\"#5-正则表达式替换\" class=\"headerlink\" title=\"5. 正则表达式替换\"></a><strong>5. 正则表达式替换</strong></h3><p>通过 <code>pattern_replace</code> 字符过滤器，您可以根据正则表达式来替换文本中的特定部分。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;char_filter&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;pattern_replace&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;pattern&quot;</span>: <span class=\"string\">&quot;http://(.*)&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;replacement&quot;</span>: <span class=\"string\">&quot;<span class=\"variable\">$1</span>&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;http://www.elastic.co&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此配置将 <code>http://</code> 替换为一个空字符串，结果为：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;www.elastic.co&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">7</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">23</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结：\"><a href=\"#总结：\" class=\"headerlink\" title=\"总结：\"></a><strong>总结：</strong></h3><ul>\n<li><strong>Tokenizer</strong>: 负责将输入文本切割成词条（token）。如 <code>keyword</code>, <code>standard</code>, <code>path_hierarchy</code>。</li>\n<li><strong>Char Filter</strong>: 处理文本中的字符替换、去除特殊符号或HTML标签等，如 <code>html_strip</code>, <code>mapping</code>, <code>pattern_replace</code>。</li>\n<li><strong>Filter</strong>: 用于文本处理，如去除停用词（<code>stop</code>）或词干提取（<code>snowball</code>）。</li>\n</ul>\n<p>这些工具的组合允许您灵活地处理和分析文本数据，并针对特定的业务需求优化索引和搜索行为。</p>\n<p>在 Elasticsearch 中，<strong>Index Templates</strong> 和 <strong>Dynamic Templates</strong> 是两种强大的工具，用于控制如何定义和管理索引的映射和设置。以下是这两者的详细解释和示例。</p>\n<h3 id=\"1-Index-Templates-索引模板\"><a href=\"#1-Index-Templates-索引模板\" class=\"headerlink\" title=\"1. Index Templates (索引模板)\"></a><strong>1. Index Templates (索引模板)</strong></h3><p><strong>Index Templates</strong> 是一种配置模板，用于为匹配特定模式的索引自动配置设置、映射和其他配置。当创建一个新索引时，如果该索引匹配模板中的 <code>index_patterns</code> 配置，模板中的设置、映射和其他配置就会自动应用到新索引上。</p>\n<h4 id=\"创建默认模板\"><a href=\"#创建默认模板\" class=\"headerlink\" title=\"创建默认模板\"></a><strong>创建默认模板</strong></h4><p>下面是创建一个默认模板的示例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _template/template_default</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;index_patterns&quot;</span>: [<span class=\"string\">&quot;*&quot;</span>],  <span class=\"comment\"># 匹配所有索引</span></span><br><span class=\"line\">  <span class=\"string\">&quot;order&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;version&quot;</span>: 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_shards&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这会为所有索引设置一个模板，其中包含分片数量为1、副本数量为1。</p>\n<h4 id=\"为特定模式创建模板\"><a href=\"#为特定模式创建模板\" class=\"headerlink\" title=\"为特定模式创建模板\"></a><strong>为特定模式创建模板</strong></h4><p>另一个例子是为 <code>test*</code> 开头的索引创建模板：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /_template/template_test</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;index_patterns&quot;</span>: [<span class=\"string\">&quot;test*&quot;</span>],  <span class=\"comment\"># 匹配所有以test开头的索引</span></span><br><span class=\"line\">  <span class=\"string\">&quot;order&quot;</span>: 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_shards&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 2</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;date_detection&quot;</span>: <span class=\"literal\">false</span>,  <span class=\"comment\"># 禁止自动检测日期字段</span></span><br><span class=\"line\">    <span class=\"string\">&quot;numeric_detection&quot;</span>: <span class=\"literal\">true</span>  <span class=\"comment\"># 自动检测数字字段</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查看模板\"><a href=\"#查看模板\" class=\"headerlink\" title=\"查看模板\"></a><strong>查看模板</strong></h4><p>你可以查看已定义的模板：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_template/template_default</span><br><span class=\"line\">GET /_template/temp*  <span class=\"comment\"># 查看所有模板</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"删除模板\"><a href=\"#删除模板\" class=\"headerlink\" title=\"删除模板\"></a><strong>删除模板</strong></h4><p>删除模板的命令如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE /_template/template_default</span><br><span class=\"line\">DELETE /_template/template_test</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"2-Dynamic-Templates-动态模板\"><a href=\"#2-Dynamic-Templates-动态模板\" class=\"headerlink\" title=\"2. Dynamic Templates (动态模板)\"></a><strong>2. Dynamic Templates (动态模板)</strong></h3><p><strong>Dynamic Templates</strong> 用于在创建索引时自动匹配字段类型和名称，根据这些动态模板来生成字段的映射规则。可以根据字段的类型（例如字符串、数字）和字段名称（例如以某些字符开头的字段）来定义映射。</p>\n<h4 id=\"自动映射数字字符串和日期字符串\"><a href=\"#自动映射数字字符串和日期字符串\" class=\"headerlink\" title=\"自动映射数字字符串和日期字符串\"></a><strong>自动映射数字字符串和日期字符串</strong></h4><p>例如，数字字符串会被映射为 <code>text</code> 类型，日期字符串会被映射为日期类型：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT ttemplate/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;someNumber&quot;</span>: <span class=\"string\">&quot;1&quot;</span>,        <span class=\"comment\"># 字符串数字</span></span><br><span class=\"line\">  <span class=\"string\">&quot;someDate&quot;</span>: <span class=\"string\">&quot;2019/01/01&quot;</span>  <span class=\"comment\"># 字符串日期</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">GET ttemplate/_mapping</span><br></pre></td></tr></table></figure>\n<p>在这个例子中，<code>someNumber</code> 会被映射成 <code>text</code> 类型，而 <code>someDate</code> 会被映射成 <code>date</code> 类型。</p>\n<h4 id=\"定义动态模板映射规则\"><a href=\"#定义动态模板映射规则\" class=\"headerlink\" title=\"定义动态模板映射规则\"></a><strong>定义动态模板映射规则</strong></h4><p>使用 <code>dynamic_templates</code> 可以根据字段类型和名称定义映射。例如，以下动态模板将以 <code>is*</code> 开头的字符串字段映射为 <code>boolean</code> 类型，其他字符串字段映射为 <code>keyword</code> 类型：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE my_index</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;dynamic_templates&quot;</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;strings_as_boolean&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;match_mapping_type&quot;</span>: <span class=\"string\">&quot;string&quot;</span>,   <span class=\"comment\"># 匹配所有字符串类型</span></span><br><span class=\"line\">          <span class=\"string\">&quot;match&quot;</span>: <span class=\"string\">&quot;is*&quot;</span>,  <span class=\"comment\"># 字段名称以is开头</span></span><br><span class=\"line\">          <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;boolean&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;strings_as_keywords&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;match_mapping_type&quot;</span>: <span class=\"string\">&quot;string&quot;</span>,   <span class=\"comment\"># 匹配所有字符串类型</span></span><br><span class=\"line\">          <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个示例中，<code>isVIP</code> 字段会被映射为 <code>boolean</code> 类型，而其他字符串类型的字段则会被映射为 <code>keyword</code> 类型。</p>\n<h4 id=\"结合路径匹配\"><a href=\"#结合路径匹配\" class=\"headerlink\" title=\"结合路径匹配\"></a><strong>结合路径匹配</strong></h4><p>动态模板不仅可以基于字段名称，还可以基于字段的路径。例如，以下模板会将 <code>name.*</code> 路径下的所有字段映射为 <code>text</code> 类型，并将这些字段复制到 <code>full_name</code> 字段中：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;dynamic_templates&quot;</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;full_name&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;path_match&quot;</span>: <span class=\"string\">&quot;name.*&quot;</span>,  <span class=\"comment\"># 匹配name下的所有字段</span></span><br><span class=\"line\">          <span class=\"string\">&quot;path_unmatch&quot;</span>: <span class=\"string\">&quot;*.middle&quot;</span>,  <span class=\"comment\"># 排除middle字段</span></span><br><span class=\"line\">          <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;copy_to&quot;</span>: <span class=\"string\">&quot;full_name&quot;</span>  <span class=\"comment\"># 将值复制到full_name字段</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后，插入以下数据：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT my_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;first&quot;</span>: <span class=\"string\">&quot;John&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;middle&quot;</span>: <span class=\"string\">&quot;Winston&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;last&quot;</span>: <span class=\"string\">&quot;Lennon&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在这个例子中，<code>first</code> 和 <code>last</code> 字段将被映射为 <code>text</code> 类型，并且它们的内容会被复制到 <code>full_name</code> 字段中。</p>\n<h4 id=\"搜索字段\"><a href=\"#搜索字段\" class=\"headerlink\" title=\"搜索字段\"></a><strong>搜索字段</strong></h4><p>可以通过 <code>full_name</code> 字段来搜索：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET my_index/_search?q=full_name:John</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"总结：-1\"><a href=\"#总结：-1\" class=\"headerlink\" title=\"总结：\"></a><strong>总结：</strong></h3><ul>\n<li><strong>Index Templates</strong> 是为匹配特定索引模式（<code>index_patterns</code>）的所有索引自动配置设置和映射的模板。</li>\n<li><strong>Dynamic Templates</strong> 用于根据字段类型和字段名称自动映射索引字段。你可以根据字段类型（如 <code>string</code>）或字段路径（如 <code>name.*</code>）来定义映射规则。</li>\n</ul>\n<p>这些配置使得索引的创建和管理更加灵活，可以根据实际数据自动推断和调整映射，从而提高了 Elasticsearch 的可用性和效率。</p>\n<p>Elasticsearch 提供了强大的 <strong>聚合</strong> 功能，用于对数据进行汇总和分析。聚合是 Elasticsearch 搜索的一个核心功能，允许你通过多种方式对数据进行分组、统计、求最大&#x2F;最小值、计算平均值等操作。以下是一些常见的聚合分析操作和示例：</p>\n<h3 id=\"1-基本的聚合分析：按目的地分桶统计\"><a href=\"#1-基本的聚合分析：按目的地分桶统计\" class=\"headerlink\" title=\"1. 基本的聚合分析：按目的地分桶统计\"></a><strong>1. 基本的聚合分析：按目的地分桶统计</strong></h3><p>在这个示例中，我们按航班的目的地（<code>DestCountry</code>）进行分桶统计，查看每个目的地的航班数量：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,  <span class=\"comment\"># 不返回实际的文档数据，只返回聚合结果</span></span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;flight_dest&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;DestCountry&quot;</span>  <span class=\"comment\"># 按目的地国家分桶</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个聚合查询中，<code>terms</code> 聚合用于对 <code>DestCountry</code> 字段的值进行分桶，返回每个目的地国家的航班数量。</p>\n<h3 id=\"2-增加更多统计：平均、最大、最小价格\"><a href=\"#2-增加更多统计：平均、最大、最小价格\" class=\"headerlink\" title=\"2. 增加更多统计：平均、最大、最小价格\"></a><strong>2. 增加更多统计：平均、最大、最小价格</strong></h3><p>你可以在分桶内部添加更多聚合来获取其他统计信息，如每个目的地的平均票价、最高票价和最低票价：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;flight_dest&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;DestCountry&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;AvgTicketPrice&quot;</span>  <span class=\"comment\"># 计算平均票价</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;max_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;max&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;AvgTicketPrice&quot;</span>  <span class=\"comment\"># 计算最高票价</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;min_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;min&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;AvgTicketPrice&quot;</span>  <span class=\"comment\"># 计算最低票价</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个查询中，我们为每个目的地添加了三个聚合：<code>avg_price</code>、<code>max_price</code> 和 <code>min_price</code>，分别计算每个目的地的平均票价、最大票价和最小票价。</p>\n<h3 id=\"3-聚合价格与天气信息：统计与多重聚合\"><a href=\"#3-聚合价格与天气信息：统计与多重聚合\" class=\"headerlink\" title=\"3. 聚合价格与天气信息：统计与多重聚合\"></a><strong>3. 聚合价格与天气信息：统计与多重聚合</strong></h3><p>如果你还想结合天气信息（如 <code>DestWeather</code> 字段）与航班价格统计一起进行聚合，可以使用嵌套聚合：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;flight_dest&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;DestCountry&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;stats_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;stats&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;AvgTicketPrice&quot;</span>  <span class=\"comment\"># 计算票价的多项统计信息</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;weather&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;DestWeather&quot;</span>,  <span class=\"comment\"># 按天气类型分桶</span></span><br><span class=\"line\">            <span class=\"string\">&quot;size&quot;</span>: 5  <span class=\"comment\"># 只返回前5个天气类型</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个示例中，我们不仅计算了每个目的地的票价统计信息（如平均票价、最大票价等），还将天气信息作为另一个 <code>terms</code> 聚合，显示每个目的地的天气类型，并限制返回的天气类型数量为 5 个。</p>\n<hr>\n<h3 id=\"常见的聚合类型：\"><a href=\"#常见的聚合类型：\" class=\"headerlink\" title=\"常见的聚合类型：\"></a><strong>常见的聚合类型：</strong></h3><ul>\n<li><strong><code>terms</code> 聚合</strong>：将文档按某个字段的值进行分桶，常用于统计词频或其他分类数据。</li>\n<li><strong><code>avg</code> 聚合</strong>：计算某个数值字段的平均值。</li>\n<li><strong><code>sum</code> 聚合</strong>：计算某个数值字段的总和。</li>\n<li><strong><code>min</code> 聚合</strong>：返回某个数值字段的最小值。</li>\n<li><strong><code>max</code> 聚合</strong>：返回某个数值字段的最大值。</li>\n<li><strong><code>stats</code> 聚合</strong>：返回字段的统计信息（包括：最小值、最大值、平均值、总和和文档数量）。</li>\n<li><strong><code>date_histogram</code> 聚合</strong>：按日期进行分桶，适用于时间序列数据。</li>\n<li><strong><code>histogram</code> 聚合</strong>：按数值区间进行分桶，常用于数值数据的统计。</li>\n</ul>\n<hr>\n<h3 id=\"相关阅读：\"><a href=\"#相关阅读：\" class=\"headerlink\" title=\"相关阅读：\"></a><strong>相关阅读：</strong></h3><ul>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations.html\">Elasticsearch 聚合文档</a> 详细介绍了各种聚合的使用方式和示例。</li>\n</ul>\n<p>聚合功能非常强大，能帮助你从海量数据中提取有价值的信息，适用于各种数据分析场景。</p>\n","cover":false,"excerpt":"","more":"<p>以下是 Elasticsearch (ES) 常用命令的总结和笔记：</p>\n<h3 id=\"1-查看索引相关信息\"><a href=\"#1-查看索引相关信息\" class=\"headerlink\" title=\"1. 查看索引相关信息\"></a>1. 查看索引相关信息</h3><ul>\n<li><p><strong>查看指定索引的映射信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_ecommerce</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看指定索引的文档总数</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_ecommerce/_count</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看前10条文档</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"2-查看索引状态与信息\"><a href=\"#2-查看索引状态与信息\" class=\"headerlink\" title=\"2. 查看索引状态与信息\"></a>2. 查看索引状态与信息</h3><ul>\n<li><p><strong>查看索引信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices/kibana*?v&amp;s=index</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看状态为绿的索引</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices?v&amp;health=green</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>按文档个数排序查看索引</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices?v&amp;s=docs.count:desc</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看具体的索引字段（健康、主分片、复制分片、文档数等）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices/kibana*?pri&amp;v&amp;h=health,index,pri,rep,docs.count,mt</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看每个索引使用的内存量</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/indices?v&amp;h=i,tm&amp;s=tm:desc</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"3-查看节点信息\"><a href=\"#3-查看节点信息\" class=\"headerlink\" title=\"3. 查看节点信息\"></a>3. 查看节点信息</h3><ul>\n<li><p><strong>查看所有节点信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cat/nodes?v</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看特定节点信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_nodes/es7_01,es7_02</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看节点信息并显示特定字段</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/nodes?v&amp;h=<span class=\"built_in\">id</span>,ip,port,v,m</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"4-查看集群健康状况\"><a href=\"#4-查看集群健康状况\" class=\"headerlink\" title=\"4. 查看集群健康状况\"></a>4. 查看集群健康状况</h3><ul>\n<li><p><strong>查看集群健康状况</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/health</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看集群健康状况，并按分片级别显示</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/health?level=shards</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看特定索引的集群健康状况</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/health/kibana_sample_data_ecommerce,kibana_sample_data_flights</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看特定索引的集群健康状况，并按分片级别显示</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/health/kibana_sample_data_flights?level=shards</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"5-查看集群状态\"><a href=\"#5-查看集群状态\" class=\"headerlink\" title=\"5. 查看集群状态\"></a>5. 查看集群状态</h3><ul>\n<li><strong>查看集群状态</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/state</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"6-查看集群设置\"><a href=\"#6-查看集群设置\" class=\"headerlink\" title=\"6. 查看集群设置\"></a>6. 查看集群设置</h3><ul>\n<li><p><strong>查看集群设置</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/settings</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看集群设置，包括默认设置</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/settings?include_defaults=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"7-查看分片信息\"><a href=\"#7-查看分片信息\" class=\"headerlink\" title=\"7. 查看分片信息\"></a>7. 查看分片信息</h3><ul>\n<li><p><strong>查看集群的所有分片信息</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/shards</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看特定的分片信息（包括状态、主分片&#x2F;副本分片等）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cat/shards?h=index,shard,prirep,state,unassigned.reason</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"1-创建文档\"><a href=\"#1-创建文档\" class=\"headerlink\" title=\"1. 创建文档\"></a>1. 创建文档</h3><ul>\n<li><p><strong>自动生成 <code>_id</code> 创建文档</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;user&quot;</span> : <span class=\"string\">&quot;Mike&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;post_date&quot;</span> : <span class=\"string\">&quot;2019-04-15T14:12:12&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span> : <span class=\"string\">&quot;trying out Kibana&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>指定 ID 创建文档（如果 ID 已存在则报错）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1?op_type=create</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;user&quot;</span> : <span class=\"string\">&quot;Jack&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;post_date&quot;</span> : <span class=\"string\">&quot;2019-05-15T14:12:12&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span> : <span class=\"string\">&quot;trying out Elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>指定 ID 创建文档（如果 ID 已存在则报错）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT <span class=\"built_in\">users</span>/_create/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;user&quot;</span> : <span class=\"string\">&quot;Jack&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;post_date&quot;</span> : <span class=\"string\">&quot;2019-05-15T14:12:12&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span> : <span class=\"string\">&quot;trying out Elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"2-根据-ID-获取文档\"><a href=\"#2-根据-ID-获取文档\" class=\"headerlink\" title=\"2. 根据 ID 获取文档\"></a>2. 根据 ID 获取文档</h3><ul>\n<li><strong>获取指定 ID 的文档</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET <span class=\"built_in\">users</span>/_doc/1</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"3-更新文档\"><a href=\"#3-更新文档\" class=\"headerlink\" title=\"3. 更新文档\"></a>3. 更新文档</h3><ul>\n<li><p><strong>更新指定 ID 的文档（先删除再写入）</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;user&quot;</span> : <span class=\"string\">&quot;Mike&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在原文档上增加字段</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_update/1/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;doc&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;post_date&quot;</span> : <span class=\"string\">&quot;2019-05-15T14:12:12&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;message&quot;</span> : <span class=\"string\">&quot;trying out Elasticsearch&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"4-删除文档\"><a href=\"#4-删除文档\" class=\"headerlink\" title=\"4. 删除文档\"></a>4. 删除文档</h3><ul>\n<li><strong>根据 ID 删除文档</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span>/_doc/1</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"5-批量操作-Bulk-API\"><a href=\"#5-批量操作-Bulk-API\" class=\"headerlink\" title=\"5. 批量操作 (Bulk API)\"></a>5. 批量操作 (Bulk API)</h3><ul>\n<li><strong>执行批量操作</strong><br>第一次执行批量操作：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _bulk</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;index&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;field1&quot;</span> : <span class=\"string\">&quot;value1&quot;</span> &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;delete&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;create&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test2&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;3&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;field1&quot;</span> : <span class=\"string\">&quot;value3&quot;</span> &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;update&quot;</span> : &#123;<span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>&#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;doc&quot;</span> : &#123;<span class=\"string\">&quot;field2&quot;</span> : <span class=\"string\">&quot;value2&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure>\n\n第二次执行批量操作：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _bulk</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;index&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;field1&quot;</span> : <span class=\"string\">&quot;value1&quot;</span> &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;delete&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;create&quot;</span> : &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test2&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;3&quot;</span> &#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;field1&quot;</span> : <span class=\"string\">&quot;value3&quot;</span> &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;update&quot;</span> : &#123;<span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>&#125; &#125;</span><br><span class=\"line\">&#123; <span class=\"string\">&quot;doc&quot;</span> : &#123;<span class=\"string\">&quot;field2&quot;</span> : <span class=\"string\">&quot;value2&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"6-多文档获取-MGET\"><a href=\"#6-多文档获取-MGET\" class=\"headerlink\" title=\"6. 多文档获取 (MGET)\"></a>6. 多文档获取 (MGET)</h3><ul>\n<li><p><strong>获取多个文档</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_mget</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;docs&quot;</span> : [</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span> &#125;,</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span> &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>URI中指定索引</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /test/_mget</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;docs&quot;</span> : [</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span> &#125;,</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span> &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>使用 <code>_source</code> 参数指定返回的字段</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_mget</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;docs&quot;</span> : [</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;_source&quot;</span> : <span class=\"literal\">false</span> &#125;,</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;2&quot;</span>, <span class=\"string\">&quot;_source&quot;</span> : [<span class=\"string\">&quot;field3&quot;</span>, <span class=\"string\">&quot;field4&quot;</span>] &#125;,</span><br><span class=\"line\">    &#123; <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;3&quot;</span>, <span class=\"string\">&quot;_source&quot;</span> : &#123; <span class=\"string\">&quot;include&quot;</span>: [<span class=\"string\">&quot;user&quot;</span>], <span class=\"string\">&quot;exclude&quot;</span>: [<span class=\"string\">&quot;user.location&quot;</span>] &#125; &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"7-多查询操作-MSEARCH\"><a href=\"#7-多查询操作-MSEARCH\" class=\"headerlink\" title=\"7. 多查询操作 (MSEARCH)\"></a>7. 多查询操作 (MSEARCH)</h3><ul>\n<li><strong>执行多个查询</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST kibana_sample_data_ecommerce/_msearch</span><br><span class=\"line\">&#123;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;query&quot;</span> : &#123;<span class=\"string\">&quot;match_all&quot;</span> : &#123;&#125;&#125;,<span class=\"string\">&quot;size&quot;</span>:1&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;index&quot;</span> : <span class=\"string\">&quot;kibana_sample_data_flights&quot;</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;query&quot;</span> : &#123;<span class=\"string\">&quot;match_all&quot;</span> : &#123;&#125;&#125;,<span class=\"string\">&quot;size&quot;</span>:2&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"8-清除测试数据\"><a href=\"#8-清除测试数据\" class=\"headerlink\" title=\"8. 清除测试数据\"></a>8. 清除测试数据</h3><ul>\n<li><strong>删除索引（清除数据）</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span></span><br><span class=\"line\">DELETE <span class=\"built_in\">test</span></span><br><span class=\"line\">DELETE test2</span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>[3.4-倒排索引入门]</p>\n<p>Elasticsearch 的 <code>_analyze</code> API，它用于分析文本，查看在特定分析器下，文本是如何被分词和处理的。下面是每个请求的说明：</p>\n<h3 id=\"1-分析-“Mastering-Elasticsearch”\"><a href=\"#1-分析-“Mastering-Elasticsearch”\" class=\"headerlink\" title=\"1. 分析 “Mastering Elasticsearch”\"></a>1. <strong>分析 “Mastering Elasticsearch”</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;Mastering Elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分析器</strong>：使用默认的 <code>standard</code> 分析器。</li>\n<li><strong>文本</strong>：<code>&quot;Mastering Elasticsearch&quot;</code>。</li>\n<li><strong>预期效果</strong>：<code>standard</code> 分析器会将这段文本分割成单词，通常会根据空格和标点符号进行分词。</li>\n</ul>\n<h3 id=\"2-分析-“Elasticsearch-Server”\"><a href=\"#2-分析-“Elasticsearch-Server”\" class=\"headerlink\" title=\"2. 分析 “Elasticsearch Server”\"></a>2. <strong>分析 “Elasticsearch Server”</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;Elasticsearch Server&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分析器</strong>：同样使用 <code>standard</code> 分析器。</li>\n<li><strong>文本</strong>：<code>&quot;Elasticsearch Server&quot;</code>。</li>\n<li><strong>预期效果</strong>：分析器会分割文本为单词，可能会得到类似于 <code>[&quot;elasticsearch&quot;, &quot;server&quot;]</code> 的分词结果。</li>\n</ul>\n<h3 id=\"3-分析-“Elasticsearch-Essentials”\"><a href=\"#3-分析-“Elasticsearch-Essentials”\" class=\"headerlink\" title=\"3. 分析 “Elasticsearch Essentials”\"></a>3. <strong>分析 “Elasticsearch Essentials”</strong></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;Elasticsearch Essentials&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分析器</strong>：继续使用 <code>standard</code> 分析器。</li>\n<li><strong>文本</strong>：<code>&quot;Elasticsearch Essentials&quot;</code>。</li>\n<li><strong>预期效果</strong>：分析器会将文本分割成 <code>[&quot;elasticsearch&quot;, &quot;essentials&quot;]</code>。</li>\n</ul>\n<h3 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h3><p>每个请求的结果将显示由 <code>standard</code> 分析器生成的分词结果。通常，<code>standard</code> 分析器会去除大部分标点符号并将文本转换为小写。分词的具体结果如下：</p>\n<ul>\n<li><code>&quot;Mastering Elasticsearch&quot;</code> -&gt; <code>[&quot;mastering&quot;, &quot;elasticsearch&quot;]</code></li>\n<li><code>&quot;Elasticsearch Server&quot;</code> -&gt; <code>[&quot;elasticsearch&quot;, &quot;server&quot;]</code></li>\n<li><code>&quot;Elasticsearch Essentials&quot;</code> -&gt; <code>[&quot;elasticsearch&quot;, &quot;essentials&quot;]</code></li>\n</ul>\n<p>以下是使用不同的分析器（Analyzer）对文本进行分词分析的示例：</p>\n<h3 id=\"1-Standard-Analyzer\"><a href=\"#1-Standard-Analyzer\" class=\"headerlink\" title=\"1. Standard Analyzer\"></a>1. <strong>Standard Analyzer</strong></h3><p>标准分析器会根据空格、标点符号等进行分词，并将所有文本转换为小写。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokens&quot;</span> : [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;2&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 0,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 1,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;NUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 0</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;running&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 2,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 9,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 1</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;quick&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 10,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 15,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 2</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;brown&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 16,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 21,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 3</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;foxes&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 22,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 27,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 4</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;leap&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 28,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 32,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 5</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;over&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 33,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 37,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 6</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;lazy&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 38,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 42,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 7</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;dogs&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 43,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 47,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 8</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;in&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 48,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 50,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 9</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;the&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 51,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 54,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 10</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;summer&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 55,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 61,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 11</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;token&quot;</span> : <span class=\"string\">&quot;evening&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;start_offset&quot;</span> : 62,</span><br><span class=\"line\">      <span class=\"string\">&quot;end_offset&quot;</span> : 69,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;position&quot;</span> : 12</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;over&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;in&quot;, &quot;the&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"2-Simple-Analyzer\"><a href=\"#2-Simple-Analyzer\" class=\"headerlink\" title=\"2. Simple Analyzer\"></a>2. <strong>Simple Analyzer</strong></h3><p>简单分析器按非字母字符切分，符号会被过滤，文本会转换为小写。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;simple&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;over&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;in&quot;, &quot;the&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"3-Stop-Analyzer\"><a href=\"#3-Stop-Analyzer\" class=\"headerlink\" title=\"3. Stop Analyzer\"></a>3. <strong>Stop Analyzer</strong></h3><p>停用词分析器会将文本转换为小写，并过滤掉常见的停用词（如 “the”, “a”, “is”）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;stop&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"4-Whitespace-Analyzer\"><a href=\"#4-Whitespace-Analyzer\" class=\"headerlink\" title=\"4. Whitespace Analyzer\"></a>4. <strong>Whitespace Analyzer</strong></h3><p>空格分析器会按空格切分文本，并且不会转换为小写。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;whitespace&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;Quick&quot;, &quot;brown-foxes&quot;, &quot;leap&quot;, &quot;over&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;in&quot;, &quot;the&quot;, &quot;summer&quot;, &quot;evening.&quot;]</code></li>\n</ul>\n<h3 id=\"5-Keyword-Analyzer\"><a href=\"#5-Keyword-Analyzer\" class=\"headerlink\" title=\"5. Keyword Analyzer\"></a>5. <strong>Keyword Analyzer</strong></h3><p>关键字分析器不进行分词，直接返回原始文本。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;keyword&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;]</code></li>\n</ul>\n<h3 id=\"6-Pattern-Analyzer\"><a href=\"#6-Pattern-Analyzer\" class=\"headerlink\" title=\"6. Pattern Analyzer\"></a>6. <strong>Pattern Analyzer</strong></h3><p>模式分析器使用正则表达式进行分词，默认使用 <code>\\W+</code>（非字母字符）作为分隔符。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;pattern&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;Quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;over&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;in&quot;, &quot;the&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"7-English-Analyzer\"><a href=\"#7-English-Analyzer\" class=\"headerlink\" title=\"7. English Analyzer\"></a>7. <strong>English Analyzer</strong></h3><p>英语分析器针对英语语言进行分词，去除停用词等。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;english&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;2&quot;, &quot;running&quot;, &quot;quick&quot;, &quot;brown&quot;, &quot;foxes&quot;, &quot;leap&quot;, &quot;lazy&quot;, &quot;dogs&quot;, &quot;summer&quot;, &quot;evening&quot;]</code></li>\n</ul>\n<h3 id=\"8-ICU-Analyzer-for-Chinese-Text\"><a href=\"#8-ICU-Analyzer-for-Chinese-Text\" class=\"headerlink\" title=\"8. ICU Analyzer for Chinese Text\"></a>8. <strong>ICU Analyzer for Chinese Text</strong></h3><p>使用 <code>icu_analyzer</code> 来处理中文文本，适用于多语言环境中的分词。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;icu_analyzer&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;他说的确实在理&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;他说&quot;, &quot;的&quot;, &quot;确实&quot;, &quot;在理&quot;]</code></li>\n</ul>\n<h3 id=\"9-Standard-Analyzer-for-Chinese-Text\"><a href=\"#9-Standard-Analyzer-for-Chinese-Text\" class=\"headerlink\" title=\"9. Standard Analyzer for Chinese Text\"></a>9. <strong>Standard Analyzer for Chinese Text</strong></h3><p>使用标准分析器处理中文文本，通常处理中文时可能不会像中文专用分析器那样精确。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;他说的确实在理&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;他说&quot;, &quot;的&quot;, &quot;确实&quot;, &quot;在理&quot;]</code></li>\n</ul>\n<h3 id=\"10-ICU-Analyzer-for-Another-Chinese-Sentence\"><a href=\"#10-ICU-Analyzer-for-Another-Chinese-Sentence\" class=\"headerlink\" title=\"10. ICU Analyzer for Another Chinese Sentence\"></a>10. <strong>ICU Analyzer for Another Chinese Sentence</strong></h3><p>处理另一个中文句子 <code>&quot;这个苹果不大好吃&quot;</code>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;analyzer&quot;</span>: <span class=\"string\">&quot;icu_analyzer&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;这个苹果不大好吃&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>分词结果</strong>：<code>[&quot;这个&quot;, &quot;苹果&quot;, &quot;不大&quot;, &quot;好吃&quot;]</code></li>\n</ul>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>每种分析器具有不同的分词行为：</p>\n<ul>\n<li><strong>Standard</strong>：根据空格和标点符号分词并小写化。</li>\n<li><strong>Simple</strong>：过滤非字母字符并小写化。</li>\n<li><strong>Stop</strong>：去除停用词并小写化。</li>\n<li><strong>Whitespace</strong>：仅按空格分词，不进行大小写转换。</li>\n<li><strong>Keyword</strong>：不进行分词，返回整个文本。</li>\n<li><strong>Pattern</strong>：使用正则表达式分词，默认 <code>\\W+</code> 分割。</li>\n<li><strong>English</strong>：为英语文本设计的分析器，去除停用词。</li>\n<li><strong>ICU Analyzer</strong>：适合多语言的分词，特别适用于中文等非拉丁字母语言。</li>\n</ul>\n<p>这些分析器可以根据不同的语言和需求来优化索引和搜索。</p>\n<p>以下是您提供的一些 Elasticsearch 查询示例，涵盖了基本查询、带有分析的查询、布尔查询、范围查询、通配符查询、模糊查询等操作。下面是每种查询的详细解释和用法：</p>\n<h3 id=\"1-基本查询\"><a href=\"#1-基本查询\" class=\"headerlink\" title=\"1. 基本查询\"></a>1. <strong>基本查询</strong></h3><p>查询 <code>movies</code> 索引中标题为 <code>2012</code> 的电影，并根据 <code>year</code> 字段降序排序，返回前 10 条结果：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=2012&amp;<span class=\"built_in\">df</span>=title&amp;<span class=\"built_in\">sort</span>=year:desc&amp;from=0&amp;size=10&amp;<span class=\"built_in\">timeout</span>=1s</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>q=2012</code>**：查询内容为 <code>2012</code>。</li>\n<li>**<code>df=title</code>**：指定查询字段为 <code>title</code>。</li>\n<li>**<code>sort=year:desc</code>**：按 <code>year</code> 字段降序排序。</li>\n<li>**<code>from=0&amp;size=10</code>**：分页，返回前 10 条数据。</li>\n<li>**<code>timeout=1s</code>**：查询超时限制为 1 秒。</li>\n</ul>\n<h3 id=\"2-带-Profile-的查询\"><a href=\"#2-带-Profile-的查询\" class=\"headerlink\" title=\"2. 带 Profile 的查询\"></a>2. <strong>带 Profile 的查询</strong></h3><p>启用 <code>profile</code> 可以帮助分析查询性能，查看查询的每个阶段的时间。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=2012&amp;<span class=\"built_in\">df</span>=title</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>&quot;profile&quot;: &quot;true&quot;</code>**：启用查询性能分析。</li>\n</ul>\n<h3 id=\"3-泛查询，对所有字段进行查询\"><a href=\"#3-泛查询，对所有字段进行查询\" class=\"headerlink\" title=\"3. 泛查询，对所有字段进行查询\"></a>3. <strong>泛查询，对所有字段进行查询</strong></h3><p>使用 <code>_all</code> 字段进行泛查询，查询所有字段。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=2012</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>q=2012</code>**：查询所有字段中包含 <code>2012</code> 的数据。</li>\n</ul>\n<h3 id=\"4-指定字段查询\"><a href=\"#4-指定字段查询\" class=\"headerlink\" title=\"4. 指定字段查询\"></a>4. <strong>指定字段查询</strong></h3><p>查询 <code>title</code> 字段中包含 <code>2012</code> 的记录，并按照 <code>year</code> 字段降序排序：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:2012&amp;<span class=\"built_in\">sort</span>=year:desc&amp;from=0&amp;size=10&amp;<span class=\"built_in\">timeout</span>=1s</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>q=title:2012</code>**：指定查询字段为 <code>title</code>，查询内容为 <code>2012</code>。</li>\n</ul>\n<h3 id=\"5-查找美丽心灵\"><a href=\"#5-查找美丽心灵\" class=\"headerlink\" title=\"5. 查找美丽心灵\"></a>5. <strong>查找美丽心灵</strong></h3><p>查询 <code>title</code> 字段包含 <code>&quot;Beautiful Mind&quot;</code> 的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:Beautiful Mind</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-泛查询\"><a href=\"#6-泛查询\" class=\"headerlink\" title=\"6. 泛查询\"></a>6. <strong>泛查询</strong></h3><p>查询 <code>title</code> 字段包含 <code>2012</code> 的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:2012</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-Phrase-查询（短语查询）\"><a href=\"#7-Phrase-查询（短语查询）\" class=\"headerlink\" title=\"7. Phrase 查询（短语查询）\"></a>7. <strong>Phrase 查询（短语查询）</strong></h3><p>查询 <code>title</code> 字段精确匹配 <code>&quot;Beautiful Mind&quot;</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:<span class=\"string\">&quot;Beautiful Mind&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用引号表示精确短语匹配，要求字段内容必须完全匹配短语 <code>&quot;Beautiful Mind&quot;</code>。</li>\n</ul>\n<h3 id=\"8-分组查询（使用括号）\"><a href=\"#8-分组查询（使用括号）\" class=\"headerlink\" title=\"8. 分组查询（使用括号）\"></a>8. <strong>分组查询（使用括号）</strong></h3><p>查询 <code>title</code> 字段中包含 <code>Beautiful Mind</code> 的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:(Beautiful Mind)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用括号可以进行分组查询，类似逻辑上的括号优先级。</li>\n</ul>\n<h3 id=\"9-布尔操作符查询\"><a href=\"#9-布尔操作符查询\" class=\"headerlink\" title=\"9. 布尔操作符查询\"></a>9. <strong>布尔操作符查询</strong></h3><ul>\n<li><strong>AND 查询：</strong><br>查询 <code>title</code> 字段同时包含 <code>Beautiful</code> 和 <code>Mind</code> 的记录：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:(Beautiful AND Mind)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><strong>NOT 查询：</strong><br>查询 <code>title</code> 字段包含 <code>Beautiful</code> 但不包含 <code>Mind</code> 的记录：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:(Beautiful NOT Mind)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><strong>OR 查询：</strong><br>查询 <code>title</code> 字段包含 <code>Beautiful</code> 或 <code>Mind</code> 的记录：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:(Beautiful %2BMind)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"10-范围查询\"><a href=\"#10-范围查询\" class=\"headerlink\" title=\"10. 范围查询\"></a>10. <strong>范围查询</strong></h3><p>查询 <code>title</code> 字段包含 <code>beautiful</code> 且 <code>year</code> 在 2002 到 2018 年之间的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:beautiful AND year:[2002 TO 2018%7D</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>year:[2002 TO 2018]</code>**：指定 <code>year</code> 字段的范围查询。</li>\n</ul>\n<h3 id=\"11-通配符查询\"><a href=\"#11-通配符查询\" class=\"headerlink\" title=\"11. 通配符查询\"></a>11. <strong>通配符查询</strong></h3><p>查询 <code>title</code> 字段以 <code>b</code> 开头的所有记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:b*</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>b*</code>**：使用通配符查询以 <code>b</code> 开头的字符串。</li>\n</ul>\n<h3 id=\"12-模糊查询-近似度匹配\"><a href=\"#12-模糊查询-近似度匹配\" class=\"headerlink\" title=\"12. 模糊查询 &amp; 近似度匹配\"></a>12. <strong>模糊查询 &amp; 近似度匹配</strong></h3><ul>\n<li><strong>模糊匹配</strong>：查询 <code>title</code> 字段中的词语 <code>beautifl</code>，允许有 1 个字符的错误：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:beautifl~1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><strong>近似度匹配</strong>：查询 <code>title</code> 字段中的短语 <code>&quot;Lord Rings&quot;</code>，允许 2 个字符的误差：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search?q=title:<span class=\"string\">&quot;Lord Rings&quot;</span>~2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;profile&quot;</span>:<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"总结-1\"><a href=\"#总结-1\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这些查询展示了如何使用 Elasticsearch 提供的强大查询能力来根据不同的需求筛选和搜索数据。常见的查询类型包括：</p>\n<ul>\n<li><strong>基本查询</strong>：用于查找单一词汇。</li>\n<li><strong>布尔查询</strong>：组合多个查询条件。</li>\n<li><strong>范围查询</strong>：查找特定范围内的记录。</li>\n<li><strong>通配符查询</strong>：模糊匹配。</li>\n<li><strong>短语查询</strong>：精确匹配整个短语。</li>\n</ul>\n<p>同时，<code>profile</code> 参数可以帮助分析查询性能，优化查询响应。</p>\n<p>3.8-RequestBody与QueryDSL简介</p>\n<p>以下是您提供的 Elasticsearch 查询操作，包括分页、日期排序、源过滤、脚本字段、以及不同的查询类型（如 <code>match</code>、<code>match_phrase</code>）。这些操作展示了如何在 Elasticsearch 中进行更精细的查询和数据处理。</p>\n<h3 id=\"1-忽略不存在的索引（ignore-unavailable-true）\"><a href=\"#1-忽略不存在的索引（ignore-unavailable-true）\" class=\"headerlink\" title=\"1. 忽略不存在的索引（ignore_unavailable=true）\"></a>1. <strong>忽略不存在的索引（<code>ignore_unavailable=true</code>）</strong></h3><p>在查询时，如果访问的索引不存在，使用 <code>ignore_unavailable=true</code> 可以避免报错：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /movies,404_idx/_search?ignore_unavailable=<span class=\"literal\">true</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;profile&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>ignore_unavailable=true</code>**：在访问不存在的索引时，忽略错误。</li>\n</ul>\n<h3 id=\"2-分页查询\"><a href=\"#2-分页查询\" class=\"headerlink\" title=\"2. 分页查询\"></a>2. <strong>分页查询</strong></h3><p>查询 <code>kibana_sample_data_ecommerce</code> 索引并分页返回数据（从第 10 条开始，返回 20 条记录）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;from&quot;</span>: 10,</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 20,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong><code>from=10</code></strong> 和 **<code>size=20</code>**：分页，跳过前 10 条，返回接下来的 20 条。</li>\n</ul>\n<h3 id=\"3-日期排序\"><a href=\"#3-日期排序\" class=\"headerlink\" title=\"3. 日期排序\"></a>3. <strong>日期排序</strong></h3><p>按 <code>order_date</code> 字段降序排序：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;sort&quot;</span>: [&#123;<span class=\"string\">&quot;order_date&quot;</span>: <span class=\"string\">&quot;desc&quot;</span>&#125;],</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>sort</code>**：按照 <code>order_date</code> 字段降序排序。</li>\n</ul>\n<h3 id=\"4-源过滤\"><a href=\"#4-源过滤\" class=\"headerlink\" title=\"4. 源过滤\"></a>4. <strong>源过滤</strong></h3><p>只返回文档中的 <code>order_date</code> 字段，不返回其他字段：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;_source&quot;</span>: [<span class=\"string\">&quot;order_date&quot;</span>],</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>_source</code>**：指定只返回 <code>order_date</code> 字段的数据。</li>\n</ul>\n<h3 id=\"5-脚本字段\"><a href=\"#5-脚本字段\" class=\"headerlink\" title=\"5. 脚本字段\"></a>5. <strong>脚本字段</strong></h3><p>使用脚本字段计算新的字段（例如，拼接 <code>order_date</code> 和 <code>&quot;hello&quot;</code>）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;script_fields&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;new_field&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;script&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;lang&quot;</span>: <span class=\"string\">&quot;painless&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;source&quot;</span>: <span class=\"string\">&quot;doc[&#x27;order_date&#x27;].value+&#x27;hello&#x27;&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>script_fields</code>**：使用 <code>painless</code> 脚本创建新的字段 <code>new_field</code>，将 <code>order_date</code> 字段与字符串 <code>&quot;hello&quot;</code> 拼接。</li>\n</ul>\n<h3 id=\"6-match-查询\"><a href=\"#6-match-查询\" class=\"headerlink\" title=\"6. match 查询\"></a>6. <strong><code>match</code> 查询</strong></h3><p>查询 <code>movies</code> 索引中 <code>title</code> 字段包含 <code>&quot;last christmas&quot;</code> 的记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span>: <span class=\"string\">&quot;last christmas&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>match</code>**：进行标准的全文匹配查询。</li>\n</ul>\n<h3 id=\"7-match-查询并使用-AND-操作符\"><a href=\"#7-match-查询并使用-AND-操作符\" class=\"headerlink\" title=\"7. match 查询并使用 AND 操作符\"></a>7. <strong><code>match</code> 查询并使用 AND 操作符</strong></h3><p>查询 <code>title</code> 包含 <code>&quot;last christmas&quot;</code> 且两个词都必须出现的记录（使用 AND 操作符）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;last christmas&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;operator&quot;</span>: <span class=\"string\">&quot;and&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>operator: &quot;and&quot;</code>**：两个词必须同时出现在字段中。</li>\n</ul>\n<h3 id=\"8-match-phrase-查询（短语匹配）\"><a href=\"#8-match-phrase-查询（短语匹配）\" class=\"headerlink\" title=\"8. match_phrase 查询（短语匹配）\"></a>8. <strong><code>match_phrase</code> 查询（短语匹配）</strong></h3><p>查询 <code>title</code> 字段精确匹配 <code>&quot;one love&quot;</code> 作为一个短语：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_phrase&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;one love&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>match_phrase</code>**：精确匹配整个短语，必须按照指定的顺序。</li>\n</ul>\n<h3 id=\"9-match-phrase-查询并使用-slop\"><a href=\"#9-match-phrase-查询并使用-slop\" class=\"headerlink\" title=\"9. match_phrase 查询并使用 slop\"></a>9. <strong><code>match_phrase</code> 查询并使用 <code>slop</code></strong></h3><p>查询 <code>title</code> 字段中的短语 <code>&quot;one love&quot;</code>，并允许 1 个词语的偏移（即词语可以有一定的顺序变化）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_phrase&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;title&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;one love&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;slop&quot;</span>: 1</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>slop: 1</code>**：允许最多 1 个词语的顺序偏移（例如，<code>love one</code> 也可以匹配）。</li>\n</ul>\n<h3 id=\"总结-2\"><a href=\"#总结-2\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这些查询展示了 Elasticsearch 中常用的查询类型：</p>\n<ul>\n<li><strong>分页查询</strong>：使用 <code>from</code> 和 <code>size</code> 来实现分页。</li>\n<li><strong>日期排序</strong>：使用 <code>sort</code> 来对结果进行排序。</li>\n<li><strong>源过滤</strong>：通过 <code>_source</code> 限制返回的字段。</li>\n<li><strong>脚本字段</strong>：使用 <code>painless</code> 脚本来计算新字段。</li>\n<li><strong>布尔操作符</strong>：通过 <code>operator</code> 来定义 <code>match</code> 查询的逻辑。</li>\n<li><strong>短语匹配和偏移</strong>：通过 <code>match_phrase</code> 和 <code>slop</code> 来进行更灵活的查询。</li>\n</ul>\n<p>这些查询可以帮助你在 Elasticsearch 中实现复杂的搜索需求。</p>\n<p>[3.9-QueryString&amp;SimpleQueryString查询]</p>\n<p>以下是您提供的 Elasticsearch 查询操作，涉及到 <code>query_string</code> 和 <code>simple_query_string</code> 查询的使用，以及如何通过不同的字段和操作符执行复杂查询。这里的查询包括布尔操作符、字段匹配、以及指定默认操作符等。</p>\n<h3 id=\"1-向索引添加文档\"><a href=\"#1-向索引添加文档\" class=\"headerlink\" title=\"1. 向索引添加文档\"></a>1. <strong>向索引添加文档</strong></h3><p>首先，向 <code>users</code> 索引添加两个用户文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /users/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;Ruan Yiming&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;about&quot;</span>: <span class=\"string\">&quot;java, golang, node, swift, elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /users/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;Li Yiming&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;about&quot;</span>: <span class=\"string\">&quot;Hadoop&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-query-string-查询：查询名称中包含-“Ruan”-和-“Yiming”-的文档\"><a href=\"#2-query-string-查询：查询名称中包含-“Ruan”-和-“Yiming”-的文档\" class=\"headerlink\" title=\"2. query_string 查询：查询名称中包含 “Ruan” 和 “Yiming” 的文档\"></a>2. <strong><code>query_string</code> 查询：查询名称中包含 “Ruan” 和 “Yiming” 的文档</strong></h3><p>使用 <code>query_string</code> 查询，指定默认字段为 <code>name</code>，查询条件为 <code>&quot;Ruan AND Yiming&quot;</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;default_field&quot;</span>: <span class=\"string\">&quot;name&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Ruan AND Yiming&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>query_string</code>**：用于执行复杂的查询，可以使用逻辑操作符（如 AND、OR）。</li>\n</ul>\n<h3 id=\"3-query-string-查询：多个字段和复杂查询\"><a href=\"#3-query-string-查询：多个字段和复杂查询\" class=\"headerlink\" title=\"3. query_string 查询：多个字段和复杂查询\"></a>3. <strong><code>query_string</code> 查询：多个字段和复杂查询</strong></h3><p>查询名称或简介字段包含 <code>&quot;Ruan AND Yiming&quot;</code> 或 <code>&quot;Java AND Elasticsearch&quot;</code> 的文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;name&quot;</span>, <span class=\"string\">&quot;about&quot;</span>],</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;(Ruan AND Yiming) OR (Java AND Elasticsearch)&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>fields</code>**：可以指定多个字段进行查询。</li>\n<li>**<code>query</code>**：包含布尔操作符（如 AND、OR）。</li>\n</ul>\n<h3 id=\"4-simple-query-string-查询（默认操作符为-OR）\"><a href=\"#4-simple-query-string-查询（默认操作符为-OR）\" class=\"headerlink\" title=\"4. simple_query_string 查询（默认操作符为 OR）\"></a>4. <strong><code>simple_query_string</code> 查询（默认操作符为 OR）</strong></h3><p>执行一个简单查询，默认操作符为 <code>OR</code>，查询 <code>name</code> 字段中包含 <code>&quot;Ruan&quot;</code> 或 <code>&quot;Yiming&quot;</code> 的文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;simple_query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Ruan AND Yiming&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;name&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>simple_query_string</code>**：适用于较简单的查询，避免了复杂的查询语法。</li>\n</ul>\n<h3 id=\"5-simple-query-string-查询（默认操作符为-AND）\"><a href=\"#5-simple-query-string-查询（默认操作符为-AND）\" class=\"headerlink\" title=\"5. simple_query_string 查询（默认操作符为 AND）\"></a>5. <strong><code>simple_query_string</code> 查询（默认操作符为 AND）</strong></h3><p>查询 <code>name</code> 字段中包含 <code>&quot;Ruan&quot;</code> 且 <code>&quot;Yiming&quot;</code> 的文档，使用 <code>AND</code> 作为默认操作符：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;simple_query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Ruan Yiming&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;name&quot;</span>],</span><br><span class=\"line\">      <span class=\"string\">&quot;default_operator&quot;</span>: <span class=\"string\">&quot;AND&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>default_operator</code>**：设置默认操作符（<code>AND</code> 或 <code>OR</code>）。在此示例中，<code>AND</code> 用于要求 <code>&quot;Ruan&quot;</code> 和 <code>&quot;Yiming&quot;</code> 必须同时出现在 <code>name</code> 字段中。</li>\n</ul>\n<h3 id=\"6-query-string-查询：查询电影标题包含-“Beautiful”-和-“Mind”\"><a href=\"#6-query-string-查询：查询电影标题包含-“Beautiful”-和-“Mind”\" class=\"headerlink\" title=\"6. query_string 查询：查询电影标题包含 “Beautiful” 和 “Mind”\"></a>6. <strong><code>query_string</code> 查询：查询电影标题包含 “Beautiful” 和 “Mind”</strong></h3><p>执行 <code>query_string</code> 查询，查询电影标题中包含 <code>&quot;Beautiful&quot;</code> 和 <code>&quot;Mind&quot;</code> 的文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;profile&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;default_field&quot;</span>: <span class=\"string\">&quot;title&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Beautiful AND Mind&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>query_string</code>**：执行复杂查询，可以使用布尔操作符（如 <code>AND</code>）。</li>\n</ul>\n<h3 id=\"7-query-string-查询：多个字段查询\"><a href=\"#7-query-string-查询：多个字段查询\" class=\"headerlink\" title=\"7. query_string 查询：多个字段查询\"></a>7. <strong><code>query_string</code> 查询：多个字段查询</strong></h3><p>查询电影的 <code>title</code> 或 <code>year</code> 字段包含 <code>&quot;2012&quot;</code> 的文档：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;profile&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;title&quot;</span>, <span class=\"string\">&quot;year&quot;</span>],</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;2012&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>**<code>fields</code>**：指定多个字段进行查询，这里同时查询 <code>title</code> 和 <code>year</code> 字段。</li>\n</ul>\n<h3 id=\"8-simple-query-string-查询：使用-进行短语匹配\"><a href=\"#8-simple-query-string-查询：使用-进行短语匹配\" class=\"headerlink\" title=\"8. simple_query_string 查询：使用 + 进行短语匹配\"></a>8. <strong><code>simple_query_string</code> 查询：使用 <code>+</code> 进行短语匹配</strong></h3><p>查询电影标题中包含 <code>&quot;Beautiful&quot;</code> 和 <code>&quot;mind&quot;</code> 的文档，使用 <code>+</code> 确保两个词都出现在查询中：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;profile&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;simple_query_string&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Beautiful +mind&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;fields&quot;</span>: [<span class=\"string\">&quot;title&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong><code>+</code> 操作符</strong>：用于强制要求某个词出现在查询结果中。</li>\n</ul>\n<hr>\n<h3 id=\"总结-3\"><a href=\"#总结-3\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这些查询展示了如何在 Elasticsearch 中使用不同类型的查询：</p>\n<ul>\n<li><strong><code>query_string</code></strong> 查询：用于执行复杂的查询，可以包含多个字段、布尔操作符（AND、OR、NOT）以及通配符等。</li>\n<li><strong><code>simple_query_string</code></strong> 查询：比 <code>query_string</code> 更简单，适用于不需要复杂语法的查询，并且支持默认操作符的配置。</li>\n<li><strong>字段查询</strong>：可以针对多个字段同时查询，指定多个字段使用 <code>fields</code> 参数。</li>\n<li><strong>布尔操作符</strong>：如 <code>AND</code>、<code>OR</code>、<code>NOT</code>，控制查询的逻辑。</li>\n</ul>\n<p>这些查询方式非常适合处理复杂的检索需求。</p>\n<p>[3.10-DynamicMapping和常见字段类型]</p>\n<p>您的示例展示了如何在 Elasticsearch 中管理映射（Mapping）以及如何处理动态字段和映射更新。以下是总结和解释：</p>\n<h3 id=\"映射和字段定义\"><a href=\"#映射和字段定义\" class=\"headerlink\" title=\"映射和字段定义\"></a><strong>映射和字段定义</strong></h3><p>映射在 Elasticsearch 中类似于关系数据库中的表结构定义，主要用于：</p>\n<ul>\n<li><strong>定义字段的名称</strong>：指定文档中的字段名。</li>\n<li><strong>定义字段的类型</strong>：比如文本（<code>text</code>）、关键字（<code>keyword</code>）、日期（<code>date</code>）等。</li>\n<li><strong>定义倒排索引相关配置</strong>：比如是否需要索引字段，以及字段的 <code>Analyzer</code> 配置。</li>\n</ul>\n<h3 id=\"动态映射（Dynamic-Mapping）\"><a href=\"#动态映射（Dynamic-Mapping）\" class=\"headerlink\" title=\"动态映射（Dynamic Mapping）\"></a><strong>动态映射（Dynamic Mapping）</strong></h3><p>动态映射允许 Elasticsearch 根据新文档自动推断字段的类型。可以通过 <code>dynamic</code> 属性来配置动态行为：</p>\n<ul>\n<li>**<code>true</code>**（默认）：允许新字段自动被索引和映射。</li>\n<li>**<code>false</code>**：禁止自动创建新字段，但已存在字段可以继续使用。</li>\n<li>**<code>strict</code>**：禁止任何新的字段。如果文档包含未定义的字段，将导致错误。</li>\n</ul>\n<h3 id=\"操作演示\"><a href=\"#操作演示\" class=\"headerlink\" title=\"操作演示\"></a><strong>操作演示</strong></h3><ol>\n<li><p><strong>写入文档并查看映射</strong></p>\n<ul>\n<li>向 <code>mapping_test</code> 索引中添加一个文档，查看映射：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT mapping_test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Chan&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Jackie&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;loginDate&quot;</span>: <span class=\"string\">&quot;2018-07-24T10:29:48.103Z&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET mapping_test/_mapping</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>动态映射：推断字段类型</strong></p>\n<ul>\n<li>新字段 <code>uid</code>, <code>isVip</code>, <code>age</code> 等被自动推断并加入映射：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT mapping_test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;uid&quot;</span>: <span class=\"string\">&quot;123&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;isVip&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;isAdmin&quot;</span>: <span class=\"string\">&quot;true&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;age&quot;</span>: 19,</span><br><span class=\"line\">  <span class=\"string\">&quot;height&quot;</span>: 180</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET mapping_test/_mapping</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>新增字段（默认动态）</strong></p>\n<ul>\n<li>如果动态映射为 <code>true</code>（默认），可以动态添加新的字段：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT dynamic_mapping_test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;newField&quot;</span>: <span class=\"string\">&quot;someValue&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST dynamic_mapping_test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;newField&quot;</span>: <span class=\"string\">&quot;someValue&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>修改动态设置为 <code>false</code></strong></p>\n<ul>\n<li>修改 <code>dynamic</code> 设置为 <code>false</code>，禁止自动推断新字段：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT dynamic_mapping_test/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;dynamic&quot;</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT dynamic_mapping_test/_doc/10</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;anotherField&quot;</span>: <span class=\"string\">&quot;someValue&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST dynamic_mapping_test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;anotherField&quot;</span>: <span class=\"string\">&quot;someValue&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>在此示例中，<code>anotherField</code> 将不会被索引或搜索，因为动态映射已设置为 <code>false</code>。</p>\n</li>\n<li><p><strong>修改为 <code>strict</code> 模式</strong></p>\n<ul>\n<li>如果将 <code>dynamic</code> 设置为 <code>strict</code>，任何新的字段都会导致错误：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT dynamic_mapping_test/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;dynamic&quot;</span>: <span class=\"string\">&quot;strict&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT dynamic_mapping_test/_doc/12</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;lastField&quot;</span>: <span class=\"string\">&quot;value&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n此时，写入新字段 <code>lastField</code> 会导致错误，HTTP 返回 <code>400</code> 错误码。</li>\n</ul>\n</li>\n<li><p><strong>删除索引</strong></p>\n<ul>\n<li>删除索引：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE dynamic_mapping_test</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"总结-4\"><a href=\"#总结-4\" class=\"headerlink\" title=\"总结\"></a><strong>总结</strong></h3><ul>\n<li><strong>动态映射（Dynamic Mapping）</strong>：允许 Elasticsearch 自动推断并添加新的字段，方便快速处理未知数据。</li>\n<li><strong><code>dynamic</code> 配置</strong>：控制是否允许 Elasticsearch 自动映射新字段：<ul>\n<li><code>true</code>：默认允许动态字段；</li>\n<li><code>false</code>：禁止自动映射新字段；</li>\n<li><code>strict</code>：禁止所有未知字段，如果有未定义字段则会报错。</li>\n</ul>\n</li>\n<li><strong>更改映射</strong>：映射一旦建立后不能直接修改字段类型，要修改字段配置或添加新字段需要使用 <code>reindex</code> 操作。</li>\n</ul>\n<p>这些操作有助于管理索引和字段的生命周期，确保数据能够根据业务需求灵活适应。</p>\n<p>您的示例展示了 Elasticsearch 中显式设置映射（Mapping）的一些常见操作和参数。以下是各个设置项的详细介绍和使用案例。</p>\n<h3 id=\"1-index-false-设置\"><a href=\"#1-index-false-设置\" class=\"headerlink\" title=\"1. index: false 设置\"></a><strong>1. <code>index: false</code> 设置</strong></h3><p>通过设置字段的 <code>index: false</code>，可以阻止某些字段被索引。这样可以避免该字段参与倒排索引，也不会进行搜索。</p>\n<p><strong>示例</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;firstName&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;lastName&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;mobile&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;index&quot;</span>: <span class=\"literal\">false</span>  <span class=\"comment\"># 禁止索引该字段</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Ruan&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Yiming&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;mobile&quot;</span>: <span class=\"string\">&quot;12345678&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;mobile&quot;</span>: <span class=\"string\">&quot;12345678&quot;</span>  <span class=\"comment\"># 搜索时不会命中mobile字段</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在上面的示例中，<code>mobile</code> 字段被设置为 <code>index: false</code>，因此无法用于搜索查询。</p>\n<h3 id=\"2-null-value-设置\"><a href=\"#2-null-value-设置\" class=\"headerlink\" title=\"2. null_value 设置\"></a><strong>2. <code>null_value</code> 设置</strong></h3><p>通过设置 <code>null_value</code>，可以在文档中存储 <code>null</code> 值，并用指定的替代值替换 <code>null</code>。这对于查询时需要处理 <code>null</code> 数据特别有用。</p>\n<p><strong>示例</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;firstName&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;lastName&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;mobile&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;null_value&quot;</span>: <span class=\"string\">&quot;NULL&quot;</span>  <span class=\"comment\"># null值替代为&quot;NULL&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Ruan&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Yiming&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;mobile&quot;</span>: null  <span class=\"comment\"># 实际值是null</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Ruan2&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Yiming2&quot;</span>  <span class=\"comment\"># 没有mobile字段</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;mobile&quot;</span>: <span class=\"string\">&quot;NULL&quot;</span>  <span class=\"comment\"># 搜索时会匹配到null值字段</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此设置可以确保查询时用 <code>NULL</code> 代替存储的 <code>null</code> 值。</p>\n<h3 id=\"3-copy-to-设置\"><a href=\"#3-copy-to-设置\" class=\"headerlink\" title=\"3. copy_to 设置\"></a><strong>3. <code>copy_to</code> 设置</strong></h3><p><code>copy_to</code> 可以将多个字段的内容复制到另一个字段，方便进行联合查询或索引。</p>\n<p><strong>示例</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE <span class=\"built_in\">users</span></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;firstName&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;copy_to&quot;</span>: <span class=\"string\">&quot;fullName&quot;</span>  <span class=\"comment\"># 将firstName复制到fullName字段</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;lastName&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;copy_to&quot;</span>: <span class=\"string\">&quot;fullName&quot;</span>  <span class=\"comment\"># 将lastName复制到fullName字段</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;firstName&quot;</span>: <span class=\"string\">&quot;Ruan&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;lastName&quot;</span>: <span class=\"string\">&quot;Yiming&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET <span class=\"built_in\">users</span>/_search?q=fullName:(Ruan Yiming)</span><br><span class=\"line\"></span><br><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;fullName&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;query&quot;</span>: <span class=\"string\">&quot;Ruan Yiming&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;operator&quot;</span>: <span class=\"string\">&quot;and&quot;</span>  <span class=\"comment\"># 联合查询fullName字段</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里，<code>firstName</code> 和 <code>lastName</code> 字段的内容会被复制到 <code>fullName</code> 字段，从而使得查询变得更加方便。</p>\n<h3 id=\"4-数组类型处理\"><a href=\"#4-数组类型处理\" class=\"headerlink\" title=\"4. 数组类型处理\"></a><strong>4. 数组类型处理</strong></h3><p>Elasticsearch 支持数组字段。数组中的每个元素会被视为一个单独的值，这对于多值字段非常有用。</p>\n<p><strong>示例</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;onebird&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;interests&quot;</span>: <span class=\"string\">&quot;reading&quot;</span>  <span class=\"comment\"># 字段为单一值</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT <span class=\"built_in\">users</span>/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;twobirds&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;interests&quot;</span>: [<span class=\"string\">&quot;reading&quot;</span>, <span class=\"string\">&quot;music&quot;</span>]  <span class=\"comment\"># 字段为数组</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST <span class=\"built_in\">users</span>/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET <span class=\"built_in\">users</span>/_mapping</span><br></pre></td></tr></table></figure>\n<p>在此示例中，<code>interests</code> 字段既可以是单个值也可以是数组，Elasticsearch 会将每个数组元素视为独立的值进行索引。</p>\n<hr>\n<h3 id=\"总结常见的-Mapping-参数\"><a href=\"#总结常见的-Mapping-参数\" class=\"headerlink\" title=\"总结常见的 Mapping 参数\"></a><strong>总结常见的 Mapping 参数</strong></h3><ul>\n<li><strong><code>type</code></strong>: 字段的数据类型，如 <code>text</code>, <code>keyword</code>, <code>date</code> 等。</li>\n<li><strong><code>index</code></strong>: 控制是否索引该字段，<code>false</code> 表示不索引，默认为 <code>true</code>。</li>\n<li><strong><code>null_value</code></strong>: 控制 <code>null</code> 值的替代值。可以设置为任何替代值，如 <code>&quot;NULL&quot;</code>。</li>\n<li><strong><code>copy_to</code></strong>: 将多个字段的内容复制到一个目标字段中，便于联合查询。</li>\n<li><strong><code>dynamic</code></strong>: 控制动态映射，<code>true</code> 表示允许自动推断新字段，<code>false</code> 表示禁止新字段自动映射，<code>strict</code> 则表示严格模式下不允许任何新字段。</li>\n</ul>\n<p>通过这些映射设置，可以更好地控制数据如何存储和索引，以及如何在查询时处理和优化字段。</p>\n<p>您的示例展示了 Elasticsearch 中关于多字段特性以及自定义分析器（Analyzer）的配置。以下是对各个分析器和相关配置的详细解释。</p>\n<h3 id=\"1-自定义-Analyzer-和-Char-Filter\"><a href=\"#1-自定义-Analyzer-和-Char-Filter\" class=\"headerlink\" title=\"1. 自定义 Analyzer 和 Char Filter\"></a><strong>1. 自定义 Analyzer 和 Char Filter</strong></h3><p>Elasticsearch 提供了灵活的机制来配置分词器（Tokenizer）和字符过滤器（Char Filter）。这些配置用于在索引和搜索过程中控制文本的处理方式。</p>\n<h4 id=\"自定义-Tokenizer-和-Char-Filter-示例\"><a href=\"#自定义-Tokenizer-和-Char-Filter-示例\" class=\"headerlink\" title=\"自定义 Tokenizer 和 Char Filter 示例\"></a><strong>自定义 Tokenizer 和 Char Filter 示例</strong></h4><ul>\n<li><strong>Keyword Tokenizer</strong>: <code>keyword</code> tokenizer 将整个文本当作一个单独的 token 进行处理。</li>\n<li><strong>HTML Strip Char Filter</strong>: <code>html_strip</code> char filter 用于从文本中去除 HTML 标签。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;keyword&quot;</span>,  <span class=\"comment\"># 使用关键词分词器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;char_filter&quot;</span>: [<span class=\"string\">&quot;html_strip&quot;</span>],  <span class=\"comment\"># 使用html_strip字符过滤器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;&lt;b&gt;hello world&lt;/b&gt;&quot;</span>  <span class=\"comment\"># 输入带有HTML标签的文本</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出将会是：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hello world&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">3</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>此配置移除了文本中的 <code>&lt;b&gt;&lt;/b&gt;</code> HTML 标签，只保留了纯文本 “hello world”。</p>\n<h4 id=\"Path-Hierarchy-Tokenizer\"><a href=\"#Path-Hierarchy-Tokenizer\" class=\"headerlink\" title=\"Path Hierarchy Tokenizer\"></a><strong>Path Hierarchy Tokenizer</strong></h4><p><code>path_hierarchy</code> tokenizer 用于处理文件路径等层级结构的数据，将路径按分隔符（如 <code>/</code>）切割。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;path_hierarchy&quot;</span>,  <span class=\"comment\"># 使用路径层级分词器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;/user/ymruan/a/b/c/d/e&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出会将路径按 <code>/</code> 切分：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/user/ymruan/a/b/c/d/e&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">21</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/user/ymruan/a/b/c/d&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">16</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-Char-Filter-替换符号\"><a href=\"#2-Char-Filter-替换符号\" class=\"headerlink\" title=\"2. Char Filter 替换符号\"></a><strong>2. Char Filter 替换符号</strong></h3><p>字符过滤器可以用于替换文本中的特定符号或字符。例如，使用 <code>mapping</code> 类型的 <code>char_filter</code>，可以替换文本中的字符（如将 <code>-</code> 替换为 <code>_</code>）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,  <span class=\"comment\"># 使用标准分词器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;char_filter&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;mapping&quot;</span>,  <span class=\"comment\"># 使用字符映射过滤器</span></span><br><span class=\"line\">      <span class=\"string\">&quot;mappings&quot;</span>: [<span class=\"string\">&quot;- =&gt; _&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;123-456, I-test! test-990 650-555-1234&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此配置将文本中的 <code>-</code> 替换为 <code>_</code>，输出将是：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;123_456&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">7</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-Char-Filter-替换表情符号\"><a href=\"#3-Char-Filter-替换表情符号\" class=\"headerlink\" title=\"3. Char Filter 替换表情符号\"></a><strong>3. Char Filter 替换表情符号</strong></h3><p>你还可以使用字符过滤器将表情符号替换为特定的文本（如将 <code>:)</code> 替换为 <code>happy</code>，<code>:(</code> 替换为 <code>sad</code>）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;char_filter&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;mapping&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;mappings&quot;</span>: [<span class=\"string\">&quot;:) =&gt; happy&quot;</span>, <span class=\"string\">&quot;:( =&gt; sad&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: [<span class=\"string\">&quot;I am felling :)&quot;</span>, <span class=\"string\">&quot;Feeling :( today&quot;</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;I&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;am&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">4</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;felling&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">12</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;happy&quot;</span><span class=\"punctuation\">,</span>  # 替换表情符号<span class=\"punctuation\">:</span>) 为 happy</span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">13</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">18</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">3</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-使用-Stop-和-Snowball-过滤器\"><a href=\"#4-使用-Stop-和-Snowball-过滤器\" class=\"headerlink\" title=\"4. 使用 Stop 和 Snowball 过滤器\"></a><strong>4. 使用 Stop 和 Snowball 过滤器</strong></h3><p>使用 <code>stop</code> 过滤器来删除常见的停用词，使用 <code>snowball</code> 过滤器进行词干提取（如将 “playing” 转换为 “play”）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;whitespace&quot;</span>,  <span class=\"comment\"># 使用空格分词器</span></span><br><span class=\"line\">  <span class=\"string\">&quot;filter&quot;</span>: [<span class=\"string\">&quot;stop&quot;</span>, <span class=\"string\">&quot;snowball&quot;</span>],  <span class=\"comment\"># 使用停用词和词干提取</span></span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: [<span class=\"string\">&quot;The girls in China are playing this game!&quot;</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;girl&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">4</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">9</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;china&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">14</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">19</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-正则表达式替换\"><a href=\"#5-正则表达式替换\" class=\"headerlink\" title=\"5. 正则表达式替换\"></a><strong>5. 正则表达式替换</strong></h3><p>通过 <code>pattern_replace</code> 字符过滤器，您可以根据正则表达式来替换文本中的特定部分。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;tokenizer&quot;</span>: <span class=\"string\">&quot;standard&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;char_filter&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;pattern_replace&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;pattern&quot;</span>: <span class=\"string\">&quot;http://(.*)&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;replacement&quot;</span>: <span class=\"string\">&quot;<span class=\"variable\">$1</span>&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;text&quot;</span>: <span class=\"string\">&quot;http://www.elastic.co&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此配置将 <code>http://</code> 替换为一个空字符串，结果为：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;tokens&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;token&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;www.elastic.co&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;start_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">7</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;end_offset&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">23</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;word&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;position&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结：\"><a href=\"#总结：\" class=\"headerlink\" title=\"总结：\"></a><strong>总结：</strong></h3><ul>\n<li><strong>Tokenizer</strong>: 负责将输入文本切割成词条（token）。如 <code>keyword</code>, <code>standard</code>, <code>path_hierarchy</code>。</li>\n<li><strong>Char Filter</strong>: 处理文本中的字符替换、去除特殊符号或HTML标签等，如 <code>html_strip</code>, <code>mapping</code>, <code>pattern_replace</code>。</li>\n<li><strong>Filter</strong>: 用于文本处理，如去除停用词（<code>stop</code>）或词干提取（<code>snowball</code>）。</li>\n</ul>\n<p>这些工具的组合允许您灵活地处理和分析文本数据，并针对特定的业务需求优化索引和搜索行为。</p>\n<p>在 Elasticsearch 中，<strong>Index Templates</strong> 和 <strong>Dynamic Templates</strong> 是两种强大的工具，用于控制如何定义和管理索引的映射和设置。以下是这两者的详细解释和示例。</p>\n<h3 id=\"1-Index-Templates-索引模板\"><a href=\"#1-Index-Templates-索引模板\" class=\"headerlink\" title=\"1. Index Templates (索引模板)\"></a><strong>1. Index Templates (索引模板)</strong></h3><p><strong>Index Templates</strong> 是一种配置模板，用于为匹配特定模式的索引自动配置设置、映射和其他配置。当创建一个新索引时，如果该索引匹配模板中的 <code>index_patterns</code> 配置，模板中的设置、映射和其他配置就会自动应用到新索引上。</p>\n<h4 id=\"创建默认模板\"><a href=\"#创建默认模板\" class=\"headerlink\" title=\"创建默认模板\"></a><strong>创建默认模板</strong></h4><p>下面是创建一个默认模板的示例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _template/template_default</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;index_patterns&quot;</span>: [<span class=\"string\">&quot;*&quot;</span>],  <span class=\"comment\"># 匹配所有索引</span></span><br><span class=\"line\">  <span class=\"string\">&quot;order&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;version&quot;</span>: 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_shards&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这会为所有索引设置一个模板，其中包含分片数量为1、副本数量为1。</p>\n<h4 id=\"为特定模式创建模板\"><a href=\"#为特定模式创建模板\" class=\"headerlink\" title=\"为特定模式创建模板\"></a><strong>为特定模式创建模板</strong></h4><p>另一个例子是为 <code>test*</code> 开头的索引创建模板：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /_template/template_test</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;index_patterns&quot;</span>: [<span class=\"string\">&quot;test*&quot;</span>],  <span class=\"comment\"># 匹配所有以test开头的索引</span></span><br><span class=\"line\">  <span class=\"string\">&quot;order&quot;</span>: 1,</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_shards&quot;</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 2</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;date_detection&quot;</span>: <span class=\"literal\">false</span>,  <span class=\"comment\"># 禁止自动检测日期字段</span></span><br><span class=\"line\">    <span class=\"string\">&quot;numeric_detection&quot;</span>: <span class=\"literal\">true</span>  <span class=\"comment\"># 自动检测数字字段</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查看模板\"><a href=\"#查看模板\" class=\"headerlink\" title=\"查看模板\"></a><strong>查看模板</strong></h4><p>你可以查看已定义的模板：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_template/template_default</span><br><span class=\"line\">GET /_template/temp*  <span class=\"comment\"># 查看所有模板</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"删除模板\"><a href=\"#删除模板\" class=\"headerlink\" title=\"删除模板\"></a><strong>删除模板</strong></h4><p>删除模板的命令如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE /_template/template_default</span><br><span class=\"line\">DELETE /_template/template_test</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"2-Dynamic-Templates-动态模板\"><a href=\"#2-Dynamic-Templates-动态模板\" class=\"headerlink\" title=\"2. Dynamic Templates (动态模板)\"></a><strong>2. Dynamic Templates (动态模板)</strong></h3><p><strong>Dynamic Templates</strong> 用于在创建索引时自动匹配字段类型和名称，根据这些动态模板来生成字段的映射规则。可以根据字段的类型（例如字符串、数字）和字段名称（例如以某些字符开头的字段）来定义映射。</p>\n<h4 id=\"自动映射数字字符串和日期字符串\"><a href=\"#自动映射数字字符串和日期字符串\" class=\"headerlink\" title=\"自动映射数字字符串和日期字符串\"></a><strong>自动映射数字字符串和日期字符串</strong></h4><p>例如，数字字符串会被映射为 <code>text</code> 类型，日期字符串会被映射为日期类型：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT ttemplate/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;someNumber&quot;</span>: <span class=\"string\">&quot;1&quot;</span>,        <span class=\"comment\"># 字符串数字</span></span><br><span class=\"line\">  <span class=\"string\">&quot;someDate&quot;</span>: <span class=\"string\">&quot;2019/01/01&quot;</span>  <span class=\"comment\"># 字符串日期</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">GET ttemplate/_mapping</span><br></pre></td></tr></table></figure>\n<p>在这个例子中，<code>someNumber</code> 会被映射成 <code>text</code> 类型，而 <code>someDate</code> 会被映射成 <code>date</code> 类型。</p>\n<h4 id=\"定义动态模板映射规则\"><a href=\"#定义动态模板映射规则\" class=\"headerlink\" title=\"定义动态模板映射规则\"></a><strong>定义动态模板映射规则</strong></h4><p>使用 <code>dynamic_templates</code> 可以根据字段类型和名称定义映射。例如，以下动态模板将以 <code>is*</code> 开头的字符串字段映射为 <code>boolean</code> 类型，其他字符串字段映射为 <code>keyword</code> 类型：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE my_index</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;dynamic_templates&quot;</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;strings_as_boolean&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;match_mapping_type&quot;</span>: <span class=\"string\">&quot;string&quot;</span>,   <span class=\"comment\"># 匹配所有字符串类型</span></span><br><span class=\"line\">          <span class=\"string\">&quot;match&quot;</span>: <span class=\"string\">&quot;is*&quot;</span>,  <span class=\"comment\"># 字段名称以is开头</span></span><br><span class=\"line\">          <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;boolean&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;strings_as_keywords&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;match_mapping_type&quot;</span>: <span class=\"string\">&quot;string&quot;</span>,   <span class=\"comment\"># 匹配所有字符串类型</span></span><br><span class=\"line\">          <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个示例中，<code>isVIP</code> 字段会被映射为 <code>boolean</code> 类型，而其他字符串类型的字段则会被映射为 <code>keyword</code> 类型。</p>\n<h4 id=\"结合路径匹配\"><a href=\"#结合路径匹配\" class=\"headerlink\" title=\"结合路径匹配\"></a><strong>结合路径匹配</strong></h4><p>动态模板不仅可以基于字段名称，还可以基于字段的路径。例如，以下模板会将 <code>name.*</code> 路径下的所有字段映射为 <code>text</code> 类型，并将这些字段复制到 <code>full_name</code> 字段中：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;dynamic_templates&quot;</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;full_name&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;path_match&quot;</span>: <span class=\"string\">&quot;name.*&quot;</span>,  <span class=\"comment\"># 匹配name下的所有字段</span></span><br><span class=\"line\">          <span class=\"string\">&quot;path_unmatch&quot;</span>: <span class=\"string\">&quot;*.middle&quot;</span>,  <span class=\"comment\"># 排除middle字段</span></span><br><span class=\"line\">          <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;copy_to&quot;</span>: <span class=\"string\">&quot;full_name&quot;</span>  <span class=\"comment\"># 将值复制到full_name字段</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后，插入以下数据：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT my_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;name&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;first&quot;</span>: <span class=\"string\">&quot;John&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;middle&quot;</span>: <span class=\"string\">&quot;Winston&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;last&quot;</span>: <span class=\"string\">&quot;Lennon&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在这个例子中，<code>first</code> 和 <code>last</code> 字段将被映射为 <code>text</code> 类型，并且它们的内容会被复制到 <code>full_name</code> 字段中。</p>\n<h4 id=\"搜索字段\"><a href=\"#搜索字段\" class=\"headerlink\" title=\"搜索字段\"></a><strong>搜索字段</strong></h4><p>可以通过 <code>full_name</code> 字段来搜索：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET my_index/_search?q=full_name:John</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"总结：-1\"><a href=\"#总结：-1\" class=\"headerlink\" title=\"总结：\"></a><strong>总结：</strong></h3><ul>\n<li><strong>Index Templates</strong> 是为匹配特定索引模式（<code>index_patterns</code>）的所有索引自动配置设置和映射的模板。</li>\n<li><strong>Dynamic Templates</strong> 用于根据字段类型和字段名称自动映射索引字段。你可以根据字段类型（如 <code>string</code>）或字段路径（如 <code>name.*</code>）来定义映射规则。</li>\n</ul>\n<p>这些配置使得索引的创建和管理更加灵活，可以根据实际数据自动推断和调整映射，从而提高了 Elasticsearch 的可用性和效率。</p>\n<p>Elasticsearch 提供了强大的 <strong>聚合</strong> 功能，用于对数据进行汇总和分析。聚合是 Elasticsearch 搜索的一个核心功能，允许你通过多种方式对数据进行分组、统计、求最大&#x2F;最小值、计算平均值等操作。以下是一些常见的聚合分析操作和示例：</p>\n<h3 id=\"1-基本的聚合分析：按目的地分桶统计\"><a href=\"#1-基本的聚合分析：按目的地分桶统计\" class=\"headerlink\" title=\"1. 基本的聚合分析：按目的地分桶统计\"></a><strong>1. 基本的聚合分析：按目的地分桶统计</strong></h3><p>在这个示例中，我们按航班的目的地（<code>DestCountry</code>）进行分桶统计，查看每个目的地的航班数量：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,  <span class=\"comment\"># 不返回实际的文档数据，只返回聚合结果</span></span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;flight_dest&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;DestCountry&quot;</span>  <span class=\"comment\"># 按目的地国家分桶</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个聚合查询中，<code>terms</code> 聚合用于对 <code>DestCountry</code> 字段的值进行分桶，返回每个目的地国家的航班数量。</p>\n<h3 id=\"2-增加更多统计：平均、最大、最小价格\"><a href=\"#2-增加更多统计：平均、最大、最小价格\" class=\"headerlink\" title=\"2. 增加更多统计：平均、最大、最小价格\"></a><strong>2. 增加更多统计：平均、最大、最小价格</strong></h3><p>你可以在分桶内部添加更多聚合来获取其他统计信息，如每个目的地的平均票价、最高票价和最低票价：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;flight_dest&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;DestCountry&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;avg_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;avg&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;AvgTicketPrice&quot;</span>  <span class=\"comment\"># 计算平均票价</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;max_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;max&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;AvgTicketPrice&quot;</span>  <span class=\"comment\"># 计算最高票价</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;min_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;min&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;AvgTicketPrice&quot;</span>  <span class=\"comment\"># 计算最低票价</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个查询中，我们为每个目的地添加了三个聚合：<code>avg_price</code>、<code>max_price</code> 和 <code>min_price</code>，分别计算每个目的地的平均票价、最大票价和最小票价。</p>\n<h3 id=\"3-聚合价格与天气信息：统计与多重聚合\"><a href=\"#3-聚合价格与天气信息：统计与多重聚合\" class=\"headerlink\" title=\"3. 聚合价格与天气信息：统计与多重聚合\"></a><strong>3. 聚合价格与天气信息：统计与多重聚合</strong></h3><p>如果你还想结合天气信息（如 <code>DestWeather</code> 字段）与航班价格统计一起进行聚合，可以使用嵌套聚合：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;flight_dest&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;DestCountry&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;stats_price&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;stats&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;AvgTicketPrice&quot;</span>  <span class=\"comment\"># 计算票价的多项统计信息</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;weather&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;DestWeather&quot;</span>,  <span class=\"comment\"># 按天气类型分桶</span></span><br><span class=\"line\">            <span class=\"string\">&quot;size&quot;</span>: 5  <span class=\"comment\"># 只返回前5个天气类型</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个示例中，我们不仅计算了每个目的地的票价统计信息（如平均票价、最大票价等），还将天气信息作为另一个 <code>terms</code> 聚合，显示每个目的地的天气类型，并限制返回的天气类型数量为 5 个。</p>\n<hr>\n<h3 id=\"常见的聚合类型：\"><a href=\"#常见的聚合类型：\" class=\"headerlink\" title=\"常见的聚合类型：\"></a><strong>常见的聚合类型：</strong></h3><ul>\n<li><strong><code>terms</code> 聚合</strong>：将文档按某个字段的值进行分桶，常用于统计词频或其他分类数据。</li>\n<li><strong><code>avg</code> 聚合</strong>：计算某个数值字段的平均值。</li>\n<li><strong><code>sum</code> 聚合</strong>：计算某个数值字段的总和。</li>\n<li><strong><code>min</code> 聚合</strong>：返回某个数值字段的最小值。</li>\n<li><strong><code>max</code> 聚合</strong>：返回某个数值字段的最大值。</li>\n<li><strong><code>stats</code> 聚合</strong>：返回字段的统计信息（包括：最小值、最大值、平均值、总和和文档数量）。</li>\n<li><strong><code>date_histogram</code> 聚合</strong>：按日期进行分桶，适用于时间序列数据。</li>\n<li><strong><code>histogram</code> 聚合</strong>：按数值区间进行分桶，常用于数值数据的统计。</li>\n</ul>\n<hr>\n<h3 id=\"相关阅读：\"><a href=\"#相关阅读：\" class=\"headerlink\" title=\"相关阅读：\"></a><strong>相关阅读：</strong></h3><ul>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations.html\">Elasticsearch 聚合文档</a> 详细介绍了各种聚合的使用方式和示例。</li>\n</ul>\n<p>聚合功能非常强大，能帮助你从海量数据中提取有价值的信息，适用于各种数据分析场景。</p>\n"},{"title":"logstach安装和导入数据","date":"2025-02-27T06:09:00.000Z","_content":"\n使用[logstash.conf](../../resource/logstash.conf)\n\n运行logstash\n```shell\nwget https://artifacts.elastic.co/downloads/logstash/logstash-oss-7.1.0.tar.gz\ntar -zxvf logstash-oss-7.1.0.tar.gz\ncd logstash-oss-7.1.0\nbin/logstash -f logstash.conf\n```\n","source":"_posts/elasticsearch/logstach安装和导入数据.md","raw":"---\ntitle: logstach安装和导入数据\ndate: 2025-02-27 14:09:00\ntags:\n---\n\n使用[logstash.conf](../../resource/logstash.conf)\n\n运行logstash\n```shell\nwget https://artifacts.elastic.co/downloads/logstash/logstash-oss-7.1.0.tar.gz\ntar -zxvf logstash-oss-7.1.0.tar.gz\ncd logstash-oss-7.1.0\nbin/logstash -f logstash.conf\n```\n","slug":"elasticsearch/logstach安装和导入数据","published":1,"updated":"2025-02-27T06:25:18.049Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8s0008ujz3hefyewq9","content":"<p>使用<a href=\"../../resource/logstash.conf\">logstash.conf</a></p>\n<p>运行logstash</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://artifacts.elastic.co/downloads/logstash/logstash-oss-7.1.0.tar.gz</span><br><span class=\"line\">tar -zxvf logstash-oss-7.1.0.tar.gz</span><br><span class=\"line\">cd logstash-oss-7.1.0</span><br><span class=\"line\">bin/logstash -f logstash.conf</span><br></pre></td></tr></table></figure>\n","cover":false,"excerpt":"","more":"<p>使用<a href=\"../../resource/logstash.conf\">logstash.conf</a></p>\n<p>运行logstash</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://artifacts.elastic.co/downloads/logstash/logstash-oss-7.1.0.tar.gz</span><br><span class=\"line\">tar -zxvf logstash-oss-7.1.0.tar.gz</span><br><span class=\"line\">cd logstash-oss-7.1.0</span><br><span class=\"line\">bin/logstash -f logstash.conf</span><br></pre></td></tr></table></figure>\n"},{"title":"在Docker容器中运行Elasticsearch,Kibana和Cerebro","date":"2025-02-27T02:42:36.000Z","_content":"\ndocker-compose.yml如下\n```shell\nversion: '2.2'\nservices:\n  cerebro:\n    image: lmenezes/cerebro:0.8.3\n    container_name: cerebro\n    ports:\n      - \"9000:9000\"\n    command:\n      - -Dhosts.0.host=http://elasticsearch:9200\n    networks:\n      - es7net\n  kibana:\n    image: docker.elastic.co/kibana/kibana:7.1.0\n    container_name: kibana7\n    environment:\n      - I18N_LOCALE=zh-CN\n      - XPACK_GRAPH_ENABLED=true\n      - TIMELION_ENABLED=true\n      - XPACK_MONITORING_COLLECTION_ENABLED=\"true\"\n    ports:\n      - \"5601:5601\"\n    networks:\n      - es7net\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0\n    container_name: es7_01\n    environment:\n      - cluster.name=geektime\n      - node.name=es7_01\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=es7_01,es7_02\n      - cluster.initial_master_nodes=es7_01,es7_02\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - es7data1:/usr/share/elasticsearch/data\n    ports:\n      - 9200:9200\n    networks:\n      - es7net\n  elasticsearch2:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0\n    container_name: es7_02\n    environment:\n      - cluster.name=geektime\n      - node.name=es7_02\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=es7_01,es7_02\n      - cluster.initial_master_nodes=es7_01,es7_02\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - es7data2:/usr/share/elasticsearch/data\n    networks:\n      - es7net\n\nvolumes:\n  es7data1:\n    driver: local\n  es7data2:\n    driver: local\n\nnetworks:\n  es7net:\n    driver: bridge\n```\n这个 `docker-compose.yml` 文件用于配置并部署一个包含 **Elasticsearch**、**Kibana** 和 **Cerebro** 的集群环境。\n\n#### 1. **cerebro**\n- **image**: 使用 `lmenezes/cerebro:0.8.3` 这个镜像，Cerebro 是一个开源的 Elasticsearch 管理工具。\n- **container_name**: 将容器命名为 `cerebro`。\n- **ports**: 将主机的 9000 端口映射到容器内的 9000 端口，允许通过浏览器访问 Cerebro 界面。\n- **command**: 启动时设置参数，`-Dhosts.0.host=http://elasticsearch:9200` 指定 Cerebro 连接的 Elasticsearch 地址为 `elasticsearch:9200`。\n- **networks**: 配置 `cerebro` 服务连接到 `es7net` 网络。\n\n#### 2. **kibana**\n- **image**: 使用 `docker.elastic.co/kibana/kibana:7.1.0` 镜像，这是 Elasticsearch 官方的 Kibana 7.1.0 版本。\n- **container_name**: 容器命名为 `kibana7`。\n- **environment**: 设置了一些 Kibana 配置项：\n    - `I18N_LOCALE=zh-CN`：设置 Kibana 界面语言为中文。\n    - `XPACK_GRAPH_ENABLED=true`、`TIMELION_ENABLED=true`：启用一些高级功能。\n    - `XPACK_MONITORING_COLLECTION_ENABLED=\"true\"`：启用监控功能。\n- **ports**: 映射主机的 5601 端口到容器的 5601 端口，用于通过浏览器访问 Kibana 界面。\n- **networks**: `kibana` 服务连接到 `es7net` 网络。\n\n#### 3. **elasticsearch**\n- **image**: 使用 `docker.elastic.co/elasticsearch/elasticsearch:7.1.0` 镜像，这是 Elasticsearch 7.1.0 的官方版本。\n- **container_name**: 容器命名为 `es7_01`。\n- **environment**: 设置 Elasticsearch 的环境变量：\n    - `cluster.name=geektime`：集群名称为 `geektime`。\n    - `node.name=es7_01`：节点名称为 `es7_01`。\n    - `bootstrap.memory_lock=true`：启用内存锁定，防止虚拟内存交换。\n    - `ES_JAVA_OPTS=-Xms512m -Xmx512m`：设置 JVM 的初始内存和最大内存为 512MB。\n    - `discovery.seed_hosts=es7_01,es7_02`：指定集群中的其他节点用于发现集群成员。\n    - `cluster.initial_master_nodes=es7_01,es7_02`：设置初始的主节点，用于集群初始化。\n- **ulimits**: 配置容器的内存锁定，`soft` 和 `hard` 都设置为 -1，表示没有限制。\n- **volumes**: 使用 `es7data1` 持久化数据。\n- **ports**: 映射主机的 9200 端口到容器的 9200 端口，允许通过 HTTP 访问 Elasticsearch。\n- **networks**: `elasticsearch` 服务连接到 `es7net` 网络。\n\n#### 4. **elasticsearch2**\n- **image**: 使用相同的 `docker.elastic.co/elasticsearch/elasticsearch:7.1.0` 镜像。\n- **container_name**: 容器命名为 `es7_02`。\n- **environment**: 与 `elasticsearch` 配置类似，唯一的区别是 `node.name` 设置为 `es7_02`，这是另一个节点。\n- **ulimits**: 配置内存锁定，和 `es7_01` 节点一致。\n- **volumes**: 使用 `es7data2` 持久化数据。\n- **networks**: `elasticsearch2` 服务连接到 `es7net` 网络。\n\n### `volumes`\n- **es7data1** 和 **es7data2**：定义了两个持久化数据卷，分别用于 Elasticsearch 节点 `es7_01` 和 `es7_02` 的数据存储，使用 `local` 驱动。\n\n### `networks`\n- **es7net**: 定义了一个名为 `es7net` 的网络，所有的服务都将连接到这个网络上。网络使用 `bridge` 驱动，适用于 Docker 容器间的通信。\n\n### 总结\n这个 `docker-compose.yml` 文件定义了一个完整的 Elasticsearch 集群（包含两个节点），同时部署了 Kibana 和 Cerebro 来进行集群管理和可视化。通过将这些服务连接到一个共享的网络 `es7net`，它们能够相互通信。数据卷 `es7data1` 和 `es7data2` 保证了 Elasticsearch 的数据持久性，即使容器停止或重启，数据也不会丢失。","source":"_posts/elasticsearch/在Docker容器中运行Elasticsearch-Kibana和Cerebro.md","raw":"---\ntitle: 在Docker容器中运行Elasticsearch,Kibana和Cerebro\ndate: 2025-02-27 10:42:36\ncategories: elasticsearch\ntag: docker部署\n---\n\ndocker-compose.yml如下\n```shell\nversion: '2.2'\nservices:\n  cerebro:\n    image: lmenezes/cerebro:0.8.3\n    container_name: cerebro\n    ports:\n      - \"9000:9000\"\n    command:\n      - -Dhosts.0.host=http://elasticsearch:9200\n    networks:\n      - es7net\n  kibana:\n    image: docker.elastic.co/kibana/kibana:7.1.0\n    container_name: kibana7\n    environment:\n      - I18N_LOCALE=zh-CN\n      - XPACK_GRAPH_ENABLED=true\n      - TIMELION_ENABLED=true\n      - XPACK_MONITORING_COLLECTION_ENABLED=\"true\"\n    ports:\n      - \"5601:5601\"\n    networks:\n      - es7net\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0\n    container_name: es7_01\n    environment:\n      - cluster.name=geektime\n      - node.name=es7_01\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=es7_01,es7_02\n      - cluster.initial_master_nodes=es7_01,es7_02\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - es7data1:/usr/share/elasticsearch/data\n    ports:\n      - 9200:9200\n    networks:\n      - es7net\n  elasticsearch2:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0\n    container_name: es7_02\n    environment:\n      - cluster.name=geektime\n      - node.name=es7_02\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=es7_01,es7_02\n      - cluster.initial_master_nodes=es7_01,es7_02\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - es7data2:/usr/share/elasticsearch/data\n    networks:\n      - es7net\n\nvolumes:\n  es7data1:\n    driver: local\n  es7data2:\n    driver: local\n\nnetworks:\n  es7net:\n    driver: bridge\n```\n这个 `docker-compose.yml` 文件用于配置并部署一个包含 **Elasticsearch**、**Kibana** 和 **Cerebro** 的集群环境。\n\n#### 1. **cerebro**\n- **image**: 使用 `lmenezes/cerebro:0.8.3` 这个镜像，Cerebro 是一个开源的 Elasticsearch 管理工具。\n- **container_name**: 将容器命名为 `cerebro`。\n- **ports**: 将主机的 9000 端口映射到容器内的 9000 端口，允许通过浏览器访问 Cerebro 界面。\n- **command**: 启动时设置参数，`-Dhosts.0.host=http://elasticsearch:9200` 指定 Cerebro 连接的 Elasticsearch 地址为 `elasticsearch:9200`。\n- **networks**: 配置 `cerebro` 服务连接到 `es7net` 网络。\n\n#### 2. **kibana**\n- **image**: 使用 `docker.elastic.co/kibana/kibana:7.1.0` 镜像，这是 Elasticsearch 官方的 Kibana 7.1.0 版本。\n- **container_name**: 容器命名为 `kibana7`。\n- **environment**: 设置了一些 Kibana 配置项：\n    - `I18N_LOCALE=zh-CN`：设置 Kibana 界面语言为中文。\n    - `XPACK_GRAPH_ENABLED=true`、`TIMELION_ENABLED=true`：启用一些高级功能。\n    - `XPACK_MONITORING_COLLECTION_ENABLED=\"true\"`：启用监控功能。\n- **ports**: 映射主机的 5601 端口到容器的 5601 端口，用于通过浏览器访问 Kibana 界面。\n- **networks**: `kibana` 服务连接到 `es7net` 网络。\n\n#### 3. **elasticsearch**\n- **image**: 使用 `docker.elastic.co/elasticsearch/elasticsearch:7.1.0` 镜像，这是 Elasticsearch 7.1.0 的官方版本。\n- **container_name**: 容器命名为 `es7_01`。\n- **environment**: 设置 Elasticsearch 的环境变量：\n    - `cluster.name=geektime`：集群名称为 `geektime`。\n    - `node.name=es7_01`：节点名称为 `es7_01`。\n    - `bootstrap.memory_lock=true`：启用内存锁定，防止虚拟内存交换。\n    - `ES_JAVA_OPTS=-Xms512m -Xmx512m`：设置 JVM 的初始内存和最大内存为 512MB。\n    - `discovery.seed_hosts=es7_01,es7_02`：指定集群中的其他节点用于发现集群成员。\n    - `cluster.initial_master_nodes=es7_01,es7_02`：设置初始的主节点，用于集群初始化。\n- **ulimits**: 配置容器的内存锁定，`soft` 和 `hard` 都设置为 -1，表示没有限制。\n- **volumes**: 使用 `es7data1` 持久化数据。\n- **ports**: 映射主机的 9200 端口到容器的 9200 端口，允许通过 HTTP 访问 Elasticsearch。\n- **networks**: `elasticsearch` 服务连接到 `es7net` 网络。\n\n#### 4. **elasticsearch2**\n- **image**: 使用相同的 `docker.elastic.co/elasticsearch/elasticsearch:7.1.0` 镜像。\n- **container_name**: 容器命名为 `es7_02`。\n- **environment**: 与 `elasticsearch` 配置类似，唯一的区别是 `node.name` 设置为 `es7_02`，这是另一个节点。\n- **ulimits**: 配置内存锁定，和 `es7_01` 节点一致。\n- **volumes**: 使用 `es7data2` 持久化数据。\n- **networks**: `elasticsearch2` 服务连接到 `es7net` 网络。\n\n### `volumes`\n- **es7data1** 和 **es7data2**：定义了两个持久化数据卷，分别用于 Elasticsearch 节点 `es7_01` 和 `es7_02` 的数据存储，使用 `local` 驱动。\n\n### `networks`\n- **es7net**: 定义了一个名为 `es7net` 的网络，所有的服务都将连接到这个网络上。网络使用 `bridge` 驱动，适用于 Docker 容器间的通信。\n\n### 总结\n这个 `docker-compose.yml` 文件定义了一个完整的 Elasticsearch 集群（包含两个节点），同时部署了 Kibana 和 Cerebro 来进行集群管理和可视化。通过将这些服务连接到一个共享的网络 `es7net`，它们能够相互通信。数据卷 `es7data1` 和 `es7data2` 保证了 Elasticsearch 的数据持久性，即使容器停止或重启，数据也不会丢失。","slug":"elasticsearch/在Docker容器中运行Elasticsearch-Kibana和Cerebro","published":1,"updated":"2025-02-27T05:58:21.489Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8s0009ujz37gh9hrxz","content":"<p>docker-compose.yml如下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: &#x27;2.2&#x27;</span><br><span class=\"line\">services:</span><br><span class=\"line\">  cerebro:</span><br><span class=\"line\">    image: lmenezes/cerebro:0.8.3</span><br><span class=\"line\">    container_name: cerebro</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &quot;9000:9000&quot;</span><br><span class=\"line\">    command:</span><br><span class=\"line\">      - -Dhosts.0.host=http://elasticsearch:9200</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - es7net</span><br><span class=\"line\">  kibana:</span><br><span class=\"line\">    image: docker.elastic.co/kibana/kibana:7.1.0</span><br><span class=\"line\">    container_name: kibana7</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - I18N_LOCALE=zh-CN</span><br><span class=\"line\">      - XPACK_GRAPH_ENABLED=true</span><br><span class=\"line\">      - TIMELION_ENABLED=true</span><br><span class=\"line\">      - XPACK_MONITORING_COLLECTION_ENABLED=&quot;true&quot;</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &quot;5601:5601&quot;</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - es7net</span><br><span class=\"line\">  elasticsearch:</span><br><span class=\"line\">    image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0</span><br><span class=\"line\">    container_name: es7_01</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - cluster.name=geektime</span><br><span class=\"line\">      - node.name=es7_01</span><br><span class=\"line\">      - bootstrap.memory_lock=true</span><br><span class=\"line\">      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br><span class=\"line\">      - discovery.seed_hosts=es7_01,es7_02</span><br><span class=\"line\">      - cluster.initial_master_nodes=es7_01,es7_02</span><br><span class=\"line\">    ulimits:</span><br><span class=\"line\">      memlock:</span><br><span class=\"line\">        soft: -1</span><br><span class=\"line\">        hard: -1</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - es7data1:/usr/share/elasticsearch/data</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - 9200:9200</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - es7net</span><br><span class=\"line\">  elasticsearch2:</span><br><span class=\"line\">    image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0</span><br><span class=\"line\">    container_name: es7_02</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - cluster.name=geektime</span><br><span class=\"line\">      - node.name=es7_02</span><br><span class=\"line\">      - bootstrap.memory_lock=true</span><br><span class=\"line\">      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br><span class=\"line\">      - discovery.seed_hosts=es7_01,es7_02</span><br><span class=\"line\">      - cluster.initial_master_nodes=es7_01,es7_02</span><br><span class=\"line\">    ulimits:</span><br><span class=\"line\">      memlock:</span><br><span class=\"line\">        soft: -1</span><br><span class=\"line\">        hard: -1</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - es7data2:/usr/share/elasticsearch/data</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - es7net</span><br><span class=\"line\"></span><br><span class=\"line\">volumes:</span><br><span class=\"line\">  es7data1:</span><br><span class=\"line\">    driver: local</span><br><span class=\"line\">  es7data2:</span><br><span class=\"line\">    driver: local</span><br><span class=\"line\"></span><br><span class=\"line\">networks:</span><br><span class=\"line\">  es7net:</span><br><span class=\"line\">    driver: bridge</span><br></pre></td></tr></table></figure>\n<p>这个 <code>docker-compose.yml</code> 文件用于配置并部署一个包含 <strong>Elasticsearch</strong>、<strong>Kibana</strong> 和 <strong>Cerebro</strong> 的集群环境。</p>\n<h4 id=\"1-cerebro\"><a href=\"#1-cerebro\" class=\"headerlink\" title=\"1. cerebro\"></a>1. <strong>cerebro</strong></h4><ul>\n<li><strong>image</strong>: 使用 <code>lmenezes/cerebro:0.8.3</code> 这个镜像，Cerebro 是一个开源的 Elasticsearch 管理工具。</li>\n<li><strong>container_name</strong>: 将容器命名为 <code>cerebro</code>。</li>\n<li><strong>ports</strong>: 将主机的 9000 端口映射到容器内的 9000 端口，允许通过浏览器访问 Cerebro 界面。</li>\n<li><strong>command</strong>: 启动时设置参数，<code>-Dhosts.0.host=http://elasticsearch:9200</code> 指定 Cerebro 连接的 Elasticsearch 地址为 <code>elasticsearch:9200</code>。</li>\n<li><strong>networks</strong>: 配置 <code>cerebro</code> 服务连接到 <code>es7net</code> 网络。</li>\n</ul>\n<h4 id=\"2-kibana\"><a href=\"#2-kibana\" class=\"headerlink\" title=\"2. kibana\"></a>2. <strong>kibana</strong></h4><ul>\n<li><strong>image</strong>: 使用 <code>docker.elastic.co/kibana/kibana:7.1.0</code> 镜像，这是 Elasticsearch 官方的 Kibana 7.1.0 版本。</li>\n<li><strong>container_name</strong>: 容器命名为 <code>kibana7</code>。</li>\n<li><strong>environment</strong>: 设置了一些 Kibana 配置项：<ul>\n<li><code>I18N_LOCALE=zh-CN</code>：设置 Kibana 界面语言为中文。</li>\n<li><code>XPACK_GRAPH_ENABLED=true</code>、<code>TIMELION_ENABLED=true</code>：启用一些高级功能。</li>\n<li><code>XPACK_MONITORING_COLLECTION_ENABLED=&quot;true&quot;</code>：启用监控功能。</li>\n</ul>\n</li>\n<li><strong>ports</strong>: 映射主机的 5601 端口到容器的 5601 端口，用于通过浏览器访问 Kibana 界面。</li>\n<li><strong>networks</strong>: <code>kibana</code> 服务连接到 <code>es7net</code> 网络。</li>\n</ul>\n<h4 id=\"3-elasticsearch\"><a href=\"#3-elasticsearch\" class=\"headerlink\" title=\"3. elasticsearch\"></a>3. <strong>elasticsearch</strong></h4><ul>\n<li><strong>image</strong>: 使用 <code>docker.elastic.co/elasticsearch/elasticsearch:7.1.0</code> 镜像，这是 Elasticsearch 7.1.0 的官方版本。</li>\n<li><strong>container_name</strong>: 容器命名为 <code>es7_01</code>。</li>\n<li><strong>environment</strong>: 设置 Elasticsearch 的环境变量：<ul>\n<li><code>cluster.name=geektime</code>：集群名称为 <code>geektime</code>。</li>\n<li><code>node.name=es7_01</code>：节点名称为 <code>es7_01</code>。</li>\n<li><code>bootstrap.memory_lock=true</code>：启用内存锁定，防止虚拟内存交换。</li>\n<li><code>ES_JAVA_OPTS=-Xms512m -Xmx512m</code>：设置 JVM 的初始内存和最大内存为 512MB。</li>\n<li><code>discovery.seed_hosts=es7_01,es7_02</code>：指定集群中的其他节点用于发现集群成员。</li>\n<li><code>cluster.initial_master_nodes=es7_01,es7_02</code>：设置初始的主节点，用于集群初始化。</li>\n</ul>\n</li>\n<li><strong>ulimits</strong>: 配置容器的内存锁定，<code>soft</code> 和 <code>hard</code> 都设置为 -1，表示没有限制。</li>\n<li><strong>volumes</strong>: 使用 <code>es7data1</code> 持久化数据。</li>\n<li><strong>ports</strong>: 映射主机的 9200 端口到容器的 9200 端口，允许通过 HTTP 访问 Elasticsearch。</li>\n<li><strong>networks</strong>: <code>elasticsearch</code> 服务连接到 <code>es7net</code> 网络。</li>\n</ul>\n<h4 id=\"4-elasticsearch2\"><a href=\"#4-elasticsearch2\" class=\"headerlink\" title=\"4. elasticsearch2\"></a>4. <strong>elasticsearch2</strong></h4><ul>\n<li><strong>image</strong>: 使用相同的 <code>docker.elastic.co/elasticsearch/elasticsearch:7.1.0</code> 镜像。</li>\n<li><strong>container_name</strong>: 容器命名为 <code>es7_02</code>。</li>\n<li><strong>environment</strong>: 与 <code>elasticsearch</code> 配置类似，唯一的区别是 <code>node.name</code> 设置为 <code>es7_02</code>，这是另一个节点。</li>\n<li><strong>ulimits</strong>: 配置内存锁定，和 <code>es7_01</code> 节点一致。</li>\n<li><strong>volumes</strong>: 使用 <code>es7data2</code> 持久化数据。</li>\n<li><strong>networks</strong>: <code>elasticsearch2</code> 服务连接到 <code>es7net</code> 网络。</li>\n</ul>\n<h3 id=\"volumes\"><a href=\"#volumes\" class=\"headerlink\" title=\"volumes\"></a><code>volumes</code></h3><ul>\n<li><strong>es7data1</strong> 和 <strong>es7data2</strong>：定义了两个持久化数据卷，分别用于 Elasticsearch 节点 <code>es7_01</code> 和 <code>es7_02</code> 的数据存储，使用 <code>local</code> 驱动。</li>\n</ul>\n<h3 id=\"networks\"><a href=\"#networks\" class=\"headerlink\" title=\"networks\"></a><code>networks</code></h3><ul>\n<li><strong>es7net</strong>: 定义了一个名为 <code>es7net</code> 的网络，所有的服务都将连接到这个网络上。网络使用 <code>bridge</code> 驱动，适用于 Docker 容器间的通信。</li>\n</ul>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这个 <code>docker-compose.yml</code> 文件定义了一个完整的 Elasticsearch 集群（包含两个节点），同时部署了 Kibana 和 Cerebro 来进行集群管理和可视化。通过将这些服务连接到一个共享的网络 <code>es7net</code>，它们能够相互通信。数据卷 <code>es7data1</code> 和 <code>es7data2</code> 保证了 Elasticsearch 的数据持久性，即使容器停止或重启，数据也不会丢失。</p>\n","cover":false,"excerpt":"","more":"<p>docker-compose.yml如下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: &#x27;2.2&#x27;</span><br><span class=\"line\">services:</span><br><span class=\"line\">  cerebro:</span><br><span class=\"line\">    image: lmenezes/cerebro:0.8.3</span><br><span class=\"line\">    container_name: cerebro</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &quot;9000:9000&quot;</span><br><span class=\"line\">    command:</span><br><span class=\"line\">      - -Dhosts.0.host=http://elasticsearch:9200</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - es7net</span><br><span class=\"line\">  kibana:</span><br><span class=\"line\">    image: docker.elastic.co/kibana/kibana:7.1.0</span><br><span class=\"line\">    container_name: kibana7</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - I18N_LOCALE=zh-CN</span><br><span class=\"line\">      - XPACK_GRAPH_ENABLED=true</span><br><span class=\"line\">      - TIMELION_ENABLED=true</span><br><span class=\"line\">      - XPACK_MONITORING_COLLECTION_ENABLED=&quot;true&quot;</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &quot;5601:5601&quot;</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - es7net</span><br><span class=\"line\">  elasticsearch:</span><br><span class=\"line\">    image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0</span><br><span class=\"line\">    container_name: es7_01</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - cluster.name=geektime</span><br><span class=\"line\">      - node.name=es7_01</span><br><span class=\"line\">      - bootstrap.memory_lock=true</span><br><span class=\"line\">      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br><span class=\"line\">      - discovery.seed_hosts=es7_01,es7_02</span><br><span class=\"line\">      - cluster.initial_master_nodes=es7_01,es7_02</span><br><span class=\"line\">    ulimits:</span><br><span class=\"line\">      memlock:</span><br><span class=\"line\">        soft: -1</span><br><span class=\"line\">        hard: -1</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - es7data1:/usr/share/elasticsearch/data</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - 9200:9200</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - es7net</span><br><span class=\"line\">  elasticsearch2:</span><br><span class=\"line\">    image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0</span><br><span class=\"line\">    container_name: es7_02</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - cluster.name=geektime</span><br><span class=\"line\">      - node.name=es7_02</span><br><span class=\"line\">      - bootstrap.memory_lock=true</span><br><span class=\"line\">      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br><span class=\"line\">      - discovery.seed_hosts=es7_01,es7_02</span><br><span class=\"line\">      - cluster.initial_master_nodes=es7_01,es7_02</span><br><span class=\"line\">    ulimits:</span><br><span class=\"line\">      memlock:</span><br><span class=\"line\">        soft: -1</span><br><span class=\"line\">        hard: -1</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - es7data2:/usr/share/elasticsearch/data</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - es7net</span><br><span class=\"line\"></span><br><span class=\"line\">volumes:</span><br><span class=\"line\">  es7data1:</span><br><span class=\"line\">    driver: local</span><br><span class=\"line\">  es7data2:</span><br><span class=\"line\">    driver: local</span><br><span class=\"line\"></span><br><span class=\"line\">networks:</span><br><span class=\"line\">  es7net:</span><br><span class=\"line\">    driver: bridge</span><br></pre></td></tr></table></figure>\n<p>这个 <code>docker-compose.yml</code> 文件用于配置并部署一个包含 <strong>Elasticsearch</strong>、<strong>Kibana</strong> 和 <strong>Cerebro</strong> 的集群环境。</p>\n<h4 id=\"1-cerebro\"><a href=\"#1-cerebro\" class=\"headerlink\" title=\"1. cerebro\"></a>1. <strong>cerebro</strong></h4><ul>\n<li><strong>image</strong>: 使用 <code>lmenezes/cerebro:0.8.3</code> 这个镜像，Cerebro 是一个开源的 Elasticsearch 管理工具。</li>\n<li><strong>container_name</strong>: 将容器命名为 <code>cerebro</code>。</li>\n<li><strong>ports</strong>: 将主机的 9000 端口映射到容器内的 9000 端口，允许通过浏览器访问 Cerebro 界面。</li>\n<li><strong>command</strong>: 启动时设置参数，<code>-Dhosts.0.host=http://elasticsearch:9200</code> 指定 Cerebro 连接的 Elasticsearch 地址为 <code>elasticsearch:9200</code>。</li>\n<li><strong>networks</strong>: 配置 <code>cerebro</code> 服务连接到 <code>es7net</code> 网络。</li>\n</ul>\n<h4 id=\"2-kibana\"><a href=\"#2-kibana\" class=\"headerlink\" title=\"2. kibana\"></a>2. <strong>kibana</strong></h4><ul>\n<li><strong>image</strong>: 使用 <code>docker.elastic.co/kibana/kibana:7.1.0</code> 镜像，这是 Elasticsearch 官方的 Kibana 7.1.0 版本。</li>\n<li><strong>container_name</strong>: 容器命名为 <code>kibana7</code>。</li>\n<li><strong>environment</strong>: 设置了一些 Kibana 配置项：<ul>\n<li><code>I18N_LOCALE=zh-CN</code>：设置 Kibana 界面语言为中文。</li>\n<li><code>XPACK_GRAPH_ENABLED=true</code>、<code>TIMELION_ENABLED=true</code>：启用一些高级功能。</li>\n<li><code>XPACK_MONITORING_COLLECTION_ENABLED=&quot;true&quot;</code>：启用监控功能。</li>\n</ul>\n</li>\n<li><strong>ports</strong>: 映射主机的 5601 端口到容器的 5601 端口，用于通过浏览器访问 Kibana 界面。</li>\n<li><strong>networks</strong>: <code>kibana</code> 服务连接到 <code>es7net</code> 网络。</li>\n</ul>\n<h4 id=\"3-elasticsearch\"><a href=\"#3-elasticsearch\" class=\"headerlink\" title=\"3. elasticsearch\"></a>3. <strong>elasticsearch</strong></h4><ul>\n<li><strong>image</strong>: 使用 <code>docker.elastic.co/elasticsearch/elasticsearch:7.1.0</code> 镜像，这是 Elasticsearch 7.1.0 的官方版本。</li>\n<li><strong>container_name</strong>: 容器命名为 <code>es7_01</code>。</li>\n<li><strong>environment</strong>: 设置 Elasticsearch 的环境变量：<ul>\n<li><code>cluster.name=geektime</code>：集群名称为 <code>geektime</code>。</li>\n<li><code>node.name=es7_01</code>：节点名称为 <code>es7_01</code>。</li>\n<li><code>bootstrap.memory_lock=true</code>：启用内存锁定，防止虚拟内存交换。</li>\n<li><code>ES_JAVA_OPTS=-Xms512m -Xmx512m</code>：设置 JVM 的初始内存和最大内存为 512MB。</li>\n<li><code>discovery.seed_hosts=es7_01,es7_02</code>：指定集群中的其他节点用于发现集群成员。</li>\n<li><code>cluster.initial_master_nodes=es7_01,es7_02</code>：设置初始的主节点，用于集群初始化。</li>\n</ul>\n</li>\n<li><strong>ulimits</strong>: 配置容器的内存锁定，<code>soft</code> 和 <code>hard</code> 都设置为 -1，表示没有限制。</li>\n<li><strong>volumes</strong>: 使用 <code>es7data1</code> 持久化数据。</li>\n<li><strong>ports</strong>: 映射主机的 9200 端口到容器的 9200 端口，允许通过 HTTP 访问 Elasticsearch。</li>\n<li><strong>networks</strong>: <code>elasticsearch</code> 服务连接到 <code>es7net</code> 网络。</li>\n</ul>\n<h4 id=\"4-elasticsearch2\"><a href=\"#4-elasticsearch2\" class=\"headerlink\" title=\"4. elasticsearch2\"></a>4. <strong>elasticsearch2</strong></h4><ul>\n<li><strong>image</strong>: 使用相同的 <code>docker.elastic.co/elasticsearch/elasticsearch:7.1.0</code> 镜像。</li>\n<li><strong>container_name</strong>: 容器命名为 <code>es7_02</code>。</li>\n<li><strong>environment</strong>: 与 <code>elasticsearch</code> 配置类似，唯一的区别是 <code>node.name</code> 设置为 <code>es7_02</code>，这是另一个节点。</li>\n<li><strong>ulimits</strong>: 配置内存锁定，和 <code>es7_01</code> 节点一致。</li>\n<li><strong>volumes</strong>: 使用 <code>es7data2</code> 持久化数据。</li>\n<li><strong>networks</strong>: <code>elasticsearch2</code> 服务连接到 <code>es7net</code> 网络。</li>\n</ul>\n<h3 id=\"volumes\"><a href=\"#volumes\" class=\"headerlink\" title=\"volumes\"></a><code>volumes</code></h3><ul>\n<li><strong>es7data1</strong> 和 <strong>es7data2</strong>：定义了两个持久化数据卷，分别用于 Elasticsearch 节点 <code>es7_01</code> 和 <code>es7_02</code> 的数据存储，使用 <code>local</code> 驱动。</li>\n</ul>\n<h3 id=\"networks\"><a href=\"#networks\" class=\"headerlink\" title=\"networks\"></a><code>networks</code></h3><ul>\n<li><strong>es7net</strong>: 定义了一个名为 <code>es7net</code> 的网络，所有的服务都将连接到这个网络上。网络使用 <code>bridge</code> 驱动，适用于 Docker 容器间的通信。</li>\n</ul>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这个 <code>docker-compose.yml</code> 文件定义了一个完整的 Elasticsearch 集群（包含两个节点），同时部署了 Kibana 和 Cerebro 来进行集群管理和可视化。通过将这些服务连接到一个共享的网络 <code>es7net</code>，它们能够相互通信。数据卷 <code>es7data1</code> 和 <code>es7data2</code> 保证了 Elasticsearch 的数据持久性，即使容器停止或重启，数据也不会丢失。</p>\n"},{"title":"将生产的流量镜像到预生产环境的一些思考","date":"2025-06-24T07:06:47.000Z","_content":"在生产环境中将流量复制（或称**流量镜像**、**shadow traffic / traffic mirroring**）到预生产环境，是一种非常常见的**预发布验证、压测、安全测试手段**。\n\n下面是一个完整的实现方案，包含多个常见做法、工具和注意事项。\n\n---\n\n## 🧭 一、核心目标\n\n* **从生产环境获取真实请求流量**\n* **将流量同时复制一份（不影响真实用户）**\n* **发送到预生产环境的服务进行验证或压测**\n* **预生产环境的返回值不影响真实用户**\n\n---\n\n## 🧰 二、可选方案汇总（推荐方式在前）\n\n| 方法                                          | 是否推荐 | 说明                  |\n| ------------------------------------------- | ---- | ------------------- |\n| ✅ **使用服务网关流量镜像功能（如 Envoy、Istio）**           | ⭐⭐⭐⭐ | 自动镜像请求，业界主流做法       |\n| ✅ **使用 Nginx + mirror 模块**                  | ⭐⭐⭐  | 简单可靠，适用于中小项目        |\n| ✅ **代码层拦截 & 异步复制（如 Spring Gateway Filter）** | ⭐⭐   | 可控性强，但开发成本高         |\n| ❌ **通过日志回放/抓包再重放**                          | ⭐    | 不是真实“实时”流量，仅适用于离线分析 |\n\n---\n\n## 🧩 三、主流方式详解\n\n---\n\n### ✅ 方式一：**Envoy / Istio 流量镜像（推荐）**\n\n适用于微服务、Kubernetes、服务网格环境。\n\n#### 示例配置（Envoy）\n\n```yaml\nhttp_filters:\n- name: envoy.filters.http.router\n  typed_config:\n    \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n    shadow_policy:\n      cluster: mirror-preprod\n      runtime_fraction:\n        default_value:\n          numerator: 100\n          denominator: HUNDRED\n```\n\n说明：\n\n* 请求发往主 cluster（生产）\n* 同时 shadow 一份给 `mirror-preprod`（预发布）\n\n---\n\n### ✅ 方式二：**Nginx `mirror` 模块**\n\n适合非服务网格场景，只要你在入口使用的是 Nginx 就能支持。\n\n#### 示例配置：\n\n```nginx\nserver {\n    listen 80;\n\n    location / {\n        mirror /mirror;\n        mirror_request_body on;\n\n        proxy_pass http://prod_backend;\n    }\n\n    location = /mirror {\n        internal;\n        proxy_pass http://preprod_backend;\n    }\n}\n```\n\n说明：\n\n* `mirror` 指令会将请求复制给 `/mirror` 路径\n* 通过 `internal` 不影响正常响应\n\n---\n\n### ✅ 方式三：**代码层拦截 + 异步复制（Spring Gateway、Filter等）**\n\n适合你自己控制网关/服务逻辑时使用。\n\n#### Spring Gateway 示例（伪代码）：\n\n```java\npublic class TrafficMirrorFilter implements GlobalFilter {\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        // 复制请求\n        HttpRequest originalRequest = exchange.getRequest();\n        sendAsyncToPreProd(originalRequest);\n        return chain.filter(exchange);\n    }\n}\n```\n\n注意：\n\n* 要 **异步发送**，不能阻塞主请求\n* 可使用 `WebClient`、`HttpClient` 等发往预发布地址\n\n---\n\n## 🛑 注意事项\n\n| 事项         | 说明                            |\n| ---------- | ----------------------------- |\n| 不应影响主业务    | 镜像流量**不能影响**生产系统响应            |\n| 不应对预发布写入数据 | 如果是下单/删除类操作，要避免在预发布环境**真的执行** |\n| 考虑敏感信息保护   | 请求中可能包含用户 token、手机号等，要做脱敏或隔离  |\n| QPS 限流     | 预发布环境性能较低，需做限流或镜像比例控制         |\n| 日志区分       | 镜像请求日志要能明显区分，以免干扰监控/告警        |\n\n---\n\n## ✅ 推荐实施步骤\n\n1. **网关接入层选型**\n\n    * 如果你有 API Gateway（如 Kong、Nginx、Istio、Envoy）→ 推荐用网关层做镜像\n2. **选定目标镜像路径**\n\n    * 一般是 `/api/**` 类接口，但不包括登录、上传大文件等\n3. **开启灰度镜像（比例复制）**\n\n    * 初期可设置 10% 流量镜像，避免打垮预发布\n4. **在预发布环境配置完整监控**\n\n    * 确保响应时间、错误率、业务一致性能追踪\n5. **观察一段时间后扩大镜像比例或做回归测试**\n\n---\n\n## 🎯 实战建议\n\n* 如果你在使用 **K8s** 或微服务架构：优先考虑 Envoy / Istio 实现\n* 如果你用的是 **Nginx 接入层**：可优先尝试 `mirror` 模块\n* 如果你想要 **精细控制、低流量镜像**：代码级实现最灵活\n\n---\n\n如你告诉我你当前系统是基于什么架构（Spring Boot？K8s？Nginx？API Gateway？），我可以为你定制一套镜像流量配置模板或代码方案。是否需要？\n","source":"_posts/k8s/将生产的流量镜像到预生产环境的一些思考.md","raw":"---\ntitle: 将生产的流量镜像到预生产环境的一些思考\ndate: 2025-06-24 15:06:47\ntags: k8s\ncategories: 生产环境\n---\n在生产环境中将流量复制（或称**流量镜像**、**shadow traffic / traffic mirroring**）到预生产环境，是一种非常常见的**预发布验证、压测、安全测试手段**。\n\n下面是一个完整的实现方案，包含多个常见做法、工具和注意事项。\n\n---\n\n## 🧭 一、核心目标\n\n* **从生产环境获取真实请求流量**\n* **将流量同时复制一份（不影响真实用户）**\n* **发送到预生产环境的服务进行验证或压测**\n* **预生产环境的返回值不影响真实用户**\n\n---\n\n## 🧰 二、可选方案汇总（推荐方式在前）\n\n| 方法                                          | 是否推荐 | 说明                  |\n| ------------------------------------------- | ---- | ------------------- |\n| ✅ **使用服务网关流量镜像功能（如 Envoy、Istio）**           | ⭐⭐⭐⭐ | 自动镜像请求，业界主流做法       |\n| ✅ **使用 Nginx + mirror 模块**                  | ⭐⭐⭐  | 简单可靠，适用于中小项目        |\n| ✅ **代码层拦截 & 异步复制（如 Spring Gateway Filter）** | ⭐⭐   | 可控性强，但开发成本高         |\n| ❌ **通过日志回放/抓包再重放**                          | ⭐    | 不是真实“实时”流量，仅适用于离线分析 |\n\n---\n\n## 🧩 三、主流方式详解\n\n---\n\n### ✅ 方式一：**Envoy / Istio 流量镜像（推荐）**\n\n适用于微服务、Kubernetes、服务网格环境。\n\n#### 示例配置（Envoy）\n\n```yaml\nhttp_filters:\n- name: envoy.filters.http.router\n  typed_config:\n    \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n    shadow_policy:\n      cluster: mirror-preprod\n      runtime_fraction:\n        default_value:\n          numerator: 100\n          denominator: HUNDRED\n```\n\n说明：\n\n* 请求发往主 cluster（生产）\n* 同时 shadow 一份给 `mirror-preprod`（预发布）\n\n---\n\n### ✅ 方式二：**Nginx `mirror` 模块**\n\n适合非服务网格场景，只要你在入口使用的是 Nginx 就能支持。\n\n#### 示例配置：\n\n```nginx\nserver {\n    listen 80;\n\n    location / {\n        mirror /mirror;\n        mirror_request_body on;\n\n        proxy_pass http://prod_backend;\n    }\n\n    location = /mirror {\n        internal;\n        proxy_pass http://preprod_backend;\n    }\n}\n```\n\n说明：\n\n* `mirror` 指令会将请求复制给 `/mirror` 路径\n* 通过 `internal` 不影响正常响应\n\n---\n\n### ✅ 方式三：**代码层拦截 + 异步复制（Spring Gateway、Filter等）**\n\n适合你自己控制网关/服务逻辑时使用。\n\n#### Spring Gateway 示例（伪代码）：\n\n```java\npublic class TrafficMirrorFilter implements GlobalFilter {\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        // 复制请求\n        HttpRequest originalRequest = exchange.getRequest();\n        sendAsyncToPreProd(originalRequest);\n        return chain.filter(exchange);\n    }\n}\n```\n\n注意：\n\n* 要 **异步发送**，不能阻塞主请求\n* 可使用 `WebClient`、`HttpClient` 等发往预发布地址\n\n---\n\n## 🛑 注意事项\n\n| 事项         | 说明                            |\n| ---------- | ----------------------------- |\n| 不应影响主业务    | 镜像流量**不能影响**生产系统响应            |\n| 不应对预发布写入数据 | 如果是下单/删除类操作，要避免在预发布环境**真的执行** |\n| 考虑敏感信息保护   | 请求中可能包含用户 token、手机号等，要做脱敏或隔离  |\n| QPS 限流     | 预发布环境性能较低，需做限流或镜像比例控制         |\n| 日志区分       | 镜像请求日志要能明显区分，以免干扰监控/告警        |\n\n---\n\n## ✅ 推荐实施步骤\n\n1. **网关接入层选型**\n\n    * 如果你有 API Gateway（如 Kong、Nginx、Istio、Envoy）→ 推荐用网关层做镜像\n2. **选定目标镜像路径**\n\n    * 一般是 `/api/**` 类接口，但不包括登录、上传大文件等\n3. **开启灰度镜像（比例复制）**\n\n    * 初期可设置 10% 流量镜像，避免打垮预发布\n4. **在预发布环境配置完整监控**\n\n    * 确保响应时间、错误率、业务一致性能追踪\n5. **观察一段时间后扩大镜像比例或做回归测试**\n\n---\n\n## 🎯 实战建议\n\n* 如果你在使用 **K8s** 或微服务架构：优先考虑 Envoy / Istio 实现\n* 如果你用的是 **Nginx 接入层**：可优先尝试 `mirror` 模块\n* 如果你想要 **精细控制、低流量镜像**：代码级实现最灵活\n\n---\n\n如你告诉我你当前系统是基于什么架构（Spring Boot？K8s？Nginx？API Gateway？），我可以为你定制一套镜像流量配置模板或代码方案。是否需要？\n","slug":"k8s/将生产的流量镜像到预生产环境的一些思考","published":1,"updated":"2025-06-24T07:07:35.789Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8t000dujz3d3skh9w2","content":"<p>在生产环境中将流量复制（或称<strong>流量镜像</strong>、<strong>shadow traffic &#x2F; traffic mirroring</strong>）到预生产环境，是一种非常常见的<strong>预发布验证、压测、安全测试手段</strong>。</p>\n<p>下面是一个完整的实现方案，包含多个常见做法、工具和注意事项。</p>\n<hr>\n<h2 id=\"🧭-一、核心目标\"><a href=\"#🧭-一、核心目标\" class=\"headerlink\" title=\"🧭 一、核心目标\"></a>🧭 一、核心目标</h2><ul>\n<li><strong>从生产环境获取真实请求流量</strong></li>\n<li><strong>将流量同时复制一份（不影响真实用户）</strong></li>\n<li><strong>发送到预生产环境的服务进行验证或压测</strong></li>\n<li><strong>预生产环境的返回值不影响真实用户</strong></li>\n</ul>\n<hr>\n<h2 id=\"🧰-二、可选方案汇总（推荐方式在前）\"><a href=\"#🧰-二、可选方案汇总（推荐方式在前）\" class=\"headerlink\" title=\"🧰 二、可选方案汇总（推荐方式在前）\"></a>🧰 二、可选方案汇总（推荐方式在前）</h2><table>\n<thead>\n<tr>\n<th>方法</th>\n<th>是否推荐</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>✅ <strong>使用服务网关流量镜像功能（如 Envoy、Istio）</strong></td>\n<td>⭐⭐⭐⭐</td>\n<td>自动镜像请求，业界主流做法</td>\n</tr>\n<tr>\n<td>✅ <strong>使用 Nginx + mirror 模块</strong></td>\n<td>⭐⭐⭐</td>\n<td>简单可靠，适用于中小项目</td>\n</tr>\n<tr>\n<td>✅ <strong>代码层拦截 &amp; 异步复制（如 Spring Gateway Filter）</strong></td>\n<td>⭐⭐</td>\n<td>可控性强，但开发成本高</td>\n</tr>\n<tr>\n<td>❌ <strong>通过日志回放&#x2F;抓包再重放</strong></td>\n<td>⭐</td>\n<td>不是真实“实时”流量，仅适用于离线分析</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"🧩-三、主流方式详解\"><a href=\"#🧩-三、主流方式详解\" class=\"headerlink\" title=\"🧩 三、主流方式详解\"></a>🧩 三、主流方式详解</h2><hr>\n<h3 id=\"✅-方式一：Envoy-Istio-流量镜像（推荐）\"><a href=\"#✅-方式一：Envoy-Istio-流量镜像（推荐）\" class=\"headerlink\" title=\"✅ 方式一：Envoy &#x2F; Istio 流量镜像（推荐）\"></a>✅ 方式一：<strong>Envoy &#x2F; Istio 流量镜像（推荐）</strong></h3><p>适用于微服务、Kubernetes、服务网格环境。</p>\n<h4 id=\"示例配置（Envoy）\"><a href=\"#示例配置（Envoy）\" class=\"headerlink\" title=\"示例配置（Envoy）\"></a>示例配置（Envoy）</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">http_filters:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">envoy.filters.http.router</span></span><br><span class=\"line\">  <span class=\"attr\">typed_config:</span></span><br><span class=\"line\">    <span class=\"string\">&quot;@type&quot;</span><span class=\"string\">:</span> <span class=\"string\">type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span></span><br><span class=\"line\">    <span class=\"attr\">shadow_policy:</span></span><br><span class=\"line\">      <span class=\"attr\">cluster:</span> <span class=\"string\">mirror-preprod</span></span><br><span class=\"line\">      <span class=\"attr\">runtime_fraction:</span></span><br><span class=\"line\">        <span class=\"attr\">default_value:</span></span><br><span class=\"line\">          <span class=\"attr\">numerator:</span> <span class=\"number\">100</span></span><br><span class=\"line\">          <span class=\"attr\">denominator:</span> <span class=\"string\">HUNDRED</span></span><br></pre></td></tr></table></figure>\n\n<p>说明：</p>\n<ul>\n<li>请求发往主 cluster（生产）</li>\n<li>同时 shadow 一份给 <code>mirror-preprod</code>（预发布）</li>\n</ul>\n<hr>\n<h3 id=\"✅-方式二：Nginx-mirror-模块\"><a href=\"#✅-方式二：Nginx-mirror-模块\" class=\"headerlink\" title=\"✅ 方式二：Nginx mirror 模块\"></a>✅ 方式二：<strong>Nginx <code>mirror</code> 模块</strong></h3><p>适合非服务网格场景，只要你在入口使用的是 Nginx 就能支持。</p>\n<h4 id=\"示例配置：\"><a href=\"#示例配置：\" class=\"headerlink\" title=\"示例配置：\"></a>示例配置：</h4><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">mirror</span> /mirror;</span><br><span class=\"line\">        <span class=\"attribute\">mirror_request_body</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://prod_backend;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> = /mirror &#123;</span><br><span class=\"line\">        internal;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://preprod_backend;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>说明：</p>\n<ul>\n<li><code>mirror</code> 指令会将请求复制给 <code>/mirror</code> 路径</li>\n<li>通过 <code>internal</code> 不影响正常响应</li>\n</ul>\n<hr>\n<h3 id=\"✅-方式三：代码层拦截-异步复制（Spring-Gateway、Filter等）\"><a href=\"#✅-方式三：代码层拦截-异步复制（Spring-Gateway、Filter等）\" class=\"headerlink\" title=\"✅ 方式三：代码层拦截 + 异步复制（Spring Gateway、Filter等）\"></a>✅ 方式三：<strong>代码层拦截 + 异步复制（Spring Gateway、Filter等）</strong></h3><p>适合你自己控制网关&#x2F;服务逻辑时使用。</p>\n<h4 id=\"Spring-Gateway-示例（伪代码）：\"><a href=\"#Spring-Gateway-示例（伪代码）：\" class=\"headerlink\" title=\"Spring Gateway 示例（伪代码）：\"></a>Spring Gateway 示例（伪代码）：</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TrafficMirrorFilter</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">GlobalFilter</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title function_\">filter</span><span class=\"params\">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 复制请求</span></span><br><span class=\"line\">        <span class=\"type\">HttpRequest</span> <span class=\"variable\">originalRequest</span> <span class=\"operator\">=</span> exchange.getRequest();</span><br><span class=\"line\">        sendAsyncToPreProd(originalRequest);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> chain.filter(exchange);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>注意：</p>\n<ul>\n<li>要 <strong>异步发送</strong>，不能阻塞主请求</li>\n<li>可使用 <code>WebClient</code>、<code>HttpClient</code> 等发往预发布地址</li>\n</ul>\n<hr>\n<h2 id=\"🛑-注意事项\"><a href=\"#🛑-注意事项\" class=\"headerlink\" title=\"🛑 注意事项\"></a>🛑 注意事项</h2><table>\n<thead>\n<tr>\n<th>事项</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>不应影响主业务</td>\n<td>镜像流量<strong>不能影响</strong>生产系统响应</td>\n</tr>\n<tr>\n<td>不应对预发布写入数据</td>\n<td>如果是下单&#x2F;删除类操作，要避免在预发布环境<strong>真的执行</strong></td>\n</tr>\n<tr>\n<td>考虑敏感信息保护</td>\n<td>请求中可能包含用户 token、手机号等，要做脱敏或隔离</td>\n</tr>\n<tr>\n<td>QPS 限流</td>\n<td>预发布环境性能较低，需做限流或镜像比例控制</td>\n</tr>\n<tr>\n<td>日志区分</td>\n<td>镜像请求日志要能明显区分，以免干扰监控&#x2F;告警</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"✅-推荐实施步骤\"><a href=\"#✅-推荐实施步骤\" class=\"headerlink\" title=\"✅ 推荐实施步骤\"></a>✅ 推荐实施步骤</h2><ol>\n<li><p><strong>网关接入层选型</strong></p>\n<ul>\n<li>如果你有 API Gateway（如 Kong、Nginx、Istio、Envoy）→ 推荐用网关层做镜像</li>\n</ul>\n</li>\n<li><p><strong>选定目标镜像路径</strong></p>\n<ul>\n<li>一般是 <code>/api/**</code> 类接口，但不包括登录、上传大文件等</li>\n</ul>\n</li>\n<li><p><strong>开启灰度镜像（比例复制）</strong></p>\n<ul>\n<li>初期可设置 10% 流量镜像，避免打垮预发布</li>\n</ul>\n</li>\n<li><p><strong>在预发布环境配置完整监控</strong></p>\n<ul>\n<li>确保响应时间、错误率、业务一致性能追踪</li>\n</ul>\n</li>\n<li><p><strong>观察一段时间后扩大镜像比例或做回归测试</strong></p>\n</li>\n</ol>\n<hr>\n<h2 id=\"🎯-实战建议\"><a href=\"#🎯-实战建议\" class=\"headerlink\" title=\"🎯 实战建议\"></a>🎯 实战建议</h2><ul>\n<li>如果你在使用 <strong>K8s</strong> 或微服务架构：优先考虑 Envoy &#x2F; Istio 实现</li>\n<li>如果你用的是 <strong>Nginx 接入层</strong>：可优先尝试 <code>mirror</code> 模块</li>\n<li>如果你想要 <strong>精细控制、低流量镜像</strong>：代码级实现最灵活</li>\n</ul>\n<hr>\n<p>如你告诉我你当前系统是基于什么架构（Spring Boot？K8s？Nginx？API Gateway？），我可以为你定制一套镜像流量配置模板或代码方案。是否需要？</p>\n","cover":false,"excerpt":"","more":"<p>在生产环境中将流量复制（或称<strong>流量镜像</strong>、<strong>shadow traffic &#x2F; traffic mirroring</strong>）到预生产环境，是一种非常常见的<strong>预发布验证、压测、安全测试手段</strong>。</p>\n<p>下面是一个完整的实现方案，包含多个常见做法、工具和注意事项。</p>\n<hr>\n<h2 id=\"🧭-一、核心目标\"><a href=\"#🧭-一、核心目标\" class=\"headerlink\" title=\"🧭 一、核心目标\"></a>🧭 一、核心目标</h2><ul>\n<li><strong>从生产环境获取真实请求流量</strong></li>\n<li><strong>将流量同时复制一份（不影响真实用户）</strong></li>\n<li><strong>发送到预生产环境的服务进行验证或压测</strong></li>\n<li><strong>预生产环境的返回值不影响真实用户</strong></li>\n</ul>\n<hr>\n<h2 id=\"🧰-二、可选方案汇总（推荐方式在前）\"><a href=\"#🧰-二、可选方案汇总（推荐方式在前）\" class=\"headerlink\" title=\"🧰 二、可选方案汇总（推荐方式在前）\"></a>🧰 二、可选方案汇总（推荐方式在前）</h2><table>\n<thead>\n<tr>\n<th>方法</th>\n<th>是否推荐</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>✅ <strong>使用服务网关流量镜像功能（如 Envoy、Istio）</strong></td>\n<td>⭐⭐⭐⭐</td>\n<td>自动镜像请求，业界主流做法</td>\n</tr>\n<tr>\n<td>✅ <strong>使用 Nginx + mirror 模块</strong></td>\n<td>⭐⭐⭐</td>\n<td>简单可靠，适用于中小项目</td>\n</tr>\n<tr>\n<td>✅ <strong>代码层拦截 &amp; 异步复制（如 Spring Gateway Filter）</strong></td>\n<td>⭐⭐</td>\n<td>可控性强，但开发成本高</td>\n</tr>\n<tr>\n<td>❌ <strong>通过日志回放&#x2F;抓包再重放</strong></td>\n<td>⭐</td>\n<td>不是真实“实时”流量，仅适用于离线分析</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"🧩-三、主流方式详解\"><a href=\"#🧩-三、主流方式详解\" class=\"headerlink\" title=\"🧩 三、主流方式详解\"></a>🧩 三、主流方式详解</h2><hr>\n<h3 id=\"✅-方式一：Envoy-Istio-流量镜像（推荐）\"><a href=\"#✅-方式一：Envoy-Istio-流量镜像（推荐）\" class=\"headerlink\" title=\"✅ 方式一：Envoy &#x2F; Istio 流量镜像（推荐）\"></a>✅ 方式一：<strong>Envoy &#x2F; Istio 流量镜像（推荐）</strong></h3><p>适用于微服务、Kubernetes、服务网格环境。</p>\n<h4 id=\"示例配置（Envoy）\"><a href=\"#示例配置（Envoy）\" class=\"headerlink\" title=\"示例配置（Envoy）\"></a>示例配置（Envoy）</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">http_filters:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">envoy.filters.http.router</span></span><br><span class=\"line\">  <span class=\"attr\">typed_config:</span></span><br><span class=\"line\">    <span class=\"string\">&quot;@type&quot;</span><span class=\"string\">:</span> <span class=\"string\">type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span></span><br><span class=\"line\">    <span class=\"attr\">shadow_policy:</span></span><br><span class=\"line\">      <span class=\"attr\">cluster:</span> <span class=\"string\">mirror-preprod</span></span><br><span class=\"line\">      <span class=\"attr\">runtime_fraction:</span></span><br><span class=\"line\">        <span class=\"attr\">default_value:</span></span><br><span class=\"line\">          <span class=\"attr\">numerator:</span> <span class=\"number\">100</span></span><br><span class=\"line\">          <span class=\"attr\">denominator:</span> <span class=\"string\">HUNDRED</span></span><br></pre></td></tr></table></figure>\n\n<p>说明：</p>\n<ul>\n<li>请求发往主 cluster（生产）</li>\n<li>同时 shadow 一份给 <code>mirror-preprod</code>（预发布）</li>\n</ul>\n<hr>\n<h3 id=\"✅-方式二：Nginx-mirror-模块\"><a href=\"#✅-方式二：Nginx-mirror-模块\" class=\"headerlink\" title=\"✅ 方式二：Nginx mirror 模块\"></a>✅ 方式二：<strong>Nginx <code>mirror</code> 模块</strong></h3><p>适合非服务网格场景，只要你在入口使用的是 Nginx 就能支持。</p>\n<h4 id=\"示例配置：\"><a href=\"#示例配置：\" class=\"headerlink\" title=\"示例配置：\"></a>示例配置：</h4><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">mirror</span> /mirror;</span><br><span class=\"line\">        <span class=\"attribute\">mirror_request_body</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://prod_backend;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> = /mirror &#123;</span><br><span class=\"line\">        internal;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://preprod_backend;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>说明：</p>\n<ul>\n<li><code>mirror</code> 指令会将请求复制给 <code>/mirror</code> 路径</li>\n<li>通过 <code>internal</code> 不影响正常响应</li>\n</ul>\n<hr>\n<h3 id=\"✅-方式三：代码层拦截-异步复制（Spring-Gateway、Filter等）\"><a href=\"#✅-方式三：代码层拦截-异步复制（Spring-Gateway、Filter等）\" class=\"headerlink\" title=\"✅ 方式三：代码层拦截 + 异步复制（Spring Gateway、Filter等）\"></a>✅ 方式三：<strong>代码层拦截 + 异步复制（Spring Gateway、Filter等）</strong></h3><p>适合你自己控制网关&#x2F;服务逻辑时使用。</p>\n<h4 id=\"Spring-Gateway-示例（伪代码）：\"><a href=\"#Spring-Gateway-示例（伪代码）：\" class=\"headerlink\" title=\"Spring Gateway 示例（伪代码）：\"></a>Spring Gateway 示例（伪代码）：</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TrafficMirrorFilter</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">GlobalFilter</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title function_\">filter</span><span class=\"params\">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 复制请求</span></span><br><span class=\"line\">        <span class=\"type\">HttpRequest</span> <span class=\"variable\">originalRequest</span> <span class=\"operator\">=</span> exchange.getRequest();</span><br><span class=\"line\">        sendAsyncToPreProd(originalRequest);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> chain.filter(exchange);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>注意：</p>\n<ul>\n<li>要 <strong>异步发送</strong>，不能阻塞主请求</li>\n<li>可使用 <code>WebClient</code>、<code>HttpClient</code> 等发往预发布地址</li>\n</ul>\n<hr>\n<h2 id=\"🛑-注意事项\"><a href=\"#🛑-注意事项\" class=\"headerlink\" title=\"🛑 注意事项\"></a>🛑 注意事项</h2><table>\n<thead>\n<tr>\n<th>事项</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>不应影响主业务</td>\n<td>镜像流量<strong>不能影响</strong>生产系统响应</td>\n</tr>\n<tr>\n<td>不应对预发布写入数据</td>\n<td>如果是下单&#x2F;删除类操作，要避免在预发布环境<strong>真的执行</strong></td>\n</tr>\n<tr>\n<td>考虑敏感信息保护</td>\n<td>请求中可能包含用户 token、手机号等，要做脱敏或隔离</td>\n</tr>\n<tr>\n<td>QPS 限流</td>\n<td>预发布环境性能较低，需做限流或镜像比例控制</td>\n</tr>\n<tr>\n<td>日志区分</td>\n<td>镜像请求日志要能明显区分，以免干扰监控&#x2F;告警</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"✅-推荐实施步骤\"><a href=\"#✅-推荐实施步骤\" class=\"headerlink\" title=\"✅ 推荐实施步骤\"></a>✅ 推荐实施步骤</h2><ol>\n<li><p><strong>网关接入层选型</strong></p>\n<ul>\n<li>如果你有 API Gateway（如 Kong、Nginx、Istio、Envoy）→ 推荐用网关层做镜像</li>\n</ul>\n</li>\n<li><p><strong>选定目标镜像路径</strong></p>\n<ul>\n<li>一般是 <code>/api/**</code> 类接口，但不包括登录、上传大文件等</li>\n</ul>\n</li>\n<li><p><strong>开启灰度镜像（比例复制）</strong></p>\n<ul>\n<li>初期可设置 10% 流量镜像，避免打垮预发布</li>\n</ul>\n</li>\n<li><p><strong>在预发布环境配置完整监控</strong></p>\n<ul>\n<li>确保响应时间、错误率、业务一致性能追踪</li>\n</ul>\n</li>\n<li><p><strong>观察一段时间后扩大镜像比例或做回归测试</strong></p>\n</li>\n</ol>\n<hr>\n<h2 id=\"🎯-实战建议\"><a href=\"#🎯-实战建议\" class=\"headerlink\" title=\"🎯 实战建议\"></a>🎯 实战建议</h2><ul>\n<li>如果你在使用 <strong>K8s</strong> 或微服务架构：优先考虑 Envoy &#x2F; Istio 实现</li>\n<li>如果你用的是 <strong>Nginx 接入层</strong>：可优先尝试 <code>mirror</code> 模块</li>\n<li>如果你想要 <strong>精细控制、低流量镜像</strong>：代码级实现最灵活</li>\n</ul>\n<hr>\n<p>如你告诉我你当前系统是基于什么架构（Spring Boot？K8s？Nginx？API Gateway？），我可以为你定制一套镜像流量配置模板或代码方案。是否需要？</p>\n"},{"title":"docker中运行chrome并使用代码控制","date":"2025-03-18T07:38:54.000Z","_content":"#使用docker运行chrome\n```shell\ndocker run -d -p 4444:4444 -p 5900:5900 --name selenium-chrome-debug selenium/standalone-chrome-debug\ndocker run -d -p 4444:4444 -p 5900:5900 \\\n  --name selenium-chrome-debug \\\n  -e TZ=\"US/Pacific\" \\\n  -v /dev/shm:/dev/shm \\\n  -v /opt/chrome/chrome-data:/home/seluser/.cache --privileged \\\n  selenium/standalone-chrome-debug\n\n\n```\n#使用java代码控制chrome\n```java\npackage org.example;\n\nimport org.openqa.selenium.By;\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.WebElement;\nimport org.openqa.selenium.chrome.ChromeOptions;\nimport org.openqa.selenium.remote.RemoteWebDriver;\nimport java.net.MalformedURLException;\nimport java.net.URL;\n\npublic class SeleniumDockerTest {\n    public static void main(String[] args) {\n        ChromeOptions options = new ChromeOptions();\n        options.addArguments(\"--disable-dev-shm-usage\");  // 解决 Chrome 崩溃问题\n        options.addArguments(\"--no-sandbox\");  // 避免 Chrome 在容器中受限制\n//        options.addArguments(\"--user-data-dir=/home/seluser\");  // 设置 Chrome 用户数据目录\n\n        WebDriver driver = null;\n        try {\n            driver = new RemoteWebDriver(new URL(\"http://10.8.0.5:4444/wd/hub\"), options);\n\n            driver.get(\"https://www.jd.com\");\n            System.out.println(\"页面标题: \" + driver.getTitle());\n            WebElement body = driver.findElement(By.cssSelector(\"#J_cate > ul\"));\n            System.out.println(\"页面内容: \" + body.getText());\n            System.in.read();\n        } catch (Exception e) {\n            e.printStackTrace();\n            System.out.println(\"错误: \" + e.getMessage());\n        } finally {\n            if (driver != null) {\n                driver.quit();\n            }\n        }\n    }\n}\n\n```","source":"_posts/docker/docker中运行chrome并使用代码控制.md","raw":"---\ntitle: docker中运行chrome并使用代码控制\ndate: 2025-03-18 15:38:54\ncategories: docker\ntag: chrome\n---\n#使用docker运行chrome\n```shell\ndocker run -d -p 4444:4444 -p 5900:5900 --name selenium-chrome-debug selenium/standalone-chrome-debug\ndocker run -d -p 4444:4444 -p 5900:5900 \\\n  --name selenium-chrome-debug \\\n  -e TZ=\"US/Pacific\" \\\n  -v /dev/shm:/dev/shm \\\n  -v /opt/chrome/chrome-data:/home/seluser/.cache --privileged \\\n  selenium/standalone-chrome-debug\n\n\n```\n#使用java代码控制chrome\n```java\npackage org.example;\n\nimport org.openqa.selenium.By;\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.WebElement;\nimport org.openqa.selenium.chrome.ChromeOptions;\nimport org.openqa.selenium.remote.RemoteWebDriver;\nimport java.net.MalformedURLException;\nimport java.net.URL;\n\npublic class SeleniumDockerTest {\n    public static void main(String[] args) {\n        ChromeOptions options = new ChromeOptions();\n        options.addArguments(\"--disable-dev-shm-usage\");  // 解决 Chrome 崩溃问题\n        options.addArguments(\"--no-sandbox\");  // 避免 Chrome 在容器中受限制\n//        options.addArguments(\"--user-data-dir=/home/seluser\");  // 设置 Chrome 用户数据目录\n\n        WebDriver driver = null;\n        try {\n            driver = new RemoteWebDriver(new URL(\"http://10.8.0.5:4444/wd/hub\"), options);\n\n            driver.get(\"https://www.jd.com\");\n            System.out.println(\"页面标题: \" + driver.getTitle());\n            WebElement body = driver.findElement(By.cssSelector(\"#J_cate > ul\"));\n            System.out.println(\"页面内容: \" + body.getText());\n            System.in.read();\n        } catch (Exception e) {\n            e.printStackTrace();\n            System.out.println(\"错误: \" + e.getMessage());\n        } finally {\n            if (driver != null) {\n                driver.quit();\n            }\n        }\n    }\n}\n\n```","slug":"docker/docker中运行chrome并使用代码控制","published":1,"updated":"2025-03-20T02:58:32.717Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8t000eujz3fle61rzw","content":"<p>#使用docker运行chrome</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -p 4444:4444 -p 5900:5900 --name selenium-chrome-debug selenium/standalone-chrome-debug</span><br><span class=\"line\">docker run -d -p 4444:4444 -p 5900:5900 \\</span><br><span class=\"line\">  --name selenium-chrome-debug \\</span><br><span class=\"line\">  -e TZ=&quot;US/Pacific&quot; \\</span><br><span class=\"line\">  -v /dev/shm:/dev/shm \\</span><br><span class=\"line\">  -v /opt/chrome/chrome-data:/home/seluser/.cache --privileged \\</span><br><span class=\"line\">  selenium/standalone-chrome-debug</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>#使用java代码控制chrome</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.example;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.By;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.WebDriver;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.WebElement;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.chrome.ChromeOptions;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.remote.RemoteWebDriver;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.MalformedURLException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SeleniumDockerTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">ChromeOptions</span> <span class=\"variable\">options</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ChromeOptions</span>();</span><br><span class=\"line\">        options.addArguments(<span class=\"string\">&quot;--disable-dev-shm-usage&quot;</span>);  <span class=\"comment\">// 解决 Chrome 崩溃问题</span></span><br><span class=\"line\">        options.addArguments(<span class=\"string\">&quot;--no-sandbox&quot;</span>);  <span class=\"comment\">// 避免 Chrome 在容器中受限制</span></span><br><span class=\"line\"><span class=\"comment\">//        options.addArguments(&quot;--user-data-dir=/home/seluser&quot;);  // 设置 Chrome 用户数据目录</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">WebDriver</span> <span class=\"variable\">driver</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            driver = <span class=\"keyword\">new</span> <span class=\"title class_\">RemoteWebDriver</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">URL</span>(<span class=\"string\">&quot;http://10.8.0.5:4444/wd/hub&quot;</span>), options);</span><br><span class=\"line\"></span><br><span class=\"line\">            driver.get(<span class=\"string\">&quot;https://www.jd.com&quot;</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;页面标题: &quot;</span> + driver.getTitle());</span><br><span class=\"line\">            <span class=\"type\">WebElement</span> <span class=\"variable\">body</span> <span class=\"operator\">=</span> driver.findElement(By.cssSelector(<span class=\"string\">&quot;#J_cate &gt; ul&quot;</span>));</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;页面内容: &quot;</span> + body.getText());</span><br><span class=\"line\">            System.in.read();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;错误: &quot;</span> + e.getMessage());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (driver != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                driver.quit();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","cover":false,"excerpt":"","more":"<p>#使用docker运行chrome</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -p 4444:4444 -p 5900:5900 --name selenium-chrome-debug selenium/standalone-chrome-debug</span><br><span class=\"line\">docker run -d -p 4444:4444 -p 5900:5900 \\</span><br><span class=\"line\">  --name selenium-chrome-debug \\</span><br><span class=\"line\">  -e TZ=&quot;US/Pacific&quot; \\</span><br><span class=\"line\">  -v /dev/shm:/dev/shm \\</span><br><span class=\"line\">  -v /opt/chrome/chrome-data:/home/seluser/.cache --privileged \\</span><br><span class=\"line\">  selenium/standalone-chrome-debug</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>#使用java代码控制chrome</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.example;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.By;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.WebDriver;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.WebElement;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.chrome.ChromeOptions;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.openqa.selenium.remote.RemoteWebDriver;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.MalformedURLException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SeleniumDockerTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">ChromeOptions</span> <span class=\"variable\">options</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ChromeOptions</span>();</span><br><span class=\"line\">        options.addArguments(<span class=\"string\">&quot;--disable-dev-shm-usage&quot;</span>);  <span class=\"comment\">// 解决 Chrome 崩溃问题</span></span><br><span class=\"line\">        options.addArguments(<span class=\"string\">&quot;--no-sandbox&quot;</span>);  <span class=\"comment\">// 避免 Chrome 在容器中受限制</span></span><br><span class=\"line\"><span class=\"comment\">//        options.addArguments(&quot;--user-data-dir=/home/seluser&quot;);  // 设置 Chrome 用户数据目录</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">WebDriver</span> <span class=\"variable\">driver</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            driver = <span class=\"keyword\">new</span> <span class=\"title class_\">RemoteWebDriver</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">URL</span>(<span class=\"string\">&quot;http://10.8.0.5:4444/wd/hub&quot;</span>), options);</span><br><span class=\"line\"></span><br><span class=\"line\">            driver.get(<span class=\"string\">&quot;https://www.jd.com&quot;</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;页面标题: &quot;</span> + driver.getTitle());</span><br><span class=\"line\">            <span class=\"type\">WebElement</span> <span class=\"variable\">body</span> <span class=\"operator\">=</span> driver.findElement(By.cssSelector(<span class=\"string\">&quot;#J_cate &gt; ul&quot;</span>));</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;页面内容: &quot;</span> + body.getText());</span><br><span class=\"line\">            System.in.read();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;错误: &quot;</span> + e.getMessage());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (driver != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                driver.quit();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"docker常用命令","date":"2025-02-20T07:26:30.000Z","_content":"\n新建数据库：\n\n```bash\ndocker run -d --restart=always  --name my-mysql -e MYSQL_ROOT_PASSWORD='password' -p 3306:3306 -e TZ=Asia/Shanghai  mysql:8.0.39\n```","source":"_posts/docker/docker常用命令.md","raw":"---\ntitle: docker常用命令\ndate: 2025-02-20 15:26:30\ncategories: docker\ntag: 命令\n---\n\n新建数据库：\n\n```bash\ndocker run -d --restart=always  --name my-mysql -e MYSQL_ROOT_PASSWORD='password' -p 3306:3306 -e TZ=Asia/Shanghai  mysql:8.0.39\n```","slug":"docker/docker常用命令","published":1,"updated":"2025-02-20T07:27:22.473Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8t000iujz39p534luh","content":"<p>新建数据库：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --restart=always  --name my-mysql -e MYSQL_ROOT_PASSWORD=<span class=\"string\">&#x27;password&#x27;</span> -p 3306:3306 -e TZ=Asia/Shanghai  mysql:8.0.39</span><br></pre></td></tr></table></figure>","cover":false,"excerpt":"","more":"<p>新建数据库：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --restart=always  --name my-mysql -e MYSQL_ROOT_PASSWORD=<span class=\"string\">&#x27;password&#x27;</span> -p 3306:3306 -e TZ=Asia/Shanghai  mysql:8.0.39</span><br></pre></td></tr></table></figure>"},{"title":"基于k8s实现优雅停机","date":"2025-06-06T04:27:16.000Z","_content":"在 Kubernetes 中，**默认情况下 pod 会在接收到 `SIGTERM` 信号（例如升级、删除等场景）后，立即从 Service 的负载列表中摘除（Endpoint 移除）**，然后再执行 `preStop` 钩子以及进入 `terminationGracePeriodSeconds` 等步骤。\n\n你说的需求是：\n\n> **在发版时，Pod 收到停止信号后，不要立即摘除它的 IP 和端口（即不立即从服务列表中剔除），而是等到你主动完成一些操作（如优雅停机通知）后，再摘除。**\n\n这个需求在 Kubernetes 中可以通过以下几种方式实现：\n\n---\n\n## ✅ 实现目标：控制 Pod 在 `SIGTERM` 时 **延迟摘除 IP 和端口**\n\n---\n\n## 🧩 方法一：使用 `terminationGracePeriodSeconds` + 延迟摘除逻辑\n\nKubernetes 的**摘除 Endpoint 行为**是这样的：\n\n* Pod 一旦进入 Terminating 状态，**会立即从 Service 的 endpoints 中移除**\n* 并不是等 `preStop` 或 `terminationGracePeriodSeconds` 完成后才移除\n\n因此想“暂时保留 IP 不被摘除”——**需要规避 Pod 直接进入 Terminating 状态**\n\n### 🧠 核心方案：**控制流量的移除时机，而不是控制 Pod 的下线时机**\n\n---\n\n## ✅ 方法二：使用 \\[**Readiness Probe**] 控制流量摘除时机（推荐）\n\n### 步骤如下：\n\n1. Pod 启动时设置 `readinessProbe`，只有探针通过时才参与服务\n2. 停机前，在 `preStop` 阶段**手动设置为 NotReady**（流量会被摘除，但 Pod 仍在）\n\n---\n\n### ✅ 实现方式（推荐）\n\n```yaml\nlivenessProbe:\n  httpGet:\n    path: /actuator/health\n    port: 8080\n  initialDelaySeconds: 10\n  periodSeconds: 10\n\nreadinessProbe:\n  httpGet:\n    path: /actuator/health/readiness\n    port: 8080\n  initialDelaySeconds: 5\n  periodSeconds: 5\n```\n\n### ⚙️ preStop 阶段“手动设置为不健康”\n\n```yaml\nlifecycle:\n  preStop:\n    exec:\n      command:\n        - /bin/sh\n        - -c\n        - |\n          echo \"Notifying service to stop sending traffic\"\n          curl -X POST http://localhost:8080/shutdown-hook\n          sleep 30  # 等待流量转移 + 优雅停机\n```\n\n在 Spring Boot 中可以结合 actuator 管理健康状态：\n\n```java\n@RestController\npublic class ShutdownController {\n\n    private final ApplicationAvailability availability;\n\n    @Autowired\n    public ShutdownController(ApplicationAvailability availability) {\n        this.availability = availability;\n    }\n\n    @PostMapping(\"/shutdown-hook\")\n    public void shutdown() {\n        // 手动设置为不可用（也可以切换 readiness probe 的状态）\n        // 若使用 spring-boot-actuator 2.3+ 可切换 Readiness\n        System.out.println(\"Application is preparing to shutdown...\");\n    }\n}\n```\n\n---\n\n## ❗ 为什么不能“阻止 IP 被摘除”\n\nK8s 的 Endpoint Controller 一旦发现 Pod 是 Terminating 状态（即使你还在 `preStop` 和 `terminationGracePeriodSeconds` 里），就会从 Service 中移除 Endpoint（也就是从 DNS 或网关负载中摘除 IP）。\n\n> 所以，要想“发版时不立即摘掉 IP”，你要避免一开始就让 Pod 进入 Terminating，而是**先标记为 NotReady**，等处理完毕再删除 Pod。\n\n---\n\n## ✅ 总结推荐配置\n\n| 项目                               | 推荐配置                                   |\n| -------------------------------- | -------------------------------------- |\n| `readinessProbe`                 | 用于控制服务是否接受流量                           |\n| `preStop` hook                   | 优雅通知微服务关闭，并 sleep 等待                   |\n| `terminationGracePeriodSeconds`  | 设置为 ≥ `preStop` 脚本耗时，例如 60s            |\n| `Spring Boot readiness endpoint` | 建议使用 actuator + readiness 实现接口健康状态动态切换 |\n\n---\n\n### 💡 示例完整配置片段\n\n```yaml\nspec:\n  containers:\n    - name: trade\n      image: trade:latest\n      lifecycle:\n        preStop:\n          exec:\n            command:\n              - /bin/sh\n              - -c\n              - |\n                curl -X POST http://localhost:8080/shutdown-hook\n                sleep 30\n      readinessProbe:\n        httpGet:\n          path: /actuator/health/readiness\n          port: 8080\n        initialDelaySeconds: 5\n        periodSeconds: 5\n  terminationGracePeriodSeconds: 60\n```","source":"_posts/docker/基于k8s实现优雅停机.md","raw":"---\ntitle: 基于k8s实现优雅停机\ndate: 2025-06-06 12:27:16\ncategories: k8s\ntag: chrome\n---\n在 Kubernetes 中，**默认情况下 pod 会在接收到 `SIGTERM` 信号（例如升级、删除等场景）后，立即从 Service 的负载列表中摘除（Endpoint 移除）**，然后再执行 `preStop` 钩子以及进入 `terminationGracePeriodSeconds` 等步骤。\n\n你说的需求是：\n\n> **在发版时，Pod 收到停止信号后，不要立即摘除它的 IP 和端口（即不立即从服务列表中剔除），而是等到你主动完成一些操作（如优雅停机通知）后，再摘除。**\n\n这个需求在 Kubernetes 中可以通过以下几种方式实现：\n\n---\n\n## ✅ 实现目标：控制 Pod 在 `SIGTERM` 时 **延迟摘除 IP 和端口**\n\n---\n\n## 🧩 方法一：使用 `terminationGracePeriodSeconds` + 延迟摘除逻辑\n\nKubernetes 的**摘除 Endpoint 行为**是这样的：\n\n* Pod 一旦进入 Terminating 状态，**会立即从 Service 的 endpoints 中移除**\n* 并不是等 `preStop` 或 `terminationGracePeriodSeconds` 完成后才移除\n\n因此想“暂时保留 IP 不被摘除”——**需要规避 Pod 直接进入 Terminating 状态**\n\n### 🧠 核心方案：**控制流量的移除时机，而不是控制 Pod 的下线时机**\n\n---\n\n## ✅ 方法二：使用 \\[**Readiness Probe**] 控制流量摘除时机（推荐）\n\n### 步骤如下：\n\n1. Pod 启动时设置 `readinessProbe`，只有探针通过时才参与服务\n2. 停机前，在 `preStop` 阶段**手动设置为 NotReady**（流量会被摘除，但 Pod 仍在）\n\n---\n\n### ✅ 实现方式（推荐）\n\n```yaml\nlivenessProbe:\n  httpGet:\n    path: /actuator/health\n    port: 8080\n  initialDelaySeconds: 10\n  periodSeconds: 10\n\nreadinessProbe:\n  httpGet:\n    path: /actuator/health/readiness\n    port: 8080\n  initialDelaySeconds: 5\n  periodSeconds: 5\n```\n\n### ⚙️ preStop 阶段“手动设置为不健康”\n\n```yaml\nlifecycle:\n  preStop:\n    exec:\n      command:\n        - /bin/sh\n        - -c\n        - |\n          echo \"Notifying service to stop sending traffic\"\n          curl -X POST http://localhost:8080/shutdown-hook\n          sleep 30  # 等待流量转移 + 优雅停机\n```\n\n在 Spring Boot 中可以结合 actuator 管理健康状态：\n\n```java\n@RestController\npublic class ShutdownController {\n\n    private final ApplicationAvailability availability;\n\n    @Autowired\n    public ShutdownController(ApplicationAvailability availability) {\n        this.availability = availability;\n    }\n\n    @PostMapping(\"/shutdown-hook\")\n    public void shutdown() {\n        // 手动设置为不可用（也可以切换 readiness probe 的状态）\n        // 若使用 spring-boot-actuator 2.3+ 可切换 Readiness\n        System.out.println(\"Application is preparing to shutdown...\");\n    }\n}\n```\n\n---\n\n## ❗ 为什么不能“阻止 IP 被摘除”\n\nK8s 的 Endpoint Controller 一旦发现 Pod 是 Terminating 状态（即使你还在 `preStop` 和 `terminationGracePeriodSeconds` 里），就会从 Service 中移除 Endpoint（也就是从 DNS 或网关负载中摘除 IP）。\n\n> 所以，要想“发版时不立即摘掉 IP”，你要避免一开始就让 Pod 进入 Terminating，而是**先标记为 NotReady**，等处理完毕再删除 Pod。\n\n---\n\n## ✅ 总结推荐配置\n\n| 项目                               | 推荐配置                                   |\n| -------------------------------- | -------------------------------------- |\n| `readinessProbe`                 | 用于控制服务是否接受流量                           |\n| `preStop` hook                   | 优雅通知微服务关闭，并 sleep 等待                   |\n| `terminationGracePeriodSeconds`  | 设置为 ≥ `preStop` 脚本耗时，例如 60s            |\n| `Spring Boot readiness endpoint` | 建议使用 actuator + readiness 实现接口健康状态动态切换 |\n\n---\n\n### 💡 示例完整配置片段\n\n```yaml\nspec:\n  containers:\n    - name: trade\n      image: trade:latest\n      lifecycle:\n        preStop:\n          exec:\n            command:\n              - /bin/sh\n              - -c\n              - |\n                curl -X POST http://localhost:8080/shutdown-hook\n                sleep 30\n      readinessProbe:\n        httpGet:\n          path: /actuator/health/readiness\n          port: 8080\n        initialDelaySeconds: 5\n        periodSeconds: 5\n  terminationGracePeriodSeconds: 60\n```","slug":"docker/基于k8s实现优雅停机","published":1,"updated":"2025-11-24T09:20:27.899Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8t000kujz3ceolcim4","content":"<p>在 Kubernetes 中，<strong>默认情况下 pod 会在接收到 <code>SIGTERM</code> 信号（例如升级、删除等场景）后，立即从 Service 的负载列表中摘除（Endpoint 移除）</strong>，然后再执行 <code>preStop</code> 钩子以及进入 <code>terminationGracePeriodSeconds</code> 等步骤。</p>\n<p>你说的需求是：</p>\n<blockquote>\n<p><strong>在发版时，Pod 收到停止信号后，不要立即摘除它的 IP 和端口（即不立即从服务列表中剔除），而是等到你主动完成一些操作（如优雅停机通知）后，再摘除。</strong></p>\n</blockquote>\n<p>这个需求在 Kubernetes 中可以通过以下几种方式实现：</p>\n<hr>\n<h2 id=\"✅-实现目标：控制-Pod-在-SIGTERM-时-延迟摘除-IP-和端口\"><a href=\"#✅-实现目标：控制-Pod-在-SIGTERM-时-延迟摘除-IP-和端口\" class=\"headerlink\" title=\"✅ 实现目标：控制 Pod 在 SIGTERM 时 延迟摘除 IP 和端口\"></a>✅ 实现目标：控制 Pod 在 <code>SIGTERM</code> 时 <strong>延迟摘除 IP 和端口</strong></h2><hr>\n<h2 id=\"🧩-方法一：使用-terminationGracePeriodSeconds-延迟摘除逻辑\"><a href=\"#🧩-方法一：使用-terminationGracePeriodSeconds-延迟摘除逻辑\" class=\"headerlink\" title=\"🧩 方法一：使用 terminationGracePeriodSeconds + 延迟摘除逻辑\"></a>🧩 方法一：使用 <code>terminationGracePeriodSeconds</code> + 延迟摘除逻辑</h2><p>Kubernetes 的<strong>摘除 Endpoint 行为</strong>是这样的：</p>\n<ul>\n<li>Pod 一旦进入 Terminating 状态，<strong>会立即从 Service 的 endpoints 中移除</strong></li>\n<li>并不是等 <code>preStop</code> 或 <code>terminationGracePeriodSeconds</code> 完成后才移除</li>\n</ul>\n<p>因此想“暂时保留 IP 不被摘除”——<strong>需要规避 Pod 直接进入 Terminating 状态</strong></p>\n<h3 id=\"🧠-核心方案：控制流量的移除时机，而不是控制-Pod-的下线时机\"><a href=\"#🧠-核心方案：控制流量的移除时机，而不是控制-Pod-的下线时机\" class=\"headerlink\" title=\"🧠 核心方案：控制流量的移除时机，而不是控制 Pod 的下线时机\"></a>🧠 核心方案：<strong>控制流量的移除时机，而不是控制 Pod 的下线时机</strong></h3><hr>\n<h2 id=\"✅-方法二：使用-Readiness-Probe-控制流量摘除时机（推荐）\"><a href=\"#✅-方法二：使用-Readiness-Probe-控制流量摘除时机（推荐）\" class=\"headerlink\" title=\"✅ 方法二：使用 [Readiness Probe] 控制流量摘除时机（推荐）\"></a>✅ 方法二：使用 [<strong>Readiness Probe</strong>] 控制流量摘除时机（推荐）</h2><h3 id=\"步骤如下：\"><a href=\"#步骤如下：\" class=\"headerlink\" title=\"步骤如下：\"></a>步骤如下：</h3><ol>\n<li>Pod 启动时设置 <code>readinessProbe</code>，只有探针通过时才参与服务</li>\n<li>停机前，在 <code>preStop</code> 阶段<strong>手动设置为 NotReady</strong>（流量会被摘除，但 Pod 仍在）</li>\n</ol>\n<hr>\n<h3 id=\"✅-实现方式（推荐）\"><a href=\"#✅-实现方式（推荐）\" class=\"headerlink\" title=\"✅ 实现方式（推荐）\"></a>✅ 实现方式（推荐）</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">  <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/actuator/health</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">  <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/actuator/health/readiness</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">  <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"⚙️-preStop-阶段“手动设置为不健康”\"><a href=\"#⚙️-preStop-阶段“手动设置为不健康”\" class=\"headerlink\" title=\"⚙️ preStop 阶段“手动设置为不健康”\"></a>⚙️ preStop 阶段“手动设置为不健康”</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">lifecycle:</span></span><br><span class=\"line\">  <span class=\"attr\">preStop:</span></span><br><span class=\"line\">    <span class=\"attr\">exec:</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">/bin/sh</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">          echo &quot;Notifying service to stop sending traffic&quot;</span></span><br><span class=\"line\"><span class=\"string\">          curl -X POST http://localhost:8080/shutdown-hook</span></span><br><span class=\"line\"><span class=\"string\">          sleep 30  # 等待流量转移 + 优雅停机</span></span><br></pre></td></tr></table></figure>\n\n<p>在 Spring Boot 中可以结合 actuator 管理健康状态：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ShutdownController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ApplicationAvailability availability;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">ShutdownController</span><span class=\"params\">(ApplicationAvailability availability)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.availability = availability;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@PostMapping(&quot;/shutdown-hook&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">shutdown</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 手动设置为不可用（也可以切换 readiness probe 的状态）</span></span><br><span class=\"line\">        <span class=\"comment\">// 若使用 spring-boot-actuator 2.3+ 可切换 Readiness</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Application is preparing to shutdown...&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"❗-为什么不能“阻止-IP-被摘除”\"><a href=\"#❗-为什么不能“阻止-IP-被摘除”\" class=\"headerlink\" title=\"❗ 为什么不能“阻止 IP 被摘除”\"></a>❗ 为什么不能“阻止 IP 被摘除”</h2><p>K8s 的 Endpoint Controller 一旦发现 Pod 是 Terminating 状态（即使你还在 <code>preStop</code> 和 <code>terminationGracePeriodSeconds</code> 里），就会从 Service 中移除 Endpoint（也就是从 DNS 或网关负载中摘除 IP）。</p>\n<blockquote>\n<p>所以，要想“发版时不立即摘掉 IP”，你要避免一开始就让 Pod 进入 Terminating，而是<strong>先标记为 NotReady</strong>，等处理完毕再删除 Pod。</p>\n</blockquote>\n<hr>\n<h2 id=\"✅-总结推荐配置\"><a href=\"#✅-总结推荐配置\" class=\"headerlink\" title=\"✅ 总结推荐配置\"></a>✅ 总结推荐配置</h2><table>\n<thead>\n<tr>\n<th>项目</th>\n<th>推荐配置</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>readinessProbe</code></td>\n<td>用于控制服务是否接受流量</td>\n</tr>\n<tr>\n<td><code>preStop</code> hook</td>\n<td>优雅通知微服务关闭，并 sleep 等待</td>\n</tr>\n<tr>\n<td><code>terminationGracePeriodSeconds</code></td>\n<td>设置为 ≥ <code>preStop</code> 脚本耗时，例如 60s</td>\n</tr>\n<tr>\n<td><code>Spring Boot readiness endpoint</code></td>\n<td>建议使用 actuator + readiness 实现接口健康状态动态切换</td>\n</tr>\n</tbody></table>\n<hr>\n<h3 id=\"💡-示例完整配置片段\"><a href=\"#💡-示例完整配置片段\" class=\"headerlink\" title=\"💡 示例完整配置片段\"></a>💡 示例完整配置片段</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">trade</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">trade:latest</span></span><br><span class=\"line\">      <span class=\"attr\">lifecycle:</span></span><br><span class=\"line\">        <span class=\"attr\">preStop:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> <span class=\"string\">/bin/sh</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">                curl -X POST http://localhost:8080/shutdown-hook</span></span><br><span class=\"line\"><span class=\"string\">                sleep 30</span></span><br><span class=\"line\"><span class=\"string\"></span>      <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">        <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/actuator/health/readiness</span></span><br><span class=\"line\">          <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">        <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">  <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">60</span></span><br></pre></td></tr></table></figure>","cover":false,"excerpt":"","more":"<p>在 Kubernetes 中，<strong>默认情况下 pod 会在接收到 <code>SIGTERM</code> 信号（例如升级、删除等场景）后，立即从 Service 的负载列表中摘除（Endpoint 移除）</strong>，然后再执行 <code>preStop</code> 钩子以及进入 <code>terminationGracePeriodSeconds</code> 等步骤。</p>\n<p>你说的需求是：</p>\n<blockquote>\n<p><strong>在发版时，Pod 收到停止信号后，不要立即摘除它的 IP 和端口（即不立即从服务列表中剔除），而是等到你主动完成一些操作（如优雅停机通知）后，再摘除。</strong></p>\n</blockquote>\n<p>这个需求在 Kubernetes 中可以通过以下几种方式实现：</p>\n<hr>\n<h2 id=\"✅-实现目标：控制-Pod-在-SIGTERM-时-延迟摘除-IP-和端口\"><a href=\"#✅-实现目标：控制-Pod-在-SIGTERM-时-延迟摘除-IP-和端口\" class=\"headerlink\" title=\"✅ 实现目标：控制 Pod 在 SIGTERM 时 延迟摘除 IP 和端口\"></a>✅ 实现目标：控制 Pod 在 <code>SIGTERM</code> 时 <strong>延迟摘除 IP 和端口</strong></h2><hr>\n<h2 id=\"🧩-方法一：使用-terminationGracePeriodSeconds-延迟摘除逻辑\"><a href=\"#🧩-方法一：使用-terminationGracePeriodSeconds-延迟摘除逻辑\" class=\"headerlink\" title=\"🧩 方法一：使用 terminationGracePeriodSeconds + 延迟摘除逻辑\"></a>🧩 方法一：使用 <code>terminationGracePeriodSeconds</code> + 延迟摘除逻辑</h2><p>Kubernetes 的<strong>摘除 Endpoint 行为</strong>是这样的：</p>\n<ul>\n<li>Pod 一旦进入 Terminating 状态，<strong>会立即从 Service 的 endpoints 中移除</strong></li>\n<li>并不是等 <code>preStop</code> 或 <code>terminationGracePeriodSeconds</code> 完成后才移除</li>\n</ul>\n<p>因此想“暂时保留 IP 不被摘除”——<strong>需要规避 Pod 直接进入 Terminating 状态</strong></p>\n<h3 id=\"🧠-核心方案：控制流量的移除时机，而不是控制-Pod-的下线时机\"><a href=\"#🧠-核心方案：控制流量的移除时机，而不是控制-Pod-的下线时机\" class=\"headerlink\" title=\"🧠 核心方案：控制流量的移除时机，而不是控制 Pod 的下线时机\"></a>🧠 核心方案：<strong>控制流量的移除时机，而不是控制 Pod 的下线时机</strong></h3><hr>\n<h2 id=\"✅-方法二：使用-Readiness-Probe-控制流量摘除时机（推荐）\"><a href=\"#✅-方法二：使用-Readiness-Probe-控制流量摘除时机（推荐）\" class=\"headerlink\" title=\"✅ 方法二：使用 [Readiness Probe] 控制流量摘除时机（推荐）\"></a>✅ 方法二：使用 [<strong>Readiness Probe</strong>] 控制流量摘除时机（推荐）</h2><h3 id=\"步骤如下：\"><a href=\"#步骤如下：\" class=\"headerlink\" title=\"步骤如下：\"></a>步骤如下：</h3><ol>\n<li>Pod 启动时设置 <code>readinessProbe</code>，只有探针通过时才参与服务</li>\n<li>停机前，在 <code>preStop</code> 阶段<strong>手动设置为 NotReady</strong>（流量会被摘除，但 Pod 仍在）</li>\n</ol>\n<hr>\n<h3 id=\"✅-实现方式（推荐）\"><a href=\"#✅-实现方式（推荐）\" class=\"headerlink\" title=\"✅ 实现方式（推荐）\"></a>✅ 实现方式（推荐）</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">  <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/actuator/health</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">  <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/actuator/health/readiness</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">  <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"⚙️-preStop-阶段“手动设置为不健康”\"><a href=\"#⚙️-preStop-阶段“手动设置为不健康”\" class=\"headerlink\" title=\"⚙️ preStop 阶段“手动设置为不健康”\"></a>⚙️ preStop 阶段“手动设置为不健康”</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">lifecycle:</span></span><br><span class=\"line\">  <span class=\"attr\">preStop:</span></span><br><span class=\"line\">    <span class=\"attr\">exec:</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">/bin/sh</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">          echo &quot;Notifying service to stop sending traffic&quot;</span></span><br><span class=\"line\"><span class=\"string\">          curl -X POST http://localhost:8080/shutdown-hook</span></span><br><span class=\"line\"><span class=\"string\">          sleep 30  # 等待流量转移 + 优雅停机</span></span><br></pre></td></tr></table></figure>\n\n<p>在 Spring Boot 中可以结合 actuator 管理健康状态：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ShutdownController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ApplicationAvailability availability;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">ShutdownController</span><span class=\"params\">(ApplicationAvailability availability)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.availability = availability;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@PostMapping(&quot;/shutdown-hook&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">shutdown</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 手动设置为不可用（也可以切换 readiness probe 的状态）</span></span><br><span class=\"line\">        <span class=\"comment\">// 若使用 spring-boot-actuator 2.3+ 可切换 Readiness</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Application is preparing to shutdown...&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"❗-为什么不能“阻止-IP-被摘除”\"><a href=\"#❗-为什么不能“阻止-IP-被摘除”\" class=\"headerlink\" title=\"❗ 为什么不能“阻止 IP 被摘除”\"></a>❗ 为什么不能“阻止 IP 被摘除”</h2><p>K8s 的 Endpoint Controller 一旦发现 Pod 是 Terminating 状态（即使你还在 <code>preStop</code> 和 <code>terminationGracePeriodSeconds</code> 里），就会从 Service 中移除 Endpoint（也就是从 DNS 或网关负载中摘除 IP）。</p>\n<blockquote>\n<p>所以，要想“发版时不立即摘掉 IP”，你要避免一开始就让 Pod 进入 Terminating，而是<strong>先标记为 NotReady</strong>，等处理完毕再删除 Pod。</p>\n</blockquote>\n<hr>\n<h2 id=\"✅-总结推荐配置\"><a href=\"#✅-总结推荐配置\" class=\"headerlink\" title=\"✅ 总结推荐配置\"></a>✅ 总结推荐配置</h2><table>\n<thead>\n<tr>\n<th>项目</th>\n<th>推荐配置</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>readinessProbe</code></td>\n<td>用于控制服务是否接受流量</td>\n</tr>\n<tr>\n<td><code>preStop</code> hook</td>\n<td>优雅通知微服务关闭，并 sleep 等待</td>\n</tr>\n<tr>\n<td><code>terminationGracePeriodSeconds</code></td>\n<td>设置为 ≥ <code>preStop</code> 脚本耗时，例如 60s</td>\n</tr>\n<tr>\n<td><code>Spring Boot readiness endpoint</code></td>\n<td>建议使用 actuator + readiness 实现接口健康状态动态切换</td>\n</tr>\n</tbody></table>\n<hr>\n<h3 id=\"💡-示例完整配置片段\"><a href=\"#💡-示例完整配置片段\" class=\"headerlink\" title=\"💡 示例完整配置片段\"></a>💡 示例完整配置片段</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">trade</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">trade:latest</span></span><br><span class=\"line\">      <span class=\"attr\">lifecycle:</span></span><br><span class=\"line\">        <span class=\"attr\">preStop:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> <span class=\"string\">/bin/sh</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">                curl -X POST http://localhost:8080/shutdown-hook</span></span><br><span class=\"line\"><span class=\"string\">                sleep 30</span></span><br><span class=\"line\"><span class=\"string\"></span>      <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">        <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/actuator/health/readiness</span></span><br><span class=\"line\">          <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">        <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">  <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">60</span></span><br></pre></td></tr></table></figure>"},{"title":"mysql异常排查sql","date":"2025-06-04T16:09:57.000Z","_content":"\n###查找持续时间超过 60s 的事务\n```sql\nselect * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))>60\n```\n###指定sql的引擎\n```sql\ncreate table test(c int) engine=InnoDB;\n```\n###查看 transaction-isolation 的值,例如： READ-COMMITTED\n```sql\nshow variables like 'transaction_isolation';\n```\n### alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。\n```sql\nalter table t nowait add column c int(11) not null default 0;\nalter table t wait add column c int(11) not null default 0;\n\n```\n### 防止出现死锁，设置加锁超时时间\n```sql\nSHOW GLOBAL VARIABLES LIKE 'innodb_lock_wait_timeout';\nSET GLOBAL innodb_lock_wait_timeout=120;\n```\n### 发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。\n```sql\nSHOW GLOBAL VARIABLES LIKE 'innodb_deadlock_detect';\nSET GLOBAL innodb_deadlock_detect=on;\n```\n\n### 统计索引情况\n```sql\nSELECT TABLE_NAME, INDEX_NAME, NON_UNIQUE, SEQ_IN_INDEX, COLUMN_NAME, INDEX_TYPE\nFROM information_schema.STATISTICS\nWHERE TABLE_SCHEMA = 'mt5_bybit_demo'\n  AND TABLE_NAME IN (\n                     'mt5_orders',\n                     'mt5_position',\n                     'mt5_orders_history',\n                     'mt5_deals',\n                     'mt5_accounts',\n                     'mt5_groups',\n                     'mt5_users'\n    )\nORDER BY TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;\n\n```\n### 普通数据库备份命令\n```sql\nmysqldump -u root -p --databases mt5_bybit_demo --result-file=/home/mysql_backup/mt5_bybit_demo.sql\n```\n### 基于 InnoDB 存储引擎 + MySQL做一致性备份的一种可行方案\n```sql\n-- Q1: 设置当前会话的事务隔离级别为 RR（可重复读）\nSET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n\n-- Q2: 启动事务，并创建一个一致性快照，确保整个会话读到的数据一致\nSTART TRANSACTION WITH CONSISTENT SNAPSHOT;\n\n-- Q3: 设置保存点（可选，主要用于 rollback）\nSAVEPOINT sp;\n\n-- Q4: 获取表结构\nSHOW CREATE TABLE `t1`;\n\n-- Q5: 获取表数据（在一致性视图下）\nSELECT * FROM `t1`;\n\n-- Q6: 回滚到保存点（用于清理状态，通常可选）\nROLLBACK TO SAVEPOINT sp;\n\n-- 最后提交事务或回滚（如果只是读取，其实可以不用提交）\nROLLBACK;\n```\n### 查看刷盘配置 innodb_io_capacity ,\n```sql\nSHOW GLOBAL VARIABLES LIKE 'innodb_io_capacity';\n```\n| 硬盘类型            | 类型说明                      | `innodb_io_capacity` | `innodb_io_capacity_max` |\n| --------------- | ------------------------- | -------------------- | ------------------------ |\n| 机械硬盘（HDD）       | 7200 RPM 普通硬盘             | 100 \\~ 200           | 200 \\~ 400               |\n| SATA 固态（SSD）    | 2.5英寸，SATA 接口             | 300 \\~ 800           | 1000 \\~ 2000             |\n| M.2 NVMe 固态（高速） | PCIe 3.0/4.0 NVMe（高速 SSD） | 1000 \\~ 2000         | 3000 \\~ 10000            |\n| 企业级 SSD（高IO）    | 高端 NVMe 企业硬盘/RAID阵列       | 2000 \\~ 4000+        | 5000 \\~ 20000+           |\n\n\n\n# MySQL 中 SELECT 与 ALTER TABLE 操作对表锁定的影响比较\n## 一、SELECT 查询的表锁定行为\n| 存储引擎       | 锁定行为                                          |\n| ---------- | --------------------------------------------- |\n| **InnoDB** | 默认使用 **非锁定一致性读**（MVCC 实现），**不锁表**。            |\n| **MyISAM** | 获取**共享锁（读锁）**，为**表级锁**，会**阻塞写操作**，但不会阻塞其他读操作。 |\n## 二、ALTER TABLE 操作的锁定行为\n### 1. InnoDB 引擎\n| MySQL 版本    | 操作类型           | 锁定行为                                           |\n| ----------- | -------------- | ---------------------------------------------- |\n| MySQL 5.6+  | 在线 DDL（如添加列）   | 支持使用 `ALGORITHM=INPLACE` 和 `LOCK=NONE`，**不锁表** |\n| MySQL 5.6+  | 复制数据操作（如修改列类型） | 使用 `ALGORITHM=COPY`，**会锁表**                    |\n| MySQL ≤ 5.5 | 所有 ALTER 操作    | **大多数会锁表**，阻塞读写操作                              |\n### 2. MyISAM 引擎\n* 所有 ALTER TABLE 操作都会**锁定整个表**，阻塞所有读写操作直到完成。\n## 三、减少锁定影响的策略\n* ✅ 使用在线 DDL（MySQL 5.6+）：\n  ```sql\n  ALTER TABLE table_name ADD COLUMN new_column INT, ALGORITHM=INPLACE, LOCK=NONE;\n  ```\n* ✅ 在业务低峰期执行 ALTER TABLE。\n* ✅ 使用工具 **pt-online-schema-change**（Percona Toolkit）对大表结构进行无锁修改。\n* ✅ 主从复制架构下，先在从库执行 ALTER TABLE，验证无误后切主。\n## 四、示例对比\n```sql\n-- 在线添加列（不锁表）\nALTER TABLE users ADD COLUMN phone VARCHAR(20), ALGORITHM=INPLACE, LOCK=NONE;\n-- 修改列类型（可能锁表）\nALTER TABLE users MODIFY COLUMN phone VARCHAR(30), ALGORITHM=COPY;\n```\n## 五、总结对比\n| 操作类型        | InnoDB（默认）       | MyISAM      |\n| ----------- | ---------------- | ----------- |\n| SELECT      | 非锁定一致性读，不锁表      | 表级共享锁，阻塞写操作 |\n| ALTER TABLE | 支持在线 DDL，部分操作不锁表 | 所有操作锁表，阻塞读写 |\n","source":"_posts/mysql/mysql异常排查sql.md","raw":"---\ntitle: mysql异常排查sql\ndate: 2025-06-05 00:09:57\ncategories: mysql\ntag: 备份\n---\n\n###查找持续时间超过 60s 的事务\n```sql\nselect * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))>60\n```\n###指定sql的引擎\n```sql\ncreate table test(c int) engine=InnoDB;\n```\n###查看 transaction-isolation 的值,例如： READ-COMMITTED\n```sql\nshow variables like 'transaction_isolation';\n```\n### alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。\n```sql\nalter table t nowait add column c int(11) not null default 0;\nalter table t wait add column c int(11) not null default 0;\n\n```\n### 防止出现死锁，设置加锁超时时间\n```sql\nSHOW GLOBAL VARIABLES LIKE 'innodb_lock_wait_timeout';\nSET GLOBAL innodb_lock_wait_timeout=120;\n```\n### 发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。\n```sql\nSHOW GLOBAL VARIABLES LIKE 'innodb_deadlock_detect';\nSET GLOBAL innodb_deadlock_detect=on;\n```\n\n### 统计索引情况\n```sql\nSELECT TABLE_NAME, INDEX_NAME, NON_UNIQUE, SEQ_IN_INDEX, COLUMN_NAME, INDEX_TYPE\nFROM information_schema.STATISTICS\nWHERE TABLE_SCHEMA = 'mt5_bybit_demo'\n  AND TABLE_NAME IN (\n                     'mt5_orders',\n                     'mt5_position',\n                     'mt5_orders_history',\n                     'mt5_deals',\n                     'mt5_accounts',\n                     'mt5_groups',\n                     'mt5_users'\n    )\nORDER BY TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;\n\n```\n### 普通数据库备份命令\n```sql\nmysqldump -u root -p --databases mt5_bybit_demo --result-file=/home/mysql_backup/mt5_bybit_demo.sql\n```\n### 基于 InnoDB 存储引擎 + MySQL做一致性备份的一种可行方案\n```sql\n-- Q1: 设置当前会话的事务隔离级别为 RR（可重复读）\nSET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n\n-- Q2: 启动事务，并创建一个一致性快照，确保整个会话读到的数据一致\nSTART TRANSACTION WITH CONSISTENT SNAPSHOT;\n\n-- Q3: 设置保存点（可选，主要用于 rollback）\nSAVEPOINT sp;\n\n-- Q4: 获取表结构\nSHOW CREATE TABLE `t1`;\n\n-- Q5: 获取表数据（在一致性视图下）\nSELECT * FROM `t1`;\n\n-- Q6: 回滚到保存点（用于清理状态，通常可选）\nROLLBACK TO SAVEPOINT sp;\n\n-- 最后提交事务或回滚（如果只是读取，其实可以不用提交）\nROLLBACK;\n```\n### 查看刷盘配置 innodb_io_capacity ,\n```sql\nSHOW GLOBAL VARIABLES LIKE 'innodb_io_capacity';\n```\n| 硬盘类型            | 类型说明                      | `innodb_io_capacity` | `innodb_io_capacity_max` |\n| --------------- | ------------------------- | -------------------- | ------------------------ |\n| 机械硬盘（HDD）       | 7200 RPM 普通硬盘             | 100 \\~ 200           | 200 \\~ 400               |\n| SATA 固态（SSD）    | 2.5英寸，SATA 接口             | 300 \\~ 800           | 1000 \\~ 2000             |\n| M.2 NVMe 固态（高速） | PCIe 3.0/4.0 NVMe（高速 SSD） | 1000 \\~ 2000         | 3000 \\~ 10000            |\n| 企业级 SSD（高IO）    | 高端 NVMe 企业硬盘/RAID阵列       | 2000 \\~ 4000+        | 5000 \\~ 20000+           |\n\n\n\n# MySQL 中 SELECT 与 ALTER TABLE 操作对表锁定的影响比较\n## 一、SELECT 查询的表锁定行为\n| 存储引擎       | 锁定行为                                          |\n| ---------- | --------------------------------------------- |\n| **InnoDB** | 默认使用 **非锁定一致性读**（MVCC 实现），**不锁表**。            |\n| **MyISAM** | 获取**共享锁（读锁）**，为**表级锁**，会**阻塞写操作**，但不会阻塞其他读操作。 |\n## 二、ALTER TABLE 操作的锁定行为\n### 1. InnoDB 引擎\n| MySQL 版本    | 操作类型           | 锁定行为                                           |\n| ----------- | -------------- | ---------------------------------------------- |\n| MySQL 5.6+  | 在线 DDL（如添加列）   | 支持使用 `ALGORITHM=INPLACE` 和 `LOCK=NONE`，**不锁表** |\n| MySQL 5.6+  | 复制数据操作（如修改列类型） | 使用 `ALGORITHM=COPY`，**会锁表**                    |\n| MySQL ≤ 5.5 | 所有 ALTER 操作    | **大多数会锁表**，阻塞读写操作                              |\n### 2. MyISAM 引擎\n* 所有 ALTER TABLE 操作都会**锁定整个表**，阻塞所有读写操作直到完成。\n## 三、减少锁定影响的策略\n* ✅ 使用在线 DDL（MySQL 5.6+）：\n  ```sql\n  ALTER TABLE table_name ADD COLUMN new_column INT, ALGORITHM=INPLACE, LOCK=NONE;\n  ```\n* ✅ 在业务低峰期执行 ALTER TABLE。\n* ✅ 使用工具 **pt-online-schema-change**（Percona Toolkit）对大表结构进行无锁修改。\n* ✅ 主从复制架构下，先在从库执行 ALTER TABLE，验证无误后切主。\n## 四、示例对比\n```sql\n-- 在线添加列（不锁表）\nALTER TABLE users ADD COLUMN phone VARCHAR(20), ALGORITHM=INPLACE, LOCK=NONE;\n-- 修改列类型（可能锁表）\nALTER TABLE users MODIFY COLUMN phone VARCHAR(30), ALGORITHM=COPY;\n```\n## 五、总结对比\n| 操作类型        | InnoDB（默认）       | MyISAM      |\n| ----------- | ---------------- | ----------- |\n| SELECT      | 非锁定一致性读，不锁表      | 表级共享锁，阻塞写操作 |\n| ALTER TABLE | 支持在线 DDL，部分操作不锁表 | 所有操作锁表，阻塞读写 |\n","slug":"mysql/mysql异常排查sql","published":1,"updated":"2025-06-16T02:55:53.802Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8u000oujz360wfc01w","content":"<p>###查找持续时间超过 60s 的事务</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> information_schema.innodb_trx <span class=\"keyword\">where</span> TIME_TO_SEC(timediff(now(),trx_started))<span class=\"operator\">&gt;</span><span class=\"number\">60</span></span><br></pre></td></tr></table></figure>\n<p>###指定sql的引擎</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> test(c <span class=\"type\">int</span>) engine<span class=\"operator\">=</span>InnoDB;</span><br></pre></td></tr></table></figure>\n<p>###查看 transaction-isolation 的值,例如： READ-COMMITTED</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> variables <span class=\"keyword\">like</span> <span class=\"string\">&#x27;transaction_isolation&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"alter-table-语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到-MDL-写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者-DBA-再通过重试命令重复这个过程。\"><a href=\"#alter-table-语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到-MDL-写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者-DBA-再通过重试命令重复这个过程。\" class=\"headerlink\" title=\"alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。\"></a>alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">table</span> t nowait <span class=\"keyword\">add</span> <span class=\"keyword\">column</span> c <span class=\"type\">int</span>(<span class=\"number\">11</span>) <span class=\"keyword\">not</span> <span class=\"keyword\">null</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">table</span> t wait <span class=\"keyword\">add</span> <span class=\"keyword\">column</span> c <span class=\"type\">int</span>(<span class=\"number\">11</span>) <span class=\"keyword\">not</span> <span class=\"keyword\">null</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"防止出现死锁，设置加锁超时时间\"><a href=\"#防止出现死锁，设置加锁超时时间\" class=\"headerlink\" title=\"防止出现死锁，设置加锁超时时间\"></a>防止出现死锁，设置加锁超时时间</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">GLOBAL</span> VARIABLES <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;innodb_lock_wait_timeout&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> innodb_lock_wait_timeout<span class=\"operator\">=</span><span class=\"number\">120</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数-innodb-deadlock-detect-设置为-on，表示开启这个逻辑。\"><a href=\"#发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数-innodb-deadlock-detect-设置为-on，表示开启这个逻辑。\" class=\"headerlink\" title=\"发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。\"></a>发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">GLOBAL</span> VARIABLES <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;innodb_deadlock_detect&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> innodb_deadlock_detect<span class=\"operator\">=</span><span class=\"keyword\">on</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"统计索引情况\"><a href=\"#统计索引情况\" class=\"headerlink\" title=\"统计索引情况\"></a>统计索引情况</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TABLE_NAME, INDEX_NAME, NON_UNIQUE, SEQ_IN_INDEX, COLUMN_NAME, INDEX_TYPE</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> information_schema.STATISTICS</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> TABLE_SCHEMA <span class=\"operator\">=</span> <span class=\"string\">&#x27;mt5_bybit_demo&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">AND</span> TABLE_NAME <span class=\"keyword\">IN</span> (</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_orders&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_position&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_orders_history&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_deals&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_accounts&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_groups&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_users&#x27;</span></span><br><span class=\"line\">    )</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"普通数据库备份命令\"><a href=\"#普通数据库备份命令\" class=\"headerlink\" title=\"普通数据库备份命令\"></a>普通数据库备份命令</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysqldump <span class=\"operator\">-</span>u root <span class=\"operator\">-</span>p <span class=\"comment\">--databases mt5_bybit_demo --result-file=/home/mysql_backup/mt5_bybit_demo.sql</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于-InnoDB-存储引擎-MySQL做一致性备份的一种可行方案\"><a href=\"#基于-InnoDB-存储引擎-MySQL做一致性备份的一种可行方案\" class=\"headerlink\" title=\"基于 InnoDB 存储引擎 + MySQL做一致性备份的一种可行方案\"></a>基于 InnoDB 存储引擎 + MySQL做一致性备份的一种可行方案</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- Q1: 设置当前会话的事务隔离级别为 RR（可重复读）</span></span><br><span class=\"line\"><span class=\"keyword\">SET</span> SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q2: 启动事务，并创建一个一致性快照，确保整个会话读到的数据一致</span></span><br><span class=\"line\"><span class=\"keyword\">START</span> TRANSACTION <span class=\"keyword\">WITH</span> CONSISTENT SNAPSHOT;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q3: 设置保存点（可选，主要用于 rollback）</span></span><br><span class=\"line\"><span class=\"keyword\">SAVEPOINT</span> sp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q4: 获取表结构</span></span><br><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> `t1`;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q5: 获取表数据（在一致性视图下）</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"operator\">*</span> <span class=\"keyword\">FROM</span> `t1`;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q6: 回滚到保存点（用于清理状态，通常可选）</span></span><br><span class=\"line\"><span class=\"keyword\">ROLLBACK</span> <span class=\"keyword\">TO</span> <span class=\"keyword\">SAVEPOINT</span> sp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 最后提交事务或回滚（如果只是读取，其实可以不用提交）</span></span><br><span class=\"line\"><span class=\"keyword\">ROLLBACK</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"查看刷盘配置-innodb-io-capacity\"><a href=\"#查看刷盘配置-innodb-io-capacity\" class=\"headerlink\" title=\"查看刷盘配置 innodb_io_capacity ,\"></a>查看刷盘配置 innodb_io_capacity ,</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">GLOBAL</span> VARIABLES <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;innodb_io_capacity&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>硬盘类型</th>\n<th>类型说明</th>\n<th><code>innodb_io_capacity</code></th>\n<th><code>innodb_io_capacity_max</code></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>机械硬盘（HDD）</td>\n<td>7200 RPM 普通硬盘</td>\n<td>100 ~ 200</td>\n<td>200 ~ 400</td>\n</tr>\n<tr>\n<td>SATA 固态（SSD）</td>\n<td>2.5英寸，SATA 接口</td>\n<td>300 ~ 800</td>\n<td>1000 ~ 2000</td>\n</tr>\n<tr>\n<td>M.2 NVMe 固态（高速）</td>\n<td>PCIe 3.0&#x2F;4.0 NVMe（高速 SSD）</td>\n<td>1000 ~ 2000</td>\n<td>3000 ~ 10000</td>\n</tr>\n<tr>\n<td>企业级 SSD（高IO）</td>\n<td>高端 NVMe 企业硬盘&#x2F;RAID阵列</td>\n<td>2000 ~ 4000+</td>\n<td>5000 ~ 20000+</td>\n</tr>\n</tbody></table>\n<h1 id=\"MySQL-中-SELECT-与-ALTER-TABLE-操作对表锁定的影响比较\"><a href=\"#MySQL-中-SELECT-与-ALTER-TABLE-操作对表锁定的影响比较\" class=\"headerlink\" title=\"MySQL 中 SELECT 与 ALTER TABLE 操作对表锁定的影响比较\"></a>MySQL 中 SELECT 与 ALTER TABLE 操作对表锁定的影响比较</h1><h2 id=\"一、SELECT-查询的表锁定行为\"><a href=\"#一、SELECT-查询的表锁定行为\" class=\"headerlink\" title=\"一、SELECT 查询的表锁定行为\"></a>一、SELECT 查询的表锁定行为</h2><table>\n<thead>\n<tr>\n<th>存储引擎</th>\n<th>锁定行为</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>InnoDB</strong></td>\n<td>默认使用 <strong>非锁定一致性读</strong>（MVCC 实现），<strong>不锁表</strong>。</td>\n</tr>\n<tr>\n<td><strong>MyISAM</strong></td>\n<td>获取<strong>共享锁（读锁）</strong>，为<strong>表级锁</strong>，会<strong>阻塞写操作</strong>，但不会阻塞其他读操作。</td>\n</tr>\n</tbody></table>\n<h2 id=\"二、ALTER-TABLE-操作的锁定行为\"><a href=\"#二、ALTER-TABLE-操作的锁定行为\" class=\"headerlink\" title=\"二、ALTER TABLE 操作的锁定行为\"></a>二、ALTER TABLE 操作的锁定行为</h2><h3 id=\"1-InnoDB-引擎\"><a href=\"#1-InnoDB-引擎\" class=\"headerlink\" title=\"1. InnoDB 引擎\"></a>1. InnoDB 引擎</h3><table>\n<thead>\n<tr>\n<th>MySQL 版本</th>\n<th>操作类型</th>\n<th>锁定行为</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>MySQL 5.6+</td>\n<td>在线 DDL（如添加列）</td>\n<td>支持使用 <code>ALGORITHM=INPLACE</code> 和 <code>LOCK=NONE</code>，<strong>不锁表</strong></td>\n</tr>\n<tr>\n<td>MySQL 5.6+</td>\n<td>复制数据操作（如修改列类型）</td>\n<td>使用 <code>ALGORITHM=COPY</code>，<strong>会锁表</strong></td>\n</tr>\n<tr>\n<td>MySQL ≤ 5.5</td>\n<td>所有 ALTER 操作</td>\n<td><strong>大多数会锁表</strong>，阻塞读写操作</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-MyISAM-引擎\"><a href=\"#2-MyISAM-引擎\" class=\"headerlink\" title=\"2. MyISAM 引擎\"></a>2. MyISAM 引擎</h3><ul>\n<li>所有 ALTER TABLE 操作都会<strong>锁定整个表</strong>，阻塞所有读写操作直到完成。</li>\n</ul>\n<h2 id=\"三、减少锁定影响的策略\"><a href=\"#三、减少锁定影响的策略\" class=\"headerlink\" title=\"三、减少锁定影响的策略\"></a>三、减少锁定影响的策略</h2><ul>\n<li>✅ 使用在线 DDL（MySQL 5.6+）：<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> table_name <span class=\"keyword\">ADD</span> <span class=\"keyword\">COLUMN</span> new_column <span class=\"type\">INT</span>, ALGORITHM<span class=\"operator\">=</span>INPLACE, LOCK<span class=\"operator\">=</span><span class=\"keyword\">NONE</span>;</span><br></pre></td></tr></table></figure></li>\n<li>✅ 在业务低峰期执行 ALTER TABLE。</li>\n<li>✅ 使用工具 <strong>pt-online-schema-change</strong>（Percona Toolkit）对大表结构进行无锁修改。</li>\n<li>✅ 主从复制架构下，先在从库执行 ALTER TABLE，验证无误后切主。</li>\n</ul>\n<h2 id=\"四、示例对比\"><a href=\"#四、示例对比\" class=\"headerlink\" title=\"四、示例对比\"></a>四、示例对比</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 在线添加列（不锁表）</span></span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> users <span class=\"keyword\">ADD</span> <span class=\"keyword\">COLUMN</span> phone <span class=\"type\">VARCHAR</span>(<span class=\"number\">20</span>), ALGORITHM<span class=\"operator\">=</span>INPLACE, LOCK<span class=\"operator\">=</span><span class=\"keyword\">NONE</span>;</span><br><span class=\"line\"><span class=\"comment\">-- 修改列类型（可能锁表）</span></span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> users MODIFY <span class=\"keyword\">COLUMN</span> phone <span class=\"type\">VARCHAR</span>(<span class=\"number\">30</span>), ALGORITHM<span class=\"operator\">=</span><span class=\"keyword\">COPY</span>;</span><br></pre></td></tr></table></figure>\n<h2 id=\"五、总结对比\"><a href=\"#五、总结对比\" class=\"headerlink\" title=\"五、总结对比\"></a>五、总结对比</h2><table>\n<thead>\n<tr>\n<th>操作类型</th>\n<th>InnoDB（默认）</th>\n<th>MyISAM</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>SELECT</td>\n<td>非锁定一致性读，不锁表</td>\n<td>表级共享锁，阻塞写操作</td>\n</tr>\n<tr>\n<td>ALTER TABLE</td>\n<td>支持在线 DDL，部分操作不锁表</td>\n<td>所有操作锁表，阻塞读写</td>\n</tr>\n</tbody></table>\n","cover":false,"excerpt":"","more":"<p>###查找持续时间超过 60s 的事务</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> information_schema.innodb_trx <span class=\"keyword\">where</span> TIME_TO_SEC(timediff(now(),trx_started))<span class=\"operator\">&gt;</span><span class=\"number\">60</span></span><br></pre></td></tr></table></figure>\n<p>###指定sql的引擎</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> test(c <span class=\"type\">int</span>) engine<span class=\"operator\">=</span>InnoDB;</span><br></pre></td></tr></table></figure>\n<p>###查看 transaction-isolation 的值,例如： READ-COMMITTED</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> variables <span class=\"keyword\">like</span> <span class=\"string\">&#x27;transaction_isolation&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"alter-table-语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到-MDL-写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者-DBA-再通过重试命令重复这个过程。\"><a href=\"#alter-table-语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到-MDL-写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者-DBA-再通过重试命令重复这个过程。\" class=\"headerlink\" title=\"alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。\"></a>alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">table</span> t nowait <span class=\"keyword\">add</span> <span class=\"keyword\">column</span> c <span class=\"type\">int</span>(<span class=\"number\">11</span>) <span class=\"keyword\">not</span> <span class=\"keyword\">null</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">table</span> t wait <span class=\"keyword\">add</span> <span class=\"keyword\">column</span> c <span class=\"type\">int</span>(<span class=\"number\">11</span>) <span class=\"keyword\">not</span> <span class=\"keyword\">null</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"防止出现死锁，设置加锁超时时间\"><a href=\"#防止出现死锁，设置加锁超时时间\" class=\"headerlink\" title=\"防止出现死锁，设置加锁超时时间\"></a>防止出现死锁，设置加锁超时时间</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">GLOBAL</span> VARIABLES <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;innodb_lock_wait_timeout&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> innodb_lock_wait_timeout<span class=\"operator\">=</span><span class=\"number\">120</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数-innodb-deadlock-detect-设置为-on，表示开启这个逻辑。\"><a href=\"#发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数-innodb-deadlock-detect-设置为-on，表示开启这个逻辑。\" class=\"headerlink\" title=\"发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。\"></a>发起死锁检测，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">GLOBAL</span> VARIABLES <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;innodb_deadlock_detect&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">GLOBAL</span> innodb_deadlock_detect<span class=\"operator\">=</span><span class=\"keyword\">on</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"统计索引情况\"><a href=\"#统计索引情况\" class=\"headerlink\" title=\"统计索引情况\"></a>统计索引情况</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TABLE_NAME, INDEX_NAME, NON_UNIQUE, SEQ_IN_INDEX, COLUMN_NAME, INDEX_TYPE</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> information_schema.STATISTICS</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> TABLE_SCHEMA <span class=\"operator\">=</span> <span class=\"string\">&#x27;mt5_bybit_demo&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">AND</span> TABLE_NAME <span class=\"keyword\">IN</span> (</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_orders&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_position&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_orders_history&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_deals&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_accounts&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_groups&#x27;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&#x27;mt5_users&#x27;</span></span><br><span class=\"line\">    )</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"普通数据库备份命令\"><a href=\"#普通数据库备份命令\" class=\"headerlink\" title=\"普通数据库备份命令\"></a>普通数据库备份命令</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysqldump <span class=\"operator\">-</span>u root <span class=\"operator\">-</span>p <span class=\"comment\">--databases mt5_bybit_demo --result-file=/home/mysql_backup/mt5_bybit_demo.sql</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于-InnoDB-存储引擎-MySQL做一致性备份的一种可行方案\"><a href=\"#基于-InnoDB-存储引擎-MySQL做一致性备份的一种可行方案\" class=\"headerlink\" title=\"基于 InnoDB 存储引擎 + MySQL做一致性备份的一种可行方案\"></a>基于 InnoDB 存储引擎 + MySQL做一致性备份的一种可行方案</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- Q1: 设置当前会话的事务隔离级别为 RR（可重复读）</span></span><br><span class=\"line\"><span class=\"keyword\">SET</span> SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q2: 启动事务，并创建一个一致性快照，确保整个会话读到的数据一致</span></span><br><span class=\"line\"><span class=\"keyword\">START</span> TRANSACTION <span class=\"keyword\">WITH</span> CONSISTENT SNAPSHOT;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q3: 设置保存点（可选，主要用于 rollback）</span></span><br><span class=\"line\"><span class=\"keyword\">SAVEPOINT</span> sp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q4: 获取表结构</span></span><br><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> `t1`;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q5: 获取表数据（在一致性视图下）</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"operator\">*</span> <span class=\"keyword\">FROM</span> `t1`;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Q6: 回滚到保存点（用于清理状态，通常可选）</span></span><br><span class=\"line\"><span class=\"keyword\">ROLLBACK</span> <span class=\"keyword\">TO</span> <span class=\"keyword\">SAVEPOINT</span> sp;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 最后提交事务或回滚（如果只是读取，其实可以不用提交）</span></span><br><span class=\"line\"><span class=\"keyword\">ROLLBACK</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"查看刷盘配置-innodb-io-capacity\"><a href=\"#查看刷盘配置-innodb-io-capacity\" class=\"headerlink\" title=\"查看刷盘配置 innodb_io_capacity ,\"></a>查看刷盘配置 innodb_io_capacity ,</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">GLOBAL</span> VARIABLES <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;innodb_io_capacity&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>硬盘类型</th>\n<th>类型说明</th>\n<th><code>innodb_io_capacity</code></th>\n<th><code>innodb_io_capacity_max</code></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>机械硬盘（HDD）</td>\n<td>7200 RPM 普通硬盘</td>\n<td>100 ~ 200</td>\n<td>200 ~ 400</td>\n</tr>\n<tr>\n<td>SATA 固态（SSD）</td>\n<td>2.5英寸，SATA 接口</td>\n<td>300 ~ 800</td>\n<td>1000 ~ 2000</td>\n</tr>\n<tr>\n<td>M.2 NVMe 固态（高速）</td>\n<td>PCIe 3.0&#x2F;4.0 NVMe（高速 SSD）</td>\n<td>1000 ~ 2000</td>\n<td>3000 ~ 10000</td>\n</tr>\n<tr>\n<td>企业级 SSD（高IO）</td>\n<td>高端 NVMe 企业硬盘&#x2F;RAID阵列</td>\n<td>2000 ~ 4000+</td>\n<td>5000 ~ 20000+</td>\n</tr>\n</tbody></table>\n<h1 id=\"MySQL-中-SELECT-与-ALTER-TABLE-操作对表锁定的影响比较\"><a href=\"#MySQL-中-SELECT-与-ALTER-TABLE-操作对表锁定的影响比较\" class=\"headerlink\" title=\"MySQL 中 SELECT 与 ALTER TABLE 操作对表锁定的影响比较\"></a>MySQL 中 SELECT 与 ALTER TABLE 操作对表锁定的影响比较</h1><h2 id=\"一、SELECT-查询的表锁定行为\"><a href=\"#一、SELECT-查询的表锁定行为\" class=\"headerlink\" title=\"一、SELECT 查询的表锁定行为\"></a>一、SELECT 查询的表锁定行为</h2><table>\n<thead>\n<tr>\n<th>存储引擎</th>\n<th>锁定行为</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>InnoDB</strong></td>\n<td>默认使用 <strong>非锁定一致性读</strong>（MVCC 实现），<strong>不锁表</strong>。</td>\n</tr>\n<tr>\n<td><strong>MyISAM</strong></td>\n<td>获取<strong>共享锁（读锁）</strong>，为<strong>表级锁</strong>，会<strong>阻塞写操作</strong>，但不会阻塞其他读操作。</td>\n</tr>\n</tbody></table>\n<h2 id=\"二、ALTER-TABLE-操作的锁定行为\"><a href=\"#二、ALTER-TABLE-操作的锁定行为\" class=\"headerlink\" title=\"二、ALTER TABLE 操作的锁定行为\"></a>二、ALTER TABLE 操作的锁定行为</h2><h3 id=\"1-InnoDB-引擎\"><a href=\"#1-InnoDB-引擎\" class=\"headerlink\" title=\"1. InnoDB 引擎\"></a>1. InnoDB 引擎</h3><table>\n<thead>\n<tr>\n<th>MySQL 版本</th>\n<th>操作类型</th>\n<th>锁定行为</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>MySQL 5.6+</td>\n<td>在线 DDL（如添加列）</td>\n<td>支持使用 <code>ALGORITHM=INPLACE</code> 和 <code>LOCK=NONE</code>，<strong>不锁表</strong></td>\n</tr>\n<tr>\n<td>MySQL 5.6+</td>\n<td>复制数据操作（如修改列类型）</td>\n<td>使用 <code>ALGORITHM=COPY</code>，<strong>会锁表</strong></td>\n</tr>\n<tr>\n<td>MySQL ≤ 5.5</td>\n<td>所有 ALTER 操作</td>\n<td><strong>大多数会锁表</strong>，阻塞读写操作</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-MyISAM-引擎\"><a href=\"#2-MyISAM-引擎\" class=\"headerlink\" title=\"2. MyISAM 引擎\"></a>2. MyISAM 引擎</h3><ul>\n<li>所有 ALTER TABLE 操作都会<strong>锁定整个表</strong>，阻塞所有读写操作直到完成。</li>\n</ul>\n<h2 id=\"三、减少锁定影响的策略\"><a href=\"#三、减少锁定影响的策略\" class=\"headerlink\" title=\"三、减少锁定影响的策略\"></a>三、减少锁定影响的策略</h2><ul>\n<li>✅ 使用在线 DDL（MySQL 5.6+）：<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> table_name <span class=\"keyword\">ADD</span> <span class=\"keyword\">COLUMN</span> new_column <span class=\"type\">INT</span>, ALGORITHM<span class=\"operator\">=</span>INPLACE, LOCK<span class=\"operator\">=</span><span class=\"keyword\">NONE</span>;</span><br></pre></td></tr></table></figure></li>\n<li>✅ 在业务低峰期执行 ALTER TABLE。</li>\n<li>✅ 使用工具 <strong>pt-online-schema-change</strong>（Percona Toolkit）对大表结构进行无锁修改。</li>\n<li>✅ 主从复制架构下，先在从库执行 ALTER TABLE，验证无误后切主。</li>\n</ul>\n<h2 id=\"四、示例对比\"><a href=\"#四、示例对比\" class=\"headerlink\" title=\"四、示例对比\"></a>四、示例对比</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 在线添加列（不锁表）</span></span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> users <span class=\"keyword\">ADD</span> <span class=\"keyword\">COLUMN</span> phone <span class=\"type\">VARCHAR</span>(<span class=\"number\">20</span>), ALGORITHM<span class=\"operator\">=</span>INPLACE, LOCK<span class=\"operator\">=</span><span class=\"keyword\">NONE</span>;</span><br><span class=\"line\"><span class=\"comment\">-- 修改列类型（可能锁表）</span></span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> users MODIFY <span class=\"keyword\">COLUMN</span> phone <span class=\"type\">VARCHAR</span>(<span class=\"number\">30</span>), ALGORITHM<span class=\"operator\">=</span><span class=\"keyword\">COPY</span>;</span><br></pre></td></tr></table></figure>\n<h2 id=\"五、总结对比\"><a href=\"#五、总结对比\" class=\"headerlink\" title=\"五、总结对比\"></a>五、总结对比</h2><table>\n<thead>\n<tr>\n<th>操作类型</th>\n<th>InnoDB（默认）</th>\n<th>MyISAM</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>SELECT</td>\n<td>非锁定一致性读，不锁表</td>\n<td>表级共享锁，阻塞写操作</td>\n</tr>\n<tr>\n<td>ALTER TABLE</td>\n<td>支持在线 DDL，部分操作不锁表</td>\n<td>所有操作锁表，阻塞读写</td>\n</tr>\n</tbody></table>\n"},{"title":"select for update用法的好处","date":"2024-07-25T11:10:03.000Z","_content":"`SELECT FOR UPDATE` 是一种用于数据库管理系统（DBMS）的 SQL 语句，主要用于在事务处理过程中锁定选定的行，防止其他事务修改这些行，直到当前事务完成。这种机制在处理并发访问时尤其有用，以下是其具体好处：\n\n### 1. **避免脏读、不可重复读和幻读**\n通过使用 `SELECT FOR UPDATE`，可以锁定选定的行，确保其他事务无法对这些行进行修改，从而防止以下类型的并发问题：\n- **脏读**：一个事务可以读取到另一个未提交事务的修改。\n- **不可重复读**：一个事务在两次读取之间，另一个事务修改了数据，导致两次读取结果不同。\n- **幻读**：一个事务在两次读取之间，另一个事务插入了新行，导致第二次读取返回更多行。\n\n### 2. **确保一致性和完整性**\n在执行复杂的业务逻辑时，例如账户转账、库存更新等，使用 `SELECT FOR UPDATE` 可以确保在整个事务过程中数据的一致性和完整性。这样可以避免在事务中间其他事务对数据的修改，导致数据不一致。\n\n### 3. **防止丢失更新**\n当多个事务试图同时更新同一行时，`SELECT FOR UPDATE` 可以防止丢失更新问题。它确保一个事务完成后，其他事务才能继续执行更新操作，避免了两个事务的更新互相覆盖。\n\n### 4. **优化并发控制**\n使用 `SELECT FOR UPDATE` 可以提供细粒度的并发控制，通过只锁定必要的行，而不是整个表，从而提高系统的并发性能和资源利用率。\n\n### 5. **简化编程模型**\n`SELECT FOR UPDATE` 可以简化开发人员的编程模型，不需要手动处理复杂的锁机制，数据库会自动处理行锁定和释放，从而减少编程错误的机会。\n\n### 使用示例\n```sql\nBEGIN;\nSELECT * FROM accounts WHERE account_id = 1 FOR UPDATE;\n-- 执行一些需要锁定这行的操作，例如更新账户余额\nUPDATE accounts SET balance = balance - 100 WHERE account_id = 1;\nCOMMIT;\n```\n\n在这个示例中，通过 `SELECT FOR UPDATE` 锁定 `account_id = 1` 的行，确保在事务提交之前，没有其他事务可以修改该行。\n\n总的来说，`SELECT FOR UPDATE` 提供了一种强大的并发控制机制，帮助确保数据的完整性、一致性，并防止并发修改导致的问题。","source":"_posts/mysql/select-for-update用法的好处.md","raw":"---\ntitle: select for update用法的好处\ndate: 2024-07-25 19:10:03\ncategories: mysql\ntag: 事务\n---\n`SELECT FOR UPDATE` 是一种用于数据库管理系统（DBMS）的 SQL 语句，主要用于在事务处理过程中锁定选定的行，防止其他事务修改这些行，直到当前事务完成。这种机制在处理并发访问时尤其有用，以下是其具体好处：\n\n### 1. **避免脏读、不可重复读和幻读**\n通过使用 `SELECT FOR UPDATE`，可以锁定选定的行，确保其他事务无法对这些行进行修改，从而防止以下类型的并发问题：\n- **脏读**：一个事务可以读取到另一个未提交事务的修改。\n- **不可重复读**：一个事务在两次读取之间，另一个事务修改了数据，导致两次读取结果不同。\n- **幻读**：一个事务在两次读取之间，另一个事务插入了新行，导致第二次读取返回更多行。\n\n### 2. **确保一致性和完整性**\n在执行复杂的业务逻辑时，例如账户转账、库存更新等，使用 `SELECT FOR UPDATE` 可以确保在整个事务过程中数据的一致性和完整性。这样可以避免在事务中间其他事务对数据的修改，导致数据不一致。\n\n### 3. **防止丢失更新**\n当多个事务试图同时更新同一行时，`SELECT FOR UPDATE` 可以防止丢失更新问题。它确保一个事务完成后，其他事务才能继续执行更新操作，避免了两个事务的更新互相覆盖。\n\n### 4. **优化并发控制**\n使用 `SELECT FOR UPDATE` 可以提供细粒度的并发控制，通过只锁定必要的行，而不是整个表，从而提高系统的并发性能和资源利用率。\n\n### 5. **简化编程模型**\n`SELECT FOR UPDATE` 可以简化开发人员的编程模型，不需要手动处理复杂的锁机制，数据库会自动处理行锁定和释放，从而减少编程错误的机会。\n\n### 使用示例\n```sql\nBEGIN;\nSELECT * FROM accounts WHERE account_id = 1 FOR UPDATE;\n-- 执行一些需要锁定这行的操作，例如更新账户余额\nUPDATE accounts SET balance = balance - 100 WHERE account_id = 1;\nCOMMIT;\n```\n\n在这个示例中，通过 `SELECT FOR UPDATE` 锁定 `account_id = 1` 的行，确保在事务提交之前，没有其他事务可以修改该行。\n\n总的来说，`SELECT FOR UPDATE` 提供了一种强大的并发控制机制，帮助确保数据的完整性、一致性，并防止并发修改导致的问题。","slug":"mysql/select-for-update用法的好处","published":1,"updated":"2025-02-18T06:28:30.279Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8u000qujz33mc8f32g","content":"<p><code>SELECT FOR UPDATE</code> 是一种用于数据库管理系统（DBMS）的 SQL 语句，主要用于在事务处理过程中锁定选定的行，防止其他事务修改这些行，直到当前事务完成。这种机制在处理并发访问时尤其有用，以下是其具体好处：</p>\n<h3 id=\"1-避免脏读、不可重复读和幻读\"><a href=\"#1-避免脏读、不可重复读和幻读\" class=\"headerlink\" title=\"1. 避免脏读、不可重复读和幻读\"></a>1. <strong>避免脏读、不可重复读和幻读</strong></h3><p>通过使用 <code>SELECT FOR UPDATE</code>，可以锁定选定的行，确保其他事务无法对这些行进行修改，从而防止以下类型的并发问题：</p>\n<ul>\n<li><strong>脏读</strong>：一个事务可以读取到另一个未提交事务的修改。</li>\n<li><strong>不可重复读</strong>：一个事务在两次读取之间，另一个事务修改了数据，导致两次读取结果不同。</li>\n<li><strong>幻读</strong>：一个事务在两次读取之间，另一个事务插入了新行，导致第二次读取返回更多行。</li>\n</ul>\n<h3 id=\"2-确保一致性和完整性\"><a href=\"#2-确保一致性和完整性\" class=\"headerlink\" title=\"2. 确保一致性和完整性\"></a>2. <strong>确保一致性和完整性</strong></h3><p>在执行复杂的业务逻辑时，例如账户转账、库存更新等，使用 <code>SELECT FOR UPDATE</code> 可以确保在整个事务过程中数据的一致性和完整性。这样可以避免在事务中间其他事务对数据的修改，导致数据不一致。</p>\n<h3 id=\"3-防止丢失更新\"><a href=\"#3-防止丢失更新\" class=\"headerlink\" title=\"3. 防止丢失更新\"></a>3. <strong>防止丢失更新</strong></h3><p>当多个事务试图同时更新同一行时，<code>SELECT FOR UPDATE</code> 可以防止丢失更新问题。它确保一个事务完成后，其他事务才能继续执行更新操作，避免了两个事务的更新互相覆盖。</p>\n<h3 id=\"4-优化并发控制\"><a href=\"#4-优化并发控制\" class=\"headerlink\" title=\"4. 优化并发控制\"></a>4. <strong>优化并发控制</strong></h3><p>使用 <code>SELECT FOR UPDATE</code> 可以提供细粒度的并发控制，通过只锁定必要的行，而不是整个表，从而提高系统的并发性能和资源利用率。</p>\n<h3 id=\"5-简化编程模型\"><a href=\"#5-简化编程模型\" class=\"headerlink\" title=\"5. 简化编程模型\"></a>5. <strong>简化编程模型</strong></h3><p><code>SELECT FOR UPDATE</code> 可以简化开发人员的编程模型，不需要手动处理复杂的锁机制，数据库会自动处理行锁定和释放，从而减少编程错误的机会。</p>\n<h3 id=\"使用示例\"><a href=\"#使用示例\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">BEGIN</span>;</span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"operator\">*</span> <span class=\"keyword\">FROM</span> accounts <span class=\"keyword\">WHERE</span> account_id <span class=\"operator\">=</span> <span class=\"number\">1</span> <span class=\"keyword\">FOR</span> <span class=\"keyword\">UPDATE</span>;</span><br><span class=\"line\"><span class=\"comment\">-- 执行一些需要锁定这行的操作，例如更新账户余额</span></span><br><span class=\"line\"><span class=\"keyword\">UPDATE</span> accounts <span class=\"keyword\">SET</span> balance <span class=\"operator\">=</span> balance <span class=\"operator\">-</span> <span class=\"number\">100</span> <span class=\"keyword\">WHERE</span> account_id <span class=\"operator\">=</span> <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">COMMIT</span>;</span><br></pre></td></tr></table></figure>\n\n<p>在这个示例中，通过 <code>SELECT FOR UPDATE</code> 锁定 <code>account_id = 1</code> 的行，确保在事务提交之前，没有其他事务可以修改该行。</p>\n<p>总的来说，<code>SELECT FOR UPDATE</code> 提供了一种强大的并发控制机制，帮助确保数据的完整性、一致性，并防止并发修改导致的问题。</p>\n","cover":false,"excerpt":"","more":"<p><code>SELECT FOR UPDATE</code> 是一种用于数据库管理系统（DBMS）的 SQL 语句，主要用于在事务处理过程中锁定选定的行，防止其他事务修改这些行，直到当前事务完成。这种机制在处理并发访问时尤其有用，以下是其具体好处：</p>\n<h3 id=\"1-避免脏读、不可重复读和幻读\"><a href=\"#1-避免脏读、不可重复读和幻读\" class=\"headerlink\" title=\"1. 避免脏读、不可重复读和幻读\"></a>1. <strong>避免脏读、不可重复读和幻读</strong></h3><p>通过使用 <code>SELECT FOR UPDATE</code>，可以锁定选定的行，确保其他事务无法对这些行进行修改，从而防止以下类型的并发问题：</p>\n<ul>\n<li><strong>脏读</strong>：一个事务可以读取到另一个未提交事务的修改。</li>\n<li><strong>不可重复读</strong>：一个事务在两次读取之间，另一个事务修改了数据，导致两次读取结果不同。</li>\n<li><strong>幻读</strong>：一个事务在两次读取之间，另一个事务插入了新行，导致第二次读取返回更多行。</li>\n</ul>\n<h3 id=\"2-确保一致性和完整性\"><a href=\"#2-确保一致性和完整性\" class=\"headerlink\" title=\"2. 确保一致性和完整性\"></a>2. <strong>确保一致性和完整性</strong></h3><p>在执行复杂的业务逻辑时，例如账户转账、库存更新等，使用 <code>SELECT FOR UPDATE</code> 可以确保在整个事务过程中数据的一致性和完整性。这样可以避免在事务中间其他事务对数据的修改，导致数据不一致。</p>\n<h3 id=\"3-防止丢失更新\"><a href=\"#3-防止丢失更新\" class=\"headerlink\" title=\"3. 防止丢失更新\"></a>3. <strong>防止丢失更新</strong></h3><p>当多个事务试图同时更新同一行时，<code>SELECT FOR UPDATE</code> 可以防止丢失更新问题。它确保一个事务完成后，其他事务才能继续执行更新操作，避免了两个事务的更新互相覆盖。</p>\n<h3 id=\"4-优化并发控制\"><a href=\"#4-优化并发控制\" class=\"headerlink\" title=\"4. 优化并发控制\"></a>4. <strong>优化并发控制</strong></h3><p>使用 <code>SELECT FOR UPDATE</code> 可以提供细粒度的并发控制，通过只锁定必要的行，而不是整个表，从而提高系统的并发性能和资源利用率。</p>\n<h3 id=\"5-简化编程模型\"><a href=\"#5-简化编程模型\" class=\"headerlink\" title=\"5. 简化编程模型\"></a>5. <strong>简化编程模型</strong></h3><p><code>SELECT FOR UPDATE</code> 可以简化开发人员的编程模型，不需要手动处理复杂的锁机制，数据库会自动处理行锁定和释放，从而减少编程错误的机会。</p>\n<h3 id=\"使用示例\"><a href=\"#使用示例\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">BEGIN</span>;</span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"operator\">*</span> <span class=\"keyword\">FROM</span> accounts <span class=\"keyword\">WHERE</span> account_id <span class=\"operator\">=</span> <span class=\"number\">1</span> <span class=\"keyword\">FOR</span> <span class=\"keyword\">UPDATE</span>;</span><br><span class=\"line\"><span class=\"comment\">-- 执行一些需要锁定这行的操作，例如更新账户余额</span></span><br><span class=\"line\"><span class=\"keyword\">UPDATE</span> accounts <span class=\"keyword\">SET</span> balance <span class=\"operator\">=</span> balance <span class=\"operator\">-</span> <span class=\"number\">100</span> <span class=\"keyword\">WHERE</span> account_id <span class=\"operator\">=</span> <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">COMMIT</span>;</span><br></pre></td></tr></table></figure>\n\n<p>在这个示例中，通过 <code>SELECT FOR UPDATE</code> 锁定 <code>account_id = 1</code> 的行，确保在事务提交之前，没有其他事务可以修改该行。</p>\n<p>总的来说，<code>SELECT FOR UPDATE</code> 提供了一种强大的并发控制机制，帮助确保数据的完整性、一致性，并防止并发修改导致的问题。</p>\n"},{"title":"docker修改应用为自动启动","date":"2024-07-23T06:39:38.000Z","_content":"是的，Docker 提供了一种简单的方法来配置容器在系统启动时自动启动，这就是使用 `docker update` 命令配置容器的重启策略。\n\n以下是如何使用 `docker update` 命令来配置现有的容器在系统启动时自动启动：\n\n```bash\ndocker update --restart unless-stopped <container_name_or_id>\n```\n\n例如，如果你的容器名为 `mysql-container`，你可以这样配置：\n\n```bash\ndocker update --restart unless-stopped mysql-container\n```\n\n这样配置后，当系统重启时，Docker 会根据 `unless-stopped` 策略自动重启该容器。以下是一些常用的重启策略：\n\n- `no`: 容器不会自动重启（默认值）。\n- `on-failure`: 仅当容器退出状态非零时才重启。\n- `always`: 无论退出状态如何，总是重启容器。\n- `unless-stopped`: 容器除非被手动停止，否则总是重启。\n\n### 示例\n\n以下是一个完整的示例，展示如何启动一个新的 MySQL 容器并配置其在系统重启时自动启动：\n\n1. 启动一个 MySQL 容器：\n\n    ```bash\n    docker run -d \\\n        --name mysql-container \\\n        -e MYSQL_ROOT_PASSWORD=my-secret-pw \\\n        -v /my/own/datadir:/var/lib/mysql \\\n        mysql:latest\n    ```\n\n2. 配置容器的重启策略：\n\n    ```bash\n    docker update --restart unless-stopped mysql-container\n    ```\n\n### 检查容器重启策略\n\n你可以使用以下命令来检查容器的重启策略：\n\n```bash\ndocker inspect -f '{{ .HostConfig.RestartPolicy.Name }}' mysql-container\n```\n\n这将输出容器的当前重启策略。\n\n### 使用 Docker Compose\n\n如果你使用 Docker Compose，可以在 `docker-compose.yml` 文件中配置重启策略：\n\n```yaml\nversion: '3.8'\n\nservices:\n  mysql:\n    image: mysql:latest\n    container_name: mysql-container\n    environment:\n      MYSQL_ROOT_PASSWORD: my-secret-pw\n    volumes:\n      - /my/own/datadir:/var/lib/mysql\n    restart: unless-stopped\n```\n\n然后，使用以下命令启动容器：\n\n```bash\ndocker-compose up -d\n```\n\n### 总结\n\n通过上述方法，你可以轻松地配置 Docker 容器在系统重启时自动启动，无论是通过 `docker run`、`docker update` 还是 `docker-compose`。","source":"_posts/linux/docker修改应用为自动启动.md","raw":"---\ntitle: docker修改应用为自动启动\ndate: 2024-07-23 14:39:38\ncategories: linux\ntag: docker\n---\n是的，Docker 提供了一种简单的方法来配置容器在系统启动时自动启动，这就是使用 `docker update` 命令配置容器的重启策略。\n\n以下是如何使用 `docker update` 命令来配置现有的容器在系统启动时自动启动：\n\n```bash\ndocker update --restart unless-stopped <container_name_or_id>\n```\n\n例如，如果你的容器名为 `mysql-container`，你可以这样配置：\n\n```bash\ndocker update --restart unless-stopped mysql-container\n```\n\n这样配置后，当系统重启时，Docker 会根据 `unless-stopped` 策略自动重启该容器。以下是一些常用的重启策略：\n\n- `no`: 容器不会自动重启（默认值）。\n- `on-failure`: 仅当容器退出状态非零时才重启。\n- `always`: 无论退出状态如何，总是重启容器。\n- `unless-stopped`: 容器除非被手动停止，否则总是重启。\n\n### 示例\n\n以下是一个完整的示例，展示如何启动一个新的 MySQL 容器并配置其在系统重启时自动启动：\n\n1. 启动一个 MySQL 容器：\n\n    ```bash\n    docker run -d \\\n        --name mysql-container \\\n        -e MYSQL_ROOT_PASSWORD=my-secret-pw \\\n        -v /my/own/datadir:/var/lib/mysql \\\n        mysql:latest\n    ```\n\n2. 配置容器的重启策略：\n\n    ```bash\n    docker update --restart unless-stopped mysql-container\n    ```\n\n### 检查容器重启策略\n\n你可以使用以下命令来检查容器的重启策略：\n\n```bash\ndocker inspect -f '{{ .HostConfig.RestartPolicy.Name }}' mysql-container\n```\n\n这将输出容器的当前重启策略。\n\n### 使用 Docker Compose\n\n如果你使用 Docker Compose，可以在 `docker-compose.yml` 文件中配置重启策略：\n\n```yaml\nversion: '3.8'\n\nservices:\n  mysql:\n    image: mysql:latest\n    container_name: mysql-container\n    environment:\n      MYSQL_ROOT_PASSWORD: my-secret-pw\n    volumes:\n      - /my/own/datadir:/var/lib/mysql\n    restart: unless-stopped\n```\n\n然后，使用以下命令启动容器：\n\n```bash\ndocker-compose up -d\n```\n\n### 总结\n\n通过上述方法，你可以轻松地配置 Docker 容器在系统重启时自动启动，无论是通过 `docker run`、`docker update` 还是 `docker-compose`。","slug":"linux/docker修改应用为自动启动","published":1,"updated":"2025-02-18T06:31:00.549Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8u000uujz3czao26pv","content":"<p>是的，Docker 提供了一种简单的方法来配置容器在系统启动时自动启动，这就是使用 <code>docker update</code> 命令配置容器的重启策略。</p>\n<p>以下是如何使用 <code>docker update</code> 命令来配置现有的容器在系统启动时自动启动：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker update --restart unless-stopped &lt;container_name_or_id&gt;</span><br></pre></td></tr></table></figure>\n\n<p>例如，如果你的容器名为 <code>mysql-container</code>，你可以这样配置：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker update --restart unless-stopped mysql-container</span><br></pre></td></tr></table></figure>\n\n<p>这样配置后，当系统重启时，Docker 会根据 <code>unless-stopped</code> 策略自动重启该容器。以下是一些常用的重启策略：</p>\n<ul>\n<li><code>no</code>: 容器不会自动重启（默认值）。</li>\n<li><code>on-failure</code>: 仅当容器退出状态非零时才重启。</li>\n<li><code>always</code>: 无论退出状态如何，总是重启容器。</li>\n<li><code>unless-stopped</code>: 容器除非被手动停止，否则总是重启。</li>\n</ul>\n<h3 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h3><p>以下是一个完整的示例，展示如何启动一个新的 MySQL 容器并配置其在系统重启时自动启动：</p>\n<ol>\n<li><p>启动一个 MySQL 容器：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d \\</span><br><span class=\"line\">    --name mysql-container \\</span><br><span class=\"line\">    -e MYSQL_ROOT_PASSWORD=my-secret-pw \\</span><br><span class=\"line\">    -v /my/own/datadir:/var/lib/mysql \\</span><br><span class=\"line\">    mysql:latest</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置容器的重启策略：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker update --restart unless-stopped mysql-container</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"检查容器重启策略\"><a href=\"#检查容器重启策略\" class=\"headerlink\" title=\"检查容器重启策略\"></a>检查容器重启策略</h3><p>你可以使用以下命令来检查容器的重启策略：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker inspect -f <span class=\"string\">&#x27;&#123;&#123; .HostConfig.RestartPolicy.Name &#125;&#125;&#x27;</span> mysql-container</span><br></pre></td></tr></table></figure>\n\n<p>这将输出容器的当前重启策略。</p>\n<h3 id=\"使用-Docker-Compose\"><a href=\"#使用-Docker-Compose\" class=\"headerlink\" title=\"使用 Docker Compose\"></a>使用 Docker Compose</h3><p>如果你使用 Docker Compose，可以在 <code>docker-compose.yml</code> 文件中配置重启策略：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.8&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mysql:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mysql:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">mysql-container</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"string\">my-secret-pw</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/my/own/datadir:/var/lib/mysql</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br></pre></td></tr></table></figure>\n\n<p>然后，使用以下命令启动容器：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>通过上述方法，你可以轻松地配置 Docker 容器在系统重启时自动启动，无论是通过 <code>docker run</code>、<code>docker update</code> 还是 <code>docker-compose</code>。</p>\n","cover":false,"excerpt":"","more":"<p>是的，Docker 提供了一种简单的方法来配置容器在系统启动时自动启动，这就是使用 <code>docker update</code> 命令配置容器的重启策略。</p>\n<p>以下是如何使用 <code>docker update</code> 命令来配置现有的容器在系统启动时自动启动：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker update --restart unless-stopped &lt;container_name_or_id&gt;</span><br></pre></td></tr></table></figure>\n\n<p>例如，如果你的容器名为 <code>mysql-container</code>，你可以这样配置：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker update --restart unless-stopped mysql-container</span><br></pre></td></tr></table></figure>\n\n<p>这样配置后，当系统重启时，Docker 会根据 <code>unless-stopped</code> 策略自动重启该容器。以下是一些常用的重启策略：</p>\n<ul>\n<li><code>no</code>: 容器不会自动重启（默认值）。</li>\n<li><code>on-failure</code>: 仅当容器退出状态非零时才重启。</li>\n<li><code>always</code>: 无论退出状态如何，总是重启容器。</li>\n<li><code>unless-stopped</code>: 容器除非被手动停止，否则总是重启。</li>\n</ul>\n<h3 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h3><p>以下是一个完整的示例，展示如何启动一个新的 MySQL 容器并配置其在系统重启时自动启动：</p>\n<ol>\n<li><p>启动一个 MySQL 容器：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d \\</span><br><span class=\"line\">    --name mysql-container \\</span><br><span class=\"line\">    -e MYSQL_ROOT_PASSWORD=my-secret-pw \\</span><br><span class=\"line\">    -v /my/own/datadir:/var/lib/mysql \\</span><br><span class=\"line\">    mysql:latest</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置容器的重启策略：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker update --restart unless-stopped mysql-container</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"检查容器重启策略\"><a href=\"#检查容器重启策略\" class=\"headerlink\" title=\"检查容器重启策略\"></a>检查容器重启策略</h3><p>你可以使用以下命令来检查容器的重启策略：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker inspect -f <span class=\"string\">&#x27;&#123;&#123; .HostConfig.RestartPolicy.Name &#125;&#125;&#x27;</span> mysql-container</span><br></pre></td></tr></table></figure>\n\n<p>这将输出容器的当前重启策略。</p>\n<h3 id=\"使用-Docker-Compose\"><a href=\"#使用-Docker-Compose\" class=\"headerlink\" title=\"使用 Docker Compose\"></a>使用 Docker Compose</h3><p>如果你使用 Docker Compose，可以在 <code>docker-compose.yml</code> 文件中配置重启策略：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.8&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mysql:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mysql:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">mysql-container</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"string\">my-secret-pw</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/my/own/datadir:/var/lib/mysql</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br></pre></td></tr></table></figure>\n\n<p>然后，使用以下命令启动容器：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>通过上述方法，你可以轻松地配置 Docker 容器在系统重启时自动启动，无论是通过 <code>docker run</code>、<code>docker update</code> 还是 <code>docker-compose</code>。</p>\n"},{"title":"mysql-数据备份脚本","date":"2025-02-19T09:31:43.000Z","_content":"\n\n备份：\n\n```bash\ndocker exec mysql-container mysqldump -u root -p'password' --all-databases > /path/to/backup/all_databases_backup.sql\n```\n还原：\n\n```bash\ndocker exec -i my-mysql mysql  -u root -p'password'    < /opt/mysql_back/mydatabase_backup.sql  \n```\n\n\n\n\n\n","source":"_posts/mysql/mysql-数据备份脚本.md","raw":"---\ntitle: mysql-数据备份脚本\ndate: 2025-02-19 17:31:43\ncategories: mysql\ntag: 备份\n---\n\n\n备份：\n\n```bash\ndocker exec mysql-container mysqldump -u root -p'password' --all-databases > /path/to/backup/all_databases_backup.sql\n```\n还原：\n\n```bash\ndocker exec -i my-mysql mysql  -u root -p'password'    < /opt/mysql_back/mydatabase_backup.sql  \n```\n\n\n\n\n\n","slug":"mysql/mysql-数据备份脚本","published":1,"updated":"2025-02-20T07:27:22.479Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8u000wujz37g866fha","content":"<p>备份：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"built_in\">exec</span> mysql-container mysqldump -u root -p<span class=\"string\">&#x27;password&#x27;</span> --all-databases &gt; /path/to/backup/all_databases_backup.sql</span><br></pre></td></tr></table></figure>\n<p>还原：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"built_in\">exec</span> -i my-mysql mysql  -u root -p<span class=\"string\">&#x27;password&#x27;</span>    &lt; /opt/mysql_back/mydatabase_backup.sql  </span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","cover":false,"excerpt":"","more":"<p>备份：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"built_in\">exec</span> mysql-container mysqldump -u root -p<span class=\"string\">&#x27;password&#x27;</span> --all-databases &gt; /path/to/backup/all_databases_backup.sql</span><br></pre></td></tr></table></figure>\n<p>还原：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"built_in\">exec</span> -i my-mysql mysql  -u root -p<span class=\"string\">&#x27;password&#x27;</span>    &lt; /opt/mysql_back/mydatabase_backup.sql  </span><br></pre></td></tr></table></figure>\n\n\n\n\n\n"},{"title":"es高级命令","date":"2025-02-27T08:05:47.000Z","_content":"以下是优化过的笔记，已加入注释并调整格式，使其更符合Markdown标准：\n\n---\n\n# Elasticsearch 集群管理与优化笔记\n\n## 1. 移动分片到另一个节点\n```bash\nPOST _cluster/reroute\n{\n  \"commands\": [\n    {\n      \"move\": {\n        \"index\": \"index_name\",   # 索引名称\n        \"shard\": 0,               # 分片编号\n        \"from_node\": \"node_name_1\", # 源节点\n        \"to_node\": \"node_name_2\"   # 目标节点\n      }\n    }\n  ]\n}\n```\n\n## 2. 强制分配未分配的分片（带原因说明）\n```bash\nPOST _cluster/reroute?explain\n{\n  \"commands\": [\n    {\n      \"allocate\": {\n        \"index\": \"index_name\",   # 索引名称\n        \"shard\": 0,              # 分片编号\n        \"node\": \"nodename\"       # 目标节点\n      }\n    }\n  ]\n}\n```\n\n## 3. 从集群中移除节点\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.exclude._ip\": \"the_IP_of_your_node\"   # 要排除的节点IP\n  }\n}\n```\n\n## 4. 强制执行同步刷新\n```bash\nPOST _flush/synced\n```\n\n## 5. 调整集群平衡时移动的分片数量\n```bash\nPUT /_cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\": 2   # 同时平衡的分片数\n  }\n}\n```\n\n## 6. 调整每个节点同时恢复的分片数量\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.node_concurrent_recoveries\": 5   # 每个节点并行恢复的分片数\n  }\n}\n```\n\n## 7. 调整恢复速度\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"indices.recovery.max_bytes_per_sec\": \"80mb\"   # 恢复速率\n  }\n}\n```\n\n## 8. 调整单节点恢复时并发流数量\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"indices.recovery.concurrent_streams\": 6   # 单节点恢复时的并发流数\n  }\n}\n```\n\n## 9. 调整搜索队列大小\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"threadpool.search.queue_size\": 2000   # 搜索队列大小\n  }\n}\n```\n\n## 10. 清除节点缓存\n```bash\nPOST _cache/clear\n```\n\n## 11. 调整断路器配置\n```bash\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.breaker.total.limit\": \"40%\"   # 设置内存断路器的总内存限制\n  }\n}\n```\n\n---\n\n# 监控 Elasticsearch 集群\n\n## 1. 节点统计\n```bash\nGET _nodes/stats\n```\n\n## 2. 集群统计\n```bash\nGET _cluster/stats\n```\n\n## 3. 索引统计\n```bash\nGET kibana_sample_data_ecommerce/_stats\n```\n\n## 4. 查看待处理的集群任务\n```bash\nGET _cluster/pending_tasks\n```\n\n## 5. 查看所有任务，支持取消任务\n```bash\nGET _tasks\n```\n\n## 6. 查看节点的线程池信息\n```bash\nGET _nodes/thread_pool\nGET _nodes/stats/thread_pool\nGET _cat/thread_pool?v\nGET _nodes/hot_threads\nGET _nodes/stats/thread_pool\n```\n\n## 7. 设置索引慢日志（Slowlog）\n- 设置索引慢日志阈值：\n```bash\nPUT my_index/_settings\n{\n  \"index.indexing.slowlog\": {\n    \"threshold.index\": {\n      \"warn\": \"10s\",    # 警告级别\n      \"info\": \"4s\",     # 信息级别\n      \"debug\": \"2s\",    # 调试级别\n      \"trace\": \"0s\"     # 跟踪级别\n    },\n    \"level\": \"trace\",\n    \"source\": 1000   # 日志源的最大字符数\n  }\n}\n```\n\n- 设置查询慢日志：\n```bash\nDELETE my_index\nPUT my_index/\n{\n  \"settings\": {\n    \"index.search.slowlog.threshold\": {\n      \"query.warn\": \"10s\",   # 查询慢日志警告级别\n      \"query.info\": \"3s\",    # 查询慢日志信息级别\n      \"query.debug\": \"2s\",   # 查询慢日志调试级别\n      \"query.trace\": \"0s\",   # 查询慢日志跟踪级别\n      \"fetch.warn\": \"1s\",    # 获取慢日志警告级别\n      \"fetch.info\": \"600ms\", # 获取慢日志信息级别\n      \"fetch.debug\": \"400ms\",# 获取慢日志调试级别\n      \"fetch.trace\": \"0s\"    # 获取慢日志跟踪级别\n    }\n  }\n}\n```\n\n---\n\n# 解决集群 Yellow 与 Red 状态问题\n\n## 1. 检查集群健康状态\n```bash\nGET /_cluster/health/\n```\n\n## 2. 查看索引级别健康状态，找出红色索引\n```bash\nGET /_cluster/health?level=indices\n```\n\n## 3. 查看分片级别健康状态\n```bash\nGET _cluster/health?level=shards\n```\n\n## 4. 解释索引分片无法分配的原因\n```bash\nGET /_cluster/allocation/explain\n```\n\n## 5. 删除并重新创建索引\n```bash\nDELETE mytest\nPUT mytest\n{\n  \"settings\": {\n    \"number_of_shards\": 3,    # 分片数\n    \"number_of_replicas\": 0,   # 副本数\n    \"index.routing.allocation.require.box_type\": \"hot\"   # 指定节点类型\n  }\n}\n```\n\n---\n\n# 提升集群写性能\n\n## 1. 设置优化写入性能的索引设置\n```bash\nDELETE myindex\nPUT myindex\n{\n  \"settings\": {\n    \"index\": {\n      \"refresh_interval\": \"30s\",     # 刷新间隔\n      \"number_of_shards\": \"2\"        # 分片数\n    },\n    \"routing\": {\n      \"allocation\": {\n        \"total_shards_per_node\": \"3\" # 每个节点的最大分片数\n      }\n    },\n    \"translog\": {\n      \"sync_interval\": \"30s\",         # 事务日志同步间隔\n      \"durability\": \"async\"           # 异步持久化\n    },\n    \"number_of_replicas\": 0          # 副本数\n  },\n  \"mappings\": {\n    \"dynamic\": false,                # 禁用动态映射\n    \"properties\": {}\n  }\n}\n```\n\n---\n\n# 提升集群读性能\n\n## 1. 示例：查询优化\n```bash\nPUT blogs/_doc/1\n{\n  \"title\": \"elasticsearch\"\n}\n\nGET blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": { \"title\": \"elasticsearch\" }}\n      ],\n      \"filter\": {\n        \"script\": {\n          \"script\": {\n            \"source\": \"doc['title.keyword'].value.length()>5\"\n          }\n        }\n      }\n    }\n  }\n}\n\nGET blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"elasticsearch\"}},\n        {\n          \"range\": {\n            \"publish_date\": {\n              \"gte\": 2017,\n              \"lte\": 2019\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\n---\n\n# 集群压力测试\n\n## 1. 安装并配置 esrally\n```bash\npip3 install esrally\nesrally configure\n```\n\n## 2. 执行简单的压力测试\n```bash\nesrally --distribution-version=7.1.0 --test-mode\n```\n\n## 3. 执行完整数据测试\n```bash\nesrally --distribution-version=7.1.0\n```\n\n---\n\n# 使用缓存与 Breaker 限制内存使用\n\n## 1. 获取节点统计信息\n```bash\nGET _cat/nodes?v\nGET _nodes/stats/indices?pretty\nGET _cat/nodes?v&h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count\n```\n\n## 2. 设置内存限制\n```bash\nPUT /_cluster/settings\n{\n  \"persistent\": {\n    \"indices.breaker.request.limit\": \"90%\"   # 设置请求断路器内存限制\n  }\n}\n```\n\n---\n\n# 使用 Shrink 与 Rollover API 管理索引\n\n## 1. Shrink 索引\n```bash\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n```\n\n## 2. Rollover 索引\n```bash\nPOST nginx_logs_write/_rollover\n{\n  \"conditions\": {\n    \"max_age\": \"1d\",\n    \"max_docs\": 5,\n    \"max_size\": \"5gb\"\n  }\n}\n```\n\n\n```\n# 11.2-索引全生命周期管理及工具介绍.md\n\n# 索引全生命周期管理及工具介绍\n```\n\n# 运行三个节点，分片 将box_type设置成 hot，warm和cold\n# 具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件\n\n\n\nDELETE *\n\n\n\n# 设置 1秒刷新1次，生产环境10分种刷新一次\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.lifecycle.poll_interval\":\"1s\"\n  }\n}\n\n# 设置 Policy\nPUT /_ilm/policy/log_ilm_policy\n{\n  \"policy\": {\n    \"phases\": {\n      \"hot\": {\n        \"actions\": {\n          \"rollover\": {\n            \"max_docs\": 5\n          }\n        }\n      },\n      \"warm\": {\n        \"min_age\": \"10s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"warm\"\n            }\n          }\n        }\n      },\n      \"cold\": {\n        \"min_age\": \"15s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"cold\"\n            }\n          }\n        }\n      },\n      \"delete\": {\n        \"min_age\": \"20s\",\n        \"actions\": {\n          \"delete\": {}\n        }\n      }\n    }\n  }\n}\n\n\n\n# 设置索引模版\nPUT /_template/log_ilm_template\n{\n  \"index_patterns\" : [\n      \"ilm_index-*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"lifecycle\" : {\n          \"name\" : \"log_ilm_policy\",\n          \"rollover_alias\" : \"ilm_alias\"\n        },\n        \"routing\" : {\n          \"allocation\" : {\n            \"include\" : {\n              \"box_type\" : \"hot\"\n            }\n          }\n        },\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"0\"\n      }\n    },\n    \"mappings\" : { },\n    \"aliases\" : { }\n}\n\n\n\n#创建索引\nPUT ilm_index-000001\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0,\n    \"index.lifecycle.name\": \"log_ilm_policy\",\n    \"index.lifecycle.rollover_alias\": \"ilm_alias\",\n    \"index.routing.allocation.include.box_type\":\"hot\"\n  },\n  \"aliases\": {\n    \"ilm_alias\": {\n      \"is_write_index\": true\n    }\n  }\n}\n\n# 对 Alias写入文档\nPOST  ilm_alias/_doc\n{\n  \"dfd\":\"dfdsf\"\n}\n\n```\n# 12.1-Logstash入门及架构介绍.md\n\n# Logstash 入门及架构介绍\n```\n\n\n# 一个 Demo， demo 运行\nsudo bin/logstash -f logstash-filter.conf\n\n# demo数据\n127.0.0.1 - - [11/Dec/2013:00:01:45 -0800] \"GET /xampp/status.php HTTP/1.1\" 200 3891 \"http://cadenza/xampp/navi.php\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0\"\n\n\n# codec demo\n\n\nsudo bin/logstash -e \"input{stdin{codec=>line}}output{stdout{codec=> rubydebug}}\"\nsudo bin/logstash -e \"input{stdin{codec=>json}}output{stdout{codec=> rubydebug}}\"\nsudo bin/logstash -e \"input{stdin{codec=>line}}output{stdout{codec=> dots}}\"\n\n\nsudo bin/logstash -f multiline-exception.conf\n\n# 多行数据，异常\nException in thread \"main\" java.lang.NullPointerException\n        at com.example.myproject.Book.getTitle(Book.java:16)\n        at com.example.myproject.Author.getBookTitles(Author.java:25)\n        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\n\n\n\n# 一个实例\nhttps://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf\n\n```\n\n\n# 12.2-利用JDBC插件导入数据到Elasticsearch.md\n\n# Logstash插件及文档介绍\n```\nhttps://spring.io/guides/gs/accessing-data-mysql/\ncreate database db_example;\nuse db_example;\nshow tables;\ndrop table user;\nselect * from user;\n\n\n\n# 新增用户\ncurl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ\ncurl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ\ncurl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ\n\n#查看所有的用户\ncurl 'localhost:8080/demo/all'\n\n# 更新用户\ncurl -X PUT localhost:8080/demo/update -d id=16 -d name=Bob2 -d email=bob2@xyz.com -d tags=Mysql,IntelliJ\n\n# 删除用户\ncurl -X DELETE localhost:8080/demo/delete -d id=15\n\n\n\nmysql-demo.conf\n\n# 创建 alias，只显示没有被标记 deleted的用户\nPOST /_aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"users\",\n        \"alias\": \"view_users\",\n         \"filter\" : { \"term\" : { \"is_deleted\" : false } }\n      }\n    }\n  ]\n}\n\n# 通过 Alias查询，查不到被标记成 deleted的用户\nPOST view_users/_search\n{\n\n}\n\n\nPOST view_users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"Jack\"\n      }\n    }\n  }\n}\n\nPOST users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"Jack\"\n      }\n    }\n  }\n}\n\n```\n\n\n# 12.3-Beats介绍.md\n\n# Beats介绍\n```\n\n##\n# 查看 packetbeat 模块\n# 设置 packetbeat 的mysql 模块\n# 启动运行\n#\n./metricbeat modules list\n./metricbeat modules enable mysql\n./metricbeat setup --dashboards\n\n# 安装mysql\ncreate database db_example\nuse db_example;\nshow tables;\nselect * from user\n\ncurl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ\ncurl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ\ncurl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ\n\ncurl 'localhost:8080/demo/all'\n\n\n# 配置 packetbeat\n# 启动\n修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控\n\nsudo chown root packetbeat.yml\nsudo ./packetbeat setup --dashboards\nsudo ./packetbeat\n\n\n# 查看所有 Filebeat 模块\n# 查看所有的modules\n./filebeat modules list\n\n#\n./filebeat modules enable mysql\n\n```\n\n\n# 13.1-使用IndexPattern配置数据.md\n\n\n```\n\nlocalhost:5601/status\n\n\n\n\nPUT /logstash-2015.05.18\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\nPUT /logstash-2015.05.19\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /logstash-2015.05.20\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n# For Mac & Windows\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/_bulk?pretty' --data-binary @logs.jsonl\n\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\n\n\n#For Windows\nInvoke-RestMethod \"http://localhost:9200/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"logs.jsonl\"\n\n\n\nGET /_cat/indices?v\n\n```\n\n\n# 13.2-使用KibanaDiscover探索数据.md\n\n# 使用Kibana Discovery 探索数据\n```\n\n设置时间过滤器\n搜索你的数据\n根据字段进行过滤\n查看文档数据\n查看文档上下文\n暂时字段数据统计\nSave Query\n\n\n```\n\n\n# 13.3-基本可视化组件介绍.md\n\n# 基本可视化组件介绍\n```\n\nPUT /shakespeare\n{\n  \"mappings\": {\n    \"properties\": {\n    \"speaker\": {\"type\": \"keyword\"},\n    \"play_name\": {\"type\": \"keyword\"},\n    \"line_id\": {\"type\": \"integer\"},\n    \"speech_number\": {\"type\": \"integer\"}\n    }\n  }\n}\n\n\n# For Mac & Windows\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/shakespeare/_bulk?pretty' --data-binary @shakespeare.json\n\n#For Windows\nInvoke-RestMethod \"http://localhost:9200/bank/account/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"accounts.json\"\nInvoke-RestMethod \"http://localhost:9200/shakespeare/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"shakespeare.json\"\n\n\n```\n\n\n# 13.4-构建Dashboard.md\n\n# 构建Dashboard\n```\n- 创建仪表潘\n- 加载仪表盘\n- 共享仪表盘\n\n```\n\n\n# 14.3用机器学习实现时序数据的异常检测-上.md\n\nmkdir server_metrics\ncd server_metrics\nwget https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz\ntar -xvf server_metrics.tar.gz\n\n\n# 14.5-用ELK进行日志管理.md\n\n# 用 ELK 来做日志管理\n```\n./filebeat modules list\n./filebeat modules enable system\n./filebeat modules enable elasticsearch\n\n\n## 进 modules.d 编辑相应的文件，修改log路径\n\n./filebeat setup –dashboards\n\n./filebeat export template | more\n\n./filebeat -e\n\n```\n\n# 14.6-用Canvas做数据演示.md\n\nPOST elasticoffee/_search\n{\n  \"size\": 0, \n  \"aggs\": {\n    \"by\": {\n      \"terms\": {\n        \"field\": \"beverage.keyword\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n# 4.1-基于词项和基于全文的搜索.md\n\n# 基于词项和基于全文的搜索\n\n\n```\nDELETE products\nPUT products\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  }\n}\n\n\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"productID\" : \"XHDK-A-1293-#fJ3\",\"desc\":\"iPhone\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"productID\" : \"KDKE-B-9947-#kL5\",\"desc\":\"iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"productID\" : \"JODL-X-1937-#pV7\",\"desc\":\"MBP\" }\n\nGET /products\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": {\n        //\"value\": \"iPhone\"\n        \"value\":\"iphone\"\n      }\n    }\n  }\n}\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc.keyword\": {\n        //\"value\": \"iPhone\"\n        //\"value\":\"iphone\"\n      }\n    }\n  }\n}\n\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n\nPOST /products/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n\n\n\n\nPOST /products/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n\n    }\n  }\n}\n\n\n#设置 position_increment_gap\nDELETE groups\nPUT groups\n{\n  \"mappings\": {\n    \"properties\": {\n      \"names\":{\n        \"type\": \"text\",\n        \"position_increment_gap\": 0\n      }\n    }\n  }\n}\n\nGET groups/_mapping\n\nPOST groups/_doc\n{\n  \"names\": [ \"John Water\", \"Water Smith\"]\n}\n\nPOST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": {\n        \"query\": \"Water Water\",\n        \"slop\": 100\n      }\n    }\n  }\n}\n\n\nPOST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": \"Water Smith\"\n    }\n  }\n}\n```\n\n# 4.10-综合排序：Function Score Query 优化算分.md\n\n# 综合排序：Function Score Query 优化算分\n```\nDELETE blogs\nPUT /blogs/_doc/1\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   0\n}\n\nPUT /blogs/_doc/2\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   100\n}\n\nPUT /blogs/_doc/3\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   1000000\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\"\n      }\n    }\n  }\n}\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\"\n      }\n    }\n  }\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      }\n    }\n  }\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      },\n      \"boost_mode\": \"sum\",\n      \"max_boost\": 3\n    }\n  }\n}\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"random_score\": {\n        \"seed\": 911119\n      }\n    }\n  }\n}\n```\n# 4.12-自动补全与基于上下文的提示.md\n\n# 自动补全与基于上下文的提示\n```\nDELETE articles\nPUT articles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title_completion\":{\n        \"type\": \"completion\"\n      }\n    }\n  }\n}\n\nPOST articles/_bulk\n{ \"index\" : { } }\n{ \"title_completion\": \"lucene is very cool\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch builds on top of lucene\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch rocks\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"elastic is the company behind ELK stack\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elk stack rocks\"}\n{ \"index\" : {} }\n\n\nPOST articles/_search?pretty\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"article-suggester\": {\n      \"prefix\": \"elk \",\n      \"completion\": {\n        \"field\": \"title_completion\"\n      }\n    }\n  }\n}\n\n\nDELETE comments\nPUT comments\nPUT comments/_mapping\n{\n  \"properties\": {\n    \"comment_autocomplete\":{\n      \"type\": \"completion\",\n      \"contexts\":[{\n        \"type\":\"category\",\n        \"name\":\"comment_category\"\n      }]\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"I love the star war movies\",\n  \"comment_autocomplete\":{\n    \"input\":[\"star wars\"],\n    \"contexts\":{\n      \"comment_category\":\"movies\"\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"Where can I find a Starbucks\",\n  \"comment_autocomplete\":{\n    \"input\":[\"starbucks\"],\n    \"contexts\":{\n      \"comment_category\":\"coffee\"\n    }\n  }\n}\n\n\nPOST comments/_search\n{\n  \"suggest\": {\n    \"MY_SUGGESTION\": {\n      \"prefix\": \"sta\",\n      \"completion\":{\n        \"field\":\"comment_autocomplete\",\n        \"contexts\":{\n          \"comment_category\":\"coffee\"\n        }\n      }\n    }\n  }\n}\n```\n\n\n# 4.13-跨集群搜索.md\n\n# 跨集群搜索\n```\n//启动3个集群\n\nbin/elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300\nbin/elasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301\nbin/elasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302\n\n\n//在每个集群上设置动态的设置\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster\": {\n      \"remote\": {\n        \"cluster0\": {\n          \"seeds\": [\n            \"127.0.0.1:9300\"\n          ],\n          \"transport.ping_schedule\": \"30s\"\n        },\n        \"cluster1\": {\n          \"seeds\": [\n            \"127.0.0.1:9301\"\n          ],\n          \"transport.compress\": true,\n          \"skip_unavailable\": true\n        },\n        \"cluster2\": {\n          \"seeds\": [\n            \"127.0.0.1:9302\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n#cURL\ncurl -XPUT \"http://localhost:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9201/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9202/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\n\n#创建测试数据\ncurl -XPOST \"http://localhost:9200/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user1\",\"age\":10}'\n\ncurl -XPOST \"http://localhost:9201/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user2\",\"age\":20}'\n\ncurl -XPOST \"http://localhost:9202/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user3\",\"age\":30}'\n\n\n#查询\nGET /users,cluster1:users,cluster2:users/_search\n{\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20,\n        \"lte\": 40\n      }\n    }\n  }\n}\n\n```\n\n\n# 4.2-结构化搜索.md\n\n# 结构化搜索\n\n```\n\n#结构化搜索，精确匹配\nDELETE products\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\nGET products/_mapping\n\n\n\n#对布尔值 match 查询，有算分\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"avaliable\": true\n    }\n  }\n}\n\n\n\n#对布尔值，通过constant score 转成 filtering，没有算分\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": true\n        }\n      }\n    }\n  }\n}\n\n\n#数字类型 Term\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": 30\n    }\n  }\n}\n\n#数字类型 terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"price\": [\n            \"20\",\n            \"30\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n#数字 Range 查询\nGET products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"price\" : {\n                        \"gte\" : 20,\n                        \"lte\"  : 30\n                    }\n                }\n            }\n        }\n    }\n}\n\n\n# 日期 range\nPOST products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"date\" : {\n                      \"gte\" : \"now-1y\"\n                    }\n                }\n            }\n        }\n    }\n}\n\n\n\n#exists查询\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"exists\": {\n          \"field\": \"date\"\n        }\n      }\n    }\n  }\n}\n\n#处理多值字段\nPOST /movies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\"}\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"] }\n\n\n#处理多值字段，term 查询是包含，而不是等于\nPOST movies/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"genre.keyword\": \"Comedy\"\n        }\n      }\n    }\n  }\n}\n\n\n#字符类型 terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"productID.keyword\": [\n            \"QQPX-R-3956-#aD8\",\n            \"JODL-X-1937-#pV7\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": 30\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\n\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n    }\n  }\n}\n\n#对布尔数值\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": \"false\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"avaliable\": {\n        \"value\": \"false\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": {\n        \"value\": \"20\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": \"20\"\n    }\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"bool\": {\n          \"must_not\": {\n            \"exists\": {\n              \"field\": \"date\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\n```\n# 4.3-搜索的相关性算分.md\n\n# 搜索的相关性算分\n\n```\n\n\nPUT testscore\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      }\n    }\n  }\n}\n\n\nPUT testscore/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"we use Elasticsearch to power the search\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"we like elasticsearch\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"The scoring of documents is caculated by the scoring formula\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"content\":\"you know, for search\" }\n\n\n\nPOST /testscore/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"content\":\"you\"\n      //\"content\": \"elasticsearch\"\n      //\"content\":\"the\"\n      //\"content\": \"the elasticsearch\"\n    }\n  }\n}\n\nPOST testscore/_search\n{\n    \"query\": {\n        \"boosting\" : {\n            \"positive\" : {\n                \"term\" : {\n                    \"content\" : \"elasticsearch\"\n                }\n            },\n            \"negative\" : {\n                 \"term\" : {\n                     \"content\" : \"like\"\n                }\n            },\n            \"negative_boost\" : 0.2\n        }\n    }\n}\n\n\nPOST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"more_like_this\": {\n      \"fields\": [\n        \"title^10\",\"overview\"\n      ],\n      \"like\": [{\"_id\":\"14191\"}],\n      \"min_term_freq\": 1,\n      \"max_query_terms\": 12\n    }\n  }\n}\n\n\n\n```\n\n\n# 4.4-Query&Filtering实现多字符串多字段查询.md\n\n# Query & Filtering 与多字符串多字段查询\n\n```\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\n\n\n#基本语法\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :1\n    }\n  }\n}\n\n#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题\nPOST /newmovies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\",\"genre_count\":1 }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"],\"genre_count\":2 }\n\n#must，有算分\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n\n      ]\n    }\n  }\n}\n\n#Filter。不参与算分，结果的score是0\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n        ]\n\n    }\n  }\n}\n\n\n#Filtering Context\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      }\n    }\n  }\n}\n\n\n#Query Context\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\n\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"term\": {\n            \"productID.keyword\": {\n              \"value\": \"JODL-X-1937-#pV7\"}}\n        },\n        {\"term\": {\"avaliable\": {\"value\": true}}\n        }\n      ]\n    }\n  }\n}\n\n\n#嵌套，实现了 should not 逻辑\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\": {\n          \"price\": \"30\"\n        }\n      },\n      \"should\": [\n        {\n          \"bool\": {\n            \"must_not\": {\n              \"term\": {\n                \"avaliable\": \"false\"\n              }\n            }\n          }\n        }\n      ],\n      \"minimum_should_match\": 1\n    }\n  }\n}\n\n\n#Controll the Precision\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :2\n    }\n  }\n}\n\n\n\nPOST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"brown\" }},\n        { \"term\": { \"text\": \"red\" }},\n        { \"term\": { \"text\": \"quick\"   }},\n        { \"term\": { \"text\": \"dog\"   }}\n      ]\n    }\n  }\n}\n\nPOST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"quick\" }},\n        { \"term\": { \"text\": \"dog\"   }},\n        {\n          \"bool\":{\n            \"should\":[\n               { \"term\": { \"text\": \"brown\" }},\n                 { \"term\": { \"text\": \"brown\" }},\n            ]\n          }\n\n        }\n      ]\n    }\n  }\n}\n\n\nDELETE blogs\nPOST /blogs/_bulk\n{ \"index\": { \"_id\": 1 }}\n{\"title\":\"Apple iPad\", \"content\":\"Apple iPad,Apple iPad\" }\n{ \"index\": { \"_id\": 2 }}\n{\"title\":\"Apple iPad,Apple iPad\", \"content\":\"Apple iPad\" }\n\n\nPOST blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\"match\": {\n          \"title\": {\n            \"query\": \"apple,ipad\",\n            \"boost\": 1.1\n          }\n        }},\n\n        {\"match\": {\n          \"content\": {\n            \"query\": \"apple,ipad\",\n            \"boost\":\n          }\n        }}\n      ]\n    }\n  }\n}\n\nDELETE news\nPOST /news/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"Apple Mac\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"Apple iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"Apple employee like Apple Pie and Apple Juice\" }\n\n\nPOST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      }\n    }\n  }\n}\n\nPOST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      },\n      \"must_not\": {\n        \"match\":{\"content\":\"pie\"}\n      }\n    }\n  }\n}\n\nPOST news/_search\n{\n  \"query\": {\n    \"boosting\": {\n      \"positive\": {\n        \"match\": {\n          \"content\": \"apple\"\n        }\n      },\n      \"negative\": {\n        \"match\": {\n          \"content\": \"pie\"\n        }\n      },\n      \"negative_boost\": 0.5\n    }\n  }\n}\n\n```\n\n# 4.5-单字符串多字段查询-DisMaxQuery.md\n\n# 单字符串多字段查询：Dis Max Query\n```\n\nPUT /blogs/_doc/1\n{\n    \"title\": \"Quick brown rabbits\",\n    \"body\":  \"Brown rabbits are commonly seen.\"\n}\n\nPUT /blogs/_doc/2\n{\n    \"title\": \"Keeping pets healthy\",\n    \"body\":  \"My quick brown fox eats rabbits on a regular basis.\"\n}\n\nPOST /blogs/_search\n{\n    \"query\": {\n        \"bool\": {\n            \"should\": [\n                { \"match\": { \"title\": \"Brown fox\" }},\n                { \"match\": { \"body\":  \"Brown fox\" }}\n            ]\n        }\n    }\n}\n\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ]\n        }\n    }\n}\n\n\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n\n\n```\n# 4.6-单字符串多字段查询-Multi-Match.md\n\n# 单字符串多字段查询：Multi Match\n```\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n\nPOST blogs/_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\": \"best_fields\",\n      \"query\": \"Quick pets\",\n      \"fields\": [\"title\",\"body\"],\n      \"tie_breaker\": 0.2,\n      \"minimum_should_match\": \"20%\"\n    }\n  }\n}\n\n\n\nPOST books/_search\n{\n    \"multi_match\": {\n        \"query\":  \"Quick brown fox\",\n        \"fields\": \"*_title\"\n    }\n}\n\n\nPOST books/_search\n{\n    \"multi_match\": {\n        \"query\":  \"Quick brown fox\",\n        \"fields\": [ \"*_title\", \"chapter_title^2\" ]\n    }\n}\n\n\n\nDELETE /titles\nPUT /titles\n{\n    \"settings\": { \"number_of_shards\": 1 },\n    \"mappings\": {\n        \"my_type\": {\n            \"properties\": {\n                \"title\": {\n                    \"type\":     \"string\",\n                    \"analyzer\": \"english\",\n                    \"fields\": {\n                        \"std\":   {\n                            \"type\":     \"string\",\n                            \"analyzer\": \"standard\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\"\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n\n\nGET titles/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"barking dogs\"\n    }\n  }\n}\n\nDELETE /titles\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\",\n        \"fields\": {\"std\": {\"type\": \"text\",\"analyzer\": \"standard\"}}\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n\nGET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title\", \"title.std\" ]\n        }\n    }\n}\n\nGET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title^10\", \"title.std\" ]\n        }\n    }\n}\n\n```\n\n# 4.7-多语言及中文分词与检索.md\n\n# 多语言及中文分词与检索\n\n- 来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”\n\n- 你也想犯范范玮琪犯过的错吗\n- 校长说衣服上除了校徽别别别的\n- 这几天天天天气不好\n- 我背有点驼，麻麻说“你的背得背背背背佳\n\n```\n#stop word\n\nDELETE my_index\nPUT /my_index/_doc/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/_doc/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\n\nPOST my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"not happy fox\"\n    }\n  }\n}\n\n\n#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 `english`（英语）分析器，另一次使用 `standard`（标准）分析器:\n\nDELETE my_index\n\nPUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"analyzer\": \"english\"\n        }\n      }\n    }\n  }\n}\n\nPUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"fields\": {\n            \"english\": {\n              \"type\":     \"string\",\n              \"analyzer\": \"english\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /my_index/blog/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/blog/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\nGET /_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\":     \"most_fields\",\n      \"query\":    \"not happy foxes\",\n      \"fields\": [ \"title\", \"title.english\" ]\n    }\n  }\n}\n\n\n#安装插件\n./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip\n#安装插件\nbin/elasticsearch install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip\n\n\n\n\n#ik_max_word\n#ik_smart\n#hanlp: hanlp默认分词\n#hanlp_standard: 标准分词\n#hanlp_index: 索引分词\n#hanlp_nlp: NLP分词\n#hanlp_n_short: N-最短路分词\n#hanlp_dijkstra: 最短路分词\n#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）\n#hanlp_speed: 极速词典分词\n\nPOST _analyze\n{\n  \"analyzer\": \"hanlp_standard\",\n  \"text\": [\"剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜\"]\n\n}     \n\n#Pinyin\nPUT /artists/\n{\n    \"settings\" : {\n        \"analysis\" : {\n            \"analyzer\" : {\n                \"user_name_analyzer\" : {\n                    \"tokenizer\" : \"whitespace\",\n                    \"filter\" : \"pinyin_first_letter_and_full_pinyin_filter\"\n                }\n            },\n            \"filter\" : {\n                \"pinyin_first_letter_and_full_pinyin_filter\" : {\n                    \"type\" : \"pinyin\",\n                    \"keep_first_letter\" : true,\n                    \"keep_full_pinyin\" : false,\n                    \"keep_none_chinese\" : true,\n                    \"keep_original\" : false,\n                    \"limit_first_letter_length\" : 16,\n                    \"lowercase\" : true,\n                    \"trim_whitespace\" : true,\n                    \"keep_none_chinese_in_first_letter\" : true\n                }\n            }\n        }\n    }\n}\n\n\nGET /artists/_analyze\n{\n  \"text\": [\"刘德华 张学友 郭富城 黎明 四大天王\"],\n  \"analyzer\": \"user_name_analyzer\"\n}\n\n\n```\n\n## 相关资源\n- Elasticsearch IK分词插件 https://github.com/medcl/elasticsearch-analysis-ik/releases\n- Elasticsearch hanlp 分词插件 https://github.com/KennFalcon/elasticsearch-analysis-hanlp\n\n- 分词算法综述 https://zhuanlan.zhihu.com/p/50444885\n\n### 一些分词工具，供参考：\n- 中科院计算所NLPIR http://ictclas.nlpir.org/nlpir/\n- ansj分词器 https://github.com/NLPchina/ansj_seg\n- 哈工大的LTP https://github.com/HIT-SCIR/ltp\n- 清华大学THULAC https://github.com/thunlp/THULAC\n- 斯坦福分词器 https://nlp.stanford.edu/software/segmenter.shtml\n- Hanlp分词器 https://github.com/hankcs/HanLP\n- 结巴分词 https://github.com/yanyiwu/cppjieba\n- KCWS分词器(字嵌入+Bi-LSTM+CRF) https://github.com/koth/kcws\n- ZPar https://github.com/frcchang/zpar/releases\n- IKAnalyzer https://github.com/wks/ik-analyzer\n\n\n# 4.8-SpaceJam一个全文搜索的实例.md\n\n# Space Jam，一次全文搜索的实例\n\n## 环境要求\n- Python 2.7.15\n- 可以使用pyenv管理多个python版本（可选）\n\n## 进入 tmdb-search目录\nRun\npip install -r requirements.txt\nRun python ./ingest_tmdb_from_file.py\n```\nPOST tmdb/_search\n{\n\"_source\": [\"title\",\"overview\"],\n \"query\": {\n   \"match_all\": {}\n }\n}\n\nPOST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"multi_match\": {\n      \"query\": \"basketball with cartoon aliens\",\n      \"fields\": [\"title\",\"overview\"]\n    }\n  },\n  \"highlight\" : {\n        \"fields\" : {\n            \"overview\" : { \"pre_tags\" : [\"\\\\033[0;32;40m\"], \"post_tags\" : [\"\\\\033[0m\"] },\n            \"title\" : { \"pre_tags\" : [\"\\\\033[0;32;40m\"], \"post_tags\" : [\"\\\\033[0m\"] }\n\n        }\n    }\n}\n```\n\n## 相关\n- Windows 安装 pyenv https://github.com/pyenv-win/pyenv-win\n- Mac 安装pyenv https://segmentfault.com/a/1190000017403221\n- Linux 安装 pyenv https://blog.csdn.net/GX_1_11_real/article/details/80237064\n- Python.org https://www.python.org/\n\n\n# 4.9-使用SearchTemplate和IndexAlias进行查询.md\n\n# 使用 Search Template 和 Index Alias 查询\n\n```\nPOST _scripts/tmdb\n{\n  \"script\": {\n    \"lang\": \"mustache\",\n    \"source\": {\n      \"_source\": [\n        \"title\",\"overview\"\n      ],\n      \"size\": 20,\n      \"query\": {\n        \"multi_match\": {\n          \"query\": \"{{q}}\",\n          \"fields\": [\"title\",\"overview\"]\n        }\n      }\n    }\n  }\n}\nDELETE _scripts/tmdb\n\nGET _scripts/tmdb\n\nPOST tmdb/_search/template\n{\n    \"id\":\"tmdb\",\n    \"params\": {\n        \"q\": \"basketball with cartoon aliens\"\n    }\n}\n\n\nPUT movies-2019/_doc/1\n{\n  \"name\":\"the matrix\",\n  \"rating\":5\n}\n\nPUT movies-2019/_doc/2\n{\n  \"name\":\"Speed\",\n  \"rating\":3\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-latest\"\n      }\n    }\n  ]\n}\n\nPOST movies-latest/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-lastest-highrate\",\n        \"filter\": {\n          \"range\": {\n            \"rating\": {\n              \"gte\": 4\n            }\n          }\n        }\n      }\n    }\n  ]\n}\n\nPOST movies-lastest-highrate/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n\n\n```\n\n\n# 5.1-集群分布式模型及选主与脑裂问题.md\n\n# 集群分布式模型及选主与脑裂问题\n\n```\nbin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data\nbin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data\nbin/elasticsearch -E node.name=node3 -E cluster.name=geektime -E path.data=node3_data\n\n```\n# 5.2-分片与集群的故障转移.md\n\n# 分片与集群的故障转移\n\n\n# 5.3-文档分布式存储.md\n\n# 文档分布式存储\n\n\n# 5.4-分片及其生命周期.md\n\n# 分片及其生命周期\n\n\n# 5.5-剖析分布式查询及相关性评分.md\n\n# 剖析分布式查询及相关性评分\n```\nDELETE message\nPUT message\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  }\n}\n\nGET message\n\nPOST message/_doc?routing=1\n{\n  \"content\":\"good\"\n}\n\nPOST message/_doc?routing=2\n{\n  \"content\":\"good morning\"\n}\n\nPOST message/_doc?routing=3\n{\n  \"content\":\"good morning everyone\"\n}\n\nPOST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n\nPOST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n\n\nPOST message/_search?search_type=dfs_query_then_fetch\n{\n\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n\n```\n\n\n# 5.6-排序及DocValues&Fielddata.md\n\n# 排序及Doc Values & Fielddata\n```\n#单字段排序\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}}\n  ]\n}\n\n#多字段排序\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}},\n    {\"_doc\":{\"order\": \"asc\"}},\n    {\"_score\":{ \"order\": \"desc\"}}\n  ]\n}\n\nGET kibana_sample_data_ecommerce/_mapping\n\n#对 text 字段进行排序。默认会报错，需打开fielddata\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"customer_full_name\": {\"order\": \"desc\"}}\n  ]\n}\n\n#打开 text的 fielddata\nPUT kibana_sample_data_ecommerce/_mapping\n{\n  \"properties\": {\n    \"customer_full_name\" : {\n          \"type\" : \"text\",\n          \"fielddata\": true,\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n  }\n}\n\n#关闭 keyword的 doc values\nPUT test_keyword\nPUT test_keyword/_mapping\n{\n  \"properties\": {\n    \"user_name\":{\n      \"type\": \"keyword\",\n      \"doc_values\":false\n    }\n  }\n}\n\nDELETE test_keyword\n\nPUT test_text\nPUT test_text/_mapping\n{\n  \"properties\": {\n    \"intro\":{\n      \"type\": \"text\",\n      \"doc_values\":true\n    }\n  }\n}\n\nDELETE test_text\n\n\nDELETE temp_users\nPUT temp_users\nPUT temp_users/_mapping\n{\n  \"properties\": {\n    \"name\":{\"type\": \"text\",\"fielddata\": true},\n    \"desc\":{\"type\": \"text\",\"fielddata\": true}\n  }\n}\n\nPost temp_users/_doc\n{\"name\":\"Jack\",\"desc\":\"Jack is a good boy!\",\"age\":10}\n\n#打开fielddata 后，查看 docvalue_fields数据\nPOST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"name\",\"desc\"\n    ]\n}\n\n#查看整型字段的docvalues\nPOST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"age\"\n    ]\n}\n```\n\n\n# 5.7-分页与遍历-FromSize&SearchAfter&ScrollAPI.md\n\n# 分页与遍历 - From, Size, Search_after & Scroll API\n```\n\nPOST tmdb/_search\n{\n  \"from\": 10000,\n  \"size\": 1,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  }\n}\n\n#Scroll API\nDELETE users\n\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":11}\n\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":12}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":13}\n\nPOST users/_count\n\nPOST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n\nPOST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"search_after\":\n        [\n          10,\n          \"ZQ0vYGsBrR8X3IP75QqX\"],\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n\n\n#Scroll API\nDELETE users\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":20}\n\nPOST users/_doc\n{\"name\":\"user3\",\"age\":30}\n\nPOST users/_doc\n{\"name\":\"user4\",\"age\":40}\n\nPOST /users/_search?scroll=5m\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\" : {\n        }\n    }\n}\n\n\nPOST users/_doc\n{\"name\":\"user5\",\"age\":50}\nPOST /_search/scroll\n{\n    \"scroll\" : \"1m\",\n    \"scroll_id\" : \"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ==\"\n}\n\n\n```\n\n\n# 5.8-处理并发读写.md\n\n# 处理并发读写操作\n```\n\nDELETE products\nPUT products\n\nPUT products/_doc/1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\nGET products/_doc/1\n\nPUT products/_doc/1?if_seq_no=1&if_primary_term=1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\nPUT products/_doc/1?version=30000&version_type=external\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\n```\n\n\n# 6.1-Bucket&Metric聚合分析及嵌套聚合.md\n\n# Bucket & Metric Aggregation\n## demos\n```\nDELETE /employees\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n# Metric 聚合，找到最低的工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"min_salary\": {\n      \"min\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n# Metric 聚合，找到最高的工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n# 多个 Metric 聚合，找到最低最高和平均工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"min_salary\": {\n      \"min\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"avg_salary\": {\n      \"avg\": {\n        \"field\": \"salary\"\n      }\n    }\n  }\n}\n\n# 一个聚合，输出多值\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"stats_salary\": {\n      \"stats\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n\n\n\n# 对keword 进行聚合\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n\n\n# 对 Text 字段进行 terms 聚合查询，失败\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n\n# 对 Text 字段打开 fielddata，支持terms aggregation\nPUT employees/_mapping\n{\n  \"properties\" : {\n    \"job\":{\n       \"type\":     \"text\",\n       \"fielddata\": true\n    }\n  }\n}\n\n\n# 对 Text 字段进行 terms 分词。分词后的terms\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n\n\n# 对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"cardinate\": {\n      \"cardinality\": {\n        \"field\": \"job\"\n      }\n    }\n  }\n}\n\n\n# 对 性别的 keyword 进行聚合\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"gender\": {\n      \"terms\": {\n        \"field\":\"gender\"\n      }\n    }\n  }\n}\n\n\n#指定 bucket 的 size\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"ages_5\": {\n      \"terms\": {\n        \"field\":\"age\",\n        \"size\":3\n      }\n    }\n  }\n}\n\n\n\n# 指定size，不同工种中，年纪最大的3个员工的具体信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      },\n      \"aggs\":{\n        \"old_employee\":{\n          \"top_hits\":{\n            \"size\":3,\n            \"sort\":[\n              {\n                \"age\":{\n                  \"order\":\"desc\"\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\n#Salary Ranges 分桶，可以自己定义 key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_range\": {\n      \"range\": {\n        \"field\":\"salary\",\n        \"ranges\":[\n          {\n            \"to\":10000\n          },\n          {\n            \"from\":10000,\n            \"to\":20000\n          },\n          {\n            \"key\":\">20000\",\n            \"from\":20000\n          }\n        ]\n      }\n    }\n  }\n}\n\n\n#Salary Histogram,工资0到10万，以 5000一个区间进行分桶\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_histrogram\": {\n      \"histogram\": {\n        \"field\":\"salary\",\n        \"interval\":5000,\n        \"extended_bounds\":{\n          \"min\":0,\n          \"max\":100000\n\n        }\n      }\n    }\n  }\n}\n\n\n# 嵌套聚合1，按照工作类型分桶，并统计工资信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_salary_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"salary\": {\n          \"stats\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n# 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_gender_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"gender_stats\": {\n          \"terms\": {\n            \"field\": \"gender\"\n          },\n          \"aggs\": {\n            \"salary_stats\": {\n              \"stats\": {\n                \"field\": \"salary\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\n\n# 6.2-Pipeline聚合分析.md\n\n# Pipeline 聚合分析\n```\nDELETE employees\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n\n\n# 平均工资最低的工作类型\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"min_salary_by_job\":{\n      \"min_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资最高的工作类型\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"max_salary_by_job\":{\n      \"max_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的平均工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"avg_salary_by_job\":{\n      \"avg_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的统计分析\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"stats_salary_by_job\":{\n      \"stats_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的百分位数\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"percentiles_salary_by_job\":{\n      \"percentiles_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n\n#按照年龄对平均工资求导\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"derivative_avg_salary\":{\n          \"derivative\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#Cumulative_sum\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"cumulative_salary\":{\n          \"cumulative_sum\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n#Moving Function\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"moving_avg_salary\":{\n          \"moving_fn\": {\n            \"buckets_path\": \"avg_salary\",\n            \"window\":10,\n            \"script\": \"MovingFunctions.min(values)\"\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\n# 6.3-作用范围与排序.md\n\n# 作用范围与排序\n```\nDELETE /employees\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n\n\n# Query\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    }\n  }\n}\n\n\n#Filter\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"older_person\": {\n      \"filter\":{\n        \"range\":{\n          \"age\":{\n            \"from\":35\n          }\n        }\n      },\n      \"aggs\":{\n         \"jobs\":{\n           \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n      }\n    }},\n    \"all_jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    }\n  }\n}\n\n\n\n#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果\nPOST employees/_search\n{\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      }\n    }\n  },\n  \"post_filter\": {\n    \"match\": {\n      \"job.keyword\": \"Dev Manager\"\n    }\n  }\n}\n\n\n#global\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 40\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    },\n    \n    \"all\":{\n      \"global\":{},\n      \"aggs\":{\n        \"salary_avg\":{\n          \"avg\":{\n            \"field\":\"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[\n          {\"_count\":\"asc\"},\n          {\"_key\":\"desc\"}\n          ]\n        \n      }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"avg_salary\":\"desc\"\n          }]\n        \n        \n      },\n    \"aggs\": {\n      \"avg_salary\": {\n        \"avg\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"stats_salary.min\":\"desc\"\n          }]\n        \n        \n      },\n    \"aggs\": {\n      \"stats_salary\": {\n        \"stats\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n```\n\n# 6.4-聚合分析的原理及精准度问题.md\n\n# 聚合分析的原理及精准度问题\n```\nDELETE my_flights\nPUT my_flights\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  },\n  \"mappings\" : {\n      \"properties\" : {\n        \"AvgTicketPrice\" : {\n          \"type\" : \"float\"\n        },\n        \"Cancelled\" : {\n          \"type\" : \"boolean\"\n        },\n        \"Carrier\" : {\n          \"type\" : \"keyword\"\n        },\n        \"Dest\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"DestRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DistanceKilometers\" : {\n          \"type\" : \"float\"\n        },\n        \"DistanceMiles\" : {\n          \"type\" : \"float\"\n        },\n        \"FlightDelay\" : {\n          \"type\" : \"boolean\"\n        },\n        \"FlightDelayMin\" : {\n          \"type\" : \"integer\"\n        },\n        \"FlightDelayType\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightNum\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeHour\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeMin\" : {\n          \"type\" : \"float\"\n        },\n        \"Origin\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"OriginRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"dayOfWeek\" : {\n          \"type\" : \"integer\"\n        },\n        \"timestamp\" : {\n          \"type\" : \"date\"\n        }\n      }\n    }\n}\n\n\nPOST _reindex\n{\n  \"source\": {\n    \"index\": \"kibana_sample_data_flights\"\n  },\n  \"dest\": {\n    \"index\": \"my_flights\"\n  }\n}\n\nGET kibana_sample_data_flights/_count\nGET my_flights/_count\n\nget kibana_sample_data_flights/_search\n\n\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":5,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n\n\nGET my_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":1,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n\n```\n# 7.1-对象及 Nested 对象.md\n\n# 对象及Nested对象\n```\nDELETE blog\n# 设置blog的 Mapping\nPUT /blog\n{\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"time\": {\n        \"type\": \"date\"\n      },\n      \"user\": {\n        \"properties\": {\n          \"city\": {\n            \"type\": \"text\"\n          },\n          \"userid\": {\n            \"type\": \"long\"\n          },\n          \"username\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n# 插入一条 Blog 信息\nPUT blog/_doc/1\n{\n  \"content\":\"I like Elasticsearch\",\n  \"time\":\"2019-01-01T00:00:00\",\n  \"user\":{\n    \"userid\":1,\n    \"username\":\"Jack\",\n    \"city\":\"Shanghai\"\n  }\n}\n\n\n# 查询 Blog 信息\nPOST blog/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"content\": \"Elasticsearch\"}},\n        {\"match\": {\"user.username\": \"Jack\"}}\n      ]\n    }\n  }\n}\n\n\nDELETE my_movies\n\n# 电影的Mapping信息\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"properties\" : {\n            \"first_name\" : {\n              \"type\" : \"keyword\"\n            },\n            \"last_name\" : {\n              \"type\" : \"keyword\"\n            }\n          }\n        },\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n}\n\n\n# 写入一条电影信息\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n\n# 查询电影信息\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"actors.first_name\": \"Keanu\"}},\n        {\"match\": {\"actors.last_name\": \"Hopper\"}}\n      ]\n    }\n  }\n\n}\n\nDELETE my_movies\n# 创建 Nested 对象 Mapping\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"type\": \"nested\",\n          \"properties\" : {\n            \"first_name\" : {\"type\" : \"keyword\"},\n            \"last_name\" : {\"type\" : \"keyword\"}\n          }},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\"keyword\":{\"type\":\"keyword\",\"ignore_above\":256}}\n        }\n      }\n    }\n}\n\n\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n\n# Nested 查询\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"Speed\"}},\n        {\n          \"nested\": {\n            \"path\": \"actors\",\n            \"query\": {\n              \"bool\": {\n                \"must\": [\n                  {\"match\": {\n                    \"actors.first_name\": \"Keanu\"\n                  }},\n\n                  {\"match\": {\n                    \"actors.last_name\": \"Hopper\"\n                  }}\n                ]\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n\n\n# Nested Aggregation\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"actors\": {\n      \"nested\": {\n        \"path\": \"actors\"\n      },\n      \"aggs\": {\n        \"actor_name\": {\n          \"terms\": {\n            \"field\": \"actors.first_name\",\n            \"size\": 10\n          }\n        }\n      }\n    }\n  }\n}\n\n\n# 普通 aggregation不工作\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"NAME\": {\n      \"terms\": {\n        \"field\": \"actors.first_name\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n```\n\n# 7.2-文档的父子关系.md\n\n# 文档的父子关系\n```\nDELETE my_blogs\n\n# 设定 Parent/Child Mapping\nPUT my_blogs\n{\n  \"settings\": {\n    \"number_of_shards\": 2\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"blog_comments_relation\": {\n        \"type\": \"join\",\n        \"relations\": {\n          \"blog\": \"comment\"\n        }\n      },\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"title\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n\n\n#索引父文档\nPUT my_blogs/_doc/blog1\n{\n  \"title\":\"Learning Elasticsearch\",\n  \"content\":\"learning ELK @ geektime\",\n  \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n#索引父文档\nPUT my_blogs/_doc/blog2\n{\n  \"title\":\"Learning Hadoop\",\n  \"content\":\"learning Hadoop\",\n    \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n\n#索引子文档\nPUT my_blogs/_doc/comment1?routing=blog1\n{\n  \"comment\":\"I am learning ELK\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog1\"\n  }\n}\n\n#索引子文档\nPUT my_blogs/_doc/comment2?routing=blog2\n{\n  \"comment\":\"I like Hadoop!!!!!\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog2\"\n  }\n}\n\n#索引子文档\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n  \"comment\":\"Hello Hadoop\",\n  \"username\":\"Bob\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog2\"\n  }\n}\n\n# 查询所有文档\nPOST my_blogs/_search\n{\n\n}\n\n\n#根据父文档ID查看\nGET my_blogs/_doc/blog2\n\n# Parent Id 查询\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"parent_id\": {\n      \"type\": \"comment\",\n      \"id\": \"blog2\"\n    }\n  }\n}\n\n# Has Child 查询,返回父文档\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"comment\",\n      \"query\" : {\n                \"match\": {\n                    \"username\" : \"Jack\"\n                }\n            }\n    }\n  }\n}\n\n\n# Has Parent 查询，返回相关的子文档\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_parent\": {\n      \"parent_type\": \"blog\",\n      \"query\" : {\n                \"match\": {\n                    \"title\" : \"Learning Hadoop\"\n                }\n            }\n    }\n  }\n}\n\n\n\n#通过ID ，访问子文档\nGET my_blogs/_doc/comment3\n#通过ID和routing ，访问子文档\nGET my_blogs/_doc/comment3?routing=blog2\n\n#更新子文档\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n    \"comment\": \"Hello Hadoop??\",\n    \"blog_comments_relation\": {\n      \"name\": \"comment\",\n      \"parent\": \"blog2\"\n    }\n}\n\n\n```\n\n# 7.5-Elasticsearch数据建模实例.md\n\n# Elasticsearch 数据建模实例\n```\n###### Data Modeling Example\n\n# Index 一本书的信息\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n\n\n\n#查询自动创建的Mapping\nGET books/_mapping\n\nDELETE books\n\n#优化字段类型\nPUT books\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\"},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false},\n        \"description\" : {\"type\" : \"text\"},\n        \"public_date\" : {\"type\" : \"date\"},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          }\n        }\n      }\n    }\n}\n\n#Cover URL index 设置成false，无法对该字段进行搜索\nPOST books/_search\n{\n  \"query\": {\n    \"term\": {\n      \"cover_url\": {\n        \"value\": \"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n      }\n    }\n  }\n}\n\n#Cover URL index 设置成false，依然支持聚合分析\nPOST books/_search\n{\n  \"aggs\": {\n    \"cover\": {\n      \"terms\": {\n        \"field\": \"cover_url\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n\nDELETE books\n#新增 Content字段。数据量很大。选择将Source 关闭\nPUT books\n{\n      \"mappings\" : {\n      \"_source\": {\"enabled\": false},\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\",\"store\": true},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false,\"store\": true},\n        \"description\" : {\"type\" : \"text\",\"store\": true},\n         \"content\" : {\"type\" : \"text\",\"store\": true},\n        \"public_date\" : {\"type\" : \"date\",\"store\": true},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          },\n          \"store\": true\n        }\n      }\n    }\n}\n\n\n# Index 一本书的信息,包含Content\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins\",\n  \"content\":\"The content of the book......Indexing data, aggregation, searching.    something else. something in the way............\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n\n#查询结果中，Source不包含数据\nPOST books/_search\n{}\n\n#搜索，通过store 字段显示数据，同时高亮显示 conent的内容\nPOST books/_search\n{\n  \"stored_fields\": [\"title\",\"author\",\"public_date\"],\n  \"query\": {\n    \"match\": {\n      \"content\": \"searching\"\n    }\n  },\n\n  \"highlight\": {\n    \"fields\": {\n      \"content\":{}\n    }\n  }\n\n}\n\n```\n# 7.6-Elasticsearch 数据建模最佳实践.md\n\n# Elasticsearch 数据建模最佳实践\n\n\n```\n\n###### Cookie Service\n\n##索引数据，dynamic mapping 会不断加入新增字段\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":{\n   \"username\":\"tom\",\n   \"age\":32\n }\n}\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":{\n   \"login\":\"2019-01-01\",\n   \"email\":\"xyz@abc.com\"\n }\n}\n\n\nDELETE cookie_service\n#使用 Nested 对象，增加key/value\nPUT cookie_service\n{\n  \"mappings\": {\n    \"properties\": {\n      \"cookies\": {\n        \"type\": \"nested\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"keyword\"\n          },\n          \"dateValue\": {\n            \"type\": \"date\"\n          },\n          \"keywordValue\": {\n            \"type\": \"keyword\"\n          },\n          \"IntValue\": {\n            \"type\": \"integer\"\n          }\n        }\n      },\n      \"url\": {\n        \"type\": \"text\",\n        \"fields\": {\n          \"keyword\": {\n            \"type\": \"keyword\",\n            \"ignore_above\": 256\n          }\n        }\n      }\n    }\n  }\n}\n\n\n##写入数据，使用key和合适类型的value字段\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":[\n    {\n      \"name\":\"username\",\n      \"keywordValue\":\"tom\"\n    },\n    {\n       \"name\":\"age\",\n      \"intValue\":32\n\n    }\n\n   ]\n }\n\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":[\n    {\n      \"name\":\"login\",\n      \"dateValue\":\"2019-01-01\"\n    },\n    {\n       \"name\":\"email\",\n      \"IntValue\":32\n\n    }\n\n   ]\n }\n\n\n# Nested 查询，通过bool查询进行过滤\nPOST cookie_service/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"cookies\",\n      \"query\": {\n        \"bool\": {\n          \"filter\": [\n            {\n            \"term\": {\n              \"cookies.name\": \"age\"\n            }},\n            {\n              \"range\":{\n                \"cookies.intValue\":{\n                  \"gte\":30\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  }\n}\n\n\n\n# 在Mapping中加入元信息，便于管理\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.0\"\n    }\n  }\n}\n\nGET softwares/_mapping\nPUT softwares/_doc/1\n{\n  \"software_version\":\"7.1.0\"\n}\n\nDELETE softwares\n# 优化,使用inner object\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.1\"\n    },\n    \"properties\": {\n      \"version\": {\n        \"properties\": {\n          \"display_name\": {\n            \"type\": \"keyword\"\n          },\n          \"hot_fix\": {\n            \"type\": \"byte\"\n          },\n          \"marjor\": {\n            \"type\": \"byte\"\n          },\n          \"minor\": {\n            \"type\": \"byte\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#通过 Inner Object 写入多个文档\nPUT softwares/_doc/1\n{\n  \"version\":{\n  \"display_name\":\"7.1.0\",\n  \"marjor\":7,\n  \"minor\":1,\n  \"hot_fix\":0  \n  }\n\n}\n\nPUT softwares/_doc/2\n{\n  \"version\":{\n  \"display_name\":\"7.2.0\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":0  \n  }\n}\n\nPUT softwares/_doc/3\n{\n  \"version\":{\n  \"display_name\":\"7.2.1\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":1  \n  }\n}\n\n\n# 通过 bool 查询，\nPOST softwares/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\n          \"match\":{\n            \"version.marjor\":7\n          }\n        },\n        {\n          \"match\":{\n            \"version.minor\":2\n          }\n        }\n\n      ]\n    }\n  }\n}\n\n\n\n\n# Not Null 解决聚合的问题\nDELETE ratings\nPUT ratings\n{\n  \"mappings\": {\n      \"properties\": {\n        \"rating\": {\n          \"type\": \"float\",\n          \"null_value\": 1.0\n        }\n      }\n    }\n}\n\n\nPUT ratings/_doc/1\n{\n \"rating\":5\n}\nPUT ratings/_doc/2\n{\n \"rating\":null\n}\n\n\nPOST ratings/_search\nPOST ratings/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"avg\": {\n      \"avg\": {\n        \"field\": \"rating\"\n      }\n    }\n  }\n}\n\nPOST ratings/_search\n{\n  \"query\": {\n    \"term\": {\n      \"rating\": {\n        \"value\": 1\n      }\n    }\n  }\n}\n\n```\n\n\n\n# 7.7-第二部分总结与测验.md\n\n# 第二部分总结与测验\n```\nDELETE test\nPUT test/_doc/1\n{\n  \"content\":\"Hello World\"\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n\n\n```\n\n\n# 8.1-集群身份认证与用户鉴权.md\n\n# 集群身份认证与用户鉴权\n- 如何为集群启用X-Pack Security\n- 如何为内置用户设置密码\n- 设置 Kibana与ElasticSearch通信鉴权\n- 使用安全API创建对特定索引具有有限访问权限的用户\n\nThis tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:\n\ndiscovery.type: single-node\n\n```\n#启动单节点\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true\n\n#使用Curl访问ES，或者浏览器访问 “localhost:9200/_cat/nodes?pretty”。返回401错误\ncurl 'localhost:9200/_cat/nodes?pretty'\n\n#运行密码设定的命令，设置ES内置用户及其初始密码。\nbin/elasticsearch-setup-passwords interactive\n\ncurl -u elastic 'localhost:9200/_cat/nodes?pretty'\n\n\n# 修改 kibana.yml\nelasticsearch.username: \"kibana\"\nelasticsearch.password: \"changeme\"\n\n#启动。使用用户名，elastic，密码elastic\n./bin/kibana\n\n\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n\n\n#create a new role named read_only_orders, that satisfies the following criteria:\n#The role has no cluster privileges\n#The role only has access to indices that match the pattern sales_record\n#The index privileges are read, and view_index_metadata\n\n\n#create sales_user that satisfies the following criteria:\n# Use your own email address\n# Assign the user to two roles: read_only_orders and kibana_user\n\n\n#验证读权限,可以执行\nPOST orders/_search\n{}\n\n#验证写权限,报错\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n\n\n```\n\n# 8.2-集群内部安全通信.md\n\n#\n\n```\n# 生成证书\n# 为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：\nbin/elasticsearch-certutil ca\n\n#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：\nbin/elasticsearch-certutil cert --ca elastic-stack-ca.p12\n\n#将证书拷贝到 config/certs目录下\nelastic-certificates.p12\n\n\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12\n\nbin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12\n\n\n#不提供证书的节点，无法加入\nbin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E http.port=9202 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate\n\n\n```\n\n\n```\n## elasticsearch.yml 配置\n\n#xpack.security.transport.ssl.enabled: true\n#xpack.security.transport.ssl.verification_mode: certificate\n\n#xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12\n#xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12\n\n\n```\n\n# 8.3-集群与外部间的安全通信.md\n\n\n\n```\nxpack.security.http.ssl.enabled: true\nxpack.security.http.ssl.keystore.path: certs/elastic-certificates.p12\nxpack.security.http.ssl.truststore.path: certs/elastic-certificates.p12\n\n```\n```\n\n\n# ES 启用 https\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12\n\n```\n\n```\n#Kibana 连接 ES https\n\n\n\n# 为kibana生成pem\nopenssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem\n\n\nelasticsearch.hosts: [\"https://localhost:9200\"]\nelasticsearch.ssl.certificateAuthorities: [ \"/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem\" ]\nelasticsearch.ssl.verificationMode: certificate\n\n\n\n# 为 Kibna 配置 HTTPS\n# 生成后解压，包含了instance.crt 和 instance.key\nbin/elasticsearch-certutil ca --pem\n\nserver.ssl.enabled: true\nserver.ssl.certificate: config/certs/instance.crt\nserver.ssl.key: config/certs/instance.key\n\n\n```\n\n\n\n# 9.1-常见的集群部署方式.md\n\n# 常见的集群部署方式\n\n\n# 9.2-Hot&Warm架构与ShardFiltering.md\n\n# Hot & Warm 架构与 Shard Filtering\n## 课程代码\n```\n# 标记一个 Hot 节点\nbin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot\n\n# 标记一个 warm 节点\nbin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm\n\n# 查看节点\nGET /_cat/nodeattrs?v\n\n# 配置到 Hot节点\nPUT logs-2019-06-27\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.my_node_type\":\"hot\"\n  }\n}\n\n\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\n\nGET _cat/shards?v\n\n\n# 配置到 warm 节点\nPUT PUT logs-2019-06-27/_settings\n{  \n  \"index.routing.allocation.require.my_node_type\":\"warm\"\n}\n\n\n# 标记一个 rack 1\nbin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# 标记一个 rack 2\nbin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\"\n  }\n}\n\nPUT my_index1\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1\n  }\n}\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\nGET _cat/shards?v\nDELETE my_index1/_doc/1\n\n\n\n# Fore awareness\n# 标记一个 rack 1\nbin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# 标记一个 rack 2\nbin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1\n\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\",\n    \"cluster.routing.allocation.awareness.force.my_rack_id.values\": \"rack1,rack2\"\n  }\n}\nGET _cluster/settings\n\n# 集群黄色\nGET _cluster/health\n\n# 副本无法分配\nGET _cat/shards?v\n\n\nGET _cluster/allocation/explain?pretty\n```\n# 9.3-如何对集群进行容量规划.md\n\n# 如何对集群进行容量规划\n## 代码Demo\n\n```\nPUT logs_2019-06-27\nPUT logs_2019-06-26\n\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"logs_2019-06-27\",\n        \"alias\": \"logs_write\"\n      }\n    },\n    {\n      \"remove\": {\n        \"index\": \"logs_2019-06-26\",\n        \"alias\": \"logs_write\"\n      }\n    }\n  ]\n}\n\n\n# POST /<logs-{now/d}/_search\nPOST /%3Clogs-%7Bnow%2Fd%7D%3E/_search\n\n# POST /<logs-{now/w}/_search\nPOST /%3Clogs-%7Bnow%2Fw%7D%3E/_search\n\n```\n\n# 9.4-分片设计及管理.md\n\n# 分片设计及管理\n\n# 9.5-在私有云上管理与部署Elasticsearch集群.md\n\n# 在私有云上管理与部署 Elasticsearch 集群\n\n# 9.6-在公有云上管理与部署Elasticsearch集群.md\n\n# 在公有云上管理与部署 Elasticsearch 集群\n\n# result.md\n\n# 10.1-生产环境常用配置与上线清单.md\n\n# 生产环境查用配置与线上清单\n\n# 10.10-一些运维相关的建议.md\n\n# 一些运维相关的建议\n```\n# 移动一个分片从一个节点到另外一个节点\n\nPOST _cluster/reroute\n{\n  \"commands\": [\n    {\n      \"move\": {\n        \"index\": \"index_name\",\n        \"shard\": 0,\n        \"from_node\": \"node_name_1\",\n        \"to_node\": \"node_name_2\"\n      }\n    }\n  ]\n}\n\n\n# Fore the allocation of an unassinged shard with a reason\n\nPOST _cluster/reroute?explain\n{\n  \"commands\": [\n    {\n      \"allocate\": {\n        \"index\": \"index_name\",\n        \"shard\": 0,\n        \"node\": \"nodename\"\n      }\n    }\n  ]\n}\n\n\n# remove the nodes from cluster \nPUT _cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.exclude._ip\":\"the_IP_of_your_node\"\n  }\n}\n\n# Force a synced flush\nPOST _flush/synced\n\n\n# change the number of moving shards to balance the cluster\nPUT /_cluster/settings\n{\n  \"transient\": {\"cluster.routing.allocation.cluster_concurrent_rebalance\":2}\n}\n\n# change the number of shards being recovered simultanceously per node\nPUT _cluster/settings\n{\n  \"transient\": {\"cluster.routing.allocation.node_concurrent_recoveries\":5}\n}\n\n# Change the recovery speed\nPUT /_cluster/settings\n{\n  \"transient\": {\"indices.recovery.max_bytes_per_sec\": \"80mb\"}\n}\n\n# Change the number of concurrent streams for a recovery on a single node\nPUT _cluster/settings\n{\n  \"transient\": {\"indices.recovery.concurrent_streams\":6}\n}\n\n\n# Change the sinze of the search queue\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"threadpool.search.queue_size\":2000\n  }\n}\n\n# Clear the cache on a node\nPOST _cache/clear\n\n\n#Adjust the circuit breakers\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.breaker.total.limit\":\"40%\"\n  }\n}\n\n\n```\n\n# 10.2-监控Elasticsearch集群.md\n\n# 监控 Elasticsearch 集群\n```\n# Node Stats：\nGET _nodes/stats\n\n#Cluster Stats:\nGET _cluster/stats\n\n#Index Stats:\nGET kibana_sample_data_ecommerce/_stats\n\n#Pending Cluster Tasks API:\nGET _cluster/pending_tasks\n\n# 查看所有的 tasks，也支持 cancel task\nGET _tasks\n\n\nGET _nodes/thread_pool\nGET _nodes/stats/thread_pool\nGET _cat/thread_pool?v\nGET _nodes/hot_threads\nGET _nodes/stats/thread_pool\n\n\n# 设置 Index Slowlogs\n# the first 1000 characters of the doc's source will be logged\nPUT my_index/_settings\n{\n  \"index.indexing.slowlog\":{\n    \"threshold.index\":{\n      \"warn\":\"10s\",\n      \"info\": \"4s\",\n      \"debug\":\"2s\",\n      \"trace\":\"0s\"\n    },\n    \"level\":\"trace\",\n    \"source\":1000  \n  }\n}\n\n# 设置查询\nDELETE my_index\n//\"0\" logs all queries\nPUT my_index/\n{\n  \"settings\": {\n    \"index.search.slowlog.threshold\": {\n      \"query.warn\": \"10s\",\n      \"query.info\": \"3s\",\n      \"query.debug\": \"2s\",\n      \"query.trace\": \"0s\",\n      \"fetch.warn\": \"1s\",\n      \"fetch.info\": \"600ms\",\n      \"fetch.debug\": \"400ms\",\n      \"fetch.trace\": \"0s\"\n    }\n  }\n}\n\nGET my_index\n\n\n```\n\n# 10.3-诊断集群的潜在问题.md\n\n# 诊断集群的潜在问题\n# 10.4-解决集群Yellow与Red的问题.md\n\n# 集群健康与问题排查\n```\n#案例1\nDELETE mytest\nPUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":3,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.box_type\":\"hott\"\n  }\n}\n\n\n\n\n\n# 检查集群状态，查看是否有节点丢失，有多少分片无法分配\nGET /_cluster/health/\n\n# 查看索引级别,找到红色的索引\nGET /_cluster/health?level=indices\n\n\n#查看索引的分片\nGET _cluster/health?level=shards\n\n# Explain 变红的原因\nGET /_cluster/allocation/explain\n\nGET /_cat/shards/mytest\nGET _cat/nodeattrs\n\nDELETE mytest\nGET /_cluster/health/\n\nPUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":3,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.box_type\":\"hot\"\n  }\n}\n\nGET /_cluster/health/\n\n#案例2, Explain 看 hot 上的 explain\nDELETE mytest\nPUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1,\n    \"index.routing.allocation.require.box_type\":\"hot\"\n  }\n}\n\nGET _cluster/health\nGET _cat/shards/mytest\nGET /_cluster/allocation/explain\n\nPUT mytest/_settings\n{\n    \"number_of_replicas\": 0\n}\n\n```\n\n# 10.5-提升集群写性能.md\n\n# 提升集群写性能\n```\nDELETE myindex\nPUT myindex\n{\n  \"settings\": {\n    \"index\": {\n      \"refresh_interval\": \"30s\",\n      \"number_of_shards\": \"2\"\n    },\n    \"routing\": {\n      \"allocation\": {\n        \"total_shards_per_node\": \"3\"\n      }\n    },\n    \"translog\": {\n      \"sync_interval\": \"30s\",\n      \"durability\": \"async\"\n    },\n    \"number_of_replicas\": 0\n  },\n  \"mappings\": {\n    \"dynamic\": false,\n    \"properties\": {}\n  }\n}\n```\n\n# 10.6-提升集群读性能.md\n\n# 提升集群读性能\n```\nPUT blogs/_doc/1\n{\n  \"title\":\"elasticsearch\"\n}\nGET blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\n          \"title\": \"elasticsearch\"\n        }}\n      ],\n      \n      \"filter\": {\n        \"script\": {\n          \"script\": {\n            \"source\": \"doc['title.keyword'].value.length()>5\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nGET blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"elasticsearch\"}},\n        {\n          \"range\": {\n            \"publish_date\": {\n              \"gte\": 2017,\n              \"lte\": 2019\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\n# 10.7-集群压力测试.md\n\n# 集群压力测试\n```\npip3 install esrally\n\nesrally configure\n\n# 只测试 1000条数据\nesrally --distribution-version=7.1.0 --test-mode\n\n# 测试完整数据\nesrally --distribution-version=7.1.0\n\n```\n- https://github.com/elastic/rally-tracks\n- https://logz.io/blog/rally/\n\n\n# 10.9-缓存及使用Breaker限制内存使用.md\n\n# 缓存及使用Circuit Breaker限制内存使用\n```\nGET _cat/nodes?v\n\nGET _nodes/stats/indices?pretty\n\nGET _cat/nodes?v&h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count\n\nGET _cat/nodes?h=name,port,segments.memory,segments.index_writer_memory,fielddata.memory_size,query_cache.memory_size,request_cache.memory_size&v\n\n\nPUT /_cluster/settings\n{\n    \"persistent\" : {\n       \"indices.breaker.request.limit\" : \"90%\"\n    }\n}\n\n```\n## 补充阅读\n- https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker\n\n\n# 11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md\n\n# 使用 shrink与rolloverAPI有效的管理索引\n```\n\n\n# 打开关闭索引\nDELETE test\n#查看索引是否存在\nHEAD test\n\nPUT test/_doc/1\n{\n  \"key\":\"value\"\n}\n\n#关闭索引\nPOST /test/_close\n#索引存在\nHEAD test\n# 无法查询\nPOST test/_count\n\n#打开索引\nPOST /test/_open\nPOST test/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\nPOST test/_count\n\n\n# 在一个 hot-warm-cold的集群上进行测试\nGET _cat/nodes\nGET _cat/nodeattrs\n\nDELETE my_source_index\nDELETE my_target_index\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\nGET _cat/shards/my_source_index\n\n# 分片数3，会失败\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 3,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\n\n\n# 报错，因为没有置成 readonly\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\n#将 my_source_index 设置为只读\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n# 报错，必须都在一个节点\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\nDELETE my_source_index\n## 确保分片都在 hot\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0,\n   \"index.routing.allocation.include.box_type\":\"hot\"\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\nGET _cat/shards/my_source_index\n\n#设置为只读\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\n\nGET _cat/shards/my_target_index\n\n# My target_index状态为也只读\nPUT my_target_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\n\n# Split Index\nDELETE my_source_index\nDELETE my_target_index\n\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\nGET _cat/shards/my_source_index\n\n# 必须是倍数\nPOST my_source_index/_split/my_target\n{\n  \"settings\": {\n    \"index.number_of_shards\": 10\n  }\n}\n\n# 必须是只读\nPOST my_source_index/_split/my_target\n{\n  \"settings\": {\n    \"index.number_of_shards\": 8\n  }\n}\n\n\n#设置为只读\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n\nPOST my_source_index/_split/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_shards\": 8,\n    \"index.number_of_replicas\":0\n  }\n}\n\nGET _cat/shards/my_target_index\n\n\n\n# write block\nPUT my_target_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\n\n#Rollover API\nDELETE nginx-logs*\n# 不设定 is_write_true\n# 名字符合命名规范\nPUT /nginx-logs-000001\n{\n  \"aliases\": {\n    \"nginx_logs_write\": {}\n  }\n}\n\n# 多次写入文档\nPOST nginx_logs_write/_doc\n{\n  \"log\":\"something\"\n}\n\n\nPOST /nginx_logs_write/_rollover\n{\n  \"conditions\": {\n    \"max_age\":   \"1d\",\n    \"max_docs\":  5,\n    \"max_size\":  \"5gb\"\n  }\n}\n\nGET /nginx_logs_write/_count\n# 查看 Alias信息\nGET /nginx_logs_write\n\n\nDELETE apache-logs*\n\n\n# 设置 is_write_index\nPUT apache-logs1\n{\n  \"aliases\": {\n    \"apache_logs\": {\n      \"is_write_index\":true\n    }\n  }\n}\nPOST apache_logs/_count\n\nPOST apache_logs/_doc\n{\n  \"key\":\"value\"\n}\n\n# 需要指定 target 的名字\nPOST /apache_logs/_rollover/apache-logs8xxxx\n{\n  \"conditions\": {\n    \"max_age\":   \"1d\",\n    \"max_docs\":  1,\n    \"max_size\":  \"5gb\"\n  }\n}\n\n\n# 查看 Alias信息\nGET /apache_logs\n\n\n```\n\n# 11.2-索引全生命周期管理及工具介绍.md\n\n# 索引全生命周期管理及工具介绍\n```\n\n# 运行三个节点，分片 将box_type设置成 hot，warm和cold\n# 具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件\n\n\n\nDELETE *\n\n\n\n# 设置 1秒刷新1次，生产环境10分种刷新一次\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.lifecycle.poll_interval\":\"1s\"\n  }\n}\n\n# 设置 Policy\nPUT /_ilm/policy/log_ilm_policy\n{\n  \"policy\": {\n    \"phases\": {\n      \"hot\": {\n        \"actions\": {\n          \"rollover\": {\n            \"max_docs\": 5\n          }\n        }\n      },\n      \"warm\": {\n        \"min_age\": \"10s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"warm\"\n            }\n          }\n        }\n      },\n      \"cold\": {\n        \"min_age\": \"15s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"cold\"\n            }\n          }\n        }\n      },\n      \"delete\": {\n        \"min_age\": \"20s\",\n        \"actions\": {\n          \"delete\": {}\n        }\n      }\n    }\n  }\n}\n\n\n\n# 设置索引模版\nPUT /_template/log_ilm_template\n{\n  \"index_patterns\" : [\n      \"ilm_index-*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"lifecycle\" : {\n          \"name\" : \"log_ilm_policy\",\n          \"rollover_alias\" : \"ilm_alias\"\n        },\n        \"routing\" : {\n          \"allocation\" : {\n            \"include\" : {\n              \"box_type\" : \"hot\"\n            }\n          }\n        },\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"0\"\n      }\n    },\n    \"mappings\" : { },\n    \"aliases\" : { }\n}\n\n\n\n#创建索引\nPUT ilm_index-000001\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0,\n    \"index.lifecycle.name\": \"log_ilm_policy\",\n    \"index.lifecycle.rollover_alias\": \"ilm_alias\",\n    \"index.routing.allocation.include.box_type\":\"hot\"\n  },\n  \"aliases\": {\n    \"ilm_alias\": {\n      \"is_write_index\": true\n    }\n  }\n}\n\n# 对 Alias写入文档\nPOST  ilm_alias/_doc\n{\n  \"dfd\":\"dfdsf\"\n}\n\n```\n\n# 12.1-Logstash入门及架构介绍.md\n\n# Logstash 入门及架构介绍\n```\n\n\n# 一个 Demo， demo 运行\nsudo bin/logstash -f logstash-filter.conf\n\n# demo数据\n127.0.0.1 - - [11/Dec/2013:00:01:45 -0800] \"GET /xampp/status.php HTTP/1.1\" 200 3891 \"http://cadenza/xampp/navi.php\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0\"\n\n\n# codec demo\n\n\nsudo bin/logstash -e \"input{stdin{codec=>line}}output{stdout{codec=> rubydebug}}\"\nsudo bin/logstash -e \"input{stdin{codec=>json}}output{stdout{codec=> rubydebug}}\"\nsudo bin/logstash -e \"input{stdin{codec=>line}}output{stdout{codec=> dots}}\"\n\n\nsudo bin/logstash -f multiline-exception.conf\n\n# 多行数据，异常\nException in thread \"main\" java.lang.NullPointerException\n        at com.example.myproject.Book.getTitle(Book.java:16)\n        at com.example.myproject.Author.getBookTitles(Author.java:25)\n        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\n\n\n\n# 一个实例\nhttps://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf\n\n```\n\n\n# 12.2-利用JDBC插件导入数据到Elasticsearch.md\n\n# Logstash插件及文档介绍\n```\nhttps://spring.io/guides/gs/accessing-data-mysql/\ncreate database db_example;\nuse db_example;\nshow tables;\ndrop table user;\nselect * from user;\n\n\n\n# 新增用户\ncurl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ\ncurl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ\ncurl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ\n\n#查看所有的用户\ncurl 'localhost:8080/demo/all'\n\n# 更新用户\ncurl -X PUT localhost:8080/demo/update -d id=16 -d name=Bob2 -d email=bob2@xyz.com -d tags=Mysql,IntelliJ\n\n# 删除用户\ncurl -X DELETE localhost:8080/demo/delete -d id=15\n\n\n\nmysql-demo.conf\n\n# 创建 alias，只显示没有被标记 deleted的用户\nPOST /_aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"users\",\n        \"alias\": \"view_users\",\n         \"filter\" : { \"term\" : { \"is_deleted\" : false } }\n      }\n    }\n  ]\n}\n\n# 通过 Alias查询，查不到被标记成 deleted的用户\nPOST view_users/_search\n{\n\n}\n\n\nPOST view_users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"Jack\"\n      }\n    }\n  }\n}\n\nPOST users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"Jack\"\n      }\n    }\n  }\n}\n\n```\n\n\n# 12.3-Beats介绍.md\n\n# Beats介绍\n```\n\n##\n# 查看 packetbeat 模块\n# 设置 packetbeat 的mysql 模块\n# 启动运行\n#\n./metricbeat modules list\n./metricbeat modules enable mysql\n./metricbeat setup --dashboards\n\n# 安装mysql\ncreate database db_example\nuse db_example;\nshow tables;\nselect * from user\n\ncurl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ\ncurl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ\ncurl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ\n\ncurl 'localhost:8080/demo/all'\n\n\n# 配置 packetbeat\n# 启动\n修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控\n\nsudo chown root packetbeat.yml\nsudo ./packetbeat setup --dashboards\nsudo ./packetbeat\n\n\n# 查看所有 Filebeat 模块\n# 查看所有的modules\n./filebeat modules list\n\n#\n./filebeat modules enable mysql\n\n```\n\n\n# 13.1-使用IndexPattern配置数据.md\n\n\n```\n\nlocalhost:5601/status\n\n\n\n\nPUT /logstash-2015.05.18\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\nPUT /logstash-2015.05.19\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /logstash-2015.05.20\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n# For Mac & Windows\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/_bulk?pretty' --data-binary @logs.jsonl\n\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\n\n\n#For Windows\nInvoke-RestMethod \"http://localhost:9200/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"logs.jsonl\"\n\n\n\nGET /_cat/indices?v\n\n```\n\n\n# 13.2-使用KibanaDiscover探索数据.md\n\n# 使用Kibana Discovery 探索数据\n```\n\n设置时间过滤器\n搜索你的数据\n根据字段进行过滤\n查看文档数据\n查看文档上下文\n暂时字段数据统计\nSave Query\n\n\n```\n\n\n# 13.3-基本可视化组件介绍.md\n\n# 基本可视化组件介绍\n```\n\nPUT /shakespeare\n{\n  \"mappings\": {\n    \"properties\": {\n    \"speaker\": {\"type\": \"keyword\"},\n    \"play_name\": {\"type\": \"keyword\"},\n    \"line_id\": {\"type\": \"integer\"},\n    \"speech_number\": {\"type\": \"integer\"}\n    }\n  }\n}\n\n\n# For Mac & Windows\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/shakespeare/_bulk?pretty' --data-binary @shakespeare.json\n\n#For Windows\nInvoke-RestMethod \"http://localhost:9200/bank/account/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"accounts.json\"\nInvoke-RestMethod \"http://localhost:9200/shakespeare/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"shakespeare.json\"\n\n\n```\n\n\n# 13.4-构建Dashboard.md\n\n# 构建Dashboard\n```\n- 创建仪表潘\n- 加载仪表盘\n- 共享仪表盘\n\n```\n\n\n# 14.3用机器学习实现时序数据的异常检测-上.md\n\nmkdir server_metrics\ncd server_metrics\nwget https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz\ntar -xvf server_metrics.tar.gz\n\n\n# 14.5-用ELK进行日志管理.md\n\n# 用 ELK 来做日志管理\n```\n./filebeat modules list\n./filebeat modules enable system\n./filebeat modules enable elasticsearch\n\n\n## 进 modules.d 编辑相应的文件，修改log路径\n\n./filebeat setup –dashboards\n\n./filebeat export template | more\n\n./filebeat -e\n\n```\n\n# 14.6-用Canvas做数据演示.md\n\nPOST elasticoffee/_search\n{\n  \"size\": 0, \n  \"aggs\": {\n    \"by\": {\n      \"terms\": {\n        \"field\": \"beverage.keyword\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n# 4.1-基于词项和基于全文的搜索.md\n\n# 基于词项和基于全文的搜索\n\n\n```\nDELETE products\nPUT products\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  }\n}\n\n\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"productID\" : \"XHDK-A-1293-#fJ3\",\"desc\":\"iPhone\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"productID\" : \"KDKE-B-9947-#kL5\",\"desc\":\"iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"productID\" : \"JODL-X-1937-#pV7\",\"desc\":\"MBP\" }\n\nGET /products\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": {\n        //\"value\": \"iPhone\"\n        \"value\":\"iphone\"\n      }\n    }\n  }\n}\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc.keyword\": {\n        //\"value\": \"iPhone\"\n        //\"value\":\"iphone\"\n      }\n    }\n  }\n}\n\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n\nPOST /products/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n\n\n\n\nPOST /products/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n\n    }\n  }\n}\n\n\n#设置 position_increment_gap\nDELETE groups\nPUT groups\n{\n  \"mappings\": {\n    \"properties\": {\n      \"names\":{\n        \"type\": \"text\",\n        \"position_increment_gap\": 0\n      }\n    }\n  }\n}\n\nGET groups/_mapping\n\nPOST groups/_doc\n{\n  \"names\": [ \"John Water\", \"Water Smith\"]\n}\n\nPOST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": {\n        \"query\": \"Water Water\",\n        \"slop\": 100\n      }\n    }\n  }\n}\n\n\nPOST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": \"Water Smith\"\n    }\n  }\n}\n```\n\n# 4.10-综合排序：Function Score Query 优化算分.md\n\n# 综合排序：Function Score Query 优化算分\n```\nDELETE blogs\nPUT /blogs/_doc/1\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   0\n}\n\nPUT /blogs/_doc/2\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   100\n}\n\nPUT /blogs/_doc/3\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   1000000\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\"\n      }\n    }\n  }\n}\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\"\n      }\n    }\n  }\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      }\n    }\n  }\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      },\n      \"boost_mode\": \"sum\",\n      \"max_boost\": 3\n    }\n  }\n}\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"random_score\": {\n        \"seed\": 911119\n      }\n    }\n  }\n}\n```\n\n# 4.12-自动补全与基于上下文的提示.md\n\n# 自动补全与基于上下文的提示\n```\nDELETE articles\nPUT articles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title_completion\":{\n        \"type\": \"completion\"\n      }\n    }\n  }\n}\n\nPOST articles/_bulk\n{ \"index\" : { } }\n{ \"title_completion\": \"lucene is very cool\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch builds on top of lucene\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch rocks\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"elastic is the company behind ELK stack\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elk stack rocks\"}\n{ \"index\" : {} }\n\n\nPOST articles/_search?pretty\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"article-suggester\": {\n      \"prefix\": \"elk \",\n      \"completion\": {\n        \"field\": \"title_completion\"\n      }\n    }\n  }\n}\n\n\nDELETE comments\nPUT comments\nPUT comments/_mapping\n{\n  \"properties\": {\n    \"comment_autocomplete\":{\n      \"type\": \"completion\",\n      \"contexts\":[{\n        \"type\":\"category\",\n        \"name\":\"comment_category\"\n      }]\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"I love the star war movies\",\n  \"comment_autocomplete\":{\n    \"input\":[\"star wars\"],\n    \"contexts\":{\n      \"comment_category\":\"movies\"\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"Where can I find a Starbucks\",\n  \"comment_autocomplete\":{\n    \"input\":[\"starbucks\"],\n    \"contexts\":{\n      \"comment_category\":\"coffee\"\n    }\n  }\n}\n\n\nPOST comments/_search\n{\n  \"suggest\": {\n    \"MY_SUGGESTION\": {\n      \"prefix\": \"sta\",\n      \"completion\":{\n        \"field\":\"comment_autocomplete\",\n        \"contexts\":{\n          \"comment_category\":\"coffee\"\n        }\n      }\n    }\n  }\n}\n```\n\n\n# 4.13-跨集群搜索.md\n\n# 跨集群搜索\n```\n//启动3个集群\n\nbin/elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300\nbin/elasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301\nbin/elasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302\n\n\n//在每个集群上设置动态的设置\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster\": {\n      \"remote\": {\n        \"cluster0\": {\n          \"seeds\": [\n            \"127.0.0.1:9300\"\n          ],\n          \"transport.ping_schedule\": \"30s\"\n        },\n        \"cluster1\": {\n          \"seeds\": [\n            \"127.0.0.1:9301\"\n          ],\n          \"transport.compress\": true,\n          \"skip_unavailable\": true\n        },\n        \"cluster2\": {\n          \"seeds\": [\n            \"127.0.0.1:9302\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n#cURL\ncurl -XPUT \"http://localhost:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9201/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9202/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\n\n#创建测试数据\ncurl -XPOST \"http://localhost:9200/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user1\",\"age\":10}'\n\ncurl -XPOST \"http://localhost:9201/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user2\",\"age\":20}'\n\ncurl -XPOST \"http://localhost:9202/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user3\",\"age\":30}'\n\n\n#查询\nGET /users,cluster1:users,cluster2:users/_search\n{\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20,\n        \"lte\": 40\n      }\n    }\n  }\n}\n\n```\n\n\n# 4.2-结构化搜索.md\n\n# 结构化搜索\n\n```\n\n#结构化搜索，精确匹配\nDELETE products\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\nGET products/_mapping\n\n\n\n#对布尔值 match 查询，有算分\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"avaliable\": true\n    }\n  }\n}\n\n\n\n#对布尔值，通过constant score 转成 filtering，没有算分\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": true\n        }\n      }\n    }\n  }\n}\n\n\n#数字类型 Term\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": 30\n    }\n  }\n}\n\n#数字类型 terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"price\": [\n            \"20\",\n            \"30\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n#数字 Range 查询\nGET products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"price\" : {\n                        \"gte\" : 20,\n                        \"lte\"  : 30\n                    }\n                }\n            }\n        }\n    }\n}\n\n\n# 日期 range\nPOST products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"date\" : {\n                      \"gte\" : \"now-1y\"\n                    }\n                }\n            }\n        }\n    }\n}\n\n\n\n#exists查询\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"exists\": {\n          \"field\": \"date\"\n        }\n      }\n    }\n  }\n}\n\n#处理多值字段\nPOST /movies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\"}\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"] }\n\n\n#处理多值字段，term 查询是包含，而不是等于\nPOST movies/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"genre.keyword\": \"Comedy\"\n        }\n      }\n    }\n  }\n}\n\n\n#字符类型 terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"productID.keyword\": [\n            \"QQPX-R-3956-#aD8\",\n            \"JODL-X-1937-#pV7\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": 30\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\n\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n    }\n  }\n}\n\n#对布尔数值\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": \"false\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"avaliable\": {\n        \"value\": \"false\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": {\n        \"value\": \"20\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": \"20\"\n    }\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"bool\": {\n          \"must_not\": {\n            \"exists\": {\n              \"field\": \"date\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\n```\n\n# 4.3-搜索的相关性算分.md\n\n# 搜索的相关性算分\n\n```\n\n\nPUT testscore\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      }\n    }\n  }\n}\n\n\nPUT testscore/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"we use Elasticsearch to power the search\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"we like elasticsearch\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"The scoring of documents is caculated by the scoring formula\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"content\":\"you know, for search\" }\n\n\n\nPOST /testscore/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"content\":\"you\"\n      //\"content\": \"elasticsearch\"\n      //\"content\":\"the\"\n      //\"content\": \"the elasticsearch\"\n    }\n  }\n}\n\nPOST testscore/_search\n{\n    \"query\": {\n        \"boosting\" : {\n            \"positive\" : {\n                \"term\" : {\n                    \"content\" : \"elasticsearch\"\n                }\n            },\n            \"negative\" : {\n                 \"term\" : {\n                     \"content\" : \"like\"\n                }\n            },\n            \"negative_boost\" : 0.2\n        }\n    }\n}\n\n\nPOST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"more_like_this\": {\n      \"fields\": [\n        \"title^10\",\"overview\"\n      ],\n      \"like\": [{\"_id\":\"14191\"}],\n      \"min_term_freq\": 1,\n      \"max_query_terms\": 12\n    }\n  }\n}\n\n\n\n```\n\n\n# 4.4-Query&Filtering实现多字符串多字段查询.md\n\n# Query & Filtering 与多字符串多字段查询\n\n```\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\n\n\n#基本语法\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :1\n    }\n  }\n}\n\n#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题\nPOST /newmovies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\",\"genre_count\":1 }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"],\"genre_count\":2 }\n\n#must，有算分\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n\n      ]\n    }\n  }\n}\n\n#Filter。不参与算分，结果的score是0\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n        ]\n\n    }\n  }\n}\n\n\n#Filtering Context\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      }\n    }\n  }\n}\n\n\n#Query Context\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\n\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"term\": {\n            \"productID.keyword\": {\n              \"value\": \"JODL-X-1937-#pV7\"}}\n        },\n        {\"term\": {\"avaliable\": {\"value\": true}}\n        }\n      ]\n    }\n  }\n}\n\n\n#嵌套，实现了 should not 逻辑\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\": {\n          \"price\": \"30\"\n        }\n      },\n      \"should\": [\n        {\n          \"bool\": {\n            \"must_not\": {\n              \"term\": {\n                \"avaliable\": \"false\"\n              }\n            }\n          }\n        }\n      ],\n      \"minimum_should_match\": 1\n    }\n  }\n}\n\n\n#Controll the Precision\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :2\n    }\n  }\n}\n\n\n\nPOST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"brown\" }},\n        { \"term\": { \"text\": \"red\" }},\n        { \"term\": { \"text\": \"quick\"   }},\n        { \"term\": { \"text\": \"dog\"   }}\n      ]\n    }\n  }\n}\n\nPOST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"quick\" }},\n        { \"term\": { \"text\": \"dog\"   }},\n        {\n          \"bool\":{\n            \"should\":[\n               { \"term\": { \"text\": \"brown\" }},\n                 { \"term\": { \"text\": \"brown\" }},\n            ]\n          }\n\n        }\n      ]\n    }\n  }\n}\n\n\nDELETE blogs\nPOST /blogs/_bulk\n{ \"index\": { \"_id\": 1 }}\n{\"title\":\"Apple iPad\", \"content\":\"Apple iPad,Apple iPad\" }\n{ \"index\": { \"_id\": 2 }}\n{\"title\":\"Apple iPad,Apple iPad\", \"content\":\"Apple iPad\" }\n\n\nPOST blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\"match\": {\n          \"title\": {\n            \"query\": \"apple,ipad\",\n            \"boost\": 1.1\n          }\n        }},\n\n        {\"match\": {\n          \"content\": {\n            \"query\": \"apple,ipad\",\n            \"boost\":\n          }\n        }}\n      ]\n    }\n  }\n}\n\nDELETE news\nPOST /news/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"Apple Mac\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"Apple iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"Apple employee like Apple Pie and Apple Juice\" }\n\n\nPOST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      }\n    }\n  }\n}\n\nPOST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      },\n      \"must_not\": {\n        \"match\":{\"content\":\"pie\"}\n      }\n    }\n  }\n}\n\nPOST news/_search\n{\n  \"query\": {\n    \"boosting\": {\n      \"positive\": {\n        \"match\": {\n          \"content\": \"apple\"\n        }\n      },\n      \"negative\": {\n        \"match\": {\n          \"content\": \"pie\"\n        }\n      },\n      \"negative_boost\": 0.5\n    }\n  }\n}\n\n```\n\n# 4.5-单字符串多字段查询-DisMaxQuery.md\n\n# 单字符串多字段查询：Dis Max Query\n```\n\nPUT /blogs/_doc/1\n{\n    \"title\": \"Quick brown rabbits\",\n    \"body\":  \"Brown rabbits are commonly seen.\"\n}\n\nPUT /blogs/_doc/2\n{\n    \"title\": \"Keeping pets healthy\",\n    \"body\":  \"My quick brown fox eats rabbits on a regular basis.\"\n}\n\nPOST /blogs/_search\n{\n    \"query\": {\n        \"bool\": {\n            \"should\": [\n                { \"match\": { \"title\": \"Brown fox\" }},\n                { \"match\": { \"body\":  \"Brown fox\" }}\n            ]\n        }\n    }\n}\n\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ]\n        }\n    }\n}\n\n\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n\n\n```\n\n# 4.6-单字符串多字段查询-Multi-Match.md\n\n# 单字符串多字段查询：Multi Match\n```\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n\nPOST blogs/_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\": \"best_fields\",\n      \"query\": \"Quick pets\",\n      \"fields\": [\"title\",\"body\"],\n      \"tie_breaker\": 0.2,\n      \"minimum_should_match\": \"20%\"\n    }\n  }\n}\n\n\n\nPOST books/_search\n{\n    \"multi_match\": {\n        \"query\":  \"Quick brown fox\",\n        \"fields\": \"*_title\"\n    }\n}\n\n\nPOST books/_search\n{\n    \"multi_match\": {\n        \"query\":  \"Quick brown fox\",\n        \"fields\": [ \"*_title\", \"chapter_title^2\" ]\n    }\n}\n\n\n\nDELETE /titles\nPUT /titles\n{\n    \"settings\": { \"number_of_shards\": 1 },\n    \"mappings\": {\n        \"my_type\": {\n            \"properties\": {\n                \"title\": {\n                    \"type\":     \"string\",\n                    \"analyzer\": \"english\",\n                    \"fields\": {\n                        \"std\":   {\n                            \"type\":     \"string\",\n                            \"analyzer\": \"standard\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\"\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n\n\nGET titles/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"barking dogs\"\n    }\n  }\n}\n\nDELETE /titles\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\",\n        \"fields\": {\"std\": {\"type\": \"text\",\"analyzer\": \"standard\"}}\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n\nGET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title\", \"title.std\" ]\n        }\n    }\n}\n\nGET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title^10\", \"title.std\" ]\n        }\n    }\n}\n\n```\n\n# 4.7-多语言及中文分词与检索.md\n\n# 多语言及中文分词与检索\n\n- 来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”\n\n- 你也想犯范范玮琪犯过的错吗\n- 校长说衣服上除了校徽别别别的\n- 这几天天天天气不好\n- 我背有点驼，麻麻说“你的背得背背背背佳\n\n```\n#stop word\n\nDELETE my_index\nPUT /my_index/_doc/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/_doc/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\n\nPOST my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"not happy fox\"\n    }\n  }\n}\n\n\n#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 `english`（英语）分析器，另一次使用 `standard`（标准）分析器:\n\nDELETE my_index\n\nPUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"analyzer\": \"english\"\n        }\n      }\n    }\n  }\n}\n\nPUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"fields\": {\n            \"english\": {\n              \"type\":     \"string\",\n              \"analyzer\": \"english\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /my_index/blog/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/blog/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\nGET /_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\":     \"most_fields\",\n      \"query\":    \"not happy foxes\",\n      \"fields\": [ \"title\", \"title.english\" ]\n    }\n  }\n}\n\n\n#安装插件\n./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip\n#安装插件\nbin/elasticsearch install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip\n\n\n\n\n#ik_max_word\n#ik_smart\n#hanlp: hanlp默认分词\n#hanlp_standard: 标准分词\n#hanlp_index: 索引分词\n#hanlp_nlp: NLP分词\n#hanlp_n_short: N-最短路分词\n#hanlp_dijkstra: 最短路分词\n#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）\n#hanlp_speed: 极速词典分词\n\nPOST _analyze\n{\n  \"analyzer\": \"hanlp_standard\",\n  \"text\": [\"剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜\"]\n\n}     \n\n#Pinyin\nPUT /artists/\n{\n    \"settings\" : {\n        \"analysis\" : {\n            \"analyzer\" : {\n                \"user_name_analyzer\" : {\n                    \"tokenizer\" : \"whitespace\",\n                    \"filter\" : \"pinyin_first_letter_and_full_pinyin_filter\"\n                }\n            },\n            \"filter\" : {\n                \"pinyin_first_letter_and_full_pinyin_filter\" : {\n                    \"type\" : \"pinyin\",\n                    \"keep_first_letter\" : true,\n                    \"keep_full_pinyin\" : false,\n                    \"keep_none_chinese\" : true,\n                    \"keep_original\" : false,\n                    \"limit_first_letter_length\" : 16,\n                    \"lowercase\" : true,\n                    \"trim_whitespace\" : true,\n                    \"keep_none_chinese_in_first_letter\" : true\n                }\n            }\n        }\n    }\n}\n\n\nGET /artists/_analyze\n{\n  \"text\": [\"刘德华 张学友 郭富城 黎明 四大天王\"],\n  \"analyzer\": \"user_name_analyzer\"\n}\n\n\n```\n\n## 相关资源\n- Elasticsearch IK分词插件 https://github.com/medcl/elasticsearch-analysis-ik/releases\n- Elasticsearch hanlp 分词插件 https://github.com/KennFalcon/elasticsearch-analysis-hanlp\n\n- 分词算法综述 https://zhuanlan.zhihu.com/p/50444885\n\n### 一些分词工具，供参考：\n- 中科院计算所NLPIR http://ictclas.nlpir.org/nlpir/\n- ansj分词器 https://github.com/NLPchina/ansj_seg\n- 哈工大的LTP https://github.com/HIT-SCIR/ltp\n- 清华大学THULAC https://github.com/thunlp/THULAC\n- 斯坦福分词器 https://nlp.stanford.edu/software/segmenter.shtml\n- Hanlp分词器 https://github.com/hankcs/HanLP\n- 结巴分词 https://github.com/yanyiwu/cppjieba\n- KCWS分词器(字嵌入+Bi-LSTM+CRF) https://github.com/koth/kcws\n- ZPar https://github.com/frcchang/zpar/releases\n- IKAnalyzer https://github.com/wks/ik-analyzer\n\n\n# 4.8-SpaceJam一个全文搜索的实例.md\n\n# Space Jam，一次全文搜索的实例\n\n## 环境要求\n- Python 2.7.15\n- 可以使用pyenv管理多个python版本（可选）\n\n## 进入 tmdb-search目录\nRun\npip install -r requirements.txt\nRun python ./ingest_tmdb_from_file.py\n```\nPOST tmdb/_search\n{\n\"_source\": [\"title\",\"overview\"],\n \"query\": {\n   \"match_all\": {}\n }\n}\n\nPOST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"multi_match\": {\n      \"query\": \"basketball with cartoon aliens\",\n      \"fields\": [\"title\",\"overview\"]\n    }\n  },\n  \"highlight\" : {\n        \"fields\" : {\n            \"overview\" : { \"pre_tags\" : [\"\\\\033[0;32;40m\"], \"post_tags\" : [\"\\\\033[0m\"] },\n            \"title\" : { \"pre_tags\" : [\"\\\\033[0;32;40m\"], \"post_tags\" : [\"\\\\033[0m\"] }\n\n        }\n    }\n}\n```\n\n## 相关\n- Windows 安装 pyenv https://github.com/pyenv-win/pyenv-win\n- Mac 安装pyenv https://segmentfault.com/a/1190000017403221\n- Linux 安装 pyenv https://blog.csdn.net/GX_1_11_real/article/details/80237064\n- Python.org https://www.python.org/\n\n\n# 4.9-使用SearchTemplate和IndexAlias进行查询.md\n\n# 使用 Search Template 和 Index Alias 查询\n\n```\nPOST _scripts/tmdb\n{\n  \"script\": {\n    \"lang\": \"mustache\",\n    \"source\": {\n      \"_source\": [\n        \"title\",\"overview\"\n      ],\n      \"size\": 20,\n      \"query\": {\n        \"multi_match\": {\n          \"query\": \"{{q}}\",\n          \"fields\": [\"title\",\"overview\"]\n        }\n      }\n    }\n  }\n}\nDELETE _scripts/tmdb\n\nGET _scripts/tmdb\n\nPOST tmdb/_search/template\n{\n    \"id\":\"tmdb\",\n    \"params\": {\n        \"q\": \"basketball with cartoon aliens\"\n    }\n}\n\n\nPUT movies-2019/_doc/1\n{\n  \"name\":\"the matrix\",\n  \"rating\":5\n}\n\nPUT movies-2019/_doc/2\n{\n  \"name\":\"Speed\",\n  \"rating\":3\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-latest\"\n      }\n    }\n  ]\n}\n\nPOST movies-latest/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-lastest-highrate\",\n        \"filter\": {\n          \"range\": {\n            \"rating\": {\n              \"gte\": 4\n            }\n          }\n        }\n      }\n    }\n  ]\n}\n\nPOST movies-lastest-highrate/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n\n\n```\n\n\n# 5.1-集群分布式模型及选主与脑裂问题.md\n\n# 集群分布式模型及选主与脑裂问题\n\n```\nbin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data\nbin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data\nbin/elasticsearch -E node.name=node3 -E cluster.name=geektime -E path.data=node3_data\n\n```\n# 5.2-分片与集群的故障转移.md\n\n# 分片与集群的故障转移\n\n\n# 5.3-文档分布式存储.md\n\n# 文档分布式存储\n\n\n# 5.4-分片及其生命周期.md\n\n# 分片及其生命周期\n\n\n# 5.5-剖析分布式查询及相关性评分.md\n\n# 剖析分布式查询及相关性评分\n```\nDELETE message\nPUT message\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  }\n}\n\nGET message\n\nPOST message/_doc?routing=1\n{\n  \"content\":\"good\"\n}\n\nPOST message/_doc?routing=2\n{\n  \"content\":\"good morning\"\n}\n\nPOST message/_doc?routing=3\n{\n  \"content\":\"good morning everyone\"\n}\n\nPOST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n\nPOST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n\n\nPOST message/_search?search_type=dfs_query_then_fetch\n{\n\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n\n```\n\n\n# 5.6-排序及DocValues&Fielddata.md\n\n# 排序及Doc Values & Fielddata\n```\n#单字段排序\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}}\n  ]\n}\n\n#多字段排序\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}},\n    {\"_doc\":{\"order\": \"asc\"}},\n    {\"_score\":{ \"order\": \"desc\"}}\n  ]\n}\n\nGET kibana_sample_data_ecommerce/_mapping\n\n#对 text 字段进行排序。默认会报错，需打开fielddata\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"customer_full_name\": {\"order\": \"desc\"}}\n  ]\n}\n\n#打开 text的 fielddata\nPUT kibana_sample_data_ecommerce/_mapping\n{\n  \"properties\": {\n    \"customer_full_name\" : {\n          \"type\" : \"text\",\n          \"fielddata\": true,\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n  }\n}\n\n#关闭 keyword的 doc values\nPUT test_keyword\nPUT test_keyword/_mapping\n{\n  \"properties\": {\n    \"user_name\":{\n      \"type\": \"keyword\",\n      \"doc_values\":false\n    }\n  }\n}\n\nDELETE test_keyword\n\nPUT test_text\nPUT test_text/_mapping\n{\n  \"properties\": {\n    \"intro\":{\n      \"type\": \"text\",\n      \"doc_values\":true\n    }\n  }\n}\n\nDELETE test_text\n\n\nDELETE temp_users\nPUT temp_users\nPUT temp_users/_mapping\n{\n  \"properties\": {\n    \"name\":{\"type\": \"text\",\"fielddata\": true},\n    \"desc\":{\"type\": \"text\",\"fielddata\": true}\n  }\n}\n\nPost temp_users/_doc\n{\"name\":\"Jack\",\"desc\":\"Jack is a good boy!\",\"age\":10}\n\n#打开fielddata 后，查看 docvalue_fields数据\nPOST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"name\",\"desc\"\n    ]\n}\n\n#查看整型字段的docvalues\nPOST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"age\"\n    ]\n}\n```\n\n\n# 5.7-分页与遍历-FromSize&SearchAfter&ScrollAPI.md\n\n# 分页与遍历 - From, Size, Search_after & Scroll API\n```\n\nPOST tmdb/_search\n{\n  \"from\": 10000,\n  \"size\": 1,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  }\n}\n\n#Scroll API\nDELETE users\n\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":11}\n\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":12}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":13}\n\nPOST users/_count\n\nPOST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n\nPOST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"search_after\":\n        [\n          10,\n          \"ZQ0vYGsBrR8X3IP75QqX\"],\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n\n\n#Scroll API\nDELETE users\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":20}\n\nPOST users/_doc\n{\"name\":\"user3\",\"age\":30}\n\nPOST users/_doc\n{\"name\":\"user4\",\"age\":40}\n\nPOST /users/_search?scroll=5m\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\" : {\n        }\n    }\n}\n\n\nPOST users/_doc\n{\"name\":\"user5\",\"age\":50}\nPOST /_search/scroll\n{\n    \"scroll\" : \"1m\",\n    \"scroll_id\" : \"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ==\"\n}\n\n\n```\n\n\n# 5.8-处理并发读写.md\n\n# 处理并发读写操作\n```\n\nDELETE products\nPUT products\n\nPUT products/_doc/1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\nGET products/_doc/1\n\nPUT products/_doc/1?if_seq_no=1&if_primary_term=1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\nPUT products/_doc/1?version=30000&version_type=external\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\n```\n\n\n# 6.1-Bucket&Metric聚合分析及嵌套聚合.md\n\n# Bucket & Metric Aggregation\n## demos\n```\nDELETE /employees\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n# Metric 聚合，找到最低的工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"min_salary\": {\n      \"min\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n# Metric 聚合，找到最高的工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n# 多个 Metric 聚合，找到最低最高和平均工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"min_salary\": {\n      \"min\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"avg_salary\": {\n      \"avg\": {\n        \"field\": \"salary\"\n      }\n    }\n  }\n}\n\n# 一个聚合，输出多值\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"stats_salary\": {\n      \"stats\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n\n\n\n# 对keword 进行聚合\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n\n\n# 对 Text 字段进行 terms 聚合查询，失败\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n\n# 对 Text 字段打开 fielddata，支持terms aggregation\nPUT employees/_mapping\n{\n  \"properties\" : {\n    \"job\":{\n       \"type\":     \"text\",\n       \"fielddata\": true\n    }\n  }\n}\n\n\n# 对 Text 字段进行 terms 分词。分词后的terms\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n\n\n# 对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"cardinate\": {\n      \"cardinality\": {\n        \"field\": \"job\"\n      }\n    }\n  }\n}\n\n\n# 对 性别的 keyword 进行聚合\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"gender\": {\n      \"terms\": {\n        \"field\":\"gender\"\n      }\n    }\n  }\n}\n\n\n#指定 bucket 的 size\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"ages_5\": {\n      \"terms\": {\n        \"field\":\"age\",\n        \"size\":3\n      }\n    }\n  }\n}\n\n\n\n# 指定size，不同工种中，年纪最大的3个员工的具体信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      },\n      \"aggs\":{\n        \"old_employee\":{\n          \"top_hits\":{\n            \"size\":3,\n            \"sort\":[\n              {\n                \"age\":{\n                  \"order\":\"desc\"\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\n#Salary Ranges 分桶，可以自己定义 key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_range\": {\n      \"range\": {\n        \"field\":\"salary\",\n        \"ranges\":[\n          {\n            \"to\":10000\n          },\n          {\n            \"from\":10000,\n            \"to\":20000\n          },\n          {\n            \"key\":\">20000\",\n            \"from\":20000\n          }\n        ]\n      }\n    }\n  }\n}\n\n\n#Salary Histogram,工资0到10万，以 5000一个区间进行分桶\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_histrogram\": {\n      \"histogram\": {\n        \"field\":\"salary\",\n        \"interval\":5000,\n        \"extended_bounds\":{\n          \"min\":0,\n          \"max\":100000\n\n        }\n      }\n    }\n  }\n}\n\n\n# 嵌套聚合1，按照工作类型分桶，并统计工资信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_salary_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"salary\": {\n          \"stats\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n# 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_gender_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"gender_stats\": {\n          \"terms\": {\n            \"field\": \"gender\"\n          },\n          \"aggs\": {\n            \"salary_stats\": {\n              \"stats\": {\n                \"field\": \"salary\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\n\n# 6.2-Pipeline聚合分析.md\n\n# Pipeline 聚合分析\n```\nDELETE employees\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n\n\n# 平均工资最低的工作类型\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"min_salary_by_job\":{\n      \"min_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资最高的工作类型\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"max_salary_by_job\":{\n      \"max_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的平均工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"avg_salary_by_job\":{\n      \"avg_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的统计分析\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"stats_salary_by_job\":{\n      \"stats_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的百分位数\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"percentiles_salary_by_job\":{\n      \"percentiles_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n\n#按照年龄对平均工资求导\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"derivative_avg_salary\":{\n          \"derivative\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#Cumulative_sum\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"cumulative_salary\":{\n          \"cumulative_sum\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n#Moving Function\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"moving_avg_salary\":{\n          \"moving_fn\": {\n            \"buckets_path\": \"avg_salary\",\n            \"window\":10,\n            \"script\": \"MovingFunctions.min(values)\"\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\n# 6.3-作用范围与排序.md\n\n# 作用范围与排序\n```\nDELETE /employees\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n\n\n# Query\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    }\n  }\n}\n\n\n#Filter\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"older_person\": {\n      \"filter\":{\n        \"range\":{\n          \"age\":{\n            \"from\":35\n          }\n        }\n      },\n      \"aggs\":{\n         \"jobs\":{\n           \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n      }\n    }},\n    \"all_jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    }\n  }\n}\n\n\n\n#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果\nPOST employees/_search\n{\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      }\n    }\n  },\n  \"post_filter\": {\n    \"match\": {\n      \"job.keyword\": \"Dev Manager\"\n    }\n  }\n}\n\n\n#global\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 40\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    },\n    \n    \"all\":{\n      \"global\":{},\n      \"aggs\":{\n        \"salary_avg\":{\n          \"avg\":{\n            \"field\":\"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[\n          {\"_count\":\"asc\"},\n          {\"_key\":\"desc\"}\n          ]\n        \n      }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"avg_salary\":\"desc\"\n          }]\n        \n        \n      },\n    \"aggs\": {\n      \"avg_salary\": {\n        \"avg\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"stats_salary.min\":\"desc\"\n          }]\n        \n        \n      },\n    \"aggs\": {\n      \"stats_salary\": {\n        \"stats\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n```\n\n# 6.4-聚合分析的原理及精准度问题.md\n\n# 聚合分析的原理及精准度问题\n```\nDELETE my_flights\nPUT my_flights\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  },\n  \"mappings\" : {\n      \"properties\" : {\n        \"AvgTicketPrice\" : {\n          \"type\" : \"float\"\n        },\n        \"Cancelled\" : {\n          \"type\" : \"boolean\"\n        },\n        \"Carrier\" : {\n          \"type\" : \"keyword\"\n        },\n        \"Dest\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"DestRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DistanceKilometers\" : {\n          \"type\" : \"float\"\n        },\n        \"DistanceMiles\" : {\n          \"type\" : \"float\"\n        },\n        \"FlightDelay\" : {\n          \"type\" : \"boolean\"\n        },\n        \"FlightDelayMin\" : {\n          \"type\" : \"integer\"\n        },\n        \"FlightDelayType\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightNum\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeHour\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeMin\" : {\n          \"type\" : \"float\"\n        },\n        \"Origin\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"OriginRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"dayOfWeek\" : {\n          \"type\" : \"integer\"\n        },\n        \"timestamp\" : {\n          \"type\" : \"date\"\n        }\n      }\n    }\n}\n\n\nPOST _reindex\n{\n  \"source\": {\n    \"index\": \"kibana_sample_data_flights\"\n  },\n  \"dest\": {\n    \"index\": \"my_flights\"\n  }\n}\n\nGET kibana_sample_data_flights/_count\nGET my_flights/_count\n\nget kibana_sample_data_flights/_search\n\n\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":5,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n\n\nGET my_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":1,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n\n```\n\n# 7.1-对象及 Nested 对象.md\n\n# 对象及Nested对象\n```\nDELETE blog\n# 设置blog的 Mapping\nPUT /blog\n{\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"time\": {\n        \"type\": \"date\"\n      },\n      \"user\": {\n        \"properties\": {\n          \"city\": {\n            \"type\": \"text\"\n          },\n          \"userid\": {\n            \"type\": \"long\"\n          },\n          \"username\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n# 插入一条 Blog 信息\nPUT blog/_doc/1\n{\n  \"content\":\"I like Elasticsearch\",\n  \"time\":\"2019-01-01T00:00:00\",\n  \"user\":{\n    \"userid\":1,\n    \"username\":\"Jack\",\n    \"city\":\"Shanghai\"\n  }\n}\n\n\n# 查询 Blog 信息\nPOST blog/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"content\": \"Elasticsearch\"}},\n        {\"match\": {\"user.username\": \"Jack\"}}\n      ]\n    }\n  }\n}\n\n\nDELETE my_movies\n\n# 电影的Mapping信息\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"properties\" : {\n            \"first_name\" : {\n              \"type\" : \"keyword\"\n            },\n            \"last_name\" : {\n              \"type\" : \"keyword\"\n            }\n          }\n        },\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n}\n\n\n# 写入一条电影信息\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n\n# 查询电影信息\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"actors.first_name\": \"Keanu\"}},\n        {\"match\": {\"actors.last_name\": \"Hopper\"}}\n      ]\n    }\n  }\n\n}\n\nDELETE my_movies\n# 创建 Nested 对象 Mapping\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"type\": \"nested\",\n          \"properties\" : {\n            \"first_name\" : {\"type\" : \"keyword\"},\n            \"last_name\" : {\"type\" : \"keyword\"}\n          }},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\"keyword\":{\"type\":\"keyword\",\"ignore_above\":256}}\n        }\n      }\n    }\n}\n\n\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n\n# Nested 查询\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"Speed\"}},\n        {\n          \"nested\": {\n            \"path\": \"actors\",\n            \"query\": {\n              \"bool\": {\n                \"must\": [\n                  {\"match\": {\n                    \"actors.first_name\": \"Keanu\"\n                  }},\n\n                  {\"match\": {\n                    \"actors.last_name\": \"Hopper\"\n                  }}\n                ]\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n\n\n# Nested Aggregation\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"actors\": {\n      \"nested\": {\n        \"path\": \"actors\"\n      },\n      \"aggs\": {\n        \"actor_name\": {\n          \"terms\": {\n            \"field\": \"actors.first_name\",\n            \"size\": 10\n          }\n        }\n      }\n    }\n  }\n}\n\n\n# 普通 aggregation不工作\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"NAME\": {\n      \"terms\": {\n        \"field\": \"actors.first_name\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n```\n\n# 7.2-文档的父子关系.md\n\n# 文档的父子关系\n```\nDELETE my_blogs\n\n# 设定 Parent/Child Mapping\nPUT my_blogs\n{\n  \"settings\": {\n    \"number_of_shards\": 2\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"blog_comments_relation\": {\n        \"type\": \"join\",\n        \"relations\": {\n          \"blog\": \"comment\"\n        }\n      },\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"title\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n\n\n#索引父文档\nPUT my_blogs/_doc/blog1\n{\n  \"title\":\"Learning Elasticsearch\",\n  \"content\":\"learning ELK @ geektime\",\n  \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n#索引父文档\nPUT my_blogs/_doc/blog2\n{\n  \"title\":\"Learning Hadoop\",\n  \"content\":\"learning Hadoop\",\n    \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n\n#索引子文档\nPUT my_blogs/_doc/comment1?routing=blog1\n{\n  \"comment\":\"I am learning ELK\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog1\"\n  }\n}\n\n#索引子文档\nPUT my_blogs/_doc/comment2?routing=blog2\n{\n  \"comment\":\"I like Hadoop!!!!!\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog2\"\n  }\n}\n\n#索引子文档\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n  \"comment\":\"Hello Hadoop\",\n  \"username\":\"Bob\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog2\"\n  }\n}\n\n# 查询所有文档\nPOST my_blogs/_search\n{\n\n}\n\n\n#根据父文档ID查看\nGET my_blogs/_doc/blog2\n\n# Parent Id 查询\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"parent_id\": {\n      \"type\": \"comment\",\n      \"id\": \"blog2\"\n    }\n  }\n}\n\n# Has Child 查询,返回父文档\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"comment\",\n      \"query\" : {\n                \"match\": {\n                    \"username\" : \"Jack\"\n                }\n            }\n    }\n  }\n}\n\n\n# Has Parent 查询，返回相关的子文档\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_parent\": {\n      \"parent_type\": \"blog\",\n      \"query\" : {\n                \"match\": {\n                    \"title\" : \"Learning Hadoop\"\n                }\n            }\n    }\n  }\n}\n\n\n\n#通过ID ，访问子文档\nGET my_blogs/_doc/comment3\n#通过ID和routing ，访问子文档\nGET my_blogs/_doc/comment3?routing=blog2\n\n#更新子文档\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n    \"comment\": \"Hello Hadoop??\",\n    \"blog_comments_relation\": {\n      \"name\": \"comment\",\n      \"parent\": \"blog2\"\n    }\n}\n\n\n```\n\n# 7.5-Elasticsearch数据建模实例.md\n\n# Elasticsearch 数据建模实例\n```\n###### Data Modeling Example\n\n# Index 一本书的信息\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n\n\n\n#查询自动创建的Mapping\nGET books/_mapping\n\nDELETE books\n\n#优化字段类型\nPUT books\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\"},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false},\n        \"description\" : {\"type\" : \"text\"},\n        \"public_date\" : {\"type\" : \"date\"},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          }\n        }\n      }\n    }\n}\n\n#Cover URL index 设置成false，无法对该字段进行搜索\nPOST books/_search\n{\n  \"query\": {\n    \"term\": {\n      \"cover_url\": {\n        \"value\": \"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n      }\n    }\n  }\n}\n\n#Cover URL index 设置成false，依然支持聚合分析\nPOST books/_search\n{\n  \"aggs\": {\n    \"cover\": {\n      \"terms\": {\n        \"field\": \"cover_url\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n\nDELETE books\n#新增 Content字段。数据量很大。选择将Source 关闭\nPUT books\n{\n      \"mappings\" : {\n      \"_source\": {\"enabled\": false},\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\",\"store\": true},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false,\"store\": true},\n        \"description\" : {\"type\" : \"text\",\"store\": true},\n         \"content\" : {\"type\" : \"text\",\"store\": true},\n        \"public_date\" : {\"type\" : \"date\",\"store\": true},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          },\n          \"store\": true\n        }\n      }\n    }\n}\n\n\n# Index 一本书的信息,包含Content\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins\",\n  \"content\":\"The content of the book......Indexing data, aggregation, searching.    something else. something in the way............\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n\n#查询结果中，Source不包含数据\nPOST books/_search\n{}\n\n#搜索，通过store 字段显示数据，同时高亮显示 conent的内容\nPOST books/_search\n{\n  \"stored_fields\": [\"title\",\"author\",\"public_date\"],\n  \"query\": {\n    \"match\": {\n      \"content\": \"searching\"\n    }\n  },\n\n  \"highlight\": {\n    \"fields\": {\n      \"content\":{}\n    }\n  }\n\n}\n\n```\n\n# 7.6-Elasticsearch 数据建模最佳实践.md\n\n# Elasticsearch 数据建模最佳实践\n\n\n```\n\n###### Cookie Service\n\n##索引数据，dynamic mapping 会不断加入新增字段\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":{\n   \"username\":\"tom\",\n   \"age\":32\n }\n}\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":{\n   \"login\":\"2019-01-01\",\n   \"email\":\"xyz@abc.com\"\n }\n}\n\n\nDELETE cookie_service\n#使用 Nested 对象，增加key/value\nPUT cookie_service\n{\n  \"mappings\": {\n    \"properties\": {\n      \"cookies\": {\n        \"type\": \"nested\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"keyword\"\n          },\n          \"dateValue\": {\n            \"type\": \"date\"\n          },\n          \"keywordValue\": {\n            \"type\": \"keyword\"\n          },\n          \"IntValue\": {\n            \"type\": \"integer\"\n          }\n        }\n      },\n      \"url\": {\n        \"type\": \"text\",\n        \"fields\": {\n          \"keyword\": {\n            \"type\": \"keyword\",\n            \"ignore_above\": 256\n          }\n        }\n      }\n    }\n  }\n}\n\n\n##写入数据，使用key和合适类型的value字段\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":[\n    {\n      \"name\":\"username\",\n      \"keywordValue\":\"tom\"\n    },\n    {\n       \"name\":\"age\",\n      \"intValue\":32\n\n    }\n\n   ]\n }\n\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":[\n    {\n      \"name\":\"login\",\n      \"dateValue\":\"2019-01-01\"\n    },\n    {\n       \"name\":\"email\",\n      \"IntValue\":32\n\n    }\n\n   ]\n }\n\n\n# Nested 查询，通过bool查询进行过滤\nPOST cookie_service/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"cookies\",\n      \"query\": {\n        \"bool\": {\n          \"filter\": [\n            {\n            \"term\": {\n              \"cookies.name\": \"age\"\n            }},\n            {\n              \"range\":{\n                \"cookies.intValue\":{\n                  \"gte\":30\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  }\n}\n\n\n\n# 在Mapping中加入元信息，便于管理\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.0\"\n    }\n  }\n}\n\nGET softwares/_mapping\nPUT softwares/_doc/1\n{\n  \"software_version\":\"7.1.0\"\n}\n\nDELETE softwares\n# 优化,使用inner object\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.1\"\n    },\n    \"properties\": {\n      \"version\": {\n        \"properties\": {\n          \"display_name\": {\n            \"type\": \"keyword\"\n          },\n          \"hot_fix\": {\n            \"type\": \"byte\"\n          },\n          \"marjor\": {\n            \"type\": \"byte\"\n          },\n          \"minor\": {\n            \"type\": \"byte\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#通过 Inner Object 写入多个文档\nPUT softwares/_doc/1\n{\n  \"version\":{\n  \"display_name\":\"7.1.0\",\n  \"marjor\":7,\n  \"minor\":1,\n  \"hot_fix\":0  \n  }\n\n}\n\nPUT softwares/_doc/2\n{\n  \"version\":{\n  \"display_name\":\"7.2.0\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":0  \n  }\n}\n\nPUT softwares/_doc/3\n{\n  \"version\":{\n  \"display_name\":\"7.2.1\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":1  \n  }\n}\n\n\n# 通过 bool 查询，\nPOST softwares/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\n          \"match\":{\n            \"version.marjor\":7\n          }\n        },\n        {\n          \"match\":{\n            \"version.minor\":2\n          }\n        }\n\n      ]\n    }\n  }\n}\n\n\n\n\n# Not Null 解决聚合的问题\nDELETE ratings\nPUT ratings\n{\n  \"mappings\": {\n      \"properties\": {\n        \"rating\": {\n          \"type\": \"float\",\n          \"null_value\": 1.0\n        }\n      }\n    }\n}\n\n\nPUT ratings/_doc/1\n{\n \"rating\":5\n}\nPUT ratings/_doc/2\n{\n \"rating\":null\n}\n\n\nPOST ratings/_search\nPOST ratings/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"avg\": {\n      \"avg\": {\n        \"field\": \"rating\"\n      }\n    }\n  }\n}\n\nPOST ratings/_search\n{\n  \"query\": {\n    \"term\": {\n      \"rating\": {\n        \"value\": 1\n      }\n    }\n  }\n}\n\n```\n\n\n# 7.7-第二部分总结与测验.md\n\n# 第二部分总结与测验\n```\nDELETE test\nPUT test/_doc/1\n{\n  \"content\":\"Hello World\"\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n\n\n```\n\n\n# 8.1-集群身份认证与用户鉴权.md\n\n# 集群身份认证与用户鉴权\n- 如何为集群启用X-Pack Security\n- 如何为内置用户设置密码\n- 设置 Kibana与ElasticSearch通信鉴权\n- 使用安全API创建对特定索引具有有限访问权限的用户\n\nThis tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:\n\ndiscovery.type: single-node\n\n```\n#启动单节点\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true\n\n#使用Curl访问ES，或者浏览器访问 “localhost:9200/_cat/nodes?pretty”。返回401错误\ncurl 'localhost:9200/_cat/nodes?pretty'\n\n#运行密码设定的命令，设置ES内置用户及其初始密码。\nbin/elasticsearch-setup-passwords interactive\n\ncurl -u elastic 'localhost:9200/_cat/nodes?pretty'\n\n\n# 修改 kibana.yml\nelasticsearch.username: \"kibana\"\nelasticsearch.password: \"changeme\"\n\n#启动。使用用户名，elastic，密码elastic\n./bin/kibana\n\n\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n\n\n#create a new role named read_only_orders, that satisfies the following criteria:\n#The role has no cluster privileges\n#The role only has access to indices that match the pattern sales_record\n#The index privileges are read, and view_index_metadata\n\n\n#create sales_user that satisfies the following criteria:\n# Use your own email address\n# Assign the user to two roles: read_only_orders and kibana_user\n\n\n#验证读权限,可以执行\nPOST orders/_search\n{}\n\n#验证写权限,报错\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n\n\n```\n\n\n# 8.2-集群内部安全通信.md\n\n#\n\n```\n# 生成证书\n# 为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：\nbin/elasticsearch-certutil ca\n\n#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：\nbin/elasticsearch-certutil cert --ca elastic-stack-ca.p12\n\n#将证书拷贝到 config/certs目录下\nelastic-certificates.p12\n\n\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12\n\nbin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12\n\n\n#不提供证书的节点，无法加入\nbin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E http.port=9202 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate\n\n\n```\n\n\n```\n## elasticsearch.yml 配置\n\n#xpack.security.transport.ssl.enabled: true\n#xpack.security.transport.ssl.verification_mode: certificate\n\n#xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12\n#xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12\n\n\n```\n\n# 8.3-集群与外部间的安全通信.md\n\n\n\n```\nxpack.security.http.ssl.enabled: true\nxpack.security.http.ssl.keystore.path: certs/elastic-certificates.p12\nxpack.security.http.ssl.truststore.path: certs/elastic-certificates.p12\n\n```\n```\n\n\n# ES 启用 https\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12\n\n```\n\n```\n#Kibana 连接 ES https\n\n\n\n# 为kibana生成pem\nopenssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem\n\n\nelasticsearch.hosts: [\"https://localhost:9200\"]\nelasticsearch.ssl.certificateAuthorities: [ \"/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem\" ]\nelasticsearch.ssl.verificationMode: certificate\n\n\n\n# 为 Kibna 配置 HTTPS\n# 生成后解压，包含了instance.crt 和 instance.key\nbin/elasticsearch-certutil ca --pem\n\nserver.ssl.enabled: true\nserver.ssl.certificate: config/certs/instance.crt\nserver.ssl.key: config/certs/instance.key\n\n\n```\n\n\n\n# 9.1-常见的集群部署方式.md\n\n# 常见的集群部署方式\n\n# 9.2-Hot&Warm架构与ShardFiltering.md\n\n# Hot & Warm 架构与 Shard Filtering\n## 课程代码\n```\n# 标记一个 Hot 节点\nbin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot\n\n# 标记一个 warm 节点\nbin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm\n\n# 查看节点\nGET /_cat/nodeattrs?v\n\n# 配置到 Hot节点\nPUT logs-2019-06-27\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.my_node_type\":\"hot\"\n  }\n}\n\n\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\n\nGET _cat/shards?v\n\n\n# 配置到 warm 节点\nPUT PUT logs-2019-06-27/_settings\n{  \n  \"index.routing.allocation.require.my_node_type\":\"warm\"\n}\n\n\n# 标记一个 rack 1\nbin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# 标记一个 rack 2\nbin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\"\n  }\n}\n\nPUT my_index1\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1\n  }\n}\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\nGET _cat/shards?v\nDELETE my_index1/_doc/1\n\n\n\n# Fore awareness\n# 标记一个 rack 1\nbin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# 标记一个 rack 2\nbin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1\n\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\",\n    \"cluster.routing.allocation.awareness.force.my_rack_id.values\": \"rack1,rack2\"\n  }\n}\nGET _cluster/settings\n\n# 集群黄色\nGET _cluster/health\n\n# 副本无法分配\nGET _cat/shards?v\n\n\nGET _cluster/allocation/explain?pretty\n```\n","source":"_posts/elasticsearch/es高级命令.md","raw":"---\ntitle: es高级命令\ndate: 2025-02-27 16:05:47\ncategories: elasticsearch\ntag: 学习笔记\n---\n以下是优化过的笔记，已加入注释并调整格式，使其更符合Markdown标准：\n\n---\n\n# Elasticsearch 集群管理与优化笔记\n\n## 1. 移动分片到另一个节点\n```bash\nPOST _cluster/reroute\n{\n  \"commands\": [\n    {\n      \"move\": {\n        \"index\": \"index_name\",   # 索引名称\n        \"shard\": 0,               # 分片编号\n        \"from_node\": \"node_name_1\", # 源节点\n        \"to_node\": \"node_name_2\"   # 目标节点\n      }\n    }\n  ]\n}\n```\n\n## 2. 强制分配未分配的分片（带原因说明）\n```bash\nPOST _cluster/reroute?explain\n{\n  \"commands\": [\n    {\n      \"allocate\": {\n        \"index\": \"index_name\",   # 索引名称\n        \"shard\": 0,              # 分片编号\n        \"node\": \"nodename\"       # 目标节点\n      }\n    }\n  ]\n}\n```\n\n## 3. 从集群中移除节点\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.exclude._ip\": \"the_IP_of_your_node\"   # 要排除的节点IP\n  }\n}\n```\n\n## 4. 强制执行同步刷新\n```bash\nPOST _flush/synced\n```\n\n## 5. 调整集群平衡时移动的分片数量\n```bash\nPUT /_cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\": 2   # 同时平衡的分片数\n  }\n}\n```\n\n## 6. 调整每个节点同时恢复的分片数量\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.node_concurrent_recoveries\": 5   # 每个节点并行恢复的分片数\n  }\n}\n```\n\n## 7. 调整恢复速度\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"indices.recovery.max_bytes_per_sec\": \"80mb\"   # 恢复速率\n  }\n}\n```\n\n## 8. 调整单节点恢复时并发流数量\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"indices.recovery.concurrent_streams\": 6   # 单节点恢复时的并发流数\n  }\n}\n```\n\n## 9. 调整搜索队列大小\n```bash\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"threadpool.search.queue_size\": 2000   # 搜索队列大小\n  }\n}\n```\n\n## 10. 清除节点缓存\n```bash\nPOST _cache/clear\n```\n\n## 11. 调整断路器配置\n```bash\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.breaker.total.limit\": \"40%\"   # 设置内存断路器的总内存限制\n  }\n}\n```\n\n---\n\n# 监控 Elasticsearch 集群\n\n## 1. 节点统计\n```bash\nGET _nodes/stats\n```\n\n## 2. 集群统计\n```bash\nGET _cluster/stats\n```\n\n## 3. 索引统计\n```bash\nGET kibana_sample_data_ecommerce/_stats\n```\n\n## 4. 查看待处理的集群任务\n```bash\nGET _cluster/pending_tasks\n```\n\n## 5. 查看所有任务，支持取消任务\n```bash\nGET _tasks\n```\n\n## 6. 查看节点的线程池信息\n```bash\nGET _nodes/thread_pool\nGET _nodes/stats/thread_pool\nGET _cat/thread_pool?v\nGET _nodes/hot_threads\nGET _nodes/stats/thread_pool\n```\n\n## 7. 设置索引慢日志（Slowlog）\n- 设置索引慢日志阈值：\n```bash\nPUT my_index/_settings\n{\n  \"index.indexing.slowlog\": {\n    \"threshold.index\": {\n      \"warn\": \"10s\",    # 警告级别\n      \"info\": \"4s\",     # 信息级别\n      \"debug\": \"2s\",    # 调试级别\n      \"trace\": \"0s\"     # 跟踪级别\n    },\n    \"level\": \"trace\",\n    \"source\": 1000   # 日志源的最大字符数\n  }\n}\n```\n\n- 设置查询慢日志：\n```bash\nDELETE my_index\nPUT my_index/\n{\n  \"settings\": {\n    \"index.search.slowlog.threshold\": {\n      \"query.warn\": \"10s\",   # 查询慢日志警告级别\n      \"query.info\": \"3s\",    # 查询慢日志信息级别\n      \"query.debug\": \"2s\",   # 查询慢日志调试级别\n      \"query.trace\": \"0s\",   # 查询慢日志跟踪级别\n      \"fetch.warn\": \"1s\",    # 获取慢日志警告级别\n      \"fetch.info\": \"600ms\", # 获取慢日志信息级别\n      \"fetch.debug\": \"400ms\",# 获取慢日志调试级别\n      \"fetch.trace\": \"0s\"    # 获取慢日志跟踪级别\n    }\n  }\n}\n```\n\n---\n\n# 解决集群 Yellow 与 Red 状态问题\n\n## 1. 检查集群健康状态\n```bash\nGET /_cluster/health/\n```\n\n## 2. 查看索引级别健康状态，找出红色索引\n```bash\nGET /_cluster/health?level=indices\n```\n\n## 3. 查看分片级别健康状态\n```bash\nGET _cluster/health?level=shards\n```\n\n## 4. 解释索引分片无法分配的原因\n```bash\nGET /_cluster/allocation/explain\n```\n\n## 5. 删除并重新创建索引\n```bash\nDELETE mytest\nPUT mytest\n{\n  \"settings\": {\n    \"number_of_shards\": 3,    # 分片数\n    \"number_of_replicas\": 0,   # 副本数\n    \"index.routing.allocation.require.box_type\": \"hot\"   # 指定节点类型\n  }\n}\n```\n\n---\n\n# 提升集群写性能\n\n## 1. 设置优化写入性能的索引设置\n```bash\nDELETE myindex\nPUT myindex\n{\n  \"settings\": {\n    \"index\": {\n      \"refresh_interval\": \"30s\",     # 刷新间隔\n      \"number_of_shards\": \"2\"        # 分片数\n    },\n    \"routing\": {\n      \"allocation\": {\n        \"total_shards_per_node\": \"3\" # 每个节点的最大分片数\n      }\n    },\n    \"translog\": {\n      \"sync_interval\": \"30s\",         # 事务日志同步间隔\n      \"durability\": \"async\"           # 异步持久化\n    },\n    \"number_of_replicas\": 0          # 副本数\n  },\n  \"mappings\": {\n    \"dynamic\": false,                # 禁用动态映射\n    \"properties\": {}\n  }\n}\n```\n\n---\n\n# 提升集群读性能\n\n## 1. 示例：查询优化\n```bash\nPUT blogs/_doc/1\n{\n  \"title\": \"elasticsearch\"\n}\n\nGET blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": { \"title\": \"elasticsearch\" }}\n      ],\n      \"filter\": {\n        \"script\": {\n          \"script\": {\n            \"source\": \"doc['title.keyword'].value.length()>5\"\n          }\n        }\n      }\n    }\n  }\n}\n\nGET blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"elasticsearch\"}},\n        {\n          \"range\": {\n            \"publish_date\": {\n              \"gte\": 2017,\n              \"lte\": 2019\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\n---\n\n# 集群压力测试\n\n## 1. 安装并配置 esrally\n```bash\npip3 install esrally\nesrally configure\n```\n\n## 2. 执行简单的压力测试\n```bash\nesrally --distribution-version=7.1.0 --test-mode\n```\n\n## 3. 执行完整数据测试\n```bash\nesrally --distribution-version=7.1.0\n```\n\n---\n\n# 使用缓存与 Breaker 限制内存使用\n\n## 1. 获取节点统计信息\n```bash\nGET _cat/nodes?v\nGET _nodes/stats/indices?pretty\nGET _cat/nodes?v&h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count\n```\n\n## 2. 设置内存限制\n```bash\nPUT /_cluster/settings\n{\n  \"persistent\": {\n    \"indices.breaker.request.limit\": \"90%\"   # 设置请求断路器内存限制\n  }\n}\n```\n\n---\n\n# 使用 Shrink 与 Rollover API 管理索引\n\n## 1. Shrink 索引\n```bash\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n```\n\n## 2. Rollover 索引\n```bash\nPOST nginx_logs_write/_rollover\n{\n  \"conditions\": {\n    \"max_age\": \"1d\",\n    \"max_docs\": 5,\n    \"max_size\": \"5gb\"\n  }\n}\n```\n\n\n```\n# 11.2-索引全生命周期管理及工具介绍.md\n\n# 索引全生命周期管理及工具介绍\n```\n\n# 运行三个节点，分片 将box_type设置成 hot，warm和cold\n# 具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件\n\n\n\nDELETE *\n\n\n\n# 设置 1秒刷新1次，生产环境10分种刷新一次\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.lifecycle.poll_interval\":\"1s\"\n  }\n}\n\n# 设置 Policy\nPUT /_ilm/policy/log_ilm_policy\n{\n  \"policy\": {\n    \"phases\": {\n      \"hot\": {\n        \"actions\": {\n          \"rollover\": {\n            \"max_docs\": 5\n          }\n        }\n      },\n      \"warm\": {\n        \"min_age\": \"10s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"warm\"\n            }\n          }\n        }\n      },\n      \"cold\": {\n        \"min_age\": \"15s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"cold\"\n            }\n          }\n        }\n      },\n      \"delete\": {\n        \"min_age\": \"20s\",\n        \"actions\": {\n          \"delete\": {}\n        }\n      }\n    }\n  }\n}\n\n\n\n# 设置索引模版\nPUT /_template/log_ilm_template\n{\n  \"index_patterns\" : [\n      \"ilm_index-*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"lifecycle\" : {\n          \"name\" : \"log_ilm_policy\",\n          \"rollover_alias\" : \"ilm_alias\"\n        },\n        \"routing\" : {\n          \"allocation\" : {\n            \"include\" : {\n              \"box_type\" : \"hot\"\n            }\n          }\n        },\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"0\"\n      }\n    },\n    \"mappings\" : { },\n    \"aliases\" : { }\n}\n\n\n\n#创建索引\nPUT ilm_index-000001\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0,\n    \"index.lifecycle.name\": \"log_ilm_policy\",\n    \"index.lifecycle.rollover_alias\": \"ilm_alias\",\n    \"index.routing.allocation.include.box_type\":\"hot\"\n  },\n  \"aliases\": {\n    \"ilm_alias\": {\n      \"is_write_index\": true\n    }\n  }\n}\n\n# 对 Alias写入文档\nPOST  ilm_alias/_doc\n{\n  \"dfd\":\"dfdsf\"\n}\n\n```\n# 12.1-Logstash入门及架构介绍.md\n\n# Logstash 入门及架构介绍\n```\n\n\n# 一个 Demo， demo 运行\nsudo bin/logstash -f logstash-filter.conf\n\n# demo数据\n127.0.0.1 - - [11/Dec/2013:00:01:45 -0800] \"GET /xampp/status.php HTTP/1.1\" 200 3891 \"http://cadenza/xampp/navi.php\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0\"\n\n\n# codec demo\n\n\nsudo bin/logstash -e \"input{stdin{codec=>line}}output{stdout{codec=> rubydebug}}\"\nsudo bin/logstash -e \"input{stdin{codec=>json}}output{stdout{codec=> rubydebug}}\"\nsudo bin/logstash -e \"input{stdin{codec=>line}}output{stdout{codec=> dots}}\"\n\n\nsudo bin/logstash -f multiline-exception.conf\n\n# 多行数据，异常\nException in thread \"main\" java.lang.NullPointerException\n        at com.example.myproject.Book.getTitle(Book.java:16)\n        at com.example.myproject.Author.getBookTitles(Author.java:25)\n        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\n\n\n\n# 一个实例\nhttps://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf\n\n```\n\n\n# 12.2-利用JDBC插件导入数据到Elasticsearch.md\n\n# Logstash插件及文档介绍\n```\nhttps://spring.io/guides/gs/accessing-data-mysql/\ncreate database db_example;\nuse db_example;\nshow tables;\ndrop table user;\nselect * from user;\n\n\n\n# 新增用户\ncurl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ\ncurl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ\ncurl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ\n\n#查看所有的用户\ncurl 'localhost:8080/demo/all'\n\n# 更新用户\ncurl -X PUT localhost:8080/demo/update -d id=16 -d name=Bob2 -d email=bob2@xyz.com -d tags=Mysql,IntelliJ\n\n# 删除用户\ncurl -X DELETE localhost:8080/demo/delete -d id=15\n\n\n\nmysql-demo.conf\n\n# 创建 alias，只显示没有被标记 deleted的用户\nPOST /_aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"users\",\n        \"alias\": \"view_users\",\n         \"filter\" : { \"term\" : { \"is_deleted\" : false } }\n      }\n    }\n  ]\n}\n\n# 通过 Alias查询，查不到被标记成 deleted的用户\nPOST view_users/_search\n{\n\n}\n\n\nPOST view_users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"Jack\"\n      }\n    }\n  }\n}\n\nPOST users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"Jack\"\n      }\n    }\n  }\n}\n\n```\n\n\n# 12.3-Beats介绍.md\n\n# Beats介绍\n```\n\n##\n# 查看 packetbeat 模块\n# 设置 packetbeat 的mysql 模块\n# 启动运行\n#\n./metricbeat modules list\n./metricbeat modules enable mysql\n./metricbeat setup --dashboards\n\n# 安装mysql\ncreate database db_example\nuse db_example;\nshow tables;\nselect * from user\n\ncurl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ\ncurl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ\ncurl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ\n\ncurl 'localhost:8080/demo/all'\n\n\n# 配置 packetbeat\n# 启动\n修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控\n\nsudo chown root packetbeat.yml\nsudo ./packetbeat setup --dashboards\nsudo ./packetbeat\n\n\n# 查看所有 Filebeat 模块\n# 查看所有的modules\n./filebeat modules list\n\n#\n./filebeat modules enable mysql\n\n```\n\n\n# 13.1-使用IndexPattern配置数据.md\n\n\n```\n\nlocalhost:5601/status\n\n\n\n\nPUT /logstash-2015.05.18\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\nPUT /logstash-2015.05.19\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /logstash-2015.05.20\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n# For Mac & Windows\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/_bulk?pretty' --data-binary @logs.jsonl\n\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\n\n\n#For Windows\nInvoke-RestMethod \"http://localhost:9200/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"logs.jsonl\"\n\n\n\nGET /_cat/indices?v\n\n```\n\n\n# 13.2-使用KibanaDiscover探索数据.md\n\n# 使用Kibana Discovery 探索数据\n```\n\n设置时间过滤器\n搜索你的数据\n根据字段进行过滤\n查看文档数据\n查看文档上下文\n暂时字段数据统计\nSave Query\n\n\n```\n\n\n# 13.3-基本可视化组件介绍.md\n\n# 基本可视化组件介绍\n```\n\nPUT /shakespeare\n{\n  \"mappings\": {\n    \"properties\": {\n    \"speaker\": {\"type\": \"keyword\"},\n    \"play_name\": {\"type\": \"keyword\"},\n    \"line_id\": {\"type\": \"integer\"},\n    \"speech_number\": {\"type\": \"integer\"}\n    }\n  }\n}\n\n\n# For Mac & Windows\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/shakespeare/_bulk?pretty' --data-binary @shakespeare.json\n\n#For Windows\nInvoke-RestMethod \"http://localhost:9200/bank/account/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"accounts.json\"\nInvoke-RestMethod \"http://localhost:9200/shakespeare/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"shakespeare.json\"\n\n\n```\n\n\n# 13.4-构建Dashboard.md\n\n# 构建Dashboard\n```\n- 创建仪表潘\n- 加载仪表盘\n- 共享仪表盘\n\n```\n\n\n# 14.3用机器学习实现时序数据的异常检测-上.md\n\nmkdir server_metrics\ncd server_metrics\nwget https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz\ntar -xvf server_metrics.tar.gz\n\n\n# 14.5-用ELK进行日志管理.md\n\n# 用 ELK 来做日志管理\n```\n./filebeat modules list\n./filebeat modules enable system\n./filebeat modules enable elasticsearch\n\n\n## 进 modules.d 编辑相应的文件，修改log路径\n\n./filebeat setup –dashboards\n\n./filebeat export template | more\n\n./filebeat -e\n\n```\n\n# 14.6-用Canvas做数据演示.md\n\nPOST elasticoffee/_search\n{\n  \"size\": 0, \n  \"aggs\": {\n    \"by\": {\n      \"terms\": {\n        \"field\": \"beverage.keyword\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n# 4.1-基于词项和基于全文的搜索.md\n\n# 基于词项和基于全文的搜索\n\n\n```\nDELETE products\nPUT products\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  }\n}\n\n\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"productID\" : \"XHDK-A-1293-#fJ3\",\"desc\":\"iPhone\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"productID\" : \"KDKE-B-9947-#kL5\",\"desc\":\"iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"productID\" : \"JODL-X-1937-#pV7\",\"desc\":\"MBP\" }\n\nGET /products\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": {\n        //\"value\": \"iPhone\"\n        \"value\":\"iphone\"\n      }\n    }\n  }\n}\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc.keyword\": {\n        //\"value\": \"iPhone\"\n        //\"value\":\"iphone\"\n      }\n    }\n  }\n}\n\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n\nPOST /products/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n\n\n\n\nPOST /products/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n\n    }\n  }\n}\n\n\n#设置 position_increment_gap\nDELETE groups\nPUT groups\n{\n  \"mappings\": {\n    \"properties\": {\n      \"names\":{\n        \"type\": \"text\",\n        \"position_increment_gap\": 0\n      }\n    }\n  }\n}\n\nGET groups/_mapping\n\nPOST groups/_doc\n{\n  \"names\": [ \"John Water\", \"Water Smith\"]\n}\n\nPOST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": {\n        \"query\": \"Water Water\",\n        \"slop\": 100\n      }\n    }\n  }\n}\n\n\nPOST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": \"Water Smith\"\n    }\n  }\n}\n```\n\n# 4.10-综合排序：Function Score Query 优化算分.md\n\n# 综合排序：Function Score Query 优化算分\n```\nDELETE blogs\nPUT /blogs/_doc/1\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   0\n}\n\nPUT /blogs/_doc/2\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   100\n}\n\nPUT /blogs/_doc/3\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   1000000\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\"\n      }\n    }\n  }\n}\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\"\n      }\n    }\n  }\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      }\n    }\n  }\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      },\n      \"boost_mode\": \"sum\",\n      \"max_boost\": 3\n    }\n  }\n}\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"random_score\": {\n        \"seed\": 911119\n      }\n    }\n  }\n}\n```\n# 4.12-自动补全与基于上下文的提示.md\n\n# 自动补全与基于上下文的提示\n```\nDELETE articles\nPUT articles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title_completion\":{\n        \"type\": \"completion\"\n      }\n    }\n  }\n}\n\nPOST articles/_bulk\n{ \"index\" : { } }\n{ \"title_completion\": \"lucene is very cool\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch builds on top of lucene\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch rocks\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"elastic is the company behind ELK stack\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elk stack rocks\"}\n{ \"index\" : {} }\n\n\nPOST articles/_search?pretty\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"article-suggester\": {\n      \"prefix\": \"elk \",\n      \"completion\": {\n        \"field\": \"title_completion\"\n      }\n    }\n  }\n}\n\n\nDELETE comments\nPUT comments\nPUT comments/_mapping\n{\n  \"properties\": {\n    \"comment_autocomplete\":{\n      \"type\": \"completion\",\n      \"contexts\":[{\n        \"type\":\"category\",\n        \"name\":\"comment_category\"\n      }]\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"I love the star war movies\",\n  \"comment_autocomplete\":{\n    \"input\":[\"star wars\"],\n    \"contexts\":{\n      \"comment_category\":\"movies\"\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"Where can I find a Starbucks\",\n  \"comment_autocomplete\":{\n    \"input\":[\"starbucks\"],\n    \"contexts\":{\n      \"comment_category\":\"coffee\"\n    }\n  }\n}\n\n\nPOST comments/_search\n{\n  \"suggest\": {\n    \"MY_SUGGESTION\": {\n      \"prefix\": \"sta\",\n      \"completion\":{\n        \"field\":\"comment_autocomplete\",\n        \"contexts\":{\n          \"comment_category\":\"coffee\"\n        }\n      }\n    }\n  }\n}\n```\n\n\n# 4.13-跨集群搜索.md\n\n# 跨集群搜索\n```\n//启动3个集群\n\nbin/elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300\nbin/elasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301\nbin/elasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302\n\n\n//在每个集群上设置动态的设置\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster\": {\n      \"remote\": {\n        \"cluster0\": {\n          \"seeds\": [\n            \"127.0.0.1:9300\"\n          ],\n          \"transport.ping_schedule\": \"30s\"\n        },\n        \"cluster1\": {\n          \"seeds\": [\n            \"127.0.0.1:9301\"\n          ],\n          \"transport.compress\": true,\n          \"skip_unavailable\": true\n        },\n        \"cluster2\": {\n          \"seeds\": [\n            \"127.0.0.1:9302\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n#cURL\ncurl -XPUT \"http://localhost:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9201/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9202/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\n\n#创建测试数据\ncurl -XPOST \"http://localhost:9200/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user1\",\"age\":10}'\n\ncurl -XPOST \"http://localhost:9201/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user2\",\"age\":20}'\n\ncurl -XPOST \"http://localhost:9202/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user3\",\"age\":30}'\n\n\n#查询\nGET /users,cluster1:users,cluster2:users/_search\n{\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20,\n        \"lte\": 40\n      }\n    }\n  }\n}\n\n```\n\n\n# 4.2-结构化搜索.md\n\n# 结构化搜索\n\n```\n\n#结构化搜索，精确匹配\nDELETE products\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\nGET products/_mapping\n\n\n\n#对布尔值 match 查询，有算分\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"avaliable\": true\n    }\n  }\n}\n\n\n\n#对布尔值，通过constant score 转成 filtering，没有算分\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": true\n        }\n      }\n    }\n  }\n}\n\n\n#数字类型 Term\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": 30\n    }\n  }\n}\n\n#数字类型 terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"price\": [\n            \"20\",\n            \"30\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n#数字 Range 查询\nGET products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"price\" : {\n                        \"gte\" : 20,\n                        \"lte\"  : 30\n                    }\n                }\n            }\n        }\n    }\n}\n\n\n# 日期 range\nPOST products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"date\" : {\n                      \"gte\" : \"now-1y\"\n                    }\n                }\n            }\n        }\n    }\n}\n\n\n\n#exists查询\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"exists\": {\n          \"field\": \"date\"\n        }\n      }\n    }\n  }\n}\n\n#处理多值字段\nPOST /movies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\"}\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"] }\n\n\n#处理多值字段，term 查询是包含，而不是等于\nPOST movies/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"genre.keyword\": \"Comedy\"\n        }\n      }\n    }\n  }\n}\n\n\n#字符类型 terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"productID.keyword\": [\n            \"QQPX-R-3956-#aD8\",\n            \"JODL-X-1937-#pV7\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": 30\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\n\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n    }\n  }\n}\n\n#对布尔数值\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": \"false\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"avaliable\": {\n        \"value\": \"false\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": {\n        \"value\": \"20\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": \"20\"\n    }\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"bool\": {\n          \"must_not\": {\n            \"exists\": {\n              \"field\": \"date\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\n```\n# 4.3-搜索的相关性算分.md\n\n# 搜索的相关性算分\n\n```\n\n\nPUT testscore\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      }\n    }\n  }\n}\n\n\nPUT testscore/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"we use Elasticsearch to power the search\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"we like elasticsearch\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"The scoring of documents is caculated by the scoring formula\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"content\":\"you know, for search\" }\n\n\n\nPOST /testscore/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"content\":\"you\"\n      //\"content\": \"elasticsearch\"\n      //\"content\":\"the\"\n      //\"content\": \"the elasticsearch\"\n    }\n  }\n}\n\nPOST testscore/_search\n{\n    \"query\": {\n        \"boosting\" : {\n            \"positive\" : {\n                \"term\" : {\n                    \"content\" : \"elasticsearch\"\n                }\n            },\n            \"negative\" : {\n                 \"term\" : {\n                     \"content\" : \"like\"\n                }\n            },\n            \"negative_boost\" : 0.2\n        }\n    }\n}\n\n\nPOST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"more_like_this\": {\n      \"fields\": [\n        \"title^10\",\"overview\"\n      ],\n      \"like\": [{\"_id\":\"14191\"}],\n      \"min_term_freq\": 1,\n      \"max_query_terms\": 12\n    }\n  }\n}\n\n\n\n```\n\n\n# 4.4-Query&Filtering实现多字符串多字段查询.md\n\n# Query & Filtering 与多字符串多字段查询\n\n```\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\n\n\n#基本语法\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :1\n    }\n  }\n}\n\n#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题\nPOST /newmovies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\",\"genre_count\":1 }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"],\"genre_count\":2 }\n\n#must，有算分\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n\n      ]\n    }\n  }\n}\n\n#Filter。不参与算分，结果的score是0\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n        ]\n\n    }\n  }\n}\n\n\n#Filtering Context\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      }\n    }\n  }\n}\n\n\n#Query Context\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\n\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"term\": {\n            \"productID.keyword\": {\n              \"value\": \"JODL-X-1937-#pV7\"}}\n        },\n        {\"term\": {\"avaliable\": {\"value\": true}}\n        }\n      ]\n    }\n  }\n}\n\n\n#嵌套，实现了 should not 逻辑\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\": {\n          \"price\": \"30\"\n        }\n      },\n      \"should\": [\n        {\n          \"bool\": {\n            \"must_not\": {\n              \"term\": {\n                \"avaliable\": \"false\"\n              }\n            }\n          }\n        }\n      ],\n      \"minimum_should_match\": 1\n    }\n  }\n}\n\n\n#Controll the Precision\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :2\n    }\n  }\n}\n\n\n\nPOST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"brown\" }},\n        { \"term\": { \"text\": \"red\" }},\n        { \"term\": { \"text\": \"quick\"   }},\n        { \"term\": { \"text\": \"dog\"   }}\n      ]\n    }\n  }\n}\n\nPOST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"quick\" }},\n        { \"term\": { \"text\": \"dog\"   }},\n        {\n          \"bool\":{\n            \"should\":[\n               { \"term\": { \"text\": \"brown\" }},\n                 { \"term\": { \"text\": \"brown\" }},\n            ]\n          }\n\n        }\n      ]\n    }\n  }\n}\n\n\nDELETE blogs\nPOST /blogs/_bulk\n{ \"index\": { \"_id\": 1 }}\n{\"title\":\"Apple iPad\", \"content\":\"Apple iPad,Apple iPad\" }\n{ \"index\": { \"_id\": 2 }}\n{\"title\":\"Apple iPad,Apple iPad\", \"content\":\"Apple iPad\" }\n\n\nPOST blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\"match\": {\n          \"title\": {\n            \"query\": \"apple,ipad\",\n            \"boost\": 1.1\n          }\n        }},\n\n        {\"match\": {\n          \"content\": {\n            \"query\": \"apple,ipad\",\n            \"boost\":\n          }\n        }}\n      ]\n    }\n  }\n}\n\nDELETE news\nPOST /news/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"Apple Mac\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"Apple iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"Apple employee like Apple Pie and Apple Juice\" }\n\n\nPOST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      }\n    }\n  }\n}\n\nPOST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      },\n      \"must_not\": {\n        \"match\":{\"content\":\"pie\"}\n      }\n    }\n  }\n}\n\nPOST news/_search\n{\n  \"query\": {\n    \"boosting\": {\n      \"positive\": {\n        \"match\": {\n          \"content\": \"apple\"\n        }\n      },\n      \"negative\": {\n        \"match\": {\n          \"content\": \"pie\"\n        }\n      },\n      \"negative_boost\": 0.5\n    }\n  }\n}\n\n```\n\n# 4.5-单字符串多字段查询-DisMaxQuery.md\n\n# 单字符串多字段查询：Dis Max Query\n```\n\nPUT /blogs/_doc/1\n{\n    \"title\": \"Quick brown rabbits\",\n    \"body\":  \"Brown rabbits are commonly seen.\"\n}\n\nPUT /blogs/_doc/2\n{\n    \"title\": \"Keeping pets healthy\",\n    \"body\":  \"My quick brown fox eats rabbits on a regular basis.\"\n}\n\nPOST /blogs/_search\n{\n    \"query\": {\n        \"bool\": {\n            \"should\": [\n                { \"match\": { \"title\": \"Brown fox\" }},\n                { \"match\": { \"body\":  \"Brown fox\" }}\n            ]\n        }\n    }\n}\n\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ]\n        }\n    }\n}\n\n\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n\n\n```\n# 4.6-单字符串多字段查询-Multi-Match.md\n\n# 单字符串多字段查询：Multi Match\n```\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n\nPOST blogs/_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\": \"best_fields\",\n      \"query\": \"Quick pets\",\n      \"fields\": [\"title\",\"body\"],\n      \"tie_breaker\": 0.2,\n      \"minimum_should_match\": \"20%\"\n    }\n  }\n}\n\n\n\nPOST books/_search\n{\n    \"multi_match\": {\n        \"query\":  \"Quick brown fox\",\n        \"fields\": \"*_title\"\n    }\n}\n\n\nPOST books/_search\n{\n    \"multi_match\": {\n        \"query\":  \"Quick brown fox\",\n        \"fields\": [ \"*_title\", \"chapter_title^2\" ]\n    }\n}\n\n\n\nDELETE /titles\nPUT /titles\n{\n    \"settings\": { \"number_of_shards\": 1 },\n    \"mappings\": {\n        \"my_type\": {\n            \"properties\": {\n                \"title\": {\n                    \"type\":     \"string\",\n                    \"analyzer\": \"english\",\n                    \"fields\": {\n                        \"std\":   {\n                            \"type\":     \"string\",\n                            \"analyzer\": \"standard\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\"\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n\n\nGET titles/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"barking dogs\"\n    }\n  }\n}\n\nDELETE /titles\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\",\n        \"fields\": {\"std\": {\"type\": \"text\",\"analyzer\": \"standard\"}}\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n\nGET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title\", \"title.std\" ]\n        }\n    }\n}\n\nGET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title^10\", \"title.std\" ]\n        }\n    }\n}\n\n```\n\n# 4.7-多语言及中文分词与检索.md\n\n# 多语言及中文分词与检索\n\n- 来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”\n\n- 你也想犯范范玮琪犯过的错吗\n- 校长说衣服上除了校徽别别别的\n- 这几天天天天气不好\n- 我背有点驼，麻麻说“你的背得背背背背佳\n\n```\n#stop word\n\nDELETE my_index\nPUT /my_index/_doc/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/_doc/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\n\nPOST my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"not happy fox\"\n    }\n  }\n}\n\n\n#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 `english`（英语）分析器，另一次使用 `standard`（标准）分析器:\n\nDELETE my_index\n\nPUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"analyzer\": \"english\"\n        }\n      }\n    }\n  }\n}\n\nPUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"fields\": {\n            \"english\": {\n              \"type\":     \"string\",\n              \"analyzer\": \"english\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /my_index/blog/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/blog/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\nGET /_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\":     \"most_fields\",\n      \"query\":    \"not happy foxes\",\n      \"fields\": [ \"title\", \"title.english\" ]\n    }\n  }\n}\n\n\n#安装插件\n./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip\n#安装插件\nbin/elasticsearch install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip\n\n\n\n\n#ik_max_word\n#ik_smart\n#hanlp: hanlp默认分词\n#hanlp_standard: 标准分词\n#hanlp_index: 索引分词\n#hanlp_nlp: NLP分词\n#hanlp_n_short: N-最短路分词\n#hanlp_dijkstra: 最短路分词\n#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）\n#hanlp_speed: 极速词典分词\n\nPOST _analyze\n{\n  \"analyzer\": \"hanlp_standard\",\n  \"text\": [\"剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜\"]\n\n}     \n\n#Pinyin\nPUT /artists/\n{\n    \"settings\" : {\n        \"analysis\" : {\n            \"analyzer\" : {\n                \"user_name_analyzer\" : {\n                    \"tokenizer\" : \"whitespace\",\n                    \"filter\" : \"pinyin_first_letter_and_full_pinyin_filter\"\n                }\n            },\n            \"filter\" : {\n                \"pinyin_first_letter_and_full_pinyin_filter\" : {\n                    \"type\" : \"pinyin\",\n                    \"keep_first_letter\" : true,\n                    \"keep_full_pinyin\" : false,\n                    \"keep_none_chinese\" : true,\n                    \"keep_original\" : false,\n                    \"limit_first_letter_length\" : 16,\n                    \"lowercase\" : true,\n                    \"trim_whitespace\" : true,\n                    \"keep_none_chinese_in_first_letter\" : true\n                }\n            }\n        }\n    }\n}\n\n\nGET /artists/_analyze\n{\n  \"text\": [\"刘德华 张学友 郭富城 黎明 四大天王\"],\n  \"analyzer\": \"user_name_analyzer\"\n}\n\n\n```\n\n## 相关资源\n- Elasticsearch IK分词插件 https://github.com/medcl/elasticsearch-analysis-ik/releases\n- Elasticsearch hanlp 分词插件 https://github.com/KennFalcon/elasticsearch-analysis-hanlp\n\n- 分词算法综述 https://zhuanlan.zhihu.com/p/50444885\n\n### 一些分词工具，供参考：\n- 中科院计算所NLPIR http://ictclas.nlpir.org/nlpir/\n- ansj分词器 https://github.com/NLPchina/ansj_seg\n- 哈工大的LTP https://github.com/HIT-SCIR/ltp\n- 清华大学THULAC https://github.com/thunlp/THULAC\n- 斯坦福分词器 https://nlp.stanford.edu/software/segmenter.shtml\n- Hanlp分词器 https://github.com/hankcs/HanLP\n- 结巴分词 https://github.com/yanyiwu/cppjieba\n- KCWS分词器(字嵌入+Bi-LSTM+CRF) https://github.com/koth/kcws\n- ZPar https://github.com/frcchang/zpar/releases\n- IKAnalyzer https://github.com/wks/ik-analyzer\n\n\n# 4.8-SpaceJam一个全文搜索的实例.md\n\n# Space Jam，一次全文搜索的实例\n\n## 环境要求\n- Python 2.7.15\n- 可以使用pyenv管理多个python版本（可选）\n\n## 进入 tmdb-search目录\nRun\npip install -r requirements.txt\nRun python ./ingest_tmdb_from_file.py\n```\nPOST tmdb/_search\n{\n\"_source\": [\"title\",\"overview\"],\n \"query\": {\n   \"match_all\": {}\n }\n}\n\nPOST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"multi_match\": {\n      \"query\": \"basketball with cartoon aliens\",\n      \"fields\": [\"title\",\"overview\"]\n    }\n  },\n  \"highlight\" : {\n        \"fields\" : {\n            \"overview\" : { \"pre_tags\" : [\"\\\\033[0;32;40m\"], \"post_tags\" : [\"\\\\033[0m\"] },\n            \"title\" : { \"pre_tags\" : [\"\\\\033[0;32;40m\"], \"post_tags\" : [\"\\\\033[0m\"] }\n\n        }\n    }\n}\n```\n\n## 相关\n- Windows 安装 pyenv https://github.com/pyenv-win/pyenv-win\n- Mac 安装pyenv https://segmentfault.com/a/1190000017403221\n- Linux 安装 pyenv https://blog.csdn.net/GX_1_11_real/article/details/80237064\n- Python.org https://www.python.org/\n\n\n# 4.9-使用SearchTemplate和IndexAlias进行查询.md\n\n# 使用 Search Template 和 Index Alias 查询\n\n```\nPOST _scripts/tmdb\n{\n  \"script\": {\n    \"lang\": \"mustache\",\n    \"source\": {\n      \"_source\": [\n        \"title\",\"overview\"\n      ],\n      \"size\": 20,\n      \"query\": {\n        \"multi_match\": {\n          \"query\": \"{{q}}\",\n          \"fields\": [\"title\",\"overview\"]\n        }\n      }\n    }\n  }\n}\nDELETE _scripts/tmdb\n\nGET _scripts/tmdb\n\nPOST tmdb/_search/template\n{\n    \"id\":\"tmdb\",\n    \"params\": {\n        \"q\": \"basketball with cartoon aliens\"\n    }\n}\n\n\nPUT movies-2019/_doc/1\n{\n  \"name\":\"the matrix\",\n  \"rating\":5\n}\n\nPUT movies-2019/_doc/2\n{\n  \"name\":\"Speed\",\n  \"rating\":3\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-latest\"\n      }\n    }\n  ]\n}\n\nPOST movies-latest/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-lastest-highrate\",\n        \"filter\": {\n          \"range\": {\n            \"rating\": {\n              \"gte\": 4\n            }\n          }\n        }\n      }\n    }\n  ]\n}\n\nPOST movies-lastest-highrate/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n\n\n```\n\n\n# 5.1-集群分布式模型及选主与脑裂问题.md\n\n# 集群分布式模型及选主与脑裂问题\n\n```\nbin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data\nbin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data\nbin/elasticsearch -E node.name=node3 -E cluster.name=geektime -E path.data=node3_data\n\n```\n# 5.2-分片与集群的故障转移.md\n\n# 分片与集群的故障转移\n\n\n# 5.3-文档分布式存储.md\n\n# 文档分布式存储\n\n\n# 5.4-分片及其生命周期.md\n\n# 分片及其生命周期\n\n\n# 5.5-剖析分布式查询及相关性评分.md\n\n# 剖析分布式查询及相关性评分\n```\nDELETE message\nPUT message\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  }\n}\n\nGET message\n\nPOST message/_doc?routing=1\n{\n  \"content\":\"good\"\n}\n\nPOST message/_doc?routing=2\n{\n  \"content\":\"good morning\"\n}\n\nPOST message/_doc?routing=3\n{\n  \"content\":\"good morning everyone\"\n}\n\nPOST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n\nPOST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n\n\nPOST message/_search?search_type=dfs_query_then_fetch\n{\n\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n\n```\n\n\n# 5.6-排序及DocValues&Fielddata.md\n\n# 排序及Doc Values & Fielddata\n```\n#单字段排序\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}}\n  ]\n}\n\n#多字段排序\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}},\n    {\"_doc\":{\"order\": \"asc\"}},\n    {\"_score\":{ \"order\": \"desc\"}}\n  ]\n}\n\nGET kibana_sample_data_ecommerce/_mapping\n\n#对 text 字段进行排序。默认会报错，需打开fielddata\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"customer_full_name\": {\"order\": \"desc\"}}\n  ]\n}\n\n#打开 text的 fielddata\nPUT kibana_sample_data_ecommerce/_mapping\n{\n  \"properties\": {\n    \"customer_full_name\" : {\n          \"type\" : \"text\",\n          \"fielddata\": true,\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n  }\n}\n\n#关闭 keyword的 doc values\nPUT test_keyword\nPUT test_keyword/_mapping\n{\n  \"properties\": {\n    \"user_name\":{\n      \"type\": \"keyword\",\n      \"doc_values\":false\n    }\n  }\n}\n\nDELETE test_keyword\n\nPUT test_text\nPUT test_text/_mapping\n{\n  \"properties\": {\n    \"intro\":{\n      \"type\": \"text\",\n      \"doc_values\":true\n    }\n  }\n}\n\nDELETE test_text\n\n\nDELETE temp_users\nPUT temp_users\nPUT temp_users/_mapping\n{\n  \"properties\": {\n    \"name\":{\"type\": \"text\",\"fielddata\": true},\n    \"desc\":{\"type\": \"text\",\"fielddata\": true}\n  }\n}\n\nPost temp_users/_doc\n{\"name\":\"Jack\",\"desc\":\"Jack is a good boy!\",\"age\":10}\n\n#打开fielddata 后，查看 docvalue_fields数据\nPOST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"name\",\"desc\"\n    ]\n}\n\n#查看整型字段的docvalues\nPOST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"age\"\n    ]\n}\n```\n\n\n# 5.7-分页与遍历-FromSize&SearchAfter&ScrollAPI.md\n\n# 分页与遍历 - From, Size, Search_after & Scroll API\n```\n\nPOST tmdb/_search\n{\n  \"from\": 10000,\n  \"size\": 1,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  }\n}\n\n#Scroll API\nDELETE users\n\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":11}\n\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":12}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":13}\n\nPOST users/_count\n\nPOST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n\nPOST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"search_after\":\n        [\n          10,\n          \"ZQ0vYGsBrR8X3IP75QqX\"],\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n\n\n#Scroll API\nDELETE users\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":20}\n\nPOST users/_doc\n{\"name\":\"user3\",\"age\":30}\n\nPOST users/_doc\n{\"name\":\"user4\",\"age\":40}\n\nPOST /users/_search?scroll=5m\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\" : {\n        }\n    }\n}\n\n\nPOST users/_doc\n{\"name\":\"user5\",\"age\":50}\nPOST /_search/scroll\n{\n    \"scroll\" : \"1m\",\n    \"scroll_id\" : \"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ==\"\n}\n\n\n```\n\n\n# 5.8-处理并发读写.md\n\n# 处理并发读写操作\n```\n\nDELETE products\nPUT products\n\nPUT products/_doc/1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\nGET products/_doc/1\n\nPUT products/_doc/1?if_seq_no=1&if_primary_term=1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\nPUT products/_doc/1?version=30000&version_type=external\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\n```\n\n\n# 6.1-Bucket&Metric聚合分析及嵌套聚合.md\n\n# Bucket & Metric Aggregation\n## demos\n```\nDELETE /employees\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n# Metric 聚合，找到最低的工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"min_salary\": {\n      \"min\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n# Metric 聚合，找到最高的工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n# 多个 Metric 聚合，找到最低最高和平均工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"min_salary\": {\n      \"min\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"avg_salary\": {\n      \"avg\": {\n        \"field\": \"salary\"\n      }\n    }\n  }\n}\n\n# 一个聚合，输出多值\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"stats_salary\": {\n      \"stats\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n\n\n\n# 对keword 进行聚合\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n\n\n# 对 Text 字段进行 terms 聚合查询，失败\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n\n# 对 Text 字段打开 fielddata，支持terms aggregation\nPUT employees/_mapping\n{\n  \"properties\" : {\n    \"job\":{\n       \"type\":     \"text\",\n       \"fielddata\": true\n    }\n  }\n}\n\n\n# 对 Text 字段进行 terms 分词。分词后的terms\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n\n\n# 对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"cardinate\": {\n      \"cardinality\": {\n        \"field\": \"job\"\n      }\n    }\n  }\n}\n\n\n# 对 性别的 keyword 进行聚合\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"gender\": {\n      \"terms\": {\n        \"field\":\"gender\"\n      }\n    }\n  }\n}\n\n\n#指定 bucket 的 size\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"ages_5\": {\n      \"terms\": {\n        \"field\":\"age\",\n        \"size\":3\n      }\n    }\n  }\n}\n\n\n\n# 指定size，不同工种中，年纪最大的3个员工的具体信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      },\n      \"aggs\":{\n        \"old_employee\":{\n          \"top_hits\":{\n            \"size\":3,\n            \"sort\":[\n              {\n                \"age\":{\n                  \"order\":\"desc\"\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\n#Salary Ranges 分桶，可以自己定义 key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_range\": {\n      \"range\": {\n        \"field\":\"salary\",\n        \"ranges\":[\n          {\n            \"to\":10000\n          },\n          {\n            \"from\":10000,\n            \"to\":20000\n          },\n          {\n            \"key\":\">20000\",\n            \"from\":20000\n          }\n        ]\n      }\n    }\n  }\n}\n\n\n#Salary Histogram,工资0到10万，以 5000一个区间进行分桶\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_histrogram\": {\n      \"histogram\": {\n        \"field\":\"salary\",\n        \"interval\":5000,\n        \"extended_bounds\":{\n          \"min\":0,\n          \"max\":100000\n\n        }\n      }\n    }\n  }\n}\n\n\n# 嵌套聚合1，按照工作类型分桶，并统计工资信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_salary_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"salary\": {\n          \"stats\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n# 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_gender_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"gender_stats\": {\n          \"terms\": {\n            \"field\": \"gender\"\n          },\n          \"aggs\": {\n            \"salary_stats\": {\n              \"stats\": {\n                \"field\": \"salary\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\n\n# 6.2-Pipeline聚合分析.md\n\n# Pipeline 聚合分析\n```\nDELETE employees\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n\n\n# 平均工资最低的工作类型\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"min_salary_by_job\":{\n      \"min_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资最高的工作类型\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"max_salary_by_job\":{\n      \"max_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的平均工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"avg_salary_by_job\":{\n      \"avg_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的统计分析\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"stats_salary_by_job\":{\n      \"stats_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的百分位数\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"percentiles_salary_by_job\":{\n      \"percentiles_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n\n#按照年龄对平均工资求导\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"derivative_avg_salary\":{\n          \"derivative\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#Cumulative_sum\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"cumulative_salary\":{\n          \"cumulative_sum\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n#Moving Function\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"moving_avg_salary\":{\n          \"moving_fn\": {\n            \"buckets_path\": \"avg_salary\",\n            \"window\":10,\n            \"script\": \"MovingFunctions.min(values)\"\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\n# 6.3-作用范围与排序.md\n\n# 作用范围与排序\n```\nDELETE /employees\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n\n\n# Query\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    }\n  }\n}\n\n\n#Filter\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"older_person\": {\n      \"filter\":{\n        \"range\":{\n          \"age\":{\n            \"from\":35\n          }\n        }\n      },\n      \"aggs\":{\n         \"jobs\":{\n           \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n      }\n    }},\n    \"all_jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    }\n  }\n}\n\n\n\n#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果\nPOST employees/_search\n{\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      }\n    }\n  },\n  \"post_filter\": {\n    \"match\": {\n      \"job.keyword\": \"Dev Manager\"\n    }\n  }\n}\n\n\n#global\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 40\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    },\n    \n    \"all\":{\n      \"global\":{},\n      \"aggs\":{\n        \"salary_avg\":{\n          \"avg\":{\n            \"field\":\"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[\n          {\"_count\":\"asc\"},\n          {\"_key\":\"desc\"}\n          ]\n        \n      }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"avg_salary\":\"desc\"\n          }]\n        \n        \n      },\n    \"aggs\": {\n      \"avg_salary\": {\n        \"avg\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"stats_salary.min\":\"desc\"\n          }]\n        \n        \n      },\n    \"aggs\": {\n      \"stats_salary\": {\n        \"stats\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n```\n\n# 6.4-聚合分析的原理及精准度问题.md\n\n# 聚合分析的原理及精准度问题\n```\nDELETE my_flights\nPUT my_flights\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  },\n  \"mappings\" : {\n      \"properties\" : {\n        \"AvgTicketPrice\" : {\n          \"type\" : \"float\"\n        },\n        \"Cancelled\" : {\n          \"type\" : \"boolean\"\n        },\n        \"Carrier\" : {\n          \"type\" : \"keyword\"\n        },\n        \"Dest\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"DestRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DistanceKilometers\" : {\n          \"type\" : \"float\"\n        },\n        \"DistanceMiles\" : {\n          \"type\" : \"float\"\n        },\n        \"FlightDelay\" : {\n          \"type\" : \"boolean\"\n        },\n        \"FlightDelayMin\" : {\n          \"type\" : \"integer\"\n        },\n        \"FlightDelayType\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightNum\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeHour\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeMin\" : {\n          \"type\" : \"float\"\n        },\n        \"Origin\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"OriginRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"dayOfWeek\" : {\n          \"type\" : \"integer\"\n        },\n        \"timestamp\" : {\n          \"type\" : \"date\"\n        }\n      }\n    }\n}\n\n\nPOST _reindex\n{\n  \"source\": {\n    \"index\": \"kibana_sample_data_flights\"\n  },\n  \"dest\": {\n    \"index\": \"my_flights\"\n  }\n}\n\nGET kibana_sample_data_flights/_count\nGET my_flights/_count\n\nget kibana_sample_data_flights/_search\n\n\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":5,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n\n\nGET my_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":1,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n\n```\n# 7.1-对象及 Nested 对象.md\n\n# 对象及Nested对象\n```\nDELETE blog\n# 设置blog的 Mapping\nPUT /blog\n{\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"time\": {\n        \"type\": \"date\"\n      },\n      \"user\": {\n        \"properties\": {\n          \"city\": {\n            \"type\": \"text\"\n          },\n          \"userid\": {\n            \"type\": \"long\"\n          },\n          \"username\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n# 插入一条 Blog 信息\nPUT blog/_doc/1\n{\n  \"content\":\"I like Elasticsearch\",\n  \"time\":\"2019-01-01T00:00:00\",\n  \"user\":{\n    \"userid\":1,\n    \"username\":\"Jack\",\n    \"city\":\"Shanghai\"\n  }\n}\n\n\n# 查询 Blog 信息\nPOST blog/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"content\": \"Elasticsearch\"}},\n        {\"match\": {\"user.username\": \"Jack\"}}\n      ]\n    }\n  }\n}\n\n\nDELETE my_movies\n\n# 电影的Mapping信息\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"properties\" : {\n            \"first_name\" : {\n              \"type\" : \"keyword\"\n            },\n            \"last_name\" : {\n              \"type\" : \"keyword\"\n            }\n          }\n        },\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n}\n\n\n# 写入一条电影信息\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n\n# 查询电影信息\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"actors.first_name\": \"Keanu\"}},\n        {\"match\": {\"actors.last_name\": \"Hopper\"}}\n      ]\n    }\n  }\n\n}\n\nDELETE my_movies\n# 创建 Nested 对象 Mapping\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"type\": \"nested\",\n          \"properties\" : {\n            \"first_name\" : {\"type\" : \"keyword\"},\n            \"last_name\" : {\"type\" : \"keyword\"}\n          }},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\"keyword\":{\"type\":\"keyword\",\"ignore_above\":256}}\n        }\n      }\n    }\n}\n\n\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n\n# Nested 查询\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"Speed\"}},\n        {\n          \"nested\": {\n            \"path\": \"actors\",\n            \"query\": {\n              \"bool\": {\n                \"must\": [\n                  {\"match\": {\n                    \"actors.first_name\": \"Keanu\"\n                  }},\n\n                  {\"match\": {\n                    \"actors.last_name\": \"Hopper\"\n                  }}\n                ]\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n\n\n# Nested Aggregation\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"actors\": {\n      \"nested\": {\n        \"path\": \"actors\"\n      },\n      \"aggs\": {\n        \"actor_name\": {\n          \"terms\": {\n            \"field\": \"actors.first_name\",\n            \"size\": 10\n          }\n        }\n      }\n    }\n  }\n}\n\n\n# 普通 aggregation不工作\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"NAME\": {\n      \"terms\": {\n        \"field\": \"actors.first_name\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n```\n\n# 7.2-文档的父子关系.md\n\n# 文档的父子关系\n```\nDELETE my_blogs\n\n# 设定 Parent/Child Mapping\nPUT my_blogs\n{\n  \"settings\": {\n    \"number_of_shards\": 2\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"blog_comments_relation\": {\n        \"type\": \"join\",\n        \"relations\": {\n          \"blog\": \"comment\"\n        }\n      },\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"title\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n\n\n#索引父文档\nPUT my_blogs/_doc/blog1\n{\n  \"title\":\"Learning Elasticsearch\",\n  \"content\":\"learning ELK @ geektime\",\n  \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n#索引父文档\nPUT my_blogs/_doc/blog2\n{\n  \"title\":\"Learning Hadoop\",\n  \"content\":\"learning Hadoop\",\n    \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n\n#索引子文档\nPUT my_blogs/_doc/comment1?routing=blog1\n{\n  \"comment\":\"I am learning ELK\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog1\"\n  }\n}\n\n#索引子文档\nPUT my_blogs/_doc/comment2?routing=blog2\n{\n  \"comment\":\"I like Hadoop!!!!!\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog2\"\n  }\n}\n\n#索引子文档\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n  \"comment\":\"Hello Hadoop\",\n  \"username\":\"Bob\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog2\"\n  }\n}\n\n# 查询所有文档\nPOST my_blogs/_search\n{\n\n}\n\n\n#根据父文档ID查看\nGET my_blogs/_doc/blog2\n\n# Parent Id 查询\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"parent_id\": {\n      \"type\": \"comment\",\n      \"id\": \"blog2\"\n    }\n  }\n}\n\n# Has Child 查询,返回父文档\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"comment\",\n      \"query\" : {\n                \"match\": {\n                    \"username\" : \"Jack\"\n                }\n            }\n    }\n  }\n}\n\n\n# Has Parent 查询，返回相关的子文档\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_parent\": {\n      \"parent_type\": \"blog\",\n      \"query\" : {\n                \"match\": {\n                    \"title\" : \"Learning Hadoop\"\n                }\n            }\n    }\n  }\n}\n\n\n\n#通过ID ，访问子文档\nGET my_blogs/_doc/comment3\n#通过ID和routing ，访问子文档\nGET my_blogs/_doc/comment3?routing=blog2\n\n#更新子文档\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n    \"comment\": \"Hello Hadoop??\",\n    \"blog_comments_relation\": {\n      \"name\": \"comment\",\n      \"parent\": \"blog2\"\n    }\n}\n\n\n```\n\n# 7.5-Elasticsearch数据建模实例.md\n\n# Elasticsearch 数据建模实例\n```\n###### Data Modeling Example\n\n# Index 一本书的信息\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n\n\n\n#查询自动创建的Mapping\nGET books/_mapping\n\nDELETE books\n\n#优化字段类型\nPUT books\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\"},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false},\n        \"description\" : {\"type\" : \"text\"},\n        \"public_date\" : {\"type\" : \"date\"},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          }\n        }\n      }\n    }\n}\n\n#Cover URL index 设置成false，无法对该字段进行搜索\nPOST books/_search\n{\n  \"query\": {\n    \"term\": {\n      \"cover_url\": {\n        \"value\": \"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n      }\n    }\n  }\n}\n\n#Cover URL index 设置成false，依然支持聚合分析\nPOST books/_search\n{\n  \"aggs\": {\n    \"cover\": {\n      \"terms\": {\n        \"field\": \"cover_url\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n\nDELETE books\n#新增 Content字段。数据量很大。选择将Source 关闭\nPUT books\n{\n      \"mappings\" : {\n      \"_source\": {\"enabled\": false},\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\",\"store\": true},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false,\"store\": true},\n        \"description\" : {\"type\" : \"text\",\"store\": true},\n         \"content\" : {\"type\" : \"text\",\"store\": true},\n        \"public_date\" : {\"type\" : \"date\",\"store\": true},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          },\n          \"store\": true\n        }\n      }\n    }\n}\n\n\n# Index 一本书的信息,包含Content\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins\",\n  \"content\":\"The content of the book......Indexing data, aggregation, searching.    something else. something in the way............\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n\n#查询结果中，Source不包含数据\nPOST books/_search\n{}\n\n#搜索，通过store 字段显示数据，同时高亮显示 conent的内容\nPOST books/_search\n{\n  \"stored_fields\": [\"title\",\"author\",\"public_date\"],\n  \"query\": {\n    \"match\": {\n      \"content\": \"searching\"\n    }\n  },\n\n  \"highlight\": {\n    \"fields\": {\n      \"content\":{}\n    }\n  }\n\n}\n\n```\n# 7.6-Elasticsearch 数据建模最佳实践.md\n\n# Elasticsearch 数据建模最佳实践\n\n\n```\n\n###### Cookie Service\n\n##索引数据，dynamic mapping 会不断加入新增字段\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":{\n   \"username\":\"tom\",\n   \"age\":32\n }\n}\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":{\n   \"login\":\"2019-01-01\",\n   \"email\":\"xyz@abc.com\"\n }\n}\n\n\nDELETE cookie_service\n#使用 Nested 对象，增加key/value\nPUT cookie_service\n{\n  \"mappings\": {\n    \"properties\": {\n      \"cookies\": {\n        \"type\": \"nested\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"keyword\"\n          },\n          \"dateValue\": {\n            \"type\": \"date\"\n          },\n          \"keywordValue\": {\n            \"type\": \"keyword\"\n          },\n          \"IntValue\": {\n            \"type\": \"integer\"\n          }\n        }\n      },\n      \"url\": {\n        \"type\": \"text\",\n        \"fields\": {\n          \"keyword\": {\n            \"type\": \"keyword\",\n            \"ignore_above\": 256\n          }\n        }\n      }\n    }\n  }\n}\n\n\n##写入数据，使用key和合适类型的value字段\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":[\n    {\n      \"name\":\"username\",\n      \"keywordValue\":\"tom\"\n    },\n    {\n       \"name\":\"age\",\n      \"intValue\":32\n\n    }\n\n   ]\n }\n\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":[\n    {\n      \"name\":\"login\",\n      \"dateValue\":\"2019-01-01\"\n    },\n    {\n       \"name\":\"email\",\n      \"IntValue\":32\n\n    }\n\n   ]\n }\n\n\n# Nested 查询，通过bool查询进行过滤\nPOST cookie_service/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"cookies\",\n      \"query\": {\n        \"bool\": {\n          \"filter\": [\n            {\n            \"term\": {\n              \"cookies.name\": \"age\"\n            }},\n            {\n              \"range\":{\n                \"cookies.intValue\":{\n                  \"gte\":30\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  }\n}\n\n\n\n# 在Mapping中加入元信息，便于管理\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.0\"\n    }\n  }\n}\n\nGET softwares/_mapping\nPUT softwares/_doc/1\n{\n  \"software_version\":\"7.1.0\"\n}\n\nDELETE softwares\n# 优化,使用inner object\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.1\"\n    },\n    \"properties\": {\n      \"version\": {\n        \"properties\": {\n          \"display_name\": {\n            \"type\": \"keyword\"\n          },\n          \"hot_fix\": {\n            \"type\": \"byte\"\n          },\n          \"marjor\": {\n            \"type\": \"byte\"\n          },\n          \"minor\": {\n            \"type\": \"byte\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#通过 Inner Object 写入多个文档\nPUT softwares/_doc/1\n{\n  \"version\":{\n  \"display_name\":\"7.1.0\",\n  \"marjor\":7,\n  \"minor\":1,\n  \"hot_fix\":0  \n  }\n\n}\n\nPUT softwares/_doc/2\n{\n  \"version\":{\n  \"display_name\":\"7.2.0\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":0  \n  }\n}\n\nPUT softwares/_doc/3\n{\n  \"version\":{\n  \"display_name\":\"7.2.1\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":1  \n  }\n}\n\n\n# 通过 bool 查询，\nPOST softwares/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\n          \"match\":{\n            \"version.marjor\":7\n          }\n        },\n        {\n          \"match\":{\n            \"version.minor\":2\n          }\n        }\n\n      ]\n    }\n  }\n}\n\n\n\n\n# Not Null 解决聚合的问题\nDELETE ratings\nPUT ratings\n{\n  \"mappings\": {\n      \"properties\": {\n        \"rating\": {\n          \"type\": \"float\",\n          \"null_value\": 1.0\n        }\n      }\n    }\n}\n\n\nPUT ratings/_doc/1\n{\n \"rating\":5\n}\nPUT ratings/_doc/2\n{\n \"rating\":null\n}\n\n\nPOST ratings/_search\nPOST ratings/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"avg\": {\n      \"avg\": {\n        \"field\": \"rating\"\n      }\n    }\n  }\n}\n\nPOST ratings/_search\n{\n  \"query\": {\n    \"term\": {\n      \"rating\": {\n        \"value\": 1\n      }\n    }\n  }\n}\n\n```\n\n\n\n# 7.7-第二部分总结与测验.md\n\n# 第二部分总结与测验\n```\nDELETE test\nPUT test/_doc/1\n{\n  \"content\":\"Hello World\"\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n\n\n```\n\n\n# 8.1-集群身份认证与用户鉴权.md\n\n# 集群身份认证与用户鉴权\n- 如何为集群启用X-Pack Security\n- 如何为内置用户设置密码\n- 设置 Kibana与ElasticSearch通信鉴权\n- 使用安全API创建对特定索引具有有限访问权限的用户\n\nThis tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:\n\ndiscovery.type: single-node\n\n```\n#启动单节点\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true\n\n#使用Curl访问ES，或者浏览器访问 “localhost:9200/_cat/nodes?pretty”。返回401错误\ncurl 'localhost:9200/_cat/nodes?pretty'\n\n#运行密码设定的命令，设置ES内置用户及其初始密码。\nbin/elasticsearch-setup-passwords interactive\n\ncurl -u elastic 'localhost:9200/_cat/nodes?pretty'\n\n\n# 修改 kibana.yml\nelasticsearch.username: \"kibana\"\nelasticsearch.password: \"changeme\"\n\n#启动。使用用户名，elastic，密码elastic\n./bin/kibana\n\n\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n\n\n#create a new role named read_only_orders, that satisfies the following criteria:\n#The role has no cluster privileges\n#The role only has access to indices that match the pattern sales_record\n#The index privileges are read, and view_index_metadata\n\n\n#create sales_user that satisfies the following criteria:\n# Use your own email address\n# Assign the user to two roles: read_only_orders and kibana_user\n\n\n#验证读权限,可以执行\nPOST orders/_search\n{}\n\n#验证写权限,报错\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n\n\n```\n\n# 8.2-集群内部安全通信.md\n\n#\n\n```\n# 生成证书\n# 为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：\nbin/elasticsearch-certutil ca\n\n#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：\nbin/elasticsearch-certutil cert --ca elastic-stack-ca.p12\n\n#将证书拷贝到 config/certs目录下\nelastic-certificates.p12\n\n\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12\n\nbin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12\n\n\n#不提供证书的节点，无法加入\nbin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E http.port=9202 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate\n\n\n```\n\n\n```\n## elasticsearch.yml 配置\n\n#xpack.security.transport.ssl.enabled: true\n#xpack.security.transport.ssl.verification_mode: certificate\n\n#xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12\n#xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12\n\n\n```\n\n# 8.3-集群与外部间的安全通信.md\n\n\n\n```\nxpack.security.http.ssl.enabled: true\nxpack.security.http.ssl.keystore.path: certs/elastic-certificates.p12\nxpack.security.http.ssl.truststore.path: certs/elastic-certificates.p12\n\n```\n```\n\n\n# ES 启用 https\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12\n\n```\n\n```\n#Kibana 连接 ES https\n\n\n\n# 为kibana生成pem\nopenssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem\n\n\nelasticsearch.hosts: [\"https://localhost:9200\"]\nelasticsearch.ssl.certificateAuthorities: [ \"/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem\" ]\nelasticsearch.ssl.verificationMode: certificate\n\n\n\n# 为 Kibna 配置 HTTPS\n# 生成后解压，包含了instance.crt 和 instance.key\nbin/elasticsearch-certutil ca --pem\n\nserver.ssl.enabled: true\nserver.ssl.certificate: config/certs/instance.crt\nserver.ssl.key: config/certs/instance.key\n\n\n```\n\n\n\n# 9.1-常见的集群部署方式.md\n\n# 常见的集群部署方式\n\n\n# 9.2-Hot&Warm架构与ShardFiltering.md\n\n# Hot & Warm 架构与 Shard Filtering\n## 课程代码\n```\n# 标记一个 Hot 节点\nbin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot\n\n# 标记一个 warm 节点\nbin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm\n\n# 查看节点\nGET /_cat/nodeattrs?v\n\n# 配置到 Hot节点\nPUT logs-2019-06-27\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.my_node_type\":\"hot\"\n  }\n}\n\n\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\n\nGET _cat/shards?v\n\n\n# 配置到 warm 节点\nPUT PUT logs-2019-06-27/_settings\n{  \n  \"index.routing.allocation.require.my_node_type\":\"warm\"\n}\n\n\n# 标记一个 rack 1\nbin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# 标记一个 rack 2\nbin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\"\n  }\n}\n\nPUT my_index1\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1\n  }\n}\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\nGET _cat/shards?v\nDELETE my_index1/_doc/1\n\n\n\n# Fore awareness\n# 标记一个 rack 1\nbin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# 标记一个 rack 2\nbin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1\n\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\",\n    \"cluster.routing.allocation.awareness.force.my_rack_id.values\": \"rack1,rack2\"\n  }\n}\nGET _cluster/settings\n\n# 集群黄色\nGET _cluster/health\n\n# 副本无法分配\nGET _cat/shards?v\n\n\nGET _cluster/allocation/explain?pretty\n```\n# 9.3-如何对集群进行容量规划.md\n\n# 如何对集群进行容量规划\n## 代码Demo\n\n```\nPUT logs_2019-06-27\nPUT logs_2019-06-26\n\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"logs_2019-06-27\",\n        \"alias\": \"logs_write\"\n      }\n    },\n    {\n      \"remove\": {\n        \"index\": \"logs_2019-06-26\",\n        \"alias\": \"logs_write\"\n      }\n    }\n  ]\n}\n\n\n# POST /<logs-{now/d}/_search\nPOST /%3Clogs-%7Bnow%2Fd%7D%3E/_search\n\n# POST /<logs-{now/w}/_search\nPOST /%3Clogs-%7Bnow%2Fw%7D%3E/_search\n\n```\n\n# 9.4-分片设计及管理.md\n\n# 分片设计及管理\n\n# 9.5-在私有云上管理与部署Elasticsearch集群.md\n\n# 在私有云上管理与部署 Elasticsearch 集群\n\n# 9.6-在公有云上管理与部署Elasticsearch集群.md\n\n# 在公有云上管理与部署 Elasticsearch 集群\n\n# result.md\n\n# 10.1-生产环境常用配置与上线清单.md\n\n# 生产环境查用配置与线上清单\n\n# 10.10-一些运维相关的建议.md\n\n# 一些运维相关的建议\n```\n# 移动一个分片从一个节点到另外一个节点\n\nPOST _cluster/reroute\n{\n  \"commands\": [\n    {\n      \"move\": {\n        \"index\": \"index_name\",\n        \"shard\": 0,\n        \"from_node\": \"node_name_1\",\n        \"to_node\": \"node_name_2\"\n      }\n    }\n  ]\n}\n\n\n# Fore the allocation of an unassinged shard with a reason\n\nPOST _cluster/reroute?explain\n{\n  \"commands\": [\n    {\n      \"allocate\": {\n        \"index\": \"index_name\",\n        \"shard\": 0,\n        \"node\": \"nodename\"\n      }\n    }\n  ]\n}\n\n\n# remove the nodes from cluster \nPUT _cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.exclude._ip\":\"the_IP_of_your_node\"\n  }\n}\n\n# Force a synced flush\nPOST _flush/synced\n\n\n# change the number of moving shards to balance the cluster\nPUT /_cluster/settings\n{\n  \"transient\": {\"cluster.routing.allocation.cluster_concurrent_rebalance\":2}\n}\n\n# change the number of shards being recovered simultanceously per node\nPUT _cluster/settings\n{\n  \"transient\": {\"cluster.routing.allocation.node_concurrent_recoveries\":5}\n}\n\n# Change the recovery speed\nPUT /_cluster/settings\n{\n  \"transient\": {\"indices.recovery.max_bytes_per_sec\": \"80mb\"}\n}\n\n# Change the number of concurrent streams for a recovery on a single node\nPUT _cluster/settings\n{\n  \"transient\": {\"indices.recovery.concurrent_streams\":6}\n}\n\n\n# Change the sinze of the search queue\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"threadpool.search.queue_size\":2000\n  }\n}\n\n# Clear the cache on a node\nPOST _cache/clear\n\n\n#Adjust the circuit breakers\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.breaker.total.limit\":\"40%\"\n  }\n}\n\n\n```\n\n# 10.2-监控Elasticsearch集群.md\n\n# 监控 Elasticsearch 集群\n```\n# Node Stats：\nGET _nodes/stats\n\n#Cluster Stats:\nGET _cluster/stats\n\n#Index Stats:\nGET kibana_sample_data_ecommerce/_stats\n\n#Pending Cluster Tasks API:\nGET _cluster/pending_tasks\n\n# 查看所有的 tasks，也支持 cancel task\nGET _tasks\n\n\nGET _nodes/thread_pool\nGET _nodes/stats/thread_pool\nGET _cat/thread_pool?v\nGET _nodes/hot_threads\nGET _nodes/stats/thread_pool\n\n\n# 设置 Index Slowlogs\n# the first 1000 characters of the doc's source will be logged\nPUT my_index/_settings\n{\n  \"index.indexing.slowlog\":{\n    \"threshold.index\":{\n      \"warn\":\"10s\",\n      \"info\": \"4s\",\n      \"debug\":\"2s\",\n      \"trace\":\"0s\"\n    },\n    \"level\":\"trace\",\n    \"source\":1000  \n  }\n}\n\n# 设置查询\nDELETE my_index\n//\"0\" logs all queries\nPUT my_index/\n{\n  \"settings\": {\n    \"index.search.slowlog.threshold\": {\n      \"query.warn\": \"10s\",\n      \"query.info\": \"3s\",\n      \"query.debug\": \"2s\",\n      \"query.trace\": \"0s\",\n      \"fetch.warn\": \"1s\",\n      \"fetch.info\": \"600ms\",\n      \"fetch.debug\": \"400ms\",\n      \"fetch.trace\": \"0s\"\n    }\n  }\n}\n\nGET my_index\n\n\n```\n\n# 10.3-诊断集群的潜在问题.md\n\n# 诊断集群的潜在问题\n# 10.4-解决集群Yellow与Red的问题.md\n\n# 集群健康与问题排查\n```\n#案例1\nDELETE mytest\nPUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":3,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.box_type\":\"hott\"\n  }\n}\n\n\n\n\n\n# 检查集群状态，查看是否有节点丢失，有多少分片无法分配\nGET /_cluster/health/\n\n# 查看索引级别,找到红色的索引\nGET /_cluster/health?level=indices\n\n\n#查看索引的分片\nGET _cluster/health?level=shards\n\n# Explain 变红的原因\nGET /_cluster/allocation/explain\n\nGET /_cat/shards/mytest\nGET _cat/nodeattrs\n\nDELETE mytest\nGET /_cluster/health/\n\nPUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":3,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.box_type\":\"hot\"\n  }\n}\n\nGET /_cluster/health/\n\n#案例2, Explain 看 hot 上的 explain\nDELETE mytest\nPUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1,\n    \"index.routing.allocation.require.box_type\":\"hot\"\n  }\n}\n\nGET _cluster/health\nGET _cat/shards/mytest\nGET /_cluster/allocation/explain\n\nPUT mytest/_settings\n{\n    \"number_of_replicas\": 0\n}\n\n```\n\n# 10.5-提升集群写性能.md\n\n# 提升集群写性能\n```\nDELETE myindex\nPUT myindex\n{\n  \"settings\": {\n    \"index\": {\n      \"refresh_interval\": \"30s\",\n      \"number_of_shards\": \"2\"\n    },\n    \"routing\": {\n      \"allocation\": {\n        \"total_shards_per_node\": \"3\"\n      }\n    },\n    \"translog\": {\n      \"sync_interval\": \"30s\",\n      \"durability\": \"async\"\n    },\n    \"number_of_replicas\": 0\n  },\n  \"mappings\": {\n    \"dynamic\": false,\n    \"properties\": {}\n  }\n}\n```\n\n# 10.6-提升集群读性能.md\n\n# 提升集群读性能\n```\nPUT blogs/_doc/1\n{\n  \"title\":\"elasticsearch\"\n}\nGET blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\n          \"title\": \"elasticsearch\"\n        }}\n      ],\n      \n      \"filter\": {\n        \"script\": {\n          \"script\": {\n            \"source\": \"doc['title.keyword'].value.length()>5\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nGET blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"elasticsearch\"}},\n        {\n          \"range\": {\n            \"publish_date\": {\n              \"gte\": 2017,\n              \"lte\": 2019\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\n# 10.7-集群压力测试.md\n\n# 集群压力测试\n```\npip3 install esrally\n\nesrally configure\n\n# 只测试 1000条数据\nesrally --distribution-version=7.1.0 --test-mode\n\n# 测试完整数据\nesrally --distribution-version=7.1.0\n\n```\n- https://github.com/elastic/rally-tracks\n- https://logz.io/blog/rally/\n\n\n# 10.9-缓存及使用Breaker限制内存使用.md\n\n# 缓存及使用Circuit Breaker限制内存使用\n```\nGET _cat/nodes?v\n\nGET _nodes/stats/indices?pretty\n\nGET _cat/nodes?v&h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count\n\nGET _cat/nodes?h=name,port,segments.memory,segments.index_writer_memory,fielddata.memory_size,query_cache.memory_size,request_cache.memory_size&v\n\n\nPUT /_cluster/settings\n{\n    \"persistent\" : {\n       \"indices.breaker.request.limit\" : \"90%\"\n    }\n}\n\n```\n## 补充阅读\n- https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker\n\n\n# 11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md\n\n# 使用 shrink与rolloverAPI有效的管理索引\n```\n\n\n# 打开关闭索引\nDELETE test\n#查看索引是否存在\nHEAD test\n\nPUT test/_doc/1\n{\n  \"key\":\"value\"\n}\n\n#关闭索引\nPOST /test/_close\n#索引存在\nHEAD test\n# 无法查询\nPOST test/_count\n\n#打开索引\nPOST /test/_open\nPOST test/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\nPOST test/_count\n\n\n# 在一个 hot-warm-cold的集群上进行测试\nGET _cat/nodes\nGET _cat/nodeattrs\n\nDELETE my_source_index\nDELETE my_target_index\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\nGET _cat/shards/my_source_index\n\n# 分片数3，会失败\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 3,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\n\n\n# 报错，因为没有置成 readonly\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\n#将 my_source_index 设置为只读\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n# 报错，必须都在一个节点\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\nDELETE my_source_index\n## 确保分片都在 hot\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0,\n   \"index.routing.allocation.include.box_type\":\"hot\"\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\nGET _cat/shards/my_source_index\n\n#设置为只读\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\n\nGET _cat/shards/my_target_index\n\n# My target_index状态为也只读\nPUT my_target_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\n\n# Split Index\nDELETE my_source_index\nDELETE my_target_index\n\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\nGET _cat/shards/my_source_index\n\n# 必须是倍数\nPOST my_source_index/_split/my_target\n{\n  \"settings\": {\n    \"index.number_of_shards\": 10\n  }\n}\n\n# 必须是只读\nPOST my_source_index/_split/my_target\n{\n  \"settings\": {\n    \"index.number_of_shards\": 8\n  }\n}\n\n\n#设置为只读\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n\nPOST my_source_index/_split/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_shards\": 8,\n    \"index.number_of_replicas\":0\n  }\n}\n\nGET _cat/shards/my_target_index\n\n\n\n# write block\nPUT my_target_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\n\n#Rollover API\nDELETE nginx-logs*\n# 不设定 is_write_true\n# 名字符合命名规范\nPUT /nginx-logs-000001\n{\n  \"aliases\": {\n    \"nginx_logs_write\": {}\n  }\n}\n\n# 多次写入文档\nPOST nginx_logs_write/_doc\n{\n  \"log\":\"something\"\n}\n\n\nPOST /nginx_logs_write/_rollover\n{\n  \"conditions\": {\n    \"max_age\":   \"1d\",\n    \"max_docs\":  5,\n    \"max_size\":  \"5gb\"\n  }\n}\n\nGET /nginx_logs_write/_count\n# 查看 Alias信息\nGET /nginx_logs_write\n\n\nDELETE apache-logs*\n\n\n# 设置 is_write_index\nPUT apache-logs1\n{\n  \"aliases\": {\n    \"apache_logs\": {\n      \"is_write_index\":true\n    }\n  }\n}\nPOST apache_logs/_count\n\nPOST apache_logs/_doc\n{\n  \"key\":\"value\"\n}\n\n# 需要指定 target 的名字\nPOST /apache_logs/_rollover/apache-logs8xxxx\n{\n  \"conditions\": {\n    \"max_age\":   \"1d\",\n    \"max_docs\":  1,\n    \"max_size\":  \"5gb\"\n  }\n}\n\n\n# 查看 Alias信息\nGET /apache_logs\n\n\n```\n\n# 11.2-索引全生命周期管理及工具介绍.md\n\n# 索引全生命周期管理及工具介绍\n```\n\n# 运行三个节点，分片 将box_type设置成 hot，warm和cold\n# 具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件\n\n\n\nDELETE *\n\n\n\n# 设置 1秒刷新1次，生产环境10分种刷新一次\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.lifecycle.poll_interval\":\"1s\"\n  }\n}\n\n# 设置 Policy\nPUT /_ilm/policy/log_ilm_policy\n{\n  \"policy\": {\n    \"phases\": {\n      \"hot\": {\n        \"actions\": {\n          \"rollover\": {\n            \"max_docs\": 5\n          }\n        }\n      },\n      \"warm\": {\n        \"min_age\": \"10s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"warm\"\n            }\n          }\n        }\n      },\n      \"cold\": {\n        \"min_age\": \"15s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"cold\"\n            }\n          }\n        }\n      },\n      \"delete\": {\n        \"min_age\": \"20s\",\n        \"actions\": {\n          \"delete\": {}\n        }\n      }\n    }\n  }\n}\n\n\n\n# 设置索引模版\nPUT /_template/log_ilm_template\n{\n  \"index_patterns\" : [\n      \"ilm_index-*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"lifecycle\" : {\n          \"name\" : \"log_ilm_policy\",\n          \"rollover_alias\" : \"ilm_alias\"\n        },\n        \"routing\" : {\n          \"allocation\" : {\n            \"include\" : {\n              \"box_type\" : \"hot\"\n            }\n          }\n        },\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"0\"\n      }\n    },\n    \"mappings\" : { },\n    \"aliases\" : { }\n}\n\n\n\n#创建索引\nPUT ilm_index-000001\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0,\n    \"index.lifecycle.name\": \"log_ilm_policy\",\n    \"index.lifecycle.rollover_alias\": \"ilm_alias\",\n    \"index.routing.allocation.include.box_type\":\"hot\"\n  },\n  \"aliases\": {\n    \"ilm_alias\": {\n      \"is_write_index\": true\n    }\n  }\n}\n\n# 对 Alias写入文档\nPOST  ilm_alias/_doc\n{\n  \"dfd\":\"dfdsf\"\n}\n\n```\n\n# 12.1-Logstash入门及架构介绍.md\n\n# Logstash 入门及架构介绍\n```\n\n\n# 一个 Demo， demo 运行\nsudo bin/logstash -f logstash-filter.conf\n\n# demo数据\n127.0.0.1 - - [11/Dec/2013:00:01:45 -0800] \"GET /xampp/status.php HTTP/1.1\" 200 3891 \"http://cadenza/xampp/navi.php\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0\"\n\n\n# codec demo\n\n\nsudo bin/logstash -e \"input{stdin{codec=>line}}output{stdout{codec=> rubydebug}}\"\nsudo bin/logstash -e \"input{stdin{codec=>json}}output{stdout{codec=> rubydebug}}\"\nsudo bin/logstash -e \"input{stdin{codec=>line}}output{stdout{codec=> dots}}\"\n\n\nsudo bin/logstash -f multiline-exception.conf\n\n# 多行数据，异常\nException in thread \"main\" java.lang.NullPointerException\n        at com.example.myproject.Book.getTitle(Book.java:16)\n        at com.example.myproject.Author.getBookTitles(Author.java:25)\n        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\n\n\n\n# 一个实例\nhttps://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf\n\n```\n\n\n# 12.2-利用JDBC插件导入数据到Elasticsearch.md\n\n# Logstash插件及文档介绍\n```\nhttps://spring.io/guides/gs/accessing-data-mysql/\ncreate database db_example;\nuse db_example;\nshow tables;\ndrop table user;\nselect * from user;\n\n\n\n# 新增用户\ncurl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ\ncurl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ\ncurl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ\n\n#查看所有的用户\ncurl 'localhost:8080/demo/all'\n\n# 更新用户\ncurl -X PUT localhost:8080/demo/update -d id=16 -d name=Bob2 -d email=bob2@xyz.com -d tags=Mysql,IntelliJ\n\n# 删除用户\ncurl -X DELETE localhost:8080/demo/delete -d id=15\n\n\n\nmysql-demo.conf\n\n# 创建 alias，只显示没有被标记 deleted的用户\nPOST /_aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"users\",\n        \"alias\": \"view_users\",\n         \"filter\" : { \"term\" : { \"is_deleted\" : false } }\n      }\n    }\n  ]\n}\n\n# 通过 Alias查询，查不到被标记成 deleted的用户\nPOST view_users/_search\n{\n\n}\n\n\nPOST view_users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"Jack\"\n      }\n    }\n  }\n}\n\nPOST users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"Jack\"\n      }\n    }\n  }\n}\n\n```\n\n\n# 12.3-Beats介绍.md\n\n# Beats介绍\n```\n\n##\n# 查看 packetbeat 模块\n# 设置 packetbeat 的mysql 模块\n# 启动运行\n#\n./metricbeat modules list\n./metricbeat modules enable mysql\n./metricbeat setup --dashboards\n\n# 安装mysql\ncreate database db_example\nuse db_example;\nshow tables;\nselect * from user\n\ncurl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ\ncurl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ\ncurl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ\n\ncurl 'localhost:8080/demo/all'\n\n\n# 配置 packetbeat\n# 启动\n修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控\n\nsudo chown root packetbeat.yml\nsudo ./packetbeat setup --dashboards\nsudo ./packetbeat\n\n\n# 查看所有 Filebeat 模块\n# 查看所有的modules\n./filebeat modules list\n\n#\n./filebeat modules enable mysql\n\n```\n\n\n# 13.1-使用IndexPattern配置数据.md\n\n\n```\n\nlocalhost:5601/status\n\n\n\n\nPUT /logstash-2015.05.18\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\nPUT /logstash-2015.05.19\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /logstash-2015.05.20\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n# For Mac & Windows\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/_bulk?pretty' --data-binary @logs.jsonl\n\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\n\n\n#For Windows\nInvoke-RestMethod \"http://localhost:9200/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"logs.jsonl\"\n\n\n\nGET /_cat/indices?v\n\n```\n\n\n# 13.2-使用KibanaDiscover探索数据.md\n\n# 使用Kibana Discovery 探索数据\n```\n\n设置时间过滤器\n搜索你的数据\n根据字段进行过滤\n查看文档数据\n查看文档上下文\n暂时字段数据统计\nSave Query\n\n\n```\n\n\n# 13.3-基本可视化组件介绍.md\n\n# 基本可视化组件介绍\n```\n\nPUT /shakespeare\n{\n  \"mappings\": {\n    \"properties\": {\n    \"speaker\": {\"type\": \"keyword\"},\n    \"play_name\": {\"type\": \"keyword\"},\n    \"line_id\": {\"type\": \"integer\"},\n    \"speech_number\": {\"type\": \"integer\"}\n    }\n  }\n}\n\n\n# For Mac & Windows\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/shakespeare/_bulk?pretty' --data-binary @shakespeare.json\n\n#For Windows\nInvoke-RestMethod \"http://localhost:9200/bank/account/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"accounts.json\"\nInvoke-RestMethod \"http://localhost:9200/shakespeare/_bulk?pretty\" -Method Post -ContentType 'application/x-ndjson' -InFile \"shakespeare.json\"\n\n\n```\n\n\n# 13.4-构建Dashboard.md\n\n# 构建Dashboard\n```\n- 创建仪表潘\n- 加载仪表盘\n- 共享仪表盘\n\n```\n\n\n# 14.3用机器学习实现时序数据的异常检测-上.md\n\nmkdir server_metrics\ncd server_metrics\nwget https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz\ntar -xvf server_metrics.tar.gz\n\n\n# 14.5-用ELK进行日志管理.md\n\n# 用 ELK 来做日志管理\n```\n./filebeat modules list\n./filebeat modules enable system\n./filebeat modules enable elasticsearch\n\n\n## 进 modules.d 编辑相应的文件，修改log路径\n\n./filebeat setup –dashboards\n\n./filebeat export template | more\n\n./filebeat -e\n\n```\n\n# 14.6-用Canvas做数据演示.md\n\nPOST elasticoffee/_search\n{\n  \"size\": 0, \n  \"aggs\": {\n    \"by\": {\n      \"terms\": {\n        \"field\": \"beverage.keyword\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n# 4.1-基于词项和基于全文的搜索.md\n\n# 基于词项和基于全文的搜索\n\n\n```\nDELETE products\nPUT products\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  }\n}\n\n\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"productID\" : \"XHDK-A-1293-#fJ3\",\"desc\":\"iPhone\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"productID\" : \"KDKE-B-9947-#kL5\",\"desc\":\"iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"productID\" : \"JODL-X-1937-#pV7\",\"desc\":\"MBP\" }\n\nGET /products\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": {\n        //\"value\": \"iPhone\"\n        \"value\":\"iphone\"\n      }\n    }\n  }\n}\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc.keyword\": {\n        //\"value\": \"iPhone\"\n        //\"value\":\"iphone\"\n      }\n    }\n  }\n}\n\n\nPOST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n\nPOST /products/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n\n\n\n\nPOST /products/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n\n    }\n  }\n}\n\n\n#设置 position_increment_gap\nDELETE groups\nPUT groups\n{\n  \"mappings\": {\n    \"properties\": {\n      \"names\":{\n        \"type\": \"text\",\n        \"position_increment_gap\": 0\n      }\n    }\n  }\n}\n\nGET groups/_mapping\n\nPOST groups/_doc\n{\n  \"names\": [ \"John Water\", \"Water Smith\"]\n}\n\nPOST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": {\n        \"query\": \"Water Water\",\n        \"slop\": 100\n      }\n    }\n  }\n}\n\n\nPOST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": \"Water Smith\"\n    }\n  }\n}\n```\n\n# 4.10-综合排序：Function Score Query 优化算分.md\n\n# 综合排序：Function Score Query 优化算分\n```\nDELETE blogs\nPUT /blogs/_doc/1\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   0\n}\n\nPUT /blogs/_doc/2\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   100\n}\n\nPUT /blogs/_doc/3\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   1000000\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\"\n      }\n    }\n  }\n}\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\"\n      }\n    }\n  }\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      }\n    }\n  }\n}\n\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      },\n      \"boost_mode\": \"sum\",\n      \"max_boost\": 3\n    }\n  }\n}\n\nPOST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"random_score\": {\n        \"seed\": 911119\n      }\n    }\n  }\n}\n```\n\n# 4.12-自动补全与基于上下文的提示.md\n\n# 自动补全与基于上下文的提示\n```\nDELETE articles\nPUT articles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title_completion\":{\n        \"type\": \"completion\"\n      }\n    }\n  }\n}\n\nPOST articles/_bulk\n{ \"index\" : { } }\n{ \"title_completion\": \"lucene is very cool\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch builds on top of lucene\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch rocks\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"elastic is the company behind ELK stack\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elk stack rocks\"}\n{ \"index\" : {} }\n\n\nPOST articles/_search?pretty\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"article-suggester\": {\n      \"prefix\": \"elk \",\n      \"completion\": {\n        \"field\": \"title_completion\"\n      }\n    }\n  }\n}\n\n\nDELETE comments\nPUT comments\nPUT comments/_mapping\n{\n  \"properties\": {\n    \"comment_autocomplete\":{\n      \"type\": \"completion\",\n      \"contexts\":[{\n        \"type\":\"category\",\n        \"name\":\"comment_category\"\n      }]\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"I love the star war movies\",\n  \"comment_autocomplete\":{\n    \"input\":[\"star wars\"],\n    \"contexts\":{\n      \"comment_category\":\"movies\"\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"Where can I find a Starbucks\",\n  \"comment_autocomplete\":{\n    \"input\":[\"starbucks\"],\n    \"contexts\":{\n      \"comment_category\":\"coffee\"\n    }\n  }\n}\n\n\nPOST comments/_search\n{\n  \"suggest\": {\n    \"MY_SUGGESTION\": {\n      \"prefix\": \"sta\",\n      \"completion\":{\n        \"field\":\"comment_autocomplete\",\n        \"contexts\":{\n          \"comment_category\":\"coffee\"\n        }\n      }\n    }\n  }\n}\n```\n\n\n# 4.13-跨集群搜索.md\n\n# 跨集群搜索\n```\n//启动3个集群\n\nbin/elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300\nbin/elasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301\nbin/elasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302\n\n\n//在每个集群上设置动态的设置\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster\": {\n      \"remote\": {\n        \"cluster0\": {\n          \"seeds\": [\n            \"127.0.0.1:9300\"\n          ],\n          \"transport.ping_schedule\": \"30s\"\n        },\n        \"cluster1\": {\n          \"seeds\": [\n            \"127.0.0.1:9301\"\n          ],\n          \"transport.compress\": true,\n          \"skip_unavailable\": true\n        },\n        \"cluster2\": {\n          \"seeds\": [\n            \"127.0.0.1:9302\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n#cURL\ncurl -XPUT \"http://localhost:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9201/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9202/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\n\n#创建测试数据\ncurl -XPOST \"http://localhost:9200/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user1\",\"age\":10}'\n\ncurl -XPOST \"http://localhost:9201/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user2\",\"age\":20}'\n\ncurl -XPOST \"http://localhost:9202/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user3\",\"age\":30}'\n\n\n#查询\nGET /users,cluster1:users,cluster2:users/_search\n{\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20,\n        \"lte\": 40\n      }\n    }\n  }\n}\n\n```\n\n\n# 4.2-结构化搜索.md\n\n# 结构化搜索\n\n```\n\n#结构化搜索，精确匹配\nDELETE products\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\nGET products/_mapping\n\n\n\n#对布尔值 match 查询，有算分\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"avaliable\": true\n    }\n  }\n}\n\n\n\n#对布尔值，通过constant score 转成 filtering，没有算分\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": true\n        }\n      }\n    }\n  }\n}\n\n\n#数字类型 Term\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": 30\n    }\n  }\n}\n\n#数字类型 terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"price\": [\n            \"20\",\n            \"30\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n#数字 Range 查询\nGET products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"price\" : {\n                        \"gte\" : 20,\n                        \"lte\"  : 30\n                    }\n                }\n            }\n        }\n    }\n}\n\n\n# 日期 range\nPOST products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"date\" : {\n                      \"gte\" : \"now-1y\"\n                    }\n                }\n            }\n        }\n    }\n}\n\n\n\n#exists查询\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"exists\": {\n          \"field\": \"date\"\n        }\n      }\n    }\n  }\n}\n\n#处理多值字段\nPOST /movies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\"}\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"] }\n\n\n#处理多值字段，term 查询是包含，而不是等于\nPOST movies/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"genre.keyword\": \"Comedy\"\n        }\n      }\n    }\n  }\n}\n\n\n#字符类型 terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"productID.keyword\": [\n            \"QQPX-R-3956-#aD8\",\n            \"JODL-X-1937-#pV7\"\n          ]\n        }\n      }\n    }\n  }\n}\n\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": 30\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\n\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n    }\n  }\n}\n\n#对布尔数值\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": \"false\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"avaliable\": {\n        \"value\": \"false\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": {\n        \"value\": \"20\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": \"20\"\n    }\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"bool\": {\n          \"must_not\": {\n            \"exists\": {\n              \"field\": \"date\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\n```\n\n# 4.3-搜索的相关性算分.md\n\n# 搜索的相关性算分\n\n```\n\n\nPUT testscore\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      }\n    }\n  }\n}\n\n\nPUT testscore/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"we use Elasticsearch to power the search\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"we like elasticsearch\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"The scoring of documents is caculated by the scoring formula\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"content\":\"you know, for search\" }\n\n\n\nPOST /testscore/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"content\":\"you\"\n      //\"content\": \"elasticsearch\"\n      //\"content\":\"the\"\n      //\"content\": \"the elasticsearch\"\n    }\n  }\n}\n\nPOST testscore/_search\n{\n    \"query\": {\n        \"boosting\" : {\n            \"positive\" : {\n                \"term\" : {\n                    \"content\" : \"elasticsearch\"\n                }\n            },\n            \"negative\" : {\n                 \"term\" : {\n                     \"content\" : \"like\"\n                }\n            },\n            \"negative_boost\" : 0.2\n        }\n    }\n}\n\n\nPOST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"more_like_this\": {\n      \"fields\": [\n        \"title^10\",\"overview\"\n      ],\n      \"like\": [{\"_id\":\"14191\"}],\n      \"min_term_freq\": 1,\n      \"max_query_terms\": 12\n    }\n  }\n}\n\n\n\n```\n\n\n# 4.4-Query&Filtering实现多字符串多字段查询.md\n\n# Query & Filtering 与多字符串多字段查询\n\n```\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\n\n\n#基本语法\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :1\n    }\n  }\n}\n\n#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题\nPOST /newmovies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\",\"genre_count\":1 }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"],\"genre_count\":2 }\n\n#must，有算分\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n\n      ]\n    }\n  }\n}\n\n#Filter。不参与算分，结果的score是0\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n        ]\n\n    }\n  }\n}\n\n\n#Filtering Context\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      }\n    }\n  }\n}\n\n\n#Query Context\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\n\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"term\": {\n            \"productID.keyword\": {\n              \"value\": \"JODL-X-1937-#pV7\"}}\n        },\n        {\"term\": {\"avaliable\": {\"value\": true}}\n        }\n      ]\n    }\n  }\n}\n\n\n#嵌套，实现了 should not 逻辑\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\": {\n          \"price\": \"30\"\n        }\n      },\n      \"should\": [\n        {\n          \"bool\": {\n            \"must_not\": {\n              \"term\": {\n                \"avaliable\": \"false\"\n              }\n            }\n          }\n        }\n      ],\n      \"minimum_should_match\": 1\n    }\n  }\n}\n\n\n#Controll the Precision\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :2\n    }\n  }\n}\n\n\n\nPOST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"brown\" }},\n        { \"term\": { \"text\": \"red\" }},\n        { \"term\": { \"text\": \"quick\"   }},\n        { \"term\": { \"text\": \"dog\"   }}\n      ]\n    }\n  }\n}\n\nPOST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"quick\" }},\n        { \"term\": { \"text\": \"dog\"   }},\n        {\n          \"bool\":{\n            \"should\":[\n               { \"term\": { \"text\": \"brown\" }},\n                 { \"term\": { \"text\": \"brown\" }},\n            ]\n          }\n\n        }\n      ]\n    }\n  }\n}\n\n\nDELETE blogs\nPOST /blogs/_bulk\n{ \"index\": { \"_id\": 1 }}\n{\"title\":\"Apple iPad\", \"content\":\"Apple iPad,Apple iPad\" }\n{ \"index\": { \"_id\": 2 }}\n{\"title\":\"Apple iPad,Apple iPad\", \"content\":\"Apple iPad\" }\n\n\nPOST blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\"match\": {\n          \"title\": {\n            \"query\": \"apple,ipad\",\n            \"boost\": 1.1\n          }\n        }},\n\n        {\"match\": {\n          \"content\": {\n            \"query\": \"apple,ipad\",\n            \"boost\":\n          }\n        }}\n      ]\n    }\n  }\n}\n\nDELETE news\nPOST /news/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"Apple Mac\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"Apple iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"Apple employee like Apple Pie and Apple Juice\" }\n\n\nPOST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      }\n    }\n  }\n}\n\nPOST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      },\n      \"must_not\": {\n        \"match\":{\"content\":\"pie\"}\n      }\n    }\n  }\n}\n\nPOST news/_search\n{\n  \"query\": {\n    \"boosting\": {\n      \"positive\": {\n        \"match\": {\n          \"content\": \"apple\"\n        }\n      },\n      \"negative\": {\n        \"match\": {\n          \"content\": \"pie\"\n        }\n      },\n      \"negative_boost\": 0.5\n    }\n  }\n}\n\n```\n\n# 4.5-单字符串多字段查询-DisMaxQuery.md\n\n# 单字符串多字段查询：Dis Max Query\n```\n\nPUT /blogs/_doc/1\n{\n    \"title\": \"Quick brown rabbits\",\n    \"body\":  \"Brown rabbits are commonly seen.\"\n}\n\nPUT /blogs/_doc/2\n{\n    \"title\": \"Keeping pets healthy\",\n    \"body\":  \"My quick brown fox eats rabbits on a regular basis.\"\n}\n\nPOST /blogs/_search\n{\n    \"query\": {\n        \"bool\": {\n            \"should\": [\n                { \"match\": { \"title\": \"Brown fox\" }},\n                { \"match\": { \"body\":  \"Brown fox\" }}\n            ]\n        }\n    }\n}\n\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ]\n        }\n    }\n}\n\n\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n\n\n```\n\n# 4.6-单字符串多字段查询-Multi-Match.md\n\n# 单字符串多字段查询：Multi Match\n```\nPOST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n\nPOST blogs/_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\": \"best_fields\",\n      \"query\": \"Quick pets\",\n      \"fields\": [\"title\",\"body\"],\n      \"tie_breaker\": 0.2,\n      \"minimum_should_match\": \"20%\"\n    }\n  }\n}\n\n\n\nPOST books/_search\n{\n    \"multi_match\": {\n        \"query\":  \"Quick brown fox\",\n        \"fields\": \"*_title\"\n    }\n}\n\n\nPOST books/_search\n{\n    \"multi_match\": {\n        \"query\":  \"Quick brown fox\",\n        \"fields\": [ \"*_title\", \"chapter_title^2\" ]\n    }\n}\n\n\n\nDELETE /titles\nPUT /titles\n{\n    \"settings\": { \"number_of_shards\": 1 },\n    \"mappings\": {\n        \"my_type\": {\n            \"properties\": {\n                \"title\": {\n                    \"type\":     \"string\",\n                    \"analyzer\": \"english\",\n                    \"fields\": {\n                        \"std\":   {\n                            \"type\":     \"string\",\n                            \"analyzer\": \"standard\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\"\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n\n\nGET titles/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"barking dogs\"\n    }\n  }\n}\n\nDELETE /titles\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\",\n        \"fields\": {\"std\": {\"type\": \"text\",\"analyzer\": \"standard\"}}\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n\nGET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title\", \"title.std\" ]\n        }\n    }\n}\n\nGET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title^10\", \"title.std\" ]\n        }\n    }\n}\n\n```\n\n# 4.7-多语言及中文分词与检索.md\n\n# 多语言及中文分词与检索\n\n- 来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”\n\n- 你也想犯范范玮琪犯过的错吗\n- 校长说衣服上除了校徽别别别的\n- 这几天天天天气不好\n- 我背有点驼，麻麻说“你的背得背背背背佳\n\n```\n#stop word\n\nDELETE my_index\nPUT /my_index/_doc/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/_doc/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\n\nPOST my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"not happy fox\"\n    }\n  }\n}\n\n\n#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 `english`（英语）分析器，另一次使用 `standard`（标准）分析器:\n\nDELETE my_index\n\nPUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"analyzer\": \"english\"\n        }\n      }\n    }\n  }\n}\n\nPUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"fields\": {\n            \"english\": {\n              \"type\":     \"string\",\n              \"analyzer\": \"english\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /my_index/blog/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/blog/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\nGET /_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\":     \"most_fields\",\n      \"query\":    \"not happy foxes\",\n      \"fields\": [ \"title\", \"title.english\" ]\n    }\n  }\n}\n\n\n#安装插件\n./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip\n#安装插件\nbin/elasticsearch install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip\n\n\n\n\n#ik_max_word\n#ik_smart\n#hanlp: hanlp默认分词\n#hanlp_standard: 标准分词\n#hanlp_index: 索引分词\n#hanlp_nlp: NLP分词\n#hanlp_n_short: N-最短路分词\n#hanlp_dijkstra: 最短路分词\n#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）\n#hanlp_speed: 极速词典分词\n\nPOST _analyze\n{\n  \"analyzer\": \"hanlp_standard\",\n  \"text\": [\"剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜\"]\n\n}     \n\n#Pinyin\nPUT /artists/\n{\n    \"settings\" : {\n        \"analysis\" : {\n            \"analyzer\" : {\n                \"user_name_analyzer\" : {\n                    \"tokenizer\" : \"whitespace\",\n                    \"filter\" : \"pinyin_first_letter_and_full_pinyin_filter\"\n                }\n            },\n            \"filter\" : {\n                \"pinyin_first_letter_and_full_pinyin_filter\" : {\n                    \"type\" : \"pinyin\",\n                    \"keep_first_letter\" : true,\n                    \"keep_full_pinyin\" : false,\n                    \"keep_none_chinese\" : true,\n                    \"keep_original\" : false,\n                    \"limit_first_letter_length\" : 16,\n                    \"lowercase\" : true,\n                    \"trim_whitespace\" : true,\n                    \"keep_none_chinese_in_first_letter\" : true\n                }\n            }\n        }\n    }\n}\n\n\nGET /artists/_analyze\n{\n  \"text\": [\"刘德华 张学友 郭富城 黎明 四大天王\"],\n  \"analyzer\": \"user_name_analyzer\"\n}\n\n\n```\n\n## 相关资源\n- Elasticsearch IK分词插件 https://github.com/medcl/elasticsearch-analysis-ik/releases\n- Elasticsearch hanlp 分词插件 https://github.com/KennFalcon/elasticsearch-analysis-hanlp\n\n- 分词算法综述 https://zhuanlan.zhihu.com/p/50444885\n\n### 一些分词工具，供参考：\n- 中科院计算所NLPIR http://ictclas.nlpir.org/nlpir/\n- ansj分词器 https://github.com/NLPchina/ansj_seg\n- 哈工大的LTP https://github.com/HIT-SCIR/ltp\n- 清华大学THULAC https://github.com/thunlp/THULAC\n- 斯坦福分词器 https://nlp.stanford.edu/software/segmenter.shtml\n- Hanlp分词器 https://github.com/hankcs/HanLP\n- 结巴分词 https://github.com/yanyiwu/cppjieba\n- KCWS分词器(字嵌入+Bi-LSTM+CRF) https://github.com/koth/kcws\n- ZPar https://github.com/frcchang/zpar/releases\n- IKAnalyzer https://github.com/wks/ik-analyzer\n\n\n# 4.8-SpaceJam一个全文搜索的实例.md\n\n# Space Jam，一次全文搜索的实例\n\n## 环境要求\n- Python 2.7.15\n- 可以使用pyenv管理多个python版本（可选）\n\n## 进入 tmdb-search目录\nRun\npip install -r requirements.txt\nRun python ./ingest_tmdb_from_file.py\n```\nPOST tmdb/_search\n{\n\"_source\": [\"title\",\"overview\"],\n \"query\": {\n   \"match_all\": {}\n }\n}\n\nPOST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"multi_match\": {\n      \"query\": \"basketball with cartoon aliens\",\n      \"fields\": [\"title\",\"overview\"]\n    }\n  },\n  \"highlight\" : {\n        \"fields\" : {\n            \"overview\" : { \"pre_tags\" : [\"\\\\033[0;32;40m\"], \"post_tags\" : [\"\\\\033[0m\"] },\n            \"title\" : { \"pre_tags\" : [\"\\\\033[0;32;40m\"], \"post_tags\" : [\"\\\\033[0m\"] }\n\n        }\n    }\n}\n```\n\n## 相关\n- Windows 安装 pyenv https://github.com/pyenv-win/pyenv-win\n- Mac 安装pyenv https://segmentfault.com/a/1190000017403221\n- Linux 安装 pyenv https://blog.csdn.net/GX_1_11_real/article/details/80237064\n- Python.org https://www.python.org/\n\n\n# 4.9-使用SearchTemplate和IndexAlias进行查询.md\n\n# 使用 Search Template 和 Index Alias 查询\n\n```\nPOST _scripts/tmdb\n{\n  \"script\": {\n    \"lang\": \"mustache\",\n    \"source\": {\n      \"_source\": [\n        \"title\",\"overview\"\n      ],\n      \"size\": 20,\n      \"query\": {\n        \"multi_match\": {\n          \"query\": \"{{q}}\",\n          \"fields\": [\"title\",\"overview\"]\n        }\n      }\n    }\n  }\n}\nDELETE _scripts/tmdb\n\nGET _scripts/tmdb\n\nPOST tmdb/_search/template\n{\n    \"id\":\"tmdb\",\n    \"params\": {\n        \"q\": \"basketball with cartoon aliens\"\n    }\n}\n\n\nPUT movies-2019/_doc/1\n{\n  \"name\":\"the matrix\",\n  \"rating\":5\n}\n\nPUT movies-2019/_doc/2\n{\n  \"name\":\"Speed\",\n  \"rating\":3\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-latest\"\n      }\n    }\n  ]\n}\n\nPOST movies-latest/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-lastest-highrate\",\n        \"filter\": {\n          \"range\": {\n            \"rating\": {\n              \"gte\": 4\n            }\n          }\n        }\n      }\n    }\n  ]\n}\n\nPOST movies-lastest-highrate/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n\n\n```\n\n\n# 5.1-集群分布式模型及选主与脑裂问题.md\n\n# 集群分布式模型及选主与脑裂问题\n\n```\nbin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data\nbin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data\nbin/elasticsearch -E node.name=node3 -E cluster.name=geektime -E path.data=node3_data\n\n```\n# 5.2-分片与集群的故障转移.md\n\n# 分片与集群的故障转移\n\n\n# 5.3-文档分布式存储.md\n\n# 文档分布式存储\n\n\n# 5.4-分片及其生命周期.md\n\n# 分片及其生命周期\n\n\n# 5.5-剖析分布式查询及相关性评分.md\n\n# 剖析分布式查询及相关性评分\n```\nDELETE message\nPUT message\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  }\n}\n\nGET message\n\nPOST message/_doc?routing=1\n{\n  \"content\":\"good\"\n}\n\nPOST message/_doc?routing=2\n{\n  \"content\":\"good morning\"\n}\n\nPOST message/_doc?routing=3\n{\n  \"content\":\"good morning everyone\"\n}\n\nPOST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n\nPOST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n\n\nPOST message/_search?search_type=dfs_query_then_fetch\n{\n\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n\n```\n\n\n# 5.6-排序及DocValues&Fielddata.md\n\n# 排序及Doc Values & Fielddata\n```\n#单字段排序\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}}\n  ]\n}\n\n#多字段排序\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}},\n    {\"_doc\":{\"order\": \"asc\"}},\n    {\"_score\":{ \"order\": \"desc\"}}\n  ]\n}\n\nGET kibana_sample_data_ecommerce/_mapping\n\n#对 text 字段进行排序。默认会报错，需打开fielddata\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"customer_full_name\": {\"order\": \"desc\"}}\n  ]\n}\n\n#打开 text的 fielddata\nPUT kibana_sample_data_ecommerce/_mapping\n{\n  \"properties\": {\n    \"customer_full_name\" : {\n          \"type\" : \"text\",\n          \"fielddata\": true,\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n  }\n}\n\n#关闭 keyword的 doc values\nPUT test_keyword\nPUT test_keyword/_mapping\n{\n  \"properties\": {\n    \"user_name\":{\n      \"type\": \"keyword\",\n      \"doc_values\":false\n    }\n  }\n}\n\nDELETE test_keyword\n\nPUT test_text\nPUT test_text/_mapping\n{\n  \"properties\": {\n    \"intro\":{\n      \"type\": \"text\",\n      \"doc_values\":true\n    }\n  }\n}\n\nDELETE test_text\n\n\nDELETE temp_users\nPUT temp_users\nPUT temp_users/_mapping\n{\n  \"properties\": {\n    \"name\":{\"type\": \"text\",\"fielddata\": true},\n    \"desc\":{\"type\": \"text\",\"fielddata\": true}\n  }\n}\n\nPost temp_users/_doc\n{\"name\":\"Jack\",\"desc\":\"Jack is a good boy!\",\"age\":10}\n\n#打开fielddata 后，查看 docvalue_fields数据\nPOST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"name\",\"desc\"\n    ]\n}\n\n#查看整型字段的docvalues\nPOST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"age\"\n    ]\n}\n```\n\n\n# 5.7-分页与遍历-FromSize&SearchAfter&ScrollAPI.md\n\n# 分页与遍历 - From, Size, Search_after & Scroll API\n```\n\nPOST tmdb/_search\n{\n  \"from\": 10000,\n  \"size\": 1,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  }\n}\n\n#Scroll API\nDELETE users\n\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":11}\n\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":12}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":13}\n\nPOST users/_count\n\nPOST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n\nPOST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"search_after\":\n        [\n          10,\n          \"ZQ0vYGsBrR8X3IP75QqX\"],\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n\n\n#Scroll API\nDELETE users\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":20}\n\nPOST users/_doc\n{\"name\":\"user3\",\"age\":30}\n\nPOST users/_doc\n{\"name\":\"user4\",\"age\":40}\n\nPOST /users/_search?scroll=5m\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\" : {\n        }\n    }\n}\n\n\nPOST users/_doc\n{\"name\":\"user5\",\"age\":50}\nPOST /_search/scroll\n{\n    \"scroll\" : \"1m\",\n    \"scroll_id\" : \"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ==\"\n}\n\n\n```\n\n\n# 5.8-处理并发读写.md\n\n# 处理并发读写操作\n```\n\nDELETE products\nPUT products\n\nPUT products/_doc/1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\nGET products/_doc/1\n\nPUT products/_doc/1?if_seq_no=1&if_primary_term=1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\nPUT products/_doc/1?version=30000&version_type=external\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n\n\n\n```\n\n\n# 6.1-Bucket&Metric聚合分析及嵌套聚合.md\n\n# Bucket & Metric Aggregation\n## demos\n```\nDELETE /employees\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n# Metric 聚合，找到最低的工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"min_salary\": {\n      \"min\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n# Metric 聚合，找到最高的工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n# 多个 Metric 聚合，找到最低最高和平均工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"min_salary\": {\n      \"min\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"avg_salary\": {\n      \"avg\": {\n        \"field\": \"salary\"\n      }\n    }\n  }\n}\n\n# 一个聚合，输出多值\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"stats_salary\": {\n      \"stats\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n\n\n\n\n# 对keword 进行聚合\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n\n\n# 对 Text 字段进行 terms 聚合查询，失败\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n\n# 对 Text 字段打开 fielddata，支持terms aggregation\nPUT employees/_mapping\n{\n  \"properties\" : {\n    \"job\":{\n       \"type\":     \"text\",\n       \"fielddata\": true\n    }\n  }\n}\n\n\n# 对 Text 字段进行 terms 分词。分词后的terms\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n\n\n# 对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"cardinate\": {\n      \"cardinality\": {\n        \"field\": \"job\"\n      }\n    }\n  }\n}\n\n\n# 对 性别的 keyword 进行聚合\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"gender\": {\n      \"terms\": {\n        \"field\":\"gender\"\n      }\n    }\n  }\n}\n\n\n#指定 bucket 的 size\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"ages_5\": {\n      \"terms\": {\n        \"field\":\"age\",\n        \"size\":3\n      }\n    }\n  }\n}\n\n\n\n# 指定size，不同工种中，年纪最大的3个员工的具体信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      },\n      \"aggs\":{\n        \"old_employee\":{\n          \"top_hits\":{\n            \"size\":3,\n            \"sort\":[\n              {\n                \"age\":{\n                  \"order\":\"desc\"\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\n#Salary Ranges 分桶，可以自己定义 key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_range\": {\n      \"range\": {\n        \"field\":\"salary\",\n        \"ranges\":[\n          {\n            \"to\":10000\n          },\n          {\n            \"from\":10000,\n            \"to\":20000\n          },\n          {\n            \"key\":\">20000\",\n            \"from\":20000\n          }\n        ]\n      }\n    }\n  }\n}\n\n\n#Salary Histogram,工资0到10万，以 5000一个区间进行分桶\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_histrogram\": {\n      \"histogram\": {\n        \"field\":\"salary\",\n        \"interval\":5000,\n        \"extended_bounds\":{\n          \"min\":0,\n          \"max\":100000\n\n        }\n      }\n    }\n  }\n}\n\n\n# 嵌套聚合1，按照工作类型分桶，并统计工资信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_salary_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"salary\": {\n          \"stats\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n# 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_gender_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"gender_stats\": {\n          \"terms\": {\n            \"field\": \"gender\"\n          },\n          \"aggs\": {\n            \"salary_stats\": {\n              \"stats\": {\n                \"field\": \"salary\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\n\n# 6.2-Pipeline聚合分析.md\n\n# Pipeline 聚合分析\n```\nDELETE employees\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n\n\n# 平均工资最低的工作类型\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"min_salary_by_job\":{\n      \"min_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资最高的工作类型\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"max_salary_by_job\":{\n      \"max_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的平均工资\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"avg_salary_by_job\":{\n      \"avg_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的统计分析\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"stats_salary_by_job\":{\n      \"stats_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n# 平均工资的百分位数\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"percentiles_salary_by_job\":{\n      \"percentiles_bucket\": {\n        \"buckets_path\": \"jobs>avg_salary\"\n      }\n    }\n  }\n}\n\n\n\n#按照年龄对平均工资求导\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"derivative_avg_salary\":{\n          \"derivative\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#Cumulative_sum\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"cumulative_salary\":{\n          \"cumulative_sum\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n#Moving Function\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 1,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"moving_avg_salary\":{\n          \"moving_fn\": {\n            \"buckets_path\": \"avg_salary\",\n            \"window\":10,\n            \"script\": \"MovingFunctions.min(values)\"\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\n# 6.3-作用范围与排序.md\n\n# 作用范围与排序\n```\nDELETE /employees\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n\n\n\n# Query\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    }\n  }\n}\n\n\n#Filter\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"older_person\": {\n      \"filter\":{\n        \"range\":{\n          \"age\":{\n            \"from\":35\n          }\n        }\n      },\n      \"aggs\":{\n         \"jobs\":{\n           \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n      }\n    }},\n    \"all_jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    }\n  }\n}\n\n\n\n#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果\nPOST employees/_search\n{\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      }\n    }\n  },\n  \"post_filter\": {\n    \"match\": {\n      \"job.keyword\": \"Dev Manager\"\n    }\n  }\n}\n\n\n#global\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 40\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n        \n      }\n    },\n    \n    \"all\":{\n      \"global\":{},\n      \"aggs\":{\n        \"salary_avg\":{\n          \"avg\":{\n            \"field\":\"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[\n          {\"_count\":\"asc\"},\n          {\"_key\":\"desc\"}\n          ]\n        \n      }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"avg_salary\":\"desc\"\n          }]\n        \n        \n      },\n    \"aggs\": {\n      \"avg_salary\": {\n        \"avg\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n\n\n#排序 order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"stats_salary.min\":\"desc\"\n          }]\n        \n        \n      },\n    \"aggs\": {\n      \"stats_salary\": {\n        \"stats\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n```\n\n# 6.4-聚合分析的原理及精准度问题.md\n\n# 聚合分析的原理及精准度问题\n```\nDELETE my_flights\nPUT my_flights\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  },\n  \"mappings\" : {\n      \"properties\" : {\n        \"AvgTicketPrice\" : {\n          \"type\" : \"float\"\n        },\n        \"Cancelled\" : {\n          \"type\" : \"boolean\"\n        },\n        \"Carrier\" : {\n          \"type\" : \"keyword\"\n        },\n        \"Dest\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"DestRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DistanceKilometers\" : {\n          \"type\" : \"float\"\n        },\n        \"DistanceMiles\" : {\n          \"type\" : \"float\"\n        },\n        \"FlightDelay\" : {\n          \"type\" : \"boolean\"\n        },\n        \"FlightDelayMin\" : {\n          \"type\" : \"integer\"\n        },\n        \"FlightDelayType\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightNum\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeHour\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeMin\" : {\n          \"type\" : \"float\"\n        },\n        \"Origin\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"OriginRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"dayOfWeek\" : {\n          \"type\" : \"integer\"\n        },\n        \"timestamp\" : {\n          \"type\" : \"date\"\n        }\n      }\n    }\n}\n\n\nPOST _reindex\n{\n  \"source\": {\n    \"index\": \"kibana_sample_data_flights\"\n  },\n  \"dest\": {\n    \"index\": \"my_flights\"\n  }\n}\n\nGET kibana_sample_data_flights/_count\nGET my_flights/_count\n\nget kibana_sample_data_flights/_search\n\n\nGET kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":5,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n\n\nGET my_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":1,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n\n```\n\n# 7.1-对象及 Nested 对象.md\n\n# 对象及Nested对象\n```\nDELETE blog\n# 设置blog的 Mapping\nPUT /blog\n{\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"time\": {\n        \"type\": \"date\"\n      },\n      \"user\": {\n        \"properties\": {\n          \"city\": {\n            \"type\": \"text\"\n          },\n          \"userid\": {\n            \"type\": \"long\"\n          },\n          \"username\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n# 插入一条 Blog 信息\nPUT blog/_doc/1\n{\n  \"content\":\"I like Elasticsearch\",\n  \"time\":\"2019-01-01T00:00:00\",\n  \"user\":{\n    \"userid\":1,\n    \"username\":\"Jack\",\n    \"city\":\"Shanghai\"\n  }\n}\n\n\n# 查询 Blog 信息\nPOST blog/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"content\": \"Elasticsearch\"}},\n        {\"match\": {\"user.username\": \"Jack\"}}\n      ]\n    }\n  }\n}\n\n\nDELETE my_movies\n\n# 电影的Mapping信息\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"properties\" : {\n            \"first_name\" : {\n              \"type\" : \"keyword\"\n            },\n            \"last_name\" : {\n              \"type\" : \"keyword\"\n            }\n          }\n        },\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n}\n\n\n# 写入一条电影信息\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n\n# 查询电影信息\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"actors.first_name\": \"Keanu\"}},\n        {\"match\": {\"actors.last_name\": \"Hopper\"}}\n      ]\n    }\n  }\n\n}\n\nDELETE my_movies\n# 创建 Nested 对象 Mapping\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"type\": \"nested\",\n          \"properties\" : {\n            \"first_name\" : {\"type\" : \"keyword\"},\n            \"last_name\" : {\"type\" : \"keyword\"}\n          }},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\"keyword\":{\"type\":\"keyword\",\"ignore_above\":256}}\n        }\n      }\n    }\n}\n\n\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n\n# Nested 查询\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"Speed\"}},\n        {\n          \"nested\": {\n            \"path\": \"actors\",\n            \"query\": {\n              \"bool\": {\n                \"must\": [\n                  {\"match\": {\n                    \"actors.first_name\": \"Keanu\"\n                  }},\n\n                  {\"match\": {\n                    \"actors.last_name\": \"Hopper\"\n                  }}\n                ]\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n\n\n# Nested Aggregation\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"actors\": {\n      \"nested\": {\n        \"path\": \"actors\"\n      },\n      \"aggs\": {\n        \"actor_name\": {\n          \"terms\": {\n            \"field\": \"actors.first_name\",\n            \"size\": 10\n          }\n        }\n      }\n    }\n  }\n}\n\n\n# 普通 aggregation不工作\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"NAME\": {\n      \"terms\": {\n        \"field\": \"actors.first_name\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n```\n\n# 7.2-文档的父子关系.md\n\n# 文档的父子关系\n```\nDELETE my_blogs\n\n# 设定 Parent/Child Mapping\nPUT my_blogs\n{\n  \"settings\": {\n    \"number_of_shards\": 2\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"blog_comments_relation\": {\n        \"type\": \"join\",\n        \"relations\": {\n          \"blog\": \"comment\"\n        }\n      },\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"title\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n\n\n#索引父文档\nPUT my_blogs/_doc/blog1\n{\n  \"title\":\"Learning Elasticsearch\",\n  \"content\":\"learning ELK @ geektime\",\n  \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n#索引父文档\nPUT my_blogs/_doc/blog2\n{\n  \"title\":\"Learning Hadoop\",\n  \"content\":\"learning Hadoop\",\n    \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n\n#索引子文档\nPUT my_blogs/_doc/comment1?routing=blog1\n{\n  \"comment\":\"I am learning ELK\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog1\"\n  }\n}\n\n#索引子文档\nPUT my_blogs/_doc/comment2?routing=blog2\n{\n  \"comment\":\"I like Hadoop!!!!!\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog2\"\n  }\n}\n\n#索引子文档\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n  \"comment\":\"Hello Hadoop\",\n  \"username\":\"Bob\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog2\"\n  }\n}\n\n# 查询所有文档\nPOST my_blogs/_search\n{\n\n}\n\n\n#根据父文档ID查看\nGET my_blogs/_doc/blog2\n\n# Parent Id 查询\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"parent_id\": {\n      \"type\": \"comment\",\n      \"id\": \"blog2\"\n    }\n  }\n}\n\n# Has Child 查询,返回父文档\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"comment\",\n      \"query\" : {\n                \"match\": {\n                    \"username\" : \"Jack\"\n                }\n            }\n    }\n  }\n}\n\n\n# Has Parent 查询，返回相关的子文档\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_parent\": {\n      \"parent_type\": \"blog\",\n      \"query\" : {\n                \"match\": {\n                    \"title\" : \"Learning Hadoop\"\n                }\n            }\n    }\n  }\n}\n\n\n\n#通过ID ，访问子文档\nGET my_blogs/_doc/comment3\n#通过ID和routing ，访问子文档\nGET my_blogs/_doc/comment3?routing=blog2\n\n#更新子文档\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n    \"comment\": \"Hello Hadoop??\",\n    \"blog_comments_relation\": {\n      \"name\": \"comment\",\n      \"parent\": \"blog2\"\n    }\n}\n\n\n```\n\n# 7.5-Elasticsearch数据建模实例.md\n\n# Elasticsearch 数据建模实例\n```\n###### Data Modeling Example\n\n# Index 一本书的信息\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n\n\n\n#查询自动创建的Mapping\nGET books/_mapping\n\nDELETE books\n\n#优化字段类型\nPUT books\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\"},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false},\n        \"description\" : {\"type\" : \"text\"},\n        \"public_date\" : {\"type\" : \"date\"},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          }\n        }\n      }\n    }\n}\n\n#Cover URL index 设置成false，无法对该字段进行搜索\nPOST books/_search\n{\n  \"query\": {\n    \"term\": {\n      \"cover_url\": {\n        \"value\": \"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n      }\n    }\n  }\n}\n\n#Cover URL index 设置成false，依然支持聚合分析\nPOST books/_search\n{\n  \"aggs\": {\n    \"cover\": {\n      \"terms\": {\n        \"field\": \"cover_url\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n\nDELETE books\n#新增 Content字段。数据量很大。选择将Source 关闭\nPUT books\n{\n      \"mappings\" : {\n      \"_source\": {\"enabled\": false},\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\",\"store\": true},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false,\"store\": true},\n        \"description\" : {\"type\" : \"text\",\"store\": true},\n         \"content\" : {\"type\" : \"text\",\"store\": true},\n        \"public_date\" : {\"type\" : \"date\",\"store\": true},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          },\n          \"store\": true\n        }\n      }\n    }\n}\n\n\n# Index 一本书的信息,包含Content\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins\",\n  \"content\":\"The content of the book......Indexing data, aggregation, searching.    something else. something in the way............\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n\n#查询结果中，Source不包含数据\nPOST books/_search\n{}\n\n#搜索，通过store 字段显示数据，同时高亮显示 conent的内容\nPOST books/_search\n{\n  \"stored_fields\": [\"title\",\"author\",\"public_date\"],\n  \"query\": {\n    \"match\": {\n      \"content\": \"searching\"\n    }\n  },\n\n  \"highlight\": {\n    \"fields\": {\n      \"content\":{}\n    }\n  }\n\n}\n\n```\n\n# 7.6-Elasticsearch 数据建模最佳实践.md\n\n# Elasticsearch 数据建模最佳实践\n\n\n```\n\n###### Cookie Service\n\n##索引数据，dynamic mapping 会不断加入新增字段\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":{\n   \"username\":\"tom\",\n   \"age\":32\n }\n}\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":{\n   \"login\":\"2019-01-01\",\n   \"email\":\"xyz@abc.com\"\n }\n}\n\n\nDELETE cookie_service\n#使用 Nested 对象，增加key/value\nPUT cookie_service\n{\n  \"mappings\": {\n    \"properties\": {\n      \"cookies\": {\n        \"type\": \"nested\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"keyword\"\n          },\n          \"dateValue\": {\n            \"type\": \"date\"\n          },\n          \"keywordValue\": {\n            \"type\": \"keyword\"\n          },\n          \"IntValue\": {\n            \"type\": \"integer\"\n          }\n        }\n      },\n      \"url\": {\n        \"type\": \"text\",\n        \"fields\": {\n          \"keyword\": {\n            \"type\": \"keyword\",\n            \"ignore_above\": 256\n          }\n        }\n      }\n    }\n  }\n}\n\n\n##写入数据，使用key和合适类型的value字段\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":[\n    {\n      \"name\":\"username\",\n      \"keywordValue\":\"tom\"\n    },\n    {\n       \"name\":\"age\",\n      \"intValue\":32\n\n    }\n\n   ]\n }\n\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":[\n    {\n      \"name\":\"login\",\n      \"dateValue\":\"2019-01-01\"\n    },\n    {\n       \"name\":\"email\",\n      \"IntValue\":32\n\n    }\n\n   ]\n }\n\n\n# Nested 查询，通过bool查询进行过滤\nPOST cookie_service/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"cookies\",\n      \"query\": {\n        \"bool\": {\n          \"filter\": [\n            {\n            \"term\": {\n              \"cookies.name\": \"age\"\n            }},\n            {\n              \"range\":{\n                \"cookies.intValue\":{\n                  \"gte\":30\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  }\n}\n\n\n\n# 在Mapping中加入元信息，便于管理\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.0\"\n    }\n  }\n}\n\nGET softwares/_mapping\nPUT softwares/_doc/1\n{\n  \"software_version\":\"7.1.0\"\n}\n\nDELETE softwares\n# 优化,使用inner object\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.1\"\n    },\n    \"properties\": {\n      \"version\": {\n        \"properties\": {\n          \"display_name\": {\n            \"type\": \"keyword\"\n          },\n          \"hot_fix\": {\n            \"type\": \"byte\"\n          },\n          \"marjor\": {\n            \"type\": \"byte\"\n          },\n          \"minor\": {\n            \"type\": \"byte\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n#通过 Inner Object 写入多个文档\nPUT softwares/_doc/1\n{\n  \"version\":{\n  \"display_name\":\"7.1.0\",\n  \"marjor\":7,\n  \"minor\":1,\n  \"hot_fix\":0  \n  }\n\n}\n\nPUT softwares/_doc/2\n{\n  \"version\":{\n  \"display_name\":\"7.2.0\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":0  \n  }\n}\n\nPUT softwares/_doc/3\n{\n  \"version\":{\n  \"display_name\":\"7.2.1\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":1  \n  }\n}\n\n\n# 通过 bool 查询，\nPOST softwares/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\n          \"match\":{\n            \"version.marjor\":7\n          }\n        },\n        {\n          \"match\":{\n            \"version.minor\":2\n          }\n        }\n\n      ]\n    }\n  }\n}\n\n\n\n\n# Not Null 解决聚合的问题\nDELETE ratings\nPUT ratings\n{\n  \"mappings\": {\n      \"properties\": {\n        \"rating\": {\n          \"type\": \"float\",\n          \"null_value\": 1.0\n        }\n      }\n    }\n}\n\n\nPUT ratings/_doc/1\n{\n \"rating\":5\n}\nPUT ratings/_doc/2\n{\n \"rating\":null\n}\n\n\nPOST ratings/_search\nPOST ratings/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"avg\": {\n      \"avg\": {\n        \"field\": \"rating\"\n      }\n    }\n  }\n}\n\nPOST ratings/_search\n{\n  \"query\": {\n    \"term\": {\n      \"rating\": {\n        \"value\": 1\n      }\n    }\n  }\n}\n\n```\n\n\n# 7.7-第二部分总结与测验.md\n\n# 第二部分总结与测验\n```\nDELETE test\nPUT test/_doc/1\n{\n  \"content\":\"Hello World\"\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n\n\n```\n\n\n# 8.1-集群身份认证与用户鉴权.md\n\n# 集群身份认证与用户鉴权\n- 如何为集群启用X-Pack Security\n- 如何为内置用户设置密码\n- 设置 Kibana与ElasticSearch通信鉴权\n- 使用安全API创建对特定索引具有有限访问权限的用户\n\nThis tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:\n\ndiscovery.type: single-node\n\n```\n#启动单节点\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true\n\n#使用Curl访问ES，或者浏览器访问 “localhost:9200/_cat/nodes?pretty”。返回401错误\ncurl 'localhost:9200/_cat/nodes?pretty'\n\n#运行密码设定的命令，设置ES内置用户及其初始密码。\nbin/elasticsearch-setup-passwords interactive\n\ncurl -u elastic 'localhost:9200/_cat/nodes?pretty'\n\n\n# 修改 kibana.yml\nelasticsearch.username: \"kibana\"\nelasticsearch.password: \"changeme\"\n\n#启动。使用用户名，elastic，密码elastic\n./bin/kibana\n\n\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n\n\n#create a new role named read_only_orders, that satisfies the following criteria:\n#The role has no cluster privileges\n#The role only has access to indices that match the pattern sales_record\n#The index privileges are read, and view_index_metadata\n\n\n#create sales_user that satisfies the following criteria:\n# Use your own email address\n# Assign the user to two roles: read_only_orders and kibana_user\n\n\n#验证读权限,可以执行\nPOST orders/_search\n{}\n\n#验证写权限,报错\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n\n\n```\n\n\n# 8.2-集群内部安全通信.md\n\n#\n\n```\n# 生成证书\n# 为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：\nbin/elasticsearch-certutil ca\n\n#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：\nbin/elasticsearch-certutil cert --ca elastic-stack-ca.p12\n\n#将证书拷贝到 config/certs目录下\nelastic-certificates.p12\n\n\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12\n\nbin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12\n\n\n#不提供证书的节点，无法加入\nbin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E http.port=9202 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate\n\n\n```\n\n\n```\n## elasticsearch.yml 配置\n\n#xpack.security.transport.ssl.enabled: true\n#xpack.security.transport.ssl.verification_mode: certificate\n\n#xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12\n#xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12\n\n\n```\n\n# 8.3-集群与外部间的安全通信.md\n\n\n\n```\nxpack.security.http.ssl.enabled: true\nxpack.security.http.ssl.keystore.path: certs/elastic-certificates.p12\nxpack.security.http.ssl.truststore.path: certs/elastic-certificates.p12\n\n```\n```\n\n\n# ES 启用 https\nbin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12\n\n```\n\n```\n#Kibana 连接 ES https\n\n\n\n# 为kibana生成pem\nopenssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem\n\n\nelasticsearch.hosts: [\"https://localhost:9200\"]\nelasticsearch.ssl.certificateAuthorities: [ \"/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem\" ]\nelasticsearch.ssl.verificationMode: certificate\n\n\n\n# 为 Kibna 配置 HTTPS\n# 生成后解压，包含了instance.crt 和 instance.key\nbin/elasticsearch-certutil ca --pem\n\nserver.ssl.enabled: true\nserver.ssl.certificate: config/certs/instance.crt\nserver.ssl.key: config/certs/instance.key\n\n\n```\n\n\n\n# 9.1-常见的集群部署方式.md\n\n# 常见的集群部署方式\n\n# 9.2-Hot&Warm架构与ShardFiltering.md\n\n# Hot & Warm 架构与 Shard Filtering\n## 课程代码\n```\n# 标记一个 Hot 节点\nbin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot\n\n# 标记一个 warm 节点\nbin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm\n\n# 查看节点\nGET /_cat/nodeattrs?v\n\n# 配置到 Hot节点\nPUT logs-2019-06-27\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.my_node_type\":\"hot\"\n  }\n}\n\n\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\n\nGET _cat/shards?v\n\n\n# 配置到 warm 节点\nPUT PUT logs-2019-06-27/_settings\n{  \n  \"index.routing.allocation.require.my_node_type\":\"warm\"\n}\n\n\n# 标记一个 rack 1\nbin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# 标记一个 rack 2\nbin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\"\n  }\n}\n\nPUT my_index1\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1\n  }\n}\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\nGET _cat/shards?v\nDELETE my_index1/_doc/1\n\n\n\n# Fore awareness\n# 标记一个 rack 1\nbin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# 标记一个 rack 2\nbin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1\n\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\",\n    \"cluster.routing.allocation.awareness.force.my_rack_id.values\": \"rack1,rack2\"\n  }\n}\nGET _cluster/settings\n\n# 集群黄色\nGET _cluster/health\n\n# 副本无法分配\nGET _cat/shards?v\n\n\nGET _cluster/allocation/explain?pretty\n```\n","slug":"elasticsearch/es高级命令","published":1,"updated":"2025-02-27T08:42:54.317Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8u000zujz3fw7g80ha","content":"<p>以下是优化过的笔记，已加入注释并调整格式，使其更符合Markdown标准：</p>\n<hr>\n<h1 id=\"Elasticsearch-集群管理与优化笔记\"><a href=\"#Elasticsearch-集群管理与优化笔记\" class=\"headerlink\" title=\"Elasticsearch 集群管理与优化笔记\"></a>Elasticsearch 集群管理与优化笔记</h1><h2 id=\"1-移动分片到另一个节点\"><a href=\"#1-移动分片到另一个节点\" class=\"headerlink\" title=\"1. 移动分片到另一个节点\"></a>1. 移动分片到另一个节点</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _cluster/reroute</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;commands&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;move&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;index&quot;</span>: <span class=\"string\">&quot;index_name&quot;</span>,   <span class=\"comment\"># 索引名称</span></span><br><span class=\"line\">        <span class=\"string\">&quot;shard&quot;</span>: 0,               <span class=\"comment\"># 分片编号</span></span><br><span class=\"line\">        <span class=\"string\">&quot;from_node&quot;</span>: <span class=\"string\">&quot;node_name_1&quot;</span>, <span class=\"comment\"># 源节点</span></span><br><span class=\"line\">        <span class=\"string\">&quot;to_node&quot;</span>: <span class=\"string\">&quot;node_name_2&quot;</span>   <span class=\"comment\"># 目标节点</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-强制分配未分配的分片（带原因说明）\"><a href=\"#2-强制分配未分配的分片（带原因说明）\" class=\"headerlink\" title=\"2. 强制分配未分配的分片（带原因说明）\"></a>2. 强制分配未分配的分片（带原因说明）</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _cluster/reroute?explain</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;commands&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;allocate&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;index&quot;</span>: <span class=\"string\">&quot;index_name&quot;</span>,   <span class=\"comment\"># 索引名称</span></span><br><span class=\"line\">        <span class=\"string\">&quot;shard&quot;</span>: 0,              <span class=\"comment\"># 分片编号</span></span><br><span class=\"line\">        <span class=\"string\">&quot;node&quot;</span>: <span class=\"string\">&quot;nodename&quot;</span>       <span class=\"comment\"># 目标节点</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-从集群中移除节点\"><a href=\"#3-从集群中移除节点\" class=\"headerlink\" title=\"3. 从集群中移除节点\"></a>3. 从集群中移除节点</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cluster.routing.allocation.exclude._ip&quot;</span>: <span class=\"string\">&quot;the_IP_of_your_node&quot;</span>   <span class=\"comment\"># 要排除的节点IP</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-强制执行同步刷新\"><a href=\"#4-强制执行同步刷新\" class=\"headerlink\" title=\"4. 强制执行同步刷新\"></a>4. 强制执行同步刷新</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _flush/synced</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-调整集群平衡时移动的分片数量\"><a href=\"#5-调整集群平衡时移动的分片数量\" class=\"headerlink\" title=\"5. 调整集群平衡时移动的分片数量\"></a>5. 调整集群平衡时移动的分片数量</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cluster.routing.allocation.cluster_concurrent_rebalance&quot;</span>: 2   <span class=\"comment\"># 同时平衡的分片数</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-调整每个节点同时恢复的分片数量\"><a href=\"#6-调整每个节点同时恢复的分片数量\" class=\"headerlink\" title=\"6. 调整每个节点同时恢复的分片数量\"></a>6. 调整每个节点同时恢复的分片数量</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cluster.routing.allocation.node_concurrent_recoveries&quot;</span>: 5   <span class=\"comment\"># 每个节点并行恢复的分片数</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"7-调整恢复速度\"><a href=\"#7-调整恢复速度\" class=\"headerlink\" title=\"7. 调整恢复速度\"></a>7. 调整恢复速度</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;indices.recovery.max_bytes_per_sec&quot;</span>: <span class=\"string\">&quot;80mb&quot;</span>   <span class=\"comment\"># 恢复速率</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"8-调整单节点恢复时并发流数量\"><a href=\"#8-调整单节点恢复时并发流数量\" class=\"headerlink\" title=\"8. 调整单节点恢复时并发流数量\"></a>8. 调整单节点恢复时并发流数量</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;indices.recovery.concurrent_streams&quot;</span>: 6   <span class=\"comment\"># 单节点恢复时的并发流数</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"9-调整搜索队列大小\"><a href=\"#9-调整搜索队列大小\" class=\"headerlink\" title=\"9. 调整搜索队列大小\"></a>9. 调整搜索队列大小</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;threadpool.search.queue_size&quot;</span>: 2000   <span class=\"comment\"># 搜索队列大小</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"10-清除节点缓存\"><a href=\"#10-清除节点缓存\" class=\"headerlink\" title=\"10. 清除节点缓存\"></a>10. 清除节点缓存</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _cache/clear</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"11-调整断路器配置\"><a href=\"#11-调整断路器配置\" class=\"headerlink\" title=\"11. 调整断路器配置\"></a>11. 调整断路器配置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;persistent&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;indices.breaker.total.limit&quot;</span>: <span class=\"string\">&quot;40%&quot;</span>   <span class=\"comment\"># 设置内存断路器的总内存限制</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"监控-Elasticsearch-集群\"><a href=\"#监控-Elasticsearch-集群\" class=\"headerlink\" title=\"监控 Elasticsearch 集群\"></a>监控 Elasticsearch 集群</h1><h2 id=\"1-节点统计\"><a href=\"#1-节点统计\" class=\"headerlink\" title=\"1. 节点统计\"></a>1. 节点统计</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _nodes/stats</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-集群统计\"><a href=\"#2-集群统计\" class=\"headerlink\" title=\"2. 集群统计\"></a>2. 集群统计</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/stats</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-索引统计\"><a href=\"#3-索引统计\" class=\"headerlink\" title=\"3. 索引统计\"></a>3. 索引统计</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_ecommerce/_stats</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-查看待处理的集群任务\"><a href=\"#4-查看待处理的集群任务\" class=\"headerlink\" title=\"4. 查看待处理的集群任务\"></a>4. 查看待处理的集群任务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/pending_tasks</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-查看所有任务，支持取消任务\"><a href=\"#5-查看所有任务，支持取消任务\" class=\"headerlink\" title=\"5. 查看所有任务，支持取消任务\"></a>5. 查看所有任务，支持取消任务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _tasks</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-查看节点的线程池信息\"><a href=\"#6-查看节点的线程池信息\" class=\"headerlink\" title=\"6. 查看节点的线程池信息\"></a>6. 查看节点的线程池信息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _nodes/thread_pool</span><br><span class=\"line\">GET _nodes/stats/thread_pool</span><br><span class=\"line\">GET _cat/thread_pool?v</span><br><span class=\"line\">GET _nodes/hot_threads</span><br><span class=\"line\">GET _nodes/stats/thread_pool</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"7-设置索引慢日志（Slowlog）\"><a href=\"#7-设置索引慢日志（Slowlog）\" class=\"headerlink\" title=\"7. 设置索引慢日志（Slowlog）\"></a>7. 设置索引慢日志（Slowlog）</h2><ul>\n<li><p>设置索引慢日志阈值：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT my_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;index.indexing.slowlog&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;threshold.index&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;warn&quot;</span>: <span class=\"string\">&quot;10s&quot;</span>,    <span class=\"comment\"># 警告级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;info&quot;</span>: <span class=\"string\">&quot;4s&quot;</span>,     <span class=\"comment\"># 信息级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;debug&quot;</span>: <span class=\"string\">&quot;2s&quot;</span>,    <span class=\"comment\"># 调试级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;trace&quot;</span>: <span class=\"string\">&quot;0s&quot;</span>     <span class=\"comment\"># 跟踪级别</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;level&quot;</span>: <span class=\"string\">&quot;trace&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;source&quot;</span>: 1000   <span class=\"comment\"># 日志源的最大字符数</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置查询慢日志：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE my_index</span><br><span class=\"line\">PUT my_index/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index.search.slowlog.threshold&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;query.warn&quot;</span>: <span class=\"string\">&quot;10s&quot;</span>,   <span class=\"comment\"># 查询慢日志警告级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;query.info&quot;</span>: <span class=\"string\">&quot;3s&quot;</span>,    <span class=\"comment\"># 查询慢日志信息级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;query.debug&quot;</span>: <span class=\"string\">&quot;2s&quot;</span>,   <span class=\"comment\"># 查询慢日志调试级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;query.trace&quot;</span>: <span class=\"string\">&quot;0s&quot;</span>,   <span class=\"comment\"># 查询慢日志跟踪级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;fetch.warn&quot;</span>: <span class=\"string\">&quot;1s&quot;</span>,    <span class=\"comment\"># 获取慢日志警告级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;fetch.info&quot;</span>: <span class=\"string\">&quot;600ms&quot;</span>, <span class=\"comment\"># 获取慢日志信息级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;fetch.debug&quot;</span>: <span class=\"string\">&quot;400ms&quot;</span>,<span class=\"comment\"># 获取慢日志调试级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;fetch.trace&quot;</span>: <span class=\"string\">&quot;0s&quot;</span>    <span class=\"comment\"># 获取慢日志跟踪级别</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<hr>\n<h1 id=\"解决集群-Yellow-与-Red-状态问题\"><a href=\"#解决集群-Yellow-与-Red-状态问题\" class=\"headerlink\" title=\"解决集群 Yellow 与 Red 状态问题\"></a>解决集群 Yellow 与 Red 状态问题</h1><h2 id=\"1-检查集群健康状态\"><a href=\"#1-检查集群健康状态\" class=\"headerlink\" title=\"1. 检查集群健康状态\"></a>1. 检查集群健康状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/health/</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-查看索引级别健康状态，找出红色索引\"><a href=\"#2-查看索引级别健康状态，找出红色索引\" class=\"headerlink\" title=\"2. 查看索引级别健康状态，找出红色索引\"></a>2. 查看索引级别健康状态，找出红色索引</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/health?level=indices</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-查看分片级别健康状态\"><a href=\"#3-查看分片级别健康状态\" class=\"headerlink\" title=\"3. 查看分片级别健康状态\"></a>3. 查看分片级别健康状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/health?level=shards</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-解释索引分片无法分配的原因\"><a href=\"#4-解释索引分片无法分配的原因\" class=\"headerlink\" title=\"4. 解释索引分片无法分配的原因\"></a>4. 解释索引分片无法分配的原因</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/allocation/explain</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-删除并重新创建索引\"><a href=\"#5-删除并重新创建索引\" class=\"headerlink\" title=\"5. 删除并重新创建索引\"></a>5. 删除并重新创建索引</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE mytest</span><br><span class=\"line\">PUT mytest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_shards&quot;</span>: 3,    <span class=\"comment\"># 分片数</span></span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 0,   <span class=\"comment\"># 副本数</span></span><br><span class=\"line\">    <span class=\"string\">&quot;index.routing.allocation.require.box_type&quot;</span>: <span class=\"string\">&quot;hot&quot;</span>   <span class=\"comment\"># 指定节点类型</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"提升集群写性能\"><a href=\"#提升集群写性能\" class=\"headerlink\" title=\"提升集群写性能\"></a>提升集群写性能</h1><h2 id=\"1-设置优化写入性能的索引设置\"><a href=\"#1-设置优化写入性能的索引设置\" class=\"headerlink\" title=\"1. 设置优化写入性能的索引设置\"></a>1. 设置优化写入性能的索引设置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE myindex</span><br><span class=\"line\">PUT myindex</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;refresh_interval&quot;</span>: <span class=\"string\">&quot;30s&quot;</span>,     <span class=\"comment\"># 刷新间隔</span></span><br><span class=\"line\">      <span class=\"string\">&quot;number_of_shards&quot;</span>: <span class=\"string\">&quot;2&quot;</span>        <span class=\"comment\"># 分片数</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;routing&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;allocation&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;total_shards_per_node&quot;</span>: <span class=\"string\">&quot;3&quot;</span> <span class=\"comment\"># 每个节点的最大分片数</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;translog&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;sync_interval&quot;</span>: <span class=\"string\">&quot;30s&quot;</span>,         <span class=\"comment\"># 事务日志同步间隔</span></span><br><span class=\"line\">      <span class=\"string\">&quot;durability&quot;</span>: <span class=\"string\">&quot;async&quot;</span>           <span class=\"comment\"># 异步持久化</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 0          <span class=\"comment\"># 副本数</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;dynamic&quot;</span>: <span class=\"literal\">false</span>,                <span class=\"comment\"># 禁用动态映射</span></span><br><span class=\"line\">    <span class=\"string\">&quot;properties&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"提升集群读性能\"><a href=\"#提升集群读性能\" class=\"headerlink\" title=\"提升集群读性能\"></a>提升集群读性能</h1><h2 id=\"1-示例：查询优化\"><a href=\"#1-示例：查询优化\" class=\"headerlink\" title=\"1. 示例：查询优化\"></a>1. 示例：查询优化</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT blogs/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;title&quot;</span>: <span class=\"string\">&quot;elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;bool&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;must&quot;</span>: [</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;match&quot;</span>: &#123; <span class=\"string\">&quot;title&quot;</span>: <span class=\"string\">&quot;elasticsearch&quot;</span> &#125;&#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      <span class=\"string\">&quot;filter&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;script&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;script&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;source&quot;</span>: <span class=\"string\">&quot;doc[&#x27;title.keyword&#x27;].value.length()&gt;5&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;bool&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;must&quot;</span>: [</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;match&quot;</span>: &#123;<span class=\"string\">&quot;title&quot;</span>: <span class=\"string\">&quot;elasticsearch&quot;</span>&#125;&#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;range&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;publish_date&quot;</span>: &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;gte&quot;</span>: 2017,</span><br><span class=\"line\">              <span class=\"string\">&quot;lte&quot;</span>: 2019</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"集群压力测试\"><a href=\"#集群压力测试\" class=\"headerlink\" title=\"集群压力测试\"></a>集群压力测试</h1><h2 id=\"1-安装并配置-esrally\"><a href=\"#1-安装并配置-esrally\" class=\"headerlink\" title=\"1. 安装并配置 esrally\"></a>1. 安装并配置 esrally</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip3 install esrally</span><br><span class=\"line\">esrally configure</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-执行简单的压力测试\"><a href=\"#2-执行简单的压力测试\" class=\"headerlink\" title=\"2. 执行简单的压力测试\"></a>2. 执行简单的压力测试</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">esrally --distribution-version=7.1.0 --test-mode</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-执行完整数据测试\"><a href=\"#3-执行完整数据测试\" class=\"headerlink\" title=\"3. 执行完整数据测试\"></a>3. 执行完整数据测试</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">esrally --distribution-version=7.1.0</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"使用缓存与-Breaker-限制内存使用\"><a href=\"#使用缓存与-Breaker-限制内存使用\" class=\"headerlink\" title=\"使用缓存与 Breaker 限制内存使用\"></a>使用缓存与 Breaker 限制内存使用</h1><h2 id=\"1-获取节点统计信息\"><a href=\"#1-获取节点统计信息\" class=\"headerlink\" title=\"1. 获取节点统计信息\"></a>1. 获取节点统计信息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cat/nodes?v</span><br><span class=\"line\">GET _nodes/stats/indices?pretty</span><br><span class=\"line\">GET _cat/nodes?v&amp;h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-设置内存限制\"><a href=\"#2-设置内存限制\" class=\"headerlink\" title=\"2. 设置内存限制\"></a>2. 设置内存限制</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;persistent&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;indices.breaker.request.limit&quot;</span>: <span class=\"string\">&quot;90%&quot;</span>   <span class=\"comment\"># 设置请求断路器内存限制</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"使用-Shrink-与-Rollover-API-管理索引\"><a href=\"#使用-Shrink-与-Rollover-API-管理索引\" class=\"headerlink\" title=\"使用 Shrink 与 Rollover API 管理索引\"></a>使用 Shrink 与 Rollover API 管理索引</h1><h2 id=\"1-Shrink-索引\"><a href=\"#1-Shrink-索引\" class=\"headerlink\" title=\"1. Shrink 索引\"></a>1. Shrink 索引</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index.number_of_replicas&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;index.number_of_shards&quot;</span>: 2,</span><br><span class=\"line\">    <span class=\"string\">&quot;index.codec&quot;</span>: <span class=\"string\">&quot;best_compression&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aliases&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;my_search_indices&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Rollover-索引\"><a href=\"#2-Rollover-索引\" class=\"headerlink\" title=\"2. Rollover 索引\"></a>2. Rollover 索引</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST nginx_logs_write/_rollover</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;conditions&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;max_age&quot;</span>: <span class=\"string\">&quot;1d&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_docs&quot;</span>: 5,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_size&quot;</span>: <span class=\"string\">&quot;5gb&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 11.2-索引全生命周期管理及工具介绍.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 索引全生命周期管理及工具介绍</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"运行三个节点，分片-将box-type设置成-hot，warm和cold\"><a href=\"#运行三个节点，分片-将box-type设置成-hot，warm和cold\" class=\"headerlink\" title=\"运行三个节点，分片 将box_type设置成 hot，warm和cold\"></a>运行三个节点，分片 将box_type设置成 hot，warm和cold</h1><h1 id=\"具体参考-github下，docker-hot-warm-cold-下的docker-compose-文件\"><a href=\"#具体参考-github下，docker-hot-warm-cold-下的docker-compose-文件\" class=\"headerlink\" title=\"具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件\"></a>具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件</h1><p>DELETE *</p>\n<h1 id=\"设置-1秒刷新1次，生产环境10分种刷新一次\"><a href=\"#设置-1秒刷新1次，生产环境10分种刷新一次\" class=\"headerlink\" title=\"设置 1秒刷新1次，生产环境10分种刷新一次\"></a>设置 1秒刷新1次，生产环境10分种刷新一次</h1><p>PUT _cluster&#x2F;settings<br>{<br>  “persistent”: {<br>    “indices.lifecycle.poll_interval”:”1s”<br>  }<br>}</p>\n<h1 id=\"设置-Policy\"><a href=\"#设置-Policy\" class=\"headerlink\" title=\"设置 Policy\"></a>设置 Policy</h1><p>PUT &#x2F;_ilm&#x2F;policy&#x2F;log_ilm_policy<br>{<br>  “policy”: {<br>    “phases”: {<br>      “hot”: {<br>        “actions”: {<br>          “rollover”: {<br>            “max_docs”: 5<br>          }<br>        }<br>      },<br>      “warm”: {<br>        “min_age”: “10s”,<br>        “actions”: {<br>          “allocate”: {<br>            “include”: {<br>              “box_type”: “warm”<br>            }<br>          }<br>        }<br>      },<br>      “cold”: {<br>        “min_age”: “15s”,<br>        “actions”: {<br>          “allocate”: {<br>            “include”: {<br>              “box_type”: “cold”<br>            }<br>          }<br>        }<br>      },<br>      “delete”: {<br>        “min_age”: “20s”,<br>        “actions”: {<br>          “delete”: {}<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"设置索引模版\"><a href=\"#设置索引模版\" class=\"headerlink\" title=\"设置索引模版\"></a>设置索引模版</h1><p>PUT &#x2F;_template&#x2F;log_ilm_template<br>{<br>  “index_patterns” : [<br>      “ilm_index-*”<br>    ],<br>    “settings” : {<br>      “index” : {<br>        “lifecycle” : {<br>          “name” : “log_ilm_policy”,<br>          “rollover_alias” : “ilm_alias”<br>        },<br>        “routing” : {<br>          “allocation” : {<br>            “include” : {<br>              “box_type” : “hot”<br>            }<br>          }<br>        },<br>        “number_of_shards” : “1”,<br>        “number_of_replicas” : “0”<br>      }<br>    },<br>    “mappings” : { },<br>    “aliases” : { }<br>}</p>\n<p>#创建索引<br>PUT ilm_index-000001<br>{<br>  “settings”: {<br>    “number_of_shards”: 1,<br>    “number_of_replicas”: 0,<br>    “index.lifecycle.name”: “log_ilm_policy”,<br>    “index.lifecycle.rollover_alias”: “ilm_alias”,<br>    “index.routing.allocation.include.box_type”:”hot”<br>  },<br>  “aliases”: {<br>    “ilm_alias”: {<br>      “is_write_index”: true<br>    }<br>  }<br>}</p>\n<h1 id=\"对-Alias写入文档\"><a href=\"#对-Alias写入文档\" class=\"headerlink\" title=\"对 Alias写入文档\"></a>对 Alias写入文档</h1><p>POST  ilm_alias&#x2F;_doc<br>{<br>  “dfd”:”dfdsf”<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 12.1-Logstash入门及架构介绍.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Logstash 入门及架构介绍</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"一个-Demo，-demo-运行\"><a href=\"#一个-Demo，-demo-运行\" class=\"headerlink\" title=\"一个 Demo， demo 运行\"></a>一个 Demo， demo 运行</h1><p>sudo bin&#x2F;logstash -f logstash-filter.conf</p>\n<h1 id=\"demo数据\"><a href=\"#demo数据\" class=\"headerlink\" title=\"demo数据\"></a>demo数据</h1><p>127.0.0.1 - - [11&#x2F;Dec&#x2F;2013:00:01:45 -0800] “GET &#x2F;xampp&#x2F;status.php HTTP&#x2F;1.1” 200 3891 “<a href=\"http://cadenza/xampp/navi.php\">http://cadenza/xampp/navi.php</a>“ “Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko&#x2F;20100101 Firefox&#x2F;25.0”</p>\n<h1 id=\"codec-demo\"><a href=\"#codec-demo\" class=\"headerlink\" title=\"codec demo\"></a>codec demo</h1><p>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;line}}output{stdout{codec&#x3D;&gt; rubydebug}}”<br>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;json}}output{stdout{codec&#x3D;&gt; rubydebug}}”<br>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;line}}output{stdout{codec&#x3D;&gt; dots}}”</p>\n<p>sudo bin&#x2F;logstash -f multiline-exception.conf</p>\n<h1 id=\"多行数据，异常\"><a href=\"#多行数据，异常\" class=\"headerlink\" title=\"多行数据，异常\"></a>多行数据，异常</h1><p>Exception in thread “main” java.lang.NullPointerException<br>        at com.example.myproject.Book.getTitle(Book.java:16)<br>        at com.example.myproject.Author.getBookTitles(Author.java:25)<br>        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</p>\n<h1 id=\"一个实例\"><a href=\"#一个实例\" class=\"headerlink\" title=\"一个实例\"></a>一个实例</h1><p><a href=\"https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf\">https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf</a></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 12.2-利用JDBC插件导入数据到Elasticsearch.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Logstash插件及文档介绍</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://spring.io/guides/gs/accessing-data-mysql/\">https://spring.io/guides/gs/accessing-data-mysql/</a><br>create database db_example;<br>use db_example;<br>show tables;<br>drop table user;<br>select * from user;</p>\n<h1 id=\"新增用户\"><a href=\"#新增用户\" class=\"headerlink\" title=\"新增用户\"></a>新增用户</h1><p>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Mike -d email&#x3D;<a href=\"mailto:&#x6d;&#x69;&#x6b;&#101;&#x40;&#120;&#x79;&#122;&#x2e;&#x63;&#x6f;&#109;\">&#x6d;&#x69;&#x6b;&#101;&#x40;&#120;&#x79;&#122;&#x2e;&#x63;&#x6f;&#109;</a> -d tags&#x3D;Elasticsearch,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Jack -d email&#x3D;<a href=\"mailto:&#x6a;&#x61;&#99;&#107;&#x40;&#120;&#x79;&#122;&#46;&#99;&#111;&#x6d;\">&#x6a;&#x61;&#99;&#107;&#x40;&#120;&#x79;&#122;&#46;&#99;&#111;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Bob -d email&#x3D;<a href=\"mailto:&#98;&#111;&#x62;&#64;&#x78;&#x79;&#122;&#46;&#x63;&#x6f;&#x6d;\">&#98;&#111;&#x62;&#64;&#x78;&#x79;&#122;&#46;&#x63;&#x6f;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ</p>\n<p>#查看所有的用户<br>curl ‘localhost:8080&#x2F;demo&#x2F;all’</p>\n<h1 id=\"更新用户\"><a href=\"#更新用户\" class=\"headerlink\" title=\"更新用户\"></a>更新用户</h1><p>curl -X PUT localhost:8080&#x2F;demo&#x2F;update -d id&#x3D;16 -d name&#x3D;Bob2 -d email&#x3D;<a href=\"mailto:&#98;&#111;&#x62;&#50;&#x40;&#120;&#x79;&#x7a;&#x2e;&#x63;&#111;&#x6d;\">&#98;&#111;&#x62;&#50;&#x40;&#120;&#x79;&#x7a;&#x2e;&#x63;&#111;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ</p>\n<h1 id=\"删除用户\"><a href=\"#删除用户\" class=\"headerlink\" title=\"删除用户\"></a>删除用户</h1><p>curl -X DELETE localhost:8080&#x2F;demo&#x2F;delete -d id&#x3D;15</p>\n<p>mysql-demo.conf</p>\n<h1 id=\"创建-alias，只显示没有被标记-deleted的用户\"><a href=\"#创建-alias，只显示没有被标记-deleted的用户\" class=\"headerlink\" title=\"创建 alias，只显示没有被标记 deleted的用户\"></a>创建 alias，只显示没有被标记 deleted的用户</h1><p>POST &#x2F;_aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “users”,<br>        “alias”: “view_users”,<br>         “filter” : { “term” : { “is_deleted” : false } }<br>      }<br>    }<br>  ]<br>}</p>\n<h1 id=\"通过-Alias查询，查不到被标记成-deleted的用户\"><a href=\"#通过-Alias查询，查不到被标记成-deleted的用户\" class=\"headerlink\" title=\"通过 Alias查询，查不到被标记成 deleted的用户\"></a>通过 Alias查询，查不到被标记成 deleted的用户</h1><p>POST view_users&#x2F;_search<br>{</p>\n<p>}</p>\n<p>POST view_users&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “name.keyword”: {<br>        “value”: “Jack”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST users&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “name.keyword”: {<br>        “value”: “Jack”<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 12.3-Beats介绍.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Beats介绍</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h1 id=\"查看-packetbeat-模块\"><a href=\"#查看-packetbeat-模块\" class=\"headerlink\" title=\"查看 packetbeat 模块\"></a>查看 packetbeat 模块</h1><h1 id=\"设置-packetbeat-的mysql-模块\"><a href=\"#设置-packetbeat-的mysql-模块\" class=\"headerlink\" title=\"设置 packetbeat 的mysql 模块\"></a>设置 packetbeat 的mysql 模块</h1><h1 id=\"启动运行\"><a href=\"#启动运行\" class=\"headerlink\" title=\"启动运行\"></a>启动运行</h1><h1 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h1><p>.&#x2F;metricbeat modules list<br>.&#x2F;metricbeat modules enable mysql<br>.&#x2F;metricbeat setup –dashboards</p>\n<h1 id=\"安装mysql\"><a href=\"#安装mysql\" class=\"headerlink\" title=\"安装mysql\"></a>安装mysql</h1><p>create database db_example<br>use db_example;<br>show tables;<br>select * from user</p>\n<p>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Mike -d email&#x3D;<a href=\"mailto:&#x6d;&#105;&#x6b;&#101;&#64;&#120;&#x79;&#122;&#x2e;&#x63;&#111;&#109;\">&#x6d;&#105;&#x6b;&#101;&#64;&#120;&#x79;&#122;&#x2e;&#x63;&#111;&#109;</a> -d tags&#x3D;Elasticsearch,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Jack -d email&#x3D;<a href=\"mailto:&#x6a;&#97;&#99;&#107;&#x40;&#120;&#121;&#122;&#46;&#99;&#111;&#x6d;\">&#x6a;&#97;&#99;&#107;&#x40;&#120;&#121;&#122;&#46;&#99;&#111;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Bob -d email&#x3D;<a href=\"mailto:&#x62;&#111;&#x62;&#x40;&#120;&#121;&#x7a;&#46;&#x63;&#111;&#109;\">&#x62;&#111;&#x62;&#x40;&#120;&#121;&#x7a;&#46;&#x63;&#111;&#109;</a> -d tags&#x3D;Mysql,IntelliJ</p>\n<p>curl ‘localhost:8080&#x2F;demo&#x2F;all’</p>\n<h1 id=\"配置-packetbeat\"><a href=\"#配置-packetbeat\" class=\"headerlink\" title=\"配置 packetbeat\"></a>配置 packetbeat</h1><h1 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h1><p>修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控</p>\n<p>sudo chown root packetbeat.yml<br>sudo .&#x2F;packetbeat setup –dashboards<br>sudo .&#x2F;packetbeat</p>\n<h1 id=\"查看所有-Filebeat-模块\"><a href=\"#查看所有-Filebeat-模块\" class=\"headerlink\" title=\"查看所有 Filebeat 模块\"></a>查看所有 Filebeat 模块</h1><h1 id=\"查看所有的modules\"><a href=\"#查看所有的modules\" class=\"headerlink\" title=\"查看所有的modules\"></a>查看所有的modules</h1><p>.&#x2F;filebeat modules list</p>\n<h1 id=\"-2\"><a href=\"#-2\" class=\"headerlink\" title=\"\"></a></h1><p>.&#x2F;filebeat modules enable mysql</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 13.1-使用IndexPattern配置数据.md</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>localhost:5601&#x2F;status</p>\n<p>PUT &#x2F;logstash-2015.05.18<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT &#x2F;logstash-2015.05.19<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT &#x2F;logstash-2015.05.20<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"For-Mac-Windows\"><a href=\"#For-Mac-Windows\" class=\"headerlink\" title=\"For Mac &amp; Windows\"></a>For Mac &amp; Windows</h1><p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;_bulk?pretty’ –data-binary @logs.jsonl</p>\n<p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;bank&#x2F;account&#x2F;_bulk?pretty’ –data-binary @accounts.json</p>\n<p>#For Windows<br>Invoke-RestMethod “<a href=\"http://localhost:9200/_bulk?pretty\">http://localhost:9200/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “logs.jsonl”</p>\n<p>GET &#x2F;_cat&#x2F;indices?v</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 13.2-使用KibanaDiscover探索数据.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 使用Kibana Discovery 探索数据</span><br></pre></td></tr></table></figure>\n\n<p>设置时间过滤器<br>搜索你的数据<br>根据字段进行过滤<br>查看文档数据<br>查看文档上下文<br>暂时字段数据统计<br>Save Query</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 13.3-基本可视化组件介绍.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 基本可视化组件介绍</span><br></pre></td></tr></table></figure>\n\n<p>PUT &#x2F;shakespeare<br>{<br>  “mappings”: {<br>    “properties”: {<br>    “speaker”: {“type”: “keyword”},<br>    “play_name”: {“type”: “keyword”},<br>    “line_id”: {“type”: “integer”},<br>    “speech_number”: {“type”: “integer”}<br>    }<br>  }<br>}</p>\n<h1 id=\"For-Mac-Windows-1\"><a href=\"#For-Mac-Windows-1\" class=\"headerlink\" title=\"For Mac &amp; Windows\"></a>For Mac &amp; Windows</h1><p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;bank&#x2F;account&#x2F;_bulk?pretty’ –data-binary @accounts.json<br>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;shakespeare&#x2F;_bulk?pretty’ –data-binary @shakespeare.json</p>\n<p>#For Windows<br>Invoke-RestMethod “<a href=\"http://localhost:9200/bank/account/_bulk?pretty\">http://localhost:9200/bank/account/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “accounts.json”<br>Invoke-RestMethod “<a href=\"http://localhost:9200/shakespeare/_bulk?pretty\">http://localhost:9200/shakespeare/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “shakespeare.json”</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 13.4-构建Dashboard.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 构建Dashboard</span><br></pre></td></tr></table></figure>\n<ul>\n<li>创建仪表潘</li>\n<li>加载仪表盘</li>\n<li>共享仪表盘</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 14.3用机器学习实现时序数据的异常检测-上.md</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir server_metrics</span><br><span class=\"line\">cd server_metrics</span><br><span class=\"line\">wget https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz</span><br><span class=\"line\">tar -xvf server_metrics.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 14.5-用ELK进行日志管理.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 用 ELK 来做日志管理</span><br></pre></td></tr></table></figure>\n<p>.&#x2F;filebeat modules list<br>.&#x2F;filebeat modules enable system<br>.&#x2F;filebeat modules enable elasticsearch</p>\n<h2 id=\"进-modules-d-编辑相应的文件，修改log路径\"><a href=\"#进-modules-d-编辑相应的文件，修改log路径\" class=\"headerlink\" title=\"进 modules.d 编辑相应的文件，修改log路径\"></a>进 modules.d 编辑相应的文件，修改log路径</h2><p>.&#x2F;filebeat setup –dashboards</p>\n<p>.&#x2F;filebeat export template | more</p>\n<p>.&#x2F;filebeat -e</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 14.6-用Canvas做数据演示.md</span><br><span class=\"line\"></span><br><span class=\"line\">POST elasticoffee/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0, </span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;by&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;beverage.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 4.1-基于词项和基于全文的搜索.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 基于词项和基于全文的搜索</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>DELETE products<br>PUT products<br>{<br>  “settings”: {<br>    “number_of_shards”: 1<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “productID” : “XHDK-A-1293-#fJ3”,”desc”:”iPhone” }<br>{ “index”: { “_id”: 2 }}<br>{ “productID” : “KDKE-B-9947-#kL5”,”desc”:”iPad” }<br>{ “index”: { “_id”: 3 }}<br>{ “productID” : “JODL-X-1937-#pV7”,”desc”:”MBP” }</p>\n<p>GET &#x2F;products</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “desc”: {<br>        &#x2F;&#x2F;“value”: “iPhone”<br>        “value”:”iphone”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “desc.keyword”: {<br>        &#x2F;&#x2F;“value”: “iPhone”<br>        &#x2F;&#x2F;“value”:”iphone”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “productID”: {<br>        “value”: “XHDK-A-1293-#fJ3”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  &#x2F;&#x2F;“explain”: true,<br>  “query”: {<br>    “term”: {<br>      “productID.keyword”: {<br>        “value”: “XHDK-A-1293-#fJ3”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “productID.keyword”: “XHDK-A-1293-#fJ3”<br>        }<br>      }</p>\n<pre><code>&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#设置 position_increment_gap<br>DELETE groups<br>PUT groups<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “names”:{<br>        “type”: “text”,<br>        “position_increment_gap”: 0<br>      }<br>    }<br>  }<br>}</p>\n<p>GET groups&#x2F;_mapping</p>\n<p>POST groups&#x2F;_doc<br>{<br>  “names”: [ “John Water”, “Water Smith”]<br>}</p>\n<p>POST groups&#x2F;_search<br>{<br>  “query”: {<br>    “match_phrase”: {<br>      “names”: {<br>        “query”: “Water Water”,<br>        “slop”: 100<br>      }<br>    }<br>  }<br>}</p>\n<p>POST groups&#x2F;_search<br>{<br>  “query”: {<br>    “match_phrase”: {<br>      “names”: “Water Smith”<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 4.10-综合排序：Function Score Query 优化算分.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 综合排序：Function Score Query 优化算分</span><br></pre></td></tr></table></figure>\n<p>DELETE blogs<br>PUT &#x2F;blogs&#x2F;_doc&#x2F;1<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   0<br>}</p>\n<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;2<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   100<br>}</p>\n<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;3<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   1000000<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p” ,<br>        “factor”: 0.1<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p” ,<br>        “factor”: 0.1<br>      },<br>      “boost_mode”: “sum”,<br>      “max_boost”: 3<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “random_score”: {<br>        “seed”: 911119<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 4.12-自动补全与基于上下文的提示.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 自动补全与基于上下文的提示</span><br></pre></td></tr></table></figure>\n<p>DELETE articles<br>PUT articles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title_completion”:{<br>        “type”: “completion”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST articles&#x2F;_bulk<br>{ “index” : { } }<br>{ “title_completion”: “lucene is very cool”}<br>{ “index” : { } }<br>{ “title_completion”: “Elasticsearch builds on top of lucene”}<br>{ “index” : { } }<br>{ “title_completion”: “Elasticsearch rocks”}<br>{ “index” : { } }<br>{ “title_completion”: “elastic is the company behind ELK stack”}<br>{ “index” : { } }<br>{ “title_completion”: “Elk stack rocks”}<br>{ “index” : {} }</p>\n<p>POST articles&#x2F;_search?pretty<br>{<br>  “size”: 0,<br>  “suggest”: {<br>    “article-suggester”: {<br>      “prefix”: “elk “,<br>      “completion”: {<br>        “field”: “title_completion”<br>      }<br>    }<br>  }<br>}</p>\n<p>DELETE comments<br>PUT comments<br>PUT comments&#x2F;_mapping<br>{<br>  “properties”: {<br>    “comment_autocomplete”:{<br>      “type”: “completion”,<br>      “contexts”:[{<br>        “type”:”category”,<br>        “name”:”comment_category”<br>      }]<br>    }<br>  }<br>}</p>\n<p>POST comments&#x2F;_doc<br>{<br>  “comment”:”I love the star war movies”,<br>  “comment_autocomplete”:{<br>    “input”:[“star wars”],<br>    “contexts”:{<br>      “comment_category”:”movies”<br>    }<br>  }<br>}</p>\n<p>POST comments&#x2F;_doc<br>{<br>  “comment”:”Where can I find a Starbucks”,<br>  “comment_autocomplete”:{<br>    “input”:[“starbucks”],<br>    “contexts”:{<br>      “comment_category”:”coffee”<br>    }<br>  }<br>}</p>\n<p>POST comments&#x2F;_search<br>{<br>  “suggest”: {<br>    “MY_SUGGESTION”: {<br>      “prefix”: “sta”,<br>      “completion”:{<br>        “field”:”comment_autocomplete”,<br>        “contexts”:{<br>          “comment_category”:”coffee”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.13-跨集群搜索.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 跨集群搜索</span><br></pre></td></tr></table></figure>\n<p>&#x2F;&#x2F;启动3个集群</p>\n<p>bin&#x2F;elasticsearch -E node.name&#x3D;cluster0node -E cluster.name&#x3D;cluster0 -E path.data&#x3D;cluster0_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9200 -E transport.port&#x3D;9300<br>bin&#x2F;elasticsearch -E node.name&#x3D;cluster1node -E cluster.name&#x3D;cluster1 -E path.data&#x3D;cluster1_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9201 -E transport.port&#x3D;9301<br>bin&#x2F;elasticsearch -E node.name&#x3D;cluster2node -E cluster.name&#x3D;cluster2 -E path.data&#x3D;cluster2_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9202 -E transport.port&#x3D;9302</p>\n<p>&#x2F;&#x2F;在每个集群上设置动态的设置<br>PUT _cluster&#x2F;settings<br>{<br>  “persistent”: {<br>    “cluster”: {<br>      “remote”: {<br>        “cluster0”: {<br>          “seeds”: [<br>            “127.0.0.1:9300”<br>          ],<br>          “transport.ping_schedule”: “30s”<br>        },<br>        “cluster1”: {<br>          “seeds”: [<br>            “127.0.0.1:9301”<br>          ],<br>          “transport.compress”: true,<br>          “skip_unavailable”: true<br>        },<br>        “cluster2”: {<br>          “seeds”: [<br>            “127.0.0.1:9302”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#cURL<br>curl -XPUT “<a href=\"http://localhost:9200/_cluster/settings\">http://localhost:9200/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>\n<p>curl -XPUT “<a href=\"http://localhost:9201/_cluster/settings\">http://localhost:9201/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>\n<p>curl -XPUT “<a href=\"http://localhost:9202/_cluster/settings\">http://localhost:9202/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>\n<p>#创建测试数据<br>curl -XPOST “<a href=\"http://localhost:9200/users/_doc\">http://localhost:9200/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user1”,”age”:10}’</p>\n<p>curl -XPOST “<a href=\"http://localhost:9201/users/_doc\">http://localhost:9201/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user2”,”age”:20}’</p>\n<p>curl -XPOST “<a href=\"http://localhost:9202/users/_doc\">http://localhost:9202/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user3”,”age”:30}’</p>\n<p>#查询<br>GET &#x2F;users,cluster1:users,cluster2:users&#x2F;_search<br>{<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20,<br>        “lte”: 40<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.2-结构化搜索.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 结构化搜索</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>#结构化搜索，精确匹配<br>DELETE products<br>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>\n<p>GET products&#x2F;_mapping</p>\n<p>#对布尔值 match 查询，有算分<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “avaliable”: true<br>    }<br>  }<br>}</p>\n<p>#对布尔值，通过constant score 转成 filtering，没有算分<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “avaliable”: true<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#数字类型 Term<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “price”: 30<br>    }<br>  }<br>}</p>\n<p>#数字类型 terms<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “terms”: {<br>          “price”: [<br>            “20”,<br>            “30”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#数字 Range 查询<br>GET products&#x2F;_search<br>{<br>    “query” : {<br>        “constant_score” : {<br>            “filter” : {<br>                “range” : {<br>                    “price” : {<br>                        “gte” : 20,<br>                        “lte”  : 30<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>\n<h1 id=\"日期-range\"><a href=\"#日期-range\" class=\"headerlink\" title=\"日期 range\"></a>日期 range</h1><p>POST products&#x2F;_search<br>{<br>    “query” : {<br>        “constant_score” : {<br>            “filter” : {<br>                “range” : {<br>                    “date” : {<br>                      “gte” : “now-1y”<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>\n<p>#exists查询<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “exists”: {<br>          “field”: “date”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#处理多值字段<br>POST &#x2F;movies&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title” : “Father of the Bridge Part II”,”year”:1995, “genre”:”Comedy”}<br>{ “index”: { “_id”: 2 }}<br>{ “title” : “Dave”,”year”:1993,”genre”:[“Comedy”,”Romance”] }</p>\n<p>#处理多值字段，term 查询是包含，而不是等于<br>POST movies&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “genre.keyword”: “Comedy”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#字符类型 terms<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “terms”: {<br>          “productID.keyword”: [<br>            “QQPX-R-3956-#aD8”,<br>            “JODL-X-1937-#pV7”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “price”: 30<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “date”: “2019-01-01”<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “date”: “2019-01-01”<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “productID.keyword”: “XHDK-A-1293-#fJ3”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “productID.keyword”: “XHDK-A-1293-#fJ3”<br>    }<br>  }<br>}</p>\n<p>#对布尔数值<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “avaliable”: “false”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “avaliable”: {<br>        “value”: “false”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “price”: {<br>        “value”: “20”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “price”: “20”<br>    }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “bool”: {<br>          “must_not”: {<br>            “exists”: {<br>              “field”: “date”<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 4.3-搜索的相关性算分.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 搜索的相关性算分</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<p>PUT testscore<br>{<br>  “settings”: {<br>    “number_of_shards”: 1<br>  },<br>  “mappings”: {<br>    “properties”: {<br>      “content”: {<br>        “type”: “text”<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT testscore&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “content”:”we use Elasticsearch to power the search” }<br>{ “index”: { “_id”: 2 }}<br>{ “content”:”we like elasticsearch” }<br>{ “index”: { “_id”: 3 }}<br>{ “content”:”The scoring of documents is caculated by the scoring formula” }<br>{ “index”: { “_id”: 4 }}<br>{ “content”:”you know, for search” }</p>\n<p>POST &#x2F;testscore&#x2F;_search<br>{<br>  &#x2F;&#x2F;“explain”: true,<br>  “query”: {<br>    “match”: {<br>      “content”:”you”<br>      &#x2F;&#x2F;“content”: “elasticsearch”<br>      &#x2F;&#x2F;“content”:”the”<br>      &#x2F;&#x2F;“content”: “the elasticsearch”<br>    }<br>  }<br>}</p>\n<p>POST testscore&#x2F;_search<br>{<br>    “query”: {<br>        “boosting” : {<br>            “positive” : {<br>                “term” : {<br>                    “content” : “elasticsearch”<br>                }<br>            },<br>            “negative” : {<br>                 “term” : {<br>                     “content” : “like”<br>                }<br>            },<br>            “negative_boost” : 0.2<br>        }<br>    }<br>}</p>\n<p>POST tmdb&#x2F;_search<br>{<br>  “_source”: [“title”,”overview”],<br>  “query”: {<br>    “more_like_this”: {<br>      “fields”: [<br>        “title^10”,”overview”<br>      ],<br>      “like”: [{“_id”:”14191”}],<br>      “min_term_freq”: 1,<br>      “max_query_terms”: 12<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.4-Query&amp;Filtering实现多字符串多字段查询.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Query &amp; Filtering 与多字符串多字段查询</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>\n<p>#基本语法<br>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool” : {<br>      “must” : {<br>        “term” : { “price” : “30” }<br>      },<br>      “filter”: {<br>        “term” : { “avaliable” : “true” }<br>      },<br>      “must_not” : {<br>        “range” : {<br>          “price” : { “lte” : 10 }<br>        }<br>      },<br>      “should” : [<br>        { “term” : { “productID.keyword” : “JODL-X-1937-#pV7” } },<br>        { “term” : { “productID.keyword” : “XHDK-A-1293-#fJ3” } }<br>      ],<br>      “minimum_should_match” :1<br>    }<br>  }<br>}</p>\n<p>#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题<br>POST &#x2F;newmovies&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title” : “Father of the Bridge Part II”,”year”:1995, “genre”:”Comedy”,”genre_count”:1 }<br>{ “index”: { “_id”: 2 }}<br>{ “title” : “Dave”,”year”:1993,”genre”:[“Comedy”,”Romance”],”genre_count”:2 }</p>\n<p>#must，有算分<br>POST &#x2F;newmovies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“term”: {“genre.keyword”: {“value”: “Comedy”}}},<br>        {“term”: {“genre_count”: {“value”: 1}}}</p>\n<pre><code>  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Filter。不参与算分，结果的score是0<br>POST &#x2F;newmovies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “filter”: [<br>        {“term”: {“genre.keyword”: {“value”: “Comedy”}}},<br>        {“term”: {“genre_count”: {“value”: 1}}}<br>        ]</p>\n<pre><code>&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Filtering Context<br>POST _search<br>{<br>  “query”: {<br>    “bool” : {</p>\n<pre><code>  &quot;filter&quot;: &#123;\n    &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;\n  &#125;,\n  &quot;must_not&quot; : &#123;\n    &quot;range&quot; : &#123;\n      &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;\n    &#125;\n  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Query Context<br>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        {<br>          “term”: {<br>            “productID.keyword”: {<br>              “value”: “JODL-X-1937-#pV7”}}<br>        },<br>        {“term”: {“avaliable”: {“value”: true}}<br>        }<br>      ]<br>    }<br>  }<br>}</p>\n<p>#嵌套，实现了 should not 逻辑<br>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “term”: {<br>          “price”: “30”<br>        }<br>      },<br>      “should”: [<br>        {<br>          “bool”: {<br>            “must_not”: {<br>              “term”: {<br>                “avaliable”: “false”<br>              }<br>            }<br>          }<br>        }<br>      ],<br>      “minimum_should_match”: 1<br>    }<br>  }<br>}</p>\n<p>#Controll the Precision<br>POST _search<br>{<br>  “query”: {<br>    “bool” : {<br>      “must” : {<br>        “term” : { “price” : “30” }<br>      },<br>      “filter”: {<br>        “term” : { “avaliable” : “true” }<br>      },<br>      “must_not” : {<br>        “range” : {<br>          “price” : { “lte” : 10 }<br>        }<br>      },<br>      “should” : [<br>        { “term” : { “productID.keyword” : “JODL-X-1937-#pV7” } },<br>        { “term” : { “productID.keyword” : “XHDK-A-1293-#fJ3” } }<br>      ],<br>      “minimum_should_match” :2<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;animals&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        { “term”: { “text”: “brown” }},<br>        { “term”: { “text”: “red” }},<br>        { “term”: { “text”: “quick”   }},<br>        { “term”: { “text”: “dog”   }}<br>      ]<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;animals&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        { “term”: { “text”: “quick” }},<br>        { “term”: { “text”: “dog”   }},<br>        {<br>          “bool”:{<br>            “should”:[<br>               { “term”: { “text”: “brown” }},<br>                 { “term”: { “text”: “brown” }},<br>            ]<br>          }</p>\n<pre><code>    &#125;\n  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>DELETE blogs<br>POST &#x2F;blogs&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{“title”:”Apple iPad”, “content”:”Apple iPad,Apple iPad” }<br>{ “index”: { “_id”: 2 }}<br>{“title”:”Apple iPad,Apple iPad”, “content”:”Apple iPad” }</p>\n<p>POST blogs&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        {“match”: {<br>          “title”: {<br>            “query”: “apple,ipad”,<br>            “boost”: 1.1<br>          }<br>        }},</p>\n<pre><code>    &#123;&quot;match&quot;: &#123;\n      &quot;content&quot;: &#123;\n        &quot;query&quot;: &quot;apple,ipad&quot;,\n        &quot;boost&quot;:\n      &#125;\n    &#125;&#125;\n  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>DELETE news<br>POST &#x2F;news&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “content”:”Apple Mac” }<br>{ “index”: { “_id”: 2 }}<br>{ “content”:”Apple iPad” }<br>{ “index”: { “_id”: 3 }}<br>{ “content”:”Apple employee like Apple Pie and Apple Juice” }</p>\n<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “match”:{“content”:”apple”}<br>      }<br>    }<br>  }<br>}</p>\n<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “match”:{“content”:”apple”}<br>      },<br>      “must_not”: {<br>        “match”:{“content”:”pie”}<br>      }<br>    }<br>  }<br>}</p>\n<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “boosting”: {<br>      “positive”: {<br>        “match”: {<br>          “content”: “apple”<br>        }<br>      },<br>      “negative”: {<br>        “match”: {<br>          “content”: “pie”<br>        }<br>      },<br>      “negative_boost”: 0.5<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 4.5-单字符串多字段查询-DisMaxQuery.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 单字符串多字段查询：Dis Max Query</span><br></pre></td></tr></table></figure>\n\n<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;1<br>{<br>    “title”: “Quick brown rabbits”,<br>    “body”:  “Brown rabbits are commonly seen.”<br>}</p>\n<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;2<br>{<br>    “title”: “Keeping pets healthy”,<br>    “body”:  “My quick brown fox eats rabbits on a regular basis.”<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>    “query”: {<br>        “bool”: {<br>            “should”: [<br>                { “match”: { “title”: “Brown fox” }},<br>                { “match”: { “body”:  “Brown fox” }}<br>            ]<br>        }<br>    }<br>}</p>\n<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ]<br>        }<br>    }<br>}</p>\n<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ],<br>            “tie_breaker”: 0.2<br>        }<br>    }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 4.6-单字符串多字段查询-Multi-Match.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 单字符串多字段查询：Multi Match</span><br></pre></td></tr></table></figure>\n<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ],<br>            “tie_breaker”: 0.2<br>        }<br>    }<br>}</p>\n<p>POST blogs&#x2F;_search<br>{<br>  “query”: {<br>    “multi_match”: {<br>      “type”: “best_fields”,<br>      “query”: “Quick pets”,<br>      “fields”: [“title”,”body”],<br>      “tie_breaker”: 0.2,<br>      “minimum_should_match”: “20%”<br>    }<br>  }<br>}</p>\n<p>POST books&#x2F;_search<br>{<br>    “multi_match”: {<br>        “query”:  “Quick brown fox”,<br>        “fields”: “*_title”<br>    }<br>}</p>\n<p>POST books&#x2F;_search<br>{<br>    “multi_match”: {<br>        “query”:  “Quick brown fox”,<br>        “fields”: [ “*_title”, “chapter_title^2” ]<br>    }<br>}</p>\n<p>DELETE &#x2F;titles<br>PUT &#x2F;titles<br>{<br>    “settings”: { “number_of_shards”: 1 },<br>    “mappings”: {<br>        “my_type”: {<br>            “properties”: {<br>                “title”: {<br>                    “type”:     “string”,<br>                    “analyzer”: “english”,<br>                    “fields”: {<br>                        “std”:   {<br>                            “type”:     “string”,<br>                            “analyzer”: “standard”<br>                        }<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>\n<p>PUT &#x2F;titles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title”: {<br>        “type”: “text”,<br>        “analyzer”: “english”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST titles&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title”: “My dog barks” }<br>{ “index”: { “_id”: 2 }}<br>{ “title”: “I see a lot of barking dogs on the road “ }</p>\n<p>GET titles&#x2F;_search<br>{<br>  “query”: {<br>    “match”: {<br>      “title”: “barking dogs”<br>    }<br>  }<br>}</p>\n<p>DELETE &#x2F;titles<br>PUT &#x2F;titles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title”: {<br>        “type”: “text”,<br>        “analyzer”: “english”,<br>        “fields”: {“std”: {“type”: “text”,”analyzer”: “standard”}}<br>      }<br>    }<br>  }<br>}</p>\n<p>POST titles&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title”: “My dog barks” }<br>{ “index”: { “_id”: 2 }}<br>{ “title”: “I see a lot of barking dogs on the road “ }</p>\n<p>GET &#x2F;titles&#x2F;_search<br>{<br>   “query”: {<br>        “multi_match”: {<br>            “query”:  “barking dogs”,<br>            “type”:   “most_fields”,<br>            “fields”: [ “title”, “title.std” ]<br>        }<br>    }<br>}</p>\n<p>GET &#x2F;titles&#x2F;_search<br>{<br>   “query”: {<br>        “multi_match”: {<br>            “query”:  “barking dogs”,<br>            “type”:   “most_fields”,<br>            “fields”: [ “title^10”, “title.std” ]<br>        }<br>    }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 4.7-多语言及中文分词与检索.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 多语言及中文分词与检索</span><br><span class=\"line\"></span><br><span class=\"line\">- 来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”</span><br><span class=\"line\"></span><br><span class=\"line\">- 你也想犯范范玮琪犯过的错吗</span><br><span class=\"line\">- 校长说衣服上除了校徽别别别的</span><br><span class=\"line\">- 这几天天天天气不好</span><br><span class=\"line\">- 我背有点驼，麻麻说“你的背得背背背背佳</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>#stop word</p>\n<p>DELETE my_index<br>PUT &#x2F;my_index&#x2F;_doc&#x2F;1<br>{ “title”: “I’m happy for this fox” }</p>\n<p>PUT &#x2F;my_index&#x2F;_doc&#x2F;2<br>{ “title”: “I’m not happy about my fox problem” }</p>\n<p>POST my_index&#x2F;_search<br>{<br>  “query”: {<br>    “match”: {<br>      “title”: “not happy fox”<br>    }<br>  }<br>}</p>\n<p>#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 <code>english</code>（英语）分析器，另一次使用 <code>standard</code>（标准）分析器:</p>\n<p>DELETE my_index</p>\n<p>PUT &#x2F;my_index<br>{<br>  “mappings”: {<br>    “blog”: {<br>      “properties”: {<br>        “title”: {<br>          “type”: “string”,<br>          “analyzer”: “english”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT &#x2F;my_index<br>{<br>  “mappings”: {<br>    “blog”: {<br>      “properties”: {<br>        “title”: {<br>          “type”: “string”,<br>          “fields”: {<br>            “english”: {<br>              “type”:     “string”,<br>              “analyzer”: “english”<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT &#x2F;my_index&#x2F;blog&#x2F;1<br>{ “title”: “I’m happy for this fox” }</p>\n<p>PUT &#x2F;my_index&#x2F;blog&#x2F;2<br>{ “title”: “I’m not happy about my fox problem” }</p>\n<p>GET &#x2F;_search<br>{<br>  “query”: {<br>    “multi_match”: {<br>      “type”:     “most_fields”,<br>      “query”:    “not happy foxes”,<br>      “fields”: [ “title”, “title.english” ]<br>    }<br>  }<br>}</p>\n<p>#安装插件<br>.&#x2F;elasticsearch-plugin install <a href=\"https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip\">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</a><br>#安装插件<br>bin&#x2F;elasticsearch install <a href=\"https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip\">https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip</a></p>\n<p>#ik_max_word<br>#ik_smart<br>#hanlp: hanlp默认分词<br>#hanlp_standard: 标准分词<br>#hanlp_index: 索引分词<br>#hanlp_nlp: NLP分词<br>#hanlp_n_short: N-最短路分词<br>#hanlp_dijkstra: 最短路分词<br>#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）<br>#hanlp_speed: 极速词典分词</p>\n<p>POST _analyze<br>{<br>  “analyzer”: “hanlp_standard”,<br>  “text”: [“剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜”]</p>\n<p>}     </p>\n<p>#Pinyin<br>PUT &#x2F;artists&#x2F;<br>{<br>    “settings” : {<br>        “analysis” : {<br>            “analyzer” : {<br>                “user_name_analyzer” : {<br>                    “tokenizer” : “whitespace”,<br>                    “filter” : “pinyin_first_letter_and_full_pinyin_filter”<br>                }<br>            },<br>            “filter” : {<br>                “pinyin_first_letter_and_full_pinyin_filter” : {<br>                    “type” : “pinyin”,<br>                    “keep_first_letter” : true,<br>                    “keep_full_pinyin” : false,<br>                    “keep_none_chinese” : true,<br>                    “keep_original” : false,<br>                    “limit_first_letter_length” : 16,<br>                    “lowercase” : true,<br>                    “trim_whitespace” : true,<br>                    “keep_none_chinese_in_first_letter” : true<br>                }<br>            }<br>        }<br>    }<br>}</p>\n<p>GET &#x2F;artists&#x2F;_analyze<br>{<br>  “text”: [“刘德华 张学友 郭富城 黎明 四大天王”],<br>  “analyzer”: “user_name_analyzer”<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## 相关资源</span><br><span class=\"line\">- Elasticsearch IK分词插件 https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br><span class=\"line\">- Elasticsearch hanlp 分词插件 https://github.com/KennFalcon/elasticsearch-analysis-hanlp</span><br><span class=\"line\"></span><br><span class=\"line\">- 分词算法综述 https://zhuanlan.zhihu.com/p/50444885</span><br><span class=\"line\"></span><br><span class=\"line\">### 一些分词工具，供参考：</span><br><span class=\"line\">- 中科院计算所NLPIR http://ictclas.nlpir.org/nlpir/</span><br><span class=\"line\">- ansj分词器 https://github.com/NLPchina/ansj_seg</span><br><span class=\"line\">- 哈工大的LTP https://github.com/HIT-SCIR/ltp</span><br><span class=\"line\">- 清华大学THULAC https://github.com/thunlp/THULAC</span><br><span class=\"line\">- 斯坦福分词器 https://nlp.stanford.edu/software/segmenter.shtml</span><br><span class=\"line\">- Hanlp分词器 https://github.com/hankcs/HanLP</span><br><span class=\"line\">- 结巴分词 https://github.com/yanyiwu/cppjieba</span><br><span class=\"line\">- KCWS分词器(字嵌入+Bi-LSTM+CRF) https://github.com/koth/kcws</span><br><span class=\"line\">- ZPar https://github.com/frcchang/zpar/releases</span><br><span class=\"line\">- IKAnalyzer https://github.com/wks/ik-analyzer</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.8-SpaceJam一个全文搜索的实例.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Space Jam，一次全文搜索的实例</span><br><span class=\"line\"></span><br><span class=\"line\">## 环境要求</span><br><span class=\"line\">- Python 2.7.15</span><br><span class=\"line\">- 可以使用pyenv管理多个python版本（可选）</span><br><span class=\"line\"></span><br><span class=\"line\">## 进入 tmdb-search目录</span><br><span class=\"line\">Run</span><br><span class=\"line\">pip install -r requirements.txt</span><br><span class=\"line\">Run python ./ingest_tmdb_from_file.py</span><br></pre></td></tr></table></figure>\n<p>POST tmdb&#x2F;_search<br>{<br>“_source”: [“title”,”overview”],<br> “query”: {<br>   “match_all”: {}<br> }<br>}</p>\n<p>POST tmdb&#x2F;_search<br>{<br>  “_source”: [“title”,”overview”],<br>  “query”: {<br>    “multi_match”: {<br>      “query”: “basketball with cartoon aliens”,<br>      “fields”: [“title”,”overview”]<br>    }<br>  },<br>  “highlight” : {<br>        “fields” : {<br>            “overview” : { “pre_tags” : [“\\033[0;32;40m”], “post_tags” : [“\\033[0m”] },<br>            “title” : { “pre_tags” : [“\\033[0;32;40m”], “post_tags” : [“\\033[0m”] }</p>\n<pre><code>    &#125;\n&#125;\n</code></pre>\n<p>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## 相关</span><br><span class=\"line\">- Windows 安装 pyenv https://github.com/pyenv-win/pyenv-win</span><br><span class=\"line\">- Mac 安装pyenv https://segmentfault.com/a/1190000017403221</span><br><span class=\"line\">- Linux 安装 pyenv https://blog.csdn.net/GX_1_11_real/article/details/80237064</span><br><span class=\"line\">- Python.org https://www.python.org/</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.9-使用SearchTemplate和IndexAlias进行查询.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 使用 Search Template 和 Index Alias 查询</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>POST _scripts&#x2F;tmdb<br>{<br>  “script”: {<br>    “lang”: “mustache”,<br>    “source”: {<br>      “_source”: [<br>        “title”,”overview”<br>      ],<br>      “size”: 20,<br>      “query”: {<br>        “multi_match”: {<br>          “query”: ““,<br>          “fields”: [“title”,”overview”]<br>        }<br>      }<br>    }<br>  }<br>}<br>DELETE _scripts&#x2F;tmdb</p>\n<p>GET _scripts&#x2F;tmdb</p>\n<p>POST tmdb&#x2F;_search&#x2F;template<br>{<br>    “id”:”tmdb”,<br>    “params”: {<br>        “q”: “basketball with cartoon aliens”<br>    }<br>}</p>\n<p>PUT movies-2019&#x2F;_doc&#x2F;1<br>{<br>  “name”:”the matrix”,<br>  “rating”:5<br>}</p>\n<p>PUT movies-2019&#x2F;_doc&#x2F;2<br>{<br>  “name”:”Speed”,<br>  “rating”:3<br>}</p>\n<p>POST _aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “movies-2019”,<br>        “alias”: “movies-latest”<br>      }<br>    }<br>  ]<br>}</p>\n<p>POST movies-latest&#x2F;_search<br>{<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>\n<p>POST _aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “movies-2019”,<br>        “alias”: “movies-lastest-highrate”,<br>        “filter”: {<br>          “range”: {<br>            “rating”: {<br>              “gte”: 4<br>            }<br>          }<br>        }<br>      }<br>    }<br>  ]<br>}</p>\n<p>POST movies-lastest-highrate&#x2F;_search<br>{<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.1-集群分布式模型及选主与脑裂问题.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 集群分布式模型及选主与脑裂问题</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>bin&#x2F;elasticsearch -E node.name&#x3D;node1 -E cluster.name&#x3D;geektime -E path.data&#x3D;node1_data<br>bin&#x2F;elasticsearch -E node.name&#x3D;node2 -E cluster.name&#x3D;geektime -E path.data&#x3D;node2_data<br>bin&#x2F;elasticsearch -E node.name&#x3D;node3 -E cluster.name&#x3D;geektime -E path.data&#x3D;node3_data</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 5.2-分片与集群的故障转移.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 分片与集群的故障转移</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.3-文档分布式存储.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 文档分布式存储</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.4-分片及其生命周期.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 分片及其生命周期</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.5-剖析分布式查询及相关性评分.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 剖析分布式查询及相关性评分</span><br></pre></td></tr></table></figure>\n<p>DELETE message<br>PUT message<br>{<br>  “settings”: {<br>    “number_of_shards”: 20<br>  }<br>}</p>\n<p>GET message</p>\n<p>POST message&#x2F;_doc?routing&#x3D;1<br>{<br>  “content”:”good”<br>}</p>\n<p>POST message&#x2F;_doc?routing&#x3D;2<br>{<br>  “content”:”good morning”<br>}</p>\n<p>POST message&#x2F;_doc?routing&#x3D;3<br>{<br>  “content”:”good morning everyone”<br>}</p>\n<p>POST message&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>\n<p>POST message&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “content”: {<br>        “value”: “good”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST message&#x2F;_search?search_type&#x3D;dfs_query_then_fetch<br>{</p>\n<p>  “query”: {<br>    “term”: {<br>      “content”: {<br>        “value”: “good”<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.6-排序及DocValues&amp;Fielddata.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 排序及Doc Values &amp; Fielddata</span><br></pre></td></tr></table></figure>\n<p>#单字段排序<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>\n<pre><code>&#125;\n</code></pre>\n<p>  },<br>  “sort”: [<br>    {“order_date”: {“order”: “desc”}}<br>  ]<br>}</p>\n<p>#多字段排序<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>\n<pre><code>&#125;\n</code></pre>\n<p>  },<br>  “sort”: [<br>    {“order_date”: {“order”: “desc”}},<br>    {“_doc”:{“order”: “asc”}},<br>    {“_score”:{ “order”: “desc”}}<br>  ]<br>}</p>\n<p>GET kibana_sample_data_ecommerce&#x2F;_mapping</p>\n<p>#对 text 字段进行排序。默认会报错，需打开fielddata<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>\n<pre><code>&#125;\n</code></pre>\n<p>  },<br>  “sort”: [<br>    {“customer_full_name”: {“order”: “desc”}}<br>  ]<br>}</p>\n<p>#打开 text的 fielddata<br>PUT kibana_sample_data_ecommerce&#x2F;_mapping<br>{<br>  “properties”: {<br>    “customer_full_name” : {<br>          “type” : “text”,<br>          “fielddata”: true,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 256<br>            }<br>          }<br>        }<br>  }<br>}</p>\n<p>#关闭 keyword的 doc values<br>PUT test_keyword<br>PUT test_keyword&#x2F;_mapping<br>{<br>  “properties”: {<br>    “user_name”:{<br>      “type”: “keyword”,<br>      “doc_values”:false<br>    }<br>  }<br>}</p>\n<p>DELETE test_keyword</p>\n<p>PUT test_text<br>PUT test_text&#x2F;_mapping<br>{<br>  “properties”: {<br>    “intro”:{<br>      “type”: “text”,<br>      “doc_values”:true<br>    }<br>  }<br>}</p>\n<p>DELETE test_text</p>\n<p>DELETE temp_users<br>PUT temp_users<br>PUT temp_users&#x2F;_mapping<br>{<br>  “properties”: {<br>    “name”:{“type”: “text”,”fielddata”: true},<br>    “desc”:{“type”: “text”,”fielddata”: true}<br>  }<br>}</p>\n<p>Post temp_users&#x2F;_doc<br>{“name”:”Jack”,”desc”:”Jack is a good boy!”,”age”:10}</p>\n<p>#打开fielddata 后，查看 docvalue_fields数据<br>POST  temp_users&#x2F;_search<br>{<br>  “docvalue_fields”: [<br>    “name”,”desc”<br>    ]<br>}</p>\n<p>#查看整型字段的docvalues<br>POST  temp_users&#x2F;_search<br>{<br>  “docvalue_fields”: [<br>    “age”<br>    ]<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 分页与遍历 - From, Size, Search_after &amp; Scroll API</span><br></pre></td></tr></table></figure>\n\n<p>POST tmdb&#x2F;_search<br>{<br>  “from”: 10000,<br>  “size”: 1,<br>  “query”: {<br>    “match_all”: {</p>\n<pre><code>&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Scroll API<br>DELETE users</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user1”,”age”:10}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:11}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:12}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:13}</p>\n<p>POST users&#x2F;_count</p>\n<p>POST users&#x2F;_search<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all”: {}<br>    },<br>    “sort”: [<br>        {“age”: “desc”} ,<br>        {“_id”: “asc”}<br>    ]<br>}</p>\n<p>POST users&#x2F;_search<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all”: {}<br>    },<br>    “search_after”:<br>        [<br>          10,<br>          “ZQ0vYGsBrR8X3IP75QqX”],<br>    “sort”: [<br>        {“age”: “desc”} ,<br>        {“_id”: “asc”}<br>    ]<br>}</p>\n<p>#Scroll API<br>DELETE users<br>POST users&#x2F;_doc<br>{“name”:”user1”,”age”:10}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:20}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user3”,”age”:30}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user4”,”age”:40}</p>\n<p>POST &#x2F;users&#x2F;_search?scroll&#x3D;5m<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all” : {<br>        }<br>    }<br>}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user5”,”age”:50}<br>POST &#x2F;_search&#x2F;scroll<br>{<br>    “scroll” : “1m”,<br>    “scroll_id” : “DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ&#x3D;&#x3D;”<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.8-处理并发读写.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 处理并发读写操作</span><br></pre></td></tr></table></figure>\n\n<p>DELETE products<br>PUT products</p>\n<p>PUT products&#x2F;_doc&#x2F;1<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>\n<p>GET products&#x2F;_doc&#x2F;1</p>\n<p>PUT products&#x2F;_doc&#x2F;1?if_seq_no&#x3D;1&amp;if_primary_term&#x3D;1<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>\n<p>PUT products&#x2F;_doc&#x2F;1?version&#x3D;30000&amp;version_type&#x3D;external<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Bucket &amp; Metric Aggregation</span><br><span class=\"line\">## demos</span><br></pre></td></tr></table></figure>\n<p>DELETE &#x2F;employees<br>PUT &#x2F;employees&#x2F;<br>{<br>  “mappings” : {<br>      “properties” : {<br>        “age” : {<br>          “type” : “integer”<br>        },<br>        “gender” : {<br>          “type” : “keyword”<br>        },<br>        “job” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 50<br>            }<br>          }<br>        },<br>        “name” : {<br>          “type” : “keyword”<br>        },<br>        “salary” : {<br>          “type” : “integer”<br>        }<br>      }<br>    }<br>}</p>\n<p>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>\n<h1 id=\"Metric-聚合，找到最低的工资\"><a href=\"#Metric-聚合，找到最低的工资\" class=\"headerlink\" title=\"Metric 聚合，找到最低的工资\"></a>Metric 聚合，找到最低的工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “min_salary”: {<br>      “min”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"Metric-聚合，找到最高的工资\"><a href=\"#Metric-聚合，找到最高的工资\" class=\"headerlink\" title=\"Metric 聚合，找到最高的工资\"></a>Metric 聚合，找到最高的工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “max_salary”: {<br>      “max”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"多个-Metric-聚合，找到最低最高和平均工资\"><a href=\"#多个-Metric-聚合，找到最低最高和平均工资\" class=\"headerlink\" title=\"多个 Metric 聚合，找到最低最高和平均工资\"></a>多个 Metric 聚合，找到最低最高和平均工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “max_salary”: {<br>      “max”: {<br>        “field”: “salary”<br>      }<br>    },<br>    “min_salary”: {<br>      “min”: {<br>        “field”: “salary”<br>      }<br>    },<br>    “avg_salary”: {<br>      “avg”: {<br>        “field”: “salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"一个聚合，输出多值\"><a href=\"#一个聚合，输出多值\" class=\"headerlink\" title=\"一个聚合，输出多值\"></a>一个聚合，输出多值</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “stats_salary”: {<br>      “stats”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对keword-进行聚合\"><a href=\"#对keword-进行聚合\" class=\"headerlink\" title=\"对keword 进行聚合\"></a>对keword 进行聚合</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对-Text-字段进行-terms-聚合查询，失败\"><a href=\"#对-Text-字段进行-terms-聚合查询，失败\" class=\"headerlink\" title=\"对 Text 字段进行 terms 聚合查询，失败\"></a>对 Text 字段进行 terms 聚合查询，失败</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对-Text-字段打开-fielddata，支持terms-aggregation\"><a href=\"#对-Text-字段打开-fielddata，支持terms-aggregation\" class=\"headerlink\" title=\"对 Text 字段打开 fielddata，支持terms aggregation\"></a>对 Text 字段打开 fielddata，支持terms aggregation</h1><p>PUT employees&#x2F;_mapping<br>{<br>  “properties” : {<br>    “job”:{<br>       “type”:     “text”,<br>       “fielddata”: true<br>    }<br>  }<br>}</p>\n<h1 id=\"对-Text-字段进行-terms-分词。分词后的terms\"><a href=\"#对-Text-字段进行-terms-分词。分词后的terms\" class=\"headerlink\" title=\"对 Text 字段进行 terms 分词。分词后的terms\"></a>对 Text 字段进行 terms 分词。分词后的terms</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对job-keyword-和-job-进行-terms-聚合，分桶的总数并不一样\"><a href=\"#对job-keyword-和-job-进行-terms-聚合，分桶的总数并不一样\" class=\"headerlink\" title=\"对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样\"></a>对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “cardinate”: {<br>      “cardinality”: {<br>        “field”: “job”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对-性别的-keyword-进行聚合\"><a href=\"#对-性别的-keyword-进行聚合\" class=\"headerlink\" title=\"对 性别的 keyword 进行聚合\"></a>对 性别的 keyword 进行聚合</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “gender”: {<br>      “terms”: {<br>        “field”:”gender”<br>      }<br>    }<br>  }<br>}</p>\n<p>#指定 bucket 的 size<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “ages_5”: {<br>      “terms”: {<br>        “field”:”age”,<br>        “size”:3<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"指定size，不同工种中，年纪最大的3个员工的具体信息\"><a href=\"#指定size，不同工种中，年纪最大的3个员工的具体信息\" class=\"headerlink\" title=\"指定size，不同工种中，年纪最大的3个员工的具体信息\"></a>指定size，不同工种中，年纪最大的3个员工的具体信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      },<br>      “aggs”:{<br>        “old_employee”:{<br>          “top_hits”:{<br>            “size”:3,<br>            “sort”:[<br>              {<br>                “age”:{<br>                  “order”:”desc”<br>                }<br>              }<br>            ]<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#Salary Ranges 分桶，可以自己定义 key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “salary_range”: {<br>      “range”: {<br>        “field”:”salary”,<br>        “ranges”:[<br>          {<br>            “to”:10000<br>          },<br>          {<br>            “from”:10000,<br>            “to”:20000<br>          },<br>          {<br>            “key”:”&gt;20000”,<br>            “from”:20000<br>          }<br>        ]<br>      }<br>    }<br>  }<br>}</p>\n<p>#Salary Histogram,工资0到10万，以 5000一个区间进行分桶<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “salary_histrogram”: {<br>      “histogram”: {<br>        “field”:”salary”,<br>        “interval”:5000,<br>        “extended_bounds”:{<br>          “min”:0,<br>          “max”:100000</p>\n<pre><code>    &#125;\n  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<h1 id=\"嵌套聚合1，按照工作类型分桶，并统计工资信息\"><a href=\"#嵌套聚合1，按照工作类型分桶，并统计工资信息\" class=\"headerlink\" title=\"嵌套聚合1，按照工作类型分桶，并统计工资信息\"></a>嵌套聚合1，按照工作类型分桶，并统计工资信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “Job_salary_stats”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      },<br>      “aggs”: {<br>        “salary”: {<br>          “stats”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\"><a href=\"#多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\" class=\"headerlink\" title=\"多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\"></a>多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “Job_gender_stats”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      },<br>      “aggs”: {<br>        “gender_stats”: {<br>          “terms”: {<br>            “field”: “gender”<br>          },<br>          “aggs”: {<br>            “salary_stats”: {<br>              “stats”: {<br>                “field”: “salary”<br>              }<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 6.2-Pipeline聚合分析.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Pipeline 聚合分析</span><br></pre></td></tr></table></figure>\n<p>DELETE employees<br>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>\n<h1 id=\"平均工资最低的工作类型\"><a href=\"#平均工资最低的工作类型\" class=\"headerlink\" title=\"平均工资最低的工作类型\"></a>平均工资最低的工作类型</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “min_salary_by_job”:{<br>      “min_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"平均工资最高的工作类型\"><a href=\"#平均工资最高的工作类型\" class=\"headerlink\" title=\"平均工资最高的工作类型\"></a>平均工资最高的工作类型</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “max_salary_by_job”:{<br>      “max_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"平均工资的平均工资\"><a href=\"#平均工资的平均工资\" class=\"headerlink\" title=\"平均工资的平均工资\"></a>平均工资的平均工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “avg_salary_by_job”:{<br>      “avg_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"平均工资的统计分析\"><a href=\"#平均工资的统计分析\" class=\"headerlink\" title=\"平均工资的统计分析\"></a>平均工资的统计分析</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “stats_salary_by_job”:{<br>      “stats_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"平均工资的百分位数\"><a href=\"#平均工资的百分位数\" class=\"headerlink\" title=\"平均工资的百分位数\"></a>平均工资的百分位数</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “percentiles_salary_by_job”:{<br>      “percentiles_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<p>#按照年龄对平均工资求导<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “derivative_avg_salary”:{<br>          “derivative”: {<br>            “buckets_path”: “avg_salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#Cumulative_sum<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “cumulative_salary”:{<br>          “cumulative_sum”: {<br>            “buckets_path”: “avg_salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#Moving Function<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “moving_avg_salary”:{<br>          “moving_fn”: {<br>            “buckets_path”: “avg_salary”,<br>            “window”:10,<br>            “script”: “MovingFunctions.min(values)”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 6.3-作用范围与排序.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 作用范围与排序</span><br></pre></td></tr></table></figure>\n<p>DELETE &#x2F;employees<br>PUT &#x2F;employees&#x2F;<br>{<br>  “mappings” : {<br>      “properties” : {<br>        “age” : {<br>          “type” : “integer”<br>        },<br>        “gender” : {<br>          “type” : “keyword”<br>        },<br>        “job” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 50<br>            }<br>          }<br>        },<br>        “name” : {<br>          “type” : “keyword”<br>        },<br>        “salary” : {<br>          “type” : “integer”<br>        }<br>      }<br>    }<br>}</p>\n<p>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>\n<h1 id=\"Query\"><a href=\"#Query\" class=\"headerlink\" title=\"Query\"></a>Query</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>\n<pre><code>  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Filter<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “older_person”: {<br>      “filter”:{<br>        “range”:{<br>          “age”:{<br>            “from”:35<br>          }<br>        }<br>      },<br>      “aggs”:{<br>         “jobs”:{<br>           “terms”: {<br>        “field”:”job.keyword”<br>      }<br>      }<br>    }},<br>    “all_jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>\n<pre><code>  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果<br>POST employees&#x2F;_search<br>{<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      }<br>    }<br>  },<br>  “post_filter”: {<br>    “match”: {<br>      “job.keyword”: “Dev Manager”<br>    }<br>  }<br>}</p>\n<p>#global<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 40<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>\n<pre><code>  &#125;\n&#125;,\n\n&quot;all&quot;:&#123;\n  &quot;global&quot;:&#123;&#125;,\n  &quot;aggs&quot;:&#123;\n    &quot;salary_avg&quot;:&#123;\n      &quot;avg&quot;:&#123;\n        &quot;field&quot;:&quot;salary&quot;\n      &#125;\n    &#125;\n  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[<br>          {“_count”:”asc”},<br>          {“_key”:”desc”}<br>          ]</p>\n<pre><code>  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[  {<br>            “avg_salary”:”desc”<br>          }]</p>\n<pre><code>  &#125;,\n&quot;aggs&quot;: &#123;\n  &quot;avg_salary&quot;: &#123;\n    &quot;avg&quot;: &#123;\n      &quot;field&quot;:&quot;salary&quot;\n    &#125;\n  &#125;\n&#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[  {<br>            “stats_salary.min”:”desc”<br>          }]</p>\n<pre><code>  &#125;,\n&quot;aggs&quot;: &#123;\n  &quot;stats_salary&quot;: &#123;\n    &quot;stats&quot;: &#123;\n      &quot;field&quot;:&quot;salary&quot;\n    &#125;\n  &#125;\n&#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 6.4-聚合分析的原理及精准度问题.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 聚合分析的原理及精准度问题</span><br></pre></td></tr></table></figure>\n<p>DELETE my_flights<br>PUT my_flights<br>{<br>  “settings”: {<br>    “number_of_shards”: 20<br>  },<br>  “mappings” : {<br>      “properties” : {<br>        “AvgTicketPrice” : {<br>          “type” : “float”<br>        },<br>        “Cancelled” : {<br>          “type” : “boolean”<br>        },<br>        “Carrier” : {<br>          “type” : “keyword”<br>        },<br>        “Dest” : {<br>          “type” : “keyword”<br>        },<br>        “DestAirportID” : {<br>          “type” : “keyword”<br>        },<br>        “DestCityName” : {<br>          “type” : “keyword”<br>        },<br>        “DestCountry” : {<br>          “type” : “keyword”<br>        },<br>        “DestLocation” : {<br>          “type” : “geo_point”<br>        },<br>        “DestRegion” : {<br>          “type” : “keyword”<br>        },<br>        “DestWeather” : {<br>          “type” : “keyword”<br>        },<br>        “DistanceKilometers” : {<br>          “type” : “float”<br>        },<br>        “DistanceMiles” : {<br>          “type” : “float”<br>        },<br>        “FlightDelay” : {<br>          “type” : “boolean”<br>        },<br>        “FlightDelayMin” : {<br>          “type” : “integer”<br>        },<br>        “FlightDelayType” : {<br>          “type” : “keyword”<br>        },<br>        “FlightNum” : {<br>          “type” : “keyword”<br>        },<br>        “FlightTimeHour” : {<br>          “type” : “keyword”<br>        },<br>        “FlightTimeMin” : {<br>          “type” : “float”<br>        },<br>        “Origin” : {<br>          “type” : “keyword”<br>        },<br>        “OriginAirportID” : {<br>          “type” : “keyword”<br>        },<br>        “OriginCityName” : {<br>          “type” : “keyword”<br>        },<br>        “OriginCountry” : {<br>          “type” : “keyword”<br>        },<br>        “OriginLocation” : {<br>          “type” : “geo_point”<br>        },<br>        “OriginRegion” : {<br>          “type” : “keyword”<br>        },<br>        “OriginWeather” : {<br>          “type” : “keyword”<br>        },<br>        “dayOfWeek” : {<br>          “type” : “integer”<br>        },<br>        “timestamp” : {<br>          “type” : “date”<br>        }<br>      }<br>    }<br>}</p>\n<p>POST _reindex<br>{<br>  “source”: {<br>    “index”: “kibana_sample_data_flights”<br>  },<br>  “dest”: {<br>    “index”: “my_flights”<br>  }<br>}</p>\n<p>GET kibana_sample_data_flights&#x2F;_count<br>GET my_flights&#x2F;_count</p>\n<p>get kibana_sample_data_flights&#x2F;_search</p>\n<p>GET kibana_sample_data_flights&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “weather”: {<br>      “terms”: {<br>        “field”:”OriginWeather”,<br>        “size”:5,<br>        “show_term_doc_count_error”:true<br>      }<br>    }<br>  }<br>}</p>\n<p>GET my_flights&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “weather”: {<br>      “terms”: {<br>        “field”:”OriginWeather”,<br>        “size”:1,<br>        “shard_size”:1,<br>        “show_term_doc_count_error”:true<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 7.1-对象及 Nested 对象.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 对象及Nested对象</span><br></pre></td></tr></table></figure>\n<p>DELETE blog</p>\n<h1 id=\"设置blog的-Mapping\"><a href=\"#设置blog的-Mapping\" class=\"headerlink\" title=\"设置blog的 Mapping\"></a>设置blog的 Mapping</h1><p>PUT &#x2F;blog<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “content”: {<br>        “type”: “text”<br>      },<br>      “time”: {<br>        “type”: “date”<br>      },<br>      “user”: {<br>        “properties”: {<br>          “city”: {<br>            “type”: “text”<br>          },<br>          “userid”: {<br>            “type”: “long”<br>          },<br>          “username”: {<br>            “type”: “keyword”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"插入一条-Blog-信息\"><a href=\"#插入一条-Blog-信息\" class=\"headerlink\" title=\"插入一条 Blog 信息\"></a>插入一条 Blog 信息</h1><p>PUT blog&#x2F;_doc&#x2F;1<br>{<br>  “content”:”I like Elasticsearch”,<br>  “time”:”2019-01-01T00:00:00”,<br>  “user”:{<br>    “userid”:1,<br>    “username”:”Jack”,<br>    “city”:”Shanghai”<br>  }<br>}</p>\n<h1 id=\"查询-Blog-信息\"><a href=\"#查询-Blog-信息\" class=\"headerlink\" title=\"查询 Blog 信息\"></a>查询 Blog 信息</h1><p>POST blog&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“content”: “Elasticsearch”}},<br>        {“match”: {“user.username”: “Jack”}}<br>      ]<br>    }<br>  }<br>}</p>\n<p>DELETE my_movies</p>\n<h1 id=\"电影的Mapping信息\"><a href=\"#电影的Mapping信息\" class=\"headerlink\" title=\"电影的Mapping信息\"></a>电影的Mapping信息</h1><p>PUT my_movies<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “actors” : {<br>          “properties” : {<br>            “first_name” : {<br>              “type” : “keyword”<br>            },<br>            “last_name” : {<br>              “type” : “keyword”<br>            }<br>          }<br>        },<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 256<br>            }<br>          }<br>        }<br>      }<br>    }<br>}</p>\n<h1 id=\"写入一条电影信息\"><a href=\"#写入一条电影信息\" class=\"headerlink\" title=\"写入一条电影信息\"></a>写入一条电影信息</h1><p>POST my_movies&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Speed”,<br>  “actors”:[<br>    {<br>      “first_name”:”Keanu”,<br>      “last_name”:”Reeves”<br>    },</p>\n<pre><code>&#123;\n  &quot;first_name&quot;:&quot;Dennis&quot;,\n  &quot;last_name&quot;:&quot;Hopper&quot;\n&#125;\n</code></pre>\n<p>  ]<br>}</p>\n<h1 id=\"查询电影信息\"><a href=\"#查询电影信息\" class=\"headerlink\" title=\"查询电影信息\"></a>查询电影信息</h1><p>POST my_movies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“actors.first_name”: “Keanu”}},<br>        {“match”: {“actors.last_name”: “Hopper”}}<br>      ]<br>    }<br>  }</p>\n<p>}</p>\n<p>DELETE my_movies</p>\n<h1 id=\"创建-Nested-对象-Mapping\"><a href=\"#创建-Nested-对象-Mapping\" class=\"headerlink\" title=\"创建 Nested 对象 Mapping\"></a>创建 Nested 对象 Mapping</h1><p>PUT my_movies<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “actors” : {<br>          “type”: “nested”,<br>          “properties” : {<br>            “first_name” : {“type” : “keyword”},<br>            “last_name” : {“type” : “keyword”}<br>          }},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {“keyword”:{“type”:”keyword”,”ignore_above”:256}}<br>        }<br>      }<br>    }<br>}</p>\n<p>POST my_movies&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Speed”,<br>  “actors”:[<br>    {<br>      “first_name”:”Keanu”,<br>      “last_name”:”Reeves”<br>    },</p>\n<pre><code>&#123;\n  &quot;first_name&quot;:&quot;Dennis&quot;,\n  &quot;last_name&quot;:&quot;Hopper&quot;\n&#125;\n</code></pre>\n<p>  ]<br>}</p>\n<h1 id=\"Nested-查询\"><a href=\"#Nested-查询\" class=\"headerlink\" title=\"Nested 查询\"></a>Nested 查询</h1><p>POST my_movies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“title”: “Speed”}},<br>        {<br>          “nested”: {<br>            “path”: “actors”,<br>            “query”: {<br>              “bool”: {<br>                “must”: [<br>                  {“match”: {<br>                    “actors.first_name”: “Keanu”<br>                  }},</p>\n<pre><code>              &#123;&quot;match&quot;: &#123;\n                &quot;actors.last_name&quot;: &quot;Hopper&quot;\n              &#125;&#125;\n            ]\n          &#125;\n        &#125;\n      &#125;\n    &#125;\n  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<h1 id=\"Nested-Aggregation\"><a href=\"#Nested-Aggregation\" class=\"headerlink\" title=\"Nested Aggregation\"></a>Nested Aggregation</h1><p>POST my_movies&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “actors”: {<br>      “nested”: {<br>        “path”: “actors”<br>      },<br>      “aggs”: {<br>        “actor_name”: {<br>          “terms”: {<br>            “field”: “actors.first_name”,<br>            “size”: 10<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"普通-aggregation不工作\"><a href=\"#普通-aggregation不工作\" class=\"headerlink\" title=\"普通 aggregation不工作\"></a>普通 aggregation不工作</h1><p>POST my_movies&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “NAME”: {<br>      “terms”: {<br>        “field”: “actors.first_name”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 7.2-文档的父子关系.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 文档的父子关系</span><br></pre></td></tr></table></figure>\n<p>DELETE my_blogs</p>\n<h1 id=\"设定-Parent-Child-Mapping\"><a href=\"#设定-Parent-Child-Mapping\" class=\"headerlink\" title=\"设定 Parent&#x2F;Child Mapping\"></a>设定 Parent&#x2F;Child Mapping</h1><p>PUT my_blogs<br>{<br>  “settings”: {<br>    “number_of_shards”: 2<br>  },<br>  “mappings”: {<br>    “properties”: {<br>      “blog_comments_relation”: {<br>        “type”: “join”,<br>        “relations”: {<br>          “blog”: “comment”<br>        }<br>      },<br>      “content”: {<br>        “type”: “text”<br>      },<br>      “title”: {<br>        “type”: “keyword”<br>      }<br>    }<br>  }<br>}</p>\n<p>#索引父文档<br>PUT my_blogs&#x2F;_doc&#x2F;blog1<br>{<br>  “title”:”Learning Elasticsearch”,<br>  “content”:”learning ELK @ geektime”,<br>  “blog_comments_relation”:{<br>    “name”:”blog”<br>  }<br>}</p>\n<p>#索引父文档<br>PUT my_blogs&#x2F;_doc&#x2F;blog2<br>{<br>  “title”:”Learning Hadoop”,<br>  “content”:”learning Hadoop”,<br>    “blog_comments_relation”:{<br>    “name”:”blog”<br>  }<br>}</p>\n<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment1?routing&#x3D;blog1<br>{<br>  “comment”:”I am learning ELK”,<br>  “username”:”Jack”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog1”<br>  }<br>}</p>\n<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment2?routing&#x3D;blog2<br>{<br>  “comment”:”I like Hadoop!!!!!”,<br>  “username”:”Jack”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog2”<br>  }<br>}</p>\n<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2<br>{<br>  “comment”:”Hello Hadoop”,<br>  “username”:”Bob”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog2”<br>  }<br>}</p>\n<h1 id=\"查询所有文档\"><a href=\"#查询所有文档\" class=\"headerlink\" title=\"查询所有文档\"></a>查询所有文档</h1><p>POST my_blogs&#x2F;_search<br>{</p>\n<p>}</p>\n<p>#根据父文档ID查看<br>GET my_blogs&#x2F;_doc&#x2F;blog2</p>\n<h1 id=\"Parent-Id-查询\"><a href=\"#Parent-Id-查询\" class=\"headerlink\" title=\"Parent Id 查询\"></a>Parent Id 查询</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “parent_id”: {<br>      “type”: “comment”,<br>      “id”: “blog2”<br>    }<br>  }<br>}</p>\n<h1 id=\"Has-Child-查询-返回父文档\"><a href=\"#Has-Child-查询-返回父文档\" class=\"headerlink\" title=\"Has Child 查询,返回父文档\"></a>Has Child 查询,返回父文档</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “has_child”: {<br>      “type”: “comment”,<br>      “query” : {<br>                “match”: {<br>                    “username” : “Jack”<br>                }<br>            }<br>    }<br>  }<br>}</p>\n<h1 id=\"Has-Parent-查询，返回相关的子文档\"><a href=\"#Has-Parent-查询，返回相关的子文档\" class=\"headerlink\" title=\"Has Parent 查询，返回相关的子文档\"></a>Has Parent 查询，返回相关的子文档</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “has_parent”: {<br>      “parent_type”: “blog”,<br>      “query” : {<br>                “match”: {<br>                    “title” : “Learning Hadoop”<br>                }<br>            }<br>    }<br>  }<br>}</p>\n<p>#通过ID ，访问子文档<br>GET my_blogs&#x2F;_doc&#x2F;comment3<br>#通过ID和routing ，访问子文档<br>GET my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2</p>\n<p>#更新子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2<br>{<br>    “comment”: “Hello Hadoop??”,<br>    “blog_comments_relation”: {<br>      “name”: “comment”,<br>      “parent”: “blog2”<br>    }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 7.5-Elasticsearch数据建模实例.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Elasticsearch 数据建模实例</span><br></pre></td></tr></table></figure>\n<h6 id=\"Data-Modeling-Example\"><a href=\"#Data-Modeling-Example\" class=\"headerlink\" title=\"Data Modeling Example\"></a>Data Modeling Example</h6><h1 id=\"Index-一本书的信息\"><a href=\"#Index-一本书的信息\" class=\"headerlink\" title=\"Index 一本书的信息\"></a>Index 一本书的信息</h1><p>PUT books&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Mastering ElasticSearch 5.0”,<br>  “description”:”Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins”,<br>  “author”:”Bharvi Dixit”,<br>  “public_date”:”2017”,<br>  “cover_url”:”<a href=\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>}</p>\n<p>#查询自动创建的Mapping<br>GET books&#x2F;_mapping</p>\n<p>DELETE books</p>\n<p>#优化字段类型<br>PUT books<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “author” : {“type” : “keyword”},<br>        “cover_url” : {“type” : “keyword”,”index”: false},<br>        “description” : {“type” : “text”},<br>        “public_date” : {“type” : “date”},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 100<br>            }<br>          }<br>        }<br>      }<br>    }<br>}</p>\n<p>#Cover URL index 设置成false，无法对该字段进行搜索<br>POST books&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “cover_url”: {<br>        “value”: “<a href=\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>      }<br>    }<br>  }<br>}</p>\n<p>#Cover URL index 设置成false，依然支持聚合分析<br>POST books&#x2F;_search<br>{<br>  “aggs”: {<br>    “cover”: {<br>      “terms”: {<br>        “field”: “cover_url”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>\n<p>DELETE books<br>#新增 Content字段。数据量很大。选择将Source 关闭<br>PUT books<br>{<br>      “mappings” : {<br>      “_source”: {“enabled”: false},<br>      “properties” : {<br>        “author” : {“type” : “keyword”,”store”: true},<br>        “cover_url” : {“type” : “keyword”,”index”: false,”store”: true},<br>        “description” : {“type” : “text”,”store”: true},<br>         “content” : {“type” : “text”,”store”: true},<br>        “public_date” : {“type” : “date”,”store”: true},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 100<br>            }<br>          },<br>          “store”: true<br>        }<br>      }<br>    }<br>}</p>\n<h1 id=\"Index-一本书的信息-包含Content\"><a href=\"#Index-一本书的信息-包含Content\" class=\"headerlink\" title=\"Index 一本书的信息,包含Content\"></a>Index 一本书的信息,包含Content</h1><p>PUT books&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Mastering ElasticSearch 5.0”,<br>  “description”:”Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins”,<br>  “content”:”The content of the book……Indexing data, aggregation, searching.    something else. something in the way…………”,<br>  “author”:”Bharvi Dixit”,<br>  “public_date”:”2017”,<br>  “cover_url”:”<a href=\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>}</p>\n<p>#查询结果中，Source不包含数据<br>POST books&#x2F;_search<br>{}</p>\n<p>#搜索，通过store 字段显示数据，同时高亮显示 conent的内容<br>POST books&#x2F;_search<br>{<br>  “stored_fields”: [“title”,”author”,”public_date”],<br>  “query”: {<br>    “match”: {<br>      “content”: “searching”<br>    }<br>  },</p>\n<p>  “highlight”: {<br>    “fields”: {<br>      “content”:{}<br>    }<br>  }</p>\n<p>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 7.6-Elasticsearch 数据建模最佳实践.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Elasticsearch 数据建模最佳实践</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Cookie-Service\"><a href=\"#Cookie-Service\" class=\"headerlink\" title=\"Cookie Service\"></a>Cookie Service</h6><p>##索引数据，dynamic mapping 会不断加入新增字段<br>PUT cookie_service&#x2F;_doc&#x2F;1<br>{<br> “url”:”<a href=\"http://www.google.com/\">www.google.com</a>“,<br> “cookies”:{<br>   “username”:”tom”,<br>   “age”:32<br> }<br>}</p>\n<p>PUT cookie_service&#x2F;_doc&#x2F;2<br>{<br> “url”:”<a href=\"http://www.amazon.com/\">www.amazon.com</a>“,<br> “cookies”:{<br>   “login”:”2019-01-01”,<br>   “email”:”<a href=\"mailto:&#120;&#x79;&#x7a;&#x40;&#97;&#x62;&#99;&#46;&#99;&#111;&#109;\">&#120;&#x79;&#x7a;&#x40;&#97;&#x62;&#99;&#46;&#99;&#111;&#109;</a>“<br> }<br>}</p>\n<p>DELETE cookie_service<br>#使用 Nested 对象，增加key&#x2F;value<br>PUT cookie_service<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “cookies”: {<br>        “type”: “nested”,<br>        “properties”: {<br>          “name”: {<br>            “type”: “keyword”<br>          },<br>          “dateValue”: {<br>            “type”: “date”<br>          },<br>          “keywordValue”: {<br>            “type”: “keyword”<br>          },<br>          “IntValue”: {<br>            “type”: “integer”<br>          }<br>        }<br>      },<br>      “url”: {<br>        “type”: “text”,<br>        “fields”: {<br>          “keyword”: {<br>            “type”: “keyword”,<br>            “ignore_above”: 256<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>##写入数据，使用key和合适类型的value字段<br>PUT cookie_service&#x2F;_doc&#x2F;1<br>{<br> “url”:”<a href=\"http://www.google.com/\">www.google.com</a>“,<br> “cookies”:[<br>    {<br>      “name”:”username”,<br>      “keywordValue”:”tom”<br>    },<br>    {<br>       “name”:”age”,<br>      “intValue”:32</p>\n<pre><code>&#125;\n</code></pre>\n<p>   ]<br> }</p>\n<p>PUT cookie_service&#x2F;_doc&#x2F;2<br>{<br> “url”:”<a href=\"http://www.amazon.com/\">www.amazon.com</a>“,<br> “cookies”:[<br>    {<br>      “name”:”login”,<br>      “dateValue”:”2019-01-01”<br>    },<br>    {<br>       “name”:”email”,<br>      “IntValue”:32</p>\n<pre><code>&#125;\n</code></pre>\n<p>   ]<br> }</p>\n<h1 id=\"Nested-查询，通过bool查询进行过滤\"><a href=\"#Nested-查询，通过bool查询进行过滤\" class=\"headerlink\" title=\"Nested 查询，通过bool查询进行过滤\"></a>Nested 查询，通过bool查询进行过滤</h1><p>POST cookie_service&#x2F;_search<br>{<br>  “query”: {<br>    “nested”: {<br>      “path”: “cookies”,<br>      “query”: {<br>        “bool”: {<br>          “filter”: [<br>            {<br>            “term”: {<br>              “cookies.name”: “age”<br>            }},<br>            {<br>              “range”:{<br>                “cookies.intValue”:{<br>                  “gte”:30<br>                }<br>              }<br>            }<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"在Mapping中加入元信息，便于管理\"><a href=\"#在Mapping中加入元信息，便于管理\" class=\"headerlink\" title=\"在Mapping中加入元信息，便于管理\"></a>在Mapping中加入元信息，便于管理</h1><p>PUT softwares&#x2F;<br>{<br>  “mappings”: {<br>    “_meta”: {<br>      “software_version_mapping”: “1.0”<br>    }<br>  }<br>}</p>\n<p>GET softwares&#x2F;_mapping<br>PUT softwares&#x2F;_doc&#x2F;1<br>{<br>  “software_version”:”7.1.0”<br>}</p>\n<p>DELETE softwares</p>\n<h1 id=\"优化-使用inner-object\"><a href=\"#优化-使用inner-object\" class=\"headerlink\" title=\"优化,使用inner object\"></a>优化,使用inner object</h1><p>PUT softwares&#x2F;<br>{<br>  “mappings”: {<br>    “_meta”: {<br>      “software_version_mapping”: “1.1”<br>    },<br>    “properties”: {<br>      “version”: {<br>        “properties”: {<br>          “display_name”: {<br>            “type”: “keyword”<br>          },<br>          “hot_fix”: {<br>            “type”: “byte”<br>          },<br>          “marjor”: {<br>            “type”: “byte”<br>          },<br>          “minor”: {<br>            “type”: “byte”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#通过 Inner Object 写入多个文档<br>PUT softwares&#x2F;_doc&#x2F;1<br>{<br>  “version”:{<br>  “display_name”:”7.1.0”,<br>  “marjor”:7,<br>  “minor”:1,<br>  “hot_fix”:0<br>  }</p>\n<p>}</p>\n<p>PUT softwares&#x2F;_doc&#x2F;2<br>{<br>  “version”:{<br>  “display_name”:”7.2.0”,<br>  “marjor”:7,<br>  “minor”:2,<br>  “hot_fix”:0<br>  }<br>}</p>\n<p>PUT softwares&#x2F;_doc&#x2F;3<br>{<br>  “version”:{<br>  “display_name”:”7.2.1”,<br>  “marjor”:7,<br>  “minor”:2,<br>  “hot_fix”:1<br>  }<br>}</p>\n<h1 id=\"通过-bool-查询，\"><a href=\"#通过-bool-查询，\" class=\"headerlink\" title=\"通过 bool 查询，\"></a>通过 bool 查询，</h1><p>POST softwares&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “filter”: [<br>        {<br>          “match”:{<br>            “version.marjor”:7<br>          }<br>        },<br>        {<br>          “match”:{<br>            “version.minor”:2<br>          }<br>        }</p>\n<pre><code>  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<h1 id=\"Not-Null-解决聚合的问题\"><a href=\"#Not-Null-解决聚合的问题\" class=\"headerlink\" title=\"Not Null 解决聚合的问题\"></a>Not Null 解决聚合的问题</h1><p>DELETE ratings<br>PUT ratings<br>{<br>  “mappings”: {<br>      “properties”: {<br>        “rating”: {<br>          “type”: “float”,<br>          “null_value”: 1.0<br>        }<br>      }<br>    }<br>}</p>\n<p>PUT ratings&#x2F;_doc&#x2F;1<br>{<br> “rating”:5<br>}<br>PUT ratings&#x2F;_doc&#x2F;2<br>{<br> “rating”:null<br>}</p>\n<p>POST ratings&#x2F;_search<br>POST ratings&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “avg”: {<br>      “avg”: {<br>        “field”: “rating”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST ratings&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “rating”: {<br>        “value”: 1<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 7.7-第二部分总结与测验.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 第二部分总结与测验</span><br></pre></td></tr></table></figure>\n<p>DELETE test<br>PUT test&#x2F;_doc&#x2F;1<br>{<br>  “content”:”Hello World”<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content”: “Hello World”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content”: “hello world”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content.keyword”: “Hello World”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content.keyword”: “hello world”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content”: “Hello World”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content”: “hello world”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content.keyword”: “Hello World”<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 8.1-集群身份认证与用户鉴权.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 集群身份认证与用户鉴权</span><br><span class=\"line\">- 如何为集群启用X-Pack Security</span><br><span class=\"line\">- 如何为内置用户设置密码</span><br><span class=\"line\">- 设置 Kibana与ElasticSearch通信鉴权</span><br><span class=\"line\">- 使用安全API创建对特定索引具有有限访问权限的用户</span><br><span class=\"line\"></span><br><span class=\"line\">This tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:</span><br><span class=\"line\"></span><br><span class=\"line\">discovery.type: single-node</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>#启动单节点<br>bin&#x2F;elasticsearch -E node.name&#x3D;node0 -E cluster.name&#x3D;geektime -E path.data&#x3D;node0_data -E http.port&#x3D;9200 -E xpack.security.enabled&#x3D;true</p>\n<p>#使用Curl访问ES，或者浏览器访问 “localhost:9200&#x2F;_cat&#x2F;nodes?pretty”。返回401错误<br>curl ‘localhost:9200&#x2F;_cat&#x2F;nodes?pretty’</p>\n<p>#运行密码设定的命令，设置ES内置用户及其初始密码。<br>bin&#x2F;elasticsearch-setup-passwords interactive</p>\n<p>curl -u elastic ‘localhost:9200&#x2F;_cat&#x2F;nodes?pretty’</p>\n<h1 id=\"修改-kibana-yml\"><a href=\"#修改-kibana-yml\" class=\"headerlink\" title=\"修改 kibana.yml\"></a>修改 kibana.yml</h1><p>elasticsearch.username: “kibana”<br>elasticsearch.password: “changeme”</p>\n<p>#启动。使用用户名，elastic，密码elastic<br>.&#x2F;bin&#x2F;kibana</p>\n<p>POST orders&#x2F;_bulk<br>{“index”:{}}<br>{“product” : “1”,”price” : 18,”payment” : “master”,”card” : “9876543210123456”,”name” : “jack”}<br>{“index”:{}}<br>{“product” : “2”,”price” : 99,”payment” : “visa”,”card” : “1234567890123456”,”name” : “bob”}</p>\n<p>#create a new role named read_only_orders, that satisfies the following criteria:<br>#The role has no cluster privileges<br>#The role only has access to indices that match the pattern sales_record<br>#The index privileges are read, and view_index_metadata</p>\n<p>#create sales_user that satisfies the following criteria:</p>\n<h1 id=\"Use-your-own-email-address\"><a href=\"#Use-your-own-email-address\" class=\"headerlink\" title=\"Use your own email address\"></a>Use your own email address</h1><h1 id=\"Assign-the-user-to-two-roles-read-only-orders-and-kibana-user\"><a href=\"#Assign-the-user-to-two-roles-read-only-orders-and-kibana-user\" class=\"headerlink\" title=\"Assign the user to two roles: read_only_orders and kibana_user\"></a>Assign the user to two roles: read_only_orders and kibana_user</h1><p>#验证读权限,可以执行<br>POST orders&#x2F;_search<br>{}</p>\n<p>#验证写权限,报错<br>POST orders&#x2F;_bulk<br>{“index”:{}}<br>{“product” : “1”,”price” : 18,”payment” : “master”,”card” : “9876543210123456”,”name” : “jack”}<br>{“index”:{}}<br>{“product” : “2”,”price” : 99,”payment” : “visa”,”card” : “1234567890123456”,”name” : “bob”}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 8.2-集群内部安全通信.md</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"生成证书\"><a href=\"#生成证书\" class=\"headerlink\" title=\"生成证书\"></a>生成证书</h1><h1 id=\"为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil-ca命令：\"><a href=\"#为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil-ca命令：\" class=\"headerlink\" title=\"为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：\"></a>为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：</h1><p>bin&#x2F;elasticsearch-certutil ca</p>\n<p>#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：<br>bin&#x2F;elasticsearch-certutil cert –ca elastic-stack-ca.p12</p>\n<p>#将证书拷贝到 config&#x2F;certs目录下<br>elastic-certificates.p12</p>\n<p>bin&#x2F;elasticsearch -E node.name&#x3D;node0 -E cluster.name&#x3D;geektime -E path.data&#x3D;node0_data -E http.port&#x3D;9200 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate -E xpack.security.transport.ssl.keystore.path&#x3D;certs&#x2F;elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path&#x3D;certs&#x2F;elastic-certificates.p12</p>\n<p>bin&#x2F;elasticsearch -E node.name&#x3D;node1 -E cluster.name&#x3D;geektime -E path.data&#x3D;node1_data -E http.port&#x3D;9201 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate -E xpack.security.transport.ssl.keystore.path&#x3D;certs&#x2F;elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path&#x3D;certs&#x2F;elastic-certificates.p12</p>\n<p>#不提供证书的节点，无法加入<br>bin&#x2F;elasticsearch -E node.name&#x3D;node2 -E cluster.name&#x3D;geektime -E path.data&#x3D;node2_data -E http.port&#x3D;9202 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"elasticsearch-yml-配置\"><a href=\"#elasticsearch-yml-配置\" class=\"headerlink\" title=\"elasticsearch.yml 配置\"></a>elasticsearch.yml 配置</h2><p>#xpack.security.transport.ssl.enabled: true<br>#xpack.security.transport.ssl.verification_mode: certificate</p>\n<p>#xpack.security.transport.ssl.keystore.path: certs&#x2F;elastic-certificates.p12<br>#xpack.security.transport.ssl.truststore.path: certs&#x2F;elastic-certificates.p12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 8.3-集群与外部间的安全通信.md</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>xpack.security.http.ssl.enabled: true<br>xpack.security.http.ssl.keystore.path: certs&#x2F;elastic-certificates.p12<br>xpack.security.http.ssl.truststore.path: certs&#x2F;elastic-certificates.p12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">```</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># ES 启用 https</span><br><span class=\"line\">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Kibana 连接 ES https</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 为kibana生成pem</span><br><span class=\"line\">openssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">elasticsearch.hosts: [&quot;https://localhost:9200&quot;]</span><br><span class=\"line\">elasticsearch.ssl.certificateAuthorities: [ &quot;/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem&quot; ]</span><br><span class=\"line\">elasticsearch.ssl.verificationMode: certificate</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 为 Kibna 配置 HTTPS</span><br><span class=\"line\"># 生成后解压，包含了instance.crt 和 instance.key</span><br><span class=\"line\">bin/elasticsearch-certutil ca --pem</span><br><span class=\"line\"></span><br><span class=\"line\">server.ssl.enabled: true</span><br><span class=\"line\">server.ssl.certificate: config/certs/instance.crt</span><br><span class=\"line\">server.ssl.key: config/certs/instance.key</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"9-1-常见的集群部署方式-md\"><a href=\"#9-1-常见的集群部署方式-md\" class=\"headerlink\" title=\"9.1-常见的集群部署方式.md\"></a>9.1-常见的集群部署方式.md</h1><h1 id=\"常见的集群部署方式\"><a href=\"#常见的集群部署方式\" class=\"headerlink\" title=\"常见的集群部署方式\"></a>常见的集群部署方式</h1><h1 id=\"9-2-Hot-Warm架构与ShardFiltering-md\"><a href=\"#9-2-Hot-Warm架构与ShardFiltering-md\" class=\"headerlink\" title=\"9.2-Hot&amp;Warm架构与ShardFiltering.md\"></a>9.2-Hot&amp;Warm架构与ShardFiltering.md</h1><h1 id=\"Hot-Warm-架构与-Shard-Filtering\"><a href=\"#Hot-Warm-架构与-Shard-Filtering\" class=\"headerlink\" title=\"Hot &amp; Warm 架构与 Shard Filtering\"></a>Hot &amp; Warm 架构与 Shard Filtering</h1><h2 id=\"课程代码\"><a href=\"#课程代码\" class=\"headerlink\" title=\"课程代码\"></a>课程代码</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 标记一个 Hot 节点</span><br><span class=\"line\">bin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 warm 节点</span><br><span class=\"line\">bin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看节点</span><br><span class=\"line\">GET /_cat/nodeattrs?v</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置到 Hot节点</span><br><span class=\"line\">PUT logs-2019-06-27</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:0,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.my_node_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 配置到 warm 节点</span><br><span class=\"line\">PUT PUT logs-2019-06-27/_settings</span><br><span class=\"line\">&#123;  </span><br><span class=\"line\">  &quot;index.routing.allocation.require.my_node_type&quot;:&quot;warm&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 1</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 2</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2</span><br><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\">DELETE my_index1/_doc/1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Fore awareness</span><br><span class=\"line\"># 标记一个 rack 1</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 2</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;,</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.force.my_rack_id.values&quot;: &quot;rack1,rack2&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">GET _cluster/settings</span><br><span class=\"line\"></span><br><span class=\"line\"># 集群黄色</span><br><span class=\"line\">GET _cluster/health</span><br><span class=\"line\"></span><br><span class=\"line\"># 副本无法分配</span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cluster/allocation/explain?pretty</span><br></pre></td></tr></table></figure>\n<h1 id=\"9-3-如何对集群进行容量规划-md\"><a href=\"#9-3-如何对集群进行容量规划-md\" class=\"headerlink\" title=\"9.3-如何对集群进行容量规划.md\"></a>9.3-如何对集群进行容量规划.md</h1><h1 id=\"如何对集群进行容量规划\"><a href=\"#如何对集群进行容量规划\" class=\"headerlink\" title=\"如何对集群进行容量规划\"></a>如何对集群进行容量规划</h1><h2 id=\"代码Demo\"><a href=\"#代码Demo\" class=\"headerlink\" title=\"代码Demo\"></a>代码Demo</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT logs_2019-06-27</span><br><span class=\"line\">PUT logs_2019-06-26</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST _aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;actions&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;add&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;logs_2019-06-27&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;logs_write&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;remove&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;logs_2019-06-26&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;logs_write&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># POST /&lt;logs-&#123;now/d&#125;/_search</span><br><span class=\"line\">POST /%3Clogs-%7Bnow%2Fd%7D%3E/_search</span><br><span class=\"line\"></span><br><span class=\"line\"># POST /&lt;logs-&#123;now/w&#125;/_search</span><br><span class=\"line\">POST /%3Clogs-%7Bnow%2Fw%7D%3E/_search</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"9-4-分片设计及管理-md\"><a href=\"#9-4-分片设计及管理-md\" class=\"headerlink\" title=\"9.4-分片设计及管理.md\"></a>9.4-分片设计及管理.md</h1><h1 id=\"分片设计及管理\"><a href=\"#分片设计及管理\" class=\"headerlink\" title=\"分片设计及管理\"></a>分片设计及管理</h1><h1 id=\"9-5-在私有云上管理与部署Elasticsearch集群-md\"><a href=\"#9-5-在私有云上管理与部署Elasticsearch集群-md\" class=\"headerlink\" title=\"9.5-在私有云上管理与部署Elasticsearch集群.md\"></a>9.5-在私有云上管理与部署Elasticsearch集群.md</h1><h1 id=\"在私有云上管理与部署-Elasticsearch-集群\"><a href=\"#在私有云上管理与部署-Elasticsearch-集群\" class=\"headerlink\" title=\"在私有云上管理与部署 Elasticsearch 集群\"></a>在私有云上管理与部署 Elasticsearch 集群</h1><h1 id=\"9-6-在公有云上管理与部署Elasticsearch集群-md\"><a href=\"#9-6-在公有云上管理与部署Elasticsearch集群-md\" class=\"headerlink\" title=\"9.6-在公有云上管理与部署Elasticsearch集群.md\"></a>9.6-在公有云上管理与部署Elasticsearch集群.md</h1><h1 id=\"在公有云上管理与部署-Elasticsearch-集群\"><a href=\"#在公有云上管理与部署-Elasticsearch-集群\" class=\"headerlink\" title=\"在公有云上管理与部署 Elasticsearch 集群\"></a>在公有云上管理与部署 Elasticsearch 集群</h1><h1 id=\"result-md\"><a href=\"#result-md\" class=\"headerlink\" title=\"result.md\"></a>result.md</h1><h1 id=\"10-1-生产环境常用配置与上线清单-md\"><a href=\"#10-1-生产环境常用配置与上线清单-md\" class=\"headerlink\" title=\"10.1-生产环境常用配置与上线清单.md\"></a>10.1-生产环境常用配置与上线清单.md</h1><h1 id=\"生产环境查用配置与线上清单\"><a href=\"#生产环境查用配置与线上清单\" class=\"headerlink\" title=\"生产环境查用配置与线上清单\"></a>生产环境查用配置与线上清单</h1><h1 id=\"10-10-一些运维相关的建议-md\"><a href=\"#10-10-一些运维相关的建议-md\" class=\"headerlink\" title=\"10.10-一些运维相关的建议.md\"></a>10.10-一些运维相关的建议.md</h1><h1 id=\"一些运维相关的建议\"><a href=\"#一些运维相关的建议\" class=\"headerlink\" title=\"一些运维相关的建议\"></a>一些运维相关的建议</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 移动一个分片从一个节点到另外一个节点</span><br><span class=\"line\"></span><br><span class=\"line\">POST _cluster/reroute</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;commands&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;move&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;index_name&quot;,</span><br><span class=\"line\">        &quot;shard&quot;: 0,</span><br><span class=\"line\">        &quot;from_node&quot;: &quot;node_name_1&quot;,</span><br><span class=\"line\">        &quot;to_node&quot;: &quot;node_name_2&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Fore the allocation of an unassinged shard with a reason</span><br><span class=\"line\"></span><br><span class=\"line\">POST _cluster/reroute?explain</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;commands&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;allocate&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;index_name&quot;,</span><br><span class=\"line\">        &quot;shard&quot;: 0,</span><br><span class=\"line\">        &quot;node&quot;: &quot;nodename&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># remove the nodes from cluster </span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.exclude._ip&quot;:&quot;the_IP_of_your_node&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Force a synced flush</span><br><span class=\"line\">POST _flush/synced</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># change the number of moving shards to balance the cluster</span><br><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;&quot;cluster.routing.allocation.cluster_concurrent_rebalance&quot;:2&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># change the number of shards being recovered simultanceously per node</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;&quot;cluster.routing.allocation.node_concurrent_recoveries&quot;:5&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Change the recovery speed</span><br><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;&quot;indices.recovery.max_bytes_per_sec&quot;: &quot;80mb&quot;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Change the number of concurrent streams for a recovery on a single node</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;&quot;indices.recovery.concurrent_streams&quot;:6&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Change the sinze of the search queue</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;</span><br><span class=\"line\">    &quot;threadpool.search.queue_size&quot;:2000</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Clear the cache on a node</span><br><span class=\"line\">POST _cache/clear</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Adjust the circuit breakers</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;indices.breaker.total.limit&quot;:&quot;40%&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-2-监控Elasticsearch集群-md\"><a href=\"#10-2-监控Elasticsearch集群-md\" class=\"headerlink\" title=\"10.2-监控Elasticsearch集群.md\"></a>10.2-监控Elasticsearch集群.md</h1><h1 id=\"监控-Elasticsearch-集群-1\"><a href=\"#监控-Elasticsearch-集群-1\" class=\"headerlink\" title=\"监控 Elasticsearch 集群\"></a>监控 Elasticsearch 集群</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Node Stats：</span><br><span class=\"line\">GET _nodes/stats</span><br><span class=\"line\"></span><br><span class=\"line\">#Cluster Stats:</span><br><span class=\"line\">GET _cluster/stats</span><br><span class=\"line\"></span><br><span class=\"line\">#Index Stats:</span><br><span class=\"line\">GET kibana_sample_data_ecommerce/_stats</span><br><span class=\"line\"></span><br><span class=\"line\">#Pending Cluster Tasks API:</span><br><span class=\"line\">GET _cluster/pending_tasks</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看所有的 tasks，也支持 cancel task</span><br><span class=\"line\">GET _tasks</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _nodes/thread_pool</span><br><span class=\"line\">GET _nodes/stats/thread_pool</span><br><span class=\"line\">GET _cat/thread_pool?v</span><br><span class=\"line\">GET _nodes/hot_threads</span><br><span class=\"line\">GET _nodes/stats/thread_pool</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置 Index Slowlogs</span><br><span class=\"line\"># the first 1000 characters of the doc&#x27;s source will be logged</span><br><span class=\"line\">PUT my_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;index.indexing.slowlog&quot;:&#123;</span><br><span class=\"line\">    &quot;threshold.index&quot;:&#123;</span><br><span class=\"line\">      &quot;warn&quot;:&quot;10s&quot;,</span><br><span class=\"line\">      &quot;info&quot;: &quot;4s&quot;,</span><br><span class=\"line\">      &quot;debug&quot;:&quot;2s&quot;,</span><br><span class=\"line\">      &quot;trace&quot;:&quot;0s&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;level&quot;:&quot;trace&quot;,</span><br><span class=\"line\">    &quot;source&quot;:1000  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置查询</span><br><span class=\"line\">DELETE my_index</span><br><span class=\"line\">//&quot;0&quot; logs all queries</span><br><span class=\"line\">PUT my_index/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.search.slowlog.threshold&quot;: &#123;</span><br><span class=\"line\">      &quot;query.warn&quot;: &quot;10s&quot;,</span><br><span class=\"line\">      &quot;query.info&quot;: &quot;3s&quot;,</span><br><span class=\"line\">      &quot;query.debug&quot;: &quot;2s&quot;,</span><br><span class=\"line\">      &quot;query.trace&quot;: &quot;0s&quot;,</span><br><span class=\"line\">      &quot;fetch.warn&quot;: &quot;1s&quot;,</span><br><span class=\"line\">      &quot;fetch.info&quot;: &quot;600ms&quot;,</span><br><span class=\"line\">      &quot;fetch.debug&quot;: &quot;400ms&quot;,</span><br><span class=\"line\">      &quot;fetch.trace&quot;: &quot;0s&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET my_index</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-3-诊断集群的潜在问题-md\"><a href=\"#10-3-诊断集群的潜在问题-md\" class=\"headerlink\" title=\"10.3-诊断集群的潜在问题.md\"></a>10.3-诊断集群的潜在问题.md</h1><h1 id=\"诊断集群的潜在问题\"><a href=\"#诊断集群的潜在问题\" class=\"headerlink\" title=\"诊断集群的潜在问题\"></a>诊断集群的潜在问题</h1><h1 id=\"10-4-解决集群Yellow与Red的问题-md\"><a href=\"#10-4-解决集群Yellow与Red的问题-md\" class=\"headerlink\" title=\"10.4-解决集群Yellow与Red的问题.md\"></a>10.4-解决集群Yellow与Red的问题.md</h1><h1 id=\"集群健康与问题排查\"><a href=\"#集群健康与问题排查\" class=\"headerlink\" title=\"集群健康与问题排查\"></a>集群健康与问题排查</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#案例1</span><br><span class=\"line\">DELETE mytest</span><br><span class=\"line\">PUT mytest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:3,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:0,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hott&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 检查集群状态，查看是否有节点丢失，有多少分片无法分配</span><br><span class=\"line\">GET /_cluster/health/</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看索引级别,找到红色的索引</span><br><span class=\"line\">GET /_cluster/health?level=indices</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#查看索引的分片</span><br><span class=\"line\">GET _cluster/health?level=shards</span><br><span class=\"line\"></span><br><span class=\"line\"># Explain 变红的原因</span><br><span class=\"line\">GET /_cluster/allocation/explain</span><br><span class=\"line\"></span><br><span class=\"line\">GET /_cat/shards/mytest</span><br><span class=\"line\">GET _cat/nodeattrs</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE mytest</span><br><span class=\"line\">GET /_cluster/health/</span><br><span class=\"line\"></span><br><span class=\"line\">PUT mytest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:3,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:0,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /_cluster/health/</span><br><span class=\"line\"></span><br><span class=\"line\">#案例2, Explain 看 hot 上的 explain</span><br><span class=\"line\">DELETE mytest</span><br><span class=\"line\">PUT mytest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:1,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cluster/health</span><br><span class=\"line\">GET _cat/shards/mytest</span><br><span class=\"line\">GET /_cluster/allocation/explain</span><br><span class=\"line\"></span><br><span class=\"line\">PUT mytest/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-5-提升集群写性能-md\"><a href=\"#10-5-提升集群写性能-md\" class=\"headerlink\" title=\"10.5-提升集群写性能.md\"></a>10.5-提升集群写性能.md</h1><h1 id=\"提升集群写性能-1\"><a href=\"#提升集群写性能-1\" class=\"headerlink\" title=\"提升集群写性能\"></a>提升集群写性能</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE myindex</span><br><span class=\"line\">PUT myindex</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index&quot;: &#123;</span><br><span class=\"line\">      &quot;refresh_interval&quot;: &quot;30s&quot;,</span><br><span class=\"line\">      &quot;number_of_shards&quot;: &quot;2&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;routing&quot;: &#123;</span><br><span class=\"line\">      &quot;allocation&quot;: &#123;</span><br><span class=\"line\">        &quot;total_shards_per_node&quot;: &quot;3&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;translog&quot;: &#123;</span><br><span class=\"line\">      &quot;sync_interval&quot;: &quot;30s&quot;,</span><br><span class=\"line\">      &quot;durability&quot;: &quot;async&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;dynamic&quot;: false,</span><br><span class=\"line\">    &quot;properties&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-6-提升集群读性能-md\"><a href=\"#10-6-提升集群读性能-md\" class=\"headerlink\" title=\"10.6-提升集群读性能.md\"></a>10.6-提升集群读性能.md</h1><h1 id=\"提升集群读性能-1\"><a href=\"#提升集群读性能-1\" class=\"headerlink\" title=\"提升集群读性能\"></a>提升集群读性能</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT blogs/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;elasticsearch&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">GET blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;title&quot;: &quot;elasticsearch&quot;</span><br><span class=\"line\">        &#125;&#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      </span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;script&quot;: &#123;</span><br><span class=\"line\">          &quot;script&quot;: &#123;</span><br><span class=\"line\">            &quot;source&quot;: &quot;doc[&#x27;title.keyword&#x27;].value.length()&gt;5&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;title&quot;: &quot;elasticsearch&quot;&#125;&#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;range&quot;: &#123;</span><br><span class=\"line\">            &quot;publish_date&quot;: &#123;</span><br><span class=\"line\">              &quot;gte&quot;: 2017,</span><br><span class=\"line\">              &quot;lte&quot;: 2019</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-7-集群压力测试-md\"><a href=\"#10-7-集群压力测试-md\" class=\"headerlink\" title=\"10.7-集群压力测试.md\"></a>10.7-集群压力测试.md</h1><h1 id=\"集群压力测试-1\"><a href=\"#集群压力测试-1\" class=\"headerlink\" title=\"集群压力测试\"></a>集群压力测试</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip3 install esrally</span><br><span class=\"line\"></span><br><span class=\"line\">esrally configure</span><br><span class=\"line\"></span><br><span class=\"line\"># 只测试 1000条数据</span><br><span class=\"line\">esrally --distribution-version=7.1.0 --test-mode</span><br><span class=\"line\"></span><br><span class=\"line\"># 测试完整数据</span><br><span class=\"line\">esrally --distribution-version=7.1.0</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li><a href=\"https://github.com/elastic/rally-tracks\">https://github.com/elastic/rally-tracks</a></li>\n<li><a href=\"https://logz.io/blog/rally/\">https://logz.io/blog/rally/</a></li>\n</ul>\n<h1 id=\"10-9-缓存及使用Breaker限制内存使用-md\"><a href=\"#10-9-缓存及使用Breaker限制内存使用-md\" class=\"headerlink\" title=\"10.9-缓存及使用Breaker限制内存使用.md\"></a>10.9-缓存及使用Breaker限制内存使用.md</h1><h1 id=\"缓存及使用Circuit-Breaker限制内存使用\"><a href=\"#缓存及使用Circuit-Breaker限制内存使用\" class=\"headerlink\" title=\"缓存及使用Circuit Breaker限制内存使用\"></a>缓存及使用Circuit Breaker限制内存使用</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cat/nodes?v</span><br><span class=\"line\"></span><br><span class=\"line\">GET _nodes/stats/indices?pretty</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/nodes?v&amp;h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/nodes?h=name,port,segments.memory,segments.index_writer_memory,fielddata.memory_size,query_cache.memory_size,request_cache.memory_size&amp;v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;persistent&quot; : &#123;</span><br><span class=\"line\">       &quot;indices.breaker.request.limit&quot; : &quot;90%&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"补充阅读\"><a href=\"#补充阅读\" class=\"headerlink\" title=\"补充阅读\"></a>补充阅读</h2><ul>\n<li><a href=\"https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker\">https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker</a></li>\n</ul>\n<h1 id=\"11-1-使用Shrink与RolloverAPI有效管理时间序列索引-md\"><a href=\"#11-1-使用Shrink与RolloverAPI有效管理时间序列索引-md\" class=\"headerlink\" title=\"11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md\"></a>11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md</h1><h1 id=\"使用-shrink与rolloverAPI有效的管理索引\"><a href=\"#使用-shrink与rolloverAPI有效的管理索引\" class=\"headerlink\" title=\"使用 shrink与rolloverAPI有效的管理索引\"></a>使用 shrink与rolloverAPI有效的管理索引</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 打开关闭索引</span><br><span class=\"line\">DELETE test</span><br><span class=\"line\">#查看索引是否存在</span><br><span class=\"line\">HEAD test</span><br><span class=\"line\"></span><br><span class=\"line\">PUT test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#关闭索引</span><br><span class=\"line\">POST /test/_close</span><br><span class=\"line\">#索引存在</span><br><span class=\"line\">HEAD test</span><br><span class=\"line\"># 无法查询</span><br><span class=\"line\">POST test/_count</span><br><span class=\"line\"></span><br><span class=\"line\">#打开索引</span><br><span class=\"line\">POST /test/_open</span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">POST test/_count</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 在一个 hot-warm-cold的集群上进行测试</span><br><span class=\"line\">GET _cat/nodes</span><br><span class=\"line\">GET _cat/nodeattrs</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_source_index</span><br><span class=\"line\">DELETE my_target_index</span><br><span class=\"line\">PUT my_source_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;settings&quot;: &#123;</span><br><span class=\"line\">   &quot;number_of_shards&quot;: 4,</span><br><span class=\"line\">   &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_source_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_source_index</span><br><span class=\"line\"></span><br><span class=\"line\"># 分片数3，会失败</span><br><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 3,</span><br><span class=\"line\">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 报错，因为没有置成 readonly</span><br><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 2,</span><br><span class=\"line\">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#将 my_source_index 设置为只读</span><br><span class=\"line\">PUT /my_source_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.blocks.write&quot;: true</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 报错，必须都在一个节点</span><br><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 2,</span><br><span class=\"line\">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_source_index</span><br><span class=\"line\">## 确保分片都在 hot</span><br><span class=\"line\">PUT my_source_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;settings&quot;: &#123;</span><br><span class=\"line\">   &quot;number_of_shards&quot;: 4,</span><br><span class=\"line\">   &quot;number_of_replicas&quot;: 0,</span><br><span class=\"line\">   &quot;index.routing.allocation.include.box_type&quot;:&quot;hot&quot;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_source_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_source_index</span><br><span class=\"line\"></span><br><span class=\"line\">#设置为只读</span><br><span class=\"line\">PUT /my_source_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.blocks.write&quot;: true</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 2,</span><br><span class=\"line\">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_target_index</span><br><span class=\"line\"></span><br><span class=\"line\"># My target_index状态为也只读</span><br><span class=\"line\">PUT my_target_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Split Index</span><br><span class=\"line\">DELETE my_source_index</span><br><span class=\"line\">DELETE my_target_index</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_source_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;settings&quot;: &#123;</span><br><span class=\"line\">   &quot;number_of_shards&quot;: 4,</span><br><span class=\"line\">   &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_source_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_source_index</span><br><span class=\"line\"></span><br><span class=\"line\"># 必须是倍数</span><br><span class=\"line\">POST my_source_index/_split/my_target</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 10</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 必须是只读</span><br><span class=\"line\">POST my_source_index/_split/my_target</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 8</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#设置为只读</span><br><span class=\"line\">PUT /my_source_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.blocks.write&quot;: true</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST my_source_index/_split/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 8,</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;:0</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_target_index</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># write block</span><br><span class=\"line\">PUT my_target_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Rollover API</span><br><span class=\"line\">DELETE nginx-logs*</span><br><span class=\"line\"># 不设定 is_write_true</span><br><span class=\"line\"># 名字符合命名规范</span><br><span class=\"line\">PUT /nginx-logs-000001</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;nginx_logs_write&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 多次写入文档</span><br><span class=\"line\">POST nginx_logs_write/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;log&quot;:&quot;something&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /nginx_logs_write/_rollover</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;conditions&quot;: &#123;</span><br><span class=\"line\">    &quot;max_age&quot;:   &quot;1d&quot;,</span><br><span class=\"line\">    &quot;max_docs&quot;:  5,</span><br><span class=\"line\">    &quot;max_size&quot;:  &quot;5gb&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /nginx_logs_write/_count</span><br><span class=\"line\"># 查看 Alias信息</span><br><span class=\"line\">GET /nginx_logs_write</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE apache-logs*</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置 is_write_index</span><br><span class=\"line\">PUT apache-logs1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;apache_logs&quot;: &#123;</span><br><span class=\"line\">      &quot;is_write_index&quot;:true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">POST apache_logs/_count</span><br><span class=\"line\"></span><br><span class=\"line\">POST apache_logs/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 需要指定 target 的名字</span><br><span class=\"line\">POST /apache_logs/_rollover/apache-logs8xxxx</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;conditions&quot;: &#123;</span><br><span class=\"line\">    &quot;max_age&quot;:   &quot;1d&quot;,</span><br><span class=\"line\">    &quot;max_docs&quot;:  1,</span><br><span class=\"line\">    &quot;max_size&quot;:  &quot;5gb&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 查看 Alias信息</span><br><span class=\"line\">GET /apache_logs</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"11-2-索引全生命周期管理及工具介绍-md\"><a href=\"#11-2-索引全生命周期管理及工具介绍-md\" class=\"headerlink\" title=\"11.2-索引全生命周期管理及工具介绍.md\"></a>11.2-索引全生命周期管理及工具介绍.md</h1><h1 id=\"索引全生命周期管理及工具介绍\"><a href=\"#索引全生命周期管理及工具介绍\" class=\"headerlink\" title=\"索引全生命周期管理及工具介绍\"></a>索引全生命周期管理及工具介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 运行三个节点，分片 将box_type设置成 hot，warm和cold</span><br><span class=\"line\"># 具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE *</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置 1秒刷新1次，生产环境10分种刷新一次</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;indices.lifecycle.poll_interval&quot;:&quot;1s&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置 Policy</span><br><span class=\"line\">PUT /_ilm/policy/log_ilm_policy</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;policy&quot;: &#123;</span><br><span class=\"line\">    &quot;phases&quot;: &#123;</span><br><span class=\"line\">      &quot;hot&quot;: &#123;</span><br><span class=\"line\">        &quot;actions&quot;: &#123;</span><br><span class=\"line\">          &quot;rollover&quot;: &#123;</span><br><span class=\"line\">            &quot;max_docs&quot;: 5</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;warm&quot;: &#123;</span><br><span class=\"line\">        &quot;min_age&quot;: &quot;10s&quot;,</span><br><span class=\"line\">        &quot;actions&quot;: &#123;</span><br><span class=\"line\">          &quot;allocate&quot;: &#123;</span><br><span class=\"line\">            &quot;include&quot;: &#123;</span><br><span class=\"line\">              &quot;box_type&quot;: &quot;warm&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;cold&quot;: &#123;</span><br><span class=\"line\">        &quot;min_age&quot;: &quot;15s&quot;,</span><br><span class=\"line\">        &quot;actions&quot;: &#123;</span><br><span class=\"line\">          &quot;allocate&quot;: &#123;</span><br><span class=\"line\">            &quot;include&quot;: &#123;</span><br><span class=\"line\">              &quot;box_type&quot;: &quot;cold&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;delete&quot;: &#123;</span><br><span class=\"line\">        &quot;min_age&quot;: &quot;20s&quot;,</span><br><span class=\"line\">        &quot;actions&quot;: &#123;</span><br><span class=\"line\">          &quot;delete&quot;: &#123;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置索引模版</span><br><span class=\"line\">PUT /_template/log_ilm_template</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;index_patterns&quot; : [</span><br><span class=\"line\">      &quot;ilm_index-*&quot;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    &quot;settings&quot; : &#123;</span><br><span class=\"line\">      &quot;index&quot; : &#123;</span><br><span class=\"line\">        &quot;lifecycle&quot; : &#123;</span><br><span class=\"line\">          &quot;name&quot; : &quot;log_ilm_policy&quot;,</span><br><span class=\"line\">          &quot;rollover_alias&quot; : &quot;ilm_alias&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;routing&quot; : &#123;</span><br><span class=\"line\">          &quot;allocation&quot; : &#123;</span><br><span class=\"line\">            &quot;include&quot; : &#123;</span><br><span class=\"line\">              &quot;box_type&quot; : &quot;hot&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;number_of_shards&quot; : &quot;1&quot;,</span><br><span class=\"line\">        &quot;number_of_replicas&quot; : &quot;0&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;mappings&quot; : &#123; &#125;,</span><br><span class=\"line\">    &quot;aliases&quot; : &#123; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#创建索引</span><br><span class=\"line\">PUT ilm_index-000001</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 1,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.lifecycle.name&quot;: &quot;log_ilm_policy&quot;,</span><br><span class=\"line\">    &quot;index.lifecycle.rollover_alias&quot;: &quot;ilm_alias&quot;,</span><br><span class=\"line\">    &quot;index.routing.allocation.include.box_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;ilm_alias&quot;: &#123;</span><br><span class=\"line\">      &quot;is_write_index&quot;: true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 对 Alias写入文档</span><br><span class=\"line\">POST  ilm_alias/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;dfd&quot;:&quot;dfdsf&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"12-1-Logstash入门及架构介绍-md\"><a href=\"#12-1-Logstash入门及架构介绍-md\" class=\"headerlink\" title=\"12.1-Logstash入门及架构介绍.md\"></a>12.1-Logstash入门及架构介绍.md</h1><h1 id=\"Logstash-入门及架构介绍\"><a href=\"#Logstash-入门及架构介绍\" class=\"headerlink\" title=\"Logstash 入门及架构介绍\"></a>Logstash 入门及架构介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 一个 Demo， demo 运行</span><br><span class=\"line\">sudo bin/logstash -f logstash-filter.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># demo数据</span><br><span class=\"line\">127.0.0.1 - - [11/Dec/2013:00:01:45 -0800] &quot;GET /xampp/status.php HTTP/1.1&quot; 200 3891 &quot;http://cadenza/xampp/navi.php&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># codec demo</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;line&#125;&#125;output&#123;stdout&#123;codec=&gt; rubydebug&#125;&#125;&quot;</span><br><span class=\"line\">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;json&#125;&#125;output&#123;stdout&#123;codec=&gt; rubydebug&#125;&#125;&quot;</span><br><span class=\"line\">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;line&#125;&#125;output&#123;stdout&#123;codec=&gt; dots&#125;&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo bin/logstash -f multiline-exception.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># 多行数据，异常</span><br><span class=\"line\">Exception in thread &quot;main&quot; java.lang.NullPointerException</span><br><span class=\"line\">        at com.example.myproject.Book.getTitle(Book.java:16)</span><br><span class=\"line\">        at com.example.myproject.Author.getBookTitles(Author.java:25)</span><br><span class=\"line\">        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 一个实例</span><br><span class=\"line\">https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"12-2-利用JDBC插件导入数据到Elasticsearch-md\"><a href=\"#12-2-利用JDBC插件导入数据到Elasticsearch-md\" class=\"headerlink\" title=\"12.2-利用JDBC插件导入数据到Elasticsearch.md\"></a>12.2-利用JDBC插件导入数据到Elasticsearch.md</h1><h1 id=\"Logstash插件及文档介绍\"><a href=\"#Logstash插件及文档介绍\" class=\"headerlink\" title=\"Logstash插件及文档介绍\"></a>Logstash插件及文档介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://spring.io/guides/gs/accessing-data-mysql/</span><br><span class=\"line\">create database db_example;</span><br><span class=\"line\">use db_example;</span><br><span class=\"line\">show tables;</span><br><span class=\"line\">drop table user;</span><br><span class=\"line\">select * from user;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 新增用户</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\"></span><br><span class=\"line\">#查看所有的用户</span><br><span class=\"line\">curl &#x27;localhost:8080/demo/all&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"># 更新用户</span><br><span class=\"line\">curl -X PUT localhost:8080/demo/update -d id=16 -d name=Bob2 -d email=bob2@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\"></span><br><span class=\"line\"># 删除用户</span><br><span class=\"line\">curl -X DELETE localhost:8080/demo/delete -d id=15</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">mysql-demo.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建 alias，只显示没有被标记 deleted的用户</span><br><span class=\"line\">POST /_aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;actions&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;add&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;users&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;view_users&quot;,</span><br><span class=\"line\">         &quot;filter&quot; : &#123; &quot;term&quot; : &#123; &quot;is_deleted&quot; : false &#125; &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 通过 Alias查询，查不到被标记成 deleted的用户</span><br><span class=\"line\">POST view_users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST view_users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;name.keyword&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;Jack&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;name.keyword&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;Jack&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"12-3-Beats介绍-md\"><a href=\"#12-3-Beats介绍-md\" class=\"headerlink\" title=\"12.3-Beats介绍.md\"></a>12.3-Beats介绍.md</h1><h1 id=\"Beats介绍\"><a href=\"#Beats介绍\" class=\"headerlink\" title=\"Beats介绍\"></a>Beats介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">##</span><br><span class=\"line\"># 查看 packetbeat 模块</span><br><span class=\"line\"># 设置 packetbeat 的mysql 模块</span><br><span class=\"line\"># 启动运行</span><br><span class=\"line\">#</span><br><span class=\"line\">./metricbeat modules list</span><br><span class=\"line\">./metricbeat modules enable mysql</span><br><span class=\"line\">./metricbeat setup --dashboards</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装mysql</span><br><span class=\"line\">create database db_example</span><br><span class=\"line\">use db_example;</span><br><span class=\"line\">show tables;</span><br><span class=\"line\">select * from user</span><br><span class=\"line\"></span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\"></span><br><span class=\"line\">curl &#x27;localhost:8080/demo/all&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 配置 packetbeat</span><br><span class=\"line\"># 启动</span><br><span class=\"line\">修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控</span><br><span class=\"line\"></span><br><span class=\"line\">sudo chown root packetbeat.yml</span><br><span class=\"line\">sudo ./packetbeat setup --dashboards</span><br><span class=\"line\">sudo ./packetbeat</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 查看所有 Filebeat 模块</span><br><span class=\"line\"># 查看所有的modules</span><br><span class=\"line\">./filebeat modules list</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\">./filebeat modules enable mysql</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"13-1-使用IndexPattern配置数据-md\"><a href=\"#13-1-使用IndexPattern配置数据-md\" class=\"headerlink\" title=\"13.1-使用IndexPattern配置数据.md\"></a>13.1-使用IndexPattern配置数据.md</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">localhost:5601/status</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /logstash-2015.05.18</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;geo&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;coordinates&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /logstash-2015.05.19</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;geo&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;coordinates&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /logstash-2015.05.20</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;geo&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;coordinates&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># For Mac &amp; Windows</span><br><span class=\"line\">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/_bulk?pretty&#x27; --data-binary @logs.jsonl</span><br><span class=\"line\"></span><br><span class=\"line\">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/bank/account/_bulk?pretty&#x27; --data-binary @accounts.json</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#For Windows</span><br><span class=\"line\">Invoke-RestMethod &quot;http://localhost:9200/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;logs.jsonl&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET /_cat/indices?v</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"13-2-使用KibanaDiscover探索数据-md\"><a href=\"#13-2-使用KibanaDiscover探索数据-md\" class=\"headerlink\" title=\"13.2-使用KibanaDiscover探索数据.md\"></a>13.2-使用KibanaDiscover探索数据.md</h1><h1 id=\"使用Kibana-Discovery-探索数据\"><a href=\"#使用Kibana-Discovery-探索数据\" class=\"headerlink\" title=\"使用Kibana Discovery 探索数据\"></a>使用Kibana Discovery 探索数据</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">设置时间过滤器</span><br><span class=\"line\">搜索你的数据</span><br><span class=\"line\">根据字段进行过滤</span><br><span class=\"line\">查看文档数据</span><br><span class=\"line\">查看文档上下文</span><br><span class=\"line\">暂时字段数据统计</span><br><span class=\"line\">Save Query</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"13-3-基本可视化组件介绍-md\"><a href=\"#13-3-基本可视化组件介绍-md\" class=\"headerlink\" title=\"13.3-基本可视化组件介绍.md\"></a>13.3-基本可视化组件介绍.md</h1><h1 id=\"基本可视化组件介绍\"><a href=\"#基本可视化组件介绍\" class=\"headerlink\" title=\"基本可视化组件介绍\"></a>基本可视化组件介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">PUT /shakespeare</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;speaker&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class=\"line\">    &quot;play_name&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class=\"line\">    &quot;line_id&quot;: &#123;&quot;type&quot;: &quot;integer&quot;&#125;,</span><br><span class=\"line\">    &quot;speech_number&quot;: &#123;&quot;type&quot;: &quot;integer&quot;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># For Mac &amp; Windows</span><br><span class=\"line\">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/bank/account/_bulk?pretty&#x27; --data-binary @accounts.json</span><br><span class=\"line\">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/shakespeare/_bulk?pretty&#x27; --data-binary @shakespeare.json</span><br><span class=\"line\"></span><br><span class=\"line\">#For Windows</span><br><span class=\"line\">Invoke-RestMethod &quot;http://localhost:9200/bank/account/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;accounts.json&quot;</span><br><span class=\"line\">Invoke-RestMethod &quot;http://localhost:9200/shakespeare/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;shakespeare.json&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"13-4-构建Dashboard-md\"><a href=\"#13-4-构建Dashboard-md\" class=\"headerlink\" title=\"13.4-构建Dashboard.md\"></a>13.4-构建Dashboard.md</h1><h1 id=\"构建Dashboard\"><a href=\"#构建Dashboard\" class=\"headerlink\" title=\"构建Dashboard\"></a>构建Dashboard</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 创建仪表潘</span><br><span class=\"line\">- 加载仪表盘</span><br><span class=\"line\">- 共享仪表盘</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"14-3用机器学习实现时序数据的异常检测-上-md\"><a href=\"#14-3用机器学习实现时序数据的异常检测-上-md\" class=\"headerlink\" title=\"14.3用机器学习实现时序数据的异常检测-上.md\"></a>14.3用机器学习实现时序数据的异常检测-上.md</h1><p>mkdir server_metrics<br>cd server_metrics<br>wget <a href=\"https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz\">https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz</a><br>tar -xvf server_metrics.tar.gz</p>\n<h1 id=\"14-5-用ELK进行日志管理-md\"><a href=\"#14-5-用ELK进行日志管理-md\" class=\"headerlink\" title=\"14.5-用ELK进行日志管理.md\"></a>14.5-用ELK进行日志管理.md</h1><h1 id=\"用-ELK-来做日志管理\"><a href=\"#用-ELK-来做日志管理\" class=\"headerlink\" title=\"用 ELK 来做日志管理\"></a>用 ELK 来做日志管理</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./filebeat modules list</span><br><span class=\"line\">./filebeat modules enable system</span><br><span class=\"line\">./filebeat modules enable elasticsearch</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">## 进 modules.d 编辑相应的文件，修改log路径</span><br><span class=\"line\"></span><br><span class=\"line\">./filebeat setup –dashboards</span><br><span class=\"line\"></span><br><span class=\"line\">./filebeat export template | more</span><br><span class=\"line\"></span><br><span class=\"line\">./filebeat -e</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"14-6-用Canvas做数据演示-md\"><a href=\"#14-6-用Canvas做数据演示-md\" class=\"headerlink\" title=\"14.6-用Canvas做数据演示.md\"></a>14.6-用Canvas做数据演示.md</h1><p>POST elasticoffee&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “by”: {<br>      “terms”: {<br>        “field”: “beverage.keyword”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"4-1-基于词项和基于全文的搜索-md\"><a href=\"#4-1-基于词项和基于全文的搜索-md\" class=\"headerlink\" title=\"4.1-基于词项和基于全文的搜索.md\"></a>4.1-基于词项和基于全文的搜索.md</h1><h1 id=\"基于词项和基于全文的搜索\"><a href=\"#基于词项和基于全文的搜索\" class=\"headerlink\" title=\"基于词项和基于全文的搜索\"></a>基于词项和基于全文的搜索</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE products</span><br><span class=\"line\">PUT products</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot;,&quot;desc&quot;:&quot;iPhone&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot;,&quot;desc&quot;:&quot;iPad&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot;,&quot;desc&quot;:&quot;MBP&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /products</span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;desc&quot;: &#123;</span><br><span class=\"line\">        //&quot;value&quot;: &quot;iPhone&quot;</span><br><span class=\"line\">        &quot;value&quot;:&quot;iphone&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;desc.keyword&quot;: &#123;</span><br><span class=\"line\">        //&quot;value&quot;: &quot;iPhone&quot;</span><br><span class=\"line\">        //&quot;value&quot;:&quot;iphone&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;productID&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  //&quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;productID.keyword&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#设置 position_increment_gap</span><br><span class=\"line\">DELETE groups</span><br><span class=\"line\">PUT groups</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;names&quot;:&#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;position_increment_gap&quot;: 0</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET groups/_mapping</span><br><span class=\"line\"></span><br><span class=\"line\">POST groups/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;names&quot;: [ &quot;John Water&quot;, &quot;Water Smith&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST groups/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_phrase&quot;: &#123;</span><br><span class=\"line\">      &quot;names&quot;: &#123;</span><br><span class=\"line\">        &quot;query&quot;: &quot;Water Water&quot;,</span><br><span class=\"line\">        &quot;slop&quot;: 100</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST groups/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_phrase&quot;: &#123;</span><br><span class=\"line\">      &quot;names&quot;: &quot;Water Smith&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-10-综合排序：Function-Score-Query-优化算分-md\"><a href=\"#4-10-综合排序：Function-Score-Query-优化算分-md\" class=\"headerlink\" title=\"4.10-综合排序：Function Score Query 优化算分.md\"></a>4.10-综合排序：Function Score Query 优化算分.md</h1><h1 id=\"综合排序：Function-Score-Query-优化算分\"><a href=\"#综合排序：Function-Score-Query-优化算分\" class=\"headerlink\" title=\"综合排序：Function Score Query 优化算分\"></a>综合排序：Function Score Query 优化算分</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE blogs</span><br><span class=\"line\">PUT /blogs/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class=\"line\">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class=\"line\">  &quot;votes&quot;:   0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /blogs/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class=\"line\">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class=\"line\">  &quot;votes&quot;:   100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /blogs/_doc/3</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class=\"line\">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class=\"line\">  &quot;votes&quot;:   1000000</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;field_value_factor&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;votes&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;field_value_factor&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class=\"line\">        &quot;modifier&quot;: &quot;log1p&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;field_value_factor&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class=\"line\">        &quot;modifier&quot;: &quot;log1p&quot; ,</span><br><span class=\"line\">        &quot;factor&quot;: 0.1</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;field_value_factor&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class=\"line\">        &quot;modifier&quot;: &quot;log1p&quot; ,</span><br><span class=\"line\">        &quot;factor&quot;: 0.1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;boost_mode&quot;: &quot;sum&quot;,</span><br><span class=\"line\">      &quot;max_boost&quot;: 3</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;random_score&quot;: &#123;</span><br><span class=\"line\">        &quot;seed&quot;: 911119</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-12-自动补全与基于上下文的提示-md\"><a href=\"#4-12-自动补全与基于上下文的提示-md\" class=\"headerlink\" title=\"4.12-自动补全与基于上下文的提示.md\"></a>4.12-自动补全与基于上下文的提示.md</h1><h1 id=\"自动补全与基于上下文的提示\"><a href=\"#自动补全与基于上下文的提示\" class=\"headerlink\" title=\"自动补全与基于上下文的提示\"></a>自动补全与基于上下文的提示</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE articles</span><br><span class=\"line\">PUT articles</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;title_completion&quot;:&#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;completion&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST articles/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;lucene is very cool&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;Elasticsearch builds on top of lucene&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;Elasticsearch rocks&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;elastic is the company behind ELK stack&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;Elk stack rocks&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;&#125; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST articles/_search?pretty</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;suggest&quot;: &#123;</span><br><span class=\"line\">    &quot;article-suggester&quot;: &#123;</span><br><span class=\"line\">      &quot;prefix&quot;: &quot;elk &quot;,</span><br><span class=\"line\">      &quot;completion&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;title_completion&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE comments</span><br><span class=\"line\">PUT comments</span><br><span class=\"line\">PUT comments/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;comment_autocomplete&quot;:&#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;completion&quot;,</span><br><span class=\"line\">      &quot;contexts&quot;:[&#123;</span><br><span class=\"line\">        &quot;type&quot;:&quot;category&quot;,</span><br><span class=\"line\">        &quot;name&quot;:&quot;comment_category&quot;</span><br><span class=\"line\">      &#125;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST comments/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;I love the star war movies&quot;,</span><br><span class=\"line\">  &quot;comment_autocomplete&quot;:&#123;</span><br><span class=\"line\">    &quot;input&quot;:[&quot;star wars&quot;],</span><br><span class=\"line\">    &quot;contexts&quot;:&#123;</span><br><span class=\"line\">      &quot;comment_category&quot;:&quot;movies&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST comments/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;Where can I find a Starbucks&quot;,</span><br><span class=\"line\">  &quot;comment_autocomplete&quot;:&#123;</span><br><span class=\"line\">    &quot;input&quot;:[&quot;starbucks&quot;],</span><br><span class=\"line\">    &quot;contexts&quot;:&#123;</span><br><span class=\"line\">      &quot;comment_category&quot;:&quot;coffee&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST comments/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;suggest&quot;: &#123;</span><br><span class=\"line\">    &quot;MY_SUGGESTION&quot;: &#123;</span><br><span class=\"line\">      &quot;prefix&quot;: &quot;sta&quot;,</span><br><span class=\"line\">      &quot;completion&quot;:&#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;comment_autocomplete&quot;,</span><br><span class=\"line\">        &quot;contexts&quot;:&#123;</span><br><span class=\"line\">          &quot;comment_category&quot;:&quot;coffee&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"4-13-跨集群搜索-md\"><a href=\"#4-13-跨集群搜索-md\" class=\"headerlink\" title=\"4.13-跨集群搜索.md\"></a>4.13-跨集群搜索.md</h1><h1 id=\"跨集群搜索\"><a href=\"#跨集群搜索\" class=\"headerlink\" title=\"跨集群搜索\"></a>跨集群搜索</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//启动3个集群</span><br><span class=\"line\"></span><br><span class=\"line\">bin/elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300</span><br><span class=\"line\">bin/elasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301</span><br><span class=\"line\">bin/elasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//在每个集群上设置动态的设置</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster&quot;: &#123;</span><br><span class=\"line\">      &quot;remote&quot;: &#123;</span><br><span class=\"line\">        &quot;cluster0&quot;: &#123;</span><br><span class=\"line\">          &quot;seeds&quot;: [</span><br><span class=\"line\">            &quot;127.0.0.1:9300&quot;</span><br><span class=\"line\">          ],</span><br><span class=\"line\">          &quot;transport.ping_schedule&quot;: &quot;30s&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;cluster1&quot;: &#123;</span><br><span class=\"line\">          &quot;seeds&quot;: [</span><br><span class=\"line\">            &quot;127.0.0.1:9301&quot;</span><br><span class=\"line\">          ],</span><br><span class=\"line\">          &quot;transport.compress&quot;: true,</span><br><span class=\"line\">          &quot;skip_unavailable&quot;: true</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;cluster2&quot;: &#123;</span><br><span class=\"line\">          &quot;seeds&quot;: [</span><br><span class=\"line\">            &quot;127.0.0.1:9302&quot;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#cURL</span><br><span class=\"line\">curl -XPUT &quot;http://localhost:9200/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -XPUT &quot;http://localhost:9201/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -XPUT &quot;http://localhost:9202/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#创建测试数据</span><br><span class=\"line\">curl -XPOST &quot;http://localhost:9200/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -XPOST &quot;http://localhost:9201/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:20&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -XPOST &quot;http://localhost:9202/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user3&quot;,&quot;age&quot;:30&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#查询</span><br><span class=\"line\">GET /users,cluster1:users,cluster2:users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;range&quot;: &#123;</span><br><span class=\"line\">      &quot;age&quot;: &#123;</span><br><span class=\"line\">        &quot;gte&quot;: 20,</span><br><span class=\"line\">        &quot;lte&quot;: 40</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"4-2-结构化搜索-md\"><a href=\"#4-2-结构化搜索-md\" class=\"headerlink\" title=\"4.2-结构化搜索.md\"></a>4.2-结构化搜索.md</h1><h1 id=\"结构化搜索\"><a href=\"#结构化搜索\" class=\"headerlink\" title=\"结构化搜索\"></a>结构化搜索</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#结构化搜索，精确匹配</span><br><span class=\"line\">DELETE products</span><br><span class=\"line\">POST /products/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET products/_mapping</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#对布尔值 match 查询，有算分</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;avaliable&quot;: true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#对布尔值，通过constant score 转成 filtering，没有算分</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;avaliable&quot;: true</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#数字类型 Term</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;price&quot;: 30</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#数字类型 terms</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;terms&quot;: &#123;</span><br><span class=\"line\">          &quot;price&quot;: [</span><br><span class=\"line\">            &quot;20&quot;,</span><br><span class=\"line\">            &quot;30&quot;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#数字 Range 查询</span><br><span class=\"line\">GET products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot; : &#123;</span><br><span class=\"line\">        &quot;constant_score&quot; : &#123;</span><br><span class=\"line\">            &quot;filter&quot; : &#123;</span><br><span class=\"line\">                &quot;range&quot; : &#123;</span><br><span class=\"line\">                    &quot;price&quot; : &#123;</span><br><span class=\"line\">                        &quot;gte&quot; : 20,</span><br><span class=\"line\">                        &quot;lte&quot;  : 30</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 日期 range</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot; : &#123;</span><br><span class=\"line\">        &quot;constant_score&quot; : &#123;</span><br><span class=\"line\">            &quot;filter&quot; : &#123;</span><br><span class=\"line\">                &quot;range&quot; : &#123;</span><br><span class=\"line\">                    &quot;date&quot; : &#123;</span><br><span class=\"line\">                      &quot;gte&quot; : &quot;now-1y&quot;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#exists查询</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;exists&quot;: &#123;</span><br><span class=\"line\">          &quot;field&quot;: &quot;date&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#处理多值字段</span><br><span class=\"line\">POST /movies/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot; : &quot;Father of the Bridge Part II&quot;,&quot;year&quot;:1995, &quot;genre&quot;:&quot;Comedy&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot; : &quot;Dave&quot;,&quot;year&quot;:1993,&quot;genre&quot;:[&quot;Comedy&quot;,&quot;Romance&quot;] &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#处理多值字段，term 查询是包含，而不是等于</span><br><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;genre.keyword&quot;: &quot;Comedy&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#字符类型 terms</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;terms&quot;: &#123;</span><br><span class=\"line\">          &quot;productID.keyword&quot;: [</span><br><span class=\"line\">            &quot;QQPX-R-3956-#aD8&quot;,</span><br><span class=\"line\">            &quot;JODL-X-1937-#pV7&quot;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;price&quot;: 30</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;date&quot;: &quot;2019-01-01&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;date&quot;: &quot;2019-01-01&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#对布尔数值</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;avaliable&quot;: &quot;false&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;avaliable&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;false&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;price&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;20&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;price&quot;: &quot;20&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;bool&quot;: &#123;</span><br><span class=\"line\">          &quot;must_not&quot;: &#123;</span><br><span class=\"line\">            &quot;exists&quot;: &#123;</span><br><span class=\"line\">              &quot;field&quot;: &quot;date&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-3-搜索的相关性算分-md\"><a href=\"#4-3-搜索的相关性算分-md\" class=\"headerlink\" title=\"4.3-搜索的相关性算分.md\"></a>4.3-搜索的相关性算分.md</h1><h1 id=\"搜索的相关性算分\"><a href=\"#搜索的相关性算分\" class=\"headerlink\" title=\"搜索的相关性算分\"></a>搜索的相关性算分</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT testscore</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 1</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT testscore/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;we use Elasticsearch to power the search&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;we like elasticsearch&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;The scoring of documents is caculated by the scoring formula&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;you know, for search&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /testscore/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  //&quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;:&quot;you&quot;</span><br><span class=\"line\">      //&quot;content&quot;: &quot;elasticsearch&quot;</span><br><span class=\"line\">      //&quot;content&quot;:&quot;the&quot;</span><br><span class=\"line\">      //&quot;content&quot;: &quot;the elasticsearch&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST testscore/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;boosting&quot; : &#123;</span><br><span class=\"line\">            &quot;positive&quot; : &#123;</span><br><span class=\"line\">                &quot;term&quot; : &#123;</span><br><span class=\"line\">                    &quot;content&quot; : &quot;elasticsearch&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;negative&quot; : &#123;</span><br><span class=\"line\">                 &quot;term&quot; : &#123;</span><br><span class=\"line\">                     &quot;content&quot; : &quot;like&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;negative_boost&quot; : 0.2</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST tmdb/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;more_like_this&quot;: &#123;</span><br><span class=\"line\">      &quot;fields&quot;: [</span><br><span class=\"line\">        &quot;title^10&quot;,&quot;overview&quot;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;like&quot;: [&#123;&quot;_id&quot;:&quot;14191&quot;&#125;],</span><br><span class=\"line\">      &quot;min_term_freq&quot;: 1,</span><br><span class=\"line\">      &quot;max_query_terms&quot;: 12</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"4-4-Query-Filtering实现多字符串多字段查询-md\"><a href=\"#4-4-Query-Filtering实现多字符串多字段查询-md\" class=\"headerlink\" title=\"4.4-Query&amp;Filtering实现多字符串多字段查询.md\"></a>4.4-Query&amp;Filtering实现多字符串多字段查询.md</h1><h1 id=\"Query-Filtering-与多字符串多字段查询\"><a href=\"#Query-Filtering-与多字符串多字段查询\" class=\"headerlink\" title=\"Query &amp; Filtering 与多字符串多字段查询\"></a>Query &amp; Filtering 与多字符串多字段查询</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /products/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#基本语法</span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot; : &#123;</span><br><span class=\"line\">      &quot;must&quot; : &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;price&quot; : &quot;30&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot; : &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;should&quot; : [</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;JODL-X-1937-#pV7&quot; &#125; &#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125; &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;minimum_should_match&quot; :1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题</span><br><span class=\"line\">POST /newmovies/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot; : &quot;Father of the Bridge Part II&quot;,&quot;year&quot;:1995, &quot;genre&quot;:&quot;Comedy&quot;,&quot;genre_count&quot;:1 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot; : &quot;Dave&quot;,&quot;year&quot;:1993,&quot;genre&quot;:[&quot;Comedy&quot;,&quot;Romance&quot;],&quot;genre_count&quot;:2 &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#must，有算分</span><br><span class=\"line\">POST /newmovies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;genre.keyword&quot;: &#123;&quot;value&quot;: &quot;Comedy&quot;&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;genre_count&quot;: &#123;&quot;value&quot;: 1&#125;&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Filter。不参与算分，结果的score是0</span><br><span class=\"line\">POST /newmovies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: [</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;genre.keyword&quot;: &#123;&quot;value&quot;: &quot;Comedy&quot;&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;genre_count&quot;: &#123;&quot;value&quot;: 1&#125;&#125;&#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Filtering Context</span><br><span class=\"line\">POST _search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot; : &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot; : &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Query Context</span><br><span class=\"line\">POST /products/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;term&quot;: &#123;</span><br><span class=\"line\">            &quot;productID.keyword&quot;: &#123;</span><br><span class=\"line\">              &quot;value&quot;: &quot;JODL-X-1937-#pV7&quot;&#125;&#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;avaliable&quot;: &#123;&quot;value&quot;: true&#125;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#嵌套，实现了 should not 逻辑</span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;price&quot;: &quot;30&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;bool&quot;: &#123;</span><br><span class=\"line\">            &quot;must_not&quot;: &#123;</span><br><span class=\"line\">              &quot;term&quot;: &#123;</span><br><span class=\"line\">                &quot;avaliable&quot;: &quot;false&quot;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;minimum_should_match&quot;: 1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Controll the Precision</span><br><span class=\"line\">POST _search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot; : &#123;</span><br><span class=\"line\">      &quot;must&quot; : &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;price&quot; : &quot;30&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot; : &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;should&quot; : [</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;JODL-X-1937-#pV7&quot; &#125; &#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125; &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;minimum_should_match&quot; :2</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /animals/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;red&quot; &#125;&#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;quick&quot;   &#125;&#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;dog&quot;   &#125;&#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /animals/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;quick&quot; &#125;&#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;dog&quot;   &#125;&#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;bool&quot;:&#123;</span><br><span class=\"line\">            &quot;should&quot;:[</span><br><span class=\"line\">               &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class=\"line\">                 &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class=\"line\">            ]</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE blogs</span><br><span class=\"line\">POST /blogs/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123;&quot;title&quot;:&quot;Apple iPad&quot;, &quot;content&quot;:&quot;Apple iPad,Apple iPad&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123;&quot;title&quot;:&quot;Apple iPad,Apple iPad&quot;, &quot;content&quot;:&quot;Apple iPad&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;title&quot;: &#123;</span><br><span class=\"line\">            &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class=\"line\">            &quot;boost&quot;: 1.1</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;content&quot;: &#123;</span><br><span class=\"line\">            &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class=\"line\">            &quot;boost&quot;:</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;&#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE news</span><br><span class=\"line\">POST /news/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;Apple Mac&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;Apple iPad&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;Apple employee like Apple Pie and Apple Juice&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST news/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;apple&quot;&#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST news/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;apple&quot;&#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;pie&quot;&#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST news/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;boosting&quot;: &#123;</span><br><span class=\"line\">      &quot;positive&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;content&quot;: &quot;apple&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;negative&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;content&quot;: &quot;pie&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;negative_boost&quot;: 0.5</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-5-单字符串多字段查询-DisMaxQuery-md\"><a href=\"#4-5-单字符串多字段查询-DisMaxQuery-md\" class=\"headerlink\" title=\"4.5-单字符串多字段查询-DisMaxQuery.md\"></a>4.5-单字符串多字段查询-DisMaxQuery.md</h1><h1 id=\"单字符串多字段查询：Dis-Max-Query\"><a href=\"#单字符串多字段查询：Dis-Max-Query\" class=\"headerlink\" title=\"单字符串多字段查询：Dis Max Query\"></a>单字符串多字段查询：Dis Max Query</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">PUT /blogs/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;title&quot;: &quot;Quick brown rabbits&quot;,</span><br><span class=\"line\">    &quot;body&quot;:  &quot;Brown rabbits are commonly seen.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /blogs/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;title&quot;: &quot;Keeping pets healthy&quot;,</span><br><span class=\"line\">    &quot;body&quot;:  &quot;My quick brown fox eats rabbits on a regular basis.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;bool&quot;: &#123;</span><br><span class=\"line\">            &quot;should&quot;: [</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Brown fox&quot; &#125;&#125;,</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Brown fox&quot; &#125;&#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;dis_max&quot;: &#123;</span><br><span class=\"line\">            &quot;queries&quot;: [</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;dis_max&quot;: &#123;</span><br><span class=\"line\">            &quot;queries&quot;: [</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class=\"line\">            ],</span><br><span class=\"line\">            &quot;tie_breaker&quot;: 0.2</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-6-单字符串多字段查询-Multi-Match-md\"><a href=\"#4-6-单字符串多字段查询-Multi-Match-md\" class=\"headerlink\" title=\"4.6-单字符串多字段查询-Multi-Match.md\"></a>4.6-单字符串多字段查询-Multi-Match.md</h1><h1 id=\"单字符串多字段查询：Multi-Match\"><a href=\"#单字符串多字段查询：Multi-Match\" class=\"headerlink\" title=\"单字符串多字段查询：Multi Match\"></a>单字符串多字段查询：Multi Match</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;dis_max&quot;: &#123;</span><br><span class=\"line\">            &quot;queries&quot;: [</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class=\"line\">            ],</span><br><span class=\"line\">            &quot;tie_breaker&quot;: 0.2</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;best_fields&quot;,</span><br><span class=\"line\">      &quot;query&quot;: &quot;Quick pets&quot;,</span><br><span class=\"line\">      &quot;fields&quot;: [&quot;title&quot;,&quot;body&quot;],</span><br><span class=\"line\">      &quot;tie_breaker&quot;: 0.2,</span><br><span class=\"line\">      &quot;minimum_should_match&quot;: &quot;20%&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">        &quot;query&quot;:  &quot;Quick brown fox&quot;,</span><br><span class=\"line\">        &quot;fields&quot;: &quot;*_title&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">        &quot;query&quot;:  &quot;Quick brown fox&quot;,</span><br><span class=\"line\">        &quot;fields&quot;: [ &quot;*_title&quot;, &quot;chapter_title^2&quot; ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE /titles</span><br><span class=\"line\">PUT /titles</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;settings&quot;: &#123; &quot;number_of_shards&quot;: 1 &#125;,</span><br><span class=\"line\">    &quot;mappings&quot;: &#123;</span><br><span class=\"line\">        &quot;my_type&quot;: &#123;</span><br><span class=\"line\">            &quot;properties&quot;: &#123;</span><br><span class=\"line\">                &quot;title&quot;: &#123;</span><br><span class=\"line\">                    &quot;type&quot;:     &quot;string&quot;,</span><br><span class=\"line\">                    &quot;analyzer&quot;: &quot;english&quot;,</span><br><span class=\"line\">                    &quot;fields&quot;: &#123;</span><br><span class=\"line\">                        &quot;std&quot;:   &#123;</span><br><span class=\"line\">                            &quot;type&quot;:     &quot;string&quot;,</span><br><span class=\"line\">                            &quot;analyzer&quot;: &quot;standard&quot;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /titles</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;title&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;analyzer&quot;: &quot;english&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST titles/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;My dog barks&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I see a lot of barking dogs on the road &quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET titles/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;title&quot;: &quot;barking dogs&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE /titles</span><br><span class=\"line\">PUT /titles</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;title&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;analyzer&quot;: &quot;english&quot;,</span><br><span class=\"line\">        &quot;fields&quot;: &#123;&quot;std&quot;: &#123;&quot;type&quot;: &quot;text&quot;,&quot;analyzer&quot;: &quot;standard&quot;&#125;&#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST titles/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;My dog barks&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I see a lot of barking dogs on the road &quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /titles/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">            &quot;query&quot;:  &quot;barking dogs&quot;,</span><br><span class=\"line\">            &quot;type&quot;:   &quot;most_fields&quot;,</span><br><span class=\"line\">            &quot;fields&quot;: [ &quot;title&quot;, &quot;title.std&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /titles/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">            &quot;query&quot;:  &quot;barking dogs&quot;,</span><br><span class=\"line\">            &quot;type&quot;:   &quot;most_fields&quot;,</span><br><span class=\"line\">            &quot;fields&quot;: [ &quot;title^10&quot;, &quot;title.std&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-7-多语言及中文分词与检索-md\"><a href=\"#4-7-多语言及中文分词与检索-md\" class=\"headerlink\" title=\"4.7-多语言及中文分词与检索.md\"></a>4.7-多语言及中文分词与检索.md</h1><h1 id=\"多语言及中文分词与检索\"><a href=\"#多语言及中文分词与检索\" class=\"headerlink\" title=\"多语言及中文分词与检索\"></a>多语言及中文分词与检索</h1><ul>\n<li><p>来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”</p>\n</li>\n<li><p>你也想犯范范玮琪犯过的错吗</p>\n</li>\n<li><p>校长说衣服上除了校徽别别别的</p>\n</li>\n<li><p>这几天天天天气不好</p>\n</li>\n<li><p>我背有点驼，麻麻说“你的背得背背背背佳</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#stop word</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_index</span><br><span class=\"line\">PUT /my_index/_doc/1</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I&#x27;m happy for this fox&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index/_doc/2</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I&#x27;m not happy about my fox problem&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST my_index/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;title&quot;: &quot;not happy fox&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 `english`（英语）分析器，另一次使用 `standard`（标准）分析器:</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_index</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;blog&quot;: &#123;</span><br><span class=\"line\">      &quot;properties&quot;: &#123;</span><br><span class=\"line\">        &quot;title&quot;: &#123;</span><br><span class=\"line\">          &quot;type&quot;: &quot;string&quot;,</span><br><span class=\"line\">          &quot;analyzer&quot;: &quot;english&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;blog&quot;: &#123;</span><br><span class=\"line\">      &quot;properties&quot;: &#123;</span><br><span class=\"line\">        &quot;title&quot;: &#123;</span><br><span class=\"line\">          &quot;type&quot;: &quot;string&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: &#123;</span><br><span class=\"line\">            &quot;english&quot;: &#123;</span><br><span class=\"line\">              &quot;type&quot;:     &quot;string&quot;,</span><br><span class=\"line\">              &quot;analyzer&quot;: &quot;english&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index/blog/1</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I&#x27;m happy for this fox&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index/blog/2</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I&#x27;m not happy about my fox problem&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;:     &quot;most_fields&quot;,</span><br><span class=\"line\">      &quot;query&quot;:    &quot;not happy foxes&quot;,</span><br><span class=\"line\">      &quot;fields&quot;: [ &quot;title&quot;, &quot;title.english&quot; ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#安装插件</span><br><span class=\"line\">./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</span><br><span class=\"line\">#安装插件</span><br><span class=\"line\">bin/elasticsearch install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#ik_max_word</span><br><span class=\"line\">#ik_smart</span><br><span class=\"line\">#hanlp: hanlp默认分词</span><br><span class=\"line\">#hanlp_standard: 标准分词</span><br><span class=\"line\">#hanlp_index: 索引分词</span><br><span class=\"line\">#hanlp_nlp: NLP分词</span><br><span class=\"line\">#hanlp_n_short: N-最短路分词</span><br><span class=\"line\">#hanlp_dijkstra: 最短路分词</span><br><span class=\"line\">#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）</span><br><span class=\"line\">#hanlp_speed: 极速词典分词</span><br><span class=\"line\"></span><br><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;analyzer&quot;: &quot;hanlp_standard&quot;,</span><br><span class=\"line\">  &quot;text&quot;: [&quot;剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;     </span><br><span class=\"line\"></span><br><span class=\"line\">#Pinyin</span><br><span class=\"line\">PUT /artists/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;settings&quot; : &#123;</span><br><span class=\"line\">        &quot;analysis&quot; : &#123;</span><br><span class=\"line\">            &quot;analyzer&quot; : &#123;</span><br><span class=\"line\">                &quot;user_name_analyzer&quot; : &#123;</span><br><span class=\"line\">                    &quot;tokenizer&quot; : &quot;whitespace&quot;,</span><br><span class=\"line\">                    &quot;filter&quot; : &quot;pinyin_first_letter_and_full_pinyin_filter&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;filter&quot; : &#123;</span><br><span class=\"line\">                &quot;pinyin_first_letter_and_full_pinyin_filter&quot; : &#123;</span><br><span class=\"line\">                    &quot;type&quot; : &quot;pinyin&quot;,</span><br><span class=\"line\">                    &quot;keep_first_letter&quot; : true,</span><br><span class=\"line\">                    &quot;keep_full_pinyin&quot; : false,</span><br><span class=\"line\">                    &quot;keep_none_chinese&quot; : true,</span><br><span class=\"line\">                    &quot;keep_original&quot; : false,</span><br><span class=\"line\">                    &quot;limit_first_letter_length&quot; : 16,</span><br><span class=\"line\">                    &quot;lowercase&quot; : true,</span><br><span class=\"line\">                    &quot;trim_whitespace&quot; : true,</span><br><span class=\"line\">                    &quot;keep_none_chinese_in_first_letter&quot; : true</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET /artists/_analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;text&quot;: [&quot;刘德华 张学友 郭富城 黎明 四大天王&quot;],</span><br><span class=\"line\">  &quot;analyzer&quot;: &quot;user_name_analyzer&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"相关资源\"><a href=\"#相关资源\" class=\"headerlink\" title=\"相关资源\"></a>相关资源</h2><ul>\n<li><p>Elasticsearch IK分词插件 <a href=\"https://github.com/medcl/elasticsearch-analysis-ik/releases\">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>\n</li>\n<li><p>Elasticsearch hanlp 分词插件 <a href=\"https://github.com/KennFalcon/elasticsearch-analysis-hanlp\">https://github.com/KennFalcon/elasticsearch-analysis-hanlp</a></p>\n</li>\n<li><p>分词算法综述 <a href=\"https://zhuanlan.zhihu.com/p/50444885\">https://zhuanlan.zhihu.com/p/50444885</a></p>\n</li>\n</ul>\n<h3 id=\"一些分词工具，供参考：\"><a href=\"#一些分词工具，供参考：\" class=\"headerlink\" title=\"一些分词工具，供参考：\"></a>一些分词工具，供参考：</h3><ul>\n<li>中科院计算所NLPIR <a href=\"http://ictclas.nlpir.org/nlpir/\">http://ictclas.nlpir.org/nlpir/</a></li>\n<li>ansj分词器 <a href=\"https://github.com/NLPchina/ansj_seg\">https://github.com/NLPchina/ansj_seg</a></li>\n<li>哈工大的LTP <a href=\"https://github.com/HIT-SCIR/ltp\">https://github.com/HIT-SCIR/ltp</a></li>\n<li>清华大学THULAC <a href=\"https://github.com/thunlp/THULAC\">https://github.com/thunlp/THULAC</a></li>\n<li>斯坦福分词器 <a href=\"https://nlp.stanford.edu/software/segmenter.shtml\">https://nlp.stanford.edu/software/segmenter.shtml</a></li>\n<li>Hanlp分词器 <a href=\"https://github.com/hankcs/HanLP\">https://github.com/hankcs/HanLP</a></li>\n<li>结巴分词 <a href=\"https://github.com/yanyiwu/cppjieba\">https://github.com/yanyiwu/cppjieba</a></li>\n<li>KCWS分词器(字嵌入+Bi-LSTM+CRF) <a href=\"https://github.com/koth/kcws\">https://github.com/koth/kcws</a></li>\n<li>ZPar <a href=\"https://github.com/frcchang/zpar/releases\">https://github.com/frcchang/zpar/releases</a></li>\n<li>IKAnalyzer <a href=\"https://github.com/wks/ik-analyzer\">https://github.com/wks/ik-analyzer</a></li>\n</ul>\n<h1 id=\"4-8-SpaceJam一个全文搜索的实例-md\"><a href=\"#4-8-SpaceJam一个全文搜索的实例-md\" class=\"headerlink\" title=\"4.8-SpaceJam一个全文搜索的实例.md\"></a>4.8-SpaceJam一个全文搜索的实例.md</h1><h1 id=\"Space-Jam，一次全文搜索的实例\"><a href=\"#Space-Jam，一次全文搜索的实例\" class=\"headerlink\" title=\"Space Jam，一次全文搜索的实例\"></a>Space Jam，一次全文搜索的实例</h1><h2 id=\"环境要求\"><a href=\"#环境要求\" class=\"headerlink\" title=\"环境要求\"></a>环境要求</h2><ul>\n<li>Python 2.7.15</li>\n<li>可以使用pyenv管理多个python版本（可选）</li>\n</ul>\n<h2 id=\"进入-tmdb-search目录\"><a href=\"#进入-tmdb-search目录\" class=\"headerlink\" title=\"进入 tmdb-search目录\"></a>进入 tmdb-search目录</h2><p>Run<br>pip install -r requirements.txt<br>Run python .&#x2F;ingest_tmdb_from_file.py</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST tmdb/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class=\"line\"> &quot;query&quot;: &#123;</span><br><span class=\"line\">   &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST tmdb/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &quot;basketball with cartoon aliens&quot;,</span><br><span class=\"line\">      &quot;fields&quot;: [&quot;title&quot;,&quot;overview&quot;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;highlight&quot; : &#123;</span><br><span class=\"line\">        &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;overview&quot; : &#123; &quot;pre_tags&quot; : [&quot;\\\\033[0;32;40m&quot;], &quot;post_tags&quot; : [&quot;\\\\033[0m&quot;] &#125;,</span><br><span class=\"line\">            &quot;title&quot; : &#123; &quot;pre_tags&quot; : [&quot;\\\\033[0;32;40m&quot;], &quot;post_tags&quot; : [&quot;\\\\033[0m&quot;] &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"相关\"><a href=\"#相关\" class=\"headerlink\" title=\"相关\"></a>相关</h2><ul>\n<li>Windows 安装 pyenv <a href=\"https://github.com/pyenv-win/pyenv-win\">https://github.com/pyenv-win/pyenv-win</a></li>\n<li>Mac 安装pyenv <a href=\"https://segmentfault.com/a/1190000017403221\">https://segmentfault.com/a/1190000017403221</a></li>\n<li>Linux 安装 pyenv <a href=\"https://blog.csdn.net/GX_1_11_real/article/details/80237064\">https://blog.csdn.net/GX_1_11_real/article/details/80237064</a></li>\n<li>Python.org <a href=\"https://www.python.org/\">https://www.python.org/</a></li>\n</ul>\n<h1 id=\"4-9-使用SearchTemplate和IndexAlias进行查询-md\"><a href=\"#4-9-使用SearchTemplate和IndexAlias进行查询-md\" class=\"headerlink\" title=\"4.9-使用SearchTemplate和IndexAlias进行查询.md\"></a>4.9-使用SearchTemplate和IndexAlias进行查询.md</h1><h1 id=\"使用-Search-Template-和-Index-Alias-查询\"><a href=\"#使用-Search-Template-和-Index-Alias-查询\" class=\"headerlink\" title=\"使用 Search Template 和 Index Alias 查询\"></a>使用 Search Template 和 Index Alias 查询</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _scripts/tmdb</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;script&quot;: &#123;</span><br><span class=\"line\">    &quot;lang&quot;: &quot;mustache&quot;,</span><br><span class=\"line\">    &quot;source&quot;: &#123;</span><br><span class=\"line\">      &quot;_source&quot;: [</span><br><span class=\"line\">        &quot;title&quot;,&quot;overview&quot;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;size&quot;: 20,</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;: &quot;&#123;&#123;q&#125;&#125;&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [&quot;title&quot;,&quot;overview&quot;]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">DELETE _scripts/tmdb</span><br><span class=\"line\"></span><br><span class=\"line\">GET _scripts/tmdb</span><br><span class=\"line\"></span><br><span class=\"line\">POST tmdb/_search/template</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;id&quot;:&quot;tmdb&quot;,</span><br><span class=\"line\">    &quot;params&quot;: &#123;</span><br><span class=\"line\">        &quot;q&quot;: &quot;basketball with cartoon aliens&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT movies-2019/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;:&quot;the matrix&quot;,</span><br><span class=\"line\">  &quot;rating&quot;:5</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT movies-2019/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;:&quot;Speed&quot;,</span><br><span class=\"line\">  &quot;rating&quot;:3</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST _aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;actions&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;add&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;movies-2019&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;movies-latest&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST movies-latest/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST _aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;actions&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;add&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;movies-2019&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;movies-lastest-highrate&quot;,</span><br><span class=\"line\">        &quot;filter&quot;: &#123;</span><br><span class=\"line\">          &quot;range&quot;: &#123;</span><br><span class=\"line\">            &quot;rating&quot;: &#123;</span><br><span class=\"line\">              &quot;gte&quot;: 4</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST movies-lastest-highrate/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"5-1-集群分布式模型及选主与脑裂问题-md\"><a href=\"#5-1-集群分布式模型及选主与脑裂问题-md\" class=\"headerlink\" title=\"5.1-集群分布式模型及选主与脑裂问题.md\"></a>5.1-集群分布式模型及选主与脑裂问题.md</h1><h1 id=\"集群分布式模型及选主与脑裂问题\"><a href=\"#集群分布式模型及选主与脑裂问题\" class=\"headerlink\" title=\"集群分布式模型及选主与脑裂问题\"></a>集群分布式模型及选主与脑裂问题</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data</span><br><span class=\"line\">bin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data</span><br><span class=\"line\">bin/elasticsearch -E node.name=node3 -E cluster.name=geektime -E path.data=node3_data</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"5-2-分片与集群的故障转移-md\"><a href=\"#5-2-分片与集群的故障转移-md\" class=\"headerlink\" title=\"5.2-分片与集群的故障转移.md\"></a>5.2-分片与集群的故障转移.md</h1><h1 id=\"分片与集群的故障转移\"><a href=\"#分片与集群的故障转移\" class=\"headerlink\" title=\"分片与集群的故障转移\"></a>分片与集群的故障转移</h1><h1 id=\"5-3-文档分布式存储-md\"><a href=\"#5-3-文档分布式存储-md\" class=\"headerlink\" title=\"5.3-文档分布式存储.md\"></a>5.3-文档分布式存储.md</h1><h1 id=\"文档分布式存储\"><a href=\"#文档分布式存储\" class=\"headerlink\" title=\"文档分布式存储\"></a>文档分布式存储</h1><h1 id=\"5-4-分片及其生命周期-md\"><a href=\"#5-4-分片及其生命周期-md\" class=\"headerlink\" title=\"5.4-分片及其生命周期.md\"></a>5.4-分片及其生命周期.md</h1><h1 id=\"分片及其生命周期\"><a href=\"#分片及其生命周期\" class=\"headerlink\" title=\"分片及其生命周期\"></a>分片及其生命周期</h1><h1 id=\"5-5-剖析分布式查询及相关性评分-md\"><a href=\"#5-5-剖析分布式查询及相关性评分-md\" class=\"headerlink\" title=\"5.5-剖析分布式查询及相关性评分.md\"></a>5.5-剖析分布式查询及相关性评分.md</h1><h1 id=\"剖析分布式查询及相关性评分\"><a href=\"#剖析分布式查询及相关性评分\" class=\"headerlink\" title=\"剖析分布式查询及相关性评分\"></a>剖析分布式查询及相关性评分</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE message</span><br><span class=\"line\">PUT message</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 20</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET message</span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_doc?routing=1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;good&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_doc?routing=2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;good morning&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_doc?routing=3</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;good morning everyone&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;good&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_search?search_type=dfs_query_then_fetch</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;good&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"5-6-排序及DocValues-Fielddata-md\"><a href=\"#5-6-排序及DocValues-Fielddata-md\" class=\"headerlink\" title=\"5.6-排序及DocValues&amp;Fielddata.md\"></a>5.6-排序及DocValues&amp;Fielddata.md</h1><h1 id=\"排序及Doc-Values-Fielddata\"><a href=\"#排序及Doc-Values-Fielddata\" class=\"headerlink\" title=\"排序及Doc Values &amp; Fielddata\"></a>排序及Doc Values &amp; Fielddata</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#单字段排序</span><br><span class=\"line\">POST /kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 5,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;sort&quot;: [</span><br><span class=\"line\">    &#123;&quot;order_date&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#多字段排序</span><br><span class=\"line\">POST /kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 5,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;sort&quot;: [</span><br><span class=\"line\">    &#123;&quot;order_date&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;,</span><br><span class=\"line\">    &#123;&quot;_doc&quot;:&#123;&quot;order&quot;: &quot;asc&quot;&#125;&#125;,</span><br><span class=\"line\">    &#123;&quot;_score&quot;:&#123; &quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET kibana_sample_data_ecommerce/_mapping</span><br><span class=\"line\"></span><br><span class=\"line\">#对 text 字段进行排序。默认会报错，需打开fielddata</span><br><span class=\"line\">POST /kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 5,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;sort&quot;: [</span><br><span class=\"line\">    &#123;&quot;customer_full_name&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#打开 text的 fielddata</span><br><span class=\"line\">PUT kibana_sample_data_ecommerce/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;customer_full_name&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fielddata&quot;: true,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 256</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#关闭 keyword的 doc values</span><br><span class=\"line\">PUT test_keyword</span><br><span class=\"line\">PUT test_keyword/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;user_name&quot;:&#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;keyword&quot;,</span><br><span class=\"line\">      &quot;doc_values&quot;:false</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE test_keyword</span><br><span class=\"line\"></span><br><span class=\"line\">PUT test_text</span><br><span class=\"line\">PUT test_text/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;intro&quot;:&#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">      &quot;doc_values&quot;:true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE test_text</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE temp_users</span><br><span class=\"line\">PUT temp_users</span><br><span class=\"line\">PUT temp_users/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;name&quot;:&#123;&quot;type&quot;: &quot;text&quot;,&quot;fielddata&quot;: true&#125;,</span><br><span class=\"line\">    &quot;desc&quot;:&#123;&quot;type&quot;: &quot;text&quot;,&quot;fielddata&quot;: true&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Post temp_users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;Jack&quot;,&quot;desc&quot;:&quot;Jack is a good boy!&quot;,&quot;age&quot;:10&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#打开fielddata 后，查看 docvalue_fields数据</span><br><span class=\"line\">POST  temp_users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;docvalue_fields&quot;: [</span><br><span class=\"line\">    &quot;name&quot;,&quot;desc&quot;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#查看整型字段的docvalues</span><br><span class=\"line\">POST  temp_users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;docvalue_fields&quot;: [</span><br><span class=\"line\">    &quot;age&quot;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"5-7-分页与遍历-FromSize-SearchAfter-ScrollAPI-md\"><a href=\"#5-7-分页与遍历-FromSize-SearchAfter-ScrollAPI-md\" class=\"headerlink\" title=\"5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md\"></a>5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md</h1><h1 id=\"分页与遍历-From-Size-Search-after-Scroll-API\"><a href=\"#分页与遍历-From-Size-Search-after-Scroll-API\" class=\"headerlink\" title=\"分页与遍历 - From, Size, Search_after &amp; Scroll API\"></a>分页与遍历 - From, Size, Search_after &amp; Scroll API</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">POST tmdb/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;from&quot;: 10000,</span><br><span class=\"line\">  &quot;size&quot;: 1,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Scroll API</span><br><span class=\"line\">DELETE users</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:11&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:12&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:13&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_count</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;size&quot;: 1,</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;sort&quot;: [</span><br><span class=\"line\">        &#123;&quot;age&quot;: &quot;desc&quot;&#125; ,</span><br><span class=\"line\">        &#123;&quot;_id&quot;: &quot;asc&quot;&#125;    </span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;size&quot;: 1,</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;search_after&quot;:</span><br><span class=\"line\">        [</span><br><span class=\"line\">          10,</span><br><span class=\"line\">          &quot;ZQ0vYGsBrR8X3IP75QqX&quot;],</span><br><span class=\"line\">    &quot;sort&quot;: [</span><br><span class=\"line\">        &#123;&quot;age&quot;: &quot;desc&quot;&#125; ,</span><br><span class=\"line\">        &#123;&quot;_id&quot;: &quot;asc&quot;&#125;    </span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Scroll API</span><br><span class=\"line\">DELETE users</span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:20&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user3&quot;,&quot;age&quot;:30&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user4&quot;,&quot;age&quot;:40&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /users/_search?scroll=5m</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;size&quot;: 1,</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;match_all&quot; : &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user5&quot;,&quot;age&quot;:50&#125;</span><br><span class=\"line\">POST /_search/scroll</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;scroll&quot; : &quot;1m&quot;,</span><br><span class=\"line\">    &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ==&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"5-8-处理并发读写-md\"><a href=\"#5-8-处理并发读写-md\" class=\"headerlink\" title=\"5.8-处理并发读写.md\"></a>5.8-处理并发读写.md</h1><h1 id=\"处理并发读写操作\"><a href=\"#处理并发读写操作\" class=\"headerlink\" title=\"处理并发读写操作\"></a>处理并发读写操作</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">DELETE products</span><br><span class=\"line\">PUT products</span><br><span class=\"line\"></span><br><span class=\"line\">PUT products/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class=\"line\">  &quot;count&quot;:100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET products/_doc/1</span><br><span class=\"line\"></span><br><span class=\"line\">PUT products/_doc/1?if_seq_no=1&amp;if_primary_term=1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class=\"line\">  &quot;count&quot;:100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT products/_doc/1?version=30000&amp;version_type=external</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class=\"line\">  &quot;count&quot;:100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"6-1-Bucket-Metric聚合分析及嵌套聚合-md\"><a href=\"#6-1-Bucket-Metric聚合分析及嵌套聚合-md\" class=\"headerlink\" title=\"6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md\"></a>6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md</h1><h1 id=\"Bucket-Metric-Aggregation\"><a href=\"#Bucket-Metric-Aggregation\" class=\"headerlink\" title=\"Bucket &amp; Metric Aggregation\"></a>Bucket &amp; Metric Aggregation</h1><h2 id=\"demos\"><a href=\"#demos\" class=\"headerlink\" title=\"demos\"></a>demos</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE /employees</span><br><span class=\"line\">PUT /employees/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;age&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;gender&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;job&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 50</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;name&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;salary&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /employees/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Metric 聚合，找到最低的工资</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;min_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;min&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Metric 聚合，找到最高的工资</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;max_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;max&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 多个 Metric 聚合，找到最低最高和平均工资</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;max_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;max&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;min_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;min&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;avg&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 一个聚合，输出多值</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;stats_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;stats&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对keword 进行聚合</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对 Text 字段进行 terms 聚合查询，失败</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 对 Text 字段打开 fielddata，支持terms aggregation</span><br><span class=\"line\">PUT employees/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot; : &#123;</span><br><span class=\"line\">    &quot;job&quot;:&#123;</span><br><span class=\"line\">       &quot;type&quot;:     &quot;text&quot;,</span><br><span class=\"line\">       &quot;fielddata&quot;: true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对 Text 字段进行 terms 分词。分词后的terms</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;cardinate&quot;: &#123;</span><br><span class=\"line\">      &quot;cardinality&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对 性别的 keyword 进行聚合</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;gender&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;gender&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#指定 bucket 的 size</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;ages_5&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;age&quot;,</span><br><span class=\"line\">        &quot;size&quot;:3</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 指定size，不同工种中，年纪最大的3个员工的具体信息</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;:&#123;</span><br><span class=\"line\">        &quot;old_employee&quot;:&#123;</span><br><span class=\"line\">          &quot;top_hits&quot;:&#123;</span><br><span class=\"line\">            &quot;size&quot;:3,</span><br><span class=\"line\">            &quot;sort&quot;:[</span><br><span class=\"line\">              &#123;</span><br><span class=\"line\">                &quot;age&quot;:&#123;</span><br><span class=\"line\">                  &quot;order&quot;:&quot;desc&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Salary Ranges 分桶，可以自己定义 key</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;salary_range&quot;: &#123;</span><br><span class=\"line\">      &quot;range&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;,</span><br><span class=\"line\">        &quot;ranges&quot;:[</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            &quot;to&quot;:10000</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            &quot;from&quot;:10000,</span><br><span class=\"line\">            &quot;to&quot;:20000</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            &quot;key&quot;:&quot;&gt;20000&quot;,</span><br><span class=\"line\">            &quot;from&quot;:20000</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Salary Histogram,工资0到10万，以 5000一个区间进行分桶</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;salary_histrogram&quot;: &#123;</span><br><span class=\"line\">      &quot;histogram&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;,</span><br><span class=\"line\">        &quot;interval&quot;:5000,</span><br><span class=\"line\">        &quot;extended_bounds&quot;:&#123;</span><br><span class=\"line\">          &quot;min&quot;:0,</span><br><span class=\"line\">          &quot;max&quot;:100000</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 嵌套聚合1，按照工作类型分桶，并统计工资信息</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;Job_salary_stats&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;salary&quot;: &#123;</span><br><span class=\"line\">          &quot;stats&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;Job_gender_stats&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;gender_stats&quot;: &#123;</span><br><span class=\"line\">          &quot;terms&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;gender&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;aggs&quot;: &#123;</span><br><span class=\"line\">            &quot;salary_stats&quot;: &#123;</span><br><span class=\"line\">              &quot;stats&quot;: &#123;</span><br><span class=\"line\">                &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"6-2-Pipeline聚合分析-md\"><a href=\"#6-2-Pipeline聚合分析-md\" class=\"headerlink\" title=\"6.2-Pipeline聚合分析.md\"></a>6.2-Pipeline聚合分析.md</h1><h1 id=\"Pipeline-聚合分析\"><a href=\"#Pipeline-聚合分析\" class=\"headerlink\" title=\"Pipeline 聚合分析\"></a>Pipeline 聚合分析</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE employees</span><br><span class=\"line\">PUT /employees/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资最低的工作类型</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;min_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;min_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资最高的工作类型</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;max_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;max_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资的平均工资</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;avg_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;avg_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资的统计分析</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;stats_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;stats_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资的百分位数</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;percentiles_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;percentiles_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#按照年龄对平均工资求导</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;age&quot;: &#123;</span><br><span class=\"line\">      &quot;histogram&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;age&quot;,</span><br><span class=\"line\">        &quot;min_doc_count&quot;: 1,</span><br><span class=\"line\">        &quot;interval&quot;: 1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;derivative_avg_salary&quot;:&#123;</span><br><span class=\"line\">          &quot;derivative&quot;: &#123;</span><br><span class=\"line\">            &quot;buckets_path&quot;: &quot;avg_salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Cumulative_sum</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;age&quot;: &#123;</span><br><span class=\"line\">      &quot;histogram&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;age&quot;,</span><br><span class=\"line\">        &quot;min_doc_count&quot;: 1,</span><br><span class=\"line\">        &quot;interval&quot;: 1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;cumulative_salary&quot;:&#123;</span><br><span class=\"line\">          &quot;cumulative_sum&quot;: &#123;</span><br><span class=\"line\">            &quot;buckets_path&quot;: &quot;avg_salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Moving Function</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;age&quot;: &#123;</span><br><span class=\"line\">      &quot;histogram&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;age&quot;,</span><br><span class=\"line\">        &quot;min_doc_count&quot;: 1,</span><br><span class=\"line\">        &quot;interval&quot;: 1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;moving_avg_salary&quot;:&#123;</span><br><span class=\"line\">          &quot;moving_fn&quot;: &#123;</span><br><span class=\"line\">            &quot;buckets_path&quot;: &quot;avg_salary&quot;,</span><br><span class=\"line\">            &quot;window&quot;:10,</span><br><span class=\"line\">            &quot;script&quot;: &quot;MovingFunctions.min(values)&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-3-作用范围与排序-md\"><a href=\"#6-3-作用范围与排序-md\" class=\"headerlink\" title=\"6.3-作用范围与排序.md\"></a>6.3-作用范围与排序.md</h1><h1 id=\"作用范围与排序\"><a href=\"#作用范围与排序\" class=\"headerlink\" title=\"作用范围与排序\"></a>作用范围与排序</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE /employees</span><br><span class=\"line\">PUT /employees/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;age&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;gender&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;job&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 50</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;name&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;salary&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /employees/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Query</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;range&quot;: &#123;</span><br><span class=\"line\">      &quot;age&quot;: &#123;</span><br><span class=\"line\">        &quot;gte&quot;: 20</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Filter</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;older_person&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;:&#123;</span><br><span class=\"line\">        &quot;range&quot;:&#123;</span><br><span class=\"line\">          &quot;age&quot;:&#123;</span><br><span class=\"line\">            &quot;from&quot;:35</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;:&#123;</span><br><span class=\"line\">         &quot;jobs&quot;:&#123;</span><br><span class=\"line\">           &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;&#125;,</span><br><span class=\"line\">    &quot;all_jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;post_filter&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;job.keyword&quot;: &quot;Dev Manager&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#global</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;range&quot;: &#123;</span><br><span class=\"line\">      &quot;age&quot;: &#123;</span><br><span class=\"line\">        &quot;gte&quot;: 40</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    </span><br><span class=\"line\">    &quot;all&quot;:&#123;</span><br><span class=\"line\">      &quot;global&quot;:&#123;&#125;,</span><br><span class=\"line\">      &quot;aggs&quot;:&#123;</span><br><span class=\"line\">        &quot;salary_avg&quot;:&#123;</span><br><span class=\"line\">          &quot;avg&quot;:&#123;</span><br><span class=\"line\">            &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#排序 order</span><br><span class=\"line\">#count and key</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;range&quot;: &#123;</span><br><span class=\"line\">      &quot;age&quot;: &#123;</span><br><span class=\"line\">        &quot;gte&quot;: 20</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;order&quot;:[</span><br><span class=\"line\">          &#123;&quot;_count&quot;:&quot;asc&quot;&#125;,</span><br><span class=\"line\">          &#123;&quot;_key&quot;:&quot;desc&quot;&#125;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#排序 order</span><br><span class=\"line\">#count and key</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;order&quot;:[  &#123;</span><br><span class=\"line\">            &quot;avg_salary&quot;:&quot;desc&quot;</span><br><span class=\"line\">          &#125;]</span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &quot;aggs&quot;: &#123;</span><br><span class=\"line\">      &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">        &quot;avg&quot;: &#123;</span><br><span class=\"line\">          &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#排序 order</span><br><span class=\"line\">#count and key</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;order&quot;:[  &#123;</span><br><span class=\"line\">            &quot;stats_salary.min&quot;:&quot;desc&quot;</span><br><span class=\"line\">          &#125;]</span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &quot;aggs&quot;: &#123;</span><br><span class=\"line\">      &quot;stats_salary&quot;: &#123;</span><br><span class=\"line\">        &quot;stats&quot;: &#123;</span><br><span class=\"line\">          &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-4-聚合分析的原理及精准度问题-md\"><a href=\"#6-4-聚合分析的原理及精准度问题-md\" class=\"headerlink\" title=\"6.4-聚合分析的原理及精准度问题.md\"></a>6.4-聚合分析的原理及精准度问题.md</h1><h1 id=\"聚合分析的原理及精准度问题\"><a href=\"#聚合分析的原理及精准度问题\" class=\"headerlink\" title=\"聚合分析的原理及精准度问题\"></a>聚合分析的原理及精准度问题</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE my_flights</span><br><span class=\"line\">PUT my_flights</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 20</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;AvgTicketPrice&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;float&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Cancelled&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;boolean&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Carrier&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Dest&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestAirportID&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestCityName&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestCountry&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestLocation&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;geo_point&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestRegion&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestWeather&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DistanceKilometers&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;float&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DistanceMiles&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;float&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightDelay&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;boolean&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightDelayMin&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightDelayType&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightNum&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightTimeHour&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightTimeMin&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;float&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Origin&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginAirportID&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginCityName&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginCountry&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginLocation&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;geo_point&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginRegion&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginWeather&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;dayOfWeek&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;timestamp&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;date&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST _reindex</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;source&quot;: &#123;</span><br><span class=\"line\">    &quot;index&quot;: &quot;kibana_sample_data_flights&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;dest&quot;: &#123;</span><br><span class=\"line\">    &quot;index&quot;: &quot;my_flights&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET kibana_sample_data_flights/_count</span><br><span class=\"line\">GET my_flights/_count</span><br><span class=\"line\"></span><br><span class=\"line\">get kibana_sample_data_flights/_search</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET kibana_sample_data_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;weather&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;OriginWeather&quot;,</span><br><span class=\"line\">        &quot;size&quot;:5,</span><br><span class=\"line\">        &quot;show_term_doc_count_error&quot;:true</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET my_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;weather&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;OriginWeather&quot;,</span><br><span class=\"line\">        &quot;size&quot;:1,</span><br><span class=\"line\">        &quot;shard_size&quot;:1,</span><br><span class=\"line\">        &quot;show_term_doc_count_error&quot;:true</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-1-对象及-Nested-对象-md\"><a href=\"#7-1-对象及-Nested-对象-md\" class=\"headerlink\" title=\"7.1-对象及 Nested 对象.md\"></a>7.1-对象及 Nested 对象.md</h1><h1 id=\"对象及Nested对象\"><a href=\"#对象及Nested对象\" class=\"headerlink\" title=\"对象及Nested对象\"></a>对象及Nested对象</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE blog</span><br><span class=\"line\"># 设置blog的 Mapping</span><br><span class=\"line\">PUT /blog</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;time&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;date&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;user&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;city&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;text&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;userid&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;long&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;username&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 插入一条 Blog 信息</span><br><span class=\"line\">PUT blog/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;I like Elasticsearch&quot;,</span><br><span class=\"line\">  &quot;time&quot;:&quot;2019-01-01T00:00:00&quot;,</span><br><span class=\"line\">  &quot;user&quot;:&#123;</span><br><span class=\"line\">    &quot;userid&quot;:1,</span><br><span class=\"line\">    &quot;username&quot;:&quot;Jack&quot;,</span><br><span class=\"line\">    &quot;city&quot;:&quot;Shanghai&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 查询 Blog 信息</span><br><span class=\"line\">POST blog/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;content&quot;: &quot;Elasticsearch&quot;&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;user.username&quot;: &quot;Jack&quot;&#125;&#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_movies</span><br><span class=\"line\"></span><br><span class=\"line\"># 电影的Mapping信息</span><br><span class=\"line\">PUT my_movies</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;actors&quot; : &#123;</span><br><span class=\"line\">          &quot;properties&quot; : &#123;</span><br><span class=\"line\">            &quot;first_name&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;last_name&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;title&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 256</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 写入一条电影信息</span><br><span class=\"line\">POST my_movies/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Speed&quot;,</span><br><span class=\"line\">  &quot;actors&quot;:[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;first_name&quot;:&quot;Keanu&quot;,</span><br><span class=\"line\">      &quot;last_name&quot;:&quot;Reeves&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;first_name&quot;:&quot;Dennis&quot;,</span><br><span class=\"line\">      &quot;last_name&quot;:&quot;Hopper&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 查询电影信息</span><br><span class=\"line\">POST my_movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;actors.first_name&quot;: &quot;Keanu&quot;&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;actors.last_name&quot;: &quot;Hopper&quot;&#125;&#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_movies</span><br><span class=\"line\"># 创建 Nested 对象 Mapping</span><br><span class=\"line\">PUT my_movies</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;actors&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot;: &quot;nested&quot;,</span><br><span class=\"line\">          &quot;properties&quot; : &#123;</span><br><span class=\"line\">            &quot;first_name&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;,</span><br><span class=\"line\">            &quot;last_name&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;</span><br><span class=\"line\">          &#125;&#125;,</span><br><span class=\"line\">        &quot;title&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;&quot;keyword&quot;:&#123;&quot;type&quot;:&quot;keyword&quot;,&quot;ignore_above&quot;:256&#125;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST my_movies/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Speed&quot;,</span><br><span class=\"line\">  &quot;actors&quot;:[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;first_name&quot;:&quot;Keanu&quot;,</span><br><span class=\"line\">      &quot;last_name&quot;:&quot;Reeves&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;first_name&quot;:&quot;Dennis&quot;,</span><br><span class=\"line\">      &quot;last_name&quot;:&quot;Hopper&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Nested 查询</span><br><span class=\"line\">POST my_movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;title&quot;: &quot;Speed&quot;&#125;&#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;nested&quot;: &#123;</span><br><span class=\"line\">            &quot;path&quot;: &quot;actors&quot;,</span><br><span class=\"line\">            &quot;query&quot;: &#123;</span><br><span class=\"line\">              &quot;bool&quot;: &#123;</span><br><span class=\"line\">                &quot;must&quot;: [</span><br><span class=\"line\">                  &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">                    &quot;actors.first_name&quot;: &quot;Keanu&quot;</span><br><span class=\"line\">                  &#125;&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">                  &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">                    &quot;actors.last_name&quot;: &quot;Hopper&quot;</span><br><span class=\"line\">                  &#125;&#125;</span><br><span class=\"line\">                ]</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Nested Aggregation</span><br><span class=\"line\">POST my_movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;actors&quot;: &#123;</span><br><span class=\"line\">      &quot;nested&quot;: &#123;</span><br><span class=\"line\">        &quot;path&quot;: &quot;actors&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;actor_name&quot;: &#123;</span><br><span class=\"line\">          &quot;terms&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;actors.first_name&quot;,</span><br><span class=\"line\">            &quot;size&quot;: 10</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 普通 aggregation不工作</span><br><span class=\"line\">POST my_movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;NAME&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;actors.first_name&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-2-文档的父子关系-md\"><a href=\"#7-2-文档的父子关系-md\" class=\"headerlink\" title=\"7.2-文档的父子关系.md\"></a>7.2-文档的父子关系.md</h1><h1 id=\"文档的父子关系\"><a href=\"#文档的父子关系\" class=\"headerlink\" title=\"文档的父子关系\"></a>文档的父子关系</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE my_blogs</span><br><span class=\"line\"></span><br><span class=\"line\"># 设定 Parent/Child Mapping</span><br><span class=\"line\">PUT my_blogs</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 2</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;blog_comments_relation&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;join&quot;,</span><br><span class=\"line\">        &quot;relations&quot;: &#123;</span><br><span class=\"line\">          &quot;blog&quot;: &quot;comment&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;title&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#索引父文档</span><br><span class=\"line\">PUT my_blogs/_doc/blog1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Learning Elasticsearch&quot;,</span><br><span class=\"line\">  &quot;content&quot;:&quot;learning ELK @ geektime&quot;,</span><br><span class=\"line\">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;blog&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#索引父文档</span><br><span class=\"line\">PUT my_blogs/_doc/blog2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Learning Hadoop&quot;,</span><br><span class=\"line\">  &quot;content&quot;:&quot;learning Hadoop&quot;,</span><br><span class=\"line\">    &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;blog&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#索引子文档</span><br><span class=\"line\">PUT my_blogs/_doc/comment1?routing=blog1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;I am learning ELK&quot;,</span><br><span class=\"line\">  &quot;username&quot;:&quot;Jack&quot;,</span><br><span class=\"line\">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class=\"line\">    &quot;parent&quot;:&quot;blog1&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#索引子文档</span><br><span class=\"line\">PUT my_blogs/_doc/comment2?routing=blog2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;I like Hadoop!!!!!&quot;,</span><br><span class=\"line\">  &quot;username&quot;:&quot;Jack&quot;,</span><br><span class=\"line\">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class=\"line\">    &quot;parent&quot;:&quot;blog2&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#索引子文档</span><br><span class=\"line\">PUT my_blogs/_doc/comment3?routing=blog2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;Hello Hadoop&quot;,</span><br><span class=\"line\">  &quot;username&quot;:&quot;Bob&quot;,</span><br><span class=\"line\">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class=\"line\">    &quot;parent&quot;:&quot;blog2&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 查询所有文档</span><br><span class=\"line\">POST my_blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#根据父文档ID查看</span><br><span class=\"line\">GET my_blogs/_doc/blog2</span><br><span class=\"line\"></span><br><span class=\"line\"># Parent Id 查询</span><br><span class=\"line\">POST my_blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;parent_id&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;comment&quot;,</span><br><span class=\"line\">      &quot;id&quot;: &quot;blog2&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Has Child 查询,返回父文档</span><br><span class=\"line\">POST my_blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;has_child&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;comment&quot;,</span><br><span class=\"line\">      &quot;query&quot; : &#123;</span><br><span class=\"line\">                &quot;match&quot;: &#123;</span><br><span class=\"line\">                    &quot;username&quot; : &quot;Jack&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Has Parent 查询，返回相关的子文档</span><br><span class=\"line\">POST my_blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;has_parent&quot;: &#123;</span><br><span class=\"line\">      &quot;parent_type&quot;: &quot;blog&quot;,</span><br><span class=\"line\">      &quot;query&quot; : &#123;</span><br><span class=\"line\">                &quot;match&quot;: &#123;</span><br><span class=\"line\">                    &quot;title&quot; : &quot;Learning Hadoop&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#通过ID ，访问子文档</span><br><span class=\"line\">GET my_blogs/_doc/comment3</span><br><span class=\"line\">#通过ID和routing ，访问子文档</span><br><span class=\"line\">GET my_blogs/_doc/comment3?routing=blog2</span><br><span class=\"line\"></span><br><span class=\"line\">#更新子文档</span><br><span class=\"line\">PUT my_blogs/_doc/comment3?routing=blog2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;comment&quot;: &quot;Hello Hadoop??&quot;,</span><br><span class=\"line\">    &quot;blog_comments_relation&quot;: &#123;</span><br><span class=\"line\">      &quot;name&quot;: &quot;comment&quot;,</span><br><span class=\"line\">      &quot;parent&quot;: &quot;blog2&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-5-Elasticsearch数据建模实例-md\"><a href=\"#7-5-Elasticsearch数据建模实例-md\" class=\"headerlink\" title=\"7.5-Elasticsearch数据建模实例.md\"></a>7.5-Elasticsearch数据建模实例.md</h1><h1 id=\"Elasticsearch-数据建模实例\"><a href=\"#Elasticsearch-数据建模实例\" class=\"headerlink\" title=\"Elasticsearch 数据建模实例\"></a>Elasticsearch 数据建模实例</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">###### Data Modeling Example</span><br><span class=\"line\"></span><br><span class=\"line\"># Index 一本书的信息</span><br><span class=\"line\">PUT books/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Mastering ElasticSearch 5.0&quot;,</span><br><span class=\"line\">  &quot;description&quot;:&quot;Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins&quot;,</span><br><span class=\"line\">  &quot;author&quot;:&quot;Bharvi Dixit&quot;,</span><br><span class=\"line\">  &quot;public_date&quot;:&quot;2017&quot;,</span><br><span class=\"line\">  &quot;cover_url&quot;:&quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#查询自动创建的Mapping</span><br><span class=\"line\">GET books/_mapping</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE books</span><br><span class=\"line\"></span><br><span class=\"line\">#优化字段类型</span><br><span class=\"line\">PUT books</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;author&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;,</span><br><span class=\"line\">        &quot;cover_url&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;index&quot;: false&#125;,</span><br><span class=\"line\">        &quot;description&quot; : &#123;&quot;type&quot; : &quot;text&quot;&#125;,</span><br><span class=\"line\">        &quot;public_date&quot; : &#123;&quot;type&quot; : &quot;date&quot;&#125;,</span><br><span class=\"line\">        &quot;title&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 100</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Cover URL index 设置成false，无法对该字段进行搜索</span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;cover_url&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Cover URL index 设置成false，依然支持聚合分析</span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;cover&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;cover_url&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE books</span><br><span class=\"line\">#新增 Content字段。数据量很大。选择将Source 关闭</span><br><span class=\"line\">PUT books</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;_source&quot;: &#123;&quot;enabled&quot;: false&#125;,</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;author&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">        &quot;cover_url&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;index&quot;: false,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">        &quot;description&quot; : &#123;&quot;type&quot; : &quot;text&quot;,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">         &quot;content&quot; : &#123;&quot;type&quot; : &quot;text&quot;,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">        &quot;public_date&quot; : &#123;&quot;type&quot; : &quot;date&quot;,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">        &quot;title&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 100</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;store&quot;: true</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Index 一本书的信息,包含Content</span><br><span class=\"line\">PUT books/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Mastering ElasticSearch 5.0&quot;,</span><br><span class=\"line\">  &quot;description&quot;:&quot;Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins&quot;,</span><br><span class=\"line\">  &quot;content&quot;:&quot;The content of the book......Indexing data, aggregation, searching.    something else. something in the way............&quot;,</span><br><span class=\"line\">  &quot;author&quot;:&quot;Bharvi Dixit&quot;,</span><br><span class=\"line\">  &quot;public_date&quot;:&quot;2017&quot;,</span><br><span class=\"line\">  &quot;cover_url&quot;:&quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#查询结果中，Source不包含数据</span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#搜索，通过store 字段显示数据，同时高亮显示 conent的内容</span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;stored_fields&quot;: [&quot;title&quot;,&quot;author&quot;,&quot;public_date&quot;],</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;searching&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">  &quot;highlight&quot;: &#123;</span><br><span class=\"line\">    &quot;fields&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;:&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-6-Elasticsearch-数据建模最佳实践-md\"><a href=\"#7-6-Elasticsearch-数据建模最佳实践-md\" class=\"headerlink\" title=\"7.6-Elasticsearch 数据建模最佳实践.md\"></a>7.6-Elasticsearch 数据建模最佳实践.md</h1><h1 id=\"Elasticsearch-数据建模最佳实践\"><a href=\"#Elasticsearch-数据建模最佳实践\" class=\"headerlink\" title=\"Elasticsearch 数据建模最佳实践\"></a>Elasticsearch 数据建模最佳实践</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">###### Cookie Service</span><br><span class=\"line\"></span><br><span class=\"line\">##索引数据，dynamic mapping 会不断加入新增字段</span><br><span class=\"line\">PUT cookie_service/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;url&quot;:&quot;www.google.com&quot;,</span><br><span class=\"line\"> &quot;cookies&quot;:&#123;</span><br><span class=\"line\">   &quot;username&quot;:&quot;tom&quot;,</span><br><span class=\"line\">   &quot;age&quot;:32</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT cookie_service/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;url&quot;:&quot;www.amazon.com&quot;,</span><br><span class=\"line\"> &quot;cookies&quot;:&#123;</span><br><span class=\"line\">   &quot;login&quot;:&quot;2019-01-01&quot;,</span><br><span class=\"line\">   &quot;email&quot;:&quot;xyz@abc.com&quot;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE cookie_service</span><br><span class=\"line\">#使用 Nested 对象，增加key/value</span><br><span class=\"line\">PUT cookie_service</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;cookies&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;nested&quot;,</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;name&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;dateValue&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;date&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;keywordValue&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;IntValue&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;integer&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;url&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;fields&quot;: &#123;</span><br><span class=\"line\">          &quot;keyword&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class=\"line\">            &quot;ignore_above&quot;: 256</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">##写入数据，使用key和合适类型的value字段</span><br><span class=\"line\">PUT cookie_service/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;url&quot;:&quot;www.google.com&quot;,</span><br><span class=\"line\"> &quot;cookies&quot;:[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;name&quot;:&quot;username&quot;,</span><br><span class=\"line\">      &quot;keywordValue&quot;:&quot;tom&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">       &quot;name&quot;:&quot;age&quot;,</span><br><span class=\"line\">      &quot;intValue&quot;:32</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   ]</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT cookie_service/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;url&quot;:&quot;www.amazon.com&quot;,</span><br><span class=\"line\"> &quot;cookies&quot;:[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;name&quot;:&quot;login&quot;,</span><br><span class=\"line\">      &quot;dateValue&quot;:&quot;2019-01-01&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">       &quot;name&quot;:&quot;email&quot;,</span><br><span class=\"line\">      &quot;IntValue&quot;:32</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   ]</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Nested 查询，通过bool查询进行过滤</span><br><span class=\"line\">POST cookie_service/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;nested&quot;: &#123;</span><br><span class=\"line\">      &quot;path&quot;: &quot;cookies&quot;,</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;bool&quot;: &#123;</span><br><span class=\"line\">          &quot;filter&quot;: [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">            &quot;term&quot;: &#123;</span><br><span class=\"line\">              &quot;cookies.name&quot;: &quot;age&quot;</span><br><span class=\"line\">            &#125;&#125;,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              &quot;range&quot;:&#123;</span><br><span class=\"line\">                &quot;cookies.intValue&quot;:&#123;</span><br><span class=\"line\">                  &quot;gte&quot;:30</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 在Mapping中加入元信息，便于管理</span><br><span class=\"line\">PUT softwares/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;_meta&quot;: &#123;</span><br><span class=\"line\">      &quot;software_version_mapping&quot;: &quot;1.0&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET softwares/_mapping</span><br><span class=\"line\">PUT softwares/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;software_version&quot;:&quot;7.1.0&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE softwares</span><br><span class=\"line\"># 优化,使用inner object</span><br><span class=\"line\">PUT softwares/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;_meta&quot;: &#123;</span><br><span class=\"line\">      &quot;software_version_mapping&quot;: &quot;1.1&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;version&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;display_name&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;hot_fix&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;byte&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;marjor&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;byte&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;minor&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;byte&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#通过 Inner Object 写入多个文档</span><br><span class=\"line\">PUT softwares/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;version&quot;:&#123;</span><br><span class=\"line\">  &quot;display_name&quot;:&quot;7.1.0&quot;,</span><br><span class=\"line\">  &quot;marjor&quot;:7,</span><br><span class=\"line\">  &quot;minor&quot;:1,</span><br><span class=\"line\">  &quot;hot_fix&quot;:0  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT softwares/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;version&quot;:&#123;</span><br><span class=\"line\">  &quot;display_name&quot;:&quot;7.2.0&quot;,</span><br><span class=\"line\">  &quot;marjor&quot;:7,</span><br><span class=\"line\">  &quot;minor&quot;:2,</span><br><span class=\"line\">  &quot;hot_fix&quot;:0  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT softwares/_doc/3</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;version&quot;:&#123;</span><br><span class=\"line\">  &quot;display_name&quot;:&quot;7.2.1&quot;,</span><br><span class=\"line\">  &quot;marjor&quot;:7,</span><br><span class=\"line\">  &quot;minor&quot;:2,</span><br><span class=\"line\">  &quot;hot_fix&quot;:1  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 通过 bool 查询，</span><br><span class=\"line\">POST softwares/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;match&quot;:&#123;</span><br><span class=\"line\">            &quot;version.marjor&quot;:7</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;match&quot;:&#123;</span><br><span class=\"line\">            &quot;version.minor&quot;:2</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Not Null 解决聚合的问题</span><br><span class=\"line\">DELETE ratings</span><br><span class=\"line\">PUT ratings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">      &quot;properties&quot;: &#123;</span><br><span class=\"line\">        &quot;rating&quot;: &#123;</span><br><span class=\"line\">          &quot;type&quot;: &quot;float&quot;,</span><br><span class=\"line\">          &quot;null_value&quot;: 1.0</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT ratings/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;rating&quot;:5</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">PUT ratings/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;rating&quot;:null</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST ratings/_search</span><br><span class=\"line\">POST ratings/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;avg&quot;: &#123;</span><br><span class=\"line\">      &quot;avg&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;rating&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST ratings/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;rating&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: 1</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"7-7-第二部分总结与测验-md\"><a href=\"#7-7-第二部分总结与测验-md\" class=\"headerlink\" title=\"7.7-第二部分总结与测验.md\"></a>7.7-第二部分总结与测验.md</h1><h1 id=\"第二部分总结与测验\"><a href=\"#第二部分总结与测验\" class=\"headerlink\" title=\"第二部分总结与测验\"></a>第二部分总结与测验</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE test</span><br><span class=\"line\">PUT test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;Hello World&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;Hello World&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;hello world&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content.keyword&quot;: &quot;Hello World&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content.keyword&quot;: &quot;hello world&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;Hello World&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;hello world&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content.keyword&quot;: &quot;Hello World&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"8-1-集群身份认证与用户鉴权-md\"><a href=\"#8-1-集群身份认证与用户鉴权-md\" class=\"headerlink\" title=\"8.1-集群身份认证与用户鉴权.md\"></a>8.1-集群身份认证与用户鉴权.md</h1><h1 id=\"集群身份认证与用户鉴权\"><a href=\"#集群身份认证与用户鉴权\" class=\"headerlink\" title=\"集群身份认证与用户鉴权\"></a>集群身份认证与用户鉴权</h1><ul>\n<li>如何为集群启用X-Pack Security</li>\n<li>如何为内置用户设置密码</li>\n<li>设置 Kibana与ElasticSearch通信鉴权</li>\n<li>使用安全API创建对特定索引具有有限访问权限的用户</li>\n</ul>\n<p>This tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:</p>\n<p>discovery.type: single-node</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#启动单节点</span><br><span class=\"line\">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true</span><br><span class=\"line\"></span><br><span class=\"line\">#使用Curl访问ES，或者浏览器访问 “localhost:9200/_cat/nodes?pretty”。返回401错误</span><br><span class=\"line\">curl &#x27;localhost:9200/_cat/nodes?pretty&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">#运行密码设定的命令，设置ES内置用户及其初始密码。</span><br><span class=\"line\">bin/elasticsearch-setup-passwords interactive</span><br><span class=\"line\"></span><br><span class=\"line\">curl -u elastic &#x27;localhost:9200/_cat/nodes?pretty&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 修改 kibana.yml</span><br><span class=\"line\">elasticsearch.username: &quot;kibana&quot;</span><br><span class=\"line\">elasticsearch.password: &quot;changeme&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#启动。使用用户名，elastic，密码elastic</span><br><span class=\"line\">./bin/kibana</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST orders/_bulk</span><br><span class=\"line\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class=\"line\">&#123;&quot;product&quot; : &quot;1&quot;,&quot;price&quot; : 18,&quot;payment&quot; : &quot;master&quot;,&quot;card&quot; : &quot;9876543210123456&quot;,&quot;name&quot; : &quot;jack&quot;&#125;</span><br><span class=\"line\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class=\"line\">&#123;&quot;product&quot; : &quot;2&quot;,&quot;price&quot; : 99,&quot;payment&quot; : &quot;visa&quot;,&quot;card&quot; : &quot;1234567890123456&quot;,&quot;name&quot; : &quot;bob&quot;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#create a new role named read_only_orders, that satisfies the following criteria:</span><br><span class=\"line\">#The role has no cluster privileges</span><br><span class=\"line\">#The role only has access to indices that match the pattern sales_record</span><br><span class=\"line\">#The index privileges are read, and view_index_metadata</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#create sales_user that satisfies the following criteria:</span><br><span class=\"line\"># Use your own email address</span><br><span class=\"line\"># Assign the user to two roles: read_only_orders and kibana_user</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#验证读权限,可以执行</span><br><span class=\"line\">POST orders/_search</span><br><span class=\"line\">&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#验证写权限,报错</span><br><span class=\"line\">POST orders/_bulk</span><br><span class=\"line\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class=\"line\">&#123;&quot;product&quot; : &quot;1&quot;,&quot;price&quot; : 18,&quot;payment&quot; : &quot;master&quot;,&quot;card&quot; : &quot;9876543210123456&quot;,&quot;name&quot; : &quot;jack&quot;&#125;</span><br><span class=\"line\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class=\"line\">&#123;&quot;product&quot; : &quot;2&quot;,&quot;price&quot; : 99,&quot;payment&quot; : &quot;visa&quot;,&quot;card&quot; : &quot;1234567890123456&quot;,&quot;name&quot; : &quot;bob&quot;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"8-2-集群内部安全通信-md\"><a href=\"#8-2-集群内部安全通信-md\" class=\"headerlink\" title=\"8.2-集群内部安全通信.md\"></a>8.2-集群内部安全通信.md</h1><h1 id=\"-3\"><a href=\"#-3\" class=\"headerlink\" title=\"\"></a></h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 生成证书</span><br><span class=\"line\"># 为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：</span><br><span class=\"line\">bin/elasticsearch-certutil ca</span><br><span class=\"line\"></span><br><span class=\"line\">#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：</span><br><span class=\"line\">bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br><span class=\"line\"></span><br><span class=\"line\">#将证书拷贝到 config/certs目录下</span><br><span class=\"line\">elastic-certificates.p12</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br><span class=\"line\">bin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#不提供证书的节点，无法加入</span><br><span class=\"line\">bin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E http.port=9202 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## elasticsearch.yml 配置</span><br><span class=\"line\"></span><br><span class=\"line\">#xpack.security.transport.ssl.enabled: true</span><br><span class=\"line\">#xpack.security.transport.ssl.verification_mode: certificate</span><br><span class=\"line\"></span><br><span class=\"line\">#xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12</span><br><span class=\"line\">#xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"8-3-集群与外部间的安全通信-md\"><a href=\"#8-3-集群与外部间的安全通信-md\" class=\"headerlink\" title=\"8.3-集群与外部间的安全通信.md\"></a>8.3-集群与外部间的安全通信.md</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xpack.security.http.ssl.enabled: true</span><br><span class=\"line\">xpack.security.http.ssl.keystore.path: certs/elastic-certificates.p12</span><br><span class=\"line\">xpack.security.http.ssl.truststore.path: certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># ES 启用 https</span><br><span class=\"line\">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Kibana 连接 ES https</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 为kibana生成pem</span><br><span class=\"line\">openssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">elasticsearch.hosts: [&quot;https://localhost:9200&quot;]</span><br><span class=\"line\">elasticsearch.ssl.certificateAuthorities: [ &quot;/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem&quot; ]</span><br><span class=\"line\">elasticsearch.ssl.verificationMode: certificate</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 为 Kibna 配置 HTTPS</span><br><span class=\"line\"># 生成后解压，包含了instance.crt 和 instance.key</span><br><span class=\"line\">bin/elasticsearch-certutil ca --pem</span><br><span class=\"line\"></span><br><span class=\"line\">server.ssl.enabled: true</span><br><span class=\"line\">server.ssl.certificate: config/certs/instance.crt</span><br><span class=\"line\">server.ssl.key: config/certs/instance.key</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"9-1-常见的集群部署方式-md-1\"><a href=\"#9-1-常见的集群部署方式-md-1\" class=\"headerlink\" title=\"9.1-常见的集群部署方式.md\"></a>9.1-常见的集群部署方式.md</h1><h1 id=\"常见的集群部署方式-1\"><a href=\"#常见的集群部署方式-1\" class=\"headerlink\" title=\"常见的集群部署方式\"></a>常见的集群部署方式</h1><h1 id=\"9-2-Hot-Warm架构与ShardFiltering-md-1\"><a href=\"#9-2-Hot-Warm架构与ShardFiltering-md-1\" class=\"headerlink\" title=\"9.2-Hot&amp;Warm架构与ShardFiltering.md\"></a>9.2-Hot&amp;Warm架构与ShardFiltering.md</h1><h1 id=\"Hot-Warm-架构与-Shard-Filtering-1\"><a href=\"#Hot-Warm-架构与-Shard-Filtering-1\" class=\"headerlink\" title=\"Hot &amp; Warm 架构与 Shard Filtering\"></a>Hot &amp; Warm 架构与 Shard Filtering</h1><h2 id=\"课程代码-1\"><a href=\"#课程代码-1\" class=\"headerlink\" title=\"课程代码\"></a>课程代码</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 标记一个 Hot 节点</span><br><span class=\"line\">bin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 warm 节点</span><br><span class=\"line\">bin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看节点</span><br><span class=\"line\">GET /_cat/nodeattrs?v</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置到 Hot节点</span><br><span class=\"line\">PUT logs-2019-06-27</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:0,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.my_node_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 配置到 warm 节点</span><br><span class=\"line\">PUT PUT logs-2019-06-27/_settings</span><br><span class=\"line\">&#123;  </span><br><span class=\"line\">  &quot;index.routing.allocation.require.my_node_type&quot;:&quot;warm&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 1</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 2</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2</span><br><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\">DELETE my_index1/_doc/1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Fore awareness</span><br><span class=\"line\"># 标记一个 rack 1</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 2</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;,</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.force.my_rack_id.values&quot;: &quot;rack1,rack2&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">GET _cluster/settings</span><br><span class=\"line\"></span><br><span class=\"line\"># 集群黄色</span><br><span class=\"line\">GET _cluster/health</span><br><span class=\"line\"></span><br><span class=\"line\"># 副本无法分配</span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cluster/allocation/explain?pretty</span><br></pre></td></tr></table></figure>\n","cover":false,"excerpt":"","more":"<p>以下是优化过的笔记，已加入注释并调整格式，使其更符合Markdown标准：</p>\n<hr>\n<h1 id=\"Elasticsearch-集群管理与优化笔记\"><a href=\"#Elasticsearch-集群管理与优化笔记\" class=\"headerlink\" title=\"Elasticsearch 集群管理与优化笔记\"></a>Elasticsearch 集群管理与优化笔记</h1><h2 id=\"1-移动分片到另一个节点\"><a href=\"#1-移动分片到另一个节点\" class=\"headerlink\" title=\"1. 移动分片到另一个节点\"></a>1. 移动分片到另一个节点</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _cluster/reroute</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;commands&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;move&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;index&quot;</span>: <span class=\"string\">&quot;index_name&quot;</span>,   <span class=\"comment\"># 索引名称</span></span><br><span class=\"line\">        <span class=\"string\">&quot;shard&quot;</span>: 0,               <span class=\"comment\"># 分片编号</span></span><br><span class=\"line\">        <span class=\"string\">&quot;from_node&quot;</span>: <span class=\"string\">&quot;node_name_1&quot;</span>, <span class=\"comment\"># 源节点</span></span><br><span class=\"line\">        <span class=\"string\">&quot;to_node&quot;</span>: <span class=\"string\">&quot;node_name_2&quot;</span>   <span class=\"comment\"># 目标节点</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-强制分配未分配的分片（带原因说明）\"><a href=\"#2-强制分配未分配的分片（带原因说明）\" class=\"headerlink\" title=\"2. 强制分配未分配的分片（带原因说明）\"></a>2. 强制分配未分配的分片（带原因说明）</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _cluster/reroute?explain</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;commands&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;allocate&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;index&quot;</span>: <span class=\"string\">&quot;index_name&quot;</span>,   <span class=\"comment\"># 索引名称</span></span><br><span class=\"line\">        <span class=\"string\">&quot;shard&quot;</span>: 0,              <span class=\"comment\"># 分片编号</span></span><br><span class=\"line\">        <span class=\"string\">&quot;node&quot;</span>: <span class=\"string\">&quot;nodename&quot;</span>       <span class=\"comment\"># 目标节点</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-从集群中移除节点\"><a href=\"#3-从集群中移除节点\" class=\"headerlink\" title=\"3. 从集群中移除节点\"></a>3. 从集群中移除节点</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cluster.routing.allocation.exclude._ip&quot;</span>: <span class=\"string\">&quot;the_IP_of_your_node&quot;</span>   <span class=\"comment\"># 要排除的节点IP</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-强制执行同步刷新\"><a href=\"#4-强制执行同步刷新\" class=\"headerlink\" title=\"4. 强制执行同步刷新\"></a>4. 强制执行同步刷新</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _flush/synced</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-调整集群平衡时移动的分片数量\"><a href=\"#5-调整集群平衡时移动的分片数量\" class=\"headerlink\" title=\"5. 调整集群平衡时移动的分片数量\"></a>5. 调整集群平衡时移动的分片数量</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cluster.routing.allocation.cluster_concurrent_rebalance&quot;</span>: 2   <span class=\"comment\"># 同时平衡的分片数</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-调整每个节点同时恢复的分片数量\"><a href=\"#6-调整每个节点同时恢复的分片数量\" class=\"headerlink\" title=\"6. 调整每个节点同时恢复的分片数量\"></a>6. 调整每个节点同时恢复的分片数量</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cluster.routing.allocation.node_concurrent_recoveries&quot;</span>: 5   <span class=\"comment\"># 每个节点并行恢复的分片数</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"7-调整恢复速度\"><a href=\"#7-调整恢复速度\" class=\"headerlink\" title=\"7. 调整恢复速度\"></a>7. 调整恢复速度</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;indices.recovery.max_bytes_per_sec&quot;</span>: <span class=\"string\">&quot;80mb&quot;</span>   <span class=\"comment\"># 恢复速率</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"8-调整单节点恢复时并发流数量\"><a href=\"#8-调整单节点恢复时并发流数量\" class=\"headerlink\" title=\"8. 调整单节点恢复时并发流数量\"></a>8. 调整单节点恢复时并发流数量</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;indices.recovery.concurrent_streams&quot;</span>: 6   <span class=\"comment\"># 单节点恢复时的并发流数</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"9-调整搜索队列大小\"><a href=\"#9-调整搜索队列大小\" class=\"headerlink\" title=\"9. 调整搜索队列大小\"></a>9. 调整搜索队列大小</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;transient&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;threadpool.search.queue_size&quot;</span>: 2000   <span class=\"comment\"># 搜索队列大小</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"10-清除节点缓存\"><a href=\"#10-清除节点缓存\" class=\"headerlink\" title=\"10. 清除节点缓存\"></a>10. 清除节点缓存</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _cache/clear</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"11-调整断路器配置\"><a href=\"#11-调整断路器配置\" class=\"headerlink\" title=\"11. 调整断路器配置\"></a>11. 调整断路器配置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;persistent&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;indices.breaker.total.limit&quot;</span>: <span class=\"string\">&quot;40%&quot;</span>   <span class=\"comment\"># 设置内存断路器的总内存限制</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"监控-Elasticsearch-集群\"><a href=\"#监控-Elasticsearch-集群\" class=\"headerlink\" title=\"监控 Elasticsearch 集群\"></a>监控 Elasticsearch 集群</h1><h2 id=\"1-节点统计\"><a href=\"#1-节点统计\" class=\"headerlink\" title=\"1. 节点统计\"></a>1. 节点统计</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _nodes/stats</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-集群统计\"><a href=\"#2-集群统计\" class=\"headerlink\" title=\"2. 集群统计\"></a>2. 集群统计</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/stats</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-索引统计\"><a href=\"#3-索引统计\" class=\"headerlink\" title=\"3. 索引统计\"></a>3. 索引统计</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET kibana_sample_data_ecommerce/_stats</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-查看待处理的集群任务\"><a href=\"#4-查看待处理的集群任务\" class=\"headerlink\" title=\"4. 查看待处理的集群任务\"></a>4. 查看待处理的集群任务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/pending_tasks</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-查看所有任务，支持取消任务\"><a href=\"#5-查看所有任务，支持取消任务\" class=\"headerlink\" title=\"5. 查看所有任务，支持取消任务\"></a>5. 查看所有任务，支持取消任务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _tasks</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-查看节点的线程池信息\"><a href=\"#6-查看节点的线程池信息\" class=\"headerlink\" title=\"6. 查看节点的线程池信息\"></a>6. 查看节点的线程池信息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _nodes/thread_pool</span><br><span class=\"line\">GET _nodes/stats/thread_pool</span><br><span class=\"line\">GET _cat/thread_pool?v</span><br><span class=\"line\">GET _nodes/hot_threads</span><br><span class=\"line\">GET _nodes/stats/thread_pool</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"7-设置索引慢日志（Slowlog）\"><a href=\"#7-设置索引慢日志（Slowlog）\" class=\"headerlink\" title=\"7. 设置索引慢日志（Slowlog）\"></a>7. 设置索引慢日志（Slowlog）</h2><ul>\n<li><p>设置索引慢日志阈值：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT my_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;index.indexing.slowlog&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;threshold.index&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;warn&quot;</span>: <span class=\"string\">&quot;10s&quot;</span>,    <span class=\"comment\"># 警告级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;info&quot;</span>: <span class=\"string\">&quot;4s&quot;</span>,     <span class=\"comment\"># 信息级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;debug&quot;</span>: <span class=\"string\">&quot;2s&quot;</span>,    <span class=\"comment\"># 调试级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;trace&quot;</span>: <span class=\"string\">&quot;0s&quot;</span>     <span class=\"comment\"># 跟踪级别</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;level&quot;</span>: <span class=\"string\">&quot;trace&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;source&quot;</span>: 1000   <span class=\"comment\"># 日志源的最大字符数</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置查询慢日志：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE my_index</span><br><span class=\"line\">PUT my_index/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index.search.slowlog.threshold&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;query.warn&quot;</span>: <span class=\"string\">&quot;10s&quot;</span>,   <span class=\"comment\"># 查询慢日志警告级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;query.info&quot;</span>: <span class=\"string\">&quot;3s&quot;</span>,    <span class=\"comment\"># 查询慢日志信息级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;query.debug&quot;</span>: <span class=\"string\">&quot;2s&quot;</span>,   <span class=\"comment\"># 查询慢日志调试级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;query.trace&quot;</span>: <span class=\"string\">&quot;0s&quot;</span>,   <span class=\"comment\"># 查询慢日志跟踪级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;fetch.warn&quot;</span>: <span class=\"string\">&quot;1s&quot;</span>,    <span class=\"comment\"># 获取慢日志警告级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;fetch.info&quot;</span>: <span class=\"string\">&quot;600ms&quot;</span>, <span class=\"comment\"># 获取慢日志信息级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;fetch.debug&quot;</span>: <span class=\"string\">&quot;400ms&quot;</span>,<span class=\"comment\"># 获取慢日志调试级别</span></span><br><span class=\"line\">      <span class=\"string\">&quot;fetch.trace&quot;</span>: <span class=\"string\">&quot;0s&quot;</span>    <span class=\"comment\"># 获取慢日志跟踪级别</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<hr>\n<h1 id=\"解决集群-Yellow-与-Red-状态问题\"><a href=\"#解决集群-Yellow-与-Red-状态问题\" class=\"headerlink\" title=\"解决集群 Yellow 与 Red 状态问题\"></a>解决集群 Yellow 与 Red 状态问题</h1><h2 id=\"1-检查集群健康状态\"><a href=\"#1-检查集群健康状态\" class=\"headerlink\" title=\"1. 检查集群健康状态\"></a>1. 检查集群健康状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/health/</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-查看索引级别健康状态，找出红色索引\"><a href=\"#2-查看索引级别健康状态，找出红色索引\" class=\"headerlink\" title=\"2. 查看索引级别健康状态，找出红色索引\"></a>2. 查看索引级别健康状态，找出红色索引</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/health?level=indices</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-查看分片级别健康状态\"><a href=\"#3-查看分片级别健康状态\" class=\"headerlink\" title=\"3. 查看分片级别健康状态\"></a>3. 查看分片级别健康状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cluster/health?level=shards</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-解释索引分片无法分配的原因\"><a href=\"#4-解释索引分片无法分配的原因\" class=\"headerlink\" title=\"4. 解释索引分片无法分配的原因\"></a>4. 解释索引分片无法分配的原因</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_cluster/allocation/explain</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-删除并重新创建索引\"><a href=\"#5-删除并重新创建索引\" class=\"headerlink\" title=\"5. 删除并重新创建索引\"></a>5. 删除并重新创建索引</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE mytest</span><br><span class=\"line\">PUT mytest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_shards&quot;</span>: 3,    <span class=\"comment\"># 分片数</span></span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 0,   <span class=\"comment\"># 副本数</span></span><br><span class=\"line\">    <span class=\"string\">&quot;index.routing.allocation.require.box_type&quot;</span>: <span class=\"string\">&quot;hot&quot;</span>   <span class=\"comment\"># 指定节点类型</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"提升集群写性能\"><a href=\"#提升集群写性能\" class=\"headerlink\" title=\"提升集群写性能\"></a>提升集群写性能</h1><h2 id=\"1-设置优化写入性能的索引设置\"><a href=\"#1-设置优化写入性能的索引设置\" class=\"headerlink\" title=\"1. 设置优化写入性能的索引设置\"></a>1. 设置优化写入性能的索引设置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE myindex</span><br><span class=\"line\">PUT myindex</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;refresh_interval&quot;</span>: <span class=\"string\">&quot;30s&quot;</span>,     <span class=\"comment\"># 刷新间隔</span></span><br><span class=\"line\">      <span class=\"string\">&quot;number_of_shards&quot;</span>: <span class=\"string\">&quot;2&quot;</span>        <span class=\"comment\"># 分片数</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;routing&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;allocation&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;total_shards_per_node&quot;</span>: <span class=\"string\">&quot;3&quot;</span> <span class=\"comment\"># 每个节点的最大分片数</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;translog&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;sync_interval&quot;</span>: <span class=\"string\">&quot;30s&quot;</span>,         <span class=\"comment\"># 事务日志同步间隔</span></span><br><span class=\"line\">      <span class=\"string\">&quot;durability&quot;</span>: <span class=\"string\">&quot;async&quot;</span>           <span class=\"comment\"># 异步持久化</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 0          <span class=\"comment\"># 副本数</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;dynamic&quot;</span>: <span class=\"literal\">false</span>,                <span class=\"comment\"># 禁用动态映射</span></span><br><span class=\"line\">    <span class=\"string\">&quot;properties&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"提升集群读性能\"><a href=\"#提升集群读性能\" class=\"headerlink\" title=\"提升集群读性能\"></a>提升集群读性能</h1><h2 id=\"1-示例：查询优化\"><a href=\"#1-示例：查询优化\" class=\"headerlink\" title=\"1. 示例：查询优化\"></a>1. 示例：查询优化</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT blogs/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;title&quot;</span>: <span class=\"string\">&quot;elasticsearch&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;bool&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;must&quot;</span>: [</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;match&quot;</span>: &#123; <span class=\"string\">&quot;title&quot;</span>: <span class=\"string\">&quot;elasticsearch&quot;</span> &#125;&#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      <span class=\"string\">&quot;filter&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;script&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;script&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;source&quot;</span>: <span class=\"string\">&quot;doc[&#x27;title.keyword&#x27;].value.length()&gt;5&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;bool&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;must&quot;</span>: [</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;match&quot;</span>: &#123;<span class=\"string\">&quot;title&quot;</span>: <span class=\"string\">&quot;elasticsearch&quot;</span>&#125;&#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;range&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;publish_date&quot;</span>: &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;gte&quot;</span>: 2017,</span><br><span class=\"line\">              <span class=\"string\">&quot;lte&quot;</span>: 2019</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"集群压力测试\"><a href=\"#集群压力测试\" class=\"headerlink\" title=\"集群压力测试\"></a>集群压力测试</h1><h2 id=\"1-安装并配置-esrally\"><a href=\"#1-安装并配置-esrally\" class=\"headerlink\" title=\"1. 安装并配置 esrally\"></a>1. 安装并配置 esrally</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip3 install esrally</span><br><span class=\"line\">esrally configure</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-执行简单的压力测试\"><a href=\"#2-执行简单的压力测试\" class=\"headerlink\" title=\"2. 执行简单的压力测试\"></a>2. 执行简单的压力测试</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">esrally --distribution-version=7.1.0 --test-mode</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-执行完整数据测试\"><a href=\"#3-执行完整数据测试\" class=\"headerlink\" title=\"3. 执行完整数据测试\"></a>3. 执行完整数据测试</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">esrally --distribution-version=7.1.0</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"使用缓存与-Breaker-限制内存使用\"><a href=\"#使用缓存与-Breaker-限制内存使用\" class=\"headerlink\" title=\"使用缓存与 Breaker 限制内存使用\"></a>使用缓存与 Breaker 限制内存使用</h1><h2 id=\"1-获取节点统计信息\"><a href=\"#1-获取节点统计信息\" class=\"headerlink\" title=\"1. 获取节点统计信息\"></a>1. 获取节点统计信息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cat/nodes?v</span><br><span class=\"line\">GET _nodes/stats/indices?pretty</span><br><span class=\"line\">GET _cat/nodes?v&amp;h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-设置内存限制\"><a href=\"#2-设置内存限制\" class=\"headerlink\" title=\"2. 设置内存限制\"></a>2. 设置内存限制</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;persistent&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;indices.breaker.request.limit&quot;</span>: <span class=\"string\">&quot;90%&quot;</span>   <span class=\"comment\"># 设置请求断路器内存限制</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h1 id=\"使用-Shrink-与-Rollover-API-管理索引\"><a href=\"#使用-Shrink-与-Rollover-API-管理索引\" class=\"headerlink\" title=\"使用 Shrink 与 Rollover API 管理索引\"></a>使用 Shrink 与 Rollover API 管理索引</h1><h2 id=\"1-Shrink-索引\"><a href=\"#1-Shrink-索引\" class=\"headerlink\" title=\"1. Shrink 索引\"></a>1. Shrink 索引</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index.number_of_replicas&quot;</span>: 0,</span><br><span class=\"line\">    <span class=\"string\">&quot;index.number_of_shards&quot;</span>: 2,</span><br><span class=\"line\">    <span class=\"string\">&quot;index.codec&quot;</span>: <span class=\"string\">&quot;best_compression&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aliases&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;my_search_indices&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Rollover-索引\"><a href=\"#2-Rollover-索引\" class=\"headerlink\" title=\"2. Rollover 索引\"></a>2. Rollover 索引</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST nginx_logs_write/_rollover</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;conditions&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;max_age&quot;</span>: <span class=\"string\">&quot;1d&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_docs&quot;</span>: 5,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_size&quot;</span>: <span class=\"string\">&quot;5gb&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 11.2-索引全生命周期管理及工具介绍.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 索引全生命周期管理及工具介绍</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"运行三个节点，分片-将box-type设置成-hot，warm和cold\"><a href=\"#运行三个节点，分片-将box-type设置成-hot，warm和cold\" class=\"headerlink\" title=\"运行三个节点，分片 将box_type设置成 hot，warm和cold\"></a>运行三个节点，分片 将box_type设置成 hot，warm和cold</h1><h1 id=\"具体参考-github下，docker-hot-warm-cold-下的docker-compose-文件\"><a href=\"#具体参考-github下，docker-hot-warm-cold-下的docker-compose-文件\" class=\"headerlink\" title=\"具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件\"></a>具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件</h1><p>DELETE *</p>\n<h1 id=\"设置-1秒刷新1次，生产环境10分种刷新一次\"><a href=\"#设置-1秒刷新1次，生产环境10分种刷新一次\" class=\"headerlink\" title=\"设置 1秒刷新1次，生产环境10分种刷新一次\"></a>设置 1秒刷新1次，生产环境10分种刷新一次</h1><p>PUT _cluster&#x2F;settings<br>{<br>  “persistent”: {<br>    “indices.lifecycle.poll_interval”:”1s”<br>  }<br>}</p>\n<h1 id=\"设置-Policy\"><a href=\"#设置-Policy\" class=\"headerlink\" title=\"设置 Policy\"></a>设置 Policy</h1><p>PUT &#x2F;_ilm&#x2F;policy&#x2F;log_ilm_policy<br>{<br>  “policy”: {<br>    “phases”: {<br>      “hot”: {<br>        “actions”: {<br>          “rollover”: {<br>            “max_docs”: 5<br>          }<br>        }<br>      },<br>      “warm”: {<br>        “min_age”: “10s”,<br>        “actions”: {<br>          “allocate”: {<br>            “include”: {<br>              “box_type”: “warm”<br>            }<br>          }<br>        }<br>      },<br>      “cold”: {<br>        “min_age”: “15s”,<br>        “actions”: {<br>          “allocate”: {<br>            “include”: {<br>              “box_type”: “cold”<br>            }<br>          }<br>        }<br>      },<br>      “delete”: {<br>        “min_age”: “20s”,<br>        “actions”: {<br>          “delete”: {}<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"设置索引模版\"><a href=\"#设置索引模版\" class=\"headerlink\" title=\"设置索引模版\"></a>设置索引模版</h1><p>PUT &#x2F;_template&#x2F;log_ilm_template<br>{<br>  “index_patterns” : [<br>      “ilm_index-*”<br>    ],<br>    “settings” : {<br>      “index” : {<br>        “lifecycle” : {<br>          “name” : “log_ilm_policy”,<br>          “rollover_alias” : “ilm_alias”<br>        },<br>        “routing” : {<br>          “allocation” : {<br>            “include” : {<br>              “box_type” : “hot”<br>            }<br>          }<br>        },<br>        “number_of_shards” : “1”,<br>        “number_of_replicas” : “0”<br>      }<br>    },<br>    “mappings” : { },<br>    “aliases” : { }<br>}</p>\n<p>#创建索引<br>PUT ilm_index-000001<br>{<br>  “settings”: {<br>    “number_of_shards”: 1,<br>    “number_of_replicas”: 0,<br>    “index.lifecycle.name”: “log_ilm_policy”,<br>    “index.lifecycle.rollover_alias”: “ilm_alias”,<br>    “index.routing.allocation.include.box_type”:”hot”<br>  },<br>  “aliases”: {<br>    “ilm_alias”: {<br>      “is_write_index”: true<br>    }<br>  }<br>}</p>\n<h1 id=\"对-Alias写入文档\"><a href=\"#对-Alias写入文档\" class=\"headerlink\" title=\"对 Alias写入文档\"></a>对 Alias写入文档</h1><p>POST  ilm_alias&#x2F;_doc<br>{<br>  “dfd”:”dfdsf”<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 12.1-Logstash入门及架构介绍.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Logstash 入门及架构介绍</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"一个-Demo，-demo-运行\"><a href=\"#一个-Demo，-demo-运行\" class=\"headerlink\" title=\"一个 Demo， demo 运行\"></a>一个 Demo， demo 运行</h1><p>sudo bin&#x2F;logstash -f logstash-filter.conf</p>\n<h1 id=\"demo数据\"><a href=\"#demo数据\" class=\"headerlink\" title=\"demo数据\"></a>demo数据</h1><p>127.0.0.1 - - [11&#x2F;Dec&#x2F;2013:00:01:45 -0800] “GET &#x2F;xampp&#x2F;status.php HTTP&#x2F;1.1” 200 3891 “<a href=\"http://cadenza/xampp/navi.php\">http://cadenza/xampp/navi.php</a>“ “Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko&#x2F;20100101 Firefox&#x2F;25.0”</p>\n<h1 id=\"codec-demo\"><a href=\"#codec-demo\" class=\"headerlink\" title=\"codec demo\"></a>codec demo</h1><p>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;line}}output{stdout{codec&#x3D;&gt; rubydebug}}”<br>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;json}}output{stdout{codec&#x3D;&gt; rubydebug}}”<br>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;line}}output{stdout{codec&#x3D;&gt; dots}}”</p>\n<p>sudo bin&#x2F;logstash -f multiline-exception.conf</p>\n<h1 id=\"多行数据，异常\"><a href=\"#多行数据，异常\" class=\"headerlink\" title=\"多行数据，异常\"></a>多行数据，异常</h1><p>Exception in thread “main” java.lang.NullPointerException<br>        at com.example.myproject.Book.getTitle(Book.java:16)<br>        at com.example.myproject.Author.getBookTitles(Author.java:25)<br>        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</p>\n<h1 id=\"一个实例\"><a href=\"#一个实例\" class=\"headerlink\" title=\"一个实例\"></a>一个实例</h1><p><a href=\"https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf\">https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf</a></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 12.2-利用JDBC插件导入数据到Elasticsearch.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Logstash插件及文档介绍</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://spring.io/guides/gs/accessing-data-mysql/\">https://spring.io/guides/gs/accessing-data-mysql/</a><br>create database db_example;<br>use db_example;<br>show tables;<br>drop table user;<br>select * from user;</p>\n<h1 id=\"新增用户\"><a href=\"#新增用户\" class=\"headerlink\" title=\"新增用户\"></a>新增用户</h1><p>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Mike -d email&#x3D;<a href=\"mailto:&#x6d;&#x69;&#x6b;&#101;&#x40;&#120;&#x79;&#122;&#x2e;&#x63;&#x6f;&#109;\">&#x6d;&#x69;&#x6b;&#101;&#x40;&#120;&#x79;&#122;&#x2e;&#x63;&#x6f;&#109;</a> -d tags&#x3D;Elasticsearch,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Jack -d email&#x3D;<a href=\"mailto:&#x6a;&#x61;&#99;&#107;&#x40;&#120;&#x79;&#122;&#46;&#99;&#111;&#x6d;\">&#x6a;&#x61;&#99;&#107;&#x40;&#120;&#x79;&#122;&#46;&#99;&#111;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Bob -d email&#x3D;<a href=\"mailto:&#98;&#111;&#x62;&#64;&#x78;&#x79;&#122;&#46;&#x63;&#x6f;&#x6d;\">&#98;&#111;&#x62;&#64;&#x78;&#x79;&#122;&#46;&#x63;&#x6f;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ</p>\n<p>#查看所有的用户<br>curl ‘localhost:8080&#x2F;demo&#x2F;all’</p>\n<h1 id=\"更新用户\"><a href=\"#更新用户\" class=\"headerlink\" title=\"更新用户\"></a>更新用户</h1><p>curl -X PUT localhost:8080&#x2F;demo&#x2F;update -d id&#x3D;16 -d name&#x3D;Bob2 -d email&#x3D;<a href=\"mailto:&#98;&#111;&#x62;&#50;&#x40;&#120;&#x79;&#x7a;&#x2e;&#x63;&#111;&#x6d;\">&#98;&#111;&#x62;&#50;&#x40;&#120;&#x79;&#x7a;&#x2e;&#x63;&#111;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ</p>\n<h1 id=\"删除用户\"><a href=\"#删除用户\" class=\"headerlink\" title=\"删除用户\"></a>删除用户</h1><p>curl -X DELETE localhost:8080&#x2F;demo&#x2F;delete -d id&#x3D;15</p>\n<p>mysql-demo.conf</p>\n<h1 id=\"创建-alias，只显示没有被标记-deleted的用户\"><a href=\"#创建-alias，只显示没有被标记-deleted的用户\" class=\"headerlink\" title=\"创建 alias，只显示没有被标记 deleted的用户\"></a>创建 alias，只显示没有被标记 deleted的用户</h1><p>POST &#x2F;_aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “users”,<br>        “alias”: “view_users”,<br>         “filter” : { “term” : { “is_deleted” : false } }<br>      }<br>    }<br>  ]<br>}</p>\n<h1 id=\"通过-Alias查询，查不到被标记成-deleted的用户\"><a href=\"#通过-Alias查询，查不到被标记成-deleted的用户\" class=\"headerlink\" title=\"通过 Alias查询，查不到被标记成 deleted的用户\"></a>通过 Alias查询，查不到被标记成 deleted的用户</h1><p>POST view_users&#x2F;_search<br>{</p>\n<p>}</p>\n<p>POST view_users&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “name.keyword”: {<br>        “value”: “Jack”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST users&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “name.keyword”: {<br>        “value”: “Jack”<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 12.3-Beats介绍.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Beats介绍</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h1 id=\"查看-packetbeat-模块\"><a href=\"#查看-packetbeat-模块\" class=\"headerlink\" title=\"查看 packetbeat 模块\"></a>查看 packetbeat 模块</h1><h1 id=\"设置-packetbeat-的mysql-模块\"><a href=\"#设置-packetbeat-的mysql-模块\" class=\"headerlink\" title=\"设置 packetbeat 的mysql 模块\"></a>设置 packetbeat 的mysql 模块</h1><h1 id=\"启动运行\"><a href=\"#启动运行\" class=\"headerlink\" title=\"启动运行\"></a>启动运行</h1><h1 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h1><p>.&#x2F;metricbeat modules list<br>.&#x2F;metricbeat modules enable mysql<br>.&#x2F;metricbeat setup –dashboards</p>\n<h1 id=\"安装mysql\"><a href=\"#安装mysql\" class=\"headerlink\" title=\"安装mysql\"></a>安装mysql</h1><p>create database db_example<br>use db_example;<br>show tables;<br>select * from user</p>\n<p>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Mike -d email&#x3D;<a href=\"mailto:&#x6d;&#105;&#x6b;&#101;&#64;&#120;&#x79;&#122;&#x2e;&#x63;&#111;&#109;\">&#x6d;&#105;&#x6b;&#101;&#64;&#120;&#x79;&#122;&#x2e;&#x63;&#111;&#109;</a> -d tags&#x3D;Elasticsearch,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Jack -d email&#x3D;<a href=\"mailto:&#x6a;&#97;&#99;&#107;&#x40;&#120;&#121;&#122;&#46;&#99;&#111;&#x6d;\">&#x6a;&#97;&#99;&#107;&#x40;&#120;&#121;&#122;&#46;&#99;&#111;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Bob -d email&#x3D;<a href=\"mailto:&#x62;&#111;&#x62;&#x40;&#120;&#121;&#x7a;&#46;&#x63;&#111;&#109;\">&#x62;&#111;&#x62;&#x40;&#120;&#121;&#x7a;&#46;&#x63;&#111;&#109;</a> -d tags&#x3D;Mysql,IntelliJ</p>\n<p>curl ‘localhost:8080&#x2F;demo&#x2F;all’</p>\n<h1 id=\"配置-packetbeat\"><a href=\"#配置-packetbeat\" class=\"headerlink\" title=\"配置 packetbeat\"></a>配置 packetbeat</h1><h1 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h1><p>修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控</p>\n<p>sudo chown root packetbeat.yml<br>sudo .&#x2F;packetbeat setup –dashboards<br>sudo .&#x2F;packetbeat</p>\n<h1 id=\"查看所有-Filebeat-模块\"><a href=\"#查看所有-Filebeat-模块\" class=\"headerlink\" title=\"查看所有 Filebeat 模块\"></a>查看所有 Filebeat 模块</h1><h1 id=\"查看所有的modules\"><a href=\"#查看所有的modules\" class=\"headerlink\" title=\"查看所有的modules\"></a>查看所有的modules</h1><p>.&#x2F;filebeat modules list</p>\n<h1 id=\"-2\"><a href=\"#-2\" class=\"headerlink\" title=\"\"></a></h1><p>.&#x2F;filebeat modules enable mysql</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 13.1-使用IndexPattern配置数据.md</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>localhost:5601&#x2F;status</p>\n<p>PUT &#x2F;logstash-2015.05.18<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT &#x2F;logstash-2015.05.19<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT &#x2F;logstash-2015.05.20<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"For-Mac-Windows\"><a href=\"#For-Mac-Windows\" class=\"headerlink\" title=\"For Mac &amp; Windows\"></a>For Mac &amp; Windows</h1><p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;_bulk?pretty’ –data-binary @logs.jsonl</p>\n<p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;bank&#x2F;account&#x2F;_bulk?pretty’ –data-binary @accounts.json</p>\n<p>#For Windows<br>Invoke-RestMethod “<a href=\"http://localhost:9200/_bulk?pretty\">http://localhost:9200/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “logs.jsonl”</p>\n<p>GET &#x2F;_cat&#x2F;indices?v</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 13.2-使用KibanaDiscover探索数据.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 使用Kibana Discovery 探索数据</span><br></pre></td></tr></table></figure>\n\n<p>设置时间过滤器<br>搜索你的数据<br>根据字段进行过滤<br>查看文档数据<br>查看文档上下文<br>暂时字段数据统计<br>Save Query</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 13.3-基本可视化组件介绍.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 基本可视化组件介绍</span><br></pre></td></tr></table></figure>\n\n<p>PUT &#x2F;shakespeare<br>{<br>  “mappings”: {<br>    “properties”: {<br>    “speaker”: {“type”: “keyword”},<br>    “play_name”: {“type”: “keyword”},<br>    “line_id”: {“type”: “integer”},<br>    “speech_number”: {“type”: “integer”}<br>    }<br>  }<br>}</p>\n<h1 id=\"For-Mac-Windows-1\"><a href=\"#For-Mac-Windows-1\" class=\"headerlink\" title=\"For Mac &amp; Windows\"></a>For Mac &amp; Windows</h1><p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;bank&#x2F;account&#x2F;_bulk?pretty’ –data-binary @accounts.json<br>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;shakespeare&#x2F;_bulk?pretty’ –data-binary @shakespeare.json</p>\n<p>#For Windows<br>Invoke-RestMethod “<a href=\"http://localhost:9200/bank/account/_bulk?pretty\">http://localhost:9200/bank/account/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “accounts.json”<br>Invoke-RestMethod “<a href=\"http://localhost:9200/shakespeare/_bulk?pretty\">http://localhost:9200/shakespeare/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “shakespeare.json”</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 13.4-构建Dashboard.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 构建Dashboard</span><br></pre></td></tr></table></figure>\n<ul>\n<li>创建仪表潘</li>\n<li>加载仪表盘</li>\n<li>共享仪表盘</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 14.3用机器学习实现时序数据的异常检测-上.md</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir server_metrics</span><br><span class=\"line\">cd server_metrics</span><br><span class=\"line\">wget https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz</span><br><span class=\"line\">tar -xvf server_metrics.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 14.5-用ELK进行日志管理.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 用 ELK 来做日志管理</span><br></pre></td></tr></table></figure>\n<p>.&#x2F;filebeat modules list<br>.&#x2F;filebeat modules enable system<br>.&#x2F;filebeat modules enable elasticsearch</p>\n<h2 id=\"进-modules-d-编辑相应的文件，修改log路径\"><a href=\"#进-modules-d-编辑相应的文件，修改log路径\" class=\"headerlink\" title=\"进 modules.d 编辑相应的文件，修改log路径\"></a>进 modules.d 编辑相应的文件，修改log路径</h2><p>.&#x2F;filebeat setup –dashboards</p>\n<p>.&#x2F;filebeat export template | more</p>\n<p>.&#x2F;filebeat -e</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 14.6-用Canvas做数据演示.md</span><br><span class=\"line\"></span><br><span class=\"line\">POST elasticoffee/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0, </span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;by&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;beverage.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 4.1-基于词项和基于全文的搜索.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 基于词项和基于全文的搜索</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>DELETE products<br>PUT products<br>{<br>  “settings”: {<br>    “number_of_shards”: 1<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “productID” : “XHDK-A-1293-#fJ3”,”desc”:”iPhone” }<br>{ “index”: { “_id”: 2 }}<br>{ “productID” : “KDKE-B-9947-#kL5”,”desc”:”iPad” }<br>{ “index”: { “_id”: 3 }}<br>{ “productID” : “JODL-X-1937-#pV7”,”desc”:”MBP” }</p>\n<p>GET &#x2F;products</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “desc”: {<br>        &#x2F;&#x2F;“value”: “iPhone”<br>        “value”:”iphone”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “desc.keyword”: {<br>        &#x2F;&#x2F;“value”: “iPhone”<br>        &#x2F;&#x2F;“value”:”iphone”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “productID”: {<br>        “value”: “XHDK-A-1293-#fJ3”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  &#x2F;&#x2F;“explain”: true,<br>  “query”: {<br>    “term”: {<br>      “productID.keyword”: {<br>        “value”: “XHDK-A-1293-#fJ3”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “productID.keyword”: “XHDK-A-1293-#fJ3”<br>        }<br>      }</p>\n<pre><code>&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#设置 position_increment_gap<br>DELETE groups<br>PUT groups<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “names”:{<br>        “type”: “text”,<br>        “position_increment_gap”: 0<br>      }<br>    }<br>  }<br>}</p>\n<p>GET groups&#x2F;_mapping</p>\n<p>POST groups&#x2F;_doc<br>{<br>  “names”: [ “John Water”, “Water Smith”]<br>}</p>\n<p>POST groups&#x2F;_search<br>{<br>  “query”: {<br>    “match_phrase”: {<br>      “names”: {<br>        “query”: “Water Water”,<br>        “slop”: 100<br>      }<br>    }<br>  }<br>}</p>\n<p>POST groups&#x2F;_search<br>{<br>  “query”: {<br>    “match_phrase”: {<br>      “names”: “Water Smith”<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 4.10-综合排序：Function Score Query 优化算分.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 综合排序：Function Score Query 优化算分</span><br></pre></td></tr></table></figure>\n<p>DELETE blogs<br>PUT &#x2F;blogs&#x2F;_doc&#x2F;1<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   0<br>}</p>\n<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;2<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   100<br>}</p>\n<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;3<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   1000000<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p” ,<br>        “factor”: 0.1<br>      }<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p” ,<br>        “factor”: 0.1<br>      },<br>      “boost_mode”: “sum”,<br>      “max_boost”: 3<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “random_score”: {<br>        “seed”: 911119<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 4.12-自动补全与基于上下文的提示.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 自动补全与基于上下文的提示</span><br></pre></td></tr></table></figure>\n<p>DELETE articles<br>PUT articles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title_completion”:{<br>        “type”: “completion”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST articles&#x2F;_bulk<br>{ “index” : { } }<br>{ “title_completion”: “lucene is very cool”}<br>{ “index” : { } }<br>{ “title_completion”: “Elasticsearch builds on top of lucene”}<br>{ “index” : { } }<br>{ “title_completion”: “Elasticsearch rocks”}<br>{ “index” : { } }<br>{ “title_completion”: “elastic is the company behind ELK stack”}<br>{ “index” : { } }<br>{ “title_completion”: “Elk stack rocks”}<br>{ “index” : {} }</p>\n<p>POST articles&#x2F;_search?pretty<br>{<br>  “size”: 0,<br>  “suggest”: {<br>    “article-suggester”: {<br>      “prefix”: “elk “,<br>      “completion”: {<br>        “field”: “title_completion”<br>      }<br>    }<br>  }<br>}</p>\n<p>DELETE comments<br>PUT comments<br>PUT comments&#x2F;_mapping<br>{<br>  “properties”: {<br>    “comment_autocomplete”:{<br>      “type”: “completion”,<br>      “contexts”:[{<br>        “type”:”category”,<br>        “name”:”comment_category”<br>      }]<br>    }<br>  }<br>}</p>\n<p>POST comments&#x2F;_doc<br>{<br>  “comment”:”I love the star war movies”,<br>  “comment_autocomplete”:{<br>    “input”:[“star wars”],<br>    “contexts”:{<br>      “comment_category”:”movies”<br>    }<br>  }<br>}</p>\n<p>POST comments&#x2F;_doc<br>{<br>  “comment”:”Where can I find a Starbucks”,<br>  “comment_autocomplete”:{<br>    “input”:[“starbucks”],<br>    “contexts”:{<br>      “comment_category”:”coffee”<br>    }<br>  }<br>}</p>\n<p>POST comments&#x2F;_search<br>{<br>  “suggest”: {<br>    “MY_SUGGESTION”: {<br>      “prefix”: “sta”,<br>      “completion”:{<br>        “field”:”comment_autocomplete”,<br>        “contexts”:{<br>          “comment_category”:”coffee”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.13-跨集群搜索.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 跨集群搜索</span><br></pre></td></tr></table></figure>\n<p>&#x2F;&#x2F;启动3个集群</p>\n<p>bin&#x2F;elasticsearch -E node.name&#x3D;cluster0node -E cluster.name&#x3D;cluster0 -E path.data&#x3D;cluster0_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9200 -E transport.port&#x3D;9300<br>bin&#x2F;elasticsearch -E node.name&#x3D;cluster1node -E cluster.name&#x3D;cluster1 -E path.data&#x3D;cluster1_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9201 -E transport.port&#x3D;9301<br>bin&#x2F;elasticsearch -E node.name&#x3D;cluster2node -E cluster.name&#x3D;cluster2 -E path.data&#x3D;cluster2_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9202 -E transport.port&#x3D;9302</p>\n<p>&#x2F;&#x2F;在每个集群上设置动态的设置<br>PUT _cluster&#x2F;settings<br>{<br>  “persistent”: {<br>    “cluster”: {<br>      “remote”: {<br>        “cluster0”: {<br>          “seeds”: [<br>            “127.0.0.1:9300”<br>          ],<br>          “transport.ping_schedule”: “30s”<br>        },<br>        “cluster1”: {<br>          “seeds”: [<br>            “127.0.0.1:9301”<br>          ],<br>          “transport.compress”: true,<br>          “skip_unavailable”: true<br>        },<br>        “cluster2”: {<br>          “seeds”: [<br>            “127.0.0.1:9302”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#cURL<br>curl -XPUT “<a href=\"http://localhost:9200/_cluster/settings\">http://localhost:9200/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>\n<p>curl -XPUT “<a href=\"http://localhost:9201/_cluster/settings\">http://localhost:9201/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>\n<p>curl -XPUT “<a href=\"http://localhost:9202/_cluster/settings\">http://localhost:9202/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>\n<p>#创建测试数据<br>curl -XPOST “<a href=\"http://localhost:9200/users/_doc\">http://localhost:9200/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user1”,”age”:10}’</p>\n<p>curl -XPOST “<a href=\"http://localhost:9201/users/_doc\">http://localhost:9201/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user2”,”age”:20}’</p>\n<p>curl -XPOST “<a href=\"http://localhost:9202/users/_doc\">http://localhost:9202/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user3”,”age”:30}’</p>\n<p>#查询<br>GET &#x2F;users,cluster1:users,cluster2:users&#x2F;_search<br>{<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20,<br>        “lte”: 40<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.2-结构化搜索.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 结构化搜索</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>#结构化搜索，精确匹配<br>DELETE products<br>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>\n<p>GET products&#x2F;_mapping</p>\n<p>#对布尔值 match 查询，有算分<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “avaliable”: true<br>    }<br>  }<br>}</p>\n<p>#对布尔值，通过constant score 转成 filtering，没有算分<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “avaliable”: true<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#数字类型 Term<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “price”: 30<br>    }<br>  }<br>}</p>\n<p>#数字类型 terms<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “terms”: {<br>          “price”: [<br>            “20”,<br>            “30”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#数字 Range 查询<br>GET products&#x2F;_search<br>{<br>    “query” : {<br>        “constant_score” : {<br>            “filter” : {<br>                “range” : {<br>                    “price” : {<br>                        “gte” : 20,<br>                        “lte”  : 30<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>\n<h1 id=\"日期-range\"><a href=\"#日期-range\" class=\"headerlink\" title=\"日期 range\"></a>日期 range</h1><p>POST products&#x2F;_search<br>{<br>    “query” : {<br>        “constant_score” : {<br>            “filter” : {<br>                “range” : {<br>                    “date” : {<br>                      “gte” : “now-1y”<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>\n<p>#exists查询<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “exists”: {<br>          “field”: “date”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#处理多值字段<br>POST &#x2F;movies&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title” : “Father of the Bridge Part II”,”year”:1995, “genre”:”Comedy”}<br>{ “index”: { “_id”: 2 }}<br>{ “title” : “Dave”,”year”:1993,”genre”:[“Comedy”,”Romance”] }</p>\n<p>#处理多值字段，term 查询是包含，而不是等于<br>POST movies&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “genre.keyword”: “Comedy”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#字符类型 terms<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “terms”: {<br>          “productID.keyword”: [<br>            “QQPX-R-3956-#aD8”,<br>            “JODL-X-1937-#pV7”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “price”: 30<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “date”: “2019-01-01”<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “date”: “2019-01-01”<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “productID.keyword”: “XHDK-A-1293-#fJ3”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “productID.keyword”: “XHDK-A-1293-#fJ3”<br>    }<br>  }<br>}</p>\n<p>#对布尔数值<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “avaliable”: “false”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “avaliable”: {<br>        “value”: “false”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “price”: {<br>        “value”: “20”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “price”: “20”<br>    }<br>    }<br>  }<br>}</p>\n<p>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “bool”: {<br>          “must_not”: {<br>            “exists”: {<br>              “field”: “date”<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 4.3-搜索的相关性算分.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 搜索的相关性算分</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<p>PUT testscore<br>{<br>  “settings”: {<br>    “number_of_shards”: 1<br>  },<br>  “mappings”: {<br>    “properties”: {<br>      “content”: {<br>        “type”: “text”<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT testscore&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “content”:”we use Elasticsearch to power the search” }<br>{ “index”: { “_id”: 2 }}<br>{ “content”:”we like elasticsearch” }<br>{ “index”: { “_id”: 3 }}<br>{ “content”:”The scoring of documents is caculated by the scoring formula” }<br>{ “index”: { “_id”: 4 }}<br>{ “content”:”you know, for search” }</p>\n<p>POST &#x2F;testscore&#x2F;_search<br>{<br>  &#x2F;&#x2F;“explain”: true,<br>  “query”: {<br>    “match”: {<br>      “content”:”you”<br>      &#x2F;&#x2F;“content”: “elasticsearch”<br>      &#x2F;&#x2F;“content”:”the”<br>      &#x2F;&#x2F;“content”: “the elasticsearch”<br>    }<br>  }<br>}</p>\n<p>POST testscore&#x2F;_search<br>{<br>    “query”: {<br>        “boosting” : {<br>            “positive” : {<br>                “term” : {<br>                    “content” : “elasticsearch”<br>                }<br>            },<br>            “negative” : {<br>                 “term” : {<br>                     “content” : “like”<br>                }<br>            },<br>            “negative_boost” : 0.2<br>        }<br>    }<br>}</p>\n<p>POST tmdb&#x2F;_search<br>{<br>  “_source”: [“title”,”overview”],<br>  “query”: {<br>    “more_like_this”: {<br>      “fields”: [<br>        “title^10”,”overview”<br>      ],<br>      “like”: [{“_id”:”14191”}],<br>      “min_term_freq”: 1,<br>      “max_query_terms”: 12<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.4-Query&amp;Filtering实现多字符串多字段查询.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Query &amp; Filtering 与多字符串多字段查询</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>\n<p>#基本语法<br>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool” : {<br>      “must” : {<br>        “term” : { “price” : “30” }<br>      },<br>      “filter”: {<br>        “term” : { “avaliable” : “true” }<br>      },<br>      “must_not” : {<br>        “range” : {<br>          “price” : { “lte” : 10 }<br>        }<br>      },<br>      “should” : [<br>        { “term” : { “productID.keyword” : “JODL-X-1937-#pV7” } },<br>        { “term” : { “productID.keyword” : “XHDK-A-1293-#fJ3” } }<br>      ],<br>      “minimum_should_match” :1<br>    }<br>  }<br>}</p>\n<p>#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题<br>POST &#x2F;newmovies&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title” : “Father of the Bridge Part II”,”year”:1995, “genre”:”Comedy”,”genre_count”:1 }<br>{ “index”: { “_id”: 2 }}<br>{ “title” : “Dave”,”year”:1993,”genre”:[“Comedy”,”Romance”],”genre_count”:2 }</p>\n<p>#must，有算分<br>POST &#x2F;newmovies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“term”: {“genre.keyword”: {“value”: “Comedy”}}},<br>        {“term”: {“genre_count”: {“value”: 1}}}</p>\n<pre><code>  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Filter。不参与算分，结果的score是0<br>POST &#x2F;newmovies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “filter”: [<br>        {“term”: {“genre.keyword”: {“value”: “Comedy”}}},<br>        {“term”: {“genre_count”: {“value”: 1}}}<br>        ]</p>\n<pre><code>&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Filtering Context<br>POST _search<br>{<br>  “query”: {<br>    “bool” : {</p>\n<pre><code>  &quot;filter&quot;: &#123;\n    &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;\n  &#125;,\n  &quot;must_not&quot; : &#123;\n    &quot;range&quot; : &#123;\n      &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;\n    &#125;\n  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Query Context<br>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>\n<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        {<br>          “term”: {<br>            “productID.keyword”: {<br>              “value”: “JODL-X-1937-#pV7”}}<br>        },<br>        {“term”: {“avaliable”: {“value”: true}}<br>        }<br>      ]<br>    }<br>  }<br>}</p>\n<p>#嵌套，实现了 should not 逻辑<br>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “term”: {<br>          “price”: “30”<br>        }<br>      },<br>      “should”: [<br>        {<br>          “bool”: {<br>            “must_not”: {<br>              “term”: {<br>                “avaliable”: “false”<br>              }<br>            }<br>          }<br>        }<br>      ],<br>      “minimum_should_match”: 1<br>    }<br>  }<br>}</p>\n<p>#Controll the Precision<br>POST _search<br>{<br>  “query”: {<br>    “bool” : {<br>      “must” : {<br>        “term” : { “price” : “30” }<br>      },<br>      “filter”: {<br>        “term” : { “avaliable” : “true” }<br>      },<br>      “must_not” : {<br>        “range” : {<br>          “price” : { “lte” : 10 }<br>        }<br>      },<br>      “should” : [<br>        { “term” : { “productID.keyword” : “JODL-X-1937-#pV7” } },<br>        { “term” : { “productID.keyword” : “XHDK-A-1293-#fJ3” } }<br>      ],<br>      “minimum_should_match” :2<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;animals&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        { “term”: { “text”: “brown” }},<br>        { “term”: { “text”: “red” }},<br>        { “term”: { “text”: “quick”   }},<br>        { “term”: { “text”: “dog”   }}<br>      ]<br>    }<br>  }<br>}</p>\n<p>POST &#x2F;animals&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        { “term”: { “text”: “quick” }},<br>        { “term”: { “text”: “dog”   }},<br>        {<br>          “bool”:{<br>            “should”:[<br>               { “term”: { “text”: “brown” }},<br>                 { “term”: { “text”: “brown” }},<br>            ]<br>          }</p>\n<pre><code>    &#125;\n  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>DELETE blogs<br>POST &#x2F;blogs&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{“title”:”Apple iPad”, “content”:”Apple iPad,Apple iPad” }<br>{ “index”: { “_id”: 2 }}<br>{“title”:”Apple iPad,Apple iPad”, “content”:”Apple iPad” }</p>\n<p>POST blogs&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        {“match”: {<br>          “title”: {<br>            “query”: “apple,ipad”,<br>            “boost”: 1.1<br>          }<br>        }},</p>\n<pre><code>    &#123;&quot;match&quot;: &#123;\n      &quot;content&quot;: &#123;\n        &quot;query&quot;: &quot;apple,ipad&quot;,\n        &quot;boost&quot;:\n      &#125;\n    &#125;&#125;\n  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>DELETE news<br>POST &#x2F;news&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “content”:”Apple Mac” }<br>{ “index”: { “_id”: 2 }}<br>{ “content”:”Apple iPad” }<br>{ “index”: { “_id”: 3 }}<br>{ “content”:”Apple employee like Apple Pie and Apple Juice” }</p>\n<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “match”:{“content”:”apple”}<br>      }<br>    }<br>  }<br>}</p>\n<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “match”:{“content”:”apple”}<br>      },<br>      “must_not”: {<br>        “match”:{“content”:”pie”}<br>      }<br>    }<br>  }<br>}</p>\n<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “boosting”: {<br>      “positive”: {<br>        “match”: {<br>          “content”: “apple”<br>        }<br>      },<br>      “negative”: {<br>        “match”: {<br>          “content”: “pie”<br>        }<br>      },<br>      “negative_boost”: 0.5<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 4.5-单字符串多字段查询-DisMaxQuery.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 单字符串多字段查询：Dis Max Query</span><br></pre></td></tr></table></figure>\n\n<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;1<br>{<br>    “title”: “Quick brown rabbits”,<br>    “body”:  “Brown rabbits are commonly seen.”<br>}</p>\n<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;2<br>{<br>    “title”: “Keeping pets healthy”,<br>    “body”:  “My quick brown fox eats rabbits on a regular basis.”<br>}</p>\n<p>POST &#x2F;blogs&#x2F;_search<br>{<br>    “query”: {<br>        “bool”: {<br>            “should”: [<br>                { “match”: { “title”: “Brown fox” }},<br>                { “match”: { “body”:  “Brown fox” }}<br>            ]<br>        }<br>    }<br>}</p>\n<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ]<br>        }<br>    }<br>}</p>\n<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ],<br>            “tie_breaker”: 0.2<br>        }<br>    }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 4.6-单字符串多字段查询-Multi-Match.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 单字符串多字段查询：Multi Match</span><br></pre></td></tr></table></figure>\n<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ],<br>            “tie_breaker”: 0.2<br>        }<br>    }<br>}</p>\n<p>POST blogs&#x2F;_search<br>{<br>  “query”: {<br>    “multi_match”: {<br>      “type”: “best_fields”,<br>      “query”: “Quick pets”,<br>      “fields”: [“title”,”body”],<br>      “tie_breaker”: 0.2,<br>      “minimum_should_match”: “20%”<br>    }<br>  }<br>}</p>\n<p>POST books&#x2F;_search<br>{<br>    “multi_match”: {<br>        “query”:  “Quick brown fox”,<br>        “fields”: “*_title”<br>    }<br>}</p>\n<p>POST books&#x2F;_search<br>{<br>    “multi_match”: {<br>        “query”:  “Quick brown fox”,<br>        “fields”: [ “*_title”, “chapter_title^2” ]<br>    }<br>}</p>\n<p>DELETE &#x2F;titles<br>PUT &#x2F;titles<br>{<br>    “settings”: { “number_of_shards”: 1 },<br>    “mappings”: {<br>        “my_type”: {<br>            “properties”: {<br>                “title”: {<br>                    “type”:     “string”,<br>                    “analyzer”: “english”,<br>                    “fields”: {<br>                        “std”:   {<br>                            “type”:     “string”,<br>                            “analyzer”: “standard”<br>                        }<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>\n<p>PUT &#x2F;titles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title”: {<br>        “type”: “text”,<br>        “analyzer”: “english”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST titles&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title”: “My dog barks” }<br>{ “index”: { “_id”: 2 }}<br>{ “title”: “I see a lot of barking dogs on the road “ }</p>\n<p>GET titles&#x2F;_search<br>{<br>  “query”: {<br>    “match”: {<br>      “title”: “barking dogs”<br>    }<br>  }<br>}</p>\n<p>DELETE &#x2F;titles<br>PUT &#x2F;titles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title”: {<br>        “type”: “text”,<br>        “analyzer”: “english”,<br>        “fields”: {“std”: {“type”: “text”,”analyzer”: “standard”}}<br>      }<br>    }<br>  }<br>}</p>\n<p>POST titles&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title”: “My dog barks” }<br>{ “index”: { “_id”: 2 }}<br>{ “title”: “I see a lot of barking dogs on the road “ }</p>\n<p>GET &#x2F;titles&#x2F;_search<br>{<br>   “query”: {<br>        “multi_match”: {<br>            “query”:  “barking dogs”,<br>            “type”:   “most_fields”,<br>            “fields”: [ “title”, “title.std” ]<br>        }<br>    }<br>}</p>\n<p>GET &#x2F;titles&#x2F;_search<br>{<br>   “query”: {<br>        “multi_match”: {<br>            “query”:  “barking dogs”,<br>            “type”:   “most_fields”,<br>            “fields”: [ “title^10”, “title.std” ]<br>        }<br>    }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 4.7-多语言及中文分词与检索.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 多语言及中文分词与检索</span><br><span class=\"line\"></span><br><span class=\"line\">- 来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”</span><br><span class=\"line\"></span><br><span class=\"line\">- 你也想犯范范玮琪犯过的错吗</span><br><span class=\"line\">- 校长说衣服上除了校徽别别别的</span><br><span class=\"line\">- 这几天天天天气不好</span><br><span class=\"line\">- 我背有点驼，麻麻说“你的背得背背背背佳</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>#stop word</p>\n<p>DELETE my_index<br>PUT &#x2F;my_index&#x2F;_doc&#x2F;1<br>{ “title”: “I’m happy for this fox” }</p>\n<p>PUT &#x2F;my_index&#x2F;_doc&#x2F;2<br>{ “title”: “I’m not happy about my fox problem” }</p>\n<p>POST my_index&#x2F;_search<br>{<br>  “query”: {<br>    “match”: {<br>      “title”: “not happy fox”<br>    }<br>  }<br>}</p>\n<p>#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 <code>english</code>（英语）分析器，另一次使用 <code>standard</code>（标准）分析器:</p>\n<p>DELETE my_index</p>\n<p>PUT &#x2F;my_index<br>{<br>  “mappings”: {<br>    “blog”: {<br>      “properties”: {<br>        “title”: {<br>          “type”: “string”,<br>          “analyzer”: “english”<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT &#x2F;my_index<br>{<br>  “mappings”: {<br>    “blog”: {<br>      “properties”: {<br>        “title”: {<br>          “type”: “string”,<br>          “fields”: {<br>            “english”: {<br>              “type”:     “string”,<br>              “analyzer”: “english”<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>PUT &#x2F;my_index&#x2F;blog&#x2F;1<br>{ “title”: “I’m happy for this fox” }</p>\n<p>PUT &#x2F;my_index&#x2F;blog&#x2F;2<br>{ “title”: “I’m not happy about my fox problem” }</p>\n<p>GET &#x2F;_search<br>{<br>  “query”: {<br>    “multi_match”: {<br>      “type”:     “most_fields”,<br>      “query”:    “not happy foxes”,<br>      “fields”: [ “title”, “title.english” ]<br>    }<br>  }<br>}</p>\n<p>#安装插件<br>.&#x2F;elasticsearch-plugin install <a href=\"https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip\">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</a><br>#安装插件<br>bin&#x2F;elasticsearch install <a href=\"https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip\">https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip</a></p>\n<p>#ik_max_word<br>#ik_smart<br>#hanlp: hanlp默认分词<br>#hanlp_standard: 标准分词<br>#hanlp_index: 索引分词<br>#hanlp_nlp: NLP分词<br>#hanlp_n_short: N-最短路分词<br>#hanlp_dijkstra: 最短路分词<br>#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）<br>#hanlp_speed: 极速词典分词</p>\n<p>POST _analyze<br>{<br>  “analyzer”: “hanlp_standard”,<br>  “text”: [“剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜”]</p>\n<p>}     </p>\n<p>#Pinyin<br>PUT &#x2F;artists&#x2F;<br>{<br>    “settings” : {<br>        “analysis” : {<br>            “analyzer” : {<br>                “user_name_analyzer” : {<br>                    “tokenizer” : “whitespace”,<br>                    “filter” : “pinyin_first_letter_and_full_pinyin_filter”<br>                }<br>            },<br>            “filter” : {<br>                “pinyin_first_letter_and_full_pinyin_filter” : {<br>                    “type” : “pinyin”,<br>                    “keep_first_letter” : true,<br>                    “keep_full_pinyin” : false,<br>                    “keep_none_chinese” : true,<br>                    “keep_original” : false,<br>                    “limit_first_letter_length” : 16,<br>                    “lowercase” : true,<br>                    “trim_whitespace” : true,<br>                    “keep_none_chinese_in_first_letter” : true<br>                }<br>            }<br>        }<br>    }<br>}</p>\n<p>GET &#x2F;artists&#x2F;_analyze<br>{<br>  “text”: [“刘德华 张学友 郭富城 黎明 四大天王”],<br>  “analyzer”: “user_name_analyzer”<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## 相关资源</span><br><span class=\"line\">- Elasticsearch IK分词插件 https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br><span class=\"line\">- Elasticsearch hanlp 分词插件 https://github.com/KennFalcon/elasticsearch-analysis-hanlp</span><br><span class=\"line\"></span><br><span class=\"line\">- 分词算法综述 https://zhuanlan.zhihu.com/p/50444885</span><br><span class=\"line\"></span><br><span class=\"line\">### 一些分词工具，供参考：</span><br><span class=\"line\">- 中科院计算所NLPIR http://ictclas.nlpir.org/nlpir/</span><br><span class=\"line\">- ansj分词器 https://github.com/NLPchina/ansj_seg</span><br><span class=\"line\">- 哈工大的LTP https://github.com/HIT-SCIR/ltp</span><br><span class=\"line\">- 清华大学THULAC https://github.com/thunlp/THULAC</span><br><span class=\"line\">- 斯坦福分词器 https://nlp.stanford.edu/software/segmenter.shtml</span><br><span class=\"line\">- Hanlp分词器 https://github.com/hankcs/HanLP</span><br><span class=\"line\">- 结巴分词 https://github.com/yanyiwu/cppjieba</span><br><span class=\"line\">- KCWS分词器(字嵌入+Bi-LSTM+CRF) https://github.com/koth/kcws</span><br><span class=\"line\">- ZPar https://github.com/frcchang/zpar/releases</span><br><span class=\"line\">- IKAnalyzer https://github.com/wks/ik-analyzer</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.8-SpaceJam一个全文搜索的实例.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Space Jam，一次全文搜索的实例</span><br><span class=\"line\"></span><br><span class=\"line\">## 环境要求</span><br><span class=\"line\">- Python 2.7.15</span><br><span class=\"line\">- 可以使用pyenv管理多个python版本（可选）</span><br><span class=\"line\"></span><br><span class=\"line\">## 进入 tmdb-search目录</span><br><span class=\"line\">Run</span><br><span class=\"line\">pip install -r requirements.txt</span><br><span class=\"line\">Run python ./ingest_tmdb_from_file.py</span><br></pre></td></tr></table></figure>\n<p>POST tmdb&#x2F;_search<br>{<br>“_source”: [“title”,”overview”],<br> “query”: {<br>   “match_all”: {}<br> }<br>}</p>\n<p>POST tmdb&#x2F;_search<br>{<br>  “_source”: [“title”,”overview”],<br>  “query”: {<br>    “multi_match”: {<br>      “query”: “basketball with cartoon aliens”,<br>      “fields”: [“title”,”overview”]<br>    }<br>  },<br>  “highlight” : {<br>        “fields” : {<br>            “overview” : { “pre_tags” : [“\\033[0;32;40m”], “post_tags” : [“\\033[0m”] },<br>            “title” : { “pre_tags” : [“\\033[0;32;40m”], “post_tags” : [“\\033[0m”] }</p>\n<pre><code>    &#125;\n&#125;\n</code></pre>\n<p>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## 相关</span><br><span class=\"line\">- Windows 安装 pyenv https://github.com/pyenv-win/pyenv-win</span><br><span class=\"line\">- Mac 安装pyenv https://segmentfault.com/a/1190000017403221</span><br><span class=\"line\">- Linux 安装 pyenv https://blog.csdn.net/GX_1_11_real/article/details/80237064</span><br><span class=\"line\">- Python.org https://www.python.org/</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 4.9-使用SearchTemplate和IndexAlias进行查询.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 使用 Search Template 和 Index Alias 查询</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>POST _scripts&#x2F;tmdb<br>{<br>  “script”: {<br>    “lang”: “mustache”,<br>    “source”: {<br>      “_source”: [<br>        “title”,”overview”<br>      ],<br>      “size”: 20,<br>      “query”: {<br>        “multi_match”: {<br>          “query”: ““,<br>          “fields”: [“title”,”overview”]<br>        }<br>      }<br>    }<br>  }<br>}<br>DELETE _scripts&#x2F;tmdb</p>\n<p>GET _scripts&#x2F;tmdb</p>\n<p>POST tmdb&#x2F;_search&#x2F;template<br>{<br>    “id”:”tmdb”,<br>    “params”: {<br>        “q”: “basketball with cartoon aliens”<br>    }<br>}</p>\n<p>PUT movies-2019&#x2F;_doc&#x2F;1<br>{<br>  “name”:”the matrix”,<br>  “rating”:5<br>}</p>\n<p>PUT movies-2019&#x2F;_doc&#x2F;2<br>{<br>  “name”:”Speed”,<br>  “rating”:3<br>}</p>\n<p>POST _aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “movies-2019”,<br>        “alias”: “movies-latest”<br>      }<br>    }<br>  ]<br>}</p>\n<p>POST movies-latest&#x2F;_search<br>{<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>\n<p>POST _aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “movies-2019”,<br>        “alias”: “movies-lastest-highrate”,<br>        “filter”: {<br>          “range”: {<br>            “rating”: {<br>              “gte”: 4<br>            }<br>          }<br>        }<br>      }<br>    }<br>  ]<br>}</p>\n<p>POST movies-lastest-highrate&#x2F;_search<br>{<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.1-集群分布式模型及选主与脑裂问题.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 集群分布式模型及选主与脑裂问题</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>bin&#x2F;elasticsearch -E node.name&#x3D;node1 -E cluster.name&#x3D;geektime -E path.data&#x3D;node1_data<br>bin&#x2F;elasticsearch -E node.name&#x3D;node2 -E cluster.name&#x3D;geektime -E path.data&#x3D;node2_data<br>bin&#x2F;elasticsearch -E node.name&#x3D;node3 -E cluster.name&#x3D;geektime -E path.data&#x3D;node3_data</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 5.2-分片与集群的故障转移.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 分片与集群的故障转移</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.3-文档分布式存储.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 文档分布式存储</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.4-分片及其生命周期.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 分片及其生命周期</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.5-剖析分布式查询及相关性评分.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 剖析分布式查询及相关性评分</span><br></pre></td></tr></table></figure>\n<p>DELETE message<br>PUT message<br>{<br>  “settings”: {<br>    “number_of_shards”: 20<br>  }<br>}</p>\n<p>GET message</p>\n<p>POST message&#x2F;_doc?routing&#x3D;1<br>{<br>  “content”:”good”<br>}</p>\n<p>POST message&#x2F;_doc?routing&#x3D;2<br>{<br>  “content”:”good morning”<br>}</p>\n<p>POST message&#x2F;_doc?routing&#x3D;3<br>{<br>  “content”:”good morning everyone”<br>}</p>\n<p>POST message&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>\n<p>POST message&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “content”: {<br>        “value”: “good”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST message&#x2F;_search?search_type&#x3D;dfs_query_then_fetch<br>{</p>\n<p>  “query”: {<br>    “term”: {<br>      “content”: {<br>        “value”: “good”<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.6-排序及DocValues&amp;Fielddata.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 排序及Doc Values &amp; Fielddata</span><br></pre></td></tr></table></figure>\n<p>#单字段排序<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>\n<pre><code>&#125;\n</code></pre>\n<p>  },<br>  “sort”: [<br>    {“order_date”: {“order”: “desc”}}<br>  ]<br>}</p>\n<p>#多字段排序<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>\n<pre><code>&#125;\n</code></pre>\n<p>  },<br>  “sort”: [<br>    {“order_date”: {“order”: “desc”}},<br>    {“_doc”:{“order”: “asc”}},<br>    {“_score”:{ “order”: “desc”}}<br>  ]<br>}</p>\n<p>GET kibana_sample_data_ecommerce&#x2F;_mapping</p>\n<p>#对 text 字段进行排序。默认会报错，需打开fielddata<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>\n<pre><code>&#125;\n</code></pre>\n<p>  },<br>  “sort”: [<br>    {“customer_full_name”: {“order”: “desc”}}<br>  ]<br>}</p>\n<p>#打开 text的 fielddata<br>PUT kibana_sample_data_ecommerce&#x2F;_mapping<br>{<br>  “properties”: {<br>    “customer_full_name” : {<br>          “type” : “text”,<br>          “fielddata”: true,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 256<br>            }<br>          }<br>        }<br>  }<br>}</p>\n<p>#关闭 keyword的 doc values<br>PUT test_keyword<br>PUT test_keyword&#x2F;_mapping<br>{<br>  “properties”: {<br>    “user_name”:{<br>      “type”: “keyword”,<br>      “doc_values”:false<br>    }<br>  }<br>}</p>\n<p>DELETE test_keyword</p>\n<p>PUT test_text<br>PUT test_text&#x2F;_mapping<br>{<br>  “properties”: {<br>    “intro”:{<br>      “type”: “text”,<br>      “doc_values”:true<br>    }<br>  }<br>}</p>\n<p>DELETE test_text</p>\n<p>DELETE temp_users<br>PUT temp_users<br>PUT temp_users&#x2F;_mapping<br>{<br>  “properties”: {<br>    “name”:{“type”: “text”,”fielddata”: true},<br>    “desc”:{“type”: “text”,”fielddata”: true}<br>  }<br>}</p>\n<p>Post temp_users&#x2F;_doc<br>{“name”:”Jack”,”desc”:”Jack is a good boy!”,”age”:10}</p>\n<p>#打开fielddata 后，查看 docvalue_fields数据<br>POST  temp_users&#x2F;_search<br>{<br>  “docvalue_fields”: [<br>    “name”,”desc”<br>    ]<br>}</p>\n<p>#查看整型字段的docvalues<br>POST  temp_users&#x2F;_search<br>{<br>  “docvalue_fields”: [<br>    “age”<br>    ]<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 分页与遍历 - From, Size, Search_after &amp; Scroll API</span><br></pre></td></tr></table></figure>\n\n<p>POST tmdb&#x2F;_search<br>{<br>  “from”: 10000,<br>  “size”: 1,<br>  “query”: {<br>    “match_all”: {</p>\n<pre><code>&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Scroll API<br>DELETE users</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user1”,”age”:10}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:11}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:12}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:13}</p>\n<p>POST users&#x2F;_count</p>\n<p>POST users&#x2F;_search<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all”: {}<br>    },<br>    “sort”: [<br>        {“age”: “desc”} ,<br>        {“_id”: “asc”}<br>    ]<br>}</p>\n<p>POST users&#x2F;_search<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all”: {}<br>    },<br>    “search_after”:<br>        [<br>          10,<br>          “ZQ0vYGsBrR8X3IP75QqX”],<br>    “sort”: [<br>        {“age”: “desc”} ,<br>        {“_id”: “asc”}<br>    ]<br>}</p>\n<p>#Scroll API<br>DELETE users<br>POST users&#x2F;_doc<br>{“name”:”user1”,”age”:10}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:20}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user3”,”age”:30}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user4”,”age”:40}</p>\n<p>POST &#x2F;users&#x2F;_search?scroll&#x3D;5m<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all” : {<br>        }<br>    }<br>}</p>\n<p>POST users&#x2F;_doc<br>{“name”:”user5”,”age”:50}<br>POST &#x2F;_search&#x2F;scroll<br>{<br>    “scroll” : “1m”,<br>    “scroll_id” : “DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ&#x3D;&#x3D;”<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 5.8-处理并发读写.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 处理并发读写操作</span><br></pre></td></tr></table></figure>\n\n<p>DELETE products<br>PUT products</p>\n<p>PUT products&#x2F;_doc&#x2F;1<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>\n<p>GET products&#x2F;_doc&#x2F;1</p>\n<p>PUT products&#x2F;_doc&#x2F;1?if_seq_no&#x3D;1&amp;if_primary_term&#x3D;1<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>\n<p>PUT products&#x2F;_doc&#x2F;1?version&#x3D;30000&amp;version_type&#x3D;external<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Bucket &amp; Metric Aggregation</span><br><span class=\"line\">## demos</span><br></pre></td></tr></table></figure>\n<p>DELETE &#x2F;employees<br>PUT &#x2F;employees&#x2F;<br>{<br>  “mappings” : {<br>      “properties” : {<br>        “age” : {<br>          “type” : “integer”<br>        },<br>        “gender” : {<br>          “type” : “keyword”<br>        },<br>        “job” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 50<br>            }<br>          }<br>        },<br>        “name” : {<br>          “type” : “keyword”<br>        },<br>        “salary” : {<br>          “type” : “integer”<br>        }<br>      }<br>    }<br>}</p>\n<p>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>\n<h1 id=\"Metric-聚合，找到最低的工资\"><a href=\"#Metric-聚合，找到最低的工资\" class=\"headerlink\" title=\"Metric 聚合，找到最低的工资\"></a>Metric 聚合，找到最低的工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “min_salary”: {<br>      “min”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"Metric-聚合，找到最高的工资\"><a href=\"#Metric-聚合，找到最高的工资\" class=\"headerlink\" title=\"Metric 聚合，找到最高的工资\"></a>Metric 聚合，找到最高的工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “max_salary”: {<br>      “max”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"多个-Metric-聚合，找到最低最高和平均工资\"><a href=\"#多个-Metric-聚合，找到最低最高和平均工资\" class=\"headerlink\" title=\"多个 Metric 聚合，找到最低最高和平均工资\"></a>多个 Metric 聚合，找到最低最高和平均工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “max_salary”: {<br>      “max”: {<br>        “field”: “salary”<br>      }<br>    },<br>    “min_salary”: {<br>      “min”: {<br>        “field”: “salary”<br>      }<br>    },<br>    “avg_salary”: {<br>      “avg”: {<br>        “field”: “salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"一个聚合，输出多值\"><a href=\"#一个聚合，输出多值\" class=\"headerlink\" title=\"一个聚合，输出多值\"></a>一个聚合，输出多值</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “stats_salary”: {<br>      “stats”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对keword-进行聚合\"><a href=\"#对keword-进行聚合\" class=\"headerlink\" title=\"对keword 进行聚合\"></a>对keword 进行聚合</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对-Text-字段进行-terms-聚合查询，失败\"><a href=\"#对-Text-字段进行-terms-聚合查询，失败\" class=\"headerlink\" title=\"对 Text 字段进行 terms 聚合查询，失败\"></a>对 Text 字段进行 terms 聚合查询，失败</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对-Text-字段打开-fielddata，支持terms-aggregation\"><a href=\"#对-Text-字段打开-fielddata，支持terms-aggregation\" class=\"headerlink\" title=\"对 Text 字段打开 fielddata，支持terms aggregation\"></a>对 Text 字段打开 fielddata，支持terms aggregation</h1><p>PUT employees&#x2F;_mapping<br>{<br>  “properties” : {<br>    “job”:{<br>       “type”:     “text”,<br>       “fielddata”: true<br>    }<br>  }<br>}</p>\n<h1 id=\"对-Text-字段进行-terms-分词。分词后的terms\"><a href=\"#对-Text-字段进行-terms-分词。分词后的terms\" class=\"headerlink\" title=\"对 Text 字段进行 terms 分词。分词后的terms\"></a>对 Text 字段进行 terms 分词。分词后的terms</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对job-keyword-和-job-进行-terms-聚合，分桶的总数并不一样\"><a href=\"#对job-keyword-和-job-进行-terms-聚合，分桶的总数并不一样\" class=\"headerlink\" title=\"对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样\"></a>对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “cardinate”: {<br>      “cardinality”: {<br>        “field”: “job”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"对-性别的-keyword-进行聚合\"><a href=\"#对-性别的-keyword-进行聚合\" class=\"headerlink\" title=\"对 性别的 keyword 进行聚合\"></a>对 性别的 keyword 进行聚合</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “gender”: {<br>      “terms”: {<br>        “field”:”gender”<br>      }<br>    }<br>  }<br>}</p>\n<p>#指定 bucket 的 size<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “ages_5”: {<br>      “terms”: {<br>        “field”:”age”,<br>        “size”:3<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"指定size，不同工种中，年纪最大的3个员工的具体信息\"><a href=\"#指定size，不同工种中，年纪最大的3个员工的具体信息\" class=\"headerlink\" title=\"指定size，不同工种中，年纪最大的3个员工的具体信息\"></a>指定size，不同工种中，年纪最大的3个员工的具体信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      },<br>      “aggs”:{<br>        “old_employee”:{<br>          “top_hits”:{<br>            “size”:3,<br>            “sort”:[<br>              {<br>                “age”:{<br>                  “order”:”desc”<br>                }<br>              }<br>            ]<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#Salary Ranges 分桶，可以自己定义 key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “salary_range”: {<br>      “range”: {<br>        “field”:”salary”,<br>        “ranges”:[<br>          {<br>            “to”:10000<br>          },<br>          {<br>            “from”:10000,<br>            “to”:20000<br>          },<br>          {<br>            “key”:”&gt;20000”,<br>            “from”:20000<br>          }<br>        ]<br>      }<br>    }<br>  }<br>}</p>\n<p>#Salary Histogram,工资0到10万，以 5000一个区间进行分桶<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “salary_histrogram”: {<br>      “histogram”: {<br>        “field”:”salary”,<br>        “interval”:5000,<br>        “extended_bounds”:{<br>          “min”:0,<br>          “max”:100000</p>\n<pre><code>    &#125;\n  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<h1 id=\"嵌套聚合1，按照工作类型分桶，并统计工资信息\"><a href=\"#嵌套聚合1，按照工作类型分桶，并统计工资信息\" class=\"headerlink\" title=\"嵌套聚合1，按照工作类型分桶，并统计工资信息\"></a>嵌套聚合1，按照工作类型分桶，并统计工资信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “Job_salary_stats”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      },<br>      “aggs”: {<br>        “salary”: {<br>          “stats”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\"><a href=\"#多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\" class=\"headerlink\" title=\"多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息\"></a>多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “Job_gender_stats”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      },<br>      “aggs”: {<br>        “gender_stats”: {<br>          “terms”: {<br>            “field”: “gender”<br>          },<br>          “aggs”: {<br>            “salary_stats”: {<br>              “stats”: {<br>                “field”: “salary”<br>              }<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 6.2-Pipeline聚合分析.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Pipeline 聚合分析</span><br></pre></td></tr></table></figure>\n<p>DELETE employees<br>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>\n<h1 id=\"平均工资最低的工作类型\"><a href=\"#平均工资最低的工作类型\" class=\"headerlink\" title=\"平均工资最低的工作类型\"></a>平均工资最低的工作类型</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “min_salary_by_job”:{<br>      “min_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"平均工资最高的工作类型\"><a href=\"#平均工资最高的工作类型\" class=\"headerlink\" title=\"平均工资最高的工作类型\"></a>平均工资最高的工作类型</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “max_salary_by_job”:{<br>      “max_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"平均工资的平均工资\"><a href=\"#平均工资的平均工资\" class=\"headerlink\" title=\"平均工资的平均工资\"></a>平均工资的平均工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “avg_salary_by_job”:{<br>      “avg_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"平均工资的统计分析\"><a href=\"#平均工资的统计分析\" class=\"headerlink\" title=\"平均工资的统计分析\"></a>平均工资的统计分析</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “stats_salary_by_job”:{<br>      “stats_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"平均工资的百分位数\"><a href=\"#平均工资的百分位数\" class=\"headerlink\" title=\"平均工资的百分位数\"></a>平均工资的百分位数</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “percentiles_salary_by_job”:{<br>      “percentiles_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>\n<p>#按照年龄对平均工资求导<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “derivative_avg_salary”:{<br>          “derivative”: {<br>            “buckets_path”: “avg_salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#Cumulative_sum<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “cumulative_salary”:{<br>          “cumulative_sum”: {<br>            “buckets_path”: “avg_salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#Moving Function<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “moving_avg_salary”:{<br>          “moving_fn”: {<br>            “buckets_path”: “avg_salary”,<br>            “window”:10,<br>            “script”: “MovingFunctions.min(values)”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 6.3-作用范围与排序.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 作用范围与排序</span><br></pre></td></tr></table></figure>\n<p>DELETE &#x2F;employees<br>PUT &#x2F;employees&#x2F;<br>{<br>  “mappings” : {<br>      “properties” : {<br>        “age” : {<br>          “type” : “integer”<br>        },<br>        “gender” : {<br>          “type” : “keyword”<br>        },<br>        “job” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 50<br>            }<br>          }<br>        },<br>        “name” : {<br>          “type” : “keyword”<br>        },<br>        “salary” : {<br>          “type” : “integer”<br>        }<br>      }<br>    }<br>}</p>\n<p>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>\n<h1 id=\"Query\"><a href=\"#Query\" class=\"headerlink\" title=\"Query\"></a>Query</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>\n<pre><code>  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Filter<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “older_person”: {<br>      “filter”:{<br>        “range”:{<br>          “age”:{<br>            “from”:35<br>          }<br>        }<br>      },<br>      “aggs”:{<br>         “jobs”:{<br>           “terms”: {<br>        “field”:”job.keyword”<br>      }<br>      }<br>    }},<br>    “all_jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>\n<pre><code>  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果<br>POST employees&#x2F;_search<br>{<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      }<br>    }<br>  },<br>  “post_filter”: {<br>    “match”: {<br>      “job.keyword”: “Dev Manager”<br>    }<br>  }<br>}</p>\n<p>#global<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 40<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>\n<pre><code>  &#125;\n&#125;,\n\n&quot;all&quot;:&#123;\n  &quot;global&quot;:&#123;&#125;,\n  &quot;aggs&quot;:&#123;\n    &quot;salary_avg&quot;:&#123;\n      &quot;avg&quot;:&#123;\n        &quot;field&quot;:&quot;salary&quot;\n      &#125;\n    &#125;\n  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[<br>          {“_count”:”asc”},<br>          {“_key”:”desc”}<br>          ]</p>\n<pre><code>  &#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[  {<br>            “avg_salary”:”desc”<br>          }]</p>\n<pre><code>  &#125;,\n&quot;aggs&quot;: &#123;\n  &quot;avg_salary&quot;: &#123;\n    &quot;avg&quot;: &#123;\n      &quot;field&quot;:&quot;salary&quot;\n    &#125;\n  &#125;\n&#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[  {<br>            “stats_salary.min”:”desc”<br>          }]</p>\n<pre><code>  &#125;,\n&quot;aggs&quot;: &#123;\n  &quot;stats_salary&quot;: &#123;\n    &quot;stats&quot;: &#123;\n      &quot;field&quot;:&quot;salary&quot;\n    &#125;\n  &#125;\n&#125;\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 6.4-聚合分析的原理及精准度问题.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 聚合分析的原理及精准度问题</span><br></pre></td></tr></table></figure>\n<p>DELETE my_flights<br>PUT my_flights<br>{<br>  “settings”: {<br>    “number_of_shards”: 20<br>  },<br>  “mappings” : {<br>      “properties” : {<br>        “AvgTicketPrice” : {<br>          “type” : “float”<br>        },<br>        “Cancelled” : {<br>          “type” : “boolean”<br>        },<br>        “Carrier” : {<br>          “type” : “keyword”<br>        },<br>        “Dest” : {<br>          “type” : “keyword”<br>        },<br>        “DestAirportID” : {<br>          “type” : “keyword”<br>        },<br>        “DestCityName” : {<br>          “type” : “keyword”<br>        },<br>        “DestCountry” : {<br>          “type” : “keyword”<br>        },<br>        “DestLocation” : {<br>          “type” : “geo_point”<br>        },<br>        “DestRegion” : {<br>          “type” : “keyword”<br>        },<br>        “DestWeather” : {<br>          “type” : “keyword”<br>        },<br>        “DistanceKilometers” : {<br>          “type” : “float”<br>        },<br>        “DistanceMiles” : {<br>          “type” : “float”<br>        },<br>        “FlightDelay” : {<br>          “type” : “boolean”<br>        },<br>        “FlightDelayMin” : {<br>          “type” : “integer”<br>        },<br>        “FlightDelayType” : {<br>          “type” : “keyword”<br>        },<br>        “FlightNum” : {<br>          “type” : “keyword”<br>        },<br>        “FlightTimeHour” : {<br>          “type” : “keyword”<br>        },<br>        “FlightTimeMin” : {<br>          “type” : “float”<br>        },<br>        “Origin” : {<br>          “type” : “keyword”<br>        },<br>        “OriginAirportID” : {<br>          “type” : “keyword”<br>        },<br>        “OriginCityName” : {<br>          “type” : “keyword”<br>        },<br>        “OriginCountry” : {<br>          “type” : “keyword”<br>        },<br>        “OriginLocation” : {<br>          “type” : “geo_point”<br>        },<br>        “OriginRegion” : {<br>          “type” : “keyword”<br>        },<br>        “OriginWeather” : {<br>          “type” : “keyword”<br>        },<br>        “dayOfWeek” : {<br>          “type” : “integer”<br>        },<br>        “timestamp” : {<br>          “type” : “date”<br>        }<br>      }<br>    }<br>}</p>\n<p>POST _reindex<br>{<br>  “source”: {<br>    “index”: “kibana_sample_data_flights”<br>  },<br>  “dest”: {<br>    “index”: “my_flights”<br>  }<br>}</p>\n<p>GET kibana_sample_data_flights&#x2F;_count<br>GET my_flights&#x2F;_count</p>\n<p>get kibana_sample_data_flights&#x2F;_search</p>\n<p>GET kibana_sample_data_flights&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “weather”: {<br>      “terms”: {<br>        “field”:”OriginWeather”,<br>        “size”:5,<br>        “show_term_doc_count_error”:true<br>      }<br>    }<br>  }<br>}</p>\n<p>GET my_flights&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “weather”: {<br>      “terms”: {<br>        “field”:”OriginWeather”,<br>        “size”:1,<br>        “shard_size”:1,<br>        “show_term_doc_count_error”:true<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 7.1-对象及 Nested 对象.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 对象及Nested对象</span><br></pre></td></tr></table></figure>\n<p>DELETE blog</p>\n<h1 id=\"设置blog的-Mapping\"><a href=\"#设置blog的-Mapping\" class=\"headerlink\" title=\"设置blog的 Mapping\"></a>设置blog的 Mapping</h1><p>PUT &#x2F;blog<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “content”: {<br>        “type”: “text”<br>      },<br>      “time”: {<br>        “type”: “date”<br>      },<br>      “user”: {<br>        “properties”: {<br>          “city”: {<br>            “type”: “text”<br>          },<br>          “userid”: {<br>            “type”: “long”<br>          },<br>          “username”: {<br>            “type”: “keyword”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"插入一条-Blog-信息\"><a href=\"#插入一条-Blog-信息\" class=\"headerlink\" title=\"插入一条 Blog 信息\"></a>插入一条 Blog 信息</h1><p>PUT blog&#x2F;_doc&#x2F;1<br>{<br>  “content”:”I like Elasticsearch”,<br>  “time”:”2019-01-01T00:00:00”,<br>  “user”:{<br>    “userid”:1,<br>    “username”:”Jack”,<br>    “city”:”Shanghai”<br>  }<br>}</p>\n<h1 id=\"查询-Blog-信息\"><a href=\"#查询-Blog-信息\" class=\"headerlink\" title=\"查询 Blog 信息\"></a>查询 Blog 信息</h1><p>POST blog&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“content”: “Elasticsearch”}},<br>        {“match”: {“user.username”: “Jack”}}<br>      ]<br>    }<br>  }<br>}</p>\n<p>DELETE my_movies</p>\n<h1 id=\"电影的Mapping信息\"><a href=\"#电影的Mapping信息\" class=\"headerlink\" title=\"电影的Mapping信息\"></a>电影的Mapping信息</h1><p>PUT my_movies<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “actors” : {<br>          “properties” : {<br>            “first_name” : {<br>              “type” : “keyword”<br>            },<br>            “last_name” : {<br>              “type” : “keyword”<br>            }<br>          }<br>        },<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 256<br>            }<br>          }<br>        }<br>      }<br>    }<br>}</p>\n<h1 id=\"写入一条电影信息\"><a href=\"#写入一条电影信息\" class=\"headerlink\" title=\"写入一条电影信息\"></a>写入一条电影信息</h1><p>POST my_movies&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Speed”,<br>  “actors”:[<br>    {<br>      “first_name”:”Keanu”,<br>      “last_name”:”Reeves”<br>    },</p>\n<pre><code>&#123;\n  &quot;first_name&quot;:&quot;Dennis&quot;,\n  &quot;last_name&quot;:&quot;Hopper&quot;\n&#125;\n</code></pre>\n<p>  ]<br>}</p>\n<h1 id=\"查询电影信息\"><a href=\"#查询电影信息\" class=\"headerlink\" title=\"查询电影信息\"></a>查询电影信息</h1><p>POST my_movies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“actors.first_name”: “Keanu”}},<br>        {“match”: {“actors.last_name”: “Hopper”}}<br>      ]<br>    }<br>  }</p>\n<p>}</p>\n<p>DELETE my_movies</p>\n<h1 id=\"创建-Nested-对象-Mapping\"><a href=\"#创建-Nested-对象-Mapping\" class=\"headerlink\" title=\"创建 Nested 对象 Mapping\"></a>创建 Nested 对象 Mapping</h1><p>PUT my_movies<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “actors” : {<br>          “type”: “nested”,<br>          “properties” : {<br>            “first_name” : {“type” : “keyword”},<br>            “last_name” : {“type” : “keyword”}<br>          }},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {“keyword”:{“type”:”keyword”,”ignore_above”:256}}<br>        }<br>      }<br>    }<br>}</p>\n<p>POST my_movies&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Speed”,<br>  “actors”:[<br>    {<br>      “first_name”:”Keanu”,<br>      “last_name”:”Reeves”<br>    },</p>\n<pre><code>&#123;\n  &quot;first_name&quot;:&quot;Dennis&quot;,\n  &quot;last_name&quot;:&quot;Hopper&quot;\n&#125;\n</code></pre>\n<p>  ]<br>}</p>\n<h1 id=\"Nested-查询\"><a href=\"#Nested-查询\" class=\"headerlink\" title=\"Nested 查询\"></a>Nested 查询</h1><p>POST my_movies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“title”: “Speed”}},<br>        {<br>          “nested”: {<br>            “path”: “actors”,<br>            “query”: {<br>              “bool”: {<br>                “must”: [<br>                  {“match”: {<br>                    “actors.first_name”: “Keanu”<br>                  }},</p>\n<pre><code>              &#123;&quot;match&quot;: &#123;\n                &quot;actors.last_name&quot;: &quot;Hopper&quot;\n              &#125;&#125;\n            ]\n          &#125;\n        &#125;\n      &#125;\n    &#125;\n  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<h1 id=\"Nested-Aggregation\"><a href=\"#Nested-Aggregation\" class=\"headerlink\" title=\"Nested Aggregation\"></a>Nested Aggregation</h1><p>POST my_movies&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “actors”: {<br>      “nested”: {<br>        “path”: “actors”<br>      },<br>      “aggs”: {<br>        “actor_name”: {<br>          “terms”: {<br>            “field”: “actors.first_name”,<br>            “size”: 10<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"普通-aggregation不工作\"><a href=\"#普通-aggregation不工作\" class=\"headerlink\" title=\"普通 aggregation不工作\"></a>普通 aggregation不工作</h1><p>POST my_movies&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “NAME”: {<br>      “terms”: {<br>        “field”: “actors.first_name”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 7.2-文档的父子关系.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 文档的父子关系</span><br></pre></td></tr></table></figure>\n<p>DELETE my_blogs</p>\n<h1 id=\"设定-Parent-Child-Mapping\"><a href=\"#设定-Parent-Child-Mapping\" class=\"headerlink\" title=\"设定 Parent&#x2F;Child Mapping\"></a>设定 Parent&#x2F;Child Mapping</h1><p>PUT my_blogs<br>{<br>  “settings”: {<br>    “number_of_shards”: 2<br>  },<br>  “mappings”: {<br>    “properties”: {<br>      “blog_comments_relation”: {<br>        “type”: “join”,<br>        “relations”: {<br>          “blog”: “comment”<br>        }<br>      },<br>      “content”: {<br>        “type”: “text”<br>      },<br>      “title”: {<br>        “type”: “keyword”<br>      }<br>    }<br>  }<br>}</p>\n<p>#索引父文档<br>PUT my_blogs&#x2F;_doc&#x2F;blog1<br>{<br>  “title”:”Learning Elasticsearch”,<br>  “content”:”learning ELK @ geektime”,<br>  “blog_comments_relation”:{<br>    “name”:”blog”<br>  }<br>}</p>\n<p>#索引父文档<br>PUT my_blogs&#x2F;_doc&#x2F;blog2<br>{<br>  “title”:”Learning Hadoop”,<br>  “content”:”learning Hadoop”,<br>    “blog_comments_relation”:{<br>    “name”:”blog”<br>  }<br>}</p>\n<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment1?routing&#x3D;blog1<br>{<br>  “comment”:”I am learning ELK”,<br>  “username”:”Jack”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog1”<br>  }<br>}</p>\n<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment2?routing&#x3D;blog2<br>{<br>  “comment”:”I like Hadoop!!!!!”,<br>  “username”:”Jack”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog2”<br>  }<br>}</p>\n<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2<br>{<br>  “comment”:”Hello Hadoop”,<br>  “username”:”Bob”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog2”<br>  }<br>}</p>\n<h1 id=\"查询所有文档\"><a href=\"#查询所有文档\" class=\"headerlink\" title=\"查询所有文档\"></a>查询所有文档</h1><p>POST my_blogs&#x2F;_search<br>{</p>\n<p>}</p>\n<p>#根据父文档ID查看<br>GET my_blogs&#x2F;_doc&#x2F;blog2</p>\n<h1 id=\"Parent-Id-查询\"><a href=\"#Parent-Id-查询\" class=\"headerlink\" title=\"Parent Id 查询\"></a>Parent Id 查询</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “parent_id”: {<br>      “type”: “comment”,<br>      “id”: “blog2”<br>    }<br>  }<br>}</p>\n<h1 id=\"Has-Child-查询-返回父文档\"><a href=\"#Has-Child-查询-返回父文档\" class=\"headerlink\" title=\"Has Child 查询,返回父文档\"></a>Has Child 查询,返回父文档</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “has_child”: {<br>      “type”: “comment”,<br>      “query” : {<br>                “match”: {<br>                    “username” : “Jack”<br>                }<br>            }<br>    }<br>  }<br>}</p>\n<h1 id=\"Has-Parent-查询，返回相关的子文档\"><a href=\"#Has-Parent-查询，返回相关的子文档\" class=\"headerlink\" title=\"Has Parent 查询，返回相关的子文档\"></a>Has Parent 查询，返回相关的子文档</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “has_parent”: {<br>      “parent_type”: “blog”,<br>      “query” : {<br>                “match”: {<br>                    “title” : “Learning Hadoop”<br>                }<br>            }<br>    }<br>  }<br>}</p>\n<p>#通过ID ，访问子文档<br>GET my_blogs&#x2F;_doc&#x2F;comment3<br>#通过ID和routing ，访问子文档<br>GET my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2</p>\n<p>#更新子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2<br>{<br>    “comment”: “Hello Hadoop??”,<br>    “blog_comments_relation”: {<br>      “name”: “comment”,<br>      “parent”: “blog2”<br>    }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 7.5-Elasticsearch数据建模实例.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Elasticsearch 数据建模实例</span><br></pre></td></tr></table></figure>\n<h6 id=\"Data-Modeling-Example\"><a href=\"#Data-Modeling-Example\" class=\"headerlink\" title=\"Data Modeling Example\"></a>Data Modeling Example</h6><h1 id=\"Index-一本书的信息\"><a href=\"#Index-一本书的信息\" class=\"headerlink\" title=\"Index 一本书的信息\"></a>Index 一本书的信息</h1><p>PUT books&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Mastering ElasticSearch 5.0”,<br>  “description”:”Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins”,<br>  “author”:”Bharvi Dixit”,<br>  “public_date”:”2017”,<br>  “cover_url”:”<a href=\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>}</p>\n<p>#查询自动创建的Mapping<br>GET books&#x2F;_mapping</p>\n<p>DELETE books</p>\n<p>#优化字段类型<br>PUT books<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “author” : {“type” : “keyword”},<br>        “cover_url” : {“type” : “keyword”,”index”: false},<br>        “description” : {“type” : “text”},<br>        “public_date” : {“type” : “date”},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 100<br>            }<br>          }<br>        }<br>      }<br>    }<br>}</p>\n<p>#Cover URL index 设置成false，无法对该字段进行搜索<br>POST books&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “cover_url”: {<br>        “value”: “<a href=\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>      }<br>    }<br>  }<br>}</p>\n<p>#Cover URL index 设置成false，依然支持聚合分析<br>POST books&#x2F;_search<br>{<br>  “aggs”: {<br>    “cover”: {<br>      “terms”: {<br>        “field”: “cover_url”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>\n<p>DELETE books<br>#新增 Content字段。数据量很大。选择将Source 关闭<br>PUT books<br>{<br>      “mappings” : {<br>      “_source”: {“enabled”: false},<br>      “properties” : {<br>        “author” : {“type” : “keyword”,”store”: true},<br>        “cover_url” : {“type” : “keyword”,”index”: false,”store”: true},<br>        “description” : {“type” : “text”,”store”: true},<br>         “content” : {“type” : “text”,”store”: true},<br>        “public_date” : {“type” : “date”,”store”: true},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 100<br>            }<br>          },<br>          “store”: true<br>        }<br>      }<br>    }<br>}</p>\n<h1 id=\"Index-一本书的信息-包含Content\"><a href=\"#Index-一本书的信息-包含Content\" class=\"headerlink\" title=\"Index 一本书的信息,包含Content\"></a>Index 一本书的信息,包含Content</h1><p>PUT books&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Mastering ElasticSearch 5.0”,<br>  “description”:”Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins”,<br>  “content”:”The content of the book……Indexing data, aggregation, searching.    something else. something in the way…………”,<br>  “author”:”Bharvi Dixit”,<br>  “public_date”:”2017”,<br>  “cover_url”:”<a href=\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>}</p>\n<p>#查询结果中，Source不包含数据<br>POST books&#x2F;_search<br>{}</p>\n<p>#搜索，通过store 字段显示数据，同时高亮显示 conent的内容<br>POST books&#x2F;_search<br>{<br>  “stored_fields”: [“title”,”author”,”public_date”],<br>  “query”: {<br>    “match”: {<br>      “content”: “searching”<br>    }<br>  },</p>\n<p>  “highlight”: {<br>    “fields”: {<br>      “content”:{}<br>    }<br>  }</p>\n<p>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 7.6-Elasticsearch 数据建模最佳实践.md</span><br><span class=\"line\"></span><br><span class=\"line\"># Elasticsearch 数据建模最佳实践</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Cookie-Service\"><a href=\"#Cookie-Service\" class=\"headerlink\" title=\"Cookie Service\"></a>Cookie Service</h6><p>##索引数据，dynamic mapping 会不断加入新增字段<br>PUT cookie_service&#x2F;_doc&#x2F;1<br>{<br> “url”:”<a href=\"http://www.google.com/\">www.google.com</a>“,<br> “cookies”:{<br>   “username”:”tom”,<br>   “age”:32<br> }<br>}</p>\n<p>PUT cookie_service&#x2F;_doc&#x2F;2<br>{<br> “url”:”<a href=\"http://www.amazon.com/\">www.amazon.com</a>“,<br> “cookies”:{<br>   “login”:”2019-01-01”,<br>   “email”:”<a href=\"mailto:&#120;&#x79;&#x7a;&#x40;&#97;&#x62;&#99;&#46;&#99;&#111;&#109;\">&#120;&#x79;&#x7a;&#x40;&#97;&#x62;&#99;&#46;&#99;&#111;&#109;</a>“<br> }<br>}</p>\n<p>DELETE cookie_service<br>#使用 Nested 对象，增加key&#x2F;value<br>PUT cookie_service<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “cookies”: {<br>        “type”: “nested”,<br>        “properties”: {<br>          “name”: {<br>            “type”: “keyword”<br>          },<br>          “dateValue”: {<br>            “type”: “date”<br>          },<br>          “keywordValue”: {<br>            “type”: “keyword”<br>          },<br>          “IntValue”: {<br>            “type”: “integer”<br>          }<br>        }<br>      },<br>      “url”: {<br>        “type”: “text”,<br>        “fields”: {<br>          “keyword”: {<br>            “type”: “keyword”,<br>            “ignore_above”: 256<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>##写入数据，使用key和合适类型的value字段<br>PUT cookie_service&#x2F;_doc&#x2F;1<br>{<br> “url”:”<a href=\"http://www.google.com/\">www.google.com</a>“,<br> “cookies”:[<br>    {<br>      “name”:”username”,<br>      “keywordValue”:”tom”<br>    },<br>    {<br>       “name”:”age”,<br>      “intValue”:32</p>\n<pre><code>&#125;\n</code></pre>\n<p>   ]<br> }</p>\n<p>PUT cookie_service&#x2F;_doc&#x2F;2<br>{<br> “url”:”<a href=\"http://www.amazon.com/\">www.amazon.com</a>“,<br> “cookies”:[<br>    {<br>      “name”:”login”,<br>      “dateValue”:”2019-01-01”<br>    },<br>    {<br>       “name”:”email”,<br>      “IntValue”:32</p>\n<pre><code>&#125;\n</code></pre>\n<p>   ]<br> }</p>\n<h1 id=\"Nested-查询，通过bool查询进行过滤\"><a href=\"#Nested-查询，通过bool查询进行过滤\" class=\"headerlink\" title=\"Nested 查询，通过bool查询进行过滤\"></a>Nested 查询，通过bool查询进行过滤</h1><p>POST cookie_service&#x2F;_search<br>{<br>  “query”: {<br>    “nested”: {<br>      “path”: “cookies”,<br>      “query”: {<br>        “bool”: {<br>          “filter”: [<br>            {<br>            “term”: {<br>              “cookies.name”: “age”<br>            }},<br>            {<br>              “range”:{<br>                “cookies.intValue”:{<br>                  “gte”:30<br>                }<br>              }<br>            }<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"在Mapping中加入元信息，便于管理\"><a href=\"#在Mapping中加入元信息，便于管理\" class=\"headerlink\" title=\"在Mapping中加入元信息，便于管理\"></a>在Mapping中加入元信息，便于管理</h1><p>PUT softwares&#x2F;<br>{<br>  “mappings”: {<br>    “_meta”: {<br>      “software_version_mapping”: “1.0”<br>    }<br>  }<br>}</p>\n<p>GET softwares&#x2F;_mapping<br>PUT softwares&#x2F;_doc&#x2F;1<br>{<br>  “software_version”:”7.1.0”<br>}</p>\n<p>DELETE softwares</p>\n<h1 id=\"优化-使用inner-object\"><a href=\"#优化-使用inner-object\" class=\"headerlink\" title=\"优化,使用inner object\"></a>优化,使用inner object</h1><p>PUT softwares&#x2F;<br>{<br>  “mappings”: {<br>    “_meta”: {<br>      “software_version_mapping”: “1.1”<br>    },<br>    “properties”: {<br>      “version”: {<br>        “properties”: {<br>          “display_name”: {<br>            “type”: “keyword”<br>          },<br>          “hot_fix”: {<br>            “type”: “byte”<br>          },<br>          “marjor”: {<br>            “type”: “byte”<br>          },<br>          “minor”: {<br>            “type”: “byte”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>\n<p>#通过 Inner Object 写入多个文档<br>PUT softwares&#x2F;_doc&#x2F;1<br>{<br>  “version”:{<br>  “display_name”:”7.1.0”,<br>  “marjor”:7,<br>  “minor”:1,<br>  “hot_fix”:0<br>  }</p>\n<p>}</p>\n<p>PUT softwares&#x2F;_doc&#x2F;2<br>{<br>  “version”:{<br>  “display_name”:”7.2.0”,<br>  “marjor”:7,<br>  “minor”:2,<br>  “hot_fix”:0<br>  }<br>}</p>\n<p>PUT softwares&#x2F;_doc&#x2F;3<br>{<br>  “version”:{<br>  “display_name”:”7.2.1”,<br>  “marjor”:7,<br>  “minor”:2,<br>  “hot_fix”:1<br>  }<br>}</p>\n<h1 id=\"通过-bool-查询，\"><a href=\"#通过-bool-查询，\" class=\"headerlink\" title=\"通过 bool 查询，\"></a>通过 bool 查询，</h1><p>POST softwares&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “filter”: [<br>        {<br>          “match”:{<br>            “version.marjor”:7<br>          }<br>        },<br>        {<br>          “match”:{<br>            “version.minor”:2<br>          }<br>        }</p>\n<pre><code>  ]\n&#125;\n</code></pre>\n<p>  }<br>}</p>\n<h1 id=\"Not-Null-解决聚合的问题\"><a href=\"#Not-Null-解决聚合的问题\" class=\"headerlink\" title=\"Not Null 解决聚合的问题\"></a>Not Null 解决聚合的问题</h1><p>DELETE ratings<br>PUT ratings<br>{<br>  “mappings”: {<br>      “properties”: {<br>        “rating”: {<br>          “type”: “float”,<br>          “null_value”: 1.0<br>        }<br>      }<br>    }<br>}</p>\n<p>PUT ratings&#x2F;_doc&#x2F;1<br>{<br> “rating”:5<br>}<br>PUT ratings&#x2F;_doc&#x2F;2<br>{<br> “rating”:null<br>}</p>\n<p>POST ratings&#x2F;_search<br>POST ratings&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “avg”: {<br>      “avg”: {<br>        “field”: “rating”<br>      }<br>    }<br>  }<br>}</p>\n<p>POST ratings&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “rating”: {<br>        “value”: 1<br>      }<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 7.7-第二部分总结与测验.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 第二部分总结与测验</span><br></pre></td></tr></table></figure>\n<p>DELETE test<br>PUT test&#x2F;_doc&#x2F;1<br>{<br>  “content”:”Hello World”<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content”: “Hello World”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content”: “hello world”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content.keyword”: “Hello World”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content.keyword”: “hello world”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content”: “Hello World”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content”: “hello world”<br>    }<br>  }<br>}</p>\n<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content.keyword”: “Hello World”<br>    }<br>  }<br>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 8.1-集群身份认证与用户鉴权.md</span><br><span class=\"line\"></span><br><span class=\"line\"># 集群身份认证与用户鉴权</span><br><span class=\"line\">- 如何为集群启用X-Pack Security</span><br><span class=\"line\">- 如何为内置用户设置密码</span><br><span class=\"line\">- 设置 Kibana与ElasticSearch通信鉴权</span><br><span class=\"line\">- 使用安全API创建对特定索引具有有限访问权限的用户</span><br><span class=\"line\"></span><br><span class=\"line\">This tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:</span><br><span class=\"line\"></span><br><span class=\"line\">discovery.type: single-node</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>#启动单节点<br>bin&#x2F;elasticsearch -E node.name&#x3D;node0 -E cluster.name&#x3D;geektime -E path.data&#x3D;node0_data -E http.port&#x3D;9200 -E xpack.security.enabled&#x3D;true</p>\n<p>#使用Curl访问ES，或者浏览器访问 “localhost:9200&#x2F;_cat&#x2F;nodes?pretty”。返回401错误<br>curl ‘localhost:9200&#x2F;_cat&#x2F;nodes?pretty’</p>\n<p>#运行密码设定的命令，设置ES内置用户及其初始密码。<br>bin&#x2F;elasticsearch-setup-passwords interactive</p>\n<p>curl -u elastic ‘localhost:9200&#x2F;_cat&#x2F;nodes?pretty’</p>\n<h1 id=\"修改-kibana-yml\"><a href=\"#修改-kibana-yml\" class=\"headerlink\" title=\"修改 kibana.yml\"></a>修改 kibana.yml</h1><p>elasticsearch.username: “kibana”<br>elasticsearch.password: “changeme”</p>\n<p>#启动。使用用户名，elastic，密码elastic<br>.&#x2F;bin&#x2F;kibana</p>\n<p>POST orders&#x2F;_bulk<br>{“index”:{}}<br>{“product” : “1”,”price” : 18,”payment” : “master”,”card” : “9876543210123456”,”name” : “jack”}<br>{“index”:{}}<br>{“product” : “2”,”price” : 99,”payment” : “visa”,”card” : “1234567890123456”,”name” : “bob”}</p>\n<p>#create a new role named read_only_orders, that satisfies the following criteria:<br>#The role has no cluster privileges<br>#The role only has access to indices that match the pattern sales_record<br>#The index privileges are read, and view_index_metadata</p>\n<p>#create sales_user that satisfies the following criteria:</p>\n<h1 id=\"Use-your-own-email-address\"><a href=\"#Use-your-own-email-address\" class=\"headerlink\" title=\"Use your own email address\"></a>Use your own email address</h1><h1 id=\"Assign-the-user-to-two-roles-read-only-orders-and-kibana-user\"><a href=\"#Assign-the-user-to-two-roles-read-only-orders-and-kibana-user\" class=\"headerlink\" title=\"Assign the user to two roles: read_only_orders and kibana_user\"></a>Assign the user to two roles: read_only_orders and kibana_user</h1><p>#验证读权限,可以执行<br>POST orders&#x2F;_search<br>{}</p>\n<p>#验证写权限,报错<br>POST orders&#x2F;_bulk<br>{“index”:{}}<br>{“product” : “1”,”price” : 18,”payment” : “master”,”card” : “9876543210123456”,”name” : “jack”}<br>{“index”:{}}<br>{“product” : “2”,”price” : 99,”payment” : “visa”,”card” : “1234567890123456”,”name” : “bob”}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 8.2-集群内部安全通信.md</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"生成证书\"><a href=\"#生成证书\" class=\"headerlink\" title=\"生成证书\"></a>生成证书</h1><h1 id=\"为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil-ca命令：\"><a href=\"#为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil-ca命令：\" class=\"headerlink\" title=\"为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：\"></a>为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：</h1><p>bin&#x2F;elasticsearch-certutil ca</p>\n<p>#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：<br>bin&#x2F;elasticsearch-certutil cert –ca elastic-stack-ca.p12</p>\n<p>#将证书拷贝到 config&#x2F;certs目录下<br>elastic-certificates.p12</p>\n<p>bin&#x2F;elasticsearch -E node.name&#x3D;node0 -E cluster.name&#x3D;geektime -E path.data&#x3D;node0_data -E http.port&#x3D;9200 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate -E xpack.security.transport.ssl.keystore.path&#x3D;certs&#x2F;elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path&#x3D;certs&#x2F;elastic-certificates.p12</p>\n<p>bin&#x2F;elasticsearch -E node.name&#x3D;node1 -E cluster.name&#x3D;geektime -E path.data&#x3D;node1_data -E http.port&#x3D;9201 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate -E xpack.security.transport.ssl.keystore.path&#x3D;certs&#x2F;elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path&#x3D;certs&#x2F;elastic-certificates.p12</p>\n<p>#不提供证书的节点，无法加入<br>bin&#x2F;elasticsearch -E node.name&#x3D;node2 -E cluster.name&#x3D;geektime -E path.data&#x3D;node2_data -E http.port&#x3D;9202 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"elasticsearch-yml-配置\"><a href=\"#elasticsearch-yml-配置\" class=\"headerlink\" title=\"elasticsearch.yml 配置\"></a>elasticsearch.yml 配置</h2><p>#xpack.security.transport.ssl.enabled: true<br>#xpack.security.transport.ssl.verification_mode: certificate</p>\n<p>#xpack.security.transport.ssl.keystore.path: certs&#x2F;elastic-certificates.p12<br>#xpack.security.transport.ssl.truststore.path: certs&#x2F;elastic-certificates.p12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 8.3-集群与外部间的安全通信.md</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>xpack.security.http.ssl.enabled: true<br>xpack.security.http.ssl.keystore.path: certs&#x2F;elastic-certificates.p12<br>xpack.security.http.ssl.truststore.path: certs&#x2F;elastic-certificates.p12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">```</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># ES 启用 https</span><br><span class=\"line\">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Kibana 连接 ES https</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 为kibana生成pem</span><br><span class=\"line\">openssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">elasticsearch.hosts: [&quot;https://localhost:9200&quot;]</span><br><span class=\"line\">elasticsearch.ssl.certificateAuthorities: [ &quot;/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem&quot; ]</span><br><span class=\"line\">elasticsearch.ssl.verificationMode: certificate</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 为 Kibna 配置 HTTPS</span><br><span class=\"line\"># 生成后解压，包含了instance.crt 和 instance.key</span><br><span class=\"line\">bin/elasticsearch-certutil ca --pem</span><br><span class=\"line\"></span><br><span class=\"line\">server.ssl.enabled: true</span><br><span class=\"line\">server.ssl.certificate: config/certs/instance.crt</span><br><span class=\"line\">server.ssl.key: config/certs/instance.key</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"9-1-常见的集群部署方式-md\"><a href=\"#9-1-常见的集群部署方式-md\" class=\"headerlink\" title=\"9.1-常见的集群部署方式.md\"></a>9.1-常见的集群部署方式.md</h1><h1 id=\"常见的集群部署方式\"><a href=\"#常见的集群部署方式\" class=\"headerlink\" title=\"常见的集群部署方式\"></a>常见的集群部署方式</h1><h1 id=\"9-2-Hot-Warm架构与ShardFiltering-md\"><a href=\"#9-2-Hot-Warm架构与ShardFiltering-md\" class=\"headerlink\" title=\"9.2-Hot&amp;Warm架构与ShardFiltering.md\"></a>9.2-Hot&amp;Warm架构与ShardFiltering.md</h1><h1 id=\"Hot-Warm-架构与-Shard-Filtering\"><a href=\"#Hot-Warm-架构与-Shard-Filtering\" class=\"headerlink\" title=\"Hot &amp; Warm 架构与 Shard Filtering\"></a>Hot &amp; Warm 架构与 Shard Filtering</h1><h2 id=\"课程代码\"><a href=\"#课程代码\" class=\"headerlink\" title=\"课程代码\"></a>课程代码</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 标记一个 Hot 节点</span><br><span class=\"line\">bin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 warm 节点</span><br><span class=\"line\">bin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看节点</span><br><span class=\"line\">GET /_cat/nodeattrs?v</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置到 Hot节点</span><br><span class=\"line\">PUT logs-2019-06-27</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:0,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.my_node_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 配置到 warm 节点</span><br><span class=\"line\">PUT PUT logs-2019-06-27/_settings</span><br><span class=\"line\">&#123;  </span><br><span class=\"line\">  &quot;index.routing.allocation.require.my_node_type&quot;:&quot;warm&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 1</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 2</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2</span><br><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\">DELETE my_index1/_doc/1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Fore awareness</span><br><span class=\"line\"># 标记一个 rack 1</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 2</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;,</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.force.my_rack_id.values&quot;: &quot;rack1,rack2&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">GET _cluster/settings</span><br><span class=\"line\"></span><br><span class=\"line\"># 集群黄色</span><br><span class=\"line\">GET _cluster/health</span><br><span class=\"line\"></span><br><span class=\"line\"># 副本无法分配</span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cluster/allocation/explain?pretty</span><br></pre></td></tr></table></figure>\n<h1 id=\"9-3-如何对集群进行容量规划-md\"><a href=\"#9-3-如何对集群进行容量规划-md\" class=\"headerlink\" title=\"9.3-如何对集群进行容量规划.md\"></a>9.3-如何对集群进行容量规划.md</h1><h1 id=\"如何对集群进行容量规划\"><a href=\"#如何对集群进行容量规划\" class=\"headerlink\" title=\"如何对集群进行容量规划\"></a>如何对集群进行容量规划</h1><h2 id=\"代码Demo\"><a href=\"#代码Demo\" class=\"headerlink\" title=\"代码Demo\"></a>代码Demo</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT logs_2019-06-27</span><br><span class=\"line\">PUT logs_2019-06-26</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST _aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;actions&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;add&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;logs_2019-06-27&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;logs_write&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;remove&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;logs_2019-06-26&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;logs_write&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># POST /&lt;logs-&#123;now/d&#125;/_search</span><br><span class=\"line\">POST /%3Clogs-%7Bnow%2Fd%7D%3E/_search</span><br><span class=\"line\"></span><br><span class=\"line\"># POST /&lt;logs-&#123;now/w&#125;/_search</span><br><span class=\"line\">POST /%3Clogs-%7Bnow%2Fw%7D%3E/_search</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"9-4-分片设计及管理-md\"><a href=\"#9-4-分片设计及管理-md\" class=\"headerlink\" title=\"9.4-分片设计及管理.md\"></a>9.4-分片设计及管理.md</h1><h1 id=\"分片设计及管理\"><a href=\"#分片设计及管理\" class=\"headerlink\" title=\"分片设计及管理\"></a>分片设计及管理</h1><h1 id=\"9-5-在私有云上管理与部署Elasticsearch集群-md\"><a href=\"#9-5-在私有云上管理与部署Elasticsearch集群-md\" class=\"headerlink\" title=\"9.5-在私有云上管理与部署Elasticsearch集群.md\"></a>9.5-在私有云上管理与部署Elasticsearch集群.md</h1><h1 id=\"在私有云上管理与部署-Elasticsearch-集群\"><a href=\"#在私有云上管理与部署-Elasticsearch-集群\" class=\"headerlink\" title=\"在私有云上管理与部署 Elasticsearch 集群\"></a>在私有云上管理与部署 Elasticsearch 集群</h1><h1 id=\"9-6-在公有云上管理与部署Elasticsearch集群-md\"><a href=\"#9-6-在公有云上管理与部署Elasticsearch集群-md\" class=\"headerlink\" title=\"9.6-在公有云上管理与部署Elasticsearch集群.md\"></a>9.6-在公有云上管理与部署Elasticsearch集群.md</h1><h1 id=\"在公有云上管理与部署-Elasticsearch-集群\"><a href=\"#在公有云上管理与部署-Elasticsearch-集群\" class=\"headerlink\" title=\"在公有云上管理与部署 Elasticsearch 集群\"></a>在公有云上管理与部署 Elasticsearch 集群</h1><h1 id=\"result-md\"><a href=\"#result-md\" class=\"headerlink\" title=\"result.md\"></a>result.md</h1><h1 id=\"10-1-生产环境常用配置与上线清单-md\"><a href=\"#10-1-生产环境常用配置与上线清单-md\" class=\"headerlink\" title=\"10.1-生产环境常用配置与上线清单.md\"></a>10.1-生产环境常用配置与上线清单.md</h1><h1 id=\"生产环境查用配置与线上清单\"><a href=\"#生产环境查用配置与线上清单\" class=\"headerlink\" title=\"生产环境查用配置与线上清单\"></a>生产环境查用配置与线上清单</h1><h1 id=\"10-10-一些运维相关的建议-md\"><a href=\"#10-10-一些运维相关的建议-md\" class=\"headerlink\" title=\"10.10-一些运维相关的建议.md\"></a>10.10-一些运维相关的建议.md</h1><h1 id=\"一些运维相关的建议\"><a href=\"#一些运维相关的建议\" class=\"headerlink\" title=\"一些运维相关的建议\"></a>一些运维相关的建议</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 移动一个分片从一个节点到另外一个节点</span><br><span class=\"line\"></span><br><span class=\"line\">POST _cluster/reroute</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;commands&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;move&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;index_name&quot;,</span><br><span class=\"line\">        &quot;shard&quot;: 0,</span><br><span class=\"line\">        &quot;from_node&quot;: &quot;node_name_1&quot;,</span><br><span class=\"line\">        &quot;to_node&quot;: &quot;node_name_2&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Fore the allocation of an unassinged shard with a reason</span><br><span class=\"line\"></span><br><span class=\"line\">POST _cluster/reroute?explain</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;commands&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;allocate&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;index_name&quot;,</span><br><span class=\"line\">        &quot;shard&quot;: 0,</span><br><span class=\"line\">        &quot;node&quot;: &quot;nodename&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># remove the nodes from cluster </span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.exclude._ip&quot;:&quot;the_IP_of_your_node&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Force a synced flush</span><br><span class=\"line\">POST _flush/synced</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># change the number of moving shards to balance the cluster</span><br><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;&quot;cluster.routing.allocation.cluster_concurrent_rebalance&quot;:2&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># change the number of shards being recovered simultanceously per node</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;&quot;cluster.routing.allocation.node_concurrent_recoveries&quot;:5&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Change the recovery speed</span><br><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;&quot;indices.recovery.max_bytes_per_sec&quot;: &quot;80mb&quot;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Change the number of concurrent streams for a recovery on a single node</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;&quot;indices.recovery.concurrent_streams&quot;:6&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Change the sinze of the search queue</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;transient&quot;: &#123;</span><br><span class=\"line\">    &quot;threadpool.search.queue_size&quot;:2000</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Clear the cache on a node</span><br><span class=\"line\">POST _cache/clear</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Adjust the circuit breakers</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;indices.breaker.total.limit&quot;:&quot;40%&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-2-监控Elasticsearch集群-md\"><a href=\"#10-2-监控Elasticsearch集群-md\" class=\"headerlink\" title=\"10.2-监控Elasticsearch集群.md\"></a>10.2-监控Elasticsearch集群.md</h1><h1 id=\"监控-Elasticsearch-集群-1\"><a href=\"#监控-Elasticsearch-集群-1\" class=\"headerlink\" title=\"监控 Elasticsearch 集群\"></a>监控 Elasticsearch 集群</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Node Stats：</span><br><span class=\"line\">GET _nodes/stats</span><br><span class=\"line\"></span><br><span class=\"line\">#Cluster Stats:</span><br><span class=\"line\">GET _cluster/stats</span><br><span class=\"line\"></span><br><span class=\"line\">#Index Stats:</span><br><span class=\"line\">GET kibana_sample_data_ecommerce/_stats</span><br><span class=\"line\"></span><br><span class=\"line\">#Pending Cluster Tasks API:</span><br><span class=\"line\">GET _cluster/pending_tasks</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看所有的 tasks，也支持 cancel task</span><br><span class=\"line\">GET _tasks</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _nodes/thread_pool</span><br><span class=\"line\">GET _nodes/stats/thread_pool</span><br><span class=\"line\">GET _cat/thread_pool?v</span><br><span class=\"line\">GET _nodes/hot_threads</span><br><span class=\"line\">GET _nodes/stats/thread_pool</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置 Index Slowlogs</span><br><span class=\"line\"># the first 1000 characters of the doc&#x27;s source will be logged</span><br><span class=\"line\">PUT my_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;index.indexing.slowlog&quot;:&#123;</span><br><span class=\"line\">    &quot;threshold.index&quot;:&#123;</span><br><span class=\"line\">      &quot;warn&quot;:&quot;10s&quot;,</span><br><span class=\"line\">      &quot;info&quot;: &quot;4s&quot;,</span><br><span class=\"line\">      &quot;debug&quot;:&quot;2s&quot;,</span><br><span class=\"line\">      &quot;trace&quot;:&quot;0s&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;level&quot;:&quot;trace&quot;,</span><br><span class=\"line\">    &quot;source&quot;:1000  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置查询</span><br><span class=\"line\">DELETE my_index</span><br><span class=\"line\">//&quot;0&quot; logs all queries</span><br><span class=\"line\">PUT my_index/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.search.slowlog.threshold&quot;: &#123;</span><br><span class=\"line\">      &quot;query.warn&quot;: &quot;10s&quot;,</span><br><span class=\"line\">      &quot;query.info&quot;: &quot;3s&quot;,</span><br><span class=\"line\">      &quot;query.debug&quot;: &quot;2s&quot;,</span><br><span class=\"line\">      &quot;query.trace&quot;: &quot;0s&quot;,</span><br><span class=\"line\">      &quot;fetch.warn&quot;: &quot;1s&quot;,</span><br><span class=\"line\">      &quot;fetch.info&quot;: &quot;600ms&quot;,</span><br><span class=\"line\">      &quot;fetch.debug&quot;: &quot;400ms&quot;,</span><br><span class=\"line\">      &quot;fetch.trace&quot;: &quot;0s&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET my_index</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-3-诊断集群的潜在问题-md\"><a href=\"#10-3-诊断集群的潜在问题-md\" class=\"headerlink\" title=\"10.3-诊断集群的潜在问题.md\"></a>10.3-诊断集群的潜在问题.md</h1><h1 id=\"诊断集群的潜在问题\"><a href=\"#诊断集群的潜在问题\" class=\"headerlink\" title=\"诊断集群的潜在问题\"></a>诊断集群的潜在问题</h1><h1 id=\"10-4-解决集群Yellow与Red的问题-md\"><a href=\"#10-4-解决集群Yellow与Red的问题-md\" class=\"headerlink\" title=\"10.4-解决集群Yellow与Red的问题.md\"></a>10.4-解决集群Yellow与Red的问题.md</h1><h1 id=\"集群健康与问题排查\"><a href=\"#集群健康与问题排查\" class=\"headerlink\" title=\"集群健康与问题排查\"></a>集群健康与问题排查</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#案例1</span><br><span class=\"line\">DELETE mytest</span><br><span class=\"line\">PUT mytest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:3,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:0,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hott&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 检查集群状态，查看是否有节点丢失，有多少分片无法分配</span><br><span class=\"line\">GET /_cluster/health/</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看索引级别,找到红色的索引</span><br><span class=\"line\">GET /_cluster/health?level=indices</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#查看索引的分片</span><br><span class=\"line\">GET _cluster/health?level=shards</span><br><span class=\"line\"></span><br><span class=\"line\"># Explain 变红的原因</span><br><span class=\"line\">GET /_cluster/allocation/explain</span><br><span class=\"line\"></span><br><span class=\"line\">GET /_cat/shards/mytest</span><br><span class=\"line\">GET _cat/nodeattrs</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE mytest</span><br><span class=\"line\">GET /_cluster/health/</span><br><span class=\"line\"></span><br><span class=\"line\">PUT mytest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:3,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:0,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /_cluster/health/</span><br><span class=\"line\"></span><br><span class=\"line\">#案例2, Explain 看 hot 上的 explain</span><br><span class=\"line\">DELETE mytest</span><br><span class=\"line\">PUT mytest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:1,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cluster/health</span><br><span class=\"line\">GET _cat/shards/mytest</span><br><span class=\"line\">GET /_cluster/allocation/explain</span><br><span class=\"line\"></span><br><span class=\"line\">PUT mytest/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-5-提升集群写性能-md\"><a href=\"#10-5-提升集群写性能-md\" class=\"headerlink\" title=\"10.5-提升集群写性能.md\"></a>10.5-提升集群写性能.md</h1><h1 id=\"提升集群写性能-1\"><a href=\"#提升集群写性能-1\" class=\"headerlink\" title=\"提升集群写性能\"></a>提升集群写性能</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE myindex</span><br><span class=\"line\">PUT myindex</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index&quot;: &#123;</span><br><span class=\"line\">      &quot;refresh_interval&quot;: &quot;30s&quot;,</span><br><span class=\"line\">      &quot;number_of_shards&quot;: &quot;2&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;routing&quot;: &#123;</span><br><span class=\"line\">      &quot;allocation&quot;: &#123;</span><br><span class=\"line\">        &quot;total_shards_per_node&quot;: &quot;3&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;translog&quot;: &#123;</span><br><span class=\"line\">      &quot;sync_interval&quot;: &quot;30s&quot;,</span><br><span class=\"line\">      &quot;durability&quot;: &quot;async&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;dynamic&quot;: false,</span><br><span class=\"line\">    &quot;properties&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-6-提升集群读性能-md\"><a href=\"#10-6-提升集群读性能-md\" class=\"headerlink\" title=\"10.6-提升集群读性能.md\"></a>10.6-提升集群读性能.md</h1><h1 id=\"提升集群读性能-1\"><a href=\"#提升集群读性能-1\" class=\"headerlink\" title=\"提升集群读性能\"></a>提升集群读性能</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT blogs/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;elasticsearch&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">GET blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;title&quot;: &quot;elasticsearch&quot;</span><br><span class=\"line\">        &#125;&#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      </span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;script&quot;: &#123;</span><br><span class=\"line\">          &quot;script&quot;: &#123;</span><br><span class=\"line\">            &quot;source&quot;: &quot;doc[&#x27;title.keyword&#x27;].value.length()&gt;5&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;title&quot;: &quot;elasticsearch&quot;&#125;&#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;range&quot;: &#123;</span><br><span class=\"line\">            &quot;publish_date&quot;: &#123;</span><br><span class=\"line\">              &quot;gte&quot;: 2017,</span><br><span class=\"line\">              &quot;lte&quot;: 2019</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-7-集群压力测试-md\"><a href=\"#10-7-集群压力测试-md\" class=\"headerlink\" title=\"10.7-集群压力测试.md\"></a>10.7-集群压力测试.md</h1><h1 id=\"集群压力测试-1\"><a href=\"#集群压力测试-1\" class=\"headerlink\" title=\"集群压力测试\"></a>集群压力测试</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip3 install esrally</span><br><span class=\"line\"></span><br><span class=\"line\">esrally configure</span><br><span class=\"line\"></span><br><span class=\"line\"># 只测试 1000条数据</span><br><span class=\"line\">esrally --distribution-version=7.1.0 --test-mode</span><br><span class=\"line\"></span><br><span class=\"line\"># 测试完整数据</span><br><span class=\"line\">esrally --distribution-version=7.1.0</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li><a href=\"https://github.com/elastic/rally-tracks\">https://github.com/elastic/rally-tracks</a></li>\n<li><a href=\"https://logz.io/blog/rally/\">https://logz.io/blog/rally/</a></li>\n</ul>\n<h1 id=\"10-9-缓存及使用Breaker限制内存使用-md\"><a href=\"#10-9-缓存及使用Breaker限制内存使用-md\" class=\"headerlink\" title=\"10.9-缓存及使用Breaker限制内存使用.md\"></a>10.9-缓存及使用Breaker限制内存使用.md</h1><h1 id=\"缓存及使用Circuit-Breaker限制内存使用\"><a href=\"#缓存及使用Circuit-Breaker限制内存使用\" class=\"headerlink\" title=\"缓存及使用Circuit Breaker限制内存使用\"></a>缓存及使用Circuit Breaker限制内存使用</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _cat/nodes?v</span><br><span class=\"line\"></span><br><span class=\"line\">GET _nodes/stats/indices?pretty</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/nodes?v&amp;h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/nodes?h=name,port,segments.memory,segments.index_writer_memory,fielddata.memory_size,query_cache.memory_size,request_cache.memory_size&amp;v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /_cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;persistent&quot; : &#123;</span><br><span class=\"line\">       &quot;indices.breaker.request.limit&quot; : &quot;90%&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"补充阅读\"><a href=\"#补充阅读\" class=\"headerlink\" title=\"补充阅读\"></a>补充阅读</h2><ul>\n<li><a href=\"https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker\">https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker</a></li>\n</ul>\n<h1 id=\"11-1-使用Shrink与RolloverAPI有效管理时间序列索引-md\"><a href=\"#11-1-使用Shrink与RolloverAPI有效管理时间序列索引-md\" class=\"headerlink\" title=\"11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md\"></a>11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md</h1><h1 id=\"使用-shrink与rolloverAPI有效的管理索引\"><a href=\"#使用-shrink与rolloverAPI有效的管理索引\" class=\"headerlink\" title=\"使用 shrink与rolloverAPI有效的管理索引\"></a>使用 shrink与rolloverAPI有效的管理索引</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 打开关闭索引</span><br><span class=\"line\">DELETE test</span><br><span class=\"line\">#查看索引是否存在</span><br><span class=\"line\">HEAD test</span><br><span class=\"line\"></span><br><span class=\"line\">PUT test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#关闭索引</span><br><span class=\"line\">POST /test/_close</span><br><span class=\"line\">#索引存在</span><br><span class=\"line\">HEAD test</span><br><span class=\"line\"># 无法查询</span><br><span class=\"line\">POST test/_count</span><br><span class=\"line\"></span><br><span class=\"line\">#打开索引</span><br><span class=\"line\">POST /test/_open</span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">POST test/_count</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 在一个 hot-warm-cold的集群上进行测试</span><br><span class=\"line\">GET _cat/nodes</span><br><span class=\"line\">GET _cat/nodeattrs</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_source_index</span><br><span class=\"line\">DELETE my_target_index</span><br><span class=\"line\">PUT my_source_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;settings&quot;: &#123;</span><br><span class=\"line\">   &quot;number_of_shards&quot;: 4,</span><br><span class=\"line\">   &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_source_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_source_index</span><br><span class=\"line\"></span><br><span class=\"line\"># 分片数3，会失败</span><br><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 3,</span><br><span class=\"line\">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 报错，因为没有置成 readonly</span><br><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 2,</span><br><span class=\"line\">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#将 my_source_index 设置为只读</span><br><span class=\"line\">PUT /my_source_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.blocks.write&quot;: true</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 报错，必须都在一个节点</span><br><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 2,</span><br><span class=\"line\">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_source_index</span><br><span class=\"line\">## 确保分片都在 hot</span><br><span class=\"line\">PUT my_source_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;settings&quot;: &#123;</span><br><span class=\"line\">   &quot;number_of_shards&quot;: 4,</span><br><span class=\"line\">   &quot;number_of_replicas&quot;: 0,</span><br><span class=\"line\">   &quot;index.routing.allocation.include.box_type&quot;:&quot;hot&quot;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_source_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_source_index</span><br><span class=\"line\"></span><br><span class=\"line\">#设置为只读</span><br><span class=\"line\">PUT /my_source_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.blocks.write&quot;: true</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST my_source_index/_shrink/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 2,</span><br><span class=\"line\">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_target_index</span><br><span class=\"line\"></span><br><span class=\"line\"># My target_index状态为也只读</span><br><span class=\"line\">PUT my_target_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Split Index</span><br><span class=\"line\">DELETE my_source_index</span><br><span class=\"line\">DELETE my_target_index</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_source_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;settings&quot;: &#123;</span><br><span class=\"line\">   &quot;number_of_shards&quot;: 4,</span><br><span class=\"line\">   &quot;number_of_replicas&quot;: 0</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_source_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_source_index</span><br><span class=\"line\"></span><br><span class=\"line\"># 必须是倍数</span><br><span class=\"line\">POST my_source_index/_split/my_target</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 10</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 必须是只读</span><br><span class=\"line\">POST my_source_index/_split/my_target</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 8</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#设置为只读</span><br><span class=\"line\">PUT /my_source_index/_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.blocks.write&quot;: true</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST my_source_index/_split/my_target_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;index.number_of_shards&quot;: 8,</span><br><span class=\"line\">    &quot;index.number_of_replicas&quot;:0</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards/my_target_index</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># write block</span><br><span class=\"line\">PUT my_target_index/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Rollover API</span><br><span class=\"line\">DELETE nginx-logs*</span><br><span class=\"line\"># 不设定 is_write_true</span><br><span class=\"line\"># 名字符合命名规范</span><br><span class=\"line\">PUT /nginx-logs-000001</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;nginx_logs_write&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 多次写入文档</span><br><span class=\"line\">POST nginx_logs_write/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;log&quot;:&quot;something&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /nginx_logs_write/_rollover</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;conditions&quot;: &#123;</span><br><span class=\"line\">    &quot;max_age&quot;:   &quot;1d&quot;,</span><br><span class=\"line\">    &quot;max_docs&quot;:  5,</span><br><span class=\"line\">    &quot;max_size&quot;:  &quot;5gb&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /nginx_logs_write/_count</span><br><span class=\"line\"># 查看 Alias信息</span><br><span class=\"line\">GET /nginx_logs_write</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE apache-logs*</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置 is_write_index</span><br><span class=\"line\">PUT apache-logs1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;apache_logs&quot;: &#123;</span><br><span class=\"line\">      &quot;is_write_index&quot;:true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">POST apache_logs/_count</span><br><span class=\"line\"></span><br><span class=\"line\">POST apache_logs/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 需要指定 target 的名字</span><br><span class=\"line\">POST /apache_logs/_rollover/apache-logs8xxxx</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;conditions&quot;: &#123;</span><br><span class=\"line\">    &quot;max_age&quot;:   &quot;1d&quot;,</span><br><span class=\"line\">    &quot;max_docs&quot;:  1,</span><br><span class=\"line\">    &quot;max_size&quot;:  &quot;5gb&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 查看 Alias信息</span><br><span class=\"line\">GET /apache_logs</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"11-2-索引全生命周期管理及工具介绍-md\"><a href=\"#11-2-索引全生命周期管理及工具介绍-md\" class=\"headerlink\" title=\"11.2-索引全生命周期管理及工具介绍.md\"></a>11.2-索引全生命周期管理及工具介绍.md</h1><h1 id=\"索引全生命周期管理及工具介绍\"><a href=\"#索引全生命周期管理及工具介绍\" class=\"headerlink\" title=\"索引全生命周期管理及工具介绍\"></a>索引全生命周期管理及工具介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 运行三个节点，分片 将box_type设置成 hot，warm和cold</span><br><span class=\"line\"># 具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE *</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置 1秒刷新1次，生产环境10分种刷新一次</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;indices.lifecycle.poll_interval&quot;:&quot;1s&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置 Policy</span><br><span class=\"line\">PUT /_ilm/policy/log_ilm_policy</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;policy&quot;: &#123;</span><br><span class=\"line\">    &quot;phases&quot;: &#123;</span><br><span class=\"line\">      &quot;hot&quot;: &#123;</span><br><span class=\"line\">        &quot;actions&quot;: &#123;</span><br><span class=\"line\">          &quot;rollover&quot;: &#123;</span><br><span class=\"line\">            &quot;max_docs&quot;: 5</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;warm&quot;: &#123;</span><br><span class=\"line\">        &quot;min_age&quot;: &quot;10s&quot;,</span><br><span class=\"line\">        &quot;actions&quot;: &#123;</span><br><span class=\"line\">          &quot;allocate&quot;: &#123;</span><br><span class=\"line\">            &quot;include&quot;: &#123;</span><br><span class=\"line\">              &quot;box_type&quot;: &quot;warm&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;cold&quot;: &#123;</span><br><span class=\"line\">        &quot;min_age&quot;: &quot;15s&quot;,</span><br><span class=\"line\">        &quot;actions&quot;: &#123;</span><br><span class=\"line\">          &quot;allocate&quot;: &#123;</span><br><span class=\"line\">            &quot;include&quot;: &#123;</span><br><span class=\"line\">              &quot;box_type&quot;: &quot;cold&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;delete&quot;: &#123;</span><br><span class=\"line\">        &quot;min_age&quot;: &quot;20s&quot;,</span><br><span class=\"line\">        &quot;actions&quot;: &#123;</span><br><span class=\"line\">          &quot;delete&quot;: &#123;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置索引模版</span><br><span class=\"line\">PUT /_template/log_ilm_template</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;index_patterns&quot; : [</span><br><span class=\"line\">      &quot;ilm_index-*&quot;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    &quot;settings&quot; : &#123;</span><br><span class=\"line\">      &quot;index&quot; : &#123;</span><br><span class=\"line\">        &quot;lifecycle&quot; : &#123;</span><br><span class=\"line\">          &quot;name&quot; : &quot;log_ilm_policy&quot;,</span><br><span class=\"line\">          &quot;rollover_alias&quot; : &quot;ilm_alias&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;routing&quot; : &#123;</span><br><span class=\"line\">          &quot;allocation&quot; : &#123;</span><br><span class=\"line\">            &quot;include&quot; : &#123;</span><br><span class=\"line\">              &quot;box_type&quot; : &quot;hot&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;number_of_shards&quot; : &quot;1&quot;,</span><br><span class=\"line\">        &quot;number_of_replicas&quot; : &quot;0&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;mappings&quot; : &#123; &#125;,</span><br><span class=\"line\">    &quot;aliases&quot; : &#123; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#创建索引</span><br><span class=\"line\">PUT ilm_index-000001</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 1,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;: 0,</span><br><span class=\"line\">    &quot;index.lifecycle.name&quot;: &quot;log_ilm_policy&quot;,</span><br><span class=\"line\">    &quot;index.lifecycle.rollover_alias&quot;: &quot;ilm_alias&quot;,</span><br><span class=\"line\">    &quot;index.routing.allocation.include.box_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aliases&quot;: &#123;</span><br><span class=\"line\">    &quot;ilm_alias&quot;: &#123;</span><br><span class=\"line\">      &quot;is_write_index&quot;: true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 对 Alias写入文档</span><br><span class=\"line\">POST  ilm_alias/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;dfd&quot;:&quot;dfdsf&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"12-1-Logstash入门及架构介绍-md\"><a href=\"#12-1-Logstash入门及架构介绍-md\" class=\"headerlink\" title=\"12.1-Logstash入门及架构介绍.md\"></a>12.1-Logstash入门及架构介绍.md</h1><h1 id=\"Logstash-入门及架构介绍\"><a href=\"#Logstash-入门及架构介绍\" class=\"headerlink\" title=\"Logstash 入门及架构介绍\"></a>Logstash 入门及架构介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 一个 Demo， demo 运行</span><br><span class=\"line\">sudo bin/logstash -f logstash-filter.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># demo数据</span><br><span class=\"line\">127.0.0.1 - - [11/Dec/2013:00:01:45 -0800] &quot;GET /xampp/status.php HTTP/1.1&quot; 200 3891 &quot;http://cadenza/xampp/navi.php&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># codec demo</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;line&#125;&#125;output&#123;stdout&#123;codec=&gt; rubydebug&#125;&#125;&quot;</span><br><span class=\"line\">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;json&#125;&#125;output&#123;stdout&#123;codec=&gt; rubydebug&#125;&#125;&quot;</span><br><span class=\"line\">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;line&#125;&#125;output&#123;stdout&#123;codec=&gt; dots&#125;&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo bin/logstash -f multiline-exception.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># 多行数据，异常</span><br><span class=\"line\">Exception in thread &quot;main&quot; java.lang.NullPointerException</span><br><span class=\"line\">        at com.example.myproject.Book.getTitle(Book.java:16)</span><br><span class=\"line\">        at com.example.myproject.Author.getBookTitles(Author.java:25)</span><br><span class=\"line\">        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 一个实例</span><br><span class=\"line\">https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"12-2-利用JDBC插件导入数据到Elasticsearch-md\"><a href=\"#12-2-利用JDBC插件导入数据到Elasticsearch-md\" class=\"headerlink\" title=\"12.2-利用JDBC插件导入数据到Elasticsearch.md\"></a>12.2-利用JDBC插件导入数据到Elasticsearch.md</h1><h1 id=\"Logstash插件及文档介绍\"><a href=\"#Logstash插件及文档介绍\" class=\"headerlink\" title=\"Logstash插件及文档介绍\"></a>Logstash插件及文档介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://spring.io/guides/gs/accessing-data-mysql/</span><br><span class=\"line\">create database db_example;</span><br><span class=\"line\">use db_example;</span><br><span class=\"line\">show tables;</span><br><span class=\"line\">drop table user;</span><br><span class=\"line\">select * from user;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 新增用户</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\"></span><br><span class=\"line\">#查看所有的用户</span><br><span class=\"line\">curl &#x27;localhost:8080/demo/all&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"># 更新用户</span><br><span class=\"line\">curl -X PUT localhost:8080/demo/update -d id=16 -d name=Bob2 -d email=bob2@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\"></span><br><span class=\"line\"># 删除用户</span><br><span class=\"line\">curl -X DELETE localhost:8080/demo/delete -d id=15</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">mysql-demo.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建 alias，只显示没有被标记 deleted的用户</span><br><span class=\"line\">POST /_aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;actions&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;add&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;users&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;view_users&quot;,</span><br><span class=\"line\">         &quot;filter&quot; : &#123; &quot;term&quot; : &#123; &quot;is_deleted&quot; : false &#125; &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 通过 Alias查询，查不到被标记成 deleted的用户</span><br><span class=\"line\">POST view_users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST view_users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;name.keyword&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;Jack&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;name.keyword&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;Jack&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"12-3-Beats介绍-md\"><a href=\"#12-3-Beats介绍-md\" class=\"headerlink\" title=\"12.3-Beats介绍.md\"></a>12.3-Beats介绍.md</h1><h1 id=\"Beats介绍\"><a href=\"#Beats介绍\" class=\"headerlink\" title=\"Beats介绍\"></a>Beats介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">##</span><br><span class=\"line\"># 查看 packetbeat 模块</span><br><span class=\"line\"># 设置 packetbeat 的mysql 模块</span><br><span class=\"line\"># 启动运行</span><br><span class=\"line\">#</span><br><span class=\"line\">./metricbeat modules list</span><br><span class=\"line\">./metricbeat modules enable mysql</span><br><span class=\"line\">./metricbeat setup --dashboards</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装mysql</span><br><span class=\"line\">create database db_example</span><br><span class=\"line\">use db_example;</span><br><span class=\"line\">show tables;</span><br><span class=\"line\">select * from user</span><br><span class=\"line\"></span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\">curl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ</span><br><span class=\"line\"></span><br><span class=\"line\">curl &#x27;localhost:8080/demo/all&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 配置 packetbeat</span><br><span class=\"line\"># 启动</span><br><span class=\"line\">修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控</span><br><span class=\"line\"></span><br><span class=\"line\">sudo chown root packetbeat.yml</span><br><span class=\"line\">sudo ./packetbeat setup --dashboards</span><br><span class=\"line\">sudo ./packetbeat</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 查看所有 Filebeat 模块</span><br><span class=\"line\"># 查看所有的modules</span><br><span class=\"line\">./filebeat modules list</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\">./filebeat modules enable mysql</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"13-1-使用IndexPattern配置数据-md\"><a href=\"#13-1-使用IndexPattern配置数据-md\" class=\"headerlink\" title=\"13.1-使用IndexPattern配置数据.md\"></a>13.1-使用IndexPattern配置数据.md</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">localhost:5601/status</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /logstash-2015.05.18</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;geo&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;coordinates&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /logstash-2015.05.19</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;geo&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;coordinates&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /logstash-2015.05.20</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;geo&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;coordinates&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># For Mac &amp; Windows</span><br><span class=\"line\">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/_bulk?pretty&#x27; --data-binary @logs.jsonl</span><br><span class=\"line\"></span><br><span class=\"line\">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/bank/account/_bulk?pretty&#x27; --data-binary @accounts.json</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#For Windows</span><br><span class=\"line\">Invoke-RestMethod &quot;http://localhost:9200/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;logs.jsonl&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET /_cat/indices?v</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"13-2-使用KibanaDiscover探索数据-md\"><a href=\"#13-2-使用KibanaDiscover探索数据-md\" class=\"headerlink\" title=\"13.2-使用KibanaDiscover探索数据.md\"></a>13.2-使用KibanaDiscover探索数据.md</h1><h1 id=\"使用Kibana-Discovery-探索数据\"><a href=\"#使用Kibana-Discovery-探索数据\" class=\"headerlink\" title=\"使用Kibana Discovery 探索数据\"></a>使用Kibana Discovery 探索数据</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">设置时间过滤器</span><br><span class=\"line\">搜索你的数据</span><br><span class=\"line\">根据字段进行过滤</span><br><span class=\"line\">查看文档数据</span><br><span class=\"line\">查看文档上下文</span><br><span class=\"line\">暂时字段数据统计</span><br><span class=\"line\">Save Query</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"13-3-基本可视化组件介绍-md\"><a href=\"#13-3-基本可视化组件介绍-md\" class=\"headerlink\" title=\"13.3-基本可视化组件介绍.md\"></a>13.3-基本可视化组件介绍.md</h1><h1 id=\"基本可视化组件介绍\"><a href=\"#基本可视化组件介绍\" class=\"headerlink\" title=\"基本可视化组件介绍\"></a>基本可视化组件介绍</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">PUT /shakespeare</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;speaker&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class=\"line\">    &quot;play_name&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class=\"line\">    &quot;line_id&quot;: &#123;&quot;type&quot;: &quot;integer&quot;&#125;,</span><br><span class=\"line\">    &quot;speech_number&quot;: &#123;&quot;type&quot;: &quot;integer&quot;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># For Mac &amp; Windows</span><br><span class=\"line\">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/bank/account/_bulk?pretty&#x27; --data-binary @accounts.json</span><br><span class=\"line\">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/shakespeare/_bulk?pretty&#x27; --data-binary @shakespeare.json</span><br><span class=\"line\"></span><br><span class=\"line\">#For Windows</span><br><span class=\"line\">Invoke-RestMethod &quot;http://localhost:9200/bank/account/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;accounts.json&quot;</span><br><span class=\"line\">Invoke-RestMethod &quot;http://localhost:9200/shakespeare/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;shakespeare.json&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"13-4-构建Dashboard-md\"><a href=\"#13-4-构建Dashboard-md\" class=\"headerlink\" title=\"13.4-构建Dashboard.md\"></a>13.4-构建Dashboard.md</h1><h1 id=\"构建Dashboard\"><a href=\"#构建Dashboard\" class=\"headerlink\" title=\"构建Dashboard\"></a>构建Dashboard</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 创建仪表潘</span><br><span class=\"line\">- 加载仪表盘</span><br><span class=\"line\">- 共享仪表盘</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"14-3用机器学习实现时序数据的异常检测-上-md\"><a href=\"#14-3用机器学习实现时序数据的异常检测-上-md\" class=\"headerlink\" title=\"14.3用机器学习实现时序数据的异常检测-上.md\"></a>14.3用机器学习实现时序数据的异常检测-上.md</h1><p>mkdir server_metrics<br>cd server_metrics<br>wget <a href=\"https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz\">https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz</a><br>tar -xvf server_metrics.tar.gz</p>\n<h1 id=\"14-5-用ELK进行日志管理-md\"><a href=\"#14-5-用ELK进行日志管理-md\" class=\"headerlink\" title=\"14.5-用ELK进行日志管理.md\"></a>14.5-用ELK进行日志管理.md</h1><h1 id=\"用-ELK-来做日志管理\"><a href=\"#用-ELK-来做日志管理\" class=\"headerlink\" title=\"用 ELK 来做日志管理\"></a>用 ELK 来做日志管理</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./filebeat modules list</span><br><span class=\"line\">./filebeat modules enable system</span><br><span class=\"line\">./filebeat modules enable elasticsearch</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">## 进 modules.d 编辑相应的文件，修改log路径</span><br><span class=\"line\"></span><br><span class=\"line\">./filebeat setup –dashboards</span><br><span class=\"line\"></span><br><span class=\"line\">./filebeat export template | more</span><br><span class=\"line\"></span><br><span class=\"line\">./filebeat -e</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"14-6-用Canvas做数据演示-md\"><a href=\"#14-6-用Canvas做数据演示-md\" class=\"headerlink\" title=\"14.6-用Canvas做数据演示.md\"></a>14.6-用Canvas做数据演示.md</h1><p>POST elasticoffee&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “by”: {<br>      “terms”: {<br>        “field”: “beverage.keyword”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>\n<h1 id=\"4-1-基于词项和基于全文的搜索-md\"><a href=\"#4-1-基于词项和基于全文的搜索-md\" class=\"headerlink\" title=\"4.1-基于词项和基于全文的搜索.md\"></a>4.1-基于词项和基于全文的搜索.md</h1><h1 id=\"基于词项和基于全文的搜索\"><a href=\"#基于词项和基于全文的搜索\" class=\"headerlink\" title=\"基于词项和基于全文的搜索\"></a>基于词项和基于全文的搜索</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE products</span><br><span class=\"line\">PUT products</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot;,&quot;desc&quot;:&quot;iPhone&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot;,&quot;desc&quot;:&quot;iPad&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot;,&quot;desc&quot;:&quot;MBP&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /products</span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;desc&quot;: &#123;</span><br><span class=\"line\">        //&quot;value&quot;: &quot;iPhone&quot;</span><br><span class=\"line\">        &quot;value&quot;:&quot;iphone&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;desc.keyword&quot;: &#123;</span><br><span class=\"line\">        //&quot;value&quot;: &quot;iPhone&quot;</span><br><span class=\"line\">        //&quot;value&quot;:&quot;iphone&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;productID&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  //&quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;productID.keyword&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#设置 position_increment_gap</span><br><span class=\"line\">DELETE groups</span><br><span class=\"line\">PUT groups</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;names&quot;:&#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;position_increment_gap&quot;: 0</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET groups/_mapping</span><br><span class=\"line\"></span><br><span class=\"line\">POST groups/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;names&quot;: [ &quot;John Water&quot;, &quot;Water Smith&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST groups/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_phrase&quot;: &#123;</span><br><span class=\"line\">      &quot;names&quot;: &#123;</span><br><span class=\"line\">        &quot;query&quot;: &quot;Water Water&quot;,</span><br><span class=\"line\">        &quot;slop&quot;: 100</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST groups/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_phrase&quot;: &#123;</span><br><span class=\"line\">      &quot;names&quot;: &quot;Water Smith&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-10-综合排序：Function-Score-Query-优化算分-md\"><a href=\"#4-10-综合排序：Function-Score-Query-优化算分-md\" class=\"headerlink\" title=\"4.10-综合排序：Function Score Query 优化算分.md\"></a>4.10-综合排序：Function Score Query 优化算分.md</h1><h1 id=\"综合排序：Function-Score-Query-优化算分\"><a href=\"#综合排序：Function-Score-Query-优化算分\" class=\"headerlink\" title=\"综合排序：Function Score Query 优化算分\"></a>综合排序：Function Score Query 优化算分</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE blogs</span><br><span class=\"line\">PUT /blogs/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class=\"line\">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class=\"line\">  &quot;votes&quot;:   0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /blogs/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class=\"line\">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class=\"line\">  &quot;votes&quot;:   100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /blogs/_doc/3</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class=\"line\">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class=\"line\">  &quot;votes&quot;:   1000000</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;field_value_factor&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;votes&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;field_value_factor&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class=\"line\">        &quot;modifier&quot;: &quot;log1p&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;field_value_factor&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class=\"line\">        &quot;modifier&quot;: &quot;log1p&quot; ,</span><br><span class=\"line\">        &quot;factor&quot;: 0.1</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;field_value_factor&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class=\"line\">        &quot;modifier&quot;: &quot;log1p&quot; ,</span><br><span class=\"line\">        &quot;factor&quot;: 0.1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;boost_mode&quot;: &quot;sum&quot;,</span><br><span class=\"line\">      &quot;max_boost&quot;: 3</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;function_score&quot;: &#123;</span><br><span class=\"line\">      &quot;random_score&quot;: &#123;</span><br><span class=\"line\">        &quot;seed&quot;: 911119</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-12-自动补全与基于上下文的提示-md\"><a href=\"#4-12-自动补全与基于上下文的提示-md\" class=\"headerlink\" title=\"4.12-自动补全与基于上下文的提示.md\"></a>4.12-自动补全与基于上下文的提示.md</h1><h1 id=\"自动补全与基于上下文的提示\"><a href=\"#自动补全与基于上下文的提示\" class=\"headerlink\" title=\"自动补全与基于上下文的提示\"></a>自动补全与基于上下文的提示</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE articles</span><br><span class=\"line\">PUT articles</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;title_completion&quot;:&#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;completion&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST articles/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;lucene is very cool&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;Elasticsearch builds on top of lucene&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;Elasticsearch rocks&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;elastic is the company behind ELK stack&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;title_completion&quot;: &quot;Elk stack rocks&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;&#125; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST articles/_search?pretty</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;suggest&quot;: &#123;</span><br><span class=\"line\">    &quot;article-suggester&quot;: &#123;</span><br><span class=\"line\">      &quot;prefix&quot;: &quot;elk &quot;,</span><br><span class=\"line\">      &quot;completion&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;title_completion&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE comments</span><br><span class=\"line\">PUT comments</span><br><span class=\"line\">PUT comments/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;comment_autocomplete&quot;:&#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;completion&quot;,</span><br><span class=\"line\">      &quot;contexts&quot;:[&#123;</span><br><span class=\"line\">        &quot;type&quot;:&quot;category&quot;,</span><br><span class=\"line\">        &quot;name&quot;:&quot;comment_category&quot;</span><br><span class=\"line\">      &#125;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST comments/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;I love the star war movies&quot;,</span><br><span class=\"line\">  &quot;comment_autocomplete&quot;:&#123;</span><br><span class=\"line\">    &quot;input&quot;:[&quot;star wars&quot;],</span><br><span class=\"line\">    &quot;contexts&quot;:&#123;</span><br><span class=\"line\">      &quot;comment_category&quot;:&quot;movies&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST comments/_doc</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;Where can I find a Starbucks&quot;,</span><br><span class=\"line\">  &quot;comment_autocomplete&quot;:&#123;</span><br><span class=\"line\">    &quot;input&quot;:[&quot;starbucks&quot;],</span><br><span class=\"line\">    &quot;contexts&quot;:&#123;</span><br><span class=\"line\">      &quot;comment_category&quot;:&quot;coffee&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST comments/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;suggest&quot;: &#123;</span><br><span class=\"line\">    &quot;MY_SUGGESTION&quot;: &#123;</span><br><span class=\"line\">      &quot;prefix&quot;: &quot;sta&quot;,</span><br><span class=\"line\">      &quot;completion&quot;:&#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;comment_autocomplete&quot;,</span><br><span class=\"line\">        &quot;contexts&quot;:&#123;</span><br><span class=\"line\">          &quot;comment_category&quot;:&quot;coffee&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"4-13-跨集群搜索-md\"><a href=\"#4-13-跨集群搜索-md\" class=\"headerlink\" title=\"4.13-跨集群搜索.md\"></a>4.13-跨集群搜索.md</h1><h1 id=\"跨集群搜索\"><a href=\"#跨集群搜索\" class=\"headerlink\" title=\"跨集群搜索\"></a>跨集群搜索</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//启动3个集群</span><br><span class=\"line\"></span><br><span class=\"line\">bin/elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300</span><br><span class=\"line\">bin/elasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301</span><br><span class=\"line\">bin/elasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//在每个集群上设置动态的设置</span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster&quot;: &#123;</span><br><span class=\"line\">      &quot;remote&quot;: &#123;</span><br><span class=\"line\">        &quot;cluster0&quot;: &#123;</span><br><span class=\"line\">          &quot;seeds&quot;: [</span><br><span class=\"line\">            &quot;127.0.0.1:9300&quot;</span><br><span class=\"line\">          ],</span><br><span class=\"line\">          &quot;transport.ping_schedule&quot;: &quot;30s&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;cluster1&quot;: &#123;</span><br><span class=\"line\">          &quot;seeds&quot;: [</span><br><span class=\"line\">            &quot;127.0.0.1:9301&quot;</span><br><span class=\"line\">          ],</span><br><span class=\"line\">          &quot;transport.compress&quot;: true,</span><br><span class=\"line\">          &quot;skip_unavailable&quot;: true</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;cluster2&quot;: &#123;</span><br><span class=\"line\">          &quot;seeds&quot;: [</span><br><span class=\"line\">            &quot;127.0.0.1:9302&quot;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#cURL</span><br><span class=\"line\">curl -XPUT &quot;http://localhost:9200/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -XPUT &quot;http://localhost:9201/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -XPUT &quot;http://localhost:9202/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#创建测试数据</span><br><span class=\"line\">curl -XPOST &quot;http://localhost:9200/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -XPOST &quot;http://localhost:9201/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:20&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -XPOST &quot;http://localhost:9202/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user3&quot;,&quot;age&quot;:30&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#查询</span><br><span class=\"line\">GET /users,cluster1:users,cluster2:users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;range&quot;: &#123;</span><br><span class=\"line\">      &quot;age&quot;: &#123;</span><br><span class=\"line\">        &quot;gte&quot;: 20,</span><br><span class=\"line\">        &quot;lte&quot;: 40</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"4-2-结构化搜索-md\"><a href=\"#4-2-结构化搜索-md\" class=\"headerlink\" title=\"4.2-结构化搜索.md\"></a>4.2-结构化搜索.md</h1><h1 id=\"结构化搜索\"><a href=\"#结构化搜索\" class=\"headerlink\" title=\"结构化搜索\"></a>结构化搜索</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#结构化搜索，精确匹配</span><br><span class=\"line\">DELETE products</span><br><span class=\"line\">POST /products/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET products/_mapping</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#对布尔值 match 查询，有算分</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;avaliable&quot;: true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#对布尔值，通过constant score 转成 filtering，没有算分</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;avaliable&quot;: true</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#数字类型 Term</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;price&quot;: 30</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#数字类型 terms</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;terms&quot;: &#123;</span><br><span class=\"line\">          &quot;price&quot;: [</span><br><span class=\"line\">            &quot;20&quot;,</span><br><span class=\"line\">            &quot;30&quot;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#数字 Range 查询</span><br><span class=\"line\">GET products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot; : &#123;</span><br><span class=\"line\">        &quot;constant_score&quot; : &#123;</span><br><span class=\"line\">            &quot;filter&quot; : &#123;</span><br><span class=\"line\">                &quot;range&quot; : &#123;</span><br><span class=\"line\">                    &quot;price&quot; : &#123;</span><br><span class=\"line\">                        &quot;gte&quot; : 20,</span><br><span class=\"line\">                        &quot;lte&quot;  : 30</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 日期 range</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot; : &#123;</span><br><span class=\"line\">        &quot;constant_score&quot; : &#123;</span><br><span class=\"line\">            &quot;filter&quot; : &#123;</span><br><span class=\"line\">                &quot;range&quot; : &#123;</span><br><span class=\"line\">                    &quot;date&quot; : &#123;</span><br><span class=\"line\">                      &quot;gte&quot; : &quot;now-1y&quot;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#exists查询</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;exists&quot;: &#123;</span><br><span class=\"line\">          &quot;field&quot;: &quot;date&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#处理多值字段</span><br><span class=\"line\">POST /movies/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot; : &quot;Father of the Bridge Part II&quot;,&quot;year&quot;:1995, &quot;genre&quot;:&quot;Comedy&quot;&#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot; : &quot;Dave&quot;,&quot;year&quot;:1993,&quot;genre&quot;:[&quot;Comedy&quot;,&quot;Romance&quot;] &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#处理多值字段，term 查询是包含，而不是等于</span><br><span class=\"line\">POST movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;genre.keyword&quot;: &quot;Comedy&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#字符类型 terms</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;terms&quot;: &#123;</span><br><span class=\"line\">          &quot;productID.keyword&quot;: [</span><br><span class=\"line\">            &quot;QQPX-R-3956-#aD8&quot;,</span><br><span class=\"line\">            &quot;JODL-X-1937-#pV7&quot;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;price&quot;: 30</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;date&quot;: &quot;2019-01-01&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;date&quot;: &quot;2019-01-01&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#对布尔数值</span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;avaliable&quot;: &quot;false&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;avaliable&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;false&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;price&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;20&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;price&quot;: &quot;20&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;constant_score&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;bool&quot;: &#123;</span><br><span class=\"line\">          &quot;must_not&quot;: &#123;</span><br><span class=\"line\">            &quot;exists&quot;: &#123;</span><br><span class=\"line\">              &quot;field&quot;: &quot;date&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-3-搜索的相关性算分-md\"><a href=\"#4-3-搜索的相关性算分-md\" class=\"headerlink\" title=\"4.3-搜索的相关性算分.md\"></a>4.3-搜索的相关性算分.md</h1><h1 id=\"搜索的相关性算分\"><a href=\"#搜索的相关性算分\" class=\"headerlink\" title=\"搜索的相关性算分\"></a>搜索的相关性算分</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT testscore</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 1</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT testscore/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;we use Elasticsearch to power the search&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;we like elasticsearch&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;The scoring of documents is caculated by the scoring formula&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;you know, for search&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /testscore/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  //&quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;:&quot;you&quot;</span><br><span class=\"line\">      //&quot;content&quot;: &quot;elasticsearch&quot;</span><br><span class=\"line\">      //&quot;content&quot;:&quot;the&quot;</span><br><span class=\"line\">      //&quot;content&quot;: &quot;the elasticsearch&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST testscore/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;boosting&quot; : &#123;</span><br><span class=\"line\">            &quot;positive&quot; : &#123;</span><br><span class=\"line\">                &quot;term&quot; : &#123;</span><br><span class=\"line\">                    &quot;content&quot; : &quot;elasticsearch&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;negative&quot; : &#123;</span><br><span class=\"line\">                 &quot;term&quot; : &#123;</span><br><span class=\"line\">                     &quot;content&quot; : &quot;like&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;negative_boost&quot; : 0.2</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST tmdb/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;more_like_this&quot;: &#123;</span><br><span class=\"line\">      &quot;fields&quot;: [</span><br><span class=\"line\">        &quot;title^10&quot;,&quot;overview&quot;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;like&quot;: [&#123;&quot;_id&quot;:&quot;14191&quot;&#125;],</span><br><span class=\"line\">      &quot;min_term_freq&quot;: 1,</span><br><span class=\"line\">      &quot;max_query_terms&quot;: 12</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"4-4-Query-Filtering实现多字符串多字段查询-md\"><a href=\"#4-4-Query-Filtering实现多字符串多字段查询-md\" class=\"headerlink\" title=\"4.4-Query&amp;Filtering实现多字符串多字段查询.md\"></a>4.4-Query&amp;Filtering实现多字符串多字段查询.md</h1><h1 id=\"Query-Filtering-与多字符串多字段查询\"><a href=\"#Query-Filtering-与多字符串多字段查询\" class=\"headerlink\" title=\"Query &amp; Filtering 与多字符串多字段查询\"></a>Query &amp; Filtering 与多字符串多字段查询</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /products/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#基本语法</span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot; : &#123;</span><br><span class=\"line\">      &quot;must&quot; : &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;price&quot; : &quot;30&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot; : &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;should&quot; : [</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;JODL-X-1937-#pV7&quot; &#125; &#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125; &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;minimum_should_match&quot; :1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题</span><br><span class=\"line\">POST /newmovies/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot; : &quot;Father of the Bridge Part II&quot;,&quot;year&quot;:1995, &quot;genre&quot;:&quot;Comedy&quot;,&quot;genre_count&quot;:1 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot; : &quot;Dave&quot;,&quot;year&quot;:1993,&quot;genre&quot;:[&quot;Comedy&quot;,&quot;Romance&quot;],&quot;genre_count&quot;:2 &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#must，有算分</span><br><span class=\"line\">POST /newmovies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;genre.keyword&quot;: &#123;&quot;value&quot;: &quot;Comedy&quot;&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;genre_count&quot;: &#123;&quot;value&quot;: 1&#125;&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Filter。不参与算分，结果的score是0</span><br><span class=\"line\">POST /newmovies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: [</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;genre.keyword&quot;: &#123;&quot;value&quot;: &quot;Comedy&quot;&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;genre_count&quot;: &#123;&quot;value&quot;: 1&#125;&#125;&#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Filtering Context</span><br><span class=\"line\">POST _search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot; : &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot; : &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Query Context</span><br><span class=\"line\">POST /products/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;term&quot;: &#123;</span><br><span class=\"line\">            &quot;productID.keyword&quot;: &#123;</span><br><span class=\"line\">              &quot;value&quot;: &quot;JODL-X-1937-#pV7&quot;&#125;&#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;avaliable&quot;: &#123;&quot;value&quot;: true&#125;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#嵌套，实现了 should not 逻辑</span><br><span class=\"line\">POST /products/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot;: &#123;</span><br><span class=\"line\">          &quot;price&quot;: &quot;30&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;bool&quot;: &#123;</span><br><span class=\"line\">            &quot;must_not&quot;: &#123;</span><br><span class=\"line\">              &quot;term&quot;: &#123;</span><br><span class=\"line\">                &quot;avaliable&quot;: &quot;false&quot;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;minimum_should_match&quot;: 1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Controll the Precision</span><br><span class=\"line\">POST _search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot; : &#123;</span><br><span class=\"line\">      &quot;must&quot; : &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;price&quot; : &quot;30&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot; : &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;should&quot; : [</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;JODL-X-1937-#pV7&quot; &#125; &#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125; &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;minimum_should_match&quot; :2</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST /animals/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;red&quot; &#125;&#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;quick&quot;   &#125;&#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;dog&quot;   &#125;&#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /animals/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;quick&quot; &#125;&#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;dog&quot;   &#125;&#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;bool&quot;:&#123;</span><br><span class=\"line\">            &quot;should&quot;:[</span><br><span class=\"line\">               &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class=\"line\">                 &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class=\"line\">            ]</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE blogs</span><br><span class=\"line\">POST /blogs/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123;&quot;title&quot;:&quot;Apple iPad&quot;, &quot;content&quot;:&quot;Apple iPad,Apple iPad&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123;&quot;title&quot;:&quot;Apple iPad,Apple iPad&quot;, &quot;content&quot;:&quot;Apple iPad&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;should&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;title&quot;: &#123;</span><br><span class=\"line\">            &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class=\"line\">            &quot;boost&quot;: 1.1</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;content&quot;: &#123;</span><br><span class=\"line\">            &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class=\"line\">            &quot;boost&quot;:</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;&#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE news</span><br><span class=\"line\">POST /news/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;Apple Mac&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;Apple iPad&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;content&quot;:&quot;Apple employee like Apple Pie and Apple Juice&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST news/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;apple&quot;&#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST news/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;apple&quot;&#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;pie&quot;&#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST news/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;boosting&quot;: &#123;</span><br><span class=\"line\">      &quot;positive&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;content&quot;: &quot;apple&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;negative&quot;: &#123;</span><br><span class=\"line\">        &quot;match&quot;: &#123;</span><br><span class=\"line\">          &quot;content&quot;: &quot;pie&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;negative_boost&quot;: 0.5</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-5-单字符串多字段查询-DisMaxQuery-md\"><a href=\"#4-5-单字符串多字段查询-DisMaxQuery-md\" class=\"headerlink\" title=\"4.5-单字符串多字段查询-DisMaxQuery.md\"></a>4.5-单字符串多字段查询-DisMaxQuery.md</h1><h1 id=\"单字符串多字段查询：Dis-Max-Query\"><a href=\"#单字符串多字段查询：Dis-Max-Query\" class=\"headerlink\" title=\"单字符串多字段查询：Dis Max Query\"></a>单字符串多字段查询：Dis Max Query</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">PUT /blogs/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;title&quot;: &quot;Quick brown rabbits&quot;,</span><br><span class=\"line\">    &quot;body&quot;:  &quot;Brown rabbits are commonly seen.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /blogs/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;title&quot;: &quot;Keeping pets healthy&quot;,</span><br><span class=\"line\">    &quot;body&quot;:  &quot;My quick brown fox eats rabbits on a regular basis.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;bool&quot;: &#123;</span><br><span class=\"line\">            &quot;should&quot;: [</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Brown fox&quot; &#125;&#125;,</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Brown fox&quot; &#125;&#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;dis_max&quot;: &#123;</span><br><span class=\"line\">            &quot;queries&quot;: [</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;dis_max&quot;: &#123;</span><br><span class=\"line\">            &quot;queries&quot;: [</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class=\"line\">            ],</span><br><span class=\"line\">            &quot;tie_breaker&quot;: 0.2</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-6-单字符串多字段查询-Multi-Match-md\"><a href=\"#4-6-单字符串多字段查询-Multi-Match-md\" class=\"headerlink\" title=\"4.6-单字符串多字段查询-Multi-Match.md\"></a>4.6-单字符串多字段查询-Multi-Match.md</h1><h1 id=\"单字符串多字段查询：Multi-Match\"><a href=\"#单字符串多字段查询：Multi-Match\" class=\"headerlink\" title=\"单字符串多字段查询：Multi Match\"></a>单字符串多字段查询：Multi Match</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;dis_max&quot;: &#123;</span><br><span class=\"line\">            &quot;queries&quot;: [</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class=\"line\">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class=\"line\">            ],</span><br><span class=\"line\">            &quot;tie_breaker&quot;: 0.2</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;best_fields&quot;,</span><br><span class=\"line\">      &quot;query&quot;: &quot;Quick pets&quot;,</span><br><span class=\"line\">      &quot;fields&quot;: [&quot;title&quot;,&quot;body&quot;],</span><br><span class=\"line\">      &quot;tie_breaker&quot;: 0.2,</span><br><span class=\"line\">      &quot;minimum_should_match&quot;: &quot;20%&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">        &quot;query&quot;:  &quot;Quick brown fox&quot;,</span><br><span class=\"line\">        &quot;fields&quot;: &quot;*_title&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">        &quot;query&quot;:  &quot;Quick brown fox&quot;,</span><br><span class=\"line\">        &quot;fields&quot;: [ &quot;*_title&quot;, &quot;chapter_title^2&quot; ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE /titles</span><br><span class=\"line\">PUT /titles</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;settings&quot;: &#123; &quot;number_of_shards&quot;: 1 &#125;,</span><br><span class=\"line\">    &quot;mappings&quot;: &#123;</span><br><span class=\"line\">        &quot;my_type&quot;: &#123;</span><br><span class=\"line\">            &quot;properties&quot;: &#123;</span><br><span class=\"line\">                &quot;title&quot;: &#123;</span><br><span class=\"line\">                    &quot;type&quot;:     &quot;string&quot;,</span><br><span class=\"line\">                    &quot;analyzer&quot;: &quot;english&quot;,</span><br><span class=\"line\">                    &quot;fields&quot;: &#123;</span><br><span class=\"line\">                        &quot;std&quot;:   &#123;</span><br><span class=\"line\">                            &quot;type&quot;:     &quot;string&quot;,</span><br><span class=\"line\">                            &quot;analyzer&quot;: &quot;standard&quot;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /titles</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;title&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;analyzer&quot;: &quot;english&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST titles/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;My dog barks&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I see a lot of barking dogs on the road &quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET titles/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;title&quot;: &quot;barking dogs&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE /titles</span><br><span class=\"line\">PUT /titles</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;title&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;analyzer&quot;: &quot;english&quot;,</span><br><span class=\"line\">        &quot;fields&quot;: &#123;&quot;std&quot;: &#123;&quot;type&quot;: &quot;text&quot;,&quot;analyzer&quot;: &quot;standard&quot;&#125;&#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST titles/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;My dog barks&quot; &#125;</span><br><span class=\"line\">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I see a lot of barking dogs on the road &quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /titles/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">            &quot;query&quot;:  &quot;barking dogs&quot;,</span><br><span class=\"line\">            &quot;type&quot;:   &quot;most_fields&quot;,</span><br><span class=\"line\">            &quot;fields&quot;: [ &quot;title&quot;, &quot;title.std&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /titles/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">            &quot;query&quot;:  &quot;barking dogs&quot;,</span><br><span class=\"line\">            &quot;type&quot;:   &quot;most_fields&quot;,</span><br><span class=\"line\">            &quot;fields&quot;: [ &quot;title^10&quot;, &quot;title.std&quot; ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-7-多语言及中文分词与检索-md\"><a href=\"#4-7-多语言及中文分词与检索-md\" class=\"headerlink\" title=\"4.7-多语言及中文分词与检索.md\"></a>4.7-多语言及中文分词与检索.md</h1><h1 id=\"多语言及中文分词与检索\"><a href=\"#多语言及中文分词与检索\" class=\"headerlink\" title=\"多语言及中文分词与检索\"></a>多语言及中文分词与检索</h1><ul>\n<li><p>来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”</p>\n</li>\n<li><p>你也想犯范范玮琪犯过的错吗</p>\n</li>\n<li><p>校长说衣服上除了校徽别别别的</p>\n</li>\n<li><p>这几天天天天气不好</p>\n</li>\n<li><p>我背有点驼，麻麻说“你的背得背背背背佳</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#stop word</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_index</span><br><span class=\"line\">PUT /my_index/_doc/1</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I&#x27;m happy for this fox&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index/_doc/2</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I&#x27;m not happy about my fox problem&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST my_index/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;title&quot;: &quot;not happy fox&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 `english`（英语）分析器，另一次使用 `standard`（标准）分析器:</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_index</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;blog&quot;: &#123;</span><br><span class=\"line\">      &quot;properties&quot;: &#123;</span><br><span class=\"line\">        &quot;title&quot;: &#123;</span><br><span class=\"line\">          &quot;type&quot;: &quot;string&quot;,</span><br><span class=\"line\">          &quot;analyzer&quot;: &quot;english&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;blog&quot;: &#123;</span><br><span class=\"line\">      &quot;properties&quot;: &#123;</span><br><span class=\"line\">        &quot;title&quot;: &#123;</span><br><span class=\"line\">          &quot;type&quot;: &quot;string&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: &#123;</span><br><span class=\"line\">            &quot;english&quot;: &#123;</span><br><span class=\"line\">              &quot;type&quot;:     &quot;string&quot;,</span><br><span class=\"line\">              &quot;analyzer&quot;: &quot;english&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index/blog/1</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I&#x27;m happy for this fox&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /my_index/blog/2</span><br><span class=\"line\">&#123; &quot;title&quot;: &quot;I&#x27;m not happy about my fox problem&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET /_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;:     &quot;most_fields&quot;,</span><br><span class=\"line\">      &quot;query&quot;:    &quot;not happy foxes&quot;,</span><br><span class=\"line\">      &quot;fields&quot;: [ &quot;title&quot;, &quot;title.english&quot; ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#安装插件</span><br><span class=\"line\">./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</span><br><span class=\"line\">#安装插件</span><br><span class=\"line\">bin/elasticsearch install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#ik_max_word</span><br><span class=\"line\">#ik_smart</span><br><span class=\"line\">#hanlp: hanlp默认分词</span><br><span class=\"line\">#hanlp_standard: 标准分词</span><br><span class=\"line\">#hanlp_index: 索引分词</span><br><span class=\"line\">#hanlp_nlp: NLP分词</span><br><span class=\"line\">#hanlp_n_short: N-最短路分词</span><br><span class=\"line\">#hanlp_dijkstra: 最短路分词</span><br><span class=\"line\">#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）</span><br><span class=\"line\">#hanlp_speed: 极速词典分词</span><br><span class=\"line\"></span><br><span class=\"line\">POST _analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;analyzer&quot;: &quot;hanlp_standard&quot;,</span><br><span class=\"line\">  &quot;text&quot;: [&quot;剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;     </span><br><span class=\"line\"></span><br><span class=\"line\">#Pinyin</span><br><span class=\"line\">PUT /artists/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;settings&quot; : &#123;</span><br><span class=\"line\">        &quot;analysis&quot; : &#123;</span><br><span class=\"line\">            &quot;analyzer&quot; : &#123;</span><br><span class=\"line\">                &quot;user_name_analyzer&quot; : &#123;</span><br><span class=\"line\">                    &quot;tokenizer&quot; : &quot;whitespace&quot;,</span><br><span class=\"line\">                    &quot;filter&quot; : &quot;pinyin_first_letter_and_full_pinyin_filter&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;filter&quot; : &#123;</span><br><span class=\"line\">                &quot;pinyin_first_letter_and_full_pinyin_filter&quot; : &#123;</span><br><span class=\"line\">                    &quot;type&quot; : &quot;pinyin&quot;,</span><br><span class=\"line\">                    &quot;keep_first_letter&quot; : true,</span><br><span class=\"line\">                    &quot;keep_full_pinyin&quot; : false,</span><br><span class=\"line\">                    &quot;keep_none_chinese&quot; : true,</span><br><span class=\"line\">                    &quot;keep_original&quot; : false,</span><br><span class=\"line\">                    &quot;limit_first_letter_length&quot; : 16,</span><br><span class=\"line\">                    &quot;lowercase&quot; : true,</span><br><span class=\"line\">                    &quot;trim_whitespace&quot; : true,</span><br><span class=\"line\">                    &quot;keep_none_chinese_in_first_letter&quot; : true</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET /artists/_analyze</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;text&quot;: [&quot;刘德华 张学友 郭富城 黎明 四大天王&quot;],</span><br><span class=\"line\">  &quot;analyzer&quot;: &quot;user_name_analyzer&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"相关资源\"><a href=\"#相关资源\" class=\"headerlink\" title=\"相关资源\"></a>相关资源</h2><ul>\n<li><p>Elasticsearch IK分词插件 <a href=\"https://github.com/medcl/elasticsearch-analysis-ik/releases\">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>\n</li>\n<li><p>Elasticsearch hanlp 分词插件 <a href=\"https://github.com/KennFalcon/elasticsearch-analysis-hanlp\">https://github.com/KennFalcon/elasticsearch-analysis-hanlp</a></p>\n</li>\n<li><p>分词算法综述 <a href=\"https://zhuanlan.zhihu.com/p/50444885\">https://zhuanlan.zhihu.com/p/50444885</a></p>\n</li>\n</ul>\n<h3 id=\"一些分词工具，供参考：\"><a href=\"#一些分词工具，供参考：\" class=\"headerlink\" title=\"一些分词工具，供参考：\"></a>一些分词工具，供参考：</h3><ul>\n<li>中科院计算所NLPIR <a href=\"http://ictclas.nlpir.org/nlpir/\">http://ictclas.nlpir.org/nlpir/</a></li>\n<li>ansj分词器 <a href=\"https://github.com/NLPchina/ansj_seg\">https://github.com/NLPchina/ansj_seg</a></li>\n<li>哈工大的LTP <a href=\"https://github.com/HIT-SCIR/ltp\">https://github.com/HIT-SCIR/ltp</a></li>\n<li>清华大学THULAC <a href=\"https://github.com/thunlp/THULAC\">https://github.com/thunlp/THULAC</a></li>\n<li>斯坦福分词器 <a href=\"https://nlp.stanford.edu/software/segmenter.shtml\">https://nlp.stanford.edu/software/segmenter.shtml</a></li>\n<li>Hanlp分词器 <a href=\"https://github.com/hankcs/HanLP\">https://github.com/hankcs/HanLP</a></li>\n<li>结巴分词 <a href=\"https://github.com/yanyiwu/cppjieba\">https://github.com/yanyiwu/cppjieba</a></li>\n<li>KCWS分词器(字嵌入+Bi-LSTM+CRF) <a href=\"https://github.com/koth/kcws\">https://github.com/koth/kcws</a></li>\n<li>ZPar <a href=\"https://github.com/frcchang/zpar/releases\">https://github.com/frcchang/zpar/releases</a></li>\n<li>IKAnalyzer <a href=\"https://github.com/wks/ik-analyzer\">https://github.com/wks/ik-analyzer</a></li>\n</ul>\n<h1 id=\"4-8-SpaceJam一个全文搜索的实例-md\"><a href=\"#4-8-SpaceJam一个全文搜索的实例-md\" class=\"headerlink\" title=\"4.8-SpaceJam一个全文搜索的实例.md\"></a>4.8-SpaceJam一个全文搜索的实例.md</h1><h1 id=\"Space-Jam，一次全文搜索的实例\"><a href=\"#Space-Jam，一次全文搜索的实例\" class=\"headerlink\" title=\"Space Jam，一次全文搜索的实例\"></a>Space Jam，一次全文搜索的实例</h1><h2 id=\"环境要求\"><a href=\"#环境要求\" class=\"headerlink\" title=\"环境要求\"></a>环境要求</h2><ul>\n<li>Python 2.7.15</li>\n<li>可以使用pyenv管理多个python版本（可选）</li>\n</ul>\n<h2 id=\"进入-tmdb-search目录\"><a href=\"#进入-tmdb-search目录\" class=\"headerlink\" title=\"进入 tmdb-search目录\"></a>进入 tmdb-search目录</h2><p>Run<br>pip install -r requirements.txt<br>Run python .&#x2F;ingest_tmdb_from_file.py</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST tmdb/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class=\"line\"> &quot;query&quot;: &#123;</span><br><span class=\"line\">   &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST tmdb/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">      &quot;query&quot;: &quot;basketball with cartoon aliens&quot;,</span><br><span class=\"line\">      &quot;fields&quot;: [&quot;title&quot;,&quot;overview&quot;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;highlight&quot; : &#123;</span><br><span class=\"line\">        &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;overview&quot; : &#123; &quot;pre_tags&quot; : [&quot;\\\\033[0;32;40m&quot;], &quot;post_tags&quot; : [&quot;\\\\033[0m&quot;] &#125;,</span><br><span class=\"line\">            &quot;title&quot; : &#123; &quot;pre_tags&quot; : [&quot;\\\\033[0;32;40m&quot;], &quot;post_tags&quot; : [&quot;\\\\033[0m&quot;] &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"相关\"><a href=\"#相关\" class=\"headerlink\" title=\"相关\"></a>相关</h2><ul>\n<li>Windows 安装 pyenv <a href=\"https://github.com/pyenv-win/pyenv-win\">https://github.com/pyenv-win/pyenv-win</a></li>\n<li>Mac 安装pyenv <a href=\"https://segmentfault.com/a/1190000017403221\">https://segmentfault.com/a/1190000017403221</a></li>\n<li>Linux 安装 pyenv <a href=\"https://blog.csdn.net/GX_1_11_real/article/details/80237064\">https://blog.csdn.net/GX_1_11_real/article/details/80237064</a></li>\n<li>Python.org <a href=\"https://www.python.org/\">https://www.python.org/</a></li>\n</ul>\n<h1 id=\"4-9-使用SearchTemplate和IndexAlias进行查询-md\"><a href=\"#4-9-使用SearchTemplate和IndexAlias进行查询-md\" class=\"headerlink\" title=\"4.9-使用SearchTemplate和IndexAlias进行查询.md\"></a>4.9-使用SearchTemplate和IndexAlias进行查询.md</h1><h1 id=\"使用-Search-Template-和-Index-Alias-查询\"><a href=\"#使用-Search-Template-和-Index-Alias-查询\" class=\"headerlink\" title=\"使用 Search Template 和 Index Alias 查询\"></a>使用 Search Template 和 Index Alias 查询</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _scripts/tmdb</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;script&quot;: &#123;</span><br><span class=\"line\">    &quot;lang&quot;: &quot;mustache&quot;,</span><br><span class=\"line\">    &quot;source&quot;: &#123;</span><br><span class=\"line\">      &quot;_source&quot;: [</span><br><span class=\"line\">        &quot;title&quot;,&quot;overview&quot;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;size&quot;: 20,</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;multi_match&quot;: &#123;</span><br><span class=\"line\">          &quot;query&quot;: &quot;&#123;&#123;q&#125;&#125;&quot;,</span><br><span class=\"line\">          &quot;fields&quot;: [&quot;title&quot;,&quot;overview&quot;]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">DELETE _scripts/tmdb</span><br><span class=\"line\"></span><br><span class=\"line\">GET _scripts/tmdb</span><br><span class=\"line\"></span><br><span class=\"line\">POST tmdb/_search/template</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;id&quot;:&quot;tmdb&quot;,</span><br><span class=\"line\">    &quot;params&quot;: &#123;</span><br><span class=\"line\">        &quot;q&quot;: &quot;basketball with cartoon aliens&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT movies-2019/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;:&quot;the matrix&quot;,</span><br><span class=\"line\">  &quot;rating&quot;:5</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT movies-2019/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;:&quot;Speed&quot;,</span><br><span class=\"line\">  &quot;rating&quot;:3</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST _aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;actions&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;add&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;movies-2019&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;movies-latest&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST movies-latest/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST _aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;actions&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;add&quot;: &#123;</span><br><span class=\"line\">        &quot;index&quot;: &quot;movies-2019&quot;,</span><br><span class=\"line\">        &quot;alias&quot;: &quot;movies-lastest-highrate&quot;,</span><br><span class=\"line\">        &quot;filter&quot;: &#123;</span><br><span class=\"line\">          &quot;range&quot;: &#123;</span><br><span class=\"line\">            &quot;rating&quot;: &#123;</span><br><span class=\"line\">              &quot;gte&quot;: 4</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST movies-lastest-highrate/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"5-1-集群分布式模型及选主与脑裂问题-md\"><a href=\"#5-1-集群分布式模型及选主与脑裂问题-md\" class=\"headerlink\" title=\"5.1-集群分布式模型及选主与脑裂问题.md\"></a>5.1-集群分布式模型及选主与脑裂问题.md</h1><h1 id=\"集群分布式模型及选主与脑裂问题\"><a href=\"#集群分布式模型及选主与脑裂问题\" class=\"headerlink\" title=\"集群分布式模型及选主与脑裂问题\"></a>集群分布式模型及选主与脑裂问题</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data</span><br><span class=\"line\">bin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data</span><br><span class=\"line\">bin/elasticsearch -E node.name=node3 -E cluster.name=geektime -E path.data=node3_data</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"5-2-分片与集群的故障转移-md\"><a href=\"#5-2-分片与集群的故障转移-md\" class=\"headerlink\" title=\"5.2-分片与集群的故障转移.md\"></a>5.2-分片与集群的故障转移.md</h1><h1 id=\"分片与集群的故障转移\"><a href=\"#分片与集群的故障转移\" class=\"headerlink\" title=\"分片与集群的故障转移\"></a>分片与集群的故障转移</h1><h1 id=\"5-3-文档分布式存储-md\"><a href=\"#5-3-文档分布式存储-md\" class=\"headerlink\" title=\"5.3-文档分布式存储.md\"></a>5.3-文档分布式存储.md</h1><h1 id=\"文档分布式存储\"><a href=\"#文档分布式存储\" class=\"headerlink\" title=\"文档分布式存储\"></a>文档分布式存储</h1><h1 id=\"5-4-分片及其生命周期-md\"><a href=\"#5-4-分片及其生命周期-md\" class=\"headerlink\" title=\"5.4-分片及其生命周期.md\"></a>5.4-分片及其生命周期.md</h1><h1 id=\"分片及其生命周期\"><a href=\"#分片及其生命周期\" class=\"headerlink\" title=\"分片及其生命周期\"></a>分片及其生命周期</h1><h1 id=\"5-5-剖析分布式查询及相关性评分-md\"><a href=\"#5-5-剖析分布式查询及相关性评分-md\" class=\"headerlink\" title=\"5.5-剖析分布式查询及相关性评分.md\"></a>5.5-剖析分布式查询及相关性评分.md</h1><h1 id=\"剖析分布式查询及相关性评分\"><a href=\"#剖析分布式查询及相关性评分\" class=\"headerlink\" title=\"剖析分布式查询及相关性评分\"></a>剖析分布式查询及相关性评分</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE message</span><br><span class=\"line\">PUT message</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 20</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET message</span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_doc?routing=1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;good&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_doc?routing=2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;good morning&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_doc?routing=3</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;good morning everyone&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;explain&quot;: true,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;good&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST message/_search?search_type=dfs_query_then_fetch</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;good&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"5-6-排序及DocValues-Fielddata-md\"><a href=\"#5-6-排序及DocValues-Fielddata-md\" class=\"headerlink\" title=\"5.6-排序及DocValues&amp;Fielddata.md\"></a>5.6-排序及DocValues&amp;Fielddata.md</h1><h1 id=\"排序及Doc-Values-Fielddata\"><a href=\"#排序及Doc-Values-Fielddata\" class=\"headerlink\" title=\"排序及Doc Values &amp; Fielddata\"></a>排序及Doc Values &amp; Fielddata</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#单字段排序</span><br><span class=\"line\">POST /kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 5,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;sort&quot;: [</span><br><span class=\"line\">    &#123;&quot;order_date&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#多字段排序</span><br><span class=\"line\">POST /kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 5,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;sort&quot;: [</span><br><span class=\"line\">    &#123;&quot;order_date&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;,</span><br><span class=\"line\">    &#123;&quot;_doc&quot;:&#123;&quot;order&quot;: &quot;asc&quot;&#125;&#125;,</span><br><span class=\"line\">    &#123;&quot;_score&quot;:&#123; &quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET kibana_sample_data_ecommerce/_mapping</span><br><span class=\"line\"></span><br><span class=\"line\">#对 text 字段进行排序。默认会报错，需打开fielddata</span><br><span class=\"line\">POST /kibana_sample_data_ecommerce/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 5,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;sort&quot;: [</span><br><span class=\"line\">    &#123;&quot;customer_full_name&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#打开 text的 fielddata</span><br><span class=\"line\">PUT kibana_sample_data_ecommerce/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;customer_full_name&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fielddata&quot;: true,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 256</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#关闭 keyword的 doc values</span><br><span class=\"line\">PUT test_keyword</span><br><span class=\"line\">PUT test_keyword/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;user_name&quot;:&#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;keyword&quot;,</span><br><span class=\"line\">      &quot;doc_values&quot;:false</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE test_keyword</span><br><span class=\"line\"></span><br><span class=\"line\">PUT test_text</span><br><span class=\"line\">PUT test_text/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;intro&quot;:&#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">      &quot;doc_values&quot;:true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE test_text</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE temp_users</span><br><span class=\"line\">PUT temp_users</span><br><span class=\"line\">PUT temp_users/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot;: &#123;</span><br><span class=\"line\">    &quot;name&quot;:&#123;&quot;type&quot;: &quot;text&quot;,&quot;fielddata&quot;: true&#125;,</span><br><span class=\"line\">    &quot;desc&quot;:&#123;&quot;type&quot;: &quot;text&quot;,&quot;fielddata&quot;: true&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Post temp_users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;Jack&quot;,&quot;desc&quot;:&quot;Jack is a good boy!&quot;,&quot;age&quot;:10&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#打开fielddata 后，查看 docvalue_fields数据</span><br><span class=\"line\">POST  temp_users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;docvalue_fields&quot;: [</span><br><span class=\"line\">    &quot;name&quot;,&quot;desc&quot;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#查看整型字段的docvalues</span><br><span class=\"line\">POST  temp_users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;docvalue_fields&quot;: [</span><br><span class=\"line\">    &quot;age&quot;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"5-7-分页与遍历-FromSize-SearchAfter-ScrollAPI-md\"><a href=\"#5-7-分页与遍历-FromSize-SearchAfter-ScrollAPI-md\" class=\"headerlink\" title=\"5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md\"></a>5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md</h1><h1 id=\"分页与遍历-From-Size-Search-after-Scroll-API\"><a href=\"#分页与遍历-From-Size-Search-after-Scroll-API\" class=\"headerlink\" title=\"分页与遍历 - From, Size, Search_after &amp; Scroll API\"></a>分页与遍历 - From, Size, Search_after &amp; Scroll API</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">POST tmdb/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;from&quot;: 10000,</span><br><span class=\"line\">  &quot;size&quot;: 1,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Scroll API</span><br><span class=\"line\">DELETE users</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:11&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:12&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:13&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_count</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;size&quot;: 1,</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;sort&quot;: [</span><br><span class=\"line\">        &#123;&quot;age&quot;: &quot;desc&quot;&#125; ,</span><br><span class=\"line\">        &#123;&quot;_id&quot;: &quot;asc&quot;&#125;    </span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;size&quot;: 1,</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;search_after&quot;:</span><br><span class=\"line\">        [</span><br><span class=\"line\">          10,</span><br><span class=\"line\">          &quot;ZQ0vYGsBrR8X3IP75QqX&quot;],</span><br><span class=\"line\">    &quot;sort&quot;: [</span><br><span class=\"line\">        &#123;&quot;age&quot;: &quot;desc&quot;&#125; ,</span><br><span class=\"line\">        &#123;&quot;_id&quot;: &quot;asc&quot;&#125;    </span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Scroll API</span><br><span class=\"line\">DELETE users</span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:20&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user3&quot;,&quot;age&quot;:30&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user4&quot;,&quot;age&quot;:40&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /users/_search?scroll=5m</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;size&quot;: 1,</span><br><span class=\"line\">    &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;match_all&quot; : &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST users/_doc</span><br><span class=\"line\">&#123;&quot;name&quot;:&quot;user5&quot;,&quot;age&quot;:50&#125;</span><br><span class=\"line\">POST /_search/scroll</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;scroll&quot; : &quot;1m&quot;,</span><br><span class=\"line\">    &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ==&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"5-8-处理并发读写-md\"><a href=\"#5-8-处理并发读写-md\" class=\"headerlink\" title=\"5.8-处理并发读写.md\"></a>5.8-处理并发读写.md</h1><h1 id=\"处理并发读写操作\"><a href=\"#处理并发读写操作\" class=\"headerlink\" title=\"处理并发读写操作\"></a>处理并发读写操作</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">DELETE products</span><br><span class=\"line\">PUT products</span><br><span class=\"line\"></span><br><span class=\"line\">PUT products/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class=\"line\">  &quot;count&quot;:100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET products/_doc/1</span><br><span class=\"line\"></span><br><span class=\"line\">PUT products/_doc/1?if_seq_no=1&amp;if_primary_term=1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class=\"line\">  &quot;count&quot;:100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT products/_doc/1?version=30000&amp;version_type=external</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class=\"line\">  &quot;count&quot;:100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"6-1-Bucket-Metric聚合分析及嵌套聚合-md\"><a href=\"#6-1-Bucket-Metric聚合分析及嵌套聚合-md\" class=\"headerlink\" title=\"6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md\"></a>6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md</h1><h1 id=\"Bucket-Metric-Aggregation\"><a href=\"#Bucket-Metric-Aggregation\" class=\"headerlink\" title=\"Bucket &amp; Metric Aggregation\"></a>Bucket &amp; Metric Aggregation</h1><h2 id=\"demos\"><a href=\"#demos\" class=\"headerlink\" title=\"demos\"></a>demos</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE /employees</span><br><span class=\"line\">PUT /employees/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;age&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;gender&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;job&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 50</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;name&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;salary&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /employees/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Metric 聚合，找到最低的工资</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;min_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;min&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Metric 聚合，找到最高的工资</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;max_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;max&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 多个 Metric 聚合，找到最低最高和平均工资</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;max_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;max&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;min_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;min&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;avg&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 一个聚合，输出多值</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;stats_salary&quot;: &#123;</span><br><span class=\"line\">      &quot;stats&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对keword 进行聚合</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对 Text 字段进行 terms 聚合查询，失败</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 对 Text 字段打开 fielddata，支持terms aggregation</span><br><span class=\"line\">PUT employees/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;properties&quot; : &#123;</span><br><span class=\"line\">    &quot;job&quot;:&#123;</span><br><span class=\"line\">       &quot;type&quot;:     &quot;text&quot;,</span><br><span class=\"line\">       &quot;fielddata&quot;: true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对 Text 字段进行 terms 分词。分词后的terms</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;cardinate&quot;: &#123;</span><br><span class=\"line\">      &quot;cardinality&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 对 性别的 keyword 进行聚合</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;gender&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;gender&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#指定 bucket 的 size</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;ages_5&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;age&quot;,</span><br><span class=\"line\">        &quot;size&quot;:3</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 指定size，不同工种中，年纪最大的3个员工的具体信息</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;:&#123;</span><br><span class=\"line\">        &quot;old_employee&quot;:&#123;</span><br><span class=\"line\">          &quot;top_hits&quot;:&#123;</span><br><span class=\"line\">            &quot;size&quot;:3,</span><br><span class=\"line\">            &quot;sort&quot;:[</span><br><span class=\"line\">              &#123;</span><br><span class=\"line\">                &quot;age&quot;:&#123;</span><br><span class=\"line\">                  &quot;order&quot;:&quot;desc&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Salary Ranges 分桶，可以自己定义 key</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;salary_range&quot;: &#123;</span><br><span class=\"line\">      &quot;range&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;,</span><br><span class=\"line\">        &quot;ranges&quot;:[</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            &quot;to&quot;:10000</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            &quot;from&quot;:10000,</span><br><span class=\"line\">            &quot;to&quot;:20000</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            &quot;key&quot;:&quot;&gt;20000&quot;,</span><br><span class=\"line\">            &quot;from&quot;:20000</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Salary Histogram,工资0到10万，以 5000一个区间进行分桶</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;salary_histrogram&quot;: &#123;</span><br><span class=\"line\">      &quot;histogram&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;salary&quot;,</span><br><span class=\"line\">        &quot;interval&quot;:5000,</span><br><span class=\"line\">        &quot;extended_bounds&quot;:&#123;</span><br><span class=\"line\">          &quot;min&quot;:0,</span><br><span class=\"line\">          &quot;max&quot;:100000</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 嵌套聚合1，按照工作类型分桶，并统计工资信息</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;Job_salary_stats&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;salary&quot;: &#123;</span><br><span class=\"line\">          &quot;stats&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;Job_gender_stats&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;gender_stats&quot;: &#123;</span><br><span class=\"line\">          &quot;terms&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;gender&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;aggs&quot;: &#123;</span><br><span class=\"line\">            &quot;salary_stats&quot;: &#123;</span><br><span class=\"line\">              &quot;stats&quot;: &#123;</span><br><span class=\"line\">                &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"6-2-Pipeline聚合分析-md\"><a href=\"#6-2-Pipeline聚合分析-md\" class=\"headerlink\" title=\"6.2-Pipeline聚合分析.md\"></a>6.2-Pipeline聚合分析.md</h1><h1 id=\"Pipeline-聚合分析\"><a href=\"#Pipeline-聚合分析\" class=\"headerlink\" title=\"Pipeline 聚合分析\"></a>Pipeline 聚合分析</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE employees</span><br><span class=\"line\">PUT /employees/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资最低的工作类型</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;min_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;min_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资最高的工作类型</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;max_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;max_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资的平均工资</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;avg_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;avg_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资的统计分析</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;stats_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;stats_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 平均工资的百分位数</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;percentiles_salary_by_job&quot;:&#123;</span><br><span class=\"line\">      &quot;percentiles_bucket&quot;: &#123;</span><br><span class=\"line\">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#按照年龄对平均工资求导</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;age&quot;: &#123;</span><br><span class=\"line\">      &quot;histogram&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;age&quot;,</span><br><span class=\"line\">        &quot;min_doc_count&quot;: 1,</span><br><span class=\"line\">        &quot;interval&quot;: 1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;derivative_avg_salary&quot;:&#123;</span><br><span class=\"line\">          &quot;derivative&quot;: &#123;</span><br><span class=\"line\">            &quot;buckets_path&quot;: &quot;avg_salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Cumulative_sum</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;age&quot;: &#123;</span><br><span class=\"line\">      &quot;histogram&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;age&quot;,</span><br><span class=\"line\">        &quot;min_doc_count&quot;: 1,</span><br><span class=\"line\">        &quot;interval&quot;: 1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;cumulative_salary&quot;:&#123;</span><br><span class=\"line\">          &quot;cumulative_sum&quot;: &#123;</span><br><span class=\"line\">            &quot;buckets_path&quot;: &quot;avg_salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Moving Function</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;age&quot;: &#123;</span><br><span class=\"line\">      &quot;histogram&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;age&quot;,</span><br><span class=\"line\">        &quot;min_doc_count&quot;: 1,</span><br><span class=\"line\">        &quot;interval&quot;: 1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">          &quot;avg&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;moving_avg_salary&quot;:&#123;</span><br><span class=\"line\">          &quot;moving_fn&quot;: &#123;</span><br><span class=\"line\">            &quot;buckets_path&quot;: &quot;avg_salary&quot;,</span><br><span class=\"line\">            &quot;window&quot;:10,</span><br><span class=\"line\">            &quot;script&quot;: &quot;MovingFunctions.min(values)&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-3-作用范围与排序-md\"><a href=\"#6-3-作用范围与排序-md\" class=\"headerlink\" title=\"6.3-作用范围与排序.md\"></a>6.3-作用范围与排序.md</h1><h1 id=\"作用范围与排序\"><a href=\"#作用范围与排序\" class=\"headerlink\" title=\"作用范围与排序\"></a>作用范围与排序</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE /employees</span><br><span class=\"line\">PUT /employees/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;age&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;gender&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;job&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 50</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;name&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;salary&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT /employees/_bulk</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class=\"line\">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class=\"line\">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Query</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;range&quot;: &#123;</span><br><span class=\"line\">      &quot;age&quot;: &#123;</span><br><span class=\"line\">        &quot;gte&quot;: 20</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Filter</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;older_person&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;:&#123;</span><br><span class=\"line\">        &quot;range&quot;:&#123;</span><br><span class=\"line\">          &quot;age&quot;:&#123;</span><br><span class=\"line\">            &quot;from&quot;:35</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;:&#123;</span><br><span class=\"line\">         &quot;jobs&quot;:&#123;</span><br><span class=\"line\">           &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;&#125;,</span><br><span class=\"line\">    &quot;all_jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;post_filter&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;job.keyword&quot;: &quot;Dev Manager&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#global</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;range&quot;: &#123;</span><br><span class=\"line\">      &quot;age&quot;: &#123;</span><br><span class=\"line\">        &quot;gte&quot;: 40</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    </span><br><span class=\"line\">    &quot;all&quot;:&#123;</span><br><span class=\"line\">      &quot;global&quot;:&#123;&#125;,</span><br><span class=\"line\">      &quot;aggs&quot;:&#123;</span><br><span class=\"line\">        &quot;salary_avg&quot;:&#123;</span><br><span class=\"line\">          &quot;avg&quot;:&#123;</span><br><span class=\"line\">            &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#排序 order</span><br><span class=\"line\">#count and key</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;range&quot;: &#123;</span><br><span class=\"line\">      &quot;age&quot;: &#123;</span><br><span class=\"line\">        &quot;gte&quot;: 20</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;order&quot;:[</span><br><span class=\"line\">          &#123;&quot;_count&quot;:&quot;asc&quot;&#125;,</span><br><span class=\"line\">          &#123;&quot;_key&quot;:&quot;desc&quot;&#125;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#排序 order</span><br><span class=\"line\">#count and key</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;order&quot;:[  &#123;</span><br><span class=\"line\">            &quot;avg_salary&quot;:&quot;desc&quot;</span><br><span class=\"line\">          &#125;]</span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &quot;aggs&quot;: &#123;</span><br><span class=\"line\">      &quot;avg_salary&quot;: &#123;</span><br><span class=\"line\">        &quot;avg&quot;: &#123;</span><br><span class=\"line\">          &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#排序 order</span><br><span class=\"line\">#count and key</span><br><span class=\"line\">POST employees/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;jobs&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class=\"line\">        &quot;order&quot;:[  &#123;</span><br><span class=\"line\">            &quot;stats_salary.min&quot;:&quot;desc&quot;</span><br><span class=\"line\">          &#125;]</span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &quot;aggs&quot;: &#123;</span><br><span class=\"line\">      &quot;stats_salary&quot;: &#123;</span><br><span class=\"line\">        &quot;stats&quot;: &#123;</span><br><span class=\"line\">          &quot;field&quot;:&quot;salary&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-4-聚合分析的原理及精准度问题-md\"><a href=\"#6-4-聚合分析的原理及精准度问题-md\" class=\"headerlink\" title=\"6.4-聚合分析的原理及精准度问题.md\"></a>6.4-聚合分析的原理及精准度问题.md</h1><h1 id=\"聚合分析的原理及精准度问题\"><a href=\"#聚合分析的原理及精准度问题\" class=\"headerlink\" title=\"聚合分析的原理及精准度问题\"></a>聚合分析的原理及精准度问题</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE my_flights</span><br><span class=\"line\">PUT my_flights</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 20</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;AvgTicketPrice&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;float&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Cancelled&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;boolean&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Carrier&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Dest&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestAirportID&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestCityName&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestCountry&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestLocation&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;geo_point&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestRegion&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DestWeather&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DistanceKilometers&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;float&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;DistanceMiles&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;float&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightDelay&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;boolean&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightDelayMin&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightDelayType&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightNum&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightTimeHour&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;FlightTimeMin&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;float&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Origin&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginAirportID&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginCityName&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginCountry&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginLocation&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;geo_point&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginRegion&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;OriginWeather&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;dayOfWeek&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;integer&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;timestamp&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;date&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST _reindex</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;source&quot;: &#123;</span><br><span class=\"line\">    &quot;index&quot;: &quot;kibana_sample_data_flights&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;dest&quot;: &#123;</span><br><span class=\"line\">    &quot;index&quot;: &quot;my_flights&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET kibana_sample_data_flights/_count</span><br><span class=\"line\">GET my_flights/_count</span><br><span class=\"line\"></span><br><span class=\"line\">get kibana_sample_data_flights/_search</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET kibana_sample_data_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;weather&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;OriginWeather&quot;,</span><br><span class=\"line\">        &quot;size&quot;:5,</span><br><span class=\"line\">        &quot;show_term_doc_count_error&quot;:true</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET my_flights/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;weather&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;:&quot;OriginWeather&quot;,</span><br><span class=\"line\">        &quot;size&quot;:1,</span><br><span class=\"line\">        &quot;shard_size&quot;:1,</span><br><span class=\"line\">        &quot;show_term_doc_count_error&quot;:true</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-1-对象及-Nested-对象-md\"><a href=\"#7-1-对象及-Nested-对象-md\" class=\"headerlink\" title=\"7.1-对象及 Nested 对象.md\"></a>7.1-对象及 Nested 对象.md</h1><h1 id=\"对象及Nested对象\"><a href=\"#对象及Nested对象\" class=\"headerlink\" title=\"对象及Nested对象\"></a>对象及Nested对象</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE blog</span><br><span class=\"line\"># 设置blog的 Mapping</span><br><span class=\"line\">PUT /blog</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;time&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;date&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;user&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;city&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;text&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;userid&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;long&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;username&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 插入一条 Blog 信息</span><br><span class=\"line\">PUT blog/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;I like Elasticsearch&quot;,</span><br><span class=\"line\">  &quot;time&quot;:&quot;2019-01-01T00:00:00&quot;,</span><br><span class=\"line\">  &quot;user&quot;:&#123;</span><br><span class=\"line\">    &quot;userid&quot;:1,</span><br><span class=\"line\">    &quot;username&quot;:&quot;Jack&quot;,</span><br><span class=\"line\">    &quot;city&quot;:&quot;Shanghai&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 查询 Blog 信息</span><br><span class=\"line\">POST blog/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;content&quot;: &quot;Elasticsearch&quot;&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;user.username&quot;: &quot;Jack&quot;&#125;&#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_movies</span><br><span class=\"line\"></span><br><span class=\"line\"># 电影的Mapping信息</span><br><span class=\"line\">PUT my_movies</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;actors&quot; : &#123;</span><br><span class=\"line\">          &quot;properties&quot; : &#123;</span><br><span class=\"line\">            &quot;first_name&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;last_name&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;title&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 256</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 写入一条电影信息</span><br><span class=\"line\">POST my_movies/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Speed&quot;,</span><br><span class=\"line\">  &quot;actors&quot;:[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;first_name&quot;:&quot;Keanu&quot;,</span><br><span class=\"line\">      &quot;last_name&quot;:&quot;Reeves&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;first_name&quot;:&quot;Dennis&quot;,</span><br><span class=\"line\">      &quot;last_name&quot;:&quot;Hopper&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 查询电影信息</span><br><span class=\"line\">POST my_movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;actors.first_name&quot;: &quot;Keanu&quot;&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;actors.last_name&quot;: &quot;Hopper&quot;&#125;&#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE my_movies</span><br><span class=\"line\"># 创建 Nested 对象 Mapping</span><br><span class=\"line\">PUT my_movies</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;actors&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot;: &quot;nested&quot;,</span><br><span class=\"line\">          &quot;properties&quot; : &#123;</span><br><span class=\"line\">            &quot;first_name&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;,</span><br><span class=\"line\">            &quot;last_name&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;</span><br><span class=\"line\">          &#125;&#125;,</span><br><span class=\"line\">        &quot;title&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;&quot;keyword&quot;:&#123;&quot;type&quot;:&quot;keyword&quot;,&quot;ignore_above&quot;:256&#125;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST my_movies/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Speed&quot;,</span><br><span class=\"line\">  &quot;actors&quot;:[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;first_name&quot;:&quot;Keanu&quot;,</span><br><span class=\"line\">      &quot;last_name&quot;:&quot;Reeves&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;first_name&quot;:&quot;Dennis&quot;,</span><br><span class=\"line\">      &quot;last_name&quot;:&quot;Hopper&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Nested 查询</span><br><span class=\"line\">POST my_movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;must&quot;: [</span><br><span class=\"line\">        &#123;&quot;match&quot;: &#123;&quot;title&quot;: &quot;Speed&quot;&#125;&#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;nested&quot;: &#123;</span><br><span class=\"line\">            &quot;path&quot;: &quot;actors&quot;,</span><br><span class=\"line\">            &quot;query&quot;: &#123;</span><br><span class=\"line\">              &quot;bool&quot;: &#123;</span><br><span class=\"line\">                &quot;must&quot;: [</span><br><span class=\"line\">                  &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">                    &quot;actors.first_name&quot;: &quot;Keanu&quot;</span><br><span class=\"line\">                  &#125;&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">                  &#123;&quot;match&quot;: &#123;</span><br><span class=\"line\">                    &quot;actors.last_name&quot;: &quot;Hopper&quot;</span><br><span class=\"line\">                  &#125;&#125;</span><br><span class=\"line\">                ]</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Nested Aggregation</span><br><span class=\"line\">POST my_movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;actors&quot;: &#123;</span><br><span class=\"line\">      &quot;nested&quot;: &#123;</span><br><span class=\"line\">        &quot;path&quot;: &quot;actors&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;aggs&quot;: &#123;</span><br><span class=\"line\">        &quot;actor_name&quot;: &#123;</span><br><span class=\"line\">          &quot;terms&quot;: &#123;</span><br><span class=\"line\">            &quot;field&quot;: &quot;actors.first_name&quot;,</span><br><span class=\"line\">            &quot;size&quot;: 10</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 普通 aggregation不工作</span><br><span class=\"line\">POST my_movies/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;NAME&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;actors.first_name&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-2-文档的父子关系-md\"><a href=\"#7-2-文档的父子关系-md\" class=\"headerlink\" title=\"7.2-文档的父子关系.md\"></a>7.2-文档的父子关系.md</h1><h1 id=\"文档的父子关系\"><a href=\"#文档的父子关系\" class=\"headerlink\" title=\"文档的父子关系\"></a>文档的父子关系</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE my_blogs</span><br><span class=\"line\"></span><br><span class=\"line\"># 设定 Parent/Child Mapping</span><br><span class=\"line\">PUT my_blogs</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;: &#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;: 2</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;blog_comments_relation&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;join&quot;,</span><br><span class=\"line\">        &quot;relations&quot;: &#123;</span><br><span class=\"line\">          &quot;blog&quot;: &quot;comment&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;content&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;title&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#索引父文档</span><br><span class=\"line\">PUT my_blogs/_doc/blog1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Learning Elasticsearch&quot;,</span><br><span class=\"line\">  &quot;content&quot;:&quot;learning ELK @ geektime&quot;,</span><br><span class=\"line\">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;blog&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#索引父文档</span><br><span class=\"line\">PUT my_blogs/_doc/blog2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Learning Hadoop&quot;,</span><br><span class=\"line\">  &quot;content&quot;:&quot;learning Hadoop&quot;,</span><br><span class=\"line\">    &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;blog&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#索引子文档</span><br><span class=\"line\">PUT my_blogs/_doc/comment1?routing=blog1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;I am learning ELK&quot;,</span><br><span class=\"line\">  &quot;username&quot;:&quot;Jack&quot;,</span><br><span class=\"line\">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class=\"line\">    &quot;parent&quot;:&quot;blog1&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#索引子文档</span><br><span class=\"line\">PUT my_blogs/_doc/comment2?routing=blog2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;I like Hadoop!!!!!&quot;,</span><br><span class=\"line\">  &quot;username&quot;:&quot;Jack&quot;,</span><br><span class=\"line\">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class=\"line\">    &quot;parent&quot;:&quot;blog2&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#索引子文档</span><br><span class=\"line\">PUT my_blogs/_doc/comment3?routing=blog2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;comment&quot;:&quot;Hello Hadoop&quot;,</span><br><span class=\"line\">  &quot;username&quot;:&quot;Bob&quot;,</span><br><span class=\"line\">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class=\"line\">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class=\"line\">    &quot;parent&quot;:&quot;blog2&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 查询所有文档</span><br><span class=\"line\">POST my_blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#根据父文档ID查看</span><br><span class=\"line\">GET my_blogs/_doc/blog2</span><br><span class=\"line\"></span><br><span class=\"line\"># Parent Id 查询</span><br><span class=\"line\">POST my_blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;parent_id&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;comment&quot;,</span><br><span class=\"line\">      &quot;id&quot;: &quot;blog2&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># Has Child 查询,返回父文档</span><br><span class=\"line\">POST my_blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;has_child&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;comment&quot;,</span><br><span class=\"line\">      &quot;query&quot; : &#123;</span><br><span class=\"line\">                &quot;match&quot;: &#123;</span><br><span class=\"line\">                    &quot;username&quot; : &quot;Jack&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Has Parent 查询，返回相关的子文档</span><br><span class=\"line\">POST my_blogs/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;has_parent&quot;: &#123;</span><br><span class=\"line\">      &quot;parent_type&quot;: &quot;blog&quot;,</span><br><span class=\"line\">      &quot;query&quot; : &#123;</span><br><span class=\"line\">                &quot;match&quot;: &#123;</span><br><span class=\"line\">                    &quot;title&quot; : &quot;Learning Hadoop&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#通过ID ，访问子文档</span><br><span class=\"line\">GET my_blogs/_doc/comment3</span><br><span class=\"line\">#通过ID和routing ，访问子文档</span><br><span class=\"line\">GET my_blogs/_doc/comment3?routing=blog2</span><br><span class=\"line\"></span><br><span class=\"line\">#更新子文档</span><br><span class=\"line\">PUT my_blogs/_doc/comment3?routing=blog2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;comment&quot;: &quot;Hello Hadoop??&quot;,</span><br><span class=\"line\">    &quot;blog_comments_relation&quot;: &#123;</span><br><span class=\"line\">      &quot;name&quot;: &quot;comment&quot;,</span><br><span class=\"line\">      &quot;parent&quot;: &quot;blog2&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-5-Elasticsearch数据建模实例-md\"><a href=\"#7-5-Elasticsearch数据建模实例-md\" class=\"headerlink\" title=\"7.5-Elasticsearch数据建模实例.md\"></a>7.5-Elasticsearch数据建模实例.md</h1><h1 id=\"Elasticsearch-数据建模实例\"><a href=\"#Elasticsearch-数据建模实例\" class=\"headerlink\" title=\"Elasticsearch 数据建模实例\"></a>Elasticsearch 数据建模实例</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">###### Data Modeling Example</span><br><span class=\"line\"></span><br><span class=\"line\"># Index 一本书的信息</span><br><span class=\"line\">PUT books/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Mastering ElasticSearch 5.0&quot;,</span><br><span class=\"line\">  &quot;description&quot;:&quot;Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins&quot;,</span><br><span class=\"line\">  &quot;author&quot;:&quot;Bharvi Dixit&quot;,</span><br><span class=\"line\">  &quot;public_date&quot;:&quot;2017&quot;,</span><br><span class=\"line\">  &quot;cover_url&quot;:&quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#查询自动创建的Mapping</span><br><span class=\"line\">GET books/_mapping</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE books</span><br><span class=\"line\"></span><br><span class=\"line\">#优化字段类型</span><br><span class=\"line\">PUT books</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;author&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;,</span><br><span class=\"line\">        &quot;cover_url&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;index&quot;: false&#125;,</span><br><span class=\"line\">        &quot;description&quot; : &#123;&quot;type&quot; : &quot;text&quot;&#125;,</span><br><span class=\"line\">        &quot;public_date&quot; : &#123;&quot;type&quot; : &quot;date&quot;&#125;,</span><br><span class=\"line\">        &quot;title&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 100</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Cover URL index 设置成false，无法对该字段进行搜索</span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;cover_url&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: &quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Cover URL index 设置成false，依然支持聚合分析</span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;cover&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;cover_url&quot;,</span><br><span class=\"line\">        &quot;size&quot;: 10</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE books</span><br><span class=\"line\">#新增 Content字段。数据量很大。选择将Source 关闭</span><br><span class=\"line\">PUT books</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      &quot;mappings&quot; : &#123;</span><br><span class=\"line\">      &quot;_source&quot;: &#123;&quot;enabled&quot;: false&#125;,</span><br><span class=\"line\">      &quot;properties&quot; : &#123;</span><br><span class=\"line\">        &quot;author&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">        &quot;cover_url&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;index&quot;: false,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">        &quot;description&quot; : &#123;&quot;type&quot; : &quot;text&quot;,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">         &quot;content&quot; : &#123;&quot;type&quot; : &quot;text&quot;,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">        &quot;public_date&quot; : &#123;&quot;type&quot; : &quot;date&quot;,&quot;store&quot;: true&#125;,</span><br><span class=\"line\">        &quot;title&quot; : &#123;</span><br><span class=\"line\">          &quot;type&quot; : &quot;text&quot;,</span><br><span class=\"line\">          &quot;fields&quot; : &#123;</span><br><span class=\"line\">            &quot;keyword&quot; : &#123;</span><br><span class=\"line\">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class=\"line\">              &quot;ignore_above&quot; : 100</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;store&quot;: true</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Index 一本书的信息,包含Content</span><br><span class=\"line\">PUT books/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;title&quot;:&quot;Mastering ElasticSearch 5.0&quot;,</span><br><span class=\"line\">  &quot;description&quot;:&quot;Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins&quot;,</span><br><span class=\"line\">  &quot;content&quot;:&quot;The content of the book......Indexing data, aggregation, searching.    something else. something in the way............&quot;,</span><br><span class=\"line\">  &quot;author&quot;:&quot;Bharvi Dixit&quot;,</span><br><span class=\"line\">  &quot;public_date&quot;:&quot;2017&quot;,</span><br><span class=\"line\">  &quot;cover_url&quot;:&quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#查询结果中，Source不包含数据</span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#搜索，通过store 字段显示数据，同时高亮显示 conent的内容</span><br><span class=\"line\">POST books/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;stored_fields&quot;: [&quot;title&quot;,&quot;author&quot;,&quot;public_date&quot;],</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;searching&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">  &quot;highlight&quot;: &#123;</span><br><span class=\"line\">    &quot;fields&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;:&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-6-Elasticsearch-数据建模最佳实践-md\"><a href=\"#7-6-Elasticsearch-数据建模最佳实践-md\" class=\"headerlink\" title=\"7.6-Elasticsearch 数据建模最佳实践.md\"></a>7.6-Elasticsearch 数据建模最佳实践.md</h1><h1 id=\"Elasticsearch-数据建模最佳实践\"><a href=\"#Elasticsearch-数据建模最佳实践\" class=\"headerlink\" title=\"Elasticsearch 数据建模最佳实践\"></a>Elasticsearch 数据建模最佳实践</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">###### Cookie Service</span><br><span class=\"line\"></span><br><span class=\"line\">##索引数据，dynamic mapping 会不断加入新增字段</span><br><span class=\"line\">PUT cookie_service/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;url&quot;:&quot;www.google.com&quot;,</span><br><span class=\"line\"> &quot;cookies&quot;:&#123;</span><br><span class=\"line\">   &quot;username&quot;:&quot;tom&quot;,</span><br><span class=\"line\">   &quot;age&quot;:32</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT cookie_service/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;url&quot;:&quot;www.amazon.com&quot;,</span><br><span class=\"line\"> &quot;cookies&quot;:&#123;</span><br><span class=\"line\">   &quot;login&quot;:&quot;2019-01-01&quot;,</span><br><span class=\"line\">   &quot;email&quot;:&quot;xyz@abc.com&quot;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DELETE cookie_service</span><br><span class=\"line\">#使用 Nested 对象，增加key/value</span><br><span class=\"line\">PUT cookie_service</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;cookies&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;nested&quot;,</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;name&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;dateValue&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;date&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;keywordValue&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;IntValue&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;integer&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;url&quot;: &#123;</span><br><span class=\"line\">        &quot;type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;fields&quot;: &#123;</span><br><span class=\"line\">          &quot;keyword&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class=\"line\">            &quot;ignore_above&quot;: 256</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">##写入数据，使用key和合适类型的value字段</span><br><span class=\"line\">PUT cookie_service/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;url&quot;:&quot;www.google.com&quot;,</span><br><span class=\"line\"> &quot;cookies&quot;:[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;name&quot;:&quot;username&quot;,</span><br><span class=\"line\">      &quot;keywordValue&quot;:&quot;tom&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">       &quot;name&quot;:&quot;age&quot;,</span><br><span class=\"line\">      &quot;intValue&quot;:32</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   ]</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT cookie_service/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;url&quot;:&quot;www.amazon.com&quot;,</span><br><span class=\"line\"> &quot;cookies&quot;:[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;name&quot;:&quot;login&quot;,</span><br><span class=\"line\">      &quot;dateValue&quot;:&quot;2019-01-01&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">       &quot;name&quot;:&quot;email&quot;,</span><br><span class=\"line\">      &quot;IntValue&quot;:32</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   ]</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Nested 查询，通过bool查询进行过滤</span><br><span class=\"line\">POST cookie_service/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;nested&quot;: &#123;</span><br><span class=\"line\">      &quot;path&quot;: &quot;cookies&quot;,</span><br><span class=\"line\">      &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;bool&quot;: &#123;</span><br><span class=\"line\">          &quot;filter&quot;: [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">            &quot;term&quot;: &#123;</span><br><span class=\"line\">              &quot;cookies.name&quot;: &quot;age&quot;</span><br><span class=\"line\">            &#125;&#125;,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              &quot;range&quot;:&#123;</span><br><span class=\"line\">                &quot;cookies.intValue&quot;:&#123;</span><br><span class=\"line\">                  &quot;gte&quot;:30</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 在Mapping中加入元信息，便于管理</span><br><span class=\"line\">PUT softwares/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;_meta&quot;: &#123;</span><br><span class=\"line\">      &quot;software_version_mapping&quot;: &quot;1.0&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GET softwares/_mapping</span><br><span class=\"line\">PUT softwares/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;software_version&quot;:&quot;7.1.0&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DELETE softwares</span><br><span class=\"line\"># 优化,使用inner object</span><br><span class=\"line\">PUT softwares/</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;_meta&quot;: &#123;</span><br><span class=\"line\">      &quot;software_version_mapping&quot;: &quot;1.1&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;properties&quot;: &#123;</span><br><span class=\"line\">      &quot;version&quot;: &#123;</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">          &quot;display_name&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;hot_fix&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;byte&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;marjor&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;byte&quot;</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &quot;minor&quot;: &#123;</span><br><span class=\"line\">            &quot;type&quot;: &quot;byte&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#通过 Inner Object 写入多个文档</span><br><span class=\"line\">PUT softwares/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;version&quot;:&#123;</span><br><span class=\"line\">  &quot;display_name&quot;:&quot;7.1.0&quot;,</span><br><span class=\"line\">  &quot;marjor&quot;:7,</span><br><span class=\"line\">  &quot;minor&quot;:1,</span><br><span class=\"line\">  &quot;hot_fix&quot;:0  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT softwares/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;version&quot;:&#123;</span><br><span class=\"line\">  &quot;display_name&quot;:&quot;7.2.0&quot;,</span><br><span class=\"line\">  &quot;marjor&quot;:7,</span><br><span class=\"line\">  &quot;minor&quot;:2,</span><br><span class=\"line\">  &quot;hot_fix&quot;:0  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT softwares/_doc/3</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;version&quot;:&#123;</span><br><span class=\"line\">  &quot;display_name&quot;:&quot;7.2.1&quot;,</span><br><span class=\"line\">  &quot;marjor&quot;:7,</span><br><span class=\"line\">  &quot;minor&quot;:2,</span><br><span class=\"line\">  &quot;hot_fix&quot;:1  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 通过 bool 查询，</span><br><span class=\"line\">POST softwares/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">      &quot;filter&quot;: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;match&quot;:&#123;</span><br><span class=\"line\">            &quot;version.marjor&quot;:7</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;match&quot;:&#123;</span><br><span class=\"line\">            &quot;version.minor&quot;:2</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Not Null 解决聚合的问题</span><br><span class=\"line\">DELETE ratings</span><br><span class=\"line\">PUT ratings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;mappings&quot;: &#123;</span><br><span class=\"line\">      &quot;properties&quot;: &#123;</span><br><span class=\"line\">        &quot;rating&quot;: &#123;</span><br><span class=\"line\">          &quot;type&quot;: &quot;float&quot;,</span><br><span class=\"line\">          &quot;null_value&quot;: 1.0</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT ratings/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;rating&quot;:5</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">PUT ratings/_doc/2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;rating&quot;:null</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST ratings/_search</span><br><span class=\"line\">POST ratings/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;size&quot;: 0,</span><br><span class=\"line\">  &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;avg&quot;: &#123;</span><br><span class=\"line\">      &quot;avg&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;rating&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST ratings/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;rating&quot;: &#123;</span><br><span class=\"line\">        &quot;value&quot;: 1</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"7-7-第二部分总结与测验-md\"><a href=\"#7-7-第二部分总结与测验-md\" class=\"headerlink\" title=\"7.7-第二部分总结与测验.md\"></a>7.7-第二部分总结与测验.md</h1><h1 id=\"第二部分总结与测验\"><a href=\"#第二部分总结与测验\" class=\"headerlink\" title=\"第二部分总结与测验\"></a>第二部分总结与测验</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE test</span><br><span class=\"line\">PUT test/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;content&quot;:&quot;Hello World&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;Hello World&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;hello world&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content.keyword&quot;: &quot;Hello World&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match&quot;: &#123;</span><br><span class=\"line\">      &quot;content.keyword&quot;: &quot;hello world&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;Hello World&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content&quot;: &quot;hello world&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot;: &#123;</span><br><span class=\"line\">      &quot;content.keyword&quot;: &quot;Hello World&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"8-1-集群身份认证与用户鉴权-md\"><a href=\"#8-1-集群身份认证与用户鉴权-md\" class=\"headerlink\" title=\"8.1-集群身份认证与用户鉴权.md\"></a>8.1-集群身份认证与用户鉴权.md</h1><h1 id=\"集群身份认证与用户鉴权\"><a href=\"#集群身份认证与用户鉴权\" class=\"headerlink\" title=\"集群身份认证与用户鉴权\"></a>集群身份认证与用户鉴权</h1><ul>\n<li>如何为集群启用X-Pack Security</li>\n<li>如何为内置用户设置密码</li>\n<li>设置 Kibana与ElasticSearch通信鉴权</li>\n<li>使用安全API创建对特定索引具有有限访问权限的用户</li>\n</ul>\n<p>This tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:</p>\n<p>discovery.type: single-node</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#启动单节点</span><br><span class=\"line\">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true</span><br><span class=\"line\"></span><br><span class=\"line\">#使用Curl访问ES，或者浏览器访问 “localhost:9200/_cat/nodes?pretty”。返回401错误</span><br><span class=\"line\">curl &#x27;localhost:9200/_cat/nodes?pretty&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">#运行密码设定的命令，设置ES内置用户及其初始密码。</span><br><span class=\"line\">bin/elasticsearch-setup-passwords interactive</span><br><span class=\"line\"></span><br><span class=\"line\">curl -u elastic &#x27;localhost:9200/_cat/nodes?pretty&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 修改 kibana.yml</span><br><span class=\"line\">elasticsearch.username: &quot;kibana&quot;</span><br><span class=\"line\">elasticsearch.password: &quot;changeme&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#启动。使用用户名，elastic，密码elastic</span><br><span class=\"line\">./bin/kibana</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">POST orders/_bulk</span><br><span class=\"line\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class=\"line\">&#123;&quot;product&quot; : &quot;1&quot;,&quot;price&quot; : 18,&quot;payment&quot; : &quot;master&quot;,&quot;card&quot; : &quot;9876543210123456&quot;,&quot;name&quot; : &quot;jack&quot;&#125;</span><br><span class=\"line\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class=\"line\">&#123;&quot;product&quot; : &quot;2&quot;,&quot;price&quot; : 99,&quot;payment&quot; : &quot;visa&quot;,&quot;card&quot; : &quot;1234567890123456&quot;,&quot;name&quot; : &quot;bob&quot;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#create a new role named read_only_orders, that satisfies the following criteria:</span><br><span class=\"line\">#The role has no cluster privileges</span><br><span class=\"line\">#The role only has access to indices that match the pattern sales_record</span><br><span class=\"line\">#The index privileges are read, and view_index_metadata</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#create sales_user that satisfies the following criteria:</span><br><span class=\"line\"># Use your own email address</span><br><span class=\"line\"># Assign the user to two roles: read_only_orders and kibana_user</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#验证读权限,可以执行</span><br><span class=\"line\">POST orders/_search</span><br><span class=\"line\">&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#验证写权限,报错</span><br><span class=\"line\">POST orders/_bulk</span><br><span class=\"line\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class=\"line\">&#123;&quot;product&quot; : &quot;1&quot;,&quot;price&quot; : 18,&quot;payment&quot; : &quot;master&quot;,&quot;card&quot; : &quot;9876543210123456&quot;,&quot;name&quot; : &quot;jack&quot;&#125;</span><br><span class=\"line\">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class=\"line\">&#123;&quot;product&quot; : &quot;2&quot;,&quot;price&quot; : 99,&quot;payment&quot; : &quot;visa&quot;,&quot;card&quot; : &quot;1234567890123456&quot;,&quot;name&quot; : &quot;bob&quot;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"8-2-集群内部安全通信-md\"><a href=\"#8-2-集群内部安全通信-md\" class=\"headerlink\" title=\"8.2-集群内部安全通信.md\"></a>8.2-集群内部安全通信.md</h1><h1 id=\"-3\"><a href=\"#-3\" class=\"headerlink\" title=\"\"></a></h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 生成证书</span><br><span class=\"line\"># 为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：</span><br><span class=\"line\">bin/elasticsearch-certutil ca</span><br><span class=\"line\"></span><br><span class=\"line\">#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：</span><br><span class=\"line\">bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br><span class=\"line\"></span><br><span class=\"line\">#将证书拷贝到 config/certs目录下</span><br><span class=\"line\">elastic-certificates.p12</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br><span class=\"line\">bin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#不提供证书的节点，无法加入</span><br><span class=\"line\">bin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E http.port=9202 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## elasticsearch.yml 配置</span><br><span class=\"line\"></span><br><span class=\"line\">#xpack.security.transport.ssl.enabled: true</span><br><span class=\"line\">#xpack.security.transport.ssl.verification_mode: certificate</span><br><span class=\"line\"></span><br><span class=\"line\">#xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12</span><br><span class=\"line\">#xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"8-3-集群与外部间的安全通信-md\"><a href=\"#8-3-集群与外部间的安全通信-md\" class=\"headerlink\" title=\"8.3-集群与外部间的安全通信.md\"></a>8.3-集群与外部间的安全通信.md</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xpack.security.http.ssl.enabled: true</span><br><span class=\"line\">xpack.security.http.ssl.keystore.path: certs/elastic-certificates.p12</span><br><span class=\"line\">xpack.security.http.ssl.truststore.path: certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># ES 启用 https</span><br><span class=\"line\">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Kibana 连接 ES https</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 为kibana生成pem</span><br><span class=\"line\">openssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">elasticsearch.hosts: [&quot;https://localhost:9200&quot;]</span><br><span class=\"line\">elasticsearch.ssl.certificateAuthorities: [ &quot;/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem&quot; ]</span><br><span class=\"line\">elasticsearch.ssl.verificationMode: certificate</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 为 Kibna 配置 HTTPS</span><br><span class=\"line\"># 生成后解压，包含了instance.crt 和 instance.key</span><br><span class=\"line\">bin/elasticsearch-certutil ca --pem</span><br><span class=\"line\"></span><br><span class=\"line\">server.ssl.enabled: true</span><br><span class=\"line\">server.ssl.certificate: config/certs/instance.crt</span><br><span class=\"line\">server.ssl.key: config/certs/instance.key</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"9-1-常见的集群部署方式-md-1\"><a href=\"#9-1-常见的集群部署方式-md-1\" class=\"headerlink\" title=\"9.1-常见的集群部署方式.md\"></a>9.1-常见的集群部署方式.md</h1><h1 id=\"常见的集群部署方式-1\"><a href=\"#常见的集群部署方式-1\" class=\"headerlink\" title=\"常见的集群部署方式\"></a>常见的集群部署方式</h1><h1 id=\"9-2-Hot-Warm架构与ShardFiltering-md-1\"><a href=\"#9-2-Hot-Warm架构与ShardFiltering-md-1\" class=\"headerlink\" title=\"9.2-Hot&amp;Warm架构与ShardFiltering.md\"></a>9.2-Hot&amp;Warm架构与ShardFiltering.md</h1><h1 id=\"Hot-Warm-架构与-Shard-Filtering-1\"><a href=\"#Hot-Warm-架构与-Shard-Filtering-1\" class=\"headerlink\" title=\"Hot &amp; Warm 架构与 Shard Filtering\"></a>Hot &amp; Warm 架构与 Shard Filtering</h1><h2 id=\"课程代码-1\"><a href=\"#课程代码-1\" class=\"headerlink\" title=\"课程代码\"></a>课程代码</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 标记一个 Hot 节点</span><br><span class=\"line\">bin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 warm 节点</span><br><span class=\"line\">bin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看节点</span><br><span class=\"line\">GET /_cat/nodeattrs?v</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置到 Hot节点</span><br><span class=\"line\">PUT logs-2019-06-27</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:0,</span><br><span class=\"line\">    &quot;index.routing.allocation.require.my_node_type&quot;:&quot;hot&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 配置到 warm 节点</span><br><span class=\"line\">PUT PUT logs-2019-06-27/_settings</span><br><span class=\"line\">&#123;  </span><br><span class=\"line\">  &quot;index.routing.allocation.require.my_node_type&quot;:&quot;warm&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 1</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 2</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2</span><br><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;settings&quot;:&#123;</span><br><span class=\"line\">    &quot;number_of_shards&quot;:2,</span><br><span class=\"line\">    &quot;number_of_replicas&quot;:1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PUT my_index1/_doc/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;key&quot;:&quot;value&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\">DELETE my_index1/_doc/1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Fore awareness</span><br><span class=\"line\"># 标记一个 rack 1</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"># 标记一个 rack 2</span><br><span class=\"line\">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;persistent&quot;: &#123;</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;,</span><br><span class=\"line\">    &quot;cluster.routing.allocation.awareness.force.my_rack_id.values&quot;: &quot;rack1,rack2&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">GET _cluster/settings</span><br><span class=\"line\"></span><br><span class=\"line\"># 集群黄色</span><br><span class=\"line\">GET _cluster/health</span><br><span class=\"line\"></span><br><span class=\"line\"># 副本无法分配</span><br><span class=\"line\">GET _cat/shards?v</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GET _cluster/allocation/explain?pretty</span><br></pre></td></tr></table></figure>\n"},{"title":"通过excel文档快速生成表设计（excel转pdm）","date":"2025-11-27T01:35:57.000Z","_content":"# 根据业务讨论生成数据表结构（Excel → PDM）流程说明\n\n在完成业务流程与逻辑讨论后，需要通过可视化的数据模型来确保数据库设计能够满足业务需求。为此，我们计划按照以下步骤进行数据表结构设计与确认。\n\n## 1. 根据业务需求编制 Excel 表结构文档\n\n首先，将各个业务流程中涉及的数据实体、字段及其关系梳理清楚，并整理到一份结构化的 Excel 文档中。Excel 将包含：\n\n* **待创建的数据库表列表**\n* **各表的字段明细**，包括：\n\n    * 字段名称\n    * 字段类型\n    * 主键/外键标识\n    * 是否允许为空\n    * 默认值\n    * 字段说明（业务含义）\n* **表之间的关联关系说明**\n```shell\n| type  | name         | code          | datatype        | comment                     | pk |\n|-------|--------------|----------------|------------------|------------------------------|----|\n| table | 用户表        | t_user         |                  | 用户信息存储表               |    |\n| field | 主键ID       | id             | bigint           | 主键                         | Y  |\n| field | 用户名        | username       | varchar(64)      | 用户登录名                    |    |\n| field | 昵称         | nickname       | varchar(128)     | 展示用昵称                    |    |\n| field | 创建时间      | create_time    | datetime         | 创建记录时间                  |    |\n| field | 更新时间      | update_time    | datetime         | 更新记录时间                  |    |\n| table | 订单表        | t_order        |                  | 用户订单记录表               |    |\n| field | 主键ID       | id             | bigint           | 主键                         | Y  |\n| field | 用户ID       | user_id        | bigint           | 关联 t_user.id               |    |\n| field | 订单金额      | amount         | decimal(10,2)    | 订单金额                      |    |\n| field | 状态         | status         | int              | 订单状态：0-未支付，1-已支付  |    |\n| exit  |              |                |                  |                              |    |\n\n```\n[pdm_excel_template.xlsx](通过excel文档快速生成表设计/pdm_excel_template.xlsx)\n该 Excel 用于作为数据库设计的初稿，方便校验字段是否完整、命名是否规范、业务含义是否明确。\n\n## 2. 将 Excel 表结构转为 PDM（PowerDesigner 数据模型）\n\n在整理好 Excel 后，将其导入或手工录入至 PowerDesigner（或其他数据建模工具）中，生成可视化的 PDM 模型。转换后的 PDM 可以：\n\n* 展现表之间的 **ER 图**（实体关系图）\n* 清晰标注主外键关系\n* 自动检查字段类型、长度、约束是否合理\n* 为后续生成建表 SQL、影响分析或迭代设计提供基础\n\n通过 PDM 能更直观地验证数据库结构是否符合业务逻辑和扩展需求。\n![bbe82095-e9ee-4c41-969c-0a70a9c6f9f2.png](通过excel文档快速生成表设计/bbe82095-e9ee-4c41-969c-0a70a9c6f9f2.png)\n```shell\nOption Explicit\n \nDim mdl ' the current model\nSet mdl = ActiveModel\nIf (mdl Is Nothing) Then\n   MsgBox \"There is no Active Model\"\nEnd If\n \nDim HaveExcel\nDim RQ\nRQ = vbYes 'MsgBox(\"Is Excel Installed on your machine ?\", vbYesNo + vbInformation, \"Confirmation\")\nIf RQ = vbYes Then\n   HaveExcel = True\n   ' Open & Create Excel Document\n   Dim x1  '\n   Set x1 = CreateObject(\"Excel.Application\")\n   x1.Workbooks.Open \"D:\\BaseAccept\\Documents\\库表设计_new.xlsx\"   '指定excel文档路径\n   x1.Workbooks(1).Worksheets(\"Sheet1\").Activate   '指定要打开的sheet名称\nElse\n   HaveExcel = False\nEnd If\n \na x1, mdl\nsub a(x1, mdl)\ndim rwIndex   \ndim tableName\ndim colname\ndim table\ndim col\ndim count\ndim cacheTableCode\non error Resume Next\n \nFor rwIndex = 2 To 1000   '指定要遍历的Excel行标  由于第1行是表头，从第2行开始\n        With x1.Workbooks(1).Worksheets(\"Sheet1\")\n            If .Cells(rwIndex, 1).Value = \"\" Then '如果遍历到第一列为空，则退出\n               'Exit For\n               Else\n               \n                  '读取第一列  代表type类型 table代表表  remake代表注释 field代表字段  空代表无需处理\n            \n                  If .Cells(rwIndex, 1).Value = \"table\" Then 'table代表表\n                      set table = mdl.Tables.CreateNew     '创建表\n                      table.Name = .Cells(rwIndex , 2).Value '指定表名\n                      table.Code = .Cells(rwIndex , 3).Value \n                      table.Comment = .Cells(rwIndex , 5).Value '指定表注释\n                      count = count + 1  \n              \n                  ElseIf .Cells(rwIndex, 1).Value = \"field\" Then '字段\n                      set col = table.Columns.CreateNew   '创建一列/字段\n                     'MsgBox .Cells(rwIndex, 1).Value, vbOK + vbInformation, \"列\"            \n                        col.Name = .Cells(rwIndex, 2).Value   '指定列名       \n                     'MsgBox col.Name, vbOK + vbInformation, \"列\"\n                     col.Code = .Cells(rwIndex, 3).Value   '指定列名                        \n                     col.DataType = .Cells(rwIndex, 4).Value '指定列数据类型           \n                       'MsgBox col.DataType, vbOK + vbInformation, \"列类型\"               \n                     col.Comment = .Cells(rwIndex, 5).Value  '指定列说明\n                  'col.Precision = .Cells(rwIndex, 6).Value  '精度\n                  If .Cells(rwIndex,6).Value=\"Y\" Then\n                    col.Primary  = true  '是否主键\n                     \n                     ElseIf .Cells(rwIndex,6).Value = \"\" Then\n                           '如果标记主键是空,默认就看是不是id字段 如果是id 那么也当主键\n                           If .Cells(rwIndex, 3).Value=\"id\"  Then\n                              col.Primary  = true  '是否主键\n                           End If\n                        \n                     End If\n                     \n                  ElseIf .Cells(rwIndex, 1).Value = \"exit\" Then '退出\n                     Exit For\n               \n                  End If\n               \n               \n            End If\n            \n        End With\nNext\nMsgBox \"生成数据表结构共计 \" + CStr(count), vbOK + vbInformation, \"表\"\n \nExit Sub\nEnd sub\n```\n## 3. 结构确认与后续输出\n\n完成 PDM 后，可以组织开发/业务/测试共同评审，重点确认：\n\n* 字段是否覆盖全部业务场景\n* 表之间关系是否正确\n* 命名是否规范、一致\n* 是否存在冗余或缺失的数据结构\n\n最终确认无误后，可基于 PDM 导出：\n![ae4eaa42-ca46-4d69-9cef-068878d45872 (1).png](通过excel文档快速生成表设计/ae4eaa42-ca46-4d69-9cef-068878d45872%20%281%29.png)\n* 建表 SQL\n* 模型文档\n* 字段字典\n* 后续开发所需的数据库初始化脚本\n* ![1edf348b-0d13-4496-9743-dc09003846d1.png](通过excel文档快速生成表设计/1edf348b-0d13-4496-9743-dc09003846d1.png)\n","source":"_posts/mysql/通过excel文档快速生成表设计.md","raw":"---\ntitle: 通过excel文档快速生成表设计（excel转pdm）\ndate: 2025-11-27 09:35:57\ncategories: mysql\ntag: 表设计\n---\n# 根据业务讨论生成数据表结构（Excel → PDM）流程说明\n\n在完成业务流程与逻辑讨论后，需要通过可视化的数据模型来确保数据库设计能够满足业务需求。为此，我们计划按照以下步骤进行数据表结构设计与确认。\n\n## 1. 根据业务需求编制 Excel 表结构文档\n\n首先，将各个业务流程中涉及的数据实体、字段及其关系梳理清楚，并整理到一份结构化的 Excel 文档中。Excel 将包含：\n\n* **待创建的数据库表列表**\n* **各表的字段明细**，包括：\n\n    * 字段名称\n    * 字段类型\n    * 主键/外键标识\n    * 是否允许为空\n    * 默认值\n    * 字段说明（业务含义）\n* **表之间的关联关系说明**\n```shell\n| type  | name         | code          | datatype        | comment                     | pk |\n|-------|--------------|----------------|------------------|------------------------------|----|\n| table | 用户表        | t_user         |                  | 用户信息存储表               |    |\n| field | 主键ID       | id             | bigint           | 主键                         | Y  |\n| field | 用户名        | username       | varchar(64)      | 用户登录名                    |    |\n| field | 昵称         | nickname       | varchar(128)     | 展示用昵称                    |    |\n| field | 创建时间      | create_time    | datetime         | 创建记录时间                  |    |\n| field | 更新时间      | update_time    | datetime         | 更新记录时间                  |    |\n| table | 订单表        | t_order        |                  | 用户订单记录表               |    |\n| field | 主键ID       | id             | bigint           | 主键                         | Y  |\n| field | 用户ID       | user_id        | bigint           | 关联 t_user.id               |    |\n| field | 订单金额      | amount         | decimal(10,2)    | 订单金额                      |    |\n| field | 状态         | status         | int              | 订单状态：0-未支付，1-已支付  |    |\n| exit  |              |                |                  |                              |    |\n\n```\n[pdm_excel_template.xlsx](通过excel文档快速生成表设计/pdm_excel_template.xlsx)\n该 Excel 用于作为数据库设计的初稿，方便校验字段是否完整、命名是否规范、业务含义是否明确。\n\n## 2. 将 Excel 表结构转为 PDM（PowerDesigner 数据模型）\n\n在整理好 Excel 后，将其导入或手工录入至 PowerDesigner（或其他数据建模工具）中，生成可视化的 PDM 模型。转换后的 PDM 可以：\n\n* 展现表之间的 **ER 图**（实体关系图）\n* 清晰标注主外键关系\n* 自动检查字段类型、长度、约束是否合理\n* 为后续生成建表 SQL、影响分析或迭代设计提供基础\n\n通过 PDM 能更直观地验证数据库结构是否符合业务逻辑和扩展需求。\n![bbe82095-e9ee-4c41-969c-0a70a9c6f9f2.png](通过excel文档快速生成表设计/bbe82095-e9ee-4c41-969c-0a70a9c6f9f2.png)\n```shell\nOption Explicit\n \nDim mdl ' the current model\nSet mdl = ActiveModel\nIf (mdl Is Nothing) Then\n   MsgBox \"There is no Active Model\"\nEnd If\n \nDim HaveExcel\nDim RQ\nRQ = vbYes 'MsgBox(\"Is Excel Installed on your machine ?\", vbYesNo + vbInformation, \"Confirmation\")\nIf RQ = vbYes Then\n   HaveExcel = True\n   ' Open & Create Excel Document\n   Dim x1  '\n   Set x1 = CreateObject(\"Excel.Application\")\n   x1.Workbooks.Open \"D:\\BaseAccept\\Documents\\库表设计_new.xlsx\"   '指定excel文档路径\n   x1.Workbooks(1).Worksheets(\"Sheet1\").Activate   '指定要打开的sheet名称\nElse\n   HaveExcel = False\nEnd If\n \na x1, mdl\nsub a(x1, mdl)\ndim rwIndex   \ndim tableName\ndim colname\ndim table\ndim col\ndim count\ndim cacheTableCode\non error Resume Next\n \nFor rwIndex = 2 To 1000   '指定要遍历的Excel行标  由于第1行是表头，从第2行开始\n        With x1.Workbooks(1).Worksheets(\"Sheet1\")\n            If .Cells(rwIndex, 1).Value = \"\" Then '如果遍历到第一列为空，则退出\n               'Exit For\n               Else\n               \n                  '读取第一列  代表type类型 table代表表  remake代表注释 field代表字段  空代表无需处理\n            \n                  If .Cells(rwIndex, 1).Value = \"table\" Then 'table代表表\n                      set table = mdl.Tables.CreateNew     '创建表\n                      table.Name = .Cells(rwIndex , 2).Value '指定表名\n                      table.Code = .Cells(rwIndex , 3).Value \n                      table.Comment = .Cells(rwIndex , 5).Value '指定表注释\n                      count = count + 1  \n              \n                  ElseIf .Cells(rwIndex, 1).Value = \"field\" Then '字段\n                      set col = table.Columns.CreateNew   '创建一列/字段\n                     'MsgBox .Cells(rwIndex, 1).Value, vbOK + vbInformation, \"列\"            \n                        col.Name = .Cells(rwIndex, 2).Value   '指定列名       \n                     'MsgBox col.Name, vbOK + vbInformation, \"列\"\n                     col.Code = .Cells(rwIndex, 3).Value   '指定列名                        \n                     col.DataType = .Cells(rwIndex, 4).Value '指定列数据类型           \n                       'MsgBox col.DataType, vbOK + vbInformation, \"列类型\"               \n                     col.Comment = .Cells(rwIndex, 5).Value  '指定列说明\n                  'col.Precision = .Cells(rwIndex, 6).Value  '精度\n                  If .Cells(rwIndex,6).Value=\"Y\" Then\n                    col.Primary  = true  '是否主键\n                     \n                     ElseIf .Cells(rwIndex,6).Value = \"\" Then\n                           '如果标记主键是空,默认就看是不是id字段 如果是id 那么也当主键\n                           If .Cells(rwIndex, 3).Value=\"id\"  Then\n                              col.Primary  = true  '是否主键\n                           End If\n                        \n                     End If\n                     \n                  ElseIf .Cells(rwIndex, 1).Value = \"exit\" Then '退出\n                     Exit For\n               \n                  End If\n               \n               \n            End If\n            \n        End With\nNext\nMsgBox \"生成数据表结构共计 \" + CStr(count), vbOK + vbInformation, \"表\"\n \nExit Sub\nEnd sub\n```\n## 3. 结构确认与后续输出\n\n完成 PDM 后，可以组织开发/业务/测试共同评审，重点确认：\n\n* 字段是否覆盖全部业务场景\n* 表之间关系是否正确\n* 命名是否规范、一致\n* 是否存在冗余或缺失的数据结构\n\n最终确认无误后，可基于 PDM 导出：\n![ae4eaa42-ca46-4d69-9cef-068878d45872 (1).png](通过excel文档快速生成表设计/ae4eaa42-ca46-4d69-9cef-068878d45872%20%281%29.png)\n* 建表 SQL\n* 模型文档\n* 字段字典\n* 后续开发所需的数据库初始化脚本\n* ![1edf348b-0d13-4496-9743-dc09003846d1.png](通过excel文档快速生成表设计/1edf348b-0d13-4496-9743-dc09003846d1.png)\n","slug":"mysql/通过excel文档快速生成表设计","published":1,"updated":"2025-11-27T03:08:38.474Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8u0012ujz3eejm2v5o","content":"<h1 id=\"根据业务讨论生成数据表结构（Excel-→-PDM）流程说明\"><a href=\"#根据业务讨论生成数据表结构（Excel-→-PDM）流程说明\" class=\"headerlink\" title=\"根据业务讨论生成数据表结构（Excel → PDM）流程说明\"></a>根据业务讨论生成数据表结构（Excel → PDM）流程说明</h1><p>在完成业务流程与逻辑讨论后，需要通过可视化的数据模型来确保数据库设计能够满足业务需求。为此，我们计划按照以下步骤进行数据表结构设计与确认。</p>\n<h2 id=\"1-根据业务需求编制-Excel-表结构文档\"><a href=\"#1-根据业务需求编制-Excel-表结构文档\" class=\"headerlink\" title=\"1. 根据业务需求编制 Excel 表结构文档\"></a>1. 根据业务需求编制 Excel 表结构文档</h2><p>首先，将各个业务流程中涉及的数据实体、字段及其关系梳理清楚，并整理到一份结构化的 Excel 文档中。Excel 将包含：</p>\n<ul>\n<li><p><strong>待创建的数据库表列表</strong></p>\n</li>\n<li><p><strong>各表的字段明细</strong>，包括：</p>\n<ul>\n<li>字段名称</li>\n<li>字段类型</li>\n<li>主键&#x2F;外键标识</li>\n<li>是否允许为空</li>\n<li>默认值</li>\n<li>字段说明（业务含义）</li>\n</ul>\n</li>\n<li><p><strong>表之间的关联关系说明</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">| type  | name         | code          | datatype        | comment                     | pk |</span><br><span class=\"line\">|-------|--------------|----------------|------------------|------------------------------|----|</span><br><span class=\"line\">| table | 用户表        | t_user         |                  | 用户信息存储表               |    |</span><br><span class=\"line\">| field | 主键ID       | id             | bigint           | 主键                         | Y  |</span><br><span class=\"line\">| field | 用户名        | username       | varchar(64)      | 用户登录名                    |    |</span><br><span class=\"line\">| field | 昵称         | nickname       | varchar(128)     | 展示用昵称                    |    |</span><br><span class=\"line\">| field | 创建时间      | create_time    | datetime         | 创建记录时间                  |    |</span><br><span class=\"line\">| field | 更新时间      | update_time    | datetime         | 更新记录时间                  |    |</span><br><span class=\"line\">| table | 订单表        | t_order        |                  | 用户订单记录表               |    |</span><br><span class=\"line\">| field | 主键ID       | id             | bigint           | 主键                         | Y  |</span><br><span class=\"line\">| field | 用户ID       | user_id        | bigint           | 关联 t_user.id               |    |</span><br><span class=\"line\">| field | 订单金额      | amount         | decimal(10,2)    | 订单金额                      |    |</span><br><span class=\"line\">| field | 状态         | status         | int              | 订单状态：0-未支付，1-已支付  |    |</span><br><span class=\"line\">| exit  |              |                |                  |                              |    |</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><a href=\"%E9%80%9A%E8%BF%87excel%E6%96%87%E6%A1%A3%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E8%A1%A8%E8%AE%BE%E8%AE%A1/pdm_excel_template.xlsx\">pdm_excel_template.xlsx</a><br>该 Excel 用于作为数据库设计的初稿，方便校验字段是否完整、命名是否规范、业务含义是否明确。</p>\n</li>\n</ul>\n<h2 id=\"2-将-Excel-表结构转为-PDM（PowerDesigner-数据模型）\"><a href=\"#2-将-Excel-表结构转为-PDM（PowerDesigner-数据模型）\" class=\"headerlink\" title=\"2. 将 Excel 表结构转为 PDM（PowerDesigner 数据模型）\"></a>2. 将 Excel 表结构转为 PDM（PowerDesigner 数据模型）</h2><p>在整理好 Excel 后，将其导入或手工录入至 PowerDesigner（或其他数据建模工具）中，生成可视化的 PDM 模型。转换后的 PDM 可以：</p>\n<ul>\n<li>展现表之间的 <strong>ER 图</strong>（实体关系图）</li>\n<li>清晰标注主外键关系</li>\n<li>自动检查字段类型、长度、约束是否合理</li>\n<li>为后续生成建表 SQL、影响分析或迭代设计提供基础</li>\n</ul>\n<p>通过 PDM 能更直观地验证数据库结构是否符合业务逻辑和扩展需求。</p>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Option Explicit</span><br><span class=\"line\"> </span><br><span class=\"line\">Dim mdl &#x27; the current model</span><br><span class=\"line\">Set mdl = ActiveModel</span><br><span class=\"line\">If (mdl Is Nothing) Then</span><br><span class=\"line\">   MsgBox &quot;There is no Active Model&quot;</span><br><span class=\"line\">End If</span><br><span class=\"line\"> </span><br><span class=\"line\">Dim HaveExcel</span><br><span class=\"line\">Dim RQ</span><br><span class=\"line\">RQ = vbYes &#x27;MsgBox(&quot;Is Excel Installed on your machine ?&quot;, vbYesNo + vbInformation, &quot;Confirmation&quot;)</span><br><span class=\"line\">If RQ = vbYes Then</span><br><span class=\"line\">   HaveExcel = True</span><br><span class=\"line\">   &#x27; Open &amp; Create Excel Document</span><br><span class=\"line\">   Dim x1  &#x27;</span><br><span class=\"line\">   Set x1 = CreateObject(&quot;Excel.Application&quot;)</span><br><span class=\"line\">   x1.Workbooks.Open &quot;D:\\BaseAccept\\Documents\\库表设计_new.xlsx&quot;   &#x27;指定excel文档路径</span><br><span class=\"line\">   x1.Workbooks(1).Worksheets(&quot;Sheet1&quot;).Activate   &#x27;指定要打开的sheet名称</span><br><span class=\"line\">Else</span><br><span class=\"line\">   HaveExcel = False</span><br><span class=\"line\">End If</span><br><span class=\"line\"> </span><br><span class=\"line\">a x1, mdl</span><br><span class=\"line\">sub a(x1, mdl)</span><br><span class=\"line\">dim rwIndex   </span><br><span class=\"line\">dim tableName</span><br><span class=\"line\">dim colname</span><br><span class=\"line\">dim table</span><br><span class=\"line\">dim col</span><br><span class=\"line\">dim count</span><br><span class=\"line\">dim cacheTableCode</span><br><span class=\"line\">on error Resume Next</span><br><span class=\"line\"> </span><br><span class=\"line\">For rwIndex = 2 To 1000   &#x27;指定要遍历的Excel行标  由于第1行是表头，从第2行开始</span><br><span class=\"line\">        With x1.Workbooks(1).Worksheets(&quot;Sheet1&quot;)</span><br><span class=\"line\">            If .Cells(rwIndex, 1).Value = &quot;&quot; Then &#x27;如果遍历到第一列为空，则退出</span><br><span class=\"line\">               &#x27;Exit For</span><br><span class=\"line\">               Else</span><br><span class=\"line\">               </span><br><span class=\"line\">                  &#x27;读取第一列  代表type类型 table代表表  remake代表注释 field代表字段  空代表无需处理</span><br><span class=\"line\">            </span><br><span class=\"line\">                  If .Cells(rwIndex, 1).Value = &quot;table&quot; Then &#x27;table代表表</span><br><span class=\"line\">                      set table = mdl.Tables.CreateNew     &#x27;创建表</span><br><span class=\"line\">                      table.Name = .Cells(rwIndex , 2).Value &#x27;指定表名</span><br><span class=\"line\">                      table.Code = .Cells(rwIndex , 3).Value </span><br><span class=\"line\">                      table.Comment = .Cells(rwIndex , 5).Value &#x27;指定表注释</span><br><span class=\"line\">                      count = count + 1  </span><br><span class=\"line\">              </span><br><span class=\"line\">                  ElseIf .Cells(rwIndex, 1).Value = &quot;field&quot; Then &#x27;字段</span><br><span class=\"line\">                      set col = table.Columns.CreateNew   &#x27;创建一列/字段</span><br><span class=\"line\">                     &#x27;MsgBox .Cells(rwIndex, 1).Value, vbOK + vbInformation, &quot;列&quot;            </span><br><span class=\"line\">                        col.Name = .Cells(rwIndex, 2).Value   &#x27;指定列名       </span><br><span class=\"line\">                     &#x27;MsgBox col.Name, vbOK + vbInformation, &quot;列&quot;</span><br><span class=\"line\">                     col.Code = .Cells(rwIndex, 3).Value   &#x27;指定列名                        </span><br><span class=\"line\">                     col.DataType = .Cells(rwIndex, 4).Value &#x27;指定列数据类型           </span><br><span class=\"line\">                       &#x27;MsgBox col.DataType, vbOK + vbInformation, &quot;列类型&quot;               </span><br><span class=\"line\">                     col.Comment = .Cells(rwIndex, 5).Value  &#x27;指定列说明</span><br><span class=\"line\">                  &#x27;col.Precision = .Cells(rwIndex, 6).Value  &#x27;精度</span><br><span class=\"line\">                  If .Cells(rwIndex,6).Value=&quot;Y&quot; Then</span><br><span class=\"line\">                    col.Primary  = true  &#x27;是否主键</span><br><span class=\"line\">                     </span><br><span class=\"line\">                     ElseIf .Cells(rwIndex,6).Value = &quot;&quot; Then</span><br><span class=\"line\">                           &#x27;如果标记主键是空,默认就看是不是id字段 如果是id 那么也当主键</span><br><span class=\"line\">                           If .Cells(rwIndex, 3).Value=&quot;id&quot;  Then</span><br><span class=\"line\">                              col.Primary  = true  &#x27;是否主键</span><br><span class=\"line\">                           End If</span><br><span class=\"line\">                        </span><br><span class=\"line\">                     End If</span><br><span class=\"line\">                     </span><br><span class=\"line\">                  ElseIf .Cells(rwIndex, 1).Value = &quot;exit&quot; Then &#x27;退出</span><br><span class=\"line\">                     Exit For</span><br><span class=\"line\">               </span><br><span class=\"line\">                  End If</span><br><span class=\"line\">               </span><br><span class=\"line\">               </span><br><span class=\"line\">            End If</span><br><span class=\"line\">            </span><br><span class=\"line\">        End With</span><br><span class=\"line\">Next</span><br><span class=\"line\">MsgBox &quot;生成数据表结构共计 &quot; + CStr(count), vbOK + vbInformation, &quot;表&quot;</span><br><span class=\"line\"> </span><br><span class=\"line\">Exit Sub</span><br><span class=\"line\">End sub</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-结构确认与后续输出\"><a href=\"#3-结构确认与后续输出\" class=\"headerlink\" title=\"3. 结构确认与后续输出\"></a>3. 结构确认与后续输出</h2><p>完成 PDM 后，可以组织开发&#x2F;业务&#x2F;测试共同评审，重点确认：</p>\n<ul>\n<li>字段是否覆盖全部业务场景</li>\n<li>表之间关系是否正确</li>\n<li>命名是否规范、一致</li>\n<li>是否存在冗余或缺失的数据结构</li>\n</ul>\n<p>最终确认无误后，可基于 PDM 导出：</p>\n\n<ul>\n<li>建表 SQL</li>\n<li>模型文档</li>\n<li>字段字典</li>\n<li>后续开发所需的数据库初始化脚本</li>\n<li></li>\n</ul>\n","cover":false,"excerpt":"","more":"<h1 id=\"根据业务讨论生成数据表结构（Excel-→-PDM）流程说明\"><a href=\"#根据业务讨论生成数据表结构（Excel-→-PDM）流程说明\" class=\"headerlink\" title=\"根据业务讨论生成数据表结构（Excel → PDM）流程说明\"></a>根据业务讨论生成数据表结构（Excel → PDM）流程说明</h1><p>在完成业务流程与逻辑讨论后，需要通过可视化的数据模型来确保数据库设计能够满足业务需求。为此，我们计划按照以下步骤进行数据表结构设计与确认。</p>\n<h2 id=\"1-根据业务需求编制-Excel-表结构文档\"><a href=\"#1-根据业务需求编制-Excel-表结构文档\" class=\"headerlink\" title=\"1. 根据业务需求编制 Excel 表结构文档\"></a>1. 根据业务需求编制 Excel 表结构文档</h2><p>首先，将各个业务流程中涉及的数据实体、字段及其关系梳理清楚，并整理到一份结构化的 Excel 文档中。Excel 将包含：</p>\n<ul>\n<li><p><strong>待创建的数据库表列表</strong></p>\n</li>\n<li><p><strong>各表的字段明细</strong>，包括：</p>\n<ul>\n<li>字段名称</li>\n<li>字段类型</li>\n<li>主键&#x2F;外键标识</li>\n<li>是否允许为空</li>\n<li>默认值</li>\n<li>字段说明（业务含义）</li>\n</ul>\n</li>\n<li><p><strong>表之间的关联关系说明</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">| type  | name         | code          | datatype        | comment                     | pk |</span><br><span class=\"line\">|-------|--------------|----------------|------------------|------------------------------|----|</span><br><span class=\"line\">| table | 用户表        | t_user         |                  | 用户信息存储表               |    |</span><br><span class=\"line\">| field | 主键ID       | id             | bigint           | 主键                         | Y  |</span><br><span class=\"line\">| field | 用户名        | username       | varchar(64)      | 用户登录名                    |    |</span><br><span class=\"line\">| field | 昵称         | nickname       | varchar(128)     | 展示用昵称                    |    |</span><br><span class=\"line\">| field | 创建时间      | create_time    | datetime         | 创建记录时间                  |    |</span><br><span class=\"line\">| field | 更新时间      | update_time    | datetime         | 更新记录时间                  |    |</span><br><span class=\"line\">| table | 订单表        | t_order        |                  | 用户订单记录表               |    |</span><br><span class=\"line\">| field | 主键ID       | id             | bigint           | 主键                         | Y  |</span><br><span class=\"line\">| field | 用户ID       | user_id        | bigint           | 关联 t_user.id               |    |</span><br><span class=\"line\">| field | 订单金额      | amount         | decimal(10,2)    | 订单金额                      |    |</span><br><span class=\"line\">| field | 状态         | status         | int              | 订单状态：0-未支付，1-已支付  |    |</span><br><span class=\"line\">| exit  |              |                |                  |                              |    |</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><a href=\"%E9%80%9A%E8%BF%87excel%E6%96%87%E6%A1%A3%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E8%A1%A8%E8%AE%BE%E8%AE%A1/pdm_excel_template.xlsx\">pdm_excel_template.xlsx</a><br>该 Excel 用于作为数据库设计的初稿，方便校验字段是否完整、命名是否规范、业务含义是否明确。</p>\n</li>\n</ul>\n<h2 id=\"2-将-Excel-表结构转为-PDM（PowerDesigner-数据模型）\"><a href=\"#2-将-Excel-表结构转为-PDM（PowerDesigner-数据模型）\" class=\"headerlink\" title=\"2. 将 Excel 表结构转为 PDM（PowerDesigner 数据模型）\"></a>2. 将 Excel 表结构转为 PDM（PowerDesigner 数据模型）</h2><p>在整理好 Excel 后，将其导入或手工录入至 PowerDesigner（或其他数据建模工具）中，生成可视化的 PDM 模型。转换后的 PDM 可以：</p>\n<ul>\n<li>展现表之间的 <strong>ER 图</strong>（实体关系图）</li>\n<li>清晰标注主外键关系</li>\n<li>自动检查字段类型、长度、约束是否合理</li>\n<li>为后续生成建表 SQL、影响分析或迭代设计提供基础</li>\n</ul>\n<p>通过 PDM 能更直观地验证数据库结构是否符合业务逻辑和扩展需求。</p>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Option Explicit</span><br><span class=\"line\"> </span><br><span class=\"line\">Dim mdl &#x27; the current model</span><br><span class=\"line\">Set mdl = ActiveModel</span><br><span class=\"line\">If (mdl Is Nothing) Then</span><br><span class=\"line\">   MsgBox &quot;There is no Active Model&quot;</span><br><span class=\"line\">End If</span><br><span class=\"line\"> </span><br><span class=\"line\">Dim HaveExcel</span><br><span class=\"line\">Dim RQ</span><br><span class=\"line\">RQ = vbYes &#x27;MsgBox(&quot;Is Excel Installed on your machine ?&quot;, vbYesNo + vbInformation, &quot;Confirmation&quot;)</span><br><span class=\"line\">If RQ = vbYes Then</span><br><span class=\"line\">   HaveExcel = True</span><br><span class=\"line\">   &#x27; Open &amp; Create Excel Document</span><br><span class=\"line\">   Dim x1  &#x27;</span><br><span class=\"line\">   Set x1 = CreateObject(&quot;Excel.Application&quot;)</span><br><span class=\"line\">   x1.Workbooks.Open &quot;D:\\BaseAccept\\Documents\\库表设计_new.xlsx&quot;   &#x27;指定excel文档路径</span><br><span class=\"line\">   x1.Workbooks(1).Worksheets(&quot;Sheet1&quot;).Activate   &#x27;指定要打开的sheet名称</span><br><span class=\"line\">Else</span><br><span class=\"line\">   HaveExcel = False</span><br><span class=\"line\">End If</span><br><span class=\"line\"> </span><br><span class=\"line\">a x1, mdl</span><br><span class=\"line\">sub a(x1, mdl)</span><br><span class=\"line\">dim rwIndex   </span><br><span class=\"line\">dim tableName</span><br><span class=\"line\">dim colname</span><br><span class=\"line\">dim table</span><br><span class=\"line\">dim col</span><br><span class=\"line\">dim count</span><br><span class=\"line\">dim cacheTableCode</span><br><span class=\"line\">on error Resume Next</span><br><span class=\"line\"> </span><br><span class=\"line\">For rwIndex = 2 To 1000   &#x27;指定要遍历的Excel行标  由于第1行是表头，从第2行开始</span><br><span class=\"line\">        With x1.Workbooks(1).Worksheets(&quot;Sheet1&quot;)</span><br><span class=\"line\">            If .Cells(rwIndex, 1).Value = &quot;&quot; Then &#x27;如果遍历到第一列为空，则退出</span><br><span class=\"line\">               &#x27;Exit For</span><br><span class=\"line\">               Else</span><br><span class=\"line\">               </span><br><span class=\"line\">                  &#x27;读取第一列  代表type类型 table代表表  remake代表注释 field代表字段  空代表无需处理</span><br><span class=\"line\">            </span><br><span class=\"line\">                  If .Cells(rwIndex, 1).Value = &quot;table&quot; Then &#x27;table代表表</span><br><span class=\"line\">                      set table = mdl.Tables.CreateNew     &#x27;创建表</span><br><span class=\"line\">                      table.Name = .Cells(rwIndex , 2).Value &#x27;指定表名</span><br><span class=\"line\">                      table.Code = .Cells(rwIndex , 3).Value </span><br><span class=\"line\">                      table.Comment = .Cells(rwIndex , 5).Value &#x27;指定表注释</span><br><span class=\"line\">                      count = count + 1  </span><br><span class=\"line\">              </span><br><span class=\"line\">                  ElseIf .Cells(rwIndex, 1).Value = &quot;field&quot; Then &#x27;字段</span><br><span class=\"line\">                      set col = table.Columns.CreateNew   &#x27;创建一列/字段</span><br><span class=\"line\">                     &#x27;MsgBox .Cells(rwIndex, 1).Value, vbOK + vbInformation, &quot;列&quot;            </span><br><span class=\"line\">                        col.Name = .Cells(rwIndex, 2).Value   &#x27;指定列名       </span><br><span class=\"line\">                     &#x27;MsgBox col.Name, vbOK + vbInformation, &quot;列&quot;</span><br><span class=\"line\">                     col.Code = .Cells(rwIndex, 3).Value   &#x27;指定列名                        </span><br><span class=\"line\">                     col.DataType = .Cells(rwIndex, 4).Value &#x27;指定列数据类型           </span><br><span class=\"line\">                       &#x27;MsgBox col.DataType, vbOK + vbInformation, &quot;列类型&quot;               </span><br><span class=\"line\">                     col.Comment = .Cells(rwIndex, 5).Value  &#x27;指定列说明</span><br><span class=\"line\">                  &#x27;col.Precision = .Cells(rwIndex, 6).Value  &#x27;精度</span><br><span class=\"line\">                  If .Cells(rwIndex,6).Value=&quot;Y&quot; Then</span><br><span class=\"line\">                    col.Primary  = true  &#x27;是否主键</span><br><span class=\"line\">                     </span><br><span class=\"line\">                     ElseIf .Cells(rwIndex,6).Value = &quot;&quot; Then</span><br><span class=\"line\">                           &#x27;如果标记主键是空,默认就看是不是id字段 如果是id 那么也当主键</span><br><span class=\"line\">                           If .Cells(rwIndex, 3).Value=&quot;id&quot;  Then</span><br><span class=\"line\">                              col.Primary  = true  &#x27;是否主键</span><br><span class=\"line\">                           End If</span><br><span class=\"line\">                        </span><br><span class=\"line\">                     End If</span><br><span class=\"line\">                     </span><br><span class=\"line\">                  ElseIf .Cells(rwIndex, 1).Value = &quot;exit&quot; Then &#x27;退出</span><br><span class=\"line\">                     Exit For</span><br><span class=\"line\">               </span><br><span class=\"line\">                  End If</span><br><span class=\"line\">               </span><br><span class=\"line\">               </span><br><span class=\"line\">            End If</span><br><span class=\"line\">            </span><br><span class=\"line\">        End With</span><br><span class=\"line\">Next</span><br><span class=\"line\">MsgBox &quot;生成数据表结构共计 &quot; + CStr(count), vbOK + vbInformation, &quot;表&quot;</span><br><span class=\"line\"> </span><br><span class=\"line\">Exit Sub</span><br><span class=\"line\">End sub</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-结构确认与后续输出\"><a href=\"#3-结构确认与后续输出\" class=\"headerlink\" title=\"3. 结构确认与后续输出\"></a>3. 结构确认与后续输出</h2><p>完成 PDM 后，可以组织开发&#x2F;业务&#x2F;测试共同评审，重点确认：</p>\n<ul>\n<li>字段是否覆盖全部业务场景</li>\n<li>表之间关系是否正确</li>\n<li>命名是否规范、一致</li>\n<li>是否存在冗余或缺失的数据结构</li>\n</ul>\n<p>最终确认无误后，可基于 PDM 导出：</p>\n\n<ul>\n<li>建表 SQL</li>\n<li>模型文档</li>\n<li>字段字典</li>\n<li>后续开发所需的数据库初始化脚本</li>\n<li></li>\n</ul>\n"},{"title":"UNIX操作系统采用i结点管理文件的存储空间","date":"2025-03-27T09:51:59.000Z","_content":"\n```markdown\n## UNIX i 结点管理文件的最大文件长度计算\n\n### 1. 给定条件\n- **磁盘块大小** = 2048 字节\n- **每个地址占** = 64 位 = **8 字节**\n- **i 结点地址项**\n  - **10 个直接地址**\n  - **1 个一次间接地址**\n  - **1 个二次间接地址**\n  - **1 个三次间接地址**\n\n### 2. 计算不同寻址方式可管理的文件大小\n\n#### （1）直接地址部分\n每个直接地址指向 **1 个磁盘块**，共有 10 个直接地址：\n```\n10 × 2048 = 20480 字节\n```\n\n#### （2）一次间接地址\n- 1 个地址项可以存储的地址数：\n  ```\n2048 ÷ 8 = 256\n  ```\n- 256 个磁盘块，每个 2048 字节：\n  ```\n256 × 2048 = 524288 字节 = 512 KB\n  ```\n\n#### （3）二次间接地址\n- 1 个地址项存 256 个地址，每个地址指向一个间接块，每个间接块又指向 256 个数据块：\n  ```\n256 × 256 = 65536 个数据块\n  ```\n- 65536 个数据块，每个 2048 字节：\n  ```\n65536 × 2048 = 134217728 字节 = 128 MB\n  ```\n\n#### （4）三次间接地址\n- 1 个地址项存 256 个地址，每个地址指向一个间接块，每个间接块再指向 256 个二次间接块，每个二次间接块又指向 256 个数据块：\n  ```\n256 × 256 × 256 = 16777216 个数据块\n  ```\n- 16777216 个数据块，每个 2048 字节：\n  ```\n16777216 × 2048 = 34359738368 字节 = 32 GB\n  ```\n\n### 3. 总文件大小\n```\n直接地址部分 + 一次间接地址 + 二次间接地址 + 三次间接地址\n20480 + 524288 + 134217728 + 34359738368 = 34494963764 字节\n```\n```\n= 32.125 GB\n\n### 4. 结论\n该 UNIX 系统能管理的 **单个文件最大长度** 为 **约 32.13 GB**。","source":"_posts/linux/UNIX操作系统采用i结点管理文件的存储空间.md","raw":"---\ntitle: UNIX操作系统采用i结点管理文件的存储空间\ndate: 2025-03-27 17:51:59\ntags:\n---\n\n```markdown\n## UNIX i 结点管理文件的最大文件长度计算\n\n### 1. 给定条件\n- **磁盘块大小** = 2048 字节\n- **每个地址占** = 64 位 = **8 字节**\n- **i 结点地址项**\n  - **10 个直接地址**\n  - **1 个一次间接地址**\n  - **1 个二次间接地址**\n  - **1 个三次间接地址**\n\n### 2. 计算不同寻址方式可管理的文件大小\n\n#### （1）直接地址部分\n每个直接地址指向 **1 个磁盘块**，共有 10 个直接地址：\n```\n10 × 2048 = 20480 字节\n```\n\n#### （2）一次间接地址\n- 1 个地址项可以存储的地址数：\n  ```\n2048 ÷ 8 = 256\n  ```\n- 256 个磁盘块，每个 2048 字节：\n  ```\n256 × 2048 = 524288 字节 = 512 KB\n  ```\n\n#### （3）二次间接地址\n- 1 个地址项存 256 个地址，每个地址指向一个间接块，每个间接块又指向 256 个数据块：\n  ```\n256 × 256 = 65536 个数据块\n  ```\n- 65536 个数据块，每个 2048 字节：\n  ```\n65536 × 2048 = 134217728 字节 = 128 MB\n  ```\n\n#### （4）三次间接地址\n- 1 个地址项存 256 个地址，每个地址指向一个间接块，每个间接块再指向 256 个二次间接块，每个二次间接块又指向 256 个数据块：\n  ```\n256 × 256 × 256 = 16777216 个数据块\n  ```\n- 16777216 个数据块，每个 2048 字节：\n  ```\n16777216 × 2048 = 34359738368 字节 = 32 GB\n  ```\n\n### 3. 总文件大小\n```\n直接地址部分 + 一次间接地址 + 二次间接地址 + 三次间接地址\n20480 + 524288 + 134217728 + 34359738368 = 34494963764 字节\n```\n```\n= 32.125 GB\n\n### 4. 结论\n该 UNIX 系统能管理的 **单个文件最大长度** 为 **约 32.13 GB**。","slug":"linux/UNIX操作系统采用i结点管理文件的存储空间","published":1,"updated":"2025-03-27T09:57:07.805Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8v0016ujz3hw4k9td3","content":"<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">## UNIX i 结点管理文件的最大文件长度计算</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">### 1. 给定条件</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"strong\">**磁盘块大小**</span> = 2048 字节</span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"strong\">**每个地址占**</span> = 64 位 = <span class=\"strong\">**8 字节**</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"strong\">**i 结点地址项**</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"strong\">**10 个直接地址**</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"strong\">**1 个一次间接地址**</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"strong\">**1 个二次间接地址**</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"strong\">**1 个三次间接地址**</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">### 2. 计算不同寻址方式可管理的文件大小</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">#### （1）直接地址部分</span></span><br><span class=\"line\">每个直接地址指向 <span class=\"strong\">**1 个磁盘块**</span>，共有 10 个直接地址：</span><br></pre></td></tr></table></figure>\n<p>10 × 2048 &#x3D; 20480 字节</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### （2）一次间接地址</span><br><span class=\"line\">- 1 个地址项可以存储的地址数：</span><br></pre></td></tr></table></figure>\n<p>2048 ÷ 8 &#x3D; 256<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 256 个磁盘块，每个 2048 字节：</span><br></pre></td></tr></table></figure><br>256 × 2048 &#x3D; 524288 字节 &#x3D; 512 KB<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### （3）二次间接地址</span><br><span class=\"line\">- 1 个地址项存 256 个地址，每个地址指向一个间接块，每个间接块又指向 256 个数据块：</span><br></pre></td></tr></table></figure><br>256 × 256 &#x3D; 65536 个数据块<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 65536 个数据块，每个 2048 字节：</span><br></pre></td></tr></table></figure><br>65536 × 2048 &#x3D; 134217728 字节 &#x3D; 128 MB<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### （4）三次间接地址</span><br><span class=\"line\">- 1 个地址项存 256 个地址，每个地址指向一个间接块，每个间接块再指向 256 个二次间接块，每个二次间接块又指向 256 个数据块：</span><br></pre></td></tr></table></figure><br>256 × 256 × 256 &#x3D; 16777216 个数据块<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 16777216 个数据块，每个 2048 字节：</span><br></pre></td></tr></table></figure><br>16777216 × 2048 &#x3D; 34359738368 字节 &#x3D; 32 GB<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">### 3. 总文件大小</span><br></pre></td></tr></table></figure><br>直接地址部分 + 一次间接地址 + 二次间接地址 + 三次间接地址<br>20480 + 524288 + 134217728 + 34359738368 &#x3D; 34494963764 字节</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>&#x3D; 32.125 GB</p>\n<h3 id=\"4-结论\"><a href=\"#4-结论\" class=\"headerlink\" title=\"4. 结论\"></a>4. 结论</h3><p>该 UNIX 系统能管理的 <strong>单个文件最大长度</strong> 为 <strong>约 32.13 GB</strong>。</p>\n","cover":false,"excerpt":"","more":"<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">## UNIX i 结点管理文件的最大文件长度计算</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">### 1. 给定条件</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"strong\">**磁盘块大小**</span> = 2048 字节</span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"strong\">**每个地址占**</span> = 64 位 = <span class=\"strong\">**8 字节**</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"strong\">**i 结点地址项**</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"strong\">**10 个直接地址**</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"strong\">**1 个一次间接地址**</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"strong\">**1 个二次间接地址**</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"strong\">**1 个三次间接地址**</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">### 2. 计算不同寻址方式可管理的文件大小</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">#### （1）直接地址部分</span></span><br><span class=\"line\">每个直接地址指向 <span class=\"strong\">**1 个磁盘块**</span>，共有 10 个直接地址：</span><br></pre></td></tr></table></figure>\n<p>10 × 2048 &#x3D; 20480 字节</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### （2）一次间接地址</span><br><span class=\"line\">- 1 个地址项可以存储的地址数：</span><br></pre></td></tr></table></figure>\n<p>2048 ÷ 8 &#x3D; 256<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 256 个磁盘块，每个 2048 字节：</span><br></pre></td></tr></table></figure><br>256 × 2048 &#x3D; 524288 字节 &#x3D; 512 KB<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### （3）二次间接地址</span><br><span class=\"line\">- 1 个地址项存 256 个地址，每个地址指向一个间接块，每个间接块又指向 256 个数据块：</span><br></pre></td></tr></table></figure><br>256 × 256 &#x3D; 65536 个数据块<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 65536 个数据块，每个 2048 字节：</span><br></pre></td></tr></table></figure><br>65536 × 2048 &#x3D; 134217728 字节 &#x3D; 128 MB<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### （4）三次间接地址</span><br><span class=\"line\">- 1 个地址项存 256 个地址，每个地址指向一个间接块，每个间接块再指向 256 个二次间接块，每个二次间接块又指向 256 个数据块：</span><br></pre></td></tr></table></figure><br>256 × 256 × 256 &#x3D; 16777216 个数据块<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 16777216 个数据块，每个 2048 字节：</span><br></pre></td></tr></table></figure><br>16777216 × 2048 &#x3D; 34359738368 字节 &#x3D; 32 GB<br>  <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">### 3. 总文件大小</span><br></pre></td></tr></table></figure><br>直接地址部分 + 一次间接地址 + 二次间接地址 + 三次间接地址<br>20480 + 524288 + 134217728 + 34359738368 &#x3D; 34494963764 字节</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>&#x3D; 32.125 GB</p>\n<h3 id=\"4-结论\"><a href=\"#4-结论\" class=\"headerlink\" title=\"4. 结论\"></a>4. 结论</h3><p>该 UNIX 系统能管理的 <strong>单个文件最大长度</strong> 为 <strong>约 32.13 GB</strong>。</p>\n"},{"title":"github 将远程仓库更新到自己的仓库中","date":"2024-08-13T08:30:29.000Z","_content":"要将远程仓库的更新同步到你本地的Git仓库中，可以按照以下步骤进行：\n\n1. **添加远程仓库**（如果还没有添加远程仓库）：\n    ```bash\n    git remote add upstream <远程仓库的URL>\n    ```\n   例如，如果你想将GitHub上原始项目的更新同步到你自己的分支，`upstream` 就是你需要添加的远程仓库。\n\n2. **获取远程仓库的更新**：\n    ```bash\n    git fetch upstream\n    ```\n   这将从远程仓库获取所有更新内容，但不会自动合并到你的分支中。\n\n3. **将远程仓库的更新合并到你的分支**：\n    - 如果你在 `main` 分支上，并希望将 `upstream/main` 的更新合并到本地的 `main` 分支：\n        ```bash\n        git checkout main\n        git merge upstream/main\n        ```\n   这会将远程 `main` 分支的更新合并到你本地的 `main` 分支中。\n\n4. **处理可能的冲突**：\n    - 如果在合并时发生冲突，Git 会提示你手动解决冲突。你需要编辑冲突的文件，解决冲突后，运行以下命令：\n        ```bash\n        git add <解决冲突的文件>\n        git commit -m \"Resolved merge conflicts\"\n        ```\n\n5. **将更新推送到你自己的远程仓库**（如果需要）：\n    ```bash\n    git push origin main\n    ```\n   这会将你本地 `main` 分支的更新推送到你自己的GitHub仓库中。\n\n通过这些步骤，你就可以将远程仓库的更新同步到你的本地仓库，并且可以根据需要将这些更新推送到你自己的远程仓库中。","source":"_posts/linux/github-将远程仓库更新到自己的仓库中.md","raw":"---\ntitle: github 将远程仓库更新到自己的仓库中\ndate: 2024-08-13 16:30:29\ncategories: linux\ntag: git\n---\n要将远程仓库的更新同步到你本地的Git仓库中，可以按照以下步骤进行：\n\n1. **添加远程仓库**（如果还没有添加远程仓库）：\n    ```bash\n    git remote add upstream <远程仓库的URL>\n    ```\n   例如，如果你想将GitHub上原始项目的更新同步到你自己的分支，`upstream` 就是你需要添加的远程仓库。\n\n2. **获取远程仓库的更新**：\n    ```bash\n    git fetch upstream\n    ```\n   这将从远程仓库获取所有更新内容，但不会自动合并到你的分支中。\n\n3. **将远程仓库的更新合并到你的分支**：\n    - 如果你在 `main` 分支上，并希望将 `upstream/main` 的更新合并到本地的 `main` 分支：\n        ```bash\n        git checkout main\n        git merge upstream/main\n        ```\n   这会将远程 `main` 分支的更新合并到你本地的 `main` 分支中。\n\n4. **处理可能的冲突**：\n    - 如果在合并时发生冲突，Git 会提示你手动解决冲突。你需要编辑冲突的文件，解决冲突后，运行以下命令：\n        ```bash\n        git add <解决冲突的文件>\n        git commit -m \"Resolved merge conflicts\"\n        ```\n\n5. **将更新推送到你自己的远程仓库**（如果需要）：\n    ```bash\n    git push origin main\n    ```\n   这会将你本地 `main` 分支的更新推送到你自己的GitHub仓库中。\n\n通过这些步骤，你就可以将远程仓库的更新同步到你的本地仓库，并且可以根据需要将这些更新推送到你自己的远程仓库中。","slug":"linux/github-将远程仓库更新到自己的仓库中","published":1,"updated":"2025-02-18T06:31:00.556Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8v0018ujz3drfd4cgv","content":"<p>要将远程仓库的更新同步到你本地的Git仓库中，可以按照以下步骤进行：</p>\n<ol>\n<li><p><strong>添加远程仓库</strong>（如果还没有添加远程仓库）：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git remote add upstream &lt;远程仓库的URL&gt;</span><br></pre></td></tr></table></figure>\n<p>例如，如果你想将GitHub上原始项目的更新同步到你自己的分支，<code>upstream</code> 就是你需要添加的远程仓库。</p>\n</li>\n<li><p><strong>获取远程仓库的更新</strong>：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git fetch upstream</span><br></pre></td></tr></table></figure>\n<p>这将从远程仓库获取所有更新内容，但不会自动合并到你的分支中。</p>\n</li>\n<li><p><strong>将远程仓库的更新合并到你的分支</strong>：</p>\n<ul>\n<li>如果你在 <code>main</code> 分支上，并希望将 <code>upstream/main</code> 的更新合并到本地的 <code>main</code> 分支：  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git checkout main</span><br><span class=\"line\">git merge upstream/main</span><br></pre></td></tr></table></figure>\n这会将远程 <code>main</code> 分支的更新合并到你本地的 <code>main</code> 分支中。</li>\n</ul>\n</li>\n<li><p><strong>处理可能的冲突</strong>：</p>\n<ul>\n<li>如果在合并时发生冲突，Git 会提示你手动解决冲突。你需要编辑冲突的文件，解决冲突后，运行以下命令：  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add &lt;解决冲突的文件&gt;</span><br><span class=\"line\">git commit -m <span class=\"string\">&quot;Resolved merge conflicts&quot;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>将更新推送到你自己的远程仓库</strong>（如果需要）：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git push origin main</span><br></pre></td></tr></table></figure>\n<p>这会将你本地 <code>main</code> 分支的更新推送到你自己的GitHub仓库中。</p>\n</li>\n</ol>\n<p>通过这些步骤，你就可以将远程仓库的更新同步到你的本地仓库，并且可以根据需要将这些更新推送到你自己的远程仓库中。</p>\n","cover":false,"excerpt":"","more":"<p>要将远程仓库的更新同步到你本地的Git仓库中，可以按照以下步骤进行：</p>\n<ol>\n<li><p><strong>添加远程仓库</strong>（如果还没有添加远程仓库）：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git remote add upstream &lt;远程仓库的URL&gt;</span><br></pre></td></tr></table></figure>\n<p>例如，如果你想将GitHub上原始项目的更新同步到你自己的分支，<code>upstream</code> 就是你需要添加的远程仓库。</p>\n</li>\n<li><p><strong>获取远程仓库的更新</strong>：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git fetch upstream</span><br></pre></td></tr></table></figure>\n<p>这将从远程仓库获取所有更新内容，但不会自动合并到你的分支中。</p>\n</li>\n<li><p><strong>将远程仓库的更新合并到你的分支</strong>：</p>\n<ul>\n<li>如果你在 <code>main</code> 分支上，并希望将 <code>upstream/main</code> 的更新合并到本地的 <code>main</code> 分支：  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git checkout main</span><br><span class=\"line\">git merge upstream/main</span><br></pre></td></tr></table></figure>\n这会将远程 <code>main</code> 分支的更新合并到你本地的 <code>main</code> 分支中。</li>\n</ul>\n</li>\n<li><p><strong>处理可能的冲突</strong>：</p>\n<ul>\n<li>如果在合并时发生冲突，Git 会提示你手动解决冲突。你需要编辑冲突的文件，解决冲突后，运行以下命令：  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add &lt;解决冲突的文件&gt;</span><br><span class=\"line\">git commit -m <span class=\"string\">&quot;Resolved merge conflicts&quot;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>将更新推送到你自己的远程仓库</strong>（如果需要）：</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git push origin main</span><br></pre></td></tr></table></figure>\n<p>这会将你本地 <code>main</code> 分支的更新推送到你自己的GitHub仓库中。</p>\n</li>\n</ol>\n<p>通过这些步骤，你就可以将远程仓库的更新同步到你的本地仓库，并且可以根据需要将这些更新推送到你自己的远程仓库中。</p>\n"},{"title":"linux-常用命令","date":"2025-02-20T09:47:37.000Z","_content":"\nlinux自启动：\n\n```bash\ncd /etc/systemd/system/\nvi openvpn-client.service\n```\n\n```bash\n[Unit]\nDescription=OpenVPN client service\nAfter=network.target\n \n[Service]\nType=simple\nExecStart= /usr/sbin/openvpn --config /opt/openvpn/huawei-5600g.ovpn\nRestart=always\n \n[Install]\nWantedBy=multi-user.target\n```\n```bash\nsystemctl daemon-reload\nsystemctl enable openvpn-client.service\n```\n添加jdk环境变量：\n```bash\n　编辑/etc/profile文件 vim /etc/profile    <<---- 通过这种方式，在关闭xshell后，添加的环境变量不生效\n\n　　文件末尾添加：export PATH=\"/usr/local/nginx/sbin/:$PATH\"\n\n　　source  /etc/profile\n```","source":"_posts/linux/linux-常用命令.md","raw":"---\ntitle: linux-常用命令\ndate: 2025-02-20 17:47:37\ncategories: linux\ntag: 常用命令\n---\n\nlinux自启动：\n\n```bash\ncd /etc/systemd/system/\nvi openvpn-client.service\n```\n\n```bash\n[Unit]\nDescription=OpenVPN client service\nAfter=network.target\n \n[Service]\nType=simple\nExecStart= /usr/sbin/openvpn --config /opt/openvpn/huawei-5600g.ovpn\nRestart=always\n \n[Install]\nWantedBy=multi-user.target\n```\n```bash\nsystemctl daemon-reload\nsystemctl enable openvpn-client.service\n```\n添加jdk环境变量：\n```bash\n　编辑/etc/profile文件 vim /etc/profile    <<---- 通过这种方式，在关闭xshell后，添加的环境变量不生效\n\n　　文件末尾添加：export PATH=\"/usr/local/nginx/sbin/:$PATH\"\n\n　　source  /etc/profile\n```","slug":"linux/linux-常用命令","published":1,"updated":"2025-02-27T06:42:41.626Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8v001cujz30jbvba0m","content":"<p>linux自启动：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /etc/systemd/system/</span><br><span class=\"line\">vi openvpn-client.service</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=OpenVPN client service</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"> </span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">ExecStart= /usr/sbin/openvpn --config /opt/openvpn/huawei-5600g.ovpn</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> openvpn-client.service</span><br></pre></td></tr></table></figure>\n<p>添加jdk环境变量：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">　编辑/etc/profile文件 vim /etc/profile    &lt;&lt;---- 通过这种方式，在关闭xshell后，添加的环境变量不生效</span><br><span class=\"line\"></span><br><span class=\"line\">　　文件末尾添加：<span class=\"built_in\">export</span> PATH=<span class=\"string\">&quot;/usr/local/nginx/sbin/:<span class=\"variable\">$PATH</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">　　<span class=\"built_in\">source</span>  /etc/profile</span><br></pre></td></tr></table></figure>","cover":false,"excerpt":"","more":"<p>linux自启动：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /etc/systemd/system/</span><br><span class=\"line\">vi openvpn-client.service</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=OpenVPN client service</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"> </span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">ExecStart= /usr/sbin/openvpn --config /opt/openvpn/huawei-5600g.ovpn</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> openvpn-client.service</span><br></pre></td></tr></table></figure>\n<p>添加jdk环境变量：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">　编辑/etc/profile文件 vim /etc/profile    &lt;&lt;---- 通过这种方式，在关闭xshell后，添加的环境变量不生效</span><br><span class=\"line\"></span><br><span class=\"line\">　　文件末尾添加：<span class=\"built_in\">export</span> PATH=<span class=\"string\">&quot;/usr/local/nginx/sbin/:<span class=\"variable\">$PATH</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">　　<span class=\"built_in\">source</span>  /etc/profile</span><br></pre></td></tr></table></figure>"},{"title":"linux-配置开机自启","date":"2025-02-26T12:29:53.000Z","_content":"### 方法一： 使用 `crontab` 设置开机自动启动\n\n1. **编辑当前用户的 `crontab` 文件**  \n   运行以下命令编辑 `crontab`：\n\n   ```bash\n   crontab -e\n   ```\n\n2. **添加开机启动任务**  \n   在 `crontab` 文件的最后一行添加以下内容，将启动日志输出到log.txt中：\n\n   ```bash\n   @reboot /usr/bin/java -jar /opt/mp/mp-web-1.0.0.jar >> /opt/mp/log.txt 2>&1 \n   ```\n\n3. **验证是否设置成功**  \n   你可以使用以下命令查看已设置的 `crontab` 任务：\n\n   ```bash\n   crontab -l\n   ```\n\n\n### 方法二：使用 `systemd`\n\n`systemd` 是现代 Linux 系统用来启动和管理服务的工具，通常在大多数发行版中都默认安装。\n\n1. **创建一个 systemd 服务文件**  \n   在 `/etc/systemd/system/` 目录下创建一个新的 `.service` 文件，例如 `openvpn-client.service`。\n\n   ```bash\n   sudo vi /etc/systemd/system/openvpn-client.service\n   ```\n\n2. **编辑服务文件**  \n   在文件中加入以下内容：\n\n   ```ini\n   [Unit]\n   Description=OpenVPN client service\n   After=network.target\n   \n   [Service]\n   Type=simple\n   ExecStart= /usr/sbin/openvpn --config /opt/openvpn/xxx.ovpn\n   Restart=always\n   \n   [Install]\n   WantedBy=multi-user.target\n   ```\n3. **重新加载 `systemd` 配置**  \n\n   ```bash\n   sudo systemctl daemon-reload\n   ```\n\n4. **启动服务**  \n   启动服务并验证是否正常运行：\n\n   ```bash\n   sudo systemctl start openvpn-client.service\n   ```\n\n5. **设置开机自启**  \n   启动后，设置服务开机自动启动：\n\n   ```bash\n   sudo systemctl enable openvpn-client.service\n   ```\n\n6. **查看服务状态**  \n   查看服务是否正常运行：\n\n   ```bash\n   sudo systemctl status openvpn-client.service\n   ```\n\n### 方法三：使用 `rc.local`（适用于较老的 Linux 版本）\n\n`rc.local` 是一个比较传统的方式，在一些较老的 Linux 系统中使用。\n\n1. **编辑 `rc.local` 文件**  \n   打开 `/etc/rc.local` 文件，如果文件不存在，可能需要手动创建：\n\n   ```bash\n   sudo vi /etc/rc.local\n   ```\n\n2. **在文件末尾添加启动命令**  \n   在文件末尾添加启动 Java 应用的命令，确保添加在 `exit 0` 之前：\n\n   ```bash\n   /usr/bin/java -jar /path/to/your/project/your-app.jar &\n   ```\n\n   使用 `&` 将应用程序放入后台运行。\n\n3. **确保 `rc.local` 可执行**  \n   如果 `rc.local` 文件没有可执行权限，需要修改：\n\n   ```bash\n   sudo chmod +x /etc/rc.local\n   ```\n\n4. **重启系统**  \n   重启系统后，Java 应用将会自动启动。\n","source":"_posts/linux/linux-配置开机自启.md","raw":"---\ntitle: linux-配置开机自启\ndate: 2025-02-26 20:29:53\ncategories: linux\ntag: 开机自启\n---\n### 方法一： 使用 `crontab` 设置开机自动启动\n\n1. **编辑当前用户的 `crontab` 文件**  \n   运行以下命令编辑 `crontab`：\n\n   ```bash\n   crontab -e\n   ```\n\n2. **添加开机启动任务**  \n   在 `crontab` 文件的最后一行添加以下内容，将启动日志输出到log.txt中：\n\n   ```bash\n   @reboot /usr/bin/java -jar /opt/mp/mp-web-1.0.0.jar >> /opt/mp/log.txt 2>&1 \n   ```\n\n3. **验证是否设置成功**  \n   你可以使用以下命令查看已设置的 `crontab` 任务：\n\n   ```bash\n   crontab -l\n   ```\n\n\n### 方法二：使用 `systemd`\n\n`systemd` 是现代 Linux 系统用来启动和管理服务的工具，通常在大多数发行版中都默认安装。\n\n1. **创建一个 systemd 服务文件**  \n   在 `/etc/systemd/system/` 目录下创建一个新的 `.service` 文件，例如 `openvpn-client.service`。\n\n   ```bash\n   sudo vi /etc/systemd/system/openvpn-client.service\n   ```\n\n2. **编辑服务文件**  \n   在文件中加入以下内容：\n\n   ```ini\n   [Unit]\n   Description=OpenVPN client service\n   After=network.target\n   \n   [Service]\n   Type=simple\n   ExecStart= /usr/sbin/openvpn --config /opt/openvpn/xxx.ovpn\n   Restart=always\n   \n   [Install]\n   WantedBy=multi-user.target\n   ```\n3. **重新加载 `systemd` 配置**  \n\n   ```bash\n   sudo systemctl daemon-reload\n   ```\n\n4. **启动服务**  \n   启动服务并验证是否正常运行：\n\n   ```bash\n   sudo systemctl start openvpn-client.service\n   ```\n\n5. **设置开机自启**  \n   启动后，设置服务开机自动启动：\n\n   ```bash\n   sudo systemctl enable openvpn-client.service\n   ```\n\n6. **查看服务状态**  \n   查看服务是否正常运行：\n\n   ```bash\n   sudo systemctl status openvpn-client.service\n   ```\n\n### 方法三：使用 `rc.local`（适用于较老的 Linux 版本）\n\n`rc.local` 是一个比较传统的方式，在一些较老的 Linux 系统中使用。\n\n1. **编辑 `rc.local` 文件**  \n   打开 `/etc/rc.local` 文件，如果文件不存在，可能需要手动创建：\n\n   ```bash\n   sudo vi /etc/rc.local\n   ```\n\n2. **在文件末尾添加启动命令**  \n   在文件末尾添加启动 Java 应用的命令，确保添加在 `exit 0` 之前：\n\n   ```bash\n   /usr/bin/java -jar /path/to/your/project/your-app.jar &\n   ```\n\n   使用 `&` 将应用程序放入后台运行。\n\n3. **确保 `rc.local` 可执行**  \n   如果 `rc.local` 文件没有可执行权限，需要修改：\n\n   ```bash\n   sudo chmod +x /etc/rc.local\n   ```\n\n4. **重启系统**  \n   重启系统后，Java 应用将会自动启动。\n","slug":"linux/linux-配置开机自启","published":1,"updated":"2025-02-26T12:35:17.628Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8v001fujz3ceq92627","content":"<h3 id=\"方法一：-使用-crontab-设置开机自动启动\"><a href=\"#方法一：-使用-crontab-设置开机自动启动\" class=\"headerlink\" title=\"方法一： 使用 crontab 设置开机自动启动\"></a>方法一： 使用 <code>crontab</code> 设置开机自动启动</h3><ol>\n<li><p><strong>编辑当前用户的 <code>crontab</code> 文件</strong><br>运行以下命令编辑 <code>crontab</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>添加开机启动任务</strong><br>在 <code>crontab</code> 文件的最后一行添加以下内容，将启动日志输出到log.txt中：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@reboot /usr/bin/java -jar /opt/mp/mp-web-1.0.0.jar &gt;&gt; /opt/mp/log.txt 2&gt;&amp;1 </span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>验证是否设置成功</strong><br>你可以使用以下命令查看已设置的 <code>crontab</code> 任务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -l</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"方法二：使用-systemd\"><a href=\"#方法二：使用-systemd\" class=\"headerlink\" title=\"方法二：使用 systemd\"></a>方法二：使用 <code>systemd</code></h3><p><code>systemd</code> 是现代 Linux 系统用来启动和管理服务的工具，通常在大多数发行版中都默认安装。</p>\n<ol>\n<li><p><strong>创建一个 systemd 服务文件</strong><br>在 <code>/etc/systemd/system/</code> 目录下创建一个新的 <code>.service</code> 文件，例如 <code>openvpn-client.service</code>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vi /etc/systemd/system/openvpn-client.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>编辑服务文件</strong><br>在文件中加入以下内容：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[Unit]</span></span><br><span class=\"line\"><span class=\"attr\">Description</span>=OpenVPN client service</span><br><span class=\"line\"><span class=\"attr\">After</span>=network.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">Type</span>=simple</span><br><span class=\"line\"><span class=\"attr\">ExecStart</span>= /usr/sbin/openvpn --config /opt/openvpn/xxx.ovpn</span><br><span class=\"line\"><span class=\"attr\">Restart</span>=always</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[Install]</span></span><br><span class=\"line\"><span class=\"attr\">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure></li>\n<li><p><strong>重新加载 <code>systemd</code> 配置</strong>  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>启动服务</strong><br>启动服务并验证是否正常运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl start openvpn-client.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>设置开机自启</strong><br>启动后，设置服务开机自动启动：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> openvpn-client.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看服务状态</strong><br>查看服务是否正常运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl status openvpn-client.service</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"方法三：使用-rc-local（适用于较老的-Linux-版本）\"><a href=\"#方法三：使用-rc-local（适用于较老的-Linux-版本）\" class=\"headerlink\" title=\"方法三：使用 rc.local（适用于较老的 Linux 版本）\"></a>方法三：使用 <code>rc.local</code>（适用于较老的 Linux 版本）</h3><p><code>rc.local</code> 是一个比较传统的方式，在一些较老的 Linux 系统中使用。</p>\n<ol>\n<li><p><strong>编辑 <code>rc.local</code> 文件</strong><br>打开 <code>/etc/rc.local</code> 文件，如果文件不存在，可能需要手动创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vi /etc/rc.local</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在文件末尾添加启动命令</strong><br>在文件末尾添加启动 Java 应用的命令，确保添加在 <code>exit 0</code> 之前：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/bin/java -jar /path/to/your/project/your-app.jar &amp;</span><br></pre></td></tr></table></figure>\n\n<p>使用 <code>&amp;</code> 将应用程序放入后台运行。</p>\n</li>\n<li><p><strong>确保 <code>rc.local</code> 可执行</strong><br>如果 <code>rc.local</code> 文件没有可执行权限，需要修改：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">chmod</span> +x /etc/rc.local</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>重启系统</strong><br>重启系统后，Java 应用将会自动启动。</p>\n</li>\n</ol>\n","cover":false,"excerpt":"","more":"<h3 id=\"方法一：-使用-crontab-设置开机自动启动\"><a href=\"#方法一：-使用-crontab-设置开机自动启动\" class=\"headerlink\" title=\"方法一： 使用 crontab 设置开机自动启动\"></a>方法一： 使用 <code>crontab</code> 设置开机自动启动</h3><ol>\n<li><p><strong>编辑当前用户的 <code>crontab</code> 文件</strong><br>运行以下命令编辑 <code>crontab</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>添加开机启动任务</strong><br>在 <code>crontab</code> 文件的最后一行添加以下内容，将启动日志输出到log.txt中：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@reboot /usr/bin/java -jar /opt/mp/mp-web-1.0.0.jar &gt;&gt; /opt/mp/log.txt 2&gt;&amp;1 </span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>验证是否设置成功</strong><br>你可以使用以下命令查看已设置的 <code>crontab</code> 任务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -l</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"方法二：使用-systemd\"><a href=\"#方法二：使用-systemd\" class=\"headerlink\" title=\"方法二：使用 systemd\"></a>方法二：使用 <code>systemd</code></h3><p><code>systemd</code> 是现代 Linux 系统用来启动和管理服务的工具，通常在大多数发行版中都默认安装。</p>\n<ol>\n<li><p><strong>创建一个 systemd 服务文件</strong><br>在 <code>/etc/systemd/system/</code> 目录下创建一个新的 <code>.service</code> 文件，例如 <code>openvpn-client.service</code>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vi /etc/systemd/system/openvpn-client.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>编辑服务文件</strong><br>在文件中加入以下内容：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[Unit]</span></span><br><span class=\"line\"><span class=\"attr\">Description</span>=OpenVPN client service</span><br><span class=\"line\"><span class=\"attr\">After</span>=network.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">Type</span>=simple</span><br><span class=\"line\"><span class=\"attr\">ExecStart</span>= /usr/sbin/openvpn --config /opt/openvpn/xxx.ovpn</span><br><span class=\"line\"><span class=\"attr\">Restart</span>=always</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[Install]</span></span><br><span class=\"line\"><span class=\"attr\">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure></li>\n<li><p><strong>重新加载 <code>systemd</code> 配置</strong>  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>启动服务</strong><br>启动服务并验证是否正常运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl start openvpn-client.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>设置开机自启</strong><br>启动后，设置服务开机自动启动：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> openvpn-client.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>查看服务状态</strong><br>查看服务是否正常运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl status openvpn-client.service</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"方法三：使用-rc-local（适用于较老的-Linux-版本）\"><a href=\"#方法三：使用-rc-local（适用于较老的-Linux-版本）\" class=\"headerlink\" title=\"方法三：使用 rc.local（适用于较老的 Linux 版本）\"></a>方法三：使用 <code>rc.local</code>（适用于较老的 Linux 版本）</h3><p><code>rc.local</code> 是一个比较传统的方式，在一些较老的 Linux 系统中使用。</p>\n<ol>\n<li><p><strong>编辑 <code>rc.local</code> 文件</strong><br>打开 <code>/etc/rc.local</code> 文件，如果文件不存在，可能需要手动创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vi /etc/rc.local</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在文件末尾添加启动命令</strong><br>在文件末尾添加启动 Java 应用的命令，确保添加在 <code>exit 0</code> 之前：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/bin/java -jar /path/to/your/project/your-app.jar &amp;</span><br></pre></td></tr></table></figure>\n\n<p>使用 <code>&amp;</code> 将应用程序放入后台运行。</p>\n</li>\n<li><p><strong>确保 <code>rc.local</code> 可执行</strong><br>如果 <code>rc.local</code> 文件没有可执行权限，需要修改：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">chmod</span> +x /etc/rc.local</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>重启系统</strong><br>重启系统后，Java 应用将会自动启动。</p>\n</li>\n</ol>\n"},{"title":"linux下实现钉钉告警","date":"2024-07-23T03:45:38.000Z","_content":"\n在Linux系统中，可以使用Shell脚本和定时任务（cron）来监控CPU、内存和硬盘使用情况，当超过指定阈值时发送告警。为了发送钉钉告警，需要用到钉钉的自定义机器人接口。\n需要注意的是，本教程的机器是12核心。因此需要得到12核心的最高cpu使用率后取最大值。\n\n以下是实现此功能的步骤：\n\n1. **创建钉钉机器人并获取Webhook URL：**\n    - 登录钉钉，创建自定义机器人并获取Webhook URL，用于发送告警信息。\n    \n2. **编写Shell脚本：**\n    - 编写一个Shell脚本来检查系统资源的使用情况，并在超过阈值时发送钉钉告警。\n    \n3. **配置定时任务（cron）：**\n    - 将脚本配置为定时任务，定期检查系统资源的使用情况。\n\n### 1. 创建钉钉机器人并获取Webhook URL\n\n在钉钉中创建自定义机器人，记录下Webhook URL，这将在脚本中用于发送告警。\n- 例如：https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5\n\n### 2. 编写Shell脚本\n\n下面是一个示例Shell脚本`monitor.sh`：\n\n```sh\n#!/bin/bash\n\n# 获取cpu使用率\nfunction get_cpu_usage(){\n    echo $(top -bn1 | grep \"Cpu(s)\" | awk '{print 100 - $8}' | awk '{printf \"%.2f\", $1}')\n}\n\n# 获取磁盘使用率\ndata_name=\"/\" \ndiskUsage=$(df -h | grep -w $data_name | awk '{print $5}' | sed 's/%//')\n\n# 获取内存情况\nmem_total=$(free -m | awk 'NR==2 {print $2}')\nmem_used=$(free -m | awk 'NR==2 {print $3}')\n\n# 统计内存使用率\nmem_used_percent=$(echo \"scale=2; ($mem_used / $mem_total) * 100\" | bc)\n\n# 获取报警时间\nnow_time=$(date '+%F %T')\n\nuser=\"18857415467\"\n\n# 主机信息\nDate_time=$(date \"+%Y-%m-%d--%H:%M:%S\")\nIP_addr=$(hostname -I | awk '{print $1}')\n\n# webhook url\nDingding_Url=\"https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5\"\n\nfunction SendDownMessageToDingding(){\n    # 发送钉钉消息\n    curl -s \"${Dingding_Url}\" -H 'Content-Type: application/json' -d \"\n    {\n     'msgtype': 'text',\n     'text': {'content': '资源耗尽警告！\\n巡查时间：${Date_time}\\nIP地址：${IP_addr}\\n资源状况如下:\\n【CPU使用率：${cpuUsage}%】\\n【磁盘使用率：${diskUsage}%】\\n【内存使用率：${mem_used_percent}%】'},\n     'at': {'atMobiles': ['${user}'], 'isAtAll': true}\n      }\"\n}\n\nfunction check(){\n    cpuUsage=$(get_cpu_usage)\n    if (( $(echo \"$cpuUsage > 90\" | bc -l) )); then\n        echo \"检测到CPU使用率高于90%，开始1分钟监控...\"\n        high_cpu_duration=0\n        for ((i=0; i<60; i++)); do\n            sleep 1\n            cpuUsage=$(get_cpu_usage)\n            if (( $(echo \"$cpuUsage > 90\" | bc -l) )); then\n                ((high_cpu_duration++))\n            else\n                high_cpu_duration=0\n            fi\n\n            if (( high_cpu_duration >= 60 )); then\n                echo \"CPU使用率持续高于90%超过1分钟，发送警报...\"\n                SendDownMessageToDingding\n                break\n            fi\n        done\n    fi\n\n    if (( $(echo \"$diskUsage > 80\" | bc -l) )) || (( $(echo \"$mem_used_percent > 80\" | bc -l) )); then\n        SendDownMessageToDingding\n    fi\n}\n\ncheck\n\n```\n\n将`073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5`替换为你从钉钉获取的Webhook URL的token。\n\n### 3. 配置定时任务（cron）\n\n通过cron定期运行这个脚本。首先，编辑cron配置：\n\n```sh\ncrontab -e\n```\n\n然后添加以下内容以每分钟运行一次脚本：\n\n```sh\n* * * * * /path/to/monitor.sh\n```\n\n确保脚本`monitor.sh`有执行权限：\n\n```sh\nchmod +x /path/to/monitor.sh\n```\n\n### 总结\n\n上述脚本和cron配置将监控CPU、内存和硬盘使用情况，并在超过设定的阈值时通过钉钉发送告警消息。你可以根据实际需求调整脚本的执行频率和告警阈值。","source":"_posts/linux/linux下实现钉钉告警.md","raw":"---\ntitle: linux下实现钉钉告警\ndate: 2024-07-23 11:45:38\ncategories: linux\ntag: 报警\n---\n\n在Linux系统中，可以使用Shell脚本和定时任务（cron）来监控CPU、内存和硬盘使用情况，当超过指定阈值时发送告警。为了发送钉钉告警，需要用到钉钉的自定义机器人接口。\n需要注意的是，本教程的机器是12核心。因此需要得到12核心的最高cpu使用率后取最大值。\n\n以下是实现此功能的步骤：\n\n1. **创建钉钉机器人并获取Webhook URL：**\n    - 登录钉钉，创建自定义机器人并获取Webhook URL，用于发送告警信息。\n    \n2. **编写Shell脚本：**\n    - 编写一个Shell脚本来检查系统资源的使用情况，并在超过阈值时发送钉钉告警。\n    \n3. **配置定时任务（cron）：**\n    - 将脚本配置为定时任务，定期检查系统资源的使用情况。\n\n### 1. 创建钉钉机器人并获取Webhook URL\n\n在钉钉中创建自定义机器人，记录下Webhook URL，这将在脚本中用于发送告警。\n- 例如：https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5\n\n### 2. 编写Shell脚本\n\n下面是一个示例Shell脚本`monitor.sh`：\n\n```sh\n#!/bin/bash\n\n# 获取cpu使用率\nfunction get_cpu_usage(){\n    echo $(top -bn1 | grep \"Cpu(s)\" | awk '{print 100 - $8}' | awk '{printf \"%.2f\", $1}')\n}\n\n# 获取磁盘使用率\ndata_name=\"/\" \ndiskUsage=$(df -h | grep -w $data_name | awk '{print $5}' | sed 's/%//')\n\n# 获取内存情况\nmem_total=$(free -m | awk 'NR==2 {print $2}')\nmem_used=$(free -m | awk 'NR==2 {print $3}')\n\n# 统计内存使用率\nmem_used_percent=$(echo \"scale=2; ($mem_used / $mem_total) * 100\" | bc)\n\n# 获取报警时间\nnow_time=$(date '+%F %T')\n\nuser=\"18857415467\"\n\n# 主机信息\nDate_time=$(date \"+%Y-%m-%d--%H:%M:%S\")\nIP_addr=$(hostname -I | awk '{print $1}')\n\n# webhook url\nDingding_Url=\"https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5\"\n\nfunction SendDownMessageToDingding(){\n    # 发送钉钉消息\n    curl -s \"${Dingding_Url}\" -H 'Content-Type: application/json' -d \"\n    {\n     'msgtype': 'text',\n     'text': {'content': '资源耗尽警告！\\n巡查时间：${Date_time}\\nIP地址：${IP_addr}\\n资源状况如下:\\n【CPU使用率：${cpuUsage}%】\\n【磁盘使用率：${diskUsage}%】\\n【内存使用率：${mem_used_percent}%】'},\n     'at': {'atMobiles': ['${user}'], 'isAtAll': true}\n      }\"\n}\n\nfunction check(){\n    cpuUsage=$(get_cpu_usage)\n    if (( $(echo \"$cpuUsage > 90\" | bc -l) )); then\n        echo \"检测到CPU使用率高于90%，开始1分钟监控...\"\n        high_cpu_duration=0\n        for ((i=0; i<60; i++)); do\n            sleep 1\n            cpuUsage=$(get_cpu_usage)\n            if (( $(echo \"$cpuUsage > 90\" | bc -l) )); then\n                ((high_cpu_duration++))\n            else\n                high_cpu_duration=0\n            fi\n\n            if (( high_cpu_duration >= 60 )); then\n                echo \"CPU使用率持续高于90%超过1分钟，发送警报...\"\n                SendDownMessageToDingding\n                break\n            fi\n        done\n    fi\n\n    if (( $(echo \"$diskUsage > 80\" | bc -l) )) || (( $(echo \"$mem_used_percent > 80\" | bc -l) )); then\n        SendDownMessageToDingding\n    fi\n}\n\ncheck\n\n```\n\n将`073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5`替换为你从钉钉获取的Webhook URL的token。\n\n### 3. 配置定时任务（cron）\n\n通过cron定期运行这个脚本。首先，编辑cron配置：\n\n```sh\ncrontab -e\n```\n\n然后添加以下内容以每分钟运行一次脚本：\n\n```sh\n* * * * * /path/to/monitor.sh\n```\n\n确保脚本`monitor.sh`有执行权限：\n\n```sh\nchmod +x /path/to/monitor.sh\n```\n\n### 总结\n\n上述脚本和cron配置将监控CPU、内存和硬盘使用情况，并在超过设定的阈值时通过钉钉发送告警消息。你可以根据实际需求调整脚本的执行频率和告警阈值。","slug":"linux/linux下实现钉钉告警","published":1,"updated":"2025-02-18T06:31:00.569Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8v001iujz3eiv15r7k","content":"<p>在Linux系统中，可以使用Shell脚本和定时任务（cron）来监控CPU、内存和硬盘使用情况，当超过指定阈值时发送告警。为了发送钉钉告警，需要用到钉钉的自定义机器人接口。<br>需要注意的是，本教程的机器是12核心。因此需要得到12核心的最高cpu使用率后取最大值。</p>\n<p>以下是实现此功能的步骤：</p>\n<ol>\n<li><p><strong>创建钉钉机器人并获取Webhook URL：</strong></p>\n<ul>\n<li>登录钉钉，创建自定义机器人并获取Webhook URL，用于发送告警信息。</li>\n</ul>\n</li>\n<li><p><strong>编写Shell脚本：</strong></p>\n<ul>\n<li>编写一个Shell脚本来检查系统资源的使用情况，并在超过阈值时发送钉钉告警。</li>\n</ul>\n</li>\n<li><p><strong>配置定时任务（cron）：</strong></p>\n<ul>\n<li>将脚本配置为定时任务，定期检查系统资源的使用情况。</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"1-创建钉钉机器人并获取Webhook-URL\"><a href=\"#1-创建钉钉机器人并获取Webhook-URL\" class=\"headerlink\" title=\"1. 创建钉钉机器人并获取Webhook URL\"></a>1. 创建钉钉机器人并获取Webhook URL</h3><p>在钉钉中创建自定义机器人，记录下Webhook URL，这将在脚本中用于发送告警。</p>\n<ul>\n<li>例如：<a href=\"https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5\">https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5</a></li>\n</ul>\n<h3 id=\"2-编写Shell脚本\"><a href=\"#2-编写Shell脚本\" class=\"headerlink\" title=\"2. 编写Shell脚本\"></a>2. 编写Shell脚本</h3><p>下面是一个示例Shell脚本<code>monitor.sh</code>：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取cpu使用率</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">get_cpu_usage</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> $(top -bn1 | grep <span class=\"string\">&quot;Cpu(s)&quot;</span> | awk <span class=\"string\">&#x27;&#123;print 100 - $8&#125;&#x27;</span> | awk <span class=\"string\">&#x27;&#123;printf &quot;%.2f&quot;, $1&#125;&#x27;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取磁盘使用率</span></span><br><span class=\"line\">data_name=<span class=\"string\">&quot;/&quot;</span> </span><br><span class=\"line\">diskUsage=$(<span class=\"built_in\">df</span> -h | grep -w <span class=\"variable\">$data_name</span> | awk <span class=\"string\">&#x27;&#123;print $5&#125;&#x27;</span> | sed <span class=\"string\">&#x27;s/%//&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取内存情况</span></span><br><span class=\"line\">mem_total=$(free -m | awk <span class=\"string\">&#x27;NR==2 &#123;print $2&#125;&#x27;</span>)</span><br><span class=\"line\">mem_used=$(free -m | awk <span class=\"string\">&#x27;NR==2 &#123;print $3&#125;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计内存使用率</span></span><br><span class=\"line\">mem_used_percent=$(<span class=\"built_in\">echo</span> <span class=\"string\">&quot;scale=2; (<span class=\"variable\">$mem_used</span> / <span class=\"variable\">$mem_total</span>) * 100&quot;</span> | bc)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取报警时间</span></span><br><span class=\"line\">now_time=$(<span class=\"built_in\">date</span> <span class=\"string\">&#x27;+%F %T&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">user=<span class=\"string\">&quot;18857415467&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机信息</span></span><br><span class=\"line\">Date_time=$(<span class=\"built_in\">date</span> <span class=\"string\">&quot;+%Y-%m-%d--%H:%M:%S&quot;</span>)</span><br><span class=\"line\">IP_addr=$(hostname -I | awk <span class=\"string\">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># webhook url</span></span><br><span class=\"line\">Dingding_Url=<span class=\"string\">&quot;https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">SendDownMessageToDingding</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"comment\"># 发送钉钉消息</span></span><br><span class=\"line\">    curl -s <span class=\"string\">&quot;<span class=\"variable\">$&#123;Dingding_Url&#125;</span>&quot;</span> -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> -d <span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">     &#x27;msgtype&#x27;: &#x27;text&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">     &#x27;text&#x27;: &#123;&#x27;content&#x27;: &#x27;资源耗尽警告！\\n巡查时间：<span class=\"variable\">$&#123;Date_time&#125;</span>\\nIP地址：<span class=\"variable\">$&#123;IP_addr&#125;</span>\\n资源状况如下:\\n【CPU使用率：<span class=\"variable\">$&#123;cpuUsage&#125;</span>%】\\n【磁盘使用率：<span class=\"variable\">$&#123;diskUsage&#125;</span>%】\\n【内存使用率：<span class=\"variable\">$&#123;mem_used_percent&#125;</span>%】&#x27;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">     &#x27;at&#x27;: &#123;&#x27;atMobiles&#x27;: [&#x27;<span class=\"variable\">$&#123;user&#125;</span>&#x27;], &#x27;isAtAll&#x27;: true&#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">check</span></span>()&#123;</span><br><span class=\"line\">    cpuUsage=$(get_cpu_usage)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (( $(echo &quot;<span class=\"variable\">$cpuUsage</span> &gt; <span class=\"number\">90</span>&quot; | bc -l) )); <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;检测到CPU使用率高于90%，开始1分钟监控...&quot;</span></span><br><span class=\"line\">        high_cpu_duration=0</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ((i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">60</span>; i++)); <span class=\"keyword\">do</span></span><br><span class=\"line\">            <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\">            cpuUsage=$(get_cpu_usage)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (( $(echo &quot;<span class=\"variable\">$cpuUsage</span> &gt; <span class=\"number\">90</span>&quot; | bc -l) )); <span class=\"keyword\">then</span></span><br><span class=\"line\">                ((high_cpu_duration++))</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                high_cpu_duration=0</span><br><span class=\"line\">            <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (( high_cpu_duration &gt;= <span class=\"number\">60</span> )); <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&quot;CPU使用率持续高于90%超过1分钟，发送警报...&quot;</span></span><br><span class=\"line\">                SendDownMessageToDingding</span><br><span class=\"line\">                <span class=\"built_in\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"keyword\">done</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (( $(echo &quot;<span class=\"variable\">$diskUsage</span> &gt; <span class=\"number\">80</span>&quot; | bc -l) )) || (( $(echo &quot;<span class=\"variable\">$mem_used_percent</span> &gt; <span class=\"number\">80</span>&quot; | bc -l) )); <span class=\"keyword\">then</span></span><br><span class=\"line\">        SendDownMessageToDingding</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">check</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>将<code>073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5</code>替换为你从钉钉获取的Webhook URL的token。</p>\n<h3 id=\"3-配置定时任务（cron）\"><a href=\"#3-配置定时任务（cron）\" class=\"headerlink\" title=\"3. 配置定时任务（cron）\"></a>3. 配置定时任务（cron）</h3><p>通过cron定期运行这个脚本。首先，编辑cron配置：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br></pre></td></tr></table></figure>\n\n<p>然后添加以下内容以每分钟运行一次脚本：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* * * * * /path/to/monitor.sh</span><br></pre></td></tr></table></figure>\n\n<p>确保脚本<code>monitor.sh</code>有执行权限：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x /path/to/monitor.sh</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>上述脚本和cron配置将监控CPU、内存和硬盘使用情况，并在超过设定的阈值时通过钉钉发送告警消息。你可以根据实际需求调整脚本的执行频率和告警阈值。</p>\n","cover":false,"excerpt":"","more":"<p>在Linux系统中，可以使用Shell脚本和定时任务（cron）来监控CPU、内存和硬盘使用情况，当超过指定阈值时发送告警。为了发送钉钉告警，需要用到钉钉的自定义机器人接口。<br>需要注意的是，本教程的机器是12核心。因此需要得到12核心的最高cpu使用率后取最大值。</p>\n<p>以下是实现此功能的步骤：</p>\n<ol>\n<li><p><strong>创建钉钉机器人并获取Webhook URL：</strong></p>\n<ul>\n<li>登录钉钉，创建自定义机器人并获取Webhook URL，用于发送告警信息。</li>\n</ul>\n</li>\n<li><p><strong>编写Shell脚本：</strong></p>\n<ul>\n<li>编写一个Shell脚本来检查系统资源的使用情况，并在超过阈值时发送钉钉告警。</li>\n</ul>\n</li>\n<li><p><strong>配置定时任务（cron）：</strong></p>\n<ul>\n<li>将脚本配置为定时任务，定期检查系统资源的使用情况。</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"1-创建钉钉机器人并获取Webhook-URL\"><a href=\"#1-创建钉钉机器人并获取Webhook-URL\" class=\"headerlink\" title=\"1. 创建钉钉机器人并获取Webhook URL\"></a>1. 创建钉钉机器人并获取Webhook URL</h3><p>在钉钉中创建自定义机器人，记录下Webhook URL，这将在脚本中用于发送告警。</p>\n<ul>\n<li>例如：<a href=\"https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5\">https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5</a></li>\n</ul>\n<h3 id=\"2-编写Shell脚本\"><a href=\"#2-编写Shell脚本\" class=\"headerlink\" title=\"2. 编写Shell脚本\"></a>2. 编写Shell脚本</h3><p>下面是一个示例Shell脚本<code>monitor.sh</code>：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取cpu使用率</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">get_cpu_usage</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> $(top -bn1 | grep <span class=\"string\">&quot;Cpu(s)&quot;</span> | awk <span class=\"string\">&#x27;&#123;print 100 - $8&#125;&#x27;</span> | awk <span class=\"string\">&#x27;&#123;printf &quot;%.2f&quot;, $1&#125;&#x27;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取磁盘使用率</span></span><br><span class=\"line\">data_name=<span class=\"string\">&quot;/&quot;</span> </span><br><span class=\"line\">diskUsage=$(<span class=\"built_in\">df</span> -h | grep -w <span class=\"variable\">$data_name</span> | awk <span class=\"string\">&#x27;&#123;print $5&#125;&#x27;</span> | sed <span class=\"string\">&#x27;s/%//&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取内存情况</span></span><br><span class=\"line\">mem_total=$(free -m | awk <span class=\"string\">&#x27;NR==2 &#123;print $2&#125;&#x27;</span>)</span><br><span class=\"line\">mem_used=$(free -m | awk <span class=\"string\">&#x27;NR==2 &#123;print $3&#125;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计内存使用率</span></span><br><span class=\"line\">mem_used_percent=$(<span class=\"built_in\">echo</span> <span class=\"string\">&quot;scale=2; (<span class=\"variable\">$mem_used</span> / <span class=\"variable\">$mem_total</span>) * 100&quot;</span> | bc)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取报警时间</span></span><br><span class=\"line\">now_time=$(<span class=\"built_in\">date</span> <span class=\"string\">&#x27;+%F %T&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">user=<span class=\"string\">&quot;18857415467&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机信息</span></span><br><span class=\"line\">Date_time=$(<span class=\"built_in\">date</span> <span class=\"string\">&quot;+%Y-%m-%d--%H:%M:%S&quot;</span>)</span><br><span class=\"line\">IP_addr=$(hostname -I | awk <span class=\"string\">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># webhook url</span></span><br><span class=\"line\">Dingding_Url=<span class=\"string\">&quot;https://oapi.dingtalk.com/robot/send?access_token=073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">SendDownMessageToDingding</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"comment\"># 发送钉钉消息</span></span><br><span class=\"line\">    curl -s <span class=\"string\">&quot;<span class=\"variable\">$&#123;Dingding_Url&#125;</span>&quot;</span> -H <span class=\"string\">&#x27;Content-Type: application/json&#x27;</span> -d <span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">     &#x27;msgtype&#x27;: &#x27;text&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">     &#x27;text&#x27;: &#123;&#x27;content&#x27;: &#x27;资源耗尽警告！\\n巡查时间：<span class=\"variable\">$&#123;Date_time&#125;</span>\\nIP地址：<span class=\"variable\">$&#123;IP_addr&#125;</span>\\n资源状况如下:\\n【CPU使用率：<span class=\"variable\">$&#123;cpuUsage&#125;</span>%】\\n【磁盘使用率：<span class=\"variable\">$&#123;diskUsage&#125;</span>%】\\n【内存使用率：<span class=\"variable\">$&#123;mem_used_percent&#125;</span>%】&#x27;&#125;,</span></span><br><span class=\"line\"><span class=\"string\">     &#x27;at&#x27;: &#123;&#x27;atMobiles&#x27;: [&#x27;<span class=\"variable\">$&#123;user&#125;</span>&#x27;], &#x27;isAtAll&#x27;: true&#125;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">check</span></span>()&#123;</span><br><span class=\"line\">    cpuUsage=$(get_cpu_usage)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (( $(echo &quot;<span class=\"variable\">$cpuUsage</span> &gt; <span class=\"number\">90</span>&quot; | bc -l) )); <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;检测到CPU使用率高于90%，开始1分钟监控...&quot;</span></span><br><span class=\"line\">        high_cpu_duration=0</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ((i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">60</span>; i++)); <span class=\"keyword\">do</span></span><br><span class=\"line\">            <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\">            cpuUsage=$(get_cpu_usage)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (( $(echo &quot;<span class=\"variable\">$cpuUsage</span> &gt; <span class=\"number\">90</span>&quot; | bc -l) )); <span class=\"keyword\">then</span></span><br><span class=\"line\">                ((high_cpu_duration++))</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                high_cpu_duration=0</span><br><span class=\"line\">            <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (( high_cpu_duration &gt;= <span class=\"number\">60</span> )); <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&quot;CPU使用率持续高于90%超过1分钟，发送警报...&quot;</span></span><br><span class=\"line\">                SendDownMessageToDingding</span><br><span class=\"line\">                <span class=\"built_in\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"keyword\">done</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (( $(echo &quot;<span class=\"variable\">$diskUsage</span> &gt; <span class=\"number\">80</span>&quot; | bc -l) )) || (( $(echo &quot;<span class=\"variable\">$mem_used_percent</span> &gt; <span class=\"number\">80</span>&quot; | bc -l) )); <span class=\"keyword\">then</span></span><br><span class=\"line\">        SendDownMessageToDingding</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">check</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>将<code>073d84ae5a2f83494c9271e0e1683603130b19e77620a836e3682a62ffd1a8f5</code>替换为你从钉钉获取的Webhook URL的token。</p>\n<h3 id=\"3-配置定时任务（cron）\"><a href=\"#3-配置定时任务（cron）\" class=\"headerlink\" title=\"3. 配置定时任务（cron）\"></a>3. 配置定时任务（cron）</h3><p>通过cron定期运行这个脚本。首先，编辑cron配置：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br></pre></td></tr></table></figure>\n\n<p>然后添加以下内容以每分钟运行一次脚本：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* * * * * /path/to/monitor.sh</span><br></pre></td></tr></table></figure>\n\n<p>确保脚本<code>monitor.sh</code>有执行权限：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x /path/to/monitor.sh</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>上述脚本和cron配置将监控CPU、内存和硬盘使用情况，并在超过设定的阈值时通过钉钉发送告警消息。你可以根据实际需求调整脚本的执行频率和告警阈值。</p>\n"},{"title":"linux下通过端口找到进程","date":"2024-08-09T06:48:30.000Z","_content":"在Linux系统中，可以使用以下几种方法通过端口号查找占用该端口的进程：\n\n### 1. 使用 `lsof` 命令\n`lsof` 是一个用于列出打开的文件的命令，它也可以用于查找正在使用某个端口的进程。\n\n```bash\nlsof -i :<端口号>\n```\n\n例如，查找占用80端口的进程：\n```bash\nlsof -i :80\n```\n\n### 2. 使用 `netstat` 命令\n`netstat` 是一个网络状态监控工具，可以显示与网络相关的内容，包括哪些进程在监听哪些端口。\n\n```bash\nnetstat -tuln | grep :<端口号>\n```\n\n例如，查找占用80端口的进程：\n```bash\nnetstat -tuln | grep :80\n```\n\n结合 `netstat` 和 `grep` 命令，还可以找到对应的PID：\n```bash\nnetstat -tulnp | grep :<端口号>\n```\n\n### 3. 使用 `ss` 命令\n`ss` 是 `netstat` 的替代品，用于显示socket统计信息，可以更快速地显示网络连接。\n\n```bash\nss -tuln | grep :<端口号>\n```\n\n例如，查找占用80端口的进程：\n```bash\nss -tuln | grep :80\n```\n\n### 4. 使用 `fuser` 命令\n`fuser` 是一个显示哪个进程使用哪些文件或socket的命令。可以直接显示占用指定端口的进程PID。\n\n```bash\nfuser <端口号>/tcp\n```\n\n例如，查找占用80端口的进程：\n```bash\nfuser 80/tcp\n```\n\n### 5. 查看详细的进程信息\n一旦获得了PID，可以使用 `ps` 命令来查看进程的详细信息。\n\n```bash\nps -p <PID> -o pid,cmd\n```\n\n例如：\n```bash\nps -p 1234 -o pid,cmd\n```\n\n这将显示PID为1234的进程的命令行。\n\n通过这些方法，您可以很容易地查找到占用特定端口的进程并获取相应的PID和其他信息。","source":"_posts/linux/linux下通过端口找到进程.md","raw":"---\ntitle: linux下通过端口找到进程\ndate: 2024-08-09 14:48:30\ncategories: linux\ntag: 查找进程\n---\n在Linux系统中，可以使用以下几种方法通过端口号查找占用该端口的进程：\n\n### 1. 使用 `lsof` 命令\n`lsof` 是一个用于列出打开的文件的命令，它也可以用于查找正在使用某个端口的进程。\n\n```bash\nlsof -i :<端口号>\n```\n\n例如，查找占用80端口的进程：\n```bash\nlsof -i :80\n```\n\n### 2. 使用 `netstat` 命令\n`netstat` 是一个网络状态监控工具，可以显示与网络相关的内容，包括哪些进程在监听哪些端口。\n\n```bash\nnetstat -tuln | grep :<端口号>\n```\n\n例如，查找占用80端口的进程：\n```bash\nnetstat -tuln | grep :80\n```\n\n结合 `netstat` 和 `grep` 命令，还可以找到对应的PID：\n```bash\nnetstat -tulnp | grep :<端口号>\n```\n\n### 3. 使用 `ss` 命令\n`ss` 是 `netstat` 的替代品，用于显示socket统计信息，可以更快速地显示网络连接。\n\n```bash\nss -tuln | grep :<端口号>\n```\n\n例如，查找占用80端口的进程：\n```bash\nss -tuln | grep :80\n```\n\n### 4. 使用 `fuser` 命令\n`fuser` 是一个显示哪个进程使用哪些文件或socket的命令。可以直接显示占用指定端口的进程PID。\n\n```bash\nfuser <端口号>/tcp\n```\n\n例如，查找占用80端口的进程：\n```bash\nfuser 80/tcp\n```\n\n### 5. 查看详细的进程信息\n一旦获得了PID，可以使用 `ps` 命令来查看进程的详细信息。\n\n```bash\nps -p <PID> -o pid,cmd\n```\n\n例如：\n```bash\nps -p 1234 -o pid,cmd\n```\n\n这将显示PID为1234的进程的命令行。\n\n通过这些方法，您可以很容易地查找到占用特定端口的进程并获取相应的PID和其他信息。","slug":"linux/linux下通过端口找到进程","published":1,"updated":"2025-02-18T06:31:00.562Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8w001lujz3132c45x5","content":"<p>在Linux系统中，可以使用以下几种方法通过端口号查找占用该端口的进程：</p>\n<h3 id=\"1-使用-lsof-命令\"><a href=\"#1-使用-lsof-命令\" class=\"headerlink\" title=\"1. 使用 lsof 命令\"></a>1. 使用 <code>lsof</code> 命令</h3><p><code>lsof</code> 是一个用于列出打开的文件的命令，它也可以用于查找正在使用某个端口的进程。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsof -i :&lt;端口号&gt;</span><br></pre></td></tr></table></figure>\n\n<p>例如，查找占用80端口的进程：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsof -i :80</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-使用-netstat-命令\"><a href=\"#2-使用-netstat-命令\" class=\"headerlink\" title=\"2. 使用 netstat 命令\"></a>2. 使用 <code>netstat</code> 命令</h3><p><code>netstat</code> 是一个网络状态监控工具，可以显示与网络相关的内容，包括哪些进程在监听哪些端口。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -tuln | grep :&lt;端口号&gt;</span><br></pre></td></tr></table></figure>\n\n<p>例如，查找占用80端口的进程：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -tuln | grep :80</span><br></pre></td></tr></table></figure>\n\n<p>结合 <code>netstat</code> 和 <code>grep</code> 命令，还可以找到对应的PID：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -tulnp | grep :&lt;端口号&gt;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-使用-ss-命令\"><a href=\"#3-使用-ss-命令\" class=\"headerlink\" title=\"3. 使用 ss 命令\"></a>3. 使用 <code>ss</code> 命令</h3><p><code>ss</code> 是 <code>netstat</code> 的替代品，用于显示socket统计信息，可以更快速地显示网络连接。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ss -tuln | grep :&lt;端口号&gt;</span><br></pre></td></tr></table></figure>\n\n<p>例如，查找占用80端口的进程：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ss -tuln | grep :80</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-使用-fuser-命令\"><a href=\"#4-使用-fuser-命令\" class=\"headerlink\" title=\"4. 使用 fuser 命令\"></a>4. 使用 <code>fuser</code> 命令</h3><p><code>fuser</code> 是一个显示哪个进程使用哪些文件或socket的命令。可以直接显示占用指定端口的进程PID。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fuser &lt;端口号&gt;/tcp</span><br></pre></td></tr></table></figure>\n\n<p>例如，查找占用80端口的进程：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fuser 80/tcp</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-查看详细的进程信息\"><a href=\"#5-查看详细的进程信息\" class=\"headerlink\" title=\"5. 查看详细的进程信息\"></a>5. 查看详细的进程信息</h3><p>一旦获得了PID，可以使用 <code>ps</code> 命令来查看进程的详细信息。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps -p &lt;PID&gt; -o pid,cmd</span><br></pre></td></tr></table></figure>\n\n<p>例如：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps -p 1234 -o pid,cmd</span><br></pre></td></tr></table></figure>\n\n<p>这将显示PID为1234的进程的命令行。</p>\n<p>通过这些方法，您可以很容易地查找到占用特定端口的进程并获取相应的PID和其他信息。</p>\n","cover":false,"excerpt":"","more":"<p>在Linux系统中，可以使用以下几种方法通过端口号查找占用该端口的进程：</p>\n<h3 id=\"1-使用-lsof-命令\"><a href=\"#1-使用-lsof-命令\" class=\"headerlink\" title=\"1. 使用 lsof 命令\"></a>1. 使用 <code>lsof</code> 命令</h3><p><code>lsof</code> 是一个用于列出打开的文件的命令，它也可以用于查找正在使用某个端口的进程。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsof -i :&lt;端口号&gt;</span><br></pre></td></tr></table></figure>\n\n<p>例如，查找占用80端口的进程：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsof -i :80</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-使用-netstat-命令\"><a href=\"#2-使用-netstat-命令\" class=\"headerlink\" title=\"2. 使用 netstat 命令\"></a>2. 使用 <code>netstat</code> 命令</h3><p><code>netstat</code> 是一个网络状态监控工具，可以显示与网络相关的内容，包括哪些进程在监听哪些端口。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -tuln | grep :&lt;端口号&gt;</span><br></pre></td></tr></table></figure>\n\n<p>例如，查找占用80端口的进程：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -tuln | grep :80</span><br></pre></td></tr></table></figure>\n\n<p>结合 <code>netstat</code> 和 <code>grep</code> 命令，还可以找到对应的PID：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -tulnp | grep :&lt;端口号&gt;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-使用-ss-命令\"><a href=\"#3-使用-ss-命令\" class=\"headerlink\" title=\"3. 使用 ss 命令\"></a>3. 使用 <code>ss</code> 命令</h3><p><code>ss</code> 是 <code>netstat</code> 的替代品，用于显示socket统计信息，可以更快速地显示网络连接。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ss -tuln | grep :&lt;端口号&gt;</span><br></pre></td></tr></table></figure>\n\n<p>例如，查找占用80端口的进程：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ss -tuln | grep :80</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-使用-fuser-命令\"><a href=\"#4-使用-fuser-命令\" class=\"headerlink\" title=\"4. 使用 fuser 命令\"></a>4. 使用 <code>fuser</code> 命令</h3><p><code>fuser</code> 是一个显示哪个进程使用哪些文件或socket的命令。可以直接显示占用指定端口的进程PID。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fuser &lt;端口号&gt;/tcp</span><br></pre></td></tr></table></figure>\n\n<p>例如，查找占用80端口的进程：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fuser 80/tcp</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-查看详细的进程信息\"><a href=\"#5-查看详细的进程信息\" class=\"headerlink\" title=\"5. 查看详细的进程信息\"></a>5. 查看详细的进程信息</h3><p>一旦获得了PID，可以使用 <code>ps</code> 命令来查看进程的详细信息。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps -p &lt;PID&gt; -o pid,cmd</span><br></pre></td></tr></table></figure>\n\n<p>例如：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps -p 1234 -o pid,cmd</span><br></pre></td></tr></table></figure>\n\n<p>这将显示PID为1234的进程的命令行。</p>\n<p>通过这些方法，您可以很容易地查找到占用特定端口的进程并获取相应的PID和其他信息。</p>\n"},{"title":"nginx配置https","date":"2025-02-26T11:52:07.000Z","_content":"```shell\nserver {\n    listen 80;\n    server_name xxx.beeflyx.cloud;\n\n    # 强制 HTTP 重定向到 HTTPS\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443 ssl;\n    server_name xxx.beeflyx.cloud;\n\n    ssl_certificate /etc/nginx/conf.d/cert/xxx.beeflyx.cloud_bundle.crt;\n    ssl_certificate_key /etc/nginx/conf.d/cert/xxx.beeflyx.cloud.key;\n\n    location / {\n        proxy_pass http://127.0.0.1:3000;\n    }\n}\n```","source":"_posts/linux/nginx配置https.md","raw":"---\ntitle: nginx配置https\ndate: 2025-02-26 19:52:07\ncategories: linux\ntag: nginx\n---\n```shell\nserver {\n    listen 80;\n    server_name xxx.beeflyx.cloud;\n\n    # 强制 HTTP 重定向到 HTTPS\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443 ssl;\n    server_name xxx.beeflyx.cloud;\n\n    ssl_certificate /etc/nginx/conf.d/cert/xxx.beeflyx.cloud_bundle.crt;\n    ssl_certificate_key /etc/nginx/conf.d/cert/xxx.beeflyx.cloud.key;\n\n    location / {\n        proxy_pass http://127.0.0.1:3000;\n    }\n}\n```","slug":"linux/nginx配置https","published":1,"updated":"2025-02-26T11:53:11.577Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8w001nujz3b6di2wfv","content":"<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name xxx.beeflyx.cloud;</span><br><span class=\"line\"></span><br><span class=\"line\">    # 强制 HTTP 重定向到 HTTPS</span><br><span class=\"line\">    return 301 https://$host$request_uri;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 443 ssl;</span><br><span class=\"line\">    server_name xxx.beeflyx.cloud;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_certificate /etc/nginx/conf.d/cert/xxx.beeflyx.cloud_bundle.crt;</span><br><span class=\"line\">    ssl_certificate_key /etc/nginx/conf.d/cert/xxx.beeflyx.cloud.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://127.0.0.1:3000;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","cover":false,"excerpt":"","more":"<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name xxx.beeflyx.cloud;</span><br><span class=\"line\"></span><br><span class=\"line\">    # 强制 HTTP 重定向到 HTTPS</span><br><span class=\"line\">    return 301 https://$host$request_uri;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 443 ssl;</span><br><span class=\"line\">    server_name xxx.beeflyx.cloud;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_certificate /etc/nginx/conf.d/cert/xxx.beeflyx.cloud_bundle.crt;</span><br><span class=\"line\">    ssl_certificate_key /etc/nginx/conf.d/cert/xxx.beeflyx.cloud.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://127.0.0.1:3000;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"linux下修复网卡出入口策略","date":"2025-10-17T09:51:59.000Z","_content":"2️⃣ 查看路由表\n    ip route show\n```shell\ndefault via 172.18.8.1 dev enp4s0 proto dhcp src 172.18.8.14 \ndefault via 172.18.4.1 dev wlx90de8039f84e proto dhcp src 172.18.5.84 metric 600 \n172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 \n172.18.0.0/16 dev br-1d60fb2053b6 proto kernel scope link src 172.18.0.1 linkdown \n172.18.4.0/22 dev wlx90de8039f84e proto kernel scope link src 172.18.5.84 metric 600 \n172.18.4.53 dev enp4s0 scope link \n172.18.8.0/24 dev enp4s0 proto kernel scope link src 172.18.8.14 \n172.19.0.0/16 dev br-2ef4d7ca1b69 proto kernel scope link src 172.19.0.1 \n172.20.0.0/16 dev br-5f32771043be proto kernel scope link src 172.20.0.1 linkdown \n172.21.0.0/16 dev br-ad6eae2e33ba proto kernel scope link src 172.21.0.1 linkdown \n172.22.0.0/16 dev br-27852fab7433 proto kernel scope link src 172.22.0.1 linkdown \n172.23.0.0/16 dev br-d47499b873f8 proto kernel scope link src 172.23.0.1 linkdown \n172.24.0.0/16 dev br-26459e3bb6fd proto kernel scope link src 172.24.0.1 linkdown \n172.25.0.0/16 dev br-b134fb0df423 proto kernel scope link src 172.25.0.1 linkdown \n172.26.0.0/16 dev br-f90da39cf0eb proto kernel scope link src 172.26.0.1 \n172.27.0.0/16 dev br-1688b9c0bb44 proto kernel scope link src 172.27.0.1 \n172.28.0.0/16 dev br-1e43fea341a0 proto kernel scope link src 172.28.0.1 linkdown \n192.168.1.0/24 dev virbr1 proto kernel scope link src 192.168.1.1 linkdown \n```\n\n我们可以看出你的系统现在有两个「默认路由（default route）」，并且它们走的是不同的网卡：\n\n---\n\n## 🧭 当前路由情况分析\n\n| 项                     | 内容                                                      |\n| --------------------- | ------------------------------------------------------- |\n| 有线网卡（enp4s0）          | IP: **172.18.8.14**，网关：**172.18.8.1**                   |\n| 无线网卡（wlx90de8039f84e） | IP: **172.18.5.84**，网关：**172.18.4.1**                   |\n| 默认路由1                 | `default via 172.18.8.1 dev enp4s0`                     |\n| 默认路由2                 | `default via 172.18.4.1 dev wlx90de8039f84e metric 600` |\n\n---\n\n## 🧠 问题根源\n\n系统现在有两条默认出口：\n\n* **优先级较高**：`enp4s0`（因为没有 metric，默认 metric=0）\n* **优先级较低**：`wlx90de8039f84e`（metric 600）\n\n这意味着：\n\n* 请求从两个网卡都能进来；\n* 但所有响应包（默认出口）会优先走 **enp4s0**；\n* 所以如果入口是无线（wlx90de8039f84e），包出去却从有线（enp4s0）走，就会出现“入口出口不一致”的情况（典型问题）。\n\n---\n\n## 🔧 修复方案一：让出口和入口一致（策略路由）\n\n### 适用情况\n\n如果你希望：\n\n> 哪个网卡收到请求，就从哪个网卡回去。\n\n### 具体操作\n\n1️⃣ 创建两个策略路由表\n\n```bash\necho \"100 enp4s0\" >> /etc/iproute2/rt_tables\necho \"200 wlx90de8039f84e\" >> /etc/iproute2/rt_tables\n```\n\n2️⃣ 添加规则与路由\n\n```bash\n# 有线网卡 enp4s0\nip rule add from 172.18.8.14/32 table enp4s0\nip route add default via 172.18.8.1 dev enp4s0 table enp4s0\n\n# 无线网卡 wlx90de8039f84e\nip rule add from 172.18.5.84/32 table wlx90de8039f84e\nip route add default via 172.18.4.1 dev wlx90de8039f84e table wlx90de8039f84e\n```\n\n3️⃣ 验证规则\n\n```bash\nip rule show\nip route show table enp4s0\nip route show table wlx90de8039f84e\n```\n\n4️⃣ 测试是否从相同网卡返回：\n\n```bash\nping -I 172.18.8.14 8.8.8.8   # 走有线\nping -I 172.18.5.84 8.8.8.8   # 走无线\n```\n\n✅ 这样就能保证：\n\n* 从哪个网卡进来的连接，返回包也从那个网卡出去；\n* 不再出现“入口出口不一致”的情况。\n\n---\n\n## 🔧 修复方案二：强制统一出口网卡（简单粗暴）\n\n如果你只希望所有流量都走某个网卡（比如有线），可直接修改默认路由：\n\n```bash\nip route del default\nip route add default via 172.18.8.1 dev enp4s0\n```\n\n可选：设置 `metric`，避免被 DHCP 自动添加的路由覆盖：\n\n```bash\nnmcli connection modify enp4s0 ipv4.route-metric 100\nnmcli connection modify wlx90de8039f84e ipv4.route-metric 600\n```\n\n这样系统会始终优先用有线网卡出网。\n\n---\n\n## 💾 永久生效方法\n\n不同系统略有差异：\n\n* **Ubuntu/Debian**：在 `/etc/network/interfaces` 或 `/etc/netplan/*.yaml` 里添加 `post-up` 命令；\n* **RHEL/CentOS**：放到 `/etc/sysconfig/network-scripts/route-enp4s0`；\n* 或写入 `/etc/rc.local` 并 `chmod +x`。\n\n---\n\n## 📊 总结建议\n\n| 目标        | 推荐方案                          |\n| --------- | ----------------------------- |\n| 自动匹配入口出口  | 策略路由（方案一 ✅）                   |\n| 全部流量走一个网卡 | 修改默认路由（方案二）                   |\n| 临时测试      | `ip rule` / `ip route` 手动执行即可 |\n\n---\n\n是否方便告诉我：\n👉 你的目标是「**所有流量都走一个出口**」，还是「**哪个网卡进就从哪个网卡出**」？\n我可以帮你写出**最简洁、可直接复制的最终命令**。\n","source":"_posts/linux/linux下修复网卡出入口策略.md","raw":"---\ntitle: linux下修复网卡出入口策略\ndate: 2025-10-17 17:51:59\ntags:\n---\n2️⃣ 查看路由表\n    ip route show\n```shell\ndefault via 172.18.8.1 dev enp4s0 proto dhcp src 172.18.8.14 \ndefault via 172.18.4.1 dev wlx90de8039f84e proto dhcp src 172.18.5.84 metric 600 \n172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 \n172.18.0.0/16 dev br-1d60fb2053b6 proto kernel scope link src 172.18.0.1 linkdown \n172.18.4.0/22 dev wlx90de8039f84e proto kernel scope link src 172.18.5.84 metric 600 \n172.18.4.53 dev enp4s0 scope link \n172.18.8.0/24 dev enp4s0 proto kernel scope link src 172.18.8.14 \n172.19.0.0/16 dev br-2ef4d7ca1b69 proto kernel scope link src 172.19.0.1 \n172.20.0.0/16 dev br-5f32771043be proto kernel scope link src 172.20.0.1 linkdown \n172.21.0.0/16 dev br-ad6eae2e33ba proto kernel scope link src 172.21.0.1 linkdown \n172.22.0.0/16 dev br-27852fab7433 proto kernel scope link src 172.22.0.1 linkdown \n172.23.0.0/16 dev br-d47499b873f8 proto kernel scope link src 172.23.0.1 linkdown \n172.24.0.0/16 dev br-26459e3bb6fd proto kernel scope link src 172.24.0.1 linkdown \n172.25.0.0/16 dev br-b134fb0df423 proto kernel scope link src 172.25.0.1 linkdown \n172.26.0.0/16 dev br-f90da39cf0eb proto kernel scope link src 172.26.0.1 \n172.27.0.0/16 dev br-1688b9c0bb44 proto kernel scope link src 172.27.0.1 \n172.28.0.0/16 dev br-1e43fea341a0 proto kernel scope link src 172.28.0.1 linkdown \n192.168.1.0/24 dev virbr1 proto kernel scope link src 192.168.1.1 linkdown \n```\n\n我们可以看出你的系统现在有两个「默认路由（default route）」，并且它们走的是不同的网卡：\n\n---\n\n## 🧭 当前路由情况分析\n\n| 项                     | 内容                                                      |\n| --------------------- | ------------------------------------------------------- |\n| 有线网卡（enp4s0）          | IP: **172.18.8.14**，网关：**172.18.8.1**                   |\n| 无线网卡（wlx90de8039f84e） | IP: **172.18.5.84**，网关：**172.18.4.1**                   |\n| 默认路由1                 | `default via 172.18.8.1 dev enp4s0`                     |\n| 默认路由2                 | `default via 172.18.4.1 dev wlx90de8039f84e metric 600` |\n\n---\n\n## 🧠 问题根源\n\n系统现在有两条默认出口：\n\n* **优先级较高**：`enp4s0`（因为没有 metric，默认 metric=0）\n* **优先级较低**：`wlx90de8039f84e`（metric 600）\n\n这意味着：\n\n* 请求从两个网卡都能进来；\n* 但所有响应包（默认出口）会优先走 **enp4s0**；\n* 所以如果入口是无线（wlx90de8039f84e），包出去却从有线（enp4s0）走，就会出现“入口出口不一致”的情况（典型问题）。\n\n---\n\n## 🔧 修复方案一：让出口和入口一致（策略路由）\n\n### 适用情况\n\n如果你希望：\n\n> 哪个网卡收到请求，就从哪个网卡回去。\n\n### 具体操作\n\n1️⃣ 创建两个策略路由表\n\n```bash\necho \"100 enp4s0\" >> /etc/iproute2/rt_tables\necho \"200 wlx90de8039f84e\" >> /etc/iproute2/rt_tables\n```\n\n2️⃣ 添加规则与路由\n\n```bash\n# 有线网卡 enp4s0\nip rule add from 172.18.8.14/32 table enp4s0\nip route add default via 172.18.8.1 dev enp4s0 table enp4s0\n\n# 无线网卡 wlx90de8039f84e\nip rule add from 172.18.5.84/32 table wlx90de8039f84e\nip route add default via 172.18.4.1 dev wlx90de8039f84e table wlx90de8039f84e\n```\n\n3️⃣ 验证规则\n\n```bash\nip rule show\nip route show table enp4s0\nip route show table wlx90de8039f84e\n```\n\n4️⃣ 测试是否从相同网卡返回：\n\n```bash\nping -I 172.18.8.14 8.8.8.8   # 走有线\nping -I 172.18.5.84 8.8.8.8   # 走无线\n```\n\n✅ 这样就能保证：\n\n* 从哪个网卡进来的连接，返回包也从那个网卡出去；\n* 不再出现“入口出口不一致”的情况。\n\n---\n\n## 🔧 修复方案二：强制统一出口网卡（简单粗暴）\n\n如果你只希望所有流量都走某个网卡（比如有线），可直接修改默认路由：\n\n```bash\nip route del default\nip route add default via 172.18.8.1 dev enp4s0\n```\n\n可选：设置 `metric`，避免被 DHCP 自动添加的路由覆盖：\n\n```bash\nnmcli connection modify enp4s0 ipv4.route-metric 100\nnmcli connection modify wlx90de8039f84e ipv4.route-metric 600\n```\n\n这样系统会始终优先用有线网卡出网。\n\n---\n\n## 💾 永久生效方法\n\n不同系统略有差异：\n\n* **Ubuntu/Debian**：在 `/etc/network/interfaces` 或 `/etc/netplan/*.yaml` 里添加 `post-up` 命令；\n* **RHEL/CentOS**：放到 `/etc/sysconfig/network-scripts/route-enp4s0`；\n* 或写入 `/etc/rc.local` 并 `chmod +x`。\n\n---\n\n## 📊 总结建议\n\n| 目标        | 推荐方案                          |\n| --------- | ----------------------------- |\n| 自动匹配入口出口  | 策略路由（方案一 ✅）                   |\n| 全部流量走一个网卡 | 修改默认路由（方案二）                   |\n| 临时测试      | `ip rule` / `ip route` 手动执行即可 |\n\n---\n\n是否方便告诉我：\n👉 你的目标是「**所有流量都走一个出口**」，还是「**哪个网卡进就从哪个网卡出**」？\n我可以帮你写出**最简洁、可直接复制的最终命令**。\n","slug":"linux/linux下修复网卡出入口策略","published":1,"updated":"2025-10-17T06:27:40.473Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8w001rujz3gmwh2frn","content":"<p>2️⃣ 查看路由表<br>    ip route show</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">default via 172.18.8.1 dev enp4s0 proto dhcp src 172.18.8.14 </span><br><span class=\"line\">default via 172.18.4.1 dev wlx90de8039f84e proto dhcp src 172.18.5.84 metric 600 </span><br><span class=\"line\">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 </span><br><span class=\"line\">172.18.0.0/16 dev br-1d60fb2053b6 proto kernel scope link src 172.18.0.1 linkdown </span><br><span class=\"line\">172.18.4.0/22 dev wlx90de8039f84e proto kernel scope link src 172.18.5.84 metric 600 </span><br><span class=\"line\">172.18.4.53 dev enp4s0 scope link </span><br><span class=\"line\">172.18.8.0/24 dev enp4s0 proto kernel scope link src 172.18.8.14 </span><br><span class=\"line\">172.19.0.0/16 dev br-2ef4d7ca1b69 proto kernel scope link src 172.19.0.1 </span><br><span class=\"line\">172.20.0.0/16 dev br-5f32771043be proto kernel scope link src 172.20.0.1 linkdown </span><br><span class=\"line\">172.21.0.0/16 dev br-ad6eae2e33ba proto kernel scope link src 172.21.0.1 linkdown </span><br><span class=\"line\">172.22.0.0/16 dev br-27852fab7433 proto kernel scope link src 172.22.0.1 linkdown </span><br><span class=\"line\">172.23.0.0/16 dev br-d47499b873f8 proto kernel scope link src 172.23.0.1 linkdown </span><br><span class=\"line\">172.24.0.0/16 dev br-26459e3bb6fd proto kernel scope link src 172.24.0.1 linkdown </span><br><span class=\"line\">172.25.0.0/16 dev br-b134fb0df423 proto kernel scope link src 172.25.0.1 linkdown </span><br><span class=\"line\">172.26.0.0/16 dev br-f90da39cf0eb proto kernel scope link src 172.26.0.1 </span><br><span class=\"line\">172.27.0.0/16 dev br-1688b9c0bb44 proto kernel scope link src 172.27.0.1 </span><br><span class=\"line\">172.28.0.0/16 dev br-1e43fea341a0 proto kernel scope link src 172.28.0.1 linkdown </span><br><span class=\"line\">192.168.1.0/24 dev virbr1 proto kernel scope link src 192.168.1.1 linkdown </span><br></pre></td></tr></table></figure>\n\n<p>我们可以看出你的系统现在有两个「默认路由（default route）」，并且它们走的是不同的网卡：</p>\n<hr>\n<h2 id=\"🧭-当前路由情况分析\"><a href=\"#🧭-当前路由情况分析\" class=\"headerlink\" title=\"🧭 当前路由情况分析\"></a>🧭 当前路由情况分析</h2><table>\n<thead>\n<tr>\n<th>项</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>有线网卡（enp4s0）</td>\n<td>IP: <strong>172.18.8.14</strong>，网关：<strong>172.18.8.1</strong></td>\n</tr>\n<tr>\n<td>无线网卡（wlx90de8039f84e）</td>\n<td>IP: <strong>172.18.5.84</strong>，网关：<strong>172.18.4.1</strong></td>\n</tr>\n<tr>\n<td>默认路由1</td>\n<td><code>default via 172.18.8.1 dev enp4s0</code></td>\n</tr>\n<tr>\n<td>默认路由2</td>\n<td><code>default via 172.18.4.1 dev wlx90de8039f84e metric 600</code></td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"🧠-问题根源\"><a href=\"#🧠-问题根源\" class=\"headerlink\" title=\"🧠 问题根源\"></a>🧠 问题根源</h2><p>系统现在有两条默认出口：</p>\n<ul>\n<li><strong>优先级较高</strong>：<code>enp4s0</code>（因为没有 metric，默认 metric&#x3D;0）</li>\n<li><strong>优先级较低</strong>：<code>wlx90de8039f84e</code>（metric 600）</li>\n</ul>\n<p>这意味着：</p>\n<ul>\n<li>请求从两个网卡都能进来；</li>\n<li>但所有响应包（默认出口）会优先走 <strong>enp4s0</strong>；</li>\n<li>所以如果入口是无线（wlx90de8039f84e），包出去却从有线（enp4s0）走，就会出现“入口出口不一致”的情况（典型问题）。</li>\n</ul>\n<hr>\n<h2 id=\"🔧-修复方案一：让出口和入口一致（策略路由）\"><a href=\"#🔧-修复方案一：让出口和入口一致（策略路由）\" class=\"headerlink\" title=\"🔧 修复方案一：让出口和入口一致（策略路由）\"></a>🔧 修复方案一：让出口和入口一致（策略路由）</h2><h3 id=\"适用情况\"><a href=\"#适用情况\" class=\"headerlink\" title=\"适用情况\"></a>适用情况</h3><p>如果你希望：</p>\n<blockquote>\n<p>哪个网卡收到请求，就从哪个网卡回去。</p>\n</blockquote>\n<h3 id=\"具体操作\"><a href=\"#具体操作\" class=\"headerlink\" title=\"具体操作\"></a>具体操作</h3><p>1️⃣ 创建两个策略路由表</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;100 enp4s0&quot;</span> &gt;&gt; /etc/iproute2/rt_tables</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;200 wlx90de8039f84e&quot;</span> &gt;&gt; /etc/iproute2/rt_tables</span><br></pre></td></tr></table></figure>\n\n<p>2️⃣ 添加规则与路由</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 有线网卡 enp4s0</span></span><br><span class=\"line\">ip rule add from 172.18.8.14/32 table enp4s0</span><br><span class=\"line\">ip route add default via 172.18.8.1 dev enp4s0 table enp4s0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 无线网卡 wlx90de8039f84e</span></span><br><span class=\"line\">ip rule add from 172.18.5.84/32 table wlx90de8039f84e</span><br><span class=\"line\">ip route add default via 172.18.4.1 dev wlx90de8039f84e table wlx90de8039f84e</span><br></pre></td></tr></table></figure>\n\n<p>3️⃣ 验证规则</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip rule show</span><br><span class=\"line\">ip route show table enp4s0</span><br><span class=\"line\">ip route show table wlx90de8039f84e</span><br></pre></td></tr></table></figure>\n\n<p>4️⃣ 测试是否从相同网卡返回：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ping -I 172.18.8.14 8.8.8.8   <span class=\"comment\"># 走有线</span></span><br><span class=\"line\">ping -I 172.18.5.84 8.8.8.8   <span class=\"comment\"># 走无线</span></span><br></pre></td></tr></table></figure>\n\n<p>✅ 这样就能保证：</p>\n<ul>\n<li>从哪个网卡进来的连接，返回包也从那个网卡出去；</li>\n<li>不再出现“入口出口不一致”的情况。</li>\n</ul>\n<hr>\n<h2 id=\"🔧-修复方案二：强制统一出口网卡（简单粗暴）\"><a href=\"#🔧-修复方案二：强制统一出口网卡（简单粗暴）\" class=\"headerlink\" title=\"🔧 修复方案二：强制统一出口网卡（简单粗暴）\"></a>🔧 修复方案二：强制统一出口网卡（简单粗暴）</h2><p>如果你只希望所有流量都走某个网卡（比如有线），可直接修改默认路由：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip route del default</span><br><span class=\"line\">ip route add default via 172.18.8.1 dev enp4s0</span><br></pre></td></tr></table></figure>\n\n<p>可选：设置 <code>metric</code>，避免被 DHCP 自动添加的路由覆盖：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify enp4s0 ipv4.route-metric 100</span><br><span class=\"line\">nmcli connection modify wlx90de8039f84e ipv4.route-metric 600</span><br></pre></td></tr></table></figure>\n\n<p>这样系统会始终优先用有线网卡出网。</p>\n<hr>\n<h2 id=\"💾-永久生效方法\"><a href=\"#💾-永久生效方法\" class=\"headerlink\" title=\"💾 永久生效方法\"></a>💾 永久生效方法</h2><p>不同系统略有差异：</p>\n<ul>\n<li><strong>Ubuntu&#x2F;Debian</strong>：在 <code>/etc/network/interfaces</code> 或 <code>/etc/netplan/*.yaml</code> 里添加 <code>post-up</code> 命令；</li>\n<li><strong>RHEL&#x2F;CentOS</strong>：放到 <code>/etc/sysconfig/network-scripts/route-enp4s0</code>；</li>\n<li>或写入 <code>/etc/rc.local</code> 并 <code>chmod +x</code>。</li>\n</ul>\n<hr>\n<h2 id=\"📊-总结建议\"><a href=\"#📊-总结建议\" class=\"headerlink\" title=\"📊 总结建议\"></a>📊 总结建议</h2><table>\n<thead>\n<tr>\n<th>目标</th>\n<th>推荐方案</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>自动匹配入口出口</td>\n<td>策略路由（方案一 ✅）</td>\n</tr>\n<tr>\n<td>全部流量走一个网卡</td>\n<td>修改默认路由（方案二）</td>\n</tr>\n<tr>\n<td>临时测试</td>\n<td><code>ip rule</code> &#x2F; <code>ip route</code> 手动执行即可</td>\n</tr>\n</tbody></table>\n<hr>\n<p>是否方便告诉我：<br>👉 你的目标是「<strong>所有流量都走一个出口</strong>」，还是「<strong>哪个网卡进就从哪个网卡出</strong>」？<br>我可以帮你写出<strong>最简洁、可直接复制的最终命令</strong>。</p>\n","cover":false,"excerpt":"","more":"<p>2️⃣ 查看路由表<br>    ip route show</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">default via 172.18.8.1 dev enp4s0 proto dhcp src 172.18.8.14 </span><br><span class=\"line\">default via 172.18.4.1 dev wlx90de8039f84e proto dhcp src 172.18.5.84 metric 600 </span><br><span class=\"line\">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 </span><br><span class=\"line\">172.18.0.0/16 dev br-1d60fb2053b6 proto kernel scope link src 172.18.0.1 linkdown </span><br><span class=\"line\">172.18.4.0/22 dev wlx90de8039f84e proto kernel scope link src 172.18.5.84 metric 600 </span><br><span class=\"line\">172.18.4.53 dev enp4s0 scope link </span><br><span class=\"line\">172.18.8.0/24 dev enp4s0 proto kernel scope link src 172.18.8.14 </span><br><span class=\"line\">172.19.0.0/16 dev br-2ef4d7ca1b69 proto kernel scope link src 172.19.0.1 </span><br><span class=\"line\">172.20.0.0/16 dev br-5f32771043be proto kernel scope link src 172.20.0.1 linkdown </span><br><span class=\"line\">172.21.0.0/16 dev br-ad6eae2e33ba proto kernel scope link src 172.21.0.1 linkdown </span><br><span class=\"line\">172.22.0.0/16 dev br-27852fab7433 proto kernel scope link src 172.22.0.1 linkdown </span><br><span class=\"line\">172.23.0.0/16 dev br-d47499b873f8 proto kernel scope link src 172.23.0.1 linkdown </span><br><span class=\"line\">172.24.0.0/16 dev br-26459e3bb6fd proto kernel scope link src 172.24.0.1 linkdown </span><br><span class=\"line\">172.25.0.0/16 dev br-b134fb0df423 proto kernel scope link src 172.25.0.1 linkdown </span><br><span class=\"line\">172.26.0.0/16 dev br-f90da39cf0eb proto kernel scope link src 172.26.0.1 </span><br><span class=\"line\">172.27.0.0/16 dev br-1688b9c0bb44 proto kernel scope link src 172.27.0.1 </span><br><span class=\"line\">172.28.0.0/16 dev br-1e43fea341a0 proto kernel scope link src 172.28.0.1 linkdown </span><br><span class=\"line\">192.168.1.0/24 dev virbr1 proto kernel scope link src 192.168.1.1 linkdown </span><br></pre></td></tr></table></figure>\n\n<p>我们可以看出你的系统现在有两个「默认路由（default route）」，并且它们走的是不同的网卡：</p>\n<hr>\n<h2 id=\"🧭-当前路由情况分析\"><a href=\"#🧭-当前路由情况分析\" class=\"headerlink\" title=\"🧭 当前路由情况分析\"></a>🧭 当前路由情况分析</h2><table>\n<thead>\n<tr>\n<th>项</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>有线网卡（enp4s0）</td>\n<td>IP: <strong>172.18.8.14</strong>，网关：<strong>172.18.8.1</strong></td>\n</tr>\n<tr>\n<td>无线网卡（wlx90de8039f84e）</td>\n<td>IP: <strong>172.18.5.84</strong>，网关：<strong>172.18.4.1</strong></td>\n</tr>\n<tr>\n<td>默认路由1</td>\n<td><code>default via 172.18.8.1 dev enp4s0</code></td>\n</tr>\n<tr>\n<td>默认路由2</td>\n<td><code>default via 172.18.4.1 dev wlx90de8039f84e metric 600</code></td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"🧠-问题根源\"><a href=\"#🧠-问题根源\" class=\"headerlink\" title=\"🧠 问题根源\"></a>🧠 问题根源</h2><p>系统现在有两条默认出口：</p>\n<ul>\n<li><strong>优先级较高</strong>：<code>enp4s0</code>（因为没有 metric，默认 metric&#x3D;0）</li>\n<li><strong>优先级较低</strong>：<code>wlx90de8039f84e</code>（metric 600）</li>\n</ul>\n<p>这意味着：</p>\n<ul>\n<li>请求从两个网卡都能进来；</li>\n<li>但所有响应包（默认出口）会优先走 <strong>enp4s0</strong>；</li>\n<li>所以如果入口是无线（wlx90de8039f84e），包出去却从有线（enp4s0）走，就会出现“入口出口不一致”的情况（典型问题）。</li>\n</ul>\n<hr>\n<h2 id=\"🔧-修复方案一：让出口和入口一致（策略路由）\"><a href=\"#🔧-修复方案一：让出口和入口一致（策略路由）\" class=\"headerlink\" title=\"🔧 修复方案一：让出口和入口一致（策略路由）\"></a>🔧 修复方案一：让出口和入口一致（策略路由）</h2><h3 id=\"适用情况\"><a href=\"#适用情况\" class=\"headerlink\" title=\"适用情况\"></a>适用情况</h3><p>如果你希望：</p>\n<blockquote>\n<p>哪个网卡收到请求，就从哪个网卡回去。</p>\n</blockquote>\n<h3 id=\"具体操作\"><a href=\"#具体操作\" class=\"headerlink\" title=\"具体操作\"></a>具体操作</h3><p>1️⃣ 创建两个策略路由表</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;100 enp4s0&quot;</span> &gt;&gt; /etc/iproute2/rt_tables</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;200 wlx90de8039f84e&quot;</span> &gt;&gt; /etc/iproute2/rt_tables</span><br></pre></td></tr></table></figure>\n\n<p>2️⃣ 添加规则与路由</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 有线网卡 enp4s0</span></span><br><span class=\"line\">ip rule add from 172.18.8.14/32 table enp4s0</span><br><span class=\"line\">ip route add default via 172.18.8.1 dev enp4s0 table enp4s0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 无线网卡 wlx90de8039f84e</span></span><br><span class=\"line\">ip rule add from 172.18.5.84/32 table wlx90de8039f84e</span><br><span class=\"line\">ip route add default via 172.18.4.1 dev wlx90de8039f84e table wlx90de8039f84e</span><br></pre></td></tr></table></figure>\n\n<p>3️⃣ 验证规则</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip rule show</span><br><span class=\"line\">ip route show table enp4s0</span><br><span class=\"line\">ip route show table wlx90de8039f84e</span><br></pre></td></tr></table></figure>\n\n<p>4️⃣ 测试是否从相同网卡返回：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ping -I 172.18.8.14 8.8.8.8   <span class=\"comment\"># 走有线</span></span><br><span class=\"line\">ping -I 172.18.5.84 8.8.8.8   <span class=\"comment\"># 走无线</span></span><br></pre></td></tr></table></figure>\n\n<p>✅ 这样就能保证：</p>\n<ul>\n<li>从哪个网卡进来的连接，返回包也从那个网卡出去；</li>\n<li>不再出现“入口出口不一致”的情况。</li>\n</ul>\n<hr>\n<h2 id=\"🔧-修复方案二：强制统一出口网卡（简单粗暴）\"><a href=\"#🔧-修复方案二：强制统一出口网卡（简单粗暴）\" class=\"headerlink\" title=\"🔧 修复方案二：强制统一出口网卡（简单粗暴）\"></a>🔧 修复方案二：强制统一出口网卡（简单粗暴）</h2><p>如果你只希望所有流量都走某个网卡（比如有线），可直接修改默认路由：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip route del default</span><br><span class=\"line\">ip route add default via 172.18.8.1 dev enp4s0</span><br></pre></td></tr></table></figure>\n\n<p>可选：设置 <code>metric</code>，避免被 DHCP 自动添加的路由覆盖：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify enp4s0 ipv4.route-metric 100</span><br><span class=\"line\">nmcli connection modify wlx90de8039f84e ipv4.route-metric 600</span><br></pre></td></tr></table></figure>\n\n<p>这样系统会始终优先用有线网卡出网。</p>\n<hr>\n<h2 id=\"💾-永久生效方法\"><a href=\"#💾-永久生效方法\" class=\"headerlink\" title=\"💾 永久生效方法\"></a>💾 永久生效方法</h2><p>不同系统略有差异：</p>\n<ul>\n<li><strong>Ubuntu&#x2F;Debian</strong>：在 <code>/etc/network/interfaces</code> 或 <code>/etc/netplan/*.yaml</code> 里添加 <code>post-up</code> 命令；</li>\n<li><strong>RHEL&#x2F;CentOS</strong>：放到 <code>/etc/sysconfig/network-scripts/route-enp4s0</code>；</li>\n<li>或写入 <code>/etc/rc.local</code> 并 <code>chmod +x</code>。</li>\n</ul>\n<hr>\n<h2 id=\"📊-总结建议\"><a href=\"#📊-总结建议\" class=\"headerlink\" title=\"📊 总结建议\"></a>📊 总结建议</h2><table>\n<thead>\n<tr>\n<th>目标</th>\n<th>推荐方案</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>自动匹配入口出口</td>\n<td>策略路由（方案一 ✅）</td>\n</tr>\n<tr>\n<td>全部流量走一个网卡</td>\n<td>修改默认路由（方案二）</td>\n</tr>\n<tr>\n<td>临时测试</td>\n<td><code>ip rule</code> &#x2F; <code>ip route</code> 手动执行即可</td>\n</tr>\n</tbody></table>\n<hr>\n<p>是否方便告诉我：<br>👉 你的目标是「<strong>所有流量都走一个出口</strong>」，还是「<strong>哪个网卡进就从哪个网卡出</strong>」？<br>我可以帮你写出<strong>最简洁、可直接复制的最终命令</strong>。</p>\n"},{"title":"openvpn中使用client1访问xxx域名时，走client2的网络流量来访问","date":"2024-10-10T03:40:10.000Z","_content":"要让一个 OpenVPN 客户端（client1）通过另一个客户端（client2）的网络流量访问特定域名（如 xxx 域名），你可以采取以下步骤：\n\n1. **在 client2 上设置路由**：\n   确保 client2 的 OpenVPN 配置中允许其他客户端通过它进行路由。你需要在 server.conf 中添加以下行：\n\n   ```plaintext\n   client-to-client\n   ```\n\n   这将允许客户端之间的直接通信。\n\n2. **在 client1 上设置路由**：\n   在 client1 的 OpenVPN 配置文件中，你需要添加一条静态路由，让它的流量通过 client2。你可以通过以下方式实现：\n\n    - 在 client1 的配置文件中添加如下内容（假设 client2 的 IP 是 10.8.0.2）：\n\n      ```plaintext\n      route xxx 255.255.255.255 net_gateway\n      ```\n\n    - 如果 client2 的 IP 不是 10.8.0.2，请用实际的 IP 替换。\n\n3. **使用 iptables 或其他工具进行流量转发**：\n   在 client2 上，你可能需要设置 iptables 规则，以便将来自 client1 的流量转发到外部网络。以下是一个简单的规则示例：\n\n   ```bash\n   iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE\n   ```\n\n   确保 `10.8.0.0/24` 替换为你的 VPN 子网。\n\n4. **修改 DNS 解析**：\n   你可能需要在 client1 上修改 DNS 设置，确保它可以正确解析 xxx 域名。你可以在 OpenVPN 配置中添加以下行：\n\n   ```plaintext\n   dhcp-option DNS 8.8.8.8\n   ```\n\n   替换成你想使用的 DNS 服务器。\n\n5. **测试连接**：\n   重启 OpenVPN 客户端，并测试 client1 是否能够通过 client2 的网络访问 xxx 域名。\n\n确保在进行这些更改时备份你的配置文件，以防需要恢复。如果遇到任何问题，可以查看 OpenVPN 的日志以获取更多信息。","source":"_posts/linux/openvpn中使用client1访问xxx域名时，走client2的网络流量来访问.md","raw":"---\ntitle: openvpn中使用client1访问xxx域名时，走client2的网络流量来访问\ndate: 2024-10-10 11:40:10\ncategories: linux\ntag: openvpn\n---\n要让一个 OpenVPN 客户端（client1）通过另一个客户端（client2）的网络流量访问特定域名（如 xxx 域名），你可以采取以下步骤：\n\n1. **在 client2 上设置路由**：\n   确保 client2 的 OpenVPN 配置中允许其他客户端通过它进行路由。你需要在 server.conf 中添加以下行：\n\n   ```plaintext\n   client-to-client\n   ```\n\n   这将允许客户端之间的直接通信。\n\n2. **在 client1 上设置路由**：\n   在 client1 的 OpenVPN 配置文件中，你需要添加一条静态路由，让它的流量通过 client2。你可以通过以下方式实现：\n\n    - 在 client1 的配置文件中添加如下内容（假设 client2 的 IP 是 10.8.0.2）：\n\n      ```plaintext\n      route xxx 255.255.255.255 net_gateway\n      ```\n\n    - 如果 client2 的 IP 不是 10.8.0.2，请用实际的 IP 替换。\n\n3. **使用 iptables 或其他工具进行流量转发**：\n   在 client2 上，你可能需要设置 iptables 规则，以便将来自 client1 的流量转发到外部网络。以下是一个简单的规则示例：\n\n   ```bash\n   iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE\n   ```\n\n   确保 `10.8.0.0/24` 替换为你的 VPN 子网。\n\n4. **修改 DNS 解析**：\n   你可能需要在 client1 上修改 DNS 设置，确保它可以正确解析 xxx 域名。你可以在 OpenVPN 配置中添加以下行：\n\n   ```plaintext\n   dhcp-option DNS 8.8.8.8\n   ```\n\n   替换成你想使用的 DNS 服务器。\n\n5. **测试连接**：\n   重启 OpenVPN 客户端，并测试 client1 是否能够通过 client2 的网络访问 xxx 域名。\n\n确保在进行这些更改时备份你的配置文件，以防需要恢复。如果遇到任何问题，可以查看 OpenVPN 的日志以获取更多信息。","slug":"linux/openvpn中使用client1访问xxx域名时，走client2的网络流量来访问","published":1,"updated":"2025-02-18T06:28:41.773Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8w001tujz3a45x7jgi","content":"<p>要让一个 OpenVPN 客户端（client1）通过另一个客户端（client2）的网络流量访问特定域名（如 xxx 域名），你可以采取以下步骤：</p>\n<ol>\n<li><p><strong>在 client2 上设置路由</strong>：<br>确保 client2 的 OpenVPN 配置中允许其他客户端通过它进行路由。你需要在 server.conf 中添加以下行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">client-to-client</span><br></pre></td></tr></table></figure>\n\n<p>这将允许客户端之间的直接通信。</p>\n</li>\n<li><p><strong>在 client1 上设置路由</strong>：<br>在 client1 的 OpenVPN 配置文件中，你需要添加一条静态路由，让它的流量通过 client2。你可以通过以下方式实现：</p>\n<ul>\n<li><p>在 client1 的配置文件中添加如下内容（假设 client2 的 IP 是 10.8.0.2）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route xxx 255.255.255.255 net_gateway</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>如果 client2 的 IP 不是 10.8.0.2，请用实际的 IP 替换。</p>\n</li>\n</ul>\n</li>\n<li><p><strong>使用 iptables 或其他工具进行流量转发</strong>：<br>在 client2 上，你可能需要设置 iptables 规则，以便将来自 client1 的流量转发到外部网络。以下是一个简单的规则示例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>\n\n<p>确保 <code>10.8.0.0/24</code> 替换为你的 VPN 子网。</p>\n</li>\n<li><p><strong>修改 DNS 解析</strong>：<br>你可能需要在 client1 上修改 DNS 设置，确保它可以正确解析 xxx 域名。你可以在 OpenVPN 配置中添加以下行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dhcp-option DNS 8.8.8.8</span><br></pre></td></tr></table></figure>\n\n<p>替换成你想使用的 DNS 服务器。</p>\n</li>\n<li><p><strong>测试连接</strong>：<br>重启 OpenVPN 客户端，并测试 client1 是否能够通过 client2 的网络访问 xxx 域名。</p>\n</li>\n</ol>\n<p>确保在进行这些更改时备份你的配置文件，以防需要恢复。如果遇到任何问题，可以查看 OpenVPN 的日志以获取更多信息。</p>\n","cover":false,"excerpt":"","more":"<p>要让一个 OpenVPN 客户端（client1）通过另一个客户端（client2）的网络流量访问特定域名（如 xxx 域名），你可以采取以下步骤：</p>\n<ol>\n<li><p><strong>在 client2 上设置路由</strong>：<br>确保 client2 的 OpenVPN 配置中允许其他客户端通过它进行路由。你需要在 server.conf 中添加以下行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">client-to-client</span><br></pre></td></tr></table></figure>\n\n<p>这将允许客户端之间的直接通信。</p>\n</li>\n<li><p><strong>在 client1 上设置路由</strong>：<br>在 client1 的 OpenVPN 配置文件中，你需要添加一条静态路由，让它的流量通过 client2。你可以通过以下方式实现：</p>\n<ul>\n<li><p>在 client1 的配置文件中添加如下内容（假设 client2 的 IP 是 10.8.0.2）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route xxx 255.255.255.255 net_gateway</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>如果 client2 的 IP 不是 10.8.0.2，请用实际的 IP 替换。</p>\n</li>\n</ul>\n</li>\n<li><p><strong>使用 iptables 或其他工具进行流量转发</strong>：<br>在 client2 上，你可能需要设置 iptables 规则，以便将来自 client1 的流量转发到外部网络。以下是一个简单的规则示例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>\n\n<p>确保 <code>10.8.0.0/24</code> 替换为你的 VPN 子网。</p>\n</li>\n<li><p><strong>修改 DNS 解析</strong>：<br>你可能需要在 client1 上修改 DNS 设置，确保它可以正确解析 xxx 域名。你可以在 OpenVPN 配置中添加以下行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dhcp-option DNS 8.8.8.8</span><br></pre></td></tr></table></figure>\n\n<p>替换成你想使用的 DNS 服务器。</p>\n</li>\n<li><p><strong>测试连接</strong>：<br>重启 OpenVPN 客户端，并测试 client1 是否能够通过 client2 的网络访问 xxx 域名。</p>\n</li>\n</ol>\n<p>确保在进行这些更改时备份你的配置文件，以防需要恢复。如果遇到任何问题，可以查看 OpenVPN 的日志以获取更多信息。</p>\n"},{"title":"openvpn-部署脚本","date":"2024-08-07T08:02:35.000Z","_content":"1.执行安装脚本：\n[openvpn.sh](../../resource/openvpn.sh)\n\n2.将覆盖的dns等配置注释掉\n``` server\nlocal 192.168.2.124\nport 5001\nproto udp\ndev tun\nca ca.crt\ncert server.crt\nkey server.key\ndh dh.pem\nauth SHA256\ntls-crypt tc.key\ntopology subnet\nserver 10.8.0.0 255.255.255.0\n#push \"block-ipv6\"\n#push \"ifconfig-ipv6 fddd:1194:1194:1194::2/64 fddd:1194:1194:1194::1\"\n#push \"redirect-gateway def1 ipv6 bypass-dhcp\"\nifconfig-pool-persist ipp.txt\n#push \"dhcp-option DNS 100.125.1.250\"\n#push \"block-outside-dns\"\nkeepalive 10 120\ncipher AES-128-GCM\nuser nobody\ngroup nogroup\npersist-key\n```","source":"_posts/linux/openvpn-部署脚本.md","raw":"---\ntitle: openvpn-部署脚本\ndate: 2024-08-07 16:02:35\ncategories: linux\ntag: openvpn\n---\n1.执行安装脚本：\n[openvpn.sh](../../resource/openvpn.sh)\n\n2.将覆盖的dns等配置注释掉\n``` server\nlocal 192.168.2.124\nport 5001\nproto udp\ndev tun\nca ca.crt\ncert server.crt\nkey server.key\ndh dh.pem\nauth SHA256\ntls-crypt tc.key\ntopology subnet\nserver 10.8.0.0 255.255.255.0\n#push \"block-ipv6\"\n#push \"ifconfig-ipv6 fddd:1194:1194:1194::2/64 fddd:1194:1194:1194::1\"\n#push \"redirect-gateway def1 ipv6 bypass-dhcp\"\nifconfig-pool-persist ipp.txt\n#push \"dhcp-option DNS 100.125.1.250\"\n#push \"block-outside-dns\"\nkeepalive 10 120\ncipher AES-128-GCM\nuser nobody\ngroup nogroup\npersist-key\n```","slug":"linux/openvpn-部署脚本","published":1,"updated":"2025-02-22T09:36:31.520Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8w001wujz3h7n3dga7","content":"<p>1.执行安装脚本：<br><a href=\"../../resource/openvpn.sh\">openvpn.sh</a></p>\n<p>2.将覆盖的dns等配置注释掉</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local 192.168.2.124</span><br><span class=\"line\">port 5001</span><br><span class=\"line\">proto udp</span><br><span class=\"line\">dev tun</span><br><span class=\"line\">ca ca.crt</span><br><span class=\"line\">cert server.crt</span><br><span class=\"line\">key server.key</span><br><span class=\"line\">dh dh.pem</span><br><span class=\"line\">auth SHA256</span><br><span class=\"line\">tls-crypt tc.key</span><br><span class=\"line\">topology subnet</span><br><span class=\"line\">server 10.8.0.0 255.255.255.0</span><br><span class=\"line\">#push &quot;block-ipv6&quot;</span><br><span class=\"line\">#push &quot;ifconfig-ipv6 fddd:1194:1194:1194::2/64 fddd:1194:1194:1194::1&quot;</span><br><span class=\"line\">#push &quot;redirect-gateway def1 ipv6 bypass-dhcp&quot;</span><br><span class=\"line\">ifconfig-pool-persist ipp.txt</span><br><span class=\"line\">#push &quot;dhcp-option DNS 100.125.1.250&quot;</span><br><span class=\"line\">#push &quot;block-outside-dns&quot;</span><br><span class=\"line\">keepalive 10 120</span><br><span class=\"line\">cipher AES-128-GCM</span><br><span class=\"line\">user nobody</span><br><span class=\"line\">group nogroup</span><br><span class=\"line\">persist-key</span><br></pre></td></tr></table></figure>","cover":false,"excerpt":"","more":"<p>1.执行安装脚本：<br><a href=\"../../resource/openvpn.sh\">openvpn.sh</a></p>\n<p>2.将覆盖的dns等配置注释掉</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local 192.168.2.124</span><br><span class=\"line\">port 5001</span><br><span class=\"line\">proto udp</span><br><span class=\"line\">dev tun</span><br><span class=\"line\">ca ca.crt</span><br><span class=\"line\">cert server.crt</span><br><span class=\"line\">key server.key</span><br><span class=\"line\">dh dh.pem</span><br><span class=\"line\">auth SHA256</span><br><span class=\"line\">tls-crypt tc.key</span><br><span class=\"line\">topology subnet</span><br><span class=\"line\">server 10.8.0.0 255.255.255.0</span><br><span class=\"line\">#push &quot;block-ipv6&quot;</span><br><span class=\"line\">#push &quot;ifconfig-ipv6 fddd:1194:1194:1194::2/64 fddd:1194:1194:1194::1&quot;</span><br><span class=\"line\">#push &quot;redirect-gateway def1 ipv6 bypass-dhcp&quot;</span><br><span class=\"line\">ifconfig-pool-persist ipp.txt</span><br><span class=\"line\">#push &quot;dhcp-option DNS 100.125.1.250&quot;</span><br><span class=\"line\">#push &quot;block-outside-dns&quot;</span><br><span class=\"line\">keepalive 10 120</span><br><span class=\"line\">cipher AES-128-GCM</span><br><span class=\"line\">user nobody</span><br><span class=\"line\">group nogroup</span><br><span class=\"line\">persist-key</span><br></pre></td></tr></table></figure>"},{"title":"tcp6 如何 改成tcp4","date":"2024-07-25T09:36:35.000Z","_content":"要将 TCP6（IPv6）转换为 TCP4（IPv4），具体步骤取决于你想要转换的上下文。例如，你可能想要在服务器配置、网络服务配置或者应用程序中进行这种转换。以下是几种常见的方法：\n\n### 1. 修改系统配置\n如果你的系统默认使用 IPv6，你可以通过修改系统配置来优先使用 IPv4。\n\n#### Linux\n编辑 `/etc/gai.conf` 文件，取消 `precedence ::ffff:0:0/96  100` 的注释。这会让系统优先使用 IPv4。\n\n```bash\nsudo nano /etc/gai.conf\n```\n\n取消下面这行的注释：\n```bash\nprecedence ::ffff:0:0/96  100\n```\n\n#### Windows\n可以通过命令行禁用IPv6：\n```bash\nnetsh interface ipv6 set prefixpolicy ::ffff:0:0/96  40 1\n```\n\n### 2. 配置网络服务\n对于具体的网络服务，你可以在配置文件中指定使用 IPv4。\n\n#### Nginx\n在 Nginx 配置文件中，你可以指定服务器监听的 IP 地址为 IPv4 地址。例如：\n\n```nginx\nserver {\n    listen 80;\n    listen [::]:80 ipv6only=off;\n    ...\n}\n```\n\n将上面的配置改为仅监听 IPv4 地址：\n```nginx\nserver {\n    listen 80;\n    ...\n}\n```\n\n#### Apache\n在 Apache 的配置文件中，你可以指定监听的 IP 地址：\n\n```apache\nListen 80\nListen [::]:80\n```\n\n将上面的配置改为仅监听 IPv4 地址：\n```apache\nListen 80\n```\n\n### 3. 修改应用程序配置\n对于某些应用程序，你可能需要修改代码或配置文件以确保它们仅使用 IPv4。\n\n#### Python\n在 Python 应用中，你可以通过 `socket` 模块指定仅使用 IPv4：\n\n```python\nimport socket\n\n# 创建一个IPv4的TCP socket\nsock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\nsock.bind(('0.0.0.0', 8080))\nsock.listen(5)\n```\n\n#### Java\n在 Java 应用中，你可以设置 `java.net.preferIPv4Stack` 系统属性：\n\n```java\npublic class Main {\n    public static void main(String[] args) {\n        System.setProperty(\"java.net.preferIPv4Stack\", \"true\");\n        // 其他代码\n    }\n}\n```\n\n### 总结\n具体的方法取决于你的具体需求和环境。在一般情况下，配置文件和系统设置通常可以解决大多数问题。如果你有更具体的应用或环境，请提供更多详细信息，我可以提供更具体的指导。","source":"_posts/linux/tcp6-如何-改成tcp4.md","raw":"---\ntitle: tcp6 如何 改成tcp4\ndate: 2024-07-25 17:36:35\ncategories: linux\ntag: 网络\n---\n要将 TCP6（IPv6）转换为 TCP4（IPv4），具体步骤取决于你想要转换的上下文。例如，你可能想要在服务器配置、网络服务配置或者应用程序中进行这种转换。以下是几种常见的方法：\n\n### 1. 修改系统配置\n如果你的系统默认使用 IPv6，你可以通过修改系统配置来优先使用 IPv4。\n\n#### Linux\n编辑 `/etc/gai.conf` 文件，取消 `precedence ::ffff:0:0/96  100` 的注释。这会让系统优先使用 IPv4。\n\n```bash\nsudo nano /etc/gai.conf\n```\n\n取消下面这行的注释：\n```bash\nprecedence ::ffff:0:0/96  100\n```\n\n#### Windows\n可以通过命令行禁用IPv6：\n```bash\nnetsh interface ipv6 set prefixpolicy ::ffff:0:0/96  40 1\n```\n\n### 2. 配置网络服务\n对于具体的网络服务，你可以在配置文件中指定使用 IPv4。\n\n#### Nginx\n在 Nginx 配置文件中，你可以指定服务器监听的 IP 地址为 IPv4 地址。例如：\n\n```nginx\nserver {\n    listen 80;\n    listen [::]:80 ipv6only=off;\n    ...\n}\n```\n\n将上面的配置改为仅监听 IPv4 地址：\n```nginx\nserver {\n    listen 80;\n    ...\n}\n```\n\n#### Apache\n在 Apache 的配置文件中，你可以指定监听的 IP 地址：\n\n```apache\nListen 80\nListen [::]:80\n```\n\n将上面的配置改为仅监听 IPv4 地址：\n```apache\nListen 80\n```\n\n### 3. 修改应用程序配置\n对于某些应用程序，你可能需要修改代码或配置文件以确保它们仅使用 IPv4。\n\n#### Python\n在 Python 应用中，你可以通过 `socket` 模块指定仅使用 IPv4：\n\n```python\nimport socket\n\n# 创建一个IPv4的TCP socket\nsock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\nsock.bind(('0.0.0.0', 8080))\nsock.listen(5)\n```\n\n#### Java\n在 Java 应用中，你可以设置 `java.net.preferIPv4Stack` 系统属性：\n\n```java\npublic class Main {\n    public static void main(String[] args) {\n        System.setProperty(\"java.net.preferIPv4Stack\", \"true\");\n        // 其他代码\n    }\n}\n```\n\n### 总结\n具体的方法取决于你的具体需求和环境。在一般情况下，配置文件和系统设置通常可以解决大多数问题。如果你有更具体的应用或环境，请提供更多详细信息，我可以提供更具体的指导。","slug":"linux/tcp6-如何-改成tcp4","published":1,"updated":"2025-02-18T06:28:00.123Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8w001zujz31yai962a","content":"<p>要将 TCP6（IPv6）转换为 TCP4（IPv4），具体步骤取决于你想要转换的上下文。例如，你可能想要在服务器配置、网络服务配置或者应用程序中进行这种转换。以下是几种常见的方法：</p>\n<h3 id=\"1-修改系统配置\"><a href=\"#1-修改系统配置\" class=\"headerlink\" title=\"1. 修改系统配置\"></a>1. 修改系统配置</h3><p>如果你的系统默认使用 IPv6，你可以通过修改系统配置来优先使用 IPv4。</p>\n<h4 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h4><p>编辑 <code>/etc/gai.conf</code> 文件，取消 <code>precedence ::ffff:0:0/96  100</code> 的注释。这会让系统优先使用 IPv4。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nano /etc/gai.conf</span><br></pre></td></tr></table></figure>\n\n<p>取消下面这行的注释：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">precedence ::ffff:0:0/96  100</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Windows\"><a href=\"#Windows\" class=\"headerlink\" title=\"Windows\"></a>Windows</h4><p>可以通过命令行禁用IPv6：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh interface ipv6 <span class=\"built_in\">set</span> prefixpolicy ::ffff:0:0/96  40 1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-配置网络服务\"><a href=\"#2-配置网络服务\" class=\"headerlink\" title=\"2. 配置网络服务\"></a>2. 配置网络服务</h3><p>对于具体的网络服务，你可以在配置文件中指定使用 IPv4。</p>\n<h4 id=\"Nginx\"><a href=\"#Nginx\" class=\"headerlink\" title=\"Nginx\"></a>Nginx</h4><p>在 Nginx 配置文件中，你可以指定服务器监听的 IP 地址为 IPv4 地址。例如：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> [::]:<span class=\"number\">80</span> ipv6only=<span class=\"literal\">off</span>;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>将上面的配置改为仅监听 IPv4 地址：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Apache\"><a href=\"#Apache\" class=\"headerlink\" title=\"Apache\"></a>Apache</h4><p>在 Apache 的配置文件中，你可以指定监听的 IP 地址：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Listen</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attribute\">Listen</span><span class=\"meta\"> [::]:80</span></span><br></pre></td></tr></table></figure>\n\n<p>将上面的配置改为仅监听 IPv4 地址：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Listen</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-修改应用程序配置\"><a href=\"#3-修改应用程序配置\" class=\"headerlink\" title=\"3. 修改应用程序配置\"></a>3. 修改应用程序配置</h3><p>对于某些应用程序，你可能需要修改代码或配置文件以确保它们仅使用 IPv4。</p>\n<h4 id=\"Python\"><a href=\"#Python\" class=\"headerlink\" title=\"Python\"></a>Python</h4><p>在 Python 应用中，你可以通过 <code>socket</code> 模块指定仅使用 IPv4：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个IPv4的TCP socket</span></span><br><span class=\"line\">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">sock.bind((<span class=\"string\">&#x27;0.0.0.0&#x27;</span>, <span class=\"number\">8080</span>))</span><br><span class=\"line\">sock.listen(<span class=\"number\">5</span>)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Java\"><a href=\"#Java\" class=\"headerlink\" title=\"Java\"></a>Java</h4><p>在 Java 应用中，你可以设置 <code>java.net.preferIPv4Stack</code> 系统属性：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        System.setProperty(<span class=\"string\">&quot;java.net.preferIPv4Stack&quot;</span>, <span class=\"string\">&quot;true&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 其他代码</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>具体的方法取决于你的具体需求和环境。在一般情况下，配置文件和系统设置通常可以解决大多数问题。如果你有更具体的应用或环境，请提供更多详细信息，我可以提供更具体的指导。</p>\n","cover":false,"excerpt":"","more":"<p>要将 TCP6（IPv6）转换为 TCP4（IPv4），具体步骤取决于你想要转换的上下文。例如，你可能想要在服务器配置、网络服务配置或者应用程序中进行这种转换。以下是几种常见的方法：</p>\n<h3 id=\"1-修改系统配置\"><a href=\"#1-修改系统配置\" class=\"headerlink\" title=\"1. 修改系统配置\"></a>1. 修改系统配置</h3><p>如果你的系统默认使用 IPv6，你可以通过修改系统配置来优先使用 IPv4。</p>\n<h4 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h4><p>编辑 <code>/etc/gai.conf</code> 文件，取消 <code>precedence ::ffff:0:0/96  100</code> 的注释。这会让系统优先使用 IPv4。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nano /etc/gai.conf</span><br></pre></td></tr></table></figure>\n\n<p>取消下面这行的注释：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">precedence ::ffff:0:0/96  100</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Windows\"><a href=\"#Windows\" class=\"headerlink\" title=\"Windows\"></a>Windows</h4><p>可以通过命令行禁用IPv6：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh interface ipv6 <span class=\"built_in\">set</span> prefixpolicy ::ffff:0:0/96  40 1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-配置网络服务\"><a href=\"#2-配置网络服务\" class=\"headerlink\" title=\"2. 配置网络服务\"></a>2. 配置网络服务</h3><p>对于具体的网络服务，你可以在配置文件中指定使用 IPv4。</p>\n<h4 id=\"Nginx\"><a href=\"#Nginx\" class=\"headerlink\" title=\"Nginx\"></a>Nginx</h4><p>在 Nginx 配置文件中，你可以指定服务器监听的 IP 地址为 IPv4 地址。例如：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> [::]:<span class=\"number\">80</span> ipv6only=<span class=\"literal\">off</span>;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>将上面的配置改为仅监听 IPv4 地址：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Apache\"><a href=\"#Apache\" class=\"headerlink\" title=\"Apache\"></a>Apache</h4><p>在 Apache 的配置文件中，你可以指定监听的 IP 地址：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Listen</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attribute\">Listen</span><span class=\"meta\"> [::]:80</span></span><br></pre></td></tr></table></figure>\n\n<p>将上面的配置改为仅监听 IPv4 地址：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Listen</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-修改应用程序配置\"><a href=\"#3-修改应用程序配置\" class=\"headerlink\" title=\"3. 修改应用程序配置\"></a>3. 修改应用程序配置</h3><p>对于某些应用程序，你可能需要修改代码或配置文件以确保它们仅使用 IPv4。</p>\n<h4 id=\"Python\"><a href=\"#Python\" class=\"headerlink\" title=\"Python\"></a>Python</h4><p>在 Python 应用中，你可以通过 <code>socket</code> 模块指定仅使用 IPv4：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个IPv4的TCP socket</span></span><br><span class=\"line\">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">sock.bind((<span class=\"string\">&#x27;0.0.0.0&#x27;</span>, <span class=\"number\">8080</span>))</span><br><span class=\"line\">sock.listen(<span class=\"number\">5</span>)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Java\"><a href=\"#Java\" class=\"headerlink\" title=\"Java\"></a>Java</h4><p>在 Java 应用中，你可以设置 <code>java.net.preferIPv4Stack</code> 系统属性：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        System.setProperty(<span class=\"string\">&quot;java.net.preferIPv4Stack&quot;</span>, <span class=\"string\">&quot;true&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 其他代码</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>具体的方法取决于你的具体需求和环境。在一般情况下，配置文件和系统设置通常可以解决大多数问题。如果你有更具体的应用或环境，请提供更多详细信息，我可以提供更具体的指导。</p>\n"},{"title":"使用图形化对linux磁盘进行扩容","date":"2024-08-06T11:55:45.000Z","_content":"![微信截图_20240806195901.png](使用图形化对linux磁盘进行扩容/微信截图_20240806195901.png)\n磁盘空间不足的提示。\n我就在终端输入df -h查看了一下磁盘的使用情况。\n文件系统        容量  已用  可用 已用% 挂载点\nudev             14G     0   14G    0% /dev\ntmpfs           2.7G  1.8M  2.7G    1% /run\n/dev/sda1        48G   46G   47M  100% /\ntmpfs            14G     0   14G    0% /dev/shm\ntmpfs           5.0M     0  5.0M    0% /run/lock\ntmpfs           2.7G   60K  2.7G    1% /run/user/130\ntmpfs           2.7G   52K  2.7G    1% /run/user/0\noverlay          48G   46G   47M  100% /var/lib/docker/overlay2/40d9810bdeacf6f8af191b96880582457507055ac701cddc05c90bd41a4cc8cd/merged\noverlay          48G   46G   47M  100% /var/lib/docker/overlay2/684b310e0e5d6cd40b0003fea2920d176d49aacacba87d1364dc0f0aa26d429d/merged\noverlay          48G   46G   47M  100% /var/lib/docker/overlay2/71c3fc9620d502f60d702b4a0227cb0ccfe86a05f75c0627a261ac1357a28867/merged\noverlay          48G   46G   47M  100% /var/lib/docker/overlay2/3491e006468ecf31bc09cfe8d4ecef08bb37d93d2678f919e0e57f02b76c7cc6/merged\n\n\n发现/dev/sda1这个文件系统的使用率打到了90%以上，我就想着给他扩一下容。\n网上各种找方法….\n网上一堆复制粘贴的坑逼教程可把我给坑惨了。\n最后找到了两篇文章综合起来才成功。\n写出来的目的仅仅为了方便记忆，那么就来说说吧。\n第一步:\n使用VMware图像界面工具，对磁盘进行扩容。这一步要先将你的ubantu关机后才可以进行。（必须删除所有快照）点击拓展后就可以指定磁盘大小了。值得注意的是，这里指定的磁盘大小并不是立马分出你给定的磁盘大小。而是给了一个容量上限，你用多少就消耗本机多少空间。所以指定大一点也没关系。\n![微信截图_20240806200518.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200518.png)\n第二步:\n下载Gparted镜像文件。\nhttps://jaist.dl.sourceforge.net/project/gparted/gparted-live-testing/1.6.0-3/gparted-live-1.6.0-3-amd64.iso?viasf=1\n\n然后在虚拟机的设置–CD/DVD(SATA)里， 在”启动时连接”前打钩 并选择 上面下载好的 Gparted 镜像， 如下图：\n![微信截图_20240806200410.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200410.png)\n\n第三步:\n启动BIOS方法:\n用记事本打开ubantu.vmx文件，在第一行添加这段代码\nbios.forceSetupOnce = “TRUE”\n\n![img.png](使用图形化对linux磁盘进行扩容/img.png)\n\n保存再打开就可以进入BIOS，这个设置时一次性的，在你开机后这段代码会自动消失，所以设置完之后就不用管了。\n\n\n\n进入BIOS后用←→键选择进入BOOT，然后用↑↓选择到CD-ROM drive，再按” + “号把它一到第一位。然后按F10保存退出。\n\n开机后即可进入这个界面。\n![微信截图_20240806200751.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200751.png)\n\n![微信截图_20240806200831.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200831.png)\n输入26选择简体中文，敲回车\n![微信截图_20240806200853.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200853.png)\n输入0，敲回车\n![微信截图_20240806200913.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200913.png)\n进入Gparted的界面会自动弹出Gparted的分区界面。\n![微信截图_20240806200924.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200924.png)\n依次删除 linux-swap项， extended项， 最后只剩下sda1和未分配， 然后右键”sda1”项进行调整大小，\n将磁盘容量调整到合适的大小最好是1024的整数倍，并预留空间(2-4G)作为交换区，交换区的大小为你系统内存的大小。 \n再右键”未分配”进行扩展分区出extended分区，然后新建逻辑分区linux-swap，操作完成后点击APPLY提交。然后退出 \n然后正常启动你的ubantu，再次输入命令df -h查看扩容是否成功\n\n└─# df -h     \n文件系统        容量  已用  可用 已用% 挂载点\nudev             14G     0   14G    0% /dev\ntmpfs           2.7G  1.8M  2.7G    1% /run\n/dev/sda1       144G   34G  104G   25% /\ntmpfs            14G     0   14G    0% /dev/shm\ntmpfs           5.0M     0  5.0M    0% /run/lock\ntmpfs           2.7G   60K  2.7G    1% /run/user/130\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/71c3fc9620d502f60d702b4a0227cb0ccfe86a05f75c0627a261ac1357a28867/merged\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/684b310e0e5d6cd40b0003fea2920d176d49aacacba87d1364dc0f0aa26d429d/merged\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/40d9810bdeacf6f8af191b96880582457507055ac701cddc05c90bd41a4cc8cd/merged\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/3491e006468ecf31bc09cfe8d4ecef08bb37d93d2678f919e0e57f02b76c7cc6/merged\ntmpfs           2.7G   56K  2.7G    1% /run/user/0\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/930ee5b9896adee4a28eec7579f04eda6b9fb74888d7c2fb13d4834d6164d782/merged","source":"_posts/linux/使用图形化对linux磁盘进行扩容.md","raw":"---\ntitle: 使用图形化对linux磁盘进行扩容\ndate: 2024-08-06 19:55:45\ncategories: linux\ntag: 扩容磁盘\n---\n![微信截图_20240806195901.png](使用图形化对linux磁盘进行扩容/微信截图_20240806195901.png)\n磁盘空间不足的提示。\n我就在终端输入df -h查看了一下磁盘的使用情况。\n文件系统        容量  已用  可用 已用% 挂载点\nudev             14G     0   14G    0% /dev\ntmpfs           2.7G  1.8M  2.7G    1% /run\n/dev/sda1        48G   46G   47M  100% /\ntmpfs            14G     0   14G    0% /dev/shm\ntmpfs           5.0M     0  5.0M    0% /run/lock\ntmpfs           2.7G   60K  2.7G    1% /run/user/130\ntmpfs           2.7G   52K  2.7G    1% /run/user/0\noverlay          48G   46G   47M  100% /var/lib/docker/overlay2/40d9810bdeacf6f8af191b96880582457507055ac701cddc05c90bd41a4cc8cd/merged\noverlay          48G   46G   47M  100% /var/lib/docker/overlay2/684b310e0e5d6cd40b0003fea2920d176d49aacacba87d1364dc0f0aa26d429d/merged\noverlay          48G   46G   47M  100% /var/lib/docker/overlay2/71c3fc9620d502f60d702b4a0227cb0ccfe86a05f75c0627a261ac1357a28867/merged\noverlay          48G   46G   47M  100% /var/lib/docker/overlay2/3491e006468ecf31bc09cfe8d4ecef08bb37d93d2678f919e0e57f02b76c7cc6/merged\n\n\n发现/dev/sda1这个文件系统的使用率打到了90%以上，我就想着给他扩一下容。\n网上各种找方法….\n网上一堆复制粘贴的坑逼教程可把我给坑惨了。\n最后找到了两篇文章综合起来才成功。\n写出来的目的仅仅为了方便记忆，那么就来说说吧。\n第一步:\n使用VMware图像界面工具，对磁盘进行扩容。这一步要先将你的ubantu关机后才可以进行。（必须删除所有快照）点击拓展后就可以指定磁盘大小了。值得注意的是，这里指定的磁盘大小并不是立马分出你给定的磁盘大小。而是给了一个容量上限，你用多少就消耗本机多少空间。所以指定大一点也没关系。\n![微信截图_20240806200518.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200518.png)\n第二步:\n下载Gparted镜像文件。\nhttps://jaist.dl.sourceforge.net/project/gparted/gparted-live-testing/1.6.0-3/gparted-live-1.6.0-3-amd64.iso?viasf=1\n\n然后在虚拟机的设置–CD/DVD(SATA)里， 在”启动时连接”前打钩 并选择 上面下载好的 Gparted 镜像， 如下图：\n![微信截图_20240806200410.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200410.png)\n\n第三步:\n启动BIOS方法:\n用记事本打开ubantu.vmx文件，在第一行添加这段代码\nbios.forceSetupOnce = “TRUE”\n\n![img.png](使用图形化对linux磁盘进行扩容/img.png)\n\n保存再打开就可以进入BIOS，这个设置时一次性的，在你开机后这段代码会自动消失，所以设置完之后就不用管了。\n\n\n\n进入BIOS后用←→键选择进入BOOT，然后用↑↓选择到CD-ROM drive，再按” + “号把它一到第一位。然后按F10保存退出。\n\n开机后即可进入这个界面。\n![微信截图_20240806200751.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200751.png)\n\n![微信截图_20240806200831.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200831.png)\n输入26选择简体中文，敲回车\n![微信截图_20240806200853.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200853.png)\n输入0，敲回车\n![微信截图_20240806200913.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200913.png)\n进入Gparted的界面会自动弹出Gparted的分区界面。\n![微信截图_20240806200924.png](使用图形化对linux磁盘进行扩容/微信截图_20240806200924.png)\n依次删除 linux-swap项， extended项， 最后只剩下sda1和未分配， 然后右键”sda1”项进行调整大小，\n将磁盘容量调整到合适的大小最好是1024的整数倍，并预留空间(2-4G)作为交换区，交换区的大小为你系统内存的大小。 \n再右键”未分配”进行扩展分区出extended分区，然后新建逻辑分区linux-swap，操作完成后点击APPLY提交。然后退出 \n然后正常启动你的ubantu，再次输入命令df -h查看扩容是否成功\n\n└─# df -h     \n文件系统        容量  已用  可用 已用% 挂载点\nudev             14G     0   14G    0% /dev\ntmpfs           2.7G  1.8M  2.7G    1% /run\n/dev/sda1       144G   34G  104G   25% /\ntmpfs            14G     0   14G    0% /dev/shm\ntmpfs           5.0M     0  5.0M    0% /run/lock\ntmpfs           2.7G   60K  2.7G    1% /run/user/130\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/71c3fc9620d502f60d702b4a0227cb0ccfe86a05f75c0627a261ac1357a28867/merged\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/684b310e0e5d6cd40b0003fea2920d176d49aacacba87d1364dc0f0aa26d429d/merged\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/40d9810bdeacf6f8af191b96880582457507055ac701cddc05c90bd41a4cc8cd/merged\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/3491e006468ecf31bc09cfe8d4ecef08bb37d93d2678f919e0e57f02b76c7cc6/merged\ntmpfs           2.7G   56K  2.7G    1% /run/user/0\noverlay         144G   34G  104G   25% /var/lib/docker/overlay2/930ee5b9896adee4a28eec7579f04eda6b9fb74888d7c2fb13d4834d6164d782/merged","slug":"linux/使用图形化对linux磁盘进行扩容","published":1,"updated":"2025-02-18T06:26:47.395Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8x0022ujz30hdldfmo","content":"\n<p>磁盘空间不足的提示。<br>我就在终端输入df -h查看了一下磁盘的使用情况。<br>文件系统        容量  已用  可用 已用% 挂载点<br>udev             14G     0   14G    0% &#x2F;dev<br>tmpfs           2.7G  1.8M  2.7G    1% &#x2F;run<br>&#x2F;dev&#x2F;sda1        48G   46G   47M  100% &#x2F;<br>tmpfs            14G     0   14G    0% &#x2F;dev&#x2F;shm<br>tmpfs           5.0M     0  5.0M    0% &#x2F;run&#x2F;lock<br>tmpfs           2.7G   60K  2.7G    1% &#x2F;run&#x2F;user&#x2F;130<br>tmpfs           2.7G   52K  2.7G    1% &#x2F;run&#x2F;user&#x2F;0<br>overlay          48G   46G   47M  100% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;40d9810bdeacf6f8af191b96880582457507055ac701cddc05c90bd41a4cc8cd&#x2F;merged<br>overlay          48G   46G   47M  100% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;684b310e0e5d6cd40b0003fea2920d176d49aacacba87d1364dc0f0aa26d429d&#x2F;merged<br>overlay          48G   46G   47M  100% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;71c3fc9620d502f60d702b4a0227cb0ccfe86a05f75c0627a261ac1357a28867&#x2F;merged<br>overlay          48G   46G   47M  100% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;3491e006468ecf31bc09cfe8d4ecef08bb37d93d2678f919e0e57f02b76c7cc6&#x2F;merged</p>\n<p>发现&#x2F;dev&#x2F;sda1这个文件系统的使用率打到了90%以上，我就想着给他扩一下容。<br>网上各种找方法….<br>网上一堆复制粘贴的坑逼教程可把我给坑惨了。<br>最后找到了两篇文章综合起来才成功。<br>写出来的目的仅仅为了方便记忆，那么就来说说吧。<br>第一步:<br>使用VMware图像界面工具，对磁盘进行扩容。这一步要先将你的ubantu关机后才可以进行。（必须删除所有快照）点击拓展后就可以指定磁盘大小了。值得注意的是，这里指定的磁盘大小并不是立马分出你给定的磁盘大小。而是给了一个容量上限，你用多少就消耗本机多少空间。所以指定大一点也没关系。</p>\n\n<p>第二步:<br>下载Gparted镜像文件。<br><a href=\"https://jaist.dl.sourceforge.net/project/gparted/gparted-live-testing/1.6.0-3/gparted-live-1.6.0-3-amd64.iso?viasf=1\">https://jaist.dl.sourceforge.net/project/gparted/gparted-live-testing/1.6.0-3/gparted-live-1.6.0-3-amd64.iso?viasf=1</a></p>\n<p>然后在虚拟机的设置–CD&#x2F;DVD(SATA)里， 在”启动时连接”前打钩 并选择 上面下载好的 Gparted 镜像， 如下图：</p>\n\n\n<p>第三步:<br>启动BIOS方法:<br>用记事本打开ubantu.vmx文件，在第一行添加这段代码<br>bios.forceSetupOnce &#x3D; “TRUE”</p>\n\n\n<p>保存再打开就可以进入BIOS，这个设置时一次性的，在你开机后这段代码会自动消失，所以设置完之后就不用管了。</p>\n<p>进入BIOS后用←→键选择进入BOOT，然后用↑↓选择到CD-ROM drive，再按” + “号把它一到第一位。然后按F10保存退出。</p>\n<p>开机后即可进入这个界面。</p>\n\n\n\n<p>输入26选择简体中文，敲回车</p>\n\n<p>输入0，敲回车</p>\n\n<p>进入Gparted的界面会自动弹出Gparted的分区界面。</p>\n\n<p>依次删除 linux-swap项， extended项， 最后只剩下sda1和未分配， 然后右键”sda1”项进行调整大小，<br>将磁盘容量调整到合适的大小最好是1024的整数倍，并预留空间(2-4G)作为交换区，交换区的大小为你系统内存的大小。<br>再右键”未分配”进行扩展分区出extended分区，然后新建逻辑分区linux-swap，操作完成后点击APPLY提交。然后退出<br>然后正常启动你的ubantu，再次输入命令df -h查看扩容是否成功</p>\n<p>└─# df -h<br>文件系统        容量  已用  可用 已用% 挂载点<br>udev             14G     0   14G    0% &#x2F;dev<br>tmpfs           2.7G  1.8M  2.7G    1% &#x2F;run<br>&#x2F;dev&#x2F;sda1       144G   34G  104G   25% &#x2F;<br>tmpfs            14G     0   14G    0% &#x2F;dev&#x2F;shm<br>tmpfs           5.0M     0  5.0M    0% &#x2F;run&#x2F;lock<br>tmpfs           2.7G   60K  2.7G    1% &#x2F;run&#x2F;user&#x2F;130<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;71c3fc9620d502f60d702b4a0227cb0ccfe86a05f75c0627a261ac1357a28867&#x2F;merged<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;684b310e0e5d6cd40b0003fea2920d176d49aacacba87d1364dc0f0aa26d429d&#x2F;merged<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;40d9810bdeacf6f8af191b96880582457507055ac701cddc05c90bd41a4cc8cd&#x2F;merged<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;3491e006468ecf31bc09cfe8d4ecef08bb37d93d2678f919e0e57f02b76c7cc6&#x2F;merged<br>tmpfs           2.7G   56K  2.7G    1% &#x2F;run&#x2F;user&#x2F;0<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;930ee5b9896adee4a28eec7579f04eda6b9fb74888d7c2fb13d4834d6164d782&#x2F;merged</p>\n","cover":false,"excerpt":"","more":"\n<p>磁盘空间不足的提示。<br>我就在终端输入df -h查看了一下磁盘的使用情况。<br>文件系统        容量  已用  可用 已用% 挂载点<br>udev             14G     0   14G    0% &#x2F;dev<br>tmpfs           2.7G  1.8M  2.7G    1% &#x2F;run<br>&#x2F;dev&#x2F;sda1        48G   46G   47M  100% &#x2F;<br>tmpfs            14G     0   14G    0% &#x2F;dev&#x2F;shm<br>tmpfs           5.0M     0  5.0M    0% &#x2F;run&#x2F;lock<br>tmpfs           2.7G   60K  2.7G    1% &#x2F;run&#x2F;user&#x2F;130<br>tmpfs           2.7G   52K  2.7G    1% &#x2F;run&#x2F;user&#x2F;0<br>overlay          48G   46G   47M  100% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;40d9810bdeacf6f8af191b96880582457507055ac701cddc05c90bd41a4cc8cd&#x2F;merged<br>overlay          48G   46G   47M  100% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;684b310e0e5d6cd40b0003fea2920d176d49aacacba87d1364dc0f0aa26d429d&#x2F;merged<br>overlay          48G   46G   47M  100% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;71c3fc9620d502f60d702b4a0227cb0ccfe86a05f75c0627a261ac1357a28867&#x2F;merged<br>overlay          48G   46G   47M  100% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;3491e006468ecf31bc09cfe8d4ecef08bb37d93d2678f919e0e57f02b76c7cc6&#x2F;merged</p>\n<p>发现&#x2F;dev&#x2F;sda1这个文件系统的使用率打到了90%以上，我就想着给他扩一下容。<br>网上各种找方法….<br>网上一堆复制粘贴的坑逼教程可把我给坑惨了。<br>最后找到了两篇文章综合起来才成功。<br>写出来的目的仅仅为了方便记忆，那么就来说说吧。<br>第一步:<br>使用VMware图像界面工具，对磁盘进行扩容。这一步要先将你的ubantu关机后才可以进行。（必须删除所有快照）点击拓展后就可以指定磁盘大小了。值得注意的是，这里指定的磁盘大小并不是立马分出你给定的磁盘大小。而是给了一个容量上限，你用多少就消耗本机多少空间。所以指定大一点也没关系。</p>\n\n<p>第二步:<br>下载Gparted镜像文件。<br><a href=\"https://jaist.dl.sourceforge.net/project/gparted/gparted-live-testing/1.6.0-3/gparted-live-1.6.0-3-amd64.iso?viasf=1\">https://jaist.dl.sourceforge.net/project/gparted/gparted-live-testing/1.6.0-3/gparted-live-1.6.0-3-amd64.iso?viasf=1</a></p>\n<p>然后在虚拟机的设置–CD&#x2F;DVD(SATA)里， 在”启动时连接”前打钩 并选择 上面下载好的 Gparted 镜像， 如下图：</p>\n\n\n<p>第三步:<br>启动BIOS方法:<br>用记事本打开ubantu.vmx文件，在第一行添加这段代码<br>bios.forceSetupOnce &#x3D; “TRUE”</p>\n\n\n<p>保存再打开就可以进入BIOS，这个设置时一次性的，在你开机后这段代码会自动消失，所以设置完之后就不用管了。</p>\n<p>进入BIOS后用←→键选择进入BOOT，然后用↑↓选择到CD-ROM drive，再按” + “号把它一到第一位。然后按F10保存退出。</p>\n<p>开机后即可进入这个界面。</p>\n\n\n\n<p>输入26选择简体中文，敲回车</p>\n\n<p>输入0，敲回车</p>\n\n<p>进入Gparted的界面会自动弹出Gparted的分区界面。</p>\n\n<p>依次删除 linux-swap项， extended项， 最后只剩下sda1和未分配， 然后右键”sda1”项进行调整大小，<br>将磁盘容量调整到合适的大小最好是1024的整数倍，并预留空间(2-4G)作为交换区，交换区的大小为你系统内存的大小。<br>再右键”未分配”进行扩展分区出extended分区，然后新建逻辑分区linux-swap，操作完成后点击APPLY提交。然后退出<br>然后正常启动你的ubantu，再次输入命令df -h查看扩容是否成功</p>\n<p>└─# df -h<br>文件系统        容量  已用  可用 已用% 挂载点<br>udev             14G     0   14G    0% &#x2F;dev<br>tmpfs           2.7G  1.8M  2.7G    1% &#x2F;run<br>&#x2F;dev&#x2F;sda1       144G   34G  104G   25% &#x2F;<br>tmpfs            14G     0   14G    0% &#x2F;dev&#x2F;shm<br>tmpfs           5.0M     0  5.0M    0% &#x2F;run&#x2F;lock<br>tmpfs           2.7G   60K  2.7G    1% &#x2F;run&#x2F;user&#x2F;130<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;71c3fc9620d502f60d702b4a0227cb0ccfe86a05f75c0627a261ac1357a28867&#x2F;merged<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;684b310e0e5d6cd40b0003fea2920d176d49aacacba87d1364dc0f0aa26d429d&#x2F;merged<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;40d9810bdeacf6f8af191b96880582457507055ac701cddc05c90bd41a4cc8cd&#x2F;merged<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;3491e006468ecf31bc09cfe8d4ecef08bb37d93d2678f919e0e57f02b76c7cc6&#x2F;merged<br>tmpfs           2.7G   56K  2.7G    1% &#x2F;run&#x2F;user&#x2F;0<br>overlay         144G   34G  104G   25% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;930ee5b9896adee4a28eec7579f04eda6b9fb74888d7c2fb13d4834d6164d782&#x2F;merged</p>\n"},{"title":"nginx配置上传文件大小","date":"2024-07-24T08:34:06.000Z","_content":"要在Nginx中配置上传文件，您需要对Nginx的配置文件进行一些修改。以下是一个示例配置，说明如何配置Nginx以支持文件上传：\n\n1. **配置Nginx处理上传文件的大小限制：**\n\n   打开您的Nginx配置文件（通常位于 `/etc/nginx/nginx.conf` 或 `/etc/nginx/conf.d/default.conf`）并找到 `http` 块或 `server` 块。\n\n   ```nginx\n   http {\n       # 其他配置...\n       \n       # 设置客户端上传文件的最大限制（单位：字节）\n       client_max_body_size 50M;\n\n       server {\n           listen 80;\n           server_name example.com;\n\n           # 其他配置...\n\n           location /upload {\n               # 将文件上传到指定的目录\n               root /var/www/uploads;\n\n               # 其他配置...\n           }\n       }\n   }\n   ```\n\n   在这个示例中，`client_max_body_size` 被设置为 `50M`，这意味着客户端可以上传最大为50MB的文件。\n\n2. **配置上传文件的保存路径：**\n\n   您可以在 `location` 块中指定文件上传的路径。例如，上面的示例中，上传的文件将被保存到 `/var/www/uploads` 目录。\n\n3. **重启Nginx以使配置生效：**\n\n   修改完配置文件后，需要重启Nginx服务以使配置生效。\n\n   ```sh\n   sudo systemctl restart nginx\n   ```\n\n4. **处理上传的文件：**\n\n   需要注意的是，Nginx本身不会处理上传的文件，您需要在后端应用中处理这些文件。例如，您可以使用PHP、Python、Node.js等语言在后端处理文件上传。\n\n   这是一个使用PHP处理文件上传的简单示例：\n\n   ```php\n   <?php\n   if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_FILES['file'])) {\n       $uploadDir = '/var/www/uploads/';\n       $uploadFile = $uploadDir . basename($_FILES['file']['name']);\n\n       if (move_uploaded_file($_FILES['file']['tmp_name'], $uploadFile)) {\n           echo \"文件上传成功。\";\n       } else {\n           echo \"文件上传失败。\";\n       }\n   }\n   ?>\n   ```\n\n   然后在Nginx的配置文件中，您可以配置一个 `location` 块来处理文件上传请求：\n\n   ```nginx\n   location /upload {\n       root /var/www/uploads;\n\n       # 代理到后端PHP脚本\n       fastcgi_pass 127.0.0.1:9000;\n       include fastcgi_params;\n       fastcgi_param SCRIPT_FILENAME /var/www/html/upload.php;\n   }\n   ```\n","source":"_posts/linux/nginx配置上传文件大小.md","raw":"---\ntitle: nginx配置上传文件大小\ndate: 2024-07-24 16:34:06\ncategories: linux\ntag: nginx\n---\n要在Nginx中配置上传文件，您需要对Nginx的配置文件进行一些修改。以下是一个示例配置，说明如何配置Nginx以支持文件上传：\n\n1. **配置Nginx处理上传文件的大小限制：**\n\n   打开您的Nginx配置文件（通常位于 `/etc/nginx/nginx.conf` 或 `/etc/nginx/conf.d/default.conf`）并找到 `http` 块或 `server` 块。\n\n   ```nginx\n   http {\n       # 其他配置...\n       \n       # 设置客户端上传文件的最大限制（单位：字节）\n       client_max_body_size 50M;\n\n       server {\n           listen 80;\n           server_name example.com;\n\n           # 其他配置...\n\n           location /upload {\n               # 将文件上传到指定的目录\n               root /var/www/uploads;\n\n               # 其他配置...\n           }\n       }\n   }\n   ```\n\n   在这个示例中，`client_max_body_size` 被设置为 `50M`，这意味着客户端可以上传最大为50MB的文件。\n\n2. **配置上传文件的保存路径：**\n\n   您可以在 `location` 块中指定文件上传的路径。例如，上面的示例中，上传的文件将被保存到 `/var/www/uploads` 目录。\n\n3. **重启Nginx以使配置生效：**\n\n   修改完配置文件后，需要重启Nginx服务以使配置生效。\n\n   ```sh\n   sudo systemctl restart nginx\n   ```\n\n4. **处理上传的文件：**\n\n   需要注意的是，Nginx本身不会处理上传的文件，您需要在后端应用中处理这些文件。例如，您可以使用PHP、Python、Node.js等语言在后端处理文件上传。\n\n   这是一个使用PHP处理文件上传的简单示例：\n\n   ```php\n   <?php\n   if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_FILES['file'])) {\n       $uploadDir = '/var/www/uploads/';\n       $uploadFile = $uploadDir . basename($_FILES['file']['name']);\n\n       if (move_uploaded_file($_FILES['file']['tmp_name'], $uploadFile)) {\n           echo \"文件上传成功。\";\n       } else {\n           echo \"文件上传失败。\";\n       }\n   }\n   ?>\n   ```\n\n   然后在Nginx的配置文件中，您可以配置一个 `location` 块来处理文件上传请求：\n\n   ```nginx\n   location /upload {\n       root /var/www/uploads;\n\n       # 代理到后端PHP脚本\n       fastcgi_pass 127.0.0.1:9000;\n       include fastcgi_params;\n       fastcgi_param SCRIPT_FILENAME /var/www/html/upload.php;\n   }\n   ```\n","slug":"linux/nginx配置上传文件大小","published":1,"updated":"2025-02-18T06:29:12.455Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8x0024ujz3hu0neq3s","content":"<p>要在Nginx中配置上传文件，您需要对Nginx的配置文件进行一些修改。以下是一个示例配置，说明如何配置Nginx以支持文件上传：</p>\n<ol>\n<li><p><strong>配置Nginx处理上传文件的大小限制：</strong></p>\n<p>打开您的Nginx配置文件（通常位于 <code>/etc/nginx/nginx.conf</code> 或 <code>/etc/nginx/conf.d/default.conf</code>）并找到 <code>http</code> 块或 <code>server</code> 块。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\"># 其他配置...</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># 设置客户端上传文件的最大限制（单位：字节）</span></span><br><span class=\"line\">    <span class=\"attribute\">client_max_body_size</span> <span class=\"number\">50M</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span> example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 其他配置...</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"section\">location</span> /upload &#123;</span><br><span class=\"line\">            <span class=\"comment\"># 将文件上传到指定的目录</span></span><br><span class=\"line\">            <span class=\"attribute\">root</span> /var/www/uploads;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\"># 其他配置...</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在这个示例中，<code>client_max_body_size</code> 被设置为 <code>50M</code>，这意味着客户端可以上传最大为50MB的文件。</p>\n</li>\n<li><p><strong>配置上传文件的保存路径：</strong></p>\n<p>您可以在 <code>location</code> 块中指定文件上传的路径。例如，上面的示例中，上传的文件将被保存到 <code>/var/www/uploads</code> 目录。</p>\n</li>\n<li><p><strong>重启Nginx以使配置生效：</strong></p>\n<p>修改完配置文件后，需要重启Nginx服务以使配置生效。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>处理上传的文件：</strong></p>\n<p>需要注意的是，Nginx本身不会处理上传的文件，您需要在后端应用中处理这些文件。例如，您可以使用PHP、Python、Node.js等语言在后端处理文件上传。</p>\n<p>这是一个使用PHP处理文件上传的简单示例：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$_SERVER</span>[<span class=\"string\">&#x27;REQUEST_METHOD&#x27;</span>] == <span class=\"string\">&#x27;POST&#x27;</span> &amp;&amp; <span class=\"keyword\">isset</span>(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"variable\">$uploadDir</span> = <span class=\"string\">&#x27;/var/www/uploads/&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$uploadFile</span> = <span class=\"variable\">$uploadDir</span> . <span class=\"title function_ invoke__\">basename</span>(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">move_uploaded_file</span>(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>], <span class=\"variable\">$uploadFile</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;文件上传成功。&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;文件上传失败。&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>然后在Nginx的配置文件中，您可以配置一个 <code>location</code> 块来处理文件上传请求：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /upload &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /var/www/uploads;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 代理到后端PHP脚本</span></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_pass</span> <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">    <span class=\"attribute\">include</span> fastcgi_params;</span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_param</span> SCRIPT_FILENAME /var/www/html/upload.php;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n","cover":false,"excerpt":"","more":"<p>要在Nginx中配置上传文件，您需要对Nginx的配置文件进行一些修改。以下是一个示例配置，说明如何配置Nginx以支持文件上传：</p>\n<ol>\n<li><p><strong>配置Nginx处理上传文件的大小限制：</strong></p>\n<p>打开您的Nginx配置文件（通常位于 <code>/etc/nginx/nginx.conf</code> 或 <code>/etc/nginx/conf.d/default.conf</code>）并找到 <code>http</code> 块或 <code>server</code> 块。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\"># 其他配置...</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># 设置客户端上传文件的最大限制（单位：字节）</span></span><br><span class=\"line\">    <span class=\"attribute\">client_max_body_size</span> <span class=\"number\">50M</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span> example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 其他配置...</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"section\">location</span> /upload &#123;</span><br><span class=\"line\">            <span class=\"comment\"># 将文件上传到指定的目录</span></span><br><span class=\"line\">            <span class=\"attribute\">root</span> /var/www/uploads;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\"># 其他配置...</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在这个示例中，<code>client_max_body_size</code> 被设置为 <code>50M</code>，这意味着客户端可以上传最大为50MB的文件。</p>\n</li>\n<li><p><strong>配置上传文件的保存路径：</strong></p>\n<p>您可以在 <code>location</code> 块中指定文件上传的路径。例如，上面的示例中，上传的文件将被保存到 <code>/var/www/uploads</code> 目录。</p>\n</li>\n<li><p><strong>重启Nginx以使配置生效：</strong></p>\n<p>修改完配置文件后，需要重启Nginx服务以使配置生效。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>处理上传的文件：</strong></p>\n<p>需要注意的是，Nginx本身不会处理上传的文件，您需要在后端应用中处理这些文件。例如，您可以使用PHP、Python、Node.js等语言在后端处理文件上传。</p>\n<p>这是一个使用PHP处理文件上传的简单示例：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$_SERVER</span>[<span class=\"string\">&#x27;REQUEST_METHOD&#x27;</span>] == <span class=\"string\">&#x27;POST&#x27;</span> &amp;&amp; <span class=\"keyword\">isset</span>(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"variable\">$uploadDir</span> = <span class=\"string\">&#x27;/var/www/uploads/&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$uploadFile</span> = <span class=\"variable\">$uploadDir</span> . <span class=\"title function_ invoke__\">basename</span>(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">move_uploaded_file</span>(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>], <span class=\"variable\">$uploadFile</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;文件上传成功。&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;文件上传失败。&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>然后在Nginx的配置文件中，您可以配置一个 <code>location</code> 块来处理文件上传请求：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /upload &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /var/www/uploads;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 代理到后端PHP脚本</span></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_pass</span> <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">    <span class=\"attribute\">include</span> fastcgi_params;</span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_param</span> SCRIPT_FILENAME /var/www/html/upload.php;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n"},{"title":"对linux磁盘进行无损扩容","date":"2024-08-05T12:37:35.000Z","_content":"\n执行 lsblk 命令得到的数据如下\n   ```bash\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsda      8:0    0  150G  0 disk \n├─sda1   8:1    0   49G  0 part /\n├─sda2   8:2    0    1K  0 part \n└─sda5   8:5    0  975M  0 part [SWAP]\nsr0     11:0    1  4.6G  0 rom  \n   ```\n此时，想将sda1从49G扩容到150G。进行无损扩展 `/dev/sda1` 的步骤较为复杂，但可以通过以下步骤来安全地扩展分区而不丢失数据。这包括使用 `fdisk` 或 `parted` 工具来调整分区大小，然后扩展文件系统。\n\n### 无损扩展分区的步骤\n\n#### 1. **备份数据**\n\n在进行任何磁盘操作之前，务必备份重要数据以防万一。\n\n#### 2. **使用 `parted` 调整分区大小**\n\n假设现有的 `/dev/sda1` 是 `ext4` 文件系统。\n\n1. **查看当前磁盘布局**\n\n   ```bash\n   lsblk\n   sudo fdisk -l /dev/sda\n   ```\n\n2. **调整分区大小**\n\n   使用 `parted` 调整分区大小。\n\n   ```bash\n   sudo parted /dev/sda\n   ```\n\n   在 `parted` 交互界面中执行以下步骤：\n\n   ```bash\n   (parted) print\n   ```\n\n   确认分区表，并记下 `/dev/sda1` 的起始位置（例如 `2048s`）。\n\n   ```bash\n   (parted) resizepart 1 150GB\n   ```\n\n   这会扩展分区1到150GB。\n\n   ```bash\n   (parted) quit\n   ```\n\n#### 3. **更新分区表**\n\n有时，系统需要重新加载分区表。\n\n```bash\nsudo partprobe /dev/sda\n```\n\n#### 4. **扩展文件系统**\n\n根据你的文件系统类型，执行以下步骤来扩展文件系统。\n\n##### 对于 `ext4` 文件系统：\n\n```bash\nsudo resize2fs /dev/sda1\n```\n\n##### 对于 `xfs` 文件系统：\n\n```bash\nsudo xfs_growfs /dev/sda1\n```\n\n#### 5. **验证扩展是否成功**\n\n```bash\ndf -h\n```\n\n### 示例步骤\n\n完整的命令和步骤如下：\n\n```bash\n# 查看当前磁盘布局\nlsblk\nsudo fdisk -l /dev/sda\n\n# 调整分区大小\nsudo parted /dev/sda\n\n# 在 parted 交互界面中\n(parted) print\n(parted) resizepart 1 150GB\n(parted) quit\n\n# 更新分区表\nsudo partprobe /dev/sda\n\n# 扩展文件系统（假设是 ext4 文件系统）\nsudo resize2fs /dev/sda1\n\n# 验证扩展是否成功\ndf -h\n```\n\n### 注意事项\n\n- 确保你的 `/dev/sda1` 分区后面有足够的未分配空间来扩展到 150GB。\n- 在操作之前，确保系统分区未被使用或者在单用户模式下进行操作，以防止数据损坏。\n- 如果你无法进入系统，可以通过 live CD/USB 启动系统并执行这些操作。\n\n这些步骤旨在提供一种相对安全的方法来无损扩展分区。如果对操作不熟悉，建议请教专业人士或使用专业的分区管理软件进行操作。","source":"_posts/linux/对linux磁盘进行无损扩容.md","raw":"---\ntitle: 对linux磁盘进行无损扩容\ndate: 2024-08-05 20:37:35\ncategories: linux\ntag: 扩容磁盘\n---\n\n执行 lsblk 命令得到的数据如下\n   ```bash\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsda      8:0    0  150G  0 disk \n├─sda1   8:1    0   49G  0 part /\n├─sda2   8:2    0    1K  0 part \n└─sda5   8:5    0  975M  0 part [SWAP]\nsr0     11:0    1  4.6G  0 rom  \n   ```\n此时，想将sda1从49G扩容到150G。进行无损扩展 `/dev/sda1` 的步骤较为复杂，但可以通过以下步骤来安全地扩展分区而不丢失数据。这包括使用 `fdisk` 或 `parted` 工具来调整分区大小，然后扩展文件系统。\n\n### 无损扩展分区的步骤\n\n#### 1. **备份数据**\n\n在进行任何磁盘操作之前，务必备份重要数据以防万一。\n\n#### 2. **使用 `parted` 调整分区大小**\n\n假设现有的 `/dev/sda1` 是 `ext4` 文件系统。\n\n1. **查看当前磁盘布局**\n\n   ```bash\n   lsblk\n   sudo fdisk -l /dev/sda\n   ```\n\n2. **调整分区大小**\n\n   使用 `parted` 调整分区大小。\n\n   ```bash\n   sudo parted /dev/sda\n   ```\n\n   在 `parted` 交互界面中执行以下步骤：\n\n   ```bash\n   (parted) print\n   ```\n\n   确认分区表，并记下 `/dev/sda1` 的起始位置（例如 `2048s`）。\n\n   ```bash\n   (parted) resizepart 1 150GB\n   ```\n\n   这会扩展分区1到150GB。\n\n   ```bash\n   (parted) quit\n   ```\n\n#### 3. **更新分区表**\n\n有时，系统需要重新加载分区表。\n\n```bash\nsudo partprobe /dev/sda\n```\n\n#### 4. **扩展文件系统**\n\n根据你的文件系统类型，执行以下步骤来扩展文件系统。\n\n##### 对于 `ext4` 文件系统：\n\n```bash\nsudo resize2fs /dev/sda1\n```\n\n##### 对于 `xfs` 文件系统：\n\n```bash\nsudo xfs_growfs /dev/sda1\n```\n\n#### 5. **验证扩展是否成功**\n\n```bash\ndf -h\n```\n\n### 示例步骤\n\n完整的命令和步骤如下：\n\n```bash\n# 查看当前磁盘布局\nlsblk\nsudo fdisk -l /dev/sda\n\n# 调整分区大小\nsudo parted /dev/sda\n\n# 在 parted 交互界面中\n(parted) print\n(parted) resizepart 1 150GB\n(parted) quit\n\n# 更新分区表\nsudo partprobe /dev/sda\n\n# 扩展文件系统（假设是 ext4 文件系统）\nsudo resize2fs /dev/sda1\n\n# 验证扩展是否成功\ndf -h\n```\n\n### 注意事项\n\n- 确保你的 `/dev/sda1` 分区后面有足够的未分配空间来扩展到 150GB。\n- 在操作之前，确保系统分区未被使用或者在单用户模式下进行操作，以防止数据损坏。\n- 如果你无法进入系统，可以通过 live CD/USB 启动系统并执行这些操作。\n\n这些步骤旨在提供一种相对安全的方法来无损扩展分区。如果对操作不熟悉，建议请教专业人士或使用专业的分区管理软件进行操作。","slug":"linux/对linux磁盘进行无损扩容","published":1,"updated":"2025-02-18T06:25:13.114Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8x0028ujz3fww8bi9t","content":"<p>执行 lsblk 命令得到的数据如下<br>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS</span><br><span class=\"line\">sda      8:0    0  150G  0 disk </span><br><span class=\"line\">├─sda1   8:1    0   49G  0 part /</span><br><span class=\"line\">├─sda2   8:2    0    1K  0 part </span><br><span class=\"line\">└─sda5   8:5    0  975M  0 part [SWAP]</span><br><span class=\"line\">sr0     11:0    1  4.6G  0 rom  </span><br></pre></td></tr></table></figure><br>此时，想将sda1从49G扩容到150G。进行无损扩展 <code>/dev/sda1</code> 的步骤较为复杂，但可以通过以下步骤来安全地扩展分区而不丢失数据。这包括使用 <code>fdisk</code> 或 <code>parted</code> 工具来调整分区大小，然后扩展文件系统。</p>\n<h3 id=\"无损扩展分区的步骤\"><a href=\"#无损扩展分区的步骤\" class=\"headerlink\" title=\"无损扩展分区的步骤\"></a>无损扩展分区的步骤</h3><h4 id=\"1-备份数据\"><a href=\"#1-备份数据\" class=\"headerlink\" title=\"1. 备份数据\"></a>1. <strong>备份数据</strong></h4><p>在进行任何磁盘操作之前，务必备份重要数据以防万一。</p>\n<h4 id=\"2-使用-parted-调整分区大小\"><a href=\"#2-使用-parted-调整分区大小\" class=\"headerlink\" title=\"2. 使用 parted 调整分区大小\"></a>2. <strong>使用 <code>parted</code> 调整分区大小</strong></h4><p>假设现有的 <code>/dev/sda1</code> 是 <code>ext4</code> 文件系统。</p>\n<ol>\n<li><p><strong>查看当前磁盘布局</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsblk</span><br><span class=\"line\">sudo fdisk -l /dev/sda</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>调整分区大小</strong></p>\n<p>使用 <code>parted</code> 调整分区大小。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo parted /dev/sda</span><br></pre></td></tr></table></figure>\n\n<p>在 <code>parted</code> 交互界面中执行以下步骤：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(parted) <span class=\"built_in\">print</span></span><br></pre></td></tr></table></figure>\n\n<p>确认分区表，并记下 <code>/dev/sda1</code> 的起始位置（例如 <code>2048s</code>）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(parted) resizepart 1 150GB</span><br></pre></td></tr></table></figure>\n\n<p>这会扩展分区1到150GB。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(parted) quit</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h4 id=\"3-更新分区表\"><a href=\"#3-更新分区表\" class=\"headerlink\" title=\"3. 更新分区表\"></a>3. <strong>更新分区表</strong></h4><p>有时，系统需要重新加载分区表。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo partprobe /dev/sda</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-扩展文件系统\"><a href=\"#4-扩展文件系统\" class=\"headerlink\" title=\"4. 扩展文件系统\"></a>4. <strong>扩展文件系统</strong></h4><p>根据你的文件系统类型，执行以下步骤来扩展文件系统。</p>\n<h5 id=\"对于-ext4-文件系统：\"><a href=\"#对于-ext4-文件系统：\" class=\"headerlink\" title=\"对于 ext4 文件系统：\"></a>对于 <code>ext4</code> 文件系统：</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo resize2fs /dev/sda1</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"对于-xfs-文件系统：\"><a href=\"#对于-xfs-文件系统：\" class=\"headerlink\" title=\"对于 xfs 文件系统：\"></a>对于 <code>xfs</code> 文件系统：</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo xfs_growfs /dev/sda1</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-验证扩展是否成功\"><a href=\"#5-验证扩展是否成功\" class=\"headerlink\" title=\"5. 验证扩展是否成功\"></a>5. <strong>验证扩展是否成功</strong></h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">df</span> -h</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"示例步骤\"><a href=\"#示例步骤\" class=\"headerlink\" title=\"示例步骤\"></a>示例步骤</h3><p>完整的命令和步骤如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前磁盘布局</span></span><br><span class=\"line\">lsblk</span><br><span class=\"line\">sudo fdisk -l /dev/sda</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 调整分区大小</span></span><br><span class=\"line\">sudo parted /dev/sda</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在 parted 交互界面中</span></span><br><span class=\"line\">(parted) <span class=\"built_in\">print</span></span><br><span class=\"line\">(parted) resizepart 1 150GB</span><br><span class=\"line\">(parted) quit</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新分区表</span></span><br><span class=\"line\">sudo partprobe /dev/sda</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 扩展文件系统（假设是 ext4 文件系统）</span></span><br><span class=\"line\">sudo resize2fs /dev/sda1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证扩展是否成功</span></span><br><span class=\"line\"><span class=\"built_in\">df</span> -h</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h3><ul>\n<li>确保你的 <code>/dev/sda1</code> 分区后面有足够的未分配空间来扩展到 150GB。</li>\n<li>在操作之前，确保系统分区未被使用或者在单用户模式下进行操作，以防止数据损坏。</li>\n<li>如果你无法进入系统，可以通过 live CD&#x2F;USB 启动系统并执行这些操作。</li>\n</ul>\n<p>这些步骤旨在提供一种相对安全的方法来无损扩展分区。如果对操作不熟悉，建议请教专业人士或使用专业的分区管理软件进行操作。</p>\n","cover":false,"excerpt":"","more":"<p>执行 lsblk 命令得到的数据如下<br>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS</span><br><span class=\"line\">sda      8:0    0  150G  0 disk </span><br><span class=\"line\">├─sda1   8:1    0   49G  0 part /</span><br><span class=\"line\">├─sda2   8:2    0    1K  0 part </span><br><span class=\"line\">└─sda5   8:5    0  975M  0 part [SWAP]</span><br><span class=\"line\">sr0     11:0    1  4.6G  0 rom  </span><br></pre></td></tr></table></figure><br>此时，想将sda1从49G扩容到150G。进行无损扩展 <code>/dev/sda1</code> 的步骤较为复杂，但可以通过以下步骤来安全地扩展分区而不丢失数据。这包括使用 <code>fdisk</code> 或 <code>parted</code> 工具来调整分区大小，然后扩展文件系统。</p>\n<h3 id=\"无损扩展分区的步骤\"><a href=\"#无损扩展分区的步骤\" class=\"headerlink\" title=\"无损扩展分区的步骤\"></a>无损扩展分区的步骤</h3><h4 id=\"1-备份数据\"><a href=\"#1-备份数据\" class=\"headerlink\" title=\"1. 备份数据\"></a>1. <strong>备份数据</strong></h4><p>在进行任何磁盘操作之前，务必备份重要数据以防万一。</p>\n<h4 id=\"2-使用-parted-调整分区大小\"><a href=\"#2-使用-parted-调整分区大小\" class=\"headerlink\" title=\"2. 使用 parted 调整分区大小\"></a>2. <strong>使用 <code>parted</code> 调整分区大小</strong></h4><p>假设现有的 <code>/dev/sda1</code> 是 <code>ext4</code> 文件系统。</p>\n<ol>\n<li><p><strong>查看当前磁盘布局</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsblk</span><br><span class=\"line\">sudo fdisk -l /dev/sda</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>调整分区大小</strong></p>\n<p>使用 <code>parted</code> 调整分区大小。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo parted /dev/sda</span><br></pre></td></tr></table></figure>\n\n<p>在 <code>parted</code> 交互界面中执行以下步骤：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(parted) <span class=\"built_in\">print</span></span><br></pre></td></tr></table></figure>\n\n<p>确认分区表，并记下 <code>/dev/sda1</code> 的起始位置（例如 <code>2048s</code>）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(parted) resizepart 1 150GB</span><br></pre></td></tr></table></figure>\n\n<p>这会扩展分区1到150GB。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(parted) quit</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h4 id=\"3-更新分区表\"><a href=\"#3-更新分区表\" class=\"headerlink\" title=\"3. 更新分区表\"></a>3. <strong>更新分区表</strong></h4><p>有时，系统需要重新加载分区表。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo partprobe /dev/sda</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-扩展文件系统\"><a href=\"#4-扩展文件系统\" class=\"headerlink\" title=\"4. 扩展文件系统\"></a>4. <strong>扩展文件系统</strong></h4><p>根据你的文件系统类型，执行以下步骤来扩展文件系统。</p>\n<h5 id=\"对于-ext4-文件系统：\"><a href=\"#对于-ext4-文件系统：\" class=\"headerlink\" title=\"对于 ext4 文件系统：\"></a>对于 <code>ext4</code> 文件系统：</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo resize2fs /dev/sda1</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"对于-xfs-文件系统：\"><a href=\"#对于-xfs-文件系统：\" class=\"headerlink\" title=\"对于 xfs 文件系统：\"></a>对于 <code>xfs</code> 文件系统：</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo xfs_growfs /dev/sda1</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-验证扩展是否成功\"><a href=\"#5-验证扩展是否成功\" class=\"headerlink\" title=\"5. 验证扩展是否成功\"></a>5. <strong>验证扩展是否成功</strong></h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">df</span> -h</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"示例步骤\"><a href=\"#示例步骤\" class=\"headerlink\" title=\"示例步骤\"></a>示例步骤</h3><p>完整的命令和步骤如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前磁盘布局</span></span><br><span class=\"line\">lsblk</span><br><span class=\"line\">sudo fdisk -l /dev/sda</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 调整分区大小</span></span><br><span class=\"line\">sudo parted /dev/sda</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在 parted 交互界面中</span></span><br><span class=\"line\">(parted) <span class=\"built_in\">print</span></span><br><span class=\"line\">(parted) resizepart 1 150GB</span><br><span class=\"line\">(parted) quit</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新分区表</span></span><br><span class=\"line\">sudo partprobe /dev/sda</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 扩展文件系统（假设是 ext4 文件系统）</span></span><br><span class=\"line\">sudo resize2fs /dev/sda1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证扩展是否成功</span></span><br><span class=\"line\"><span class=\"built_in\">df</span> -h</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h3><ul>\n<li>确保你的 <code>/dev/sda1</code> 分区后面有足够的未分配空间来扩展到 150GB。</li>\n<li>在操作之前，确保系统分区未被使用或者在单用户模式下进行操作，以防止数据损坏。</li>\n<li>如果你无法进入系统，可以通过 live CD&#x2F;USB 启动系统并执行这些操作。</li>\n</ul>\n<p>这些步骤旨在提供一种相对安全的方法来无损扩展分区。如果对操作不熟悉，建议请教专业人士或使用专业的分区管理软件进行操作。</p>\n"},{"title":"在linux上使用代理","date":"2024-07-26T01:56:32.000Z","_content":"要在 Linux 命令行下使用 Clash Verge，需要按照以下步骤进行：\n\n### 1. 安装 Clash Verge\n\n首先，确保你的系统已经安装了 Clash Core。Clash Verge 是一个图形界面管理工具，而 Clash 本身是需要运行在后台的代理工具。\n\n#### 下载 Clash\n\n[mihomo-linux-amd64-v1.18.6.deb](../../resource/mihomo-linux-amd64-v1.18.6.deb)\n```bash\ndpkg -i mihomo-linux-amd64-v1.18.6.deb     \nchmod 777 mihomo-linux-amd64-v1.18.6.deb \nsudo mv mihomo-linux-amd64-v1.18.6 clash\n```\n\n### 2. 配置 Clash\n在使用 Clash Verge 之前，需要先配置 Clash 的 `config.yaml` 文件。\n\n```bash\n拷贝windows上的配置：D:\\soft\\clash-verge-1.6.2\\.config\\io.github.clash-verge-rev.clash-verge-rev/clash-verge.yaml\nwget -O /root/.config/mihomo/config.yaml 你配置好的clash-verge.yaml\n```\n### 3. 启动 Clash\n在命令行中启动 Clash：\n```bash\nnohup ./clash &\n```\nClash Verge 启动后，将打开一个本地的图形界面，你可以通过浏览器访问该界面，通常是 `http://localhost:7899` 或者其他配置文件中指定的端口。\n\n\n\n1. **创建代理配置文件**：在Kali系统的Docker配置目录下创建一个名为`/etc/systemd/system/docker.service.d/http-proxy.conf`的文件。如果该目录不存在，请先创建它。\n\n```sh\nsudo mkdir -p /etc/systemd/system/docker.service.d\nsudo nano /etc/systemd/system/docker.service.d/http-proxy.conf\n```\n\n2. **配置代理**：在`http-proxy.conf`文件中添加以下内容，将`http://127.0.0.1:7899`替换为你的代理服务器地址和端口。\n\n```ini\n[Service]\nEnvironment=\"HTTP_PROXY=http://127.0.0.1:7899\"\nEnvironment=\"HTTPS_PROXY=http://127.0.0.1:7899\"\nEnvironment=\"NO_PROXY=localhost,127.0.0.1\"\n```\n\n3. **重新加载守护进程并重启Docker服务**：\n\n```sh\nsudo systemctl daemon-reload\nsudo systemctl restart docker\n```\n\n4. **验证代理配置**：你可以通过以下命令来验证Docker是否通过代理服务器进行连接：\n\n```sh\ndocker info\n```\n\n在输出信息中找到`HTTP Proxy`和`HTTPS Proxy`条目，检查它们是否显示了你配置的代理服务器地址。\n\n如果你需要为Docker客户端配置代理（如`docker build`命令），可以在你的shell配置文件（如`~/.bashrc`或`~/.zshrc`）中添加以下行：\n\n```sh\nexport HTTP_PROXY=\"http://your-proxy.example.com:8080\"\nexport HTTPS_PROXY=\"http://your-proxy.example.com:8080\"\nexport NO_PROXY=\"localhost,127.0.0.1\"\n```\n\n保存文件并加载新的配置：\n\n```sh\nsource ~/.bashrc  # 或者 source ~/.zshrc\n```\n\n这样，Docker客户端在运行时也会通过代理服务器进行连接。","source":"_posts/linux/在linux上使用代理.md","raw":"---\ntitle: 在linux上使用代理\ndate: 2024-07-26 09:56:32\ncategories: clash\ntag: 翻墙\n---\n要在 Linux 命令行下使用 Clash Verge，需要按照以下步骤进行：\n\n### 1. 安装 Clash Verge\n\n首先，确保你的系统已经安装了 Clash Core。Clash Verge 是一个图形界面管理工具，而 Clash 本身是需要运行在后台的代理工具。\n\n#### 下载 Clash\n\n[mihomo-linux-amd64-v1.18.6.deb](../../resource/mihomo-linux-amd64-v1.18.6.deb)\n```bash\ndpkg -i mihomo-linux-amd64-v1.18.6.deb     \nchmod 777 mihomo-linux-amd64-v1.18.6.deb \nsudo mv mihomo-linux-amd64-v1.18.6 clash\n```\n\n### 2. 配置 Clash\n在使用 Clash Verge 之前，需要先配置 Clash 的 `config.yaml` 文件。\n\n```bash\n拷贝windows上的配置：D:\\soft\\clash-verge-1.6.2\\.config\\io.github.clash-verge-rev.clash-verge-rev/clash-verge.yaml\nwget -O /root/.config/mihomo/config.yaml 你配置好的clash-verge.yaml\n```\n### 3. 启动 Clash\n在命令行中启动 Clash：\n```bash\nnohup ./clash &\n```\nClash Verge 启动后，将打开一个本地的图形界面，你可以通过浏览器访问该界面，通常是 `http://localhost:7899` 或者其他配置文件中指定的端口。\n\n\n\n1. **创建代理配置文件**：在Kali系统的Docker配置目录下创建一个名为`/etc/systemd/system/docker.service.d/http-proxy.conf`的文件。如果该目录不存在，请先创建它。\n\n```sh\nsudo mkdir -p /etc/systemd/system/docker.service.d\nsudo nano /etc/systemd/system/docker.service.d/http-proxy.conf\n```\n\n2. **配置代理**：在`http-proxy.conf`文件中添加以下内容，将`http://127.0.0.1:7899`替换为你的代理服务器地址和端口。\n\n```ini\n[Service]\nEnvironment=\"HTTP_PROXY=http://127.0.0.1:7899\"\nEnvironment=\"HTTPS_PROXY=http://127.0.0.1:7899\"\nEnvironment=\"NO_PROXY=localhost,127.0.0.1\"\n```\n\n3. **重新加载守护进程并重启Docker服务**：\n\n```sh\nsudo systemctl daemon-reload\nsudo systemctl restart docker\n```\n\n4. **验证代理配置**：你可以通过以下命令来验证Docker是否通过代理服务器进行连接：\n\n```sh\ndocker info\n```\n\n在输出信息中找到`HTTP Proxy`和`HTTPS Proxy`条目，检查它们是否显示了你配置的代理服务器地址。\n\n如果你需要为Docker客户端配置代理（如`docker build`命令），可以在你的shell配置文件（如`~/.bashrc`或`~/.zshrc`）中添加以下行：\n\n```sh\nexport HTTP_PROXY=\"http://your-proxy.example.com:8080\"\nexport HTTPS_PROXY=\"http://your-proxy.example.com:8080\"\nexport NO_PROXY=\"localhost,127.0.0.1\"\n```\n\n保存文件并加载新的配置：\n\n```sh\nsource ~/.bashrc  # 或者 source ~/.zshrc\n```\n\n这样，Docker客户端在运行时也会通过代理服务器进行连接。","slug":"linux/在linux上使用代理","published":1,"updated":"2025-02-22T09:39:54.462Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8x002bujz39ky59nis","content":"<p>要在 Linux 命令行下使用 Clash Verge，需要按照以下步骤进行：</p>\n<h3 id=\"1-安装-Clash-Verge\"><a href=\"#1-安装-Clash-Verge\" class=\"headerlink\" title=\"1. 安装 Clash Verge\"></a>1. 安装 Clash Verge</h3><p>首先，确保你的系统已经安装了 Clash Core。Clash Verge 是一个图形界面管理工具，而 Clash 本身是需要运行在后台的代理工具。</p>\n<h4 id=\"下载-Clash\"><a href=\"#下载-Clash\" class=\"headerlink\" title=\"下载 Clash\"></a>下载 Clash</h4><p><a href=\"../../resource/mihomo-linux-amd64-v1.18.6.deb\">mihomo-linux-amd64-v1.18.6.deb</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dpkg -i mihomo-linux-amd64-v1.18.6.deb     </span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 777 mihomo-linux-amd64-v1.18.6.deb </span><br><span class=\"line\">sudo <span class=\"built_in\">mv</span> mihomo-linux-amd64-v1.18.6 clash</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-配置-Clash\"><a href=\"#2-配置-Clash\" class=\"headerlink\" title=\"2. 配置 Clash\"></a>2. 配置 Clash</h3><p>在使用 Clash Verge 之前，需要先配置 Clash 的 <code>config.yaml</code> 文件。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">拷贝windows上的配置：D:\\soft\\clash-verge-1.6.2\\.config\\io.github.clash-verge-rev.clash-verge-rev/clash-verge.yaml</span><br><span class=\"line\">wget -O /root/.config/mihomo/config.yaml 你配置好的clash-verge.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-启动-Clash\"><a href=\"#3-启动-Clash\" class=\"headerlink\" title=\"3. 启动 Clash\"></a>3. 启动 Clash</h3><p>在命令行中启动 Clash：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">nohup</span> ./clash &amp;</span><br></pre></td></tr></table></figure>\n<p>Clash Verge 启动后，将打开一个本地的图形界面，你可以通过浏览器访问该界面，通常是 <code>http://localhost:7899</code> 或者其他配置文件中指定的端口。</p>\n<ol>\n<li><strong>创建代理配置文件</strong>：在Kali系统的Docker配置目录下创建一个名为<code>/etc/systemd/system/docker.service.d/http-proxy.conf</code>的文件。如果该目录不存在，请先创建它。</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class=\"line\">sudo nano /etc/systemd/system/docker.service.d/http-proxy.conf</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><strong>配置代理</strong>：在<code>http-proxy.conf</code>文件中添加以下内容，将<code>http://127.0.0.1:7899</code>替换为你的代理服务器地址和端口。</li>\n</ol>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">Environment</span>=<span class=\"string\">&quot;HTTP_PROXY=http://127.0.0.1:7899&quot;</span></span><br><span class=\"line\"><span class=\"attr\">Environment</span>=<span class=\"string\">&quot;HTTPS_PROXY=http://127.0.0.1:7899&quot;</span></span><br><span class=\"line\"><span class=\"attr\">Environment</span>=<span class=\"string\">&quot;NO_PROXY=localhost,127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><strong>重新加载守护进程并重启Docker服务</strong>：</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li><strong>验证代理配置</strong>：你可以通过以下命令来验证Docker是否通过代理服务器进行连接：</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker info</span><br></pre></td></tr></table></figure>\n\n<p>在输出信息中找到<code>HTTP Proxy</code>和<code>HTTPS Proxy</code>条目，检查它们是否显示了你配置的代理服务器地址。</p>\n<p>如果你需要为Docker客户端配置代理（如<code>docker build</code>命令），可以在你的shell配置文件（如<code>~/.bashrc</code>或<code>~/.zshrc</code>）中添加以下行：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> HTTP_PROXY=<span class=\"string\">&quot;http://your-proxy.example.com:8080&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HTTPS_PROXY=<span class=\"string\">&quot;http://your-proxy.example.com:8080&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> NO_PROXY=<span class=\"string\">&quot;localhost,127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>保存文件并加载新的配置：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc  <span class=\"comment\"># 或者 source ~/.zshrc</span></span><br></pre></td></tr></table></figure>\n\n<p>这样，Docker客户端在运行时也会通过代理服务器进行连接。</p>\n","cover":false,"excerpt":"","more":"<p>要在 Linux 命令行下使用 Clash Verge，需要按照以下步骤进行：</p>\n<h3 id=\"1-安装-Clash-Verge\"><a href=\"#1-安装-Clash-Verge\" class=\"headerlink\" title=\"1. 安装 Clash Verge\"></a>1. 安装 Clash Verge</h3><p>首先，确保你的系统已经安装了 Clash Core。Clash Verge 是一个图形界面管理工具，而 Clash 本身是需要运行在后台的代理工具。</p>\n<h4 id=\"下载-Clash\"><a href=\"#下载-Clash\" class=\"headerlink\" title=\"下载 Clash\"></a>下载 Clash</h4><p><a href=\"../../resource/mihomo-linux-amd64-v1.18.6.deb\">mihomo-linux-amd64-v1.18.6.deb</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dpkg -i mihomo-linux-amd64-v1.18.6.deb     </span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 777 mihomo-linux-amd64-v1.18.6.deb </span><br><span class=\"line\">sudo <span class=\"built_in\">mv</span> mihomo-linux-amd64-v1.18.6 clash</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-配置-Clash\"><a href=\"#2-配置-Clash\" class=\"headerlink\" title=\"2. 配置 Clash\"></a>2. 配置 Clash</h3><p>在使用 Clash Verge 之前，需要先配置 Clash 的 <code>config.yaml</code> 文件。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">拷贝windows上的配置：D:\\soft\\clash-verge-1.6.2\\.config\\io.github.clash-verge-rev.clash-verge-rev/clash-verge.yaml</span><br><span class=\"line\">wget -O /root/.config/mihomo/config.yaml 你配置好的clash-verge.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-启动-Clash\"><a href=\"#3-启动-Clash\" class=\"headerlink\" title=\"3. 启动 Clash\"></a>3. 启动 Clash</h3><p>在命令行中启动 Clash：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">nohup</span> ./clash &amp;</span><br></pre></td></tr></table></figure>\n<p>Clash Verge 启动后，将打开一个本地的图形界面，你可以通过浏览器访问该界面，通常是 <code>http://localhost:7899</code> 或者其他配置文件中指定的端口。</p>\n<ol>\n<li><strong>创建代理配置文件</strong>：在Kali系统的Docker配置目录下创建一个名为<code>/etc/systemd/system/docker.service.d/http-proxy.conf</code>的文件。如果该目录不存在，请先创建它。</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class=\"line\">sudo nano /etc/systemd/system/docker.service.d/http-proxy.conf</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><strong>配置代理</strong>：在<code>http-proxy.conf</code>文件中添加以下内容，将<code>http://127.0.0.1:7899</code>替换为你的代理服务器地址和端口。</li>\n</ol>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">Environment</span>=<span class=\"string\">&quot;HTTP_PROXY=http://127.0.0.1:7899&quot;</span></span><br><span class=\"line\"><span class=\"attr\">Environment</span>=<span class=\"string\">&quot;HTTPS_PROXY=http://127.0.0.1:7899&quot;</span></span><br><span class=\"line\"><span class=\"attr\">Environment</span>=<span class=\"string\">&quot;NO_PROXY=localhost,127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><strong>重新加载守护进程并重启Docker服务</strong>：</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li><strong>验证代理配置</strong>：你可以通过以下命令来验证Docker是否通过代理服务器进行连接：</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker info</span><br></pre></td></tr></table></figure>\n\n<p>在输出信息中找到<code>HTTP Proxy</code>和<code>HTTPS Proxy</code>条目，检查它们是否显示了你配置的代理服务器地址。</p>\n<p>如果你需要为Docker客户端配置代理（如<code>docker build</code>命令），可以在你的shell配置文件（如<code>~/.bashrc</code>或<code>~/.zshrc</code>）中添加以下行：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> HTTP_PROXY=<span class=\"string\">&quot;http://your-proxy.example.com:8080&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HTTPS_PROXY=<span class=\"string\">&quot;http://your-proxy.example.com:8080&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> NO_PROXY=<span class=\"string\">&quot;localhost,127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>保存文件并加载新的配置：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc  <span class=\"comment\"># 或者 source ~/.zshrc</span></span><br></pre></td></tr></table></figure>\n\n<p>这样，Docker客户端在运行时也会通过代理服务器进行连接。</p>\n"},{"title":"交易下单时金额变化","date":"2024-09-11T07:14:06.000Z","_content":"\n账户信息:\n\n​\t余额 : 100000 信用 : 0 净值 : 100000 可用保证金 : 100000 已用保证金 : 0 预付款比例 : 0 仓息 : 手续费 : 盈亏 : 0\n\n​\t净值 = 余额+信用+浮动盈亏（平仓后，浮动盈亏转为余额）\n\n​\t净值 = 可用保证金+已用保证金\n\n​\t浮动盈亏=订单盈亏+手续费+隔夜仓息\n\n\n\n下单时：\n\n​\t余额 : 100000 信用 : 0 净值（通过公式计算） : 100000 可用保证金 : 100000 已用保证金 : 0 预付款比例 : 0 仓息 : 手续费 : 盈亏 : 0\n\n​\t\n\n占用10元的保证金：   浮动盈亏：+1  ，开仓手续费：-50\n\n​\t余额 : 100000 信用 : 0 净值（通过公式计算） : 100000+1 -50 可用保证金 : 100000 +1 -50  -10  已用保证金 : 10 预付款比例 : 0 仓息 : 手续费 :50  ， 浮动盈亏 : -50 +1  ，订单盈亏：1\n\n\n\n发生平仓：释放占用的10元的保证金：   浮动盈亏：+1，开仓手续费：-50 ， 关仓手续费：-40\n\n​\t余额 : 100000 -50-40 +1 信用 : 0  净值（通过公式计算） : 100000+1 -50-40  可用保证金 : 100000 +1 -50 -40  -10+10  已用保证金 : 0  预付款比例 : 0 仓息 : 手续费 :  50+40， 浮动盈亏 :0  ，订单盈亏：1\n\n\n\n\n\n\n\n","source":"_posts/交易/交易下单时金额变化.md","raw":"---\ntitle: 交易下单时金额变化\ndate: 2024-09-11 15:14:06\ncategories: 交易\ntag: 账户资金\n---\n\n账户信息:\n\n​\t余额 : 100000 信用 : 0 净值 : 100000 可用保证金 : 100000 已用保证金 : 0 预付款比例 : 0 仓息 : 手续费 : 盈亏 : 0\n\n​\t净值 = 余额+信用+浮动盈亏（平仓后，浮动盈亏转为余额）\n\n​\t净值 = 可用保证金+已用保证金\n\n​\t浮动盈亏=订单盈亏+手续费+隔夜仓息\n\n\n\n下单时：\n\n​\t余额 : 100000 信用 : 0 净值（通过公式计算） : 100000 可用保证金 : 100000 已用保证金 : 0 预付款比例 : 0 仓息 : 手续费 : 盈亏 : 0\n\n​\t\n\n占用10元的保证金：   浮动盈亏：+1  ，开仓手续费：-50\n\n​\t余额 : 100000 信用 : 0 净值（通过公式计算） : 100000+1 -50 可用保证金 : 100000 +1 -50  -10  已用保证金 : 10 预付款比例 : 0 仓息 : 手续费 :50  ， 浮动盈亏 : -50 +1  ，订单盈亏：1\n\n\n\n发生平仓：释放占用的10元的保证金：   浮动盈亏：+1，开仓手续费：-50 ， 关仓手续费：-40\n\n​\t余额 : 100000 -50-40 +1 信用 : 0  净值（通过公式计算） : 100000+1 -50-40  可用保证金 : 100000 +1 -50 -40  -10+10  已用保证金 : 0  预付款比例 : 0 仓息 : 手续费 :  50+40， 浮动盈亏 :0  ，订单盈亏：1\n\n\n\n\n\n\n\n","slug":"交易/交易下单时金额变化","published":1,"updated":"2025-02-18T06:27:33.022Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8z003qujz369dofmxc","content":"<p>账户信息:</p>\n<p>​\t余额 : 100000 信用 : 0 净值 : 100000 可用保证金 : 100000 已用保证金 : 0 预付款比例 : 0 仓息 : 手续费 : 盈亏 : 0</p>\n<p>​\t净值 &#x3D; 余额+信用+浮动盈亏（平仓后，浮动盈亏转为余额）</p>\n<p>​\t净值 &#x3D; 可用保证金+已用保证金</p>\n<p>​\t浮动盈亏&#x3D;订单盈亏+手续费+隔夜仓息</p>\n<p>下单时：</p>\n<p>​\t余额 : 100000 信用 : 0 净值（通过公式计算） : 100000 可用保证金 : 100000 已用保证金 : 0 预付款比例 : 0 仓息 : 手续费 : 盈亏 : 0</p>\n<p>​\t</p>\n<p>占用10元的保证金：   浮动盈亏：+1  ，开仓手续费：-50</p>\n<p>​\t余额 : 100000 信用 : 0 净值（通过公式计算） : 100000+1 -50 可用保证金 : 100000 +1 -50  -10  已用保证金 : 10 预付款比例 : 0 仓息 : 手续费 :50  ， 浮动盈亏 : -50 +1  ，订单盈亏：1</p>\n<p>发生平仓：释放占用的10元的保证金：   浮动盈亏：+1，开仓手续费：-50 ， 关仓手续费：-40</p>\n<p>​\t余额 : 100000 -50-40 +1 信用 : 0  净值（通过公式计算） : 100000+1 -50-40  可用保证金 : 100000 +1 -50 -40  -10+10  已用保证金 : 0  预付款比例 : 0 仓息 : 手续费 :  50+40， 浮动盈亏 :0  ，订单盈亏：1</p>\n","cover":false,"excerpt":"","more":"<p>账户信息:</p>\n<p>​\t余额 : 100000 信用 : 0 净值 : 100000 可用保证金 : 100000 已用保证金 : 0 预付款比例 : 0 仓息 : 手续费 : 盈亏 : 0</p>\n<p>​\t净值 &#x3D; 余额+信用+浮动盈亏（平仓后，浮动盈亏转为余额）</p>\n<p>​\t净值 &#x3D; 可用保证金+已用保证金</p>\n<p>​\t浮动盈亏&#x3D;订单盈亏+手续费+隔夜仓息</p>\n<p>下单时：</p>\n<p>​\t余额 : 100000 信用 : 0 净值（通过公式计算） : 100000 可用保证金 : 100000 已用保证金 : 0 预付款比例 : 0 仓息 : 手续费 : 盈亏 : 0</p>\n<p>​\t</p>\n<p>占用10元的保证金：   浮动盈亏：+1  ，开仓手续费：-50</p>\n<p>​\t余额 : 100000 信用 : 0 净值（通过公式计算） : 100000+1 -50 可用保证金 : 100000 +1 -50  -10  已用保证金 : 10 预付款比例 : 0 仓息 : 手续费 :50  ， 浮动盈亏 : -50 +1  ，订单盈亏：1</p>\n<p>发生平仓：释放占用的10元的保证金：   浮动盈亏：+1，开仓手续费：-50 ， 关仓手续费：-40</p>\n<p>​\t余额 : 100000 -50-40 +1 信用 : 0  净值（通过公式计算） : 100000+1 -50-40  可用保证金 : 100000 +1 -50 -40  -10+10  已用保证金 : 0  预付款比例 : 0 仓息 : 手续费 :  50+40， 浮动盈亏 :0  ，订单盈亏：1</p>\n"},{"title":"解读redis分布式锁核心逻辑","date":"2024-07-30T02:07:27.000Z","_content":"   ```lua\n  local insertable = false; local value = redis.call('hget', KEYS[1], ARGV[5]); if value == false then insertable = true; else local t, val = struct.unpack('dLc0', value); local expireDate = 92233720368547758; local expireDateScore = redis.call('zscore', KEYS[2], ARGV[5]); if expireDateScore ~= false then expireDate = tonumber(expireDateScore) end; if t ~= 0 then local expireIdle = redis.call('zscore', KEYS[3], ARGV[5]); if expireIdle ~= false then expireDate = math.min(expireDate, tonumber(expireIdle)) end; end; if expireDate <= tonumber(ARGV[1]) then insertable = true; end; end; if insertable == true then if tonumber(ARGV[2]) > 0 then redis.call('zadd', KEYS[2], ARGV[2], ARGV[5]); else redis.call('zrem', KEYS[2], ARGV[5]); end; if tonumber(ARGV[3]) > 0 then redis.call('zadd', KEYS[3], ARGV[3], ARGV[5]); else redis.call('zrem', KEYS[3], ARGV[5]); end; local maxSize = tonumber(redis.call('hget', KEYS[7], 'max-size')); if maxSize ~= nil and maxSize ~= 0 then     local currentTime = tonumber(ARGV[1]);     local lastAccessTimeSetName = KEYS[5]; local mode = redis.call('hget', KEYS[7], 'mode'); if mode == false or mode == 'LRU' then redis.call('zadd', lastAccessTimeSetName, currentTime, ARGV[5]); end;     local cacheSize = tonumber(redis.call('hlen', KEYS[1]));     if cacheSize >= maxSize then         local lruItems = redis.call('zrange', lastAccessTimeSetName, 0, cacheSize - maxSize);         for index, lruItem in ipairs(lruItems) do             if lruItem and lruItem ~= ARGV[5] then                 local lruItemValue = redis.call('hget', KEYS[1], lruItem);                 redis.call('hdel', KEYS[1], lruItem);                 redis.call('zrem', KEYS[2], lruItem);                 redis.call('zrem', KEYS[3], lruItem);                 redis.call('zrem', lastAccessTimeSetName, lruItem);                 if lruItemValue ~= false then                 local removedChannelName = KEYS[6]; local ttl, obj = struct.unpack('dLc0', lruItemValue);                    local msg = struct.pack('Lc0Lc0', string.len(lruItem), lruItem, string.len(obj), obj);                redis.call('publish', removedChannelName, msg); end;             end;         end;     end; if mode == 'LFU' then redis.call('zincrby', lastAccessTimeSetName, 1, ARGV[5]); end; end; local val = struct.pack('dLc0', tonumber(ARGV[4]), string.len(ARGV[6]), ARGV[6]); redis.call('hset', KEYS[1], ARGV[5], val); local msg = struct.pack('Lc0Lc0', string.len(ARGV[5]), ARGV[5], string.len(ARGV[6]), ARGV[6]); redis.call('publish', KEYS[4], msg); return nil; else local t, val = struct.unpack('dLc0', value); redis.call('zadd', KEYS[3], t + ARGV[1], ARGV[5]); return val; end; \n   ```\n\n这段Lua脚本用于Redis缓存的管理和插入操作，主要功能包括：\n- 判断是否需要插入或更新缓存。\n- 处理缓存的过期逻辑。\n- 实现基于LRU（最近最少使用）或LFU（最少使用频率）策略的缓存淘汰。\n- 在缓存项插入或更新时发布相关消息。\n\n具体的解读如下：\n\n1. **初始化和获取当前值**：\n   ```lua\n   local insertable = false\n   local value = redis.call('hget', KEYS[1], ARGV[5])\n   ```\n\n2. **判断当前缓存项是否存在**：\n    - 如果不存在，则设置`insertable`为`true`，表示可以插入新的缓存项。\n    - 如果存在，继续判断其过期时间。\n   ```lua\n   if value == false then \n       insertable = true \n   else\n       local t, val = struct.unpack('dLc0', value)\n       local expireDate = 92233720368547758\n       local expireDateScore = redis.call('zscore', KEYS[2], ARGV[5])\n       if expireDateScore ~= false then expireDate = tonumber(expireDateScore) end\n       if t ~= 0 then\n           local expireIdle = redis.call('zscore', KEYS[3], ARGV[5])\n           if expireIdle ~= false then expireDate = math.min(expireDate, tonumber(expireIdle)) end\n       end\n       if expireDate <= tonumber(ARGV[1]) then insertable = true end\n   end\n   ```\n\n3. **处理可插入的情况**：\n    - 更新或删除过期时间。\n    - 检查缓存大小，并根据LRU或LFU策略进行淘汰。\n   ```lua\n   if insertable == true then \n       if tonumber(ARGV[2]) > 0 then \n           redis.call('zadd', KEYS[2], ARGV[2], ARGV[5])\n       else \n           redis.call('zrem', KEYS[2], ARGV[5]) \n       end\n       if tonumber(ARGV[3]) > 0 then \n           redis.call('zadd', KEYS[3], ARGV[3], ARGV[5])\n       else \n           redis.call('zrem', KEYS[3], ARGV[5]) \n       end\n       local maxSize = tonumber(redis.call('hget', KEYS[7], 'max-size'))\n       if maxSize ~= nil and maxSize ~= 0 then\n           local currentTime = tonumber(ARGV[1])\n           local lastAccessTimeSetName = KEYS[5]\n           local mode = redis.call('hget', KEYS[7], 'mode')\n           if mode == false or mode == 'LRU' then \n               redis.call('zadd', lastAccessTimeSetName, currentTime, ARGV[5])\n           end\n           local cacheSize = tonumber(redis.call('hlen', KEYS[1]))\n           if cacheSize >= maxSize then\n               local lruItems = redis.call('zrange', lastAccessTimeSetName, 0, cacheSize - maxSize)\n               for index, lruItem in ipairs(lruItems) do\n                   if lruItem and lruItem ~= ARGV[5] then\n                       local lruItemValue = redis.call('hget', KEYS[1], lruItem)\n                       redis.call('hdel', KEYS[1], lruItem)\n                       redis.call('zrem', KEYS[2], lruItem)\n                       redis.call('zrem', KEYS[3], lruItem)\n                       redis.call('zrem', lastAccessTimeSetName, lruItem)\n                       if lruItemValue ~= false then\n                           local removedChannelName = KEYS[6]\n                           local ttl, obj = struct.unpack('dLc0', lruItemValue)\n                           local msg = struct.pack('Lc0Lc0', string.len(lruItem), lruItem, string.len(obj), obj)\n                           redis.call('publish', removedChannelName, msg)\n                       end\n                   end\n               end\n           end\n           if mode == 'LFU' then \n               redis.call('zincrby', lastAccessTimeSetName, 1, ARGV[5]) \n           end\n       end\n       local val = struct.pack('dLc0', tonumber(ARGV[4]), string.len(ARGV[6]), ARGV[6])\n       redis.call('hset', KEYS[1], ARGV[5], val)\n       local msg = struct.pack('Lc0Lc0', string.len(ARGV[5]), ARGV[5], string.len(ARGV[6]), ARGV[6])\n       redis.call('publish', KEYS[4], msg)\n       return nil\n   ```\n\n4. **处理不可插入的情况**：\n    - 更新过期时间，并返回现有值。\n   ```lua\n   else \n       local t, val = struct.unpack('dLc0', value)\n       redis.call('zadd', KEYS[3], t + ARGV[1], ARGV[5])\n       return val\n   end\n   ```\n\n### 参数和键值解释\n\n- `KEYS[1]`: 哈希表存储缓存项。\n- `KEYS[2]`: 有序集合存储过期时间。\n- `KEYS[3]`: 有序集合存储空闲时间。\n- `KEYS[4]`: 频道名称，用于发布缓存项变更消息。\n- `KEYS[5]`: 有序集合存储最近访问时间（LRU模式）。\n- `KEYS[6]`: 频道名称，用于发布被淘汰的缓存项。\n- `KEYS[7]`: 存储缓存配置（如最大尺寸、模式等）。\n\n- `ARGV[1]`: 当前时间戳。\n- `ARGV[2]`: 新的过期时间。\n- `ARGV[3]`: 新的空闲时间。\n- `ARGV[4]`: 新缓存项的TTL。\n- `ARGV[5]`: 缓存项的键名。\n- `ARGV[6]`: 缓存项的值。","source":"_posts/redis/解读redis分布式锁核心逻辑.md","raw":"---\ntitle: 解读redis分布式锁核心逻辑\ndate: 2024-07-30 10:07:27\ncategories: redis\ntag: lua表达式\n---\n   ```lua\n  local insertable = false; local value = redis.call('hget', KEYS[1], ARGV[5]); if value == false then insertable = true; else local t, val = struct.unpack('dLc0', value); local expireDate = 92233720368547758; local expireDateScore = redis.call('zscore', KEYS[2], ARGV[5]); if expireDateScore ~= false then expireDate = tonumber(expireDateScore) end; if t ~= 0 then local expireIdle = redis.call('zscore', KEYS[3], ARGV[5]); if expireIdle ~= false then expireDate = math.min(expireDate, tonumber(expireIdle)) end; end; if expireDate <= tonumber(ARGV[1]) then insertable = true; end; end; if insertable == true then if tonumber(ARGV[2]) > 0 then redis.call('zadd', KEYS[2], ARGV[2], ARGV[5]); else redis.call('zrem', KEYS[2], ARGV[5]); end; if tonumber(ARGV[3]) > 0 then redis.call('zadd', KEYS[3], ARGV[3], ARGV[5]); else redis.call('zrem', KEYS[3], ARGV[5]); end; local maxSize = tonumber(redis.call('hget', KEYS[7], 'max-size')); if maxSize ~= nil and maxSize ~= 0 then     local currentTime = tonumber(ARGV[1]);     local lastAccessTimeSetName = KEYS[5]; local mode = redis.call('hget', KEYS[7], 'mode'); if mode == false or mode == 'LRU' then redis.call('zadd', lastAccessTimeSetName, currentTime, ARGV[5]); end;     local cacheSize = tonumber(redis.call('hlen', KEYS[1]));     if cacheSize >= maxSize then         local lruItems = redis.call('zrange', lastAccessTimeSetName, 0, cacheSize - maxSize);         for index, lruItem in ipairs(lruItems) do             if lruItem and lruItem ~= ARGV[5] then                 local lruItemValue = redis.call('hget', KEYS[1], lruItem);                 redis.call('hdel', KEYS[1], lruItem);                 redis.call('zrem', KEYS[2], lruItem);                 redis.call('zrem', KEYS[3], lruItem);                 redis.call('zrem', lastAccessTimeSetName, lruItem);                 if lruItemValue ~= false then                 local removedChannelName = KEYS[6]; local ttl, obj = struct.unpack('dLc0', lruItemValue);                    local msg = struct.pack('Lc0Lc0', string.len(lruItem), lruItem, string.len(obj), obj);                redis.call('publish', removedChannelName, msg); end;             end;         end;     end; if mode == 'LFU' then redis.call('zincrby', lastAccessTimeSetName, 1, ARGV[5]); end; end; local val = struct.pack('dLc0', tonumber(ARGV[4]), string.len(ARGV[6]), ARGV[6]); redis.call('hset', KEYS[1], ARGV[5], val); local msg = struct.pack('Lc0Lc0', string.len(ARGV[5]), ARGV[5], string.len(ARGV[6]), ARGV[6]); redis.call('publish', KEYS[4], msg); return nil; else local t, val = struct.unpack('dLc0', value); redis.call('zadd', KEYS[3], t + ARGV[1], ARGV[5]); return val; end; \n   ```\n\n这段Lua脚本用于Redis缓存的管理和插入操作，主要功能包括：\n- 判断是否需要插入或更新缓存。\n- 处理缓存的过期逻辑。\n- 实现基于LRU（最近最少使用）或LFU（最少使用频率）策略的缓存淘汰。\n- 在缓存项插入或更新时发布相关消息。\n\n具体的解读如下：\n\n1. **初始化和获取当前值**：\n   ```lua\n   local insertable = false\n   local value = redis.call('hget', KEYS[1], ARGV[5])\n   ```\n\n2. **判断当前缓存项是否存在**：\n    - 如果不存在，则设置`insertable`为`true`，表示可以插入新的缓存项。\n    - 如果存在，继续判断其过期时间。\n   ```lua\n   if value == false then \n       insertable = true \n   else\n       local t, val = struct.unpack('dLc0', value)\n       local expireDate = 92233720368547758\n       local expireDateScore = redis.call('zscore', KEYS[2], ARGV[5])\n       if expireDateScore ~= false then expireDate = tonumber(expireDateScore) end\n       if t ~= 0 then\n           local expireIdle = redis.call('zscore', KEYS[3], ARGV[5])\n           if expireIdle ~= false then expireDate = math.min(expireDate, tonumber(expireIdle)) end\n       end\n       if expireDate <= tonumber(ARGV[1]) then insertable = true end\n   end\n   ```\n\n3. **处理可插入的情况**：\n    - 更新或删除过期时间。\n    - 检查缓存大小，并根据LRU或LFU策略进行淘汰。\n   ```lua\n   if insertable == true then \n       if tonumber(ARGV[2]) > 0 then \n           redis.call('zadd', KEYS[2], ARGV[2], ARGV[5])\n       else \n           redis.call('zrem', KEYS[2], ARGV[5]) \n       end\n       if tonumber(ARGV[3]) > 0 then \n           redis.call('zadd', KEYS[3], ARGV[3], ARGV[5])\n       else \n           redis.call('zrem', KEYS[3], ARGV[5]) \n       end\n       local maxSize = tonumber(redis.call('hget', KEYS[7], 'max-size'))\n       if maxSize ~= nil and maxSize ~= 0 then\n           local currentTime = tonumber(ARGV[1])\n           local lastAccessTimeSetName = KEYS[5]\n           local mode = redis.call('hget', KEYS[7], 'mode')\n           if mode == false or mode == 'LRU' then \n               redis.call('zadd', lastAccessTimeSetName, currentTime, ARGV[5])\n           end\n           local cacheSize = tonumber(redis.call('hlen', KEYS[1]))\n           if cacheSize >= maxSize then\n               local lruItems = redis.call('zrange', lastAccessTimeSetName, 0, cacheSize - maxSize)\n               for index, lruItem in ipairs(lruItems) do\n                   if lruItem and lruItem ~= ARGV[5] then\n                       local lruItemValue = redis.call('hget', KEYS[1], lruItem)\n                       redis.call('hdel', KEYS[1], lruItem)\n                       redis.call('zrem', KEYS[2], lruItem)\n                       redis.call('zrem', KEYS[3], lruItem)\n                       redis.call('zrem', lastAccessTimeSetName, lruItem)\n                       if lruItemValue ~= false then\n                           local removedChannelName = KEYS[6]\n                           local ttl, obj = struct.unpack('dLc0', lruItemValue)\n                           local msg = struct.pack('Lc0Lc0', string.len(lruItem), lruItem, string.len(obj), obj)\n                           redis.call('publish', removedChannelName, msg)\n                       end\n                   end\n               end\n           end\n           if mode == 'LFU' then \n               redis.call('zincrby', lastAccessTimeSetName, 1, ARGV[5]) \n           end\n       end\n       local val = struct.pack('dLc0', tonumber(ARGV[4]), string.len(ARGV[6]), ARGV[6])\n       redis.call('hset', KEYS[1], ARGV[5], val)\n       local msg = struct.pack('Lc0Lc0', string.len(ARGV[5]), ARGV[5], string.len(ARGV[6]), ARGV[6])\n       redis.call('publish', KEYS[4], msg)\n       return nil\n   ```\n\n4. **处理不可插入的情况**：\n    - 更新过期时间，并返回现有值。\n   ```lua\n   else \n       local t, val = struct.unpack('dLc0', value)\n       redis.call('zadd', KEYS[3], t + ARGV[1], ARGV[5])\n       return val\n   end\n   ```\n\n### 参数和键值解释\n\n- `KEYS[1]`: 哈希表存储缓存项。\n- `KEYS[2]`: 有序集合存储过期时间。\n- `KEYS[3]`: 有序集合存储空闲时间。\n- `KEYS[4]`: 频道名称，用于发布缓存项变更消息。\n- `KEYS[5]`: 有序集合存储最近访问时间（LRU模式）。\n- `KEYS[6]`: 频道名称，用于发布被淘汰的缓存项。\n- `KEYS[7]`: 存储缓存配置（如最大尺寸、模式等）。\n\n- `ARGV[1]`: 当前时间戳。\n- `ARGV[2]`: 新的过期时间。\n- `ARGV[3]`: 新的空闲时间。\n- `ARGV[4]`: 新缓存项的TTL。\n- `ARGV[5]`: 缓存项的键名。\n- `ARGV[6]`: 缓存项的值。","slug":"redis/解读redis分布式锁核心逻辑","published":1,"updated":"2025-02-18T06:24:40.765Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul8z003rujz3bti19jlv","content":"   <figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">local</span> insertable = <span class=\"literal\">false</span>; <span class=\"keyword\">local</span> value = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">if</span> value == <span class=\"literal\">false</span> <span class=\"keyword\">then</span> insertable = <span class=\"literal\">true</span>; <span class=\"keyword\">else</span> <span class=\"keyword\">local</span> t, val = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, value); <span class=\"keyword\">local</span> expireDate = <span class=\"number\">92233720368547758</span>; <span class=\"keyword\">local</span> expireDateScore = redis.call(<span class=\"string\">&#x27;zscore&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">if</span> expireDateScore ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span> expireDate = <span class=\"built_in\">tonumber</span>(expireDateScore) <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> t ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span> <span class=\"keyword\">local</span> expireIdle = redis.call(<span class=\"string\">&#x27;zscore&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">if</span> expireIdle ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span> expireDate = <span class=\"built_in\">math</span>.<span class=\"built_in\">min</span>(expireDate, <span class=\"built_in\">tonumber</span>(expireIdle)) <span class=\"keyword\">end</span>; <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> expireDate &lt;= <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">1</span>]) <span class=\"keyword\">then</span> insertable = <span class=\"literal\">true</span>; <span class=\"keyword\">end</span>; <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> insertable == <span class=\"literal\">true</span> <span class=\"keyword\">then</span> <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">2</span>]) &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span> redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">else</span> redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">3</span>]) &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span> redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">else</span> redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">end</span>; <span class=\"keyword\">local</span> maxSize = <span class=\"built_in\">tonumber</span>(redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">7</span>], <span class=\"string\">&#x27;max-size&#x27;</span>)); <span class=\"keyword\">if</span> maxSize ~= <span class=\"literal\">nil</span> <span class=\"keyword\">and</span> maxSize ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span>     <span class=\"keyword\">local</span> currentTime = <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">1</span>]);     <span class=\"keyword\">local</span> lastAccessTimeSetName = KEYS[<span class=\"number\">5</span>]; <span class=\"keyword\">local</span> mode = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">7</span>], <span class=\"string\">&#x27;mode&#x27;</span>); <span class=\"keyword\">if</span> mode == <span class=\"literal\">false</span> <span class=\"keyword\">or</span> mode == <span class=\"string\">&#x27;LRU&#x27;</span> <span class=\"keyword\">then</span> redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, lastAccessTimeSetName, currentTime, ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">end</span>;     <span class=\"keyword\">local</span> cacheSize = <span class=\"built_in\">tonumber</span>(redis.call(<span class=\"string\">&#x27;hlen&#x27;</span>, KEYS[<span class=\"number\">1</span>]));     <span class=\"keyword\">if</span> cacheSize &gt;= maxSize <span class=\"keyword\">then</span>         <span class=\"keyword\">local</span> lruItems = redis.call(<span class=\"string\">&#x27;zrange&#x27;</span>, lastAccessTimeSetName, <span class=\"number\">0</span>, cacheSize - maxSize);         <span class=\"keyword\">for</span> index, lruItem <span class=\"keyword\">in</span> <span class=\"built_in\">ipairs</span>(lruItems) <span class=\"keyword\">do</span>             <span class=\"keyword\">if</span> lruItem <span class=\"keyword\">and</span> lruItem ~= ARGV[<span class=\"number\">5</span>] <span class=\"keyword\">then</span>                 <span class=\"keyword\">local</span> lruItemValue = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">1</span>], lruItem);                 redis.call(<span class=\"string\">&#x27;hdel&#x27;</span>, KEYS[<span class=\"number\">1</span>], lruItem);                 redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">2</span>], lruItem);                 redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">3</span>], lruItem);                 redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, lastAccessTimeSetName, lruItem);                 <span class=\"keyword\">if</span> lruItemValue ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span>                 <span class=\"keyword\">local</span> removedChannelName = KEYS[<span class=\"number\">6</span>]; <span class=\"keyword\">local</span> ttl, obj = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, lruItemValue);                    <span class=\"keyword\">local</span> msg = struct.pack(<span class=\"string\">&#x27;Lc0Lc0&#x27;</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(lruItem), lruItem, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(obj), obj);                redis.call(<span class=\"string\">&#x27;publish&#x27;</span>, removedChannelName, msg); <span class=\"keyword\">end</span>;             <span class=\"keyword\">end</span>;         <span class=\"keyword\">end</span>;     <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> mode == <span class=\"string\">&#x27;LFU&#x27;</span> <span class=\"keyword\">then</span> redis.call(<span class=\"string\">&#x27;zincrby&#x27;</span>, lastAccessTimeSetName, <span class=\"number\">1</span>, ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">end</span>; <span class=\"keyword\">end</span>; <span class=\"keyword\">local</span> val = struct.pack(<span class=\"string\">&#x27;dLc0&#x27;</span>, <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">4</span>]), <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">6</span>]), ARGV[<span class=\"number\">6</span>]); redis.call(<span class=\"string\">&#x27;hset&#x27;</span>, KEYS[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>], val); <span class=\"keyword\">local</span> msg = struct.pack(<span class=\"string\">&#x27;Lc0Lc0&#x27;</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">5</span>]), ARGV[<span class=\"number\">5</span>], <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">6</span>]), ARGV[<span class=\"number\">6</span>]); redis.call(<span class=\"string\">&#x27;publish&#x27;</span>, KEYS[<span class=\"number\">4</span>], msg); <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>; <span class=\"keyword\">else</span> <span class=\"keyword\">local</span> t, val = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, value); redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">3</span>], t + ARGV[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">return</span> val; <span class=\"keyword\">end</span>; </span><br></pre></td></tr></table></figure>\n\n<p>这段Lua脚本用于Redis缓存的管理和插入操作，主要功能包括：</p>\n<ul>\n<li>判断是否需要插入或更新缓存。</li>\n<li>处理缓存的过期逻辑。</li>\n<li>实现基于LRU（最近最少使用）或LFU（最少使用频率）策略的缓存淘汰。</li>\n<li>在缓存项插入或更新时发布相关消息。</li>\n</ul>\n<p>具体的解读如下：</p>\n<ol>\n<li><p><strong>初始化和获取当前值</strong>：</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">local</span> insertable = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> value = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>])</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>判断当前缓存项是否存在</strong>：</p>\n<ul>\n<li>如果不存在，则设置<code>insertable</code>为<code>true</code>，表示可以插入新的缓存项。</li>\n<li>如果存在，继续判断其过期时间。<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> value == <span class=\"literal\">false</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">    insertable = <span class=\"literal\">true</span> </span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> t, val = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, value)</span><br><span class=\"line\">    <span class=\"keyword\">local</span> expireDate = <span class=\"number\">92233720368547758</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> expireDateScore = redis.call(<span class=\"string\">&#x27;zscore&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">    <span class=\"keyword\">if</span> expireDateScore ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span> expireDate = <span class=\"built_in\">tonumber</span>(expireDateScore) <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> t ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> expireIdle = redis.call(<span class=\"string\">&#x27;zscore&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">        <span class=\"keyword\">if</span> expireIdle ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span> expireDate = <span class=\"built_in\">math</span>.<span class=\"built_in\">min</span>(expireDate, <span class=\"built_in\">tonumber</span>(expireIdle)) <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> expireDate &lt;= <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">1</span>]) <span class=\"keyword\">then</span> insertable = <span class=\"literal\">true</span> <span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>处理可插入的情况</strong>：</p>\n<ul>\n<li>更新或删除过期时间。</li>\n<li>检查缓存大小，并根据LRU或LFU策略进行淘汰。<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> insertable == <span class=\"literal\">true</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">2</span>]) &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">        redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">    <span class=\"keyword\">else</span> </span><br><span class=\"line\">        redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>]) </span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">3</span>]) &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">        redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">    <span class=\"keyword\">else</span> </span><br><span class=\"line\">        redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>]) </span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> maxSize = <span class=\"built_in\">tonumber</span>(redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">7</span>], <span class=\"string\">&#x27;max-size&#x27;</span>))</span><br><span class=\"line\">    <span class=\"keyword\">if</span> maxSize ~= <span class=\"literal\">nil</span> <span class=\"keyword\">and</span> maxSize ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> currentTime = <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">1</span>])</span><br><span class=\"line\">        <span class=\"keyword\">local</span> lastAccessTimeSetName = KEYS[<span class=\"number\">5</span>]</span><br><span class=\"line\">        <span class=\"keyword\">local</span> mode = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">7</span>], <span class=\"string\">&#x27;mode&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> mode == <span class=\"literal\">false</span> <span class=\"keyword\">or</span> mode == <span class=\"string\">&#x27;LRU&#x27;</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">            redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, lastAccessTimeSetName, currentTime, ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> cacheSize = <span class=\"built_in\">tonumber</span>(redis.call(<span class=\"string\">&#x27;hlen&#x27;</span>, KEYS[<span class=\"number\">1</span>]))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> cacheSize &gt;= maxSize <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"keyword\">local</span> lruItems = redis.call(<span class=\"string\">&#x27;zrange&#x27;</span>, lastAccessTimeSetName, <span class=\"number\">0</span>, cacheSize - maxSize)</span><br><span class=\"line\">            <span class=\"keyword\">for</span> index, lruItem <span class=\"keyword\">in</span> <span class=\"built_in\">ipairs</span>(lruItems) <span class=\"keyword\">do</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> lruItem <span class=\"keyword\">and</span> lruItem ~= ARGV[<span class=\"number\">5</span>] <span class=\"keyword\">then</span></span><br><span class=\"line\">                    <span class=\"keyword\">local</span> lruItemValue = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">1</span>], lruItem)</span><br><span class=\"line\">                    redis.call(<span class=\"string\">&#x27;hdel&#x27;</span>, KEYS[<span class=\"number\">1</span>], lruItem)</span><br><span class=\"line\">                    redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">2</span>], lruItem)</span><br><span class=\"line\">                    redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">3</span>], lruItem)</span><br><span class=\"line\">                    redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, lastAccessTimeSetName, lruItem)</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> lruItemValue ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">                        <span class=\"keyword\">local</span> removedChannelName = KEYS[<span class=\"number\">6</span>]</span><br><span class=\"line\">                        <span class=\"keyword\">local</span> ttl, obj = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, lruItemValue)</span><br><span class=\"line\">                        <span class=\"keyword\">local</span> msg = struct.pack(<span class=\"string\">&#x27;Lc0Lc0&#x27;</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(lruItem), lruItem, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(obj), obj)</span><br><span class=\"line\">                        redis.call(<span class=\"string\">&#x27;publish&#x27;</span>, removedChannelName, msg)</span><br><span class=\"line\">                    <span class=\"keyword\">end</span></span><br><span class=\"line\">                <span class=\"keyword\">end</span></span><br><span class=\"line\">            <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mode == <span class=\"string\">&#x27;LFU&#x27;</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">            redis.call(<span class=\"string\">&#x27;zincrby&#x27;</span>, lastAccessTimeSetName, <span class=\"number\">1</span>, ARGV[<span class=\"number\">5</span>]) </span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> val = struct.pack(<span class=\"string\">&#x27;dLc0&#x27;</span>, <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">4</span>]), <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">6</span>]), ARGV[<span class=\"number\">6</span>])</span><br><span class=\"line\">    redis.call(<span class=\"string\">&#x27;hset&#x27;</span>, KEYS[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>], val)</span><br><span class=\"line\">    <span class=\"keyword\">local</span> msg = struct.pack(<span class=\"string\">&#x27;Lc0Lc0&#x27;</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">5</span>]), ARGV[<span class=\"number\">5</span>], <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">6</span>]), ARGV[<span class=\"number\">6</span>])</span><br><span class=\"line\">    redis.call(<span class=\"string\">&#x27;publish&#x27;</span>, KEYS[<span class=\"number\">4</span>], msg)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>处理不可插入的情况</strong>：</p>\n<ul>\n<li>更新过期时间，并返回现有值。<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> </span><br><span class=\"line\">    <span class=\"keyword\">local</span> t, val = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, value)</span><br><span class=\"line\">    redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">3</span>], t + ARGV[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">    <span class=\"keyword\">return</span> val</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"参数和键值解释\"><a href=\"#参数和键值解释\" class=\"headerlink\" title=\"参数和键值解释\"></a>参数和键值解释</h3><ul>\n<li><p><code>KEYS[1]</code>: 哈希表存储缓存项。</p>\n</li>\n<li><p><code>KEYS[2]</code>: 有序集合存储过期时间。</p>\n</li>\n<li><p><code>KEYS[3]</code>: 有序集合存储空闲时间。</p>\n</li>\n<li><p><code>KEYS[4]</code>: 频道名称，用于发布缓存项变更消息。</p>\n</li>\n<li><p><code>KEYS[5]</code>: 有序集合存储最近访问时间（LRU模式）。</p>\n</li>\n<li><p><code>KEYS[6]</code>: 频道名称，用于发布被淘汰的缓存项。</p>\n</li>\n<li><p><code>KEYS[7]</code>: 存储缓存配置（如最大尺寸、模式等）。</p>\n</li>\n<li><p><code>ARGV[1]</code>: 当前时间戳。</p>\n</li>\n<li><p><code>ARGV[2]</code>: 新的过期时间。</p>\n</li>\n<li><p><code>ARGV[3]</code>: 新的空闲时间。</p>\n</li>\n<li><p><code>ARGV[4]</code>: 新缓存项的TTL。</p>\n</li>\n<li><p><code>ARGV[5]</code>: 缓存项的键名。</p>\n</li>\n<li><p><code>ARGV[6]</code>: 缓存项的值。</p>\n</li>\n</ul>\n","cover":false,"excerpt":"","more":"   <figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">local</span> insertable = <span class=\"literal\">false</span>; <span class=\"keyword\">local</span> value = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">if</span> value == <span class=\"literal\">false</span> <span class=\"keyword\">then</span> insertable = <span class=\"literal\">true</span>; <span class=\"keyword\">else</span> <span class=\"keyword\">local</span> t, val = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, value); <span class=\"keyword\">local</span> expireDate = <span class=\"number\">92233720368547758</span>; <span class=\"keyword\">local</span> expireDateScore = redis.call(<span class=\"string\">&#x27;zscore&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">if</span> expireDateScore ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span> expireDate = <span class=\"built_in\">tonumber</span>(expireDateScore) <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> t ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span> <span class=\"keyword\">local</span> expireIdle = redis.call(<span class=\"string\">&#x27;zscore&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">if</span> expireIdle ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span> expireDate = <span class=\"built_in\">math</span>.<span class=\"built_in\">min</span>(expireDate, <span class=\"built_in\">tonumber</span>(expireIdle)) <span class=\"keyword\">end</span>; <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> expireDate &lt;= <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">1</span>]) <span class=\"keyword\">then</span> insertable = <span class=\"literal\">true</span>; <span class=\"keyword\">end</span>; <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> insertable == <span class=\"literal\">true</span> <span class=\"keyword\">then</span> <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">2</span>]) &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span> redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">else</span> redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">3</span>]) &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span> redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">else</span> redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">end</span>; <span class=\"keyword\">local</span> maxSize = <span class=\"built_in\">tonumber</span>(redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">7</span>], <span class=\"string\">&#x27;max-size&#x27;</span>)); <span class=\"keyword\">if</span> maxSize ~= <span class=\"literal\">nil</span> <span class=\"keyword\">and</span> maxSize ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span>     <span class=\"keyword\">local</span> currentTime = <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">1</span>]);     <span class=\"keyword\">local</span> lastAccessTimeSetName = KEYS[<span class=\"number\">5</span>]; <span class=\"keyword\">local</span> mode = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">7</span>], <span class=\"string\">&#x27;mode&#x27;</span>); <span class=\"keyword\">if</span> mode == <span class=\"literal\">false</span> <span class=\"keyword\">or</span> mode == <span class=\"string\">&#x27;LRU&#x27;</span> <span class=\"keyword\">then</span> redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, lastAccessTimeSetName, currentTime, ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">end</span>;     <span class=\"keyword\">local</span> cacheSize = <span class=\"built_in\">tonumber</span>(redis.call(<span class=\"string\">&#x27;hlen&#x27;</span>, KEYS[<span class=\"number\">1</span>]));     <span class=\"keyword\">if</span> cacheSize &gt;= maxSize <span class=\"keyword\">then</span>         <span class=\"keyword\">local</span> lruItems = redis.call(<span class=\"string\">&#x27;zrange&#x27;</span>, lastAccessTimeSetName, <span class=\"number\">0</span>, cacheSize - maxSize);         <span class=\"keyword\">for</span> index, lruItem <span class=\"keyword\">in</span> <span class=\"built_in\">ipairs</span>(lruItems) <span class=\"keyword\">do</span>             <span class=\"keyword\">if</span> lruItem <span class=\"keyword\">and</span> lruItem ~= ARGV[<span class=\"number\">5</span>] <span class=\"keyword\">then</span>                 <span class=\"keyword\">local</span> lruItemValue = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">1</span>], lruItem);                 redis.call(<span class=\"string\">&#x27;hdel&#x27;</span>, KEYS[<span class=\"number\">1</span>], lruItem);                 redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">2</span>], lruItem);                 redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">3</span>], lruItem);                 redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, lastAccessTimeSetName, lruItem);                 <span class=\"keyword\">if</span> lruItemValue ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span>                 <span class=\"keyword\">local</span> removedChannelName = KEYS[<span class=\"number\">6</span>]; <span class=\"keyword\">local</span> ttl, obj = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, lruItemValue);                    <span class=\"keyword\">local</span> msg = struct.pack(<span class=\"string\">&#x27;Lc0Lc0&#x27;</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(lruItem), lruItem, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(obj), obj);                redis.call(<span class=\"string\">&#x27;publish&#x27;</span>, removedChannelName, msg); <span class=\"keyword\">end</span>;             <span class=\"keyword\">end</span>;         <span class=\"keyword\">end</span>;     <span class=\"keyword\">end</span>; <span class=\"keyword\">if</span> mode == <span class=\"string\">&#x27;LFU&#x27;</span> <span class=\"keyword\">then</span> redis.call(<span class=\"string\">&#x27;zincrby&#x27;</span>, lastAccessTimeSetName, <span class=\"number\">1</span>, ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">end</span>; <span class=\"keyword\">end</span>; <span class=\"keyword\">local</span> val = struct.pack(<span class=\"string\">&#x27;dLc0&#x27;</span>, <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">4</span>]), <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">6</span>]), ARGV[<span class=\"number\">6</span>]); redis.call(<span class=\"string\">&#x27;hset&#x27;</span>, KEYS[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>], val); <span class=\"keyword\">local</span> msg = struct.pack(<span class=\"string\">&#x27;Lc0Lc0&#x27;</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">5</span>]), ARGV[<span class=\"number\">5</span>], <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">6</span>]), ARGV[<span class=\"number\">6</span>]); redis.call(<span class=\"string\">&#x27;publish&#x27;</span>, KEYS[<span class=\"number\">4</span>], msg); <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>; <span class=\"keyword\">else</span> <span class=\"keyword\">local</span> t, val = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, value); redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">3</span>], t + ARGV[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>]); <span class=\"keyword\">return</span> val; <span class=\"keyword\">end</span>; </span><br></pre></td></tr></table></figure>\n\n<p>这段Lua脚本用于Redis缓存的管理和插入操作，主要功能包括：</p>\n<ul>\n<li>判断是否需要插入或更新缓存。</li>\n<li>处理缓存的过期逻辑。</li>\n<li>实现基于LRU（最近最少使用）或LFU（最少使用频率）策略的缓存淘汰。</li>\n<li>在缓存项插入或更新时发布相关消息。</li>\n</ul>\n<p>具体的解读如下：</p>\n<ol>\n<li><p><strong>初始化和获取当前值</strong>：</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">local</span> insertable = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> value = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>])</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>判断当前缓存项是否存在</strong>：</p>\n<ul>\n<li>如果不存在，则设置<code>insertable</code>为<code>true</code>，表示可以插入新的缓存项。</li>\n<li>如果存在，继续判断其过期时间。<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> value == <span class=\"literal\">false</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">    insertable = <span class=\"literal\">true</span> </span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> t, val = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, value)</span><br><span class=\"line\">    <span class=\"keyword\">local</span> expireDate = <span class=\"number\">92233720368547758</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> expireDateScore = redis.call(<span class=\"string\">&#x27;zscore&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">    <span class=\"keyword\">if</span> expireDateScore ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span> expireDate = <span class=\"built_in\">tonumber</span>(expireDateScore) <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> t ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> expireIdle = redis.call(<span class=\"string\">&#x27;zscore&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">        <span class=\"keyword\">if</span> expireIdle ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span> expireDate = <span class=\"built_in\">math</span>.<span class=\"built_in\">min</span>(expireDate, <span class=\"built_in\">tonumber</span>(expireIdle)) <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> expireDate &lt;= <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">1</span>]) <span class=\"keyword\">then</span> insertable = <span class=\"literal\">true</span> <span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>处理可插入的情况</strong>：</p>\n<ul>\n<li>更新或删除过期时间。</li>\n<li>检查缓存大小，并根据LRU或LFU策略进行淘汰。<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> insertable == <span class=\"literal\">true</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">2</span>]) &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">        redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">    <span class=\"keyword\">else</span> </span><br><span class=\"line\">        redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">2</span>], ARGV[<span class=\"number\">5</span>]) </span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">3</span>]) &gt; <span class=\"number\">0</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">        redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">    <span class=\"keyword\">else</span> </span><br><span class=\"line\">        redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">3</span>], ARGV[<span class=\"number\">5</span>]) </span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> maxSize = <span class=\"built_in\">tonumber</span>(redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">7</span>], <span class=\"string\">&#x27;max-size&#x27;</span>))</span><br><span class=\"line\">    <span class=\"keyword\">if</span> maxSize ~= <span class=\"literal\">nil</span> <span class=\"keyword\">and</span> maxSize ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> currentTime = <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">1</span>])</span><br><span class=\"line\">        <span class=\"keyword\">local</span> lastAccessTimeSetName = KEYS[<span class=\"number\">5</span>]</span><br><span class=\"line\">        <span class=\"keyword\">local</span> mode = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">7</span>], <span class=\"string\">&#x27;mode&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> mode == <span class=\"literal\">false</span> <span class=\"keyword\">or</span> mode == <span class=\"string\">&#x27;LRU&#x27;</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">            redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, lastAccessTimeSetName, currentTime, ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">local</span> cacheSize = <span class=\"built_in\">tonumber</span>(redis.call(<span class=\"string\">&#x27;hlen&#x27;</span>, KEYS[<span class=\"number\">1</span>]))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> cacheSize &gt;= maxSize <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"keyword\">local</span> lruItems = redis.call(<span class=\"string\">&#x27;zrange&#x27;</span>, lastAccessTimeSetName, <span class=\"number\">0</span>, cacheSize - maxSize)</span><br><span class=\"line\">            <span class=\"keyword\">for</span> index, lruItem <span class=\"keyword\">in</span> <span class=\"built_in\">ipairs</span>(lruItems) <span class=\"keyword\">do</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> lruItem <span class=\"keyword\">and</span> lruItem ~= ARGV[<span class=\"number\">5</span>] <span class=\"keyword\">then</span></span><br><span class=\"line\">                    <span class=\"keyword\">local</span> lruItemValue = redis.call(<span class=\"string\">&#x27;hget&#x27;</span>, KEYS[<span class=\"number\">1</span>], lruItem)</span><br><span class=\"line\">                    redis.call(<span class=\"string\">&#x27;hdel&#x27;</span>, KEYS[<span class=\"number\">1</span>], lruItem)</span><br><span class=\"line\">                    redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">2</span>], lruItem)</span><br><span class=\"line\">                    redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, KEYS[<span class=\"number\">3</span>], lruItem)</span><br><span class=\"line\">                    redis.call(<span class=\"string\">&#x27;zrem&#x27;</span>, lastAccessTimeSetName, lruItem)</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> lruItemValue ~= <span class=\"literal\">false</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">                        <span class=\"keyword\">local</span> removedChannelName = KEYS[<span class=\"number\">6</span>]</span><br><span class=\"line\">                        <span class=\"keyword\">local</span> ttl, obj = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, lruItemValue)</span><br><span class=\"line\">                        <span class=\"keyword\">local</span> msg = struct.pack(<span class=\"string\">&#x27;Lc0Lc0&#x27;</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(lruItem), lruItem, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(obj), obj)</span><br><span class=\"line\">                        redis.call(<span class=\"string\">&#x27;publish&#x27;</span>, removedChannelName, msg)</span><br><span class=\"line\">                    <span class=\"keyword\">end</span></span><br><span class=\"line\">                <span class=\"keyword\">end</span></span><br><span class=\"line\">            <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mode == <span class=\"string\">&#x27;LFU&#x27;</span> <span class=\"keyword\">then</span> </span><br><span class=\"line\">            redis.call(<span class=\"string\">&#x27;zincrby&#x27;</span>, lastAccessTimeSetName, <span class=\"number\">1</span>, ARGV[<span class=\"number\">5</span>]) </span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> val = struct.pack(<span class=\"string\">&#x27;dLc0&#x27;</span>, <span class=\"built_in\">tonumber</span>(ARGV[<span class=\"number\">4</span>]), <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">6</span>]), ARGV[<span class=\"number\">6</span>])</span><br><span class=\"line\">    redis.call(<span class=\"string\">&#x27;hset&#x27;</span>, KEYS[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>], val)</span><br><span class=\"line\">    <span class=\"keyword\">local</span> msg = struct.pack(<span class=\"string\">&#x27;Lc0Lc0&#x27;</span>, <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">5</span>]), ARGV[<span class=\"number\">5</span>], <span class=\"built_in\">string</span>.<span class=\"built_in\">len</span>(ARGV[<span class=\"number\">6</span>]), ARGV[<span class=\"number\">6</span>])</span><br><span class=\"line\">    redis.call(<span class=\"string\">&#x27;publish&#x27;</span>, KEYS[<span class=\"number\">4</span>], msg)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>处理不可插入的情况</strong>：</p>\n<ul>\n<li>更新过期时间，并返回现有值。<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> </span><br><span class=\"line\">    <span class=\"keyword\">local</span> t, val = struct.<span class=\"built_in\">unpack</span>(<span class=\"string\">&#x27;dLc0&#x27;</span>, value)</span><br><span class=\"line\">    redis.call(<span class=\"string\">&#x27;zadd&#x27;</span>, KEYS[<span class=\"number\">3</span>], t + ARGV[<span class=\"number\">1</span>], ARGV[<span class=\"number\">5</span>])</span><br><span class=\"line\">    <span class=\"keyword\">return</span> val</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"参数和键值解释\"><a href=\"#参数和键值解释\" class=\"headerlink\" title=\"参数和键值解释\"></a>参数和键值解释</h3><ul>\n<li><p><code>KEYS[1]</code>: 哈希表存储缓存项。</p>\n</li>\n<li><p><code>KEYS[2]</code>: 有序集合存储过期时间。</p>\n</li>\n<li><p><code>KEYS[3]</code>: 有序集合存储空闲时间。</p>\n</li>\n<li><p><code>KEYS[4]</code>: 频道名称，用于发布缓存项变更消息。</p>\n</li>\n<li><p><code>KEYS[5]</code>: 有序集合存储最近访问时间（LRU模式）。</p>\n</li>\n<li><p><code>KEYS[6]</code>: 频道名称，用于发布被淘汰的缓存项。</p>\n</li>\n<li><p><code>KEYS[7]</code>: 存储缓存配置（如最大尺寸、模式等）。</p>\n</li>\n<li><p><code>ARGV[1]</code>: 当前时间戳。</p>\n</li>\n<li><p><code>ARGV[2]</code>: 新的过期时间。</p>\n</li>\n<li><p><code>ARGV[3]</code>: 新的空闲时间。</p>\n</li>\n<li><p><code>ARGV[4]</code>: 新缓存项的TTL。</p>\n</li>\n<li><p><code>ARGV[5]</code>: 缓存项的键名。</p>\n</li>\n<li><p><code>ARGV[6]</code>: 缓存项的值。</p>\n</li>\n</ul>\n"},{"title":"交易策略总结","date":"2025-03-14T02:11:15.000Z","_content":"\n\n### 详细解析交易策略\n\n在金融市场交易中，合理的策略能帮助投资者控制风险、提高收益，以下是一些常见的交易策略，适用于不同的市场情况和交易目标。\n\n---\n\n### **1. 灵活的仓位止盈止损管理**\n**概念**：止盈止损是投资者在交易时设置的预定价格点，达到该点时自动平仓，以锁定利润或控制亏损。\n\n**止盈止损的方式**：\n- **根据收益设置止盈止损**：用户设定目标收益金额，系统计算出对应的止盈、止损价格。例如，投资者持有某股票，成本价为100元/股，目标收益为1000元，假设持仓10手（1000股），那么每股需要上涨10元（即110元）才可实现目标收益。\n- **根据收益率设置止盈止损**：用户设定目标收益率，系统反推止盈止损价格。例如，某股票成本价100元/股，用户设定止盈收益率为20%，那么止盈价格为120元。\n- **根据涨跌幅设置止盈止损**：用户设定价格的涨跌幅度，比如某股票当前价格100元，用户设置5%的涨幅为止盈点，10%的跌幅为止损点，则止盈点为105元，止损点为90元。\n- **部分仓位止盈止损**：针对同一仓位设定不同的止盈止损点。例如，用户买入1000股股票，目标收益率100%，可以在涨幅50%时卖出50%锁定利润，剩余部分继续持有。\n\n**应用场景**：\n- **收益翻倍后平仓50%**：例如，100元买入股票，涨到200元后卖掉50%，剩余仓位继续持有，期待更高收益。\n- **平仓后挂网格交易**：当价格达到止盈点后，自动执行网格交易策略，继续利用价格波动获利。\n\n---\n\n### **2. 跟踪委托（Trailing Stop Order）**\n**概念**：跟踪委托是一种动态止盈止损策略，市场价格上涨时调整止盈点，市场价格回落到某个回调幅度后自动触发市价卖出。\n\n**示例**：\n- 某股票当前价格100元，用户设置回调幅度5%。\n- 股票涨至120元，系统调整止盈点到114元（120 - 5%）。\n- 若价格继续上涨，止盈点也随之上移；一旦价格回调5%，在114元自动卖出。\n\n**适用场景**：\n- 捕捉趋势行情，避免因短期回调错过更大收益。\n- 适用于震荡或趋势上涨行情。\n\n---\n\n### **3. 追逐限价单**\n**概念**：一种动态调整限价单的订单类型，系统会根据市场买一或卖一价格不断调整委托价格，直至成交或取消。\n\n**示例**：\n- 某股票当前买一价100元，卖一价101元，投资者希望以最优价格买入，系统设定自动追逐限价单，在买一价调整时随之调整，避免成交价过高。\n\n**适用场景**：\n- 适用于高波动市场，确保订单快速成交且价格合理。\n\n---\n\n### **4. 移动止盈止损**\n**概念**：类似于跟踪委托，通常用于平仓，但也可以用于开仓，逻辑类似于追逐限价单。\n\n**适用场景**：\n- 适用于趋势市场，在上涨过程中逐步调整止盈点，确保利润最大化。\n\n---\n\n### **5. 分段订单（Scaled Order）**\n**概念**：在一定价格范围内自动生成多个限价单，将大单拆分成小单执行，避免对市场造成冲击。\n\n**示例**：\n- 用户希望在100~105元之间买入10000股股票，可以分成5个订单，每个价格间隔1元，每次买入2000股，降低市场冲击。\n\n**适用场景**：\n- 适用于资金量较大的投资者，减少交易影响，提高成交率。\n\n---\n\n### **6. 分时委托**\n**概念**：将大单拆分成多个小单，在固定时间间隔内执行，以市价成交，直至订单完成。\n\n**示例**：\n- 用户计划买入10万股股票，不想一次性成交导致价格剧烈波动，设置分时委托，每5分钟成交2000股。\n\n**适用场景**：\n- 适用于执行大额交易，减少市场冲击，提高成交均价的稳定性。\n\n---\n\n### **7. 冰山委托**\n**概念**：将大单拆分成多个小单，仅部分委托单对外可见，其余部分隐藏，防止市场发现大额买卖意图。\n\n**示例**：\n- 用户计划卖出10万股，但市场深度不足，一次性挂单会影响价格。因此，用户设置冰山委托，每次只显示1000股，系统在成交后自动挂出下一笔订单。\n\n**适用场景**：\n- 适用于大额交易，防止市场操纵，提高成交效率。\n\n---\n\n### **8. 网格交易**\n**概念**：通过设置多个价格区间（网格），在不同价位自动进行买入卖出，适用于震荡市场。\n\n**示例**：\n- 用户设定价格区间90~110元，每隔2元设置买入和卖出订单：\n    - 90元买入，92元卖出\n    - 92元买入，94元卖出\n    - 依次类推\n\n**适用场景**：\n- 适用于震荡市场，不需要预测市场方向，利用波动获利。\n\n---\n\n### **9. 马丁格尔交易**\n**概念**：逆势加仓策略，每次亏损后加倍投入资金，以期在价格反弹时弥补亏损并盈利。\n\n**示例**：\n- 用户在100元买入1手，跌至95元亏损时，再买入2手，跌至90元亏损时，再买入4手，最终价格反弹到95元，整体实现盈利。\n\n**风险提示**：\n- 若市场持续单边下跌，仓位会指数级增长，可能导致资金耗尽。\n\n**适用场景**：\n- 适用于短期回调市场，不适合长期单边市场。\n\n---\n\n### **10. 周期策略**\n**概念**：根据市场周期设置交易策略，分为短周期（日内策略）和长周期（日间策略）。\n\n**示例**：\n- 日内交易者可以设定每小时自动平仓，避免持仓过夜风险。\n- 长周期交易者可以基于技术指标，如均线、MACD等，设定每周执行一次交易。\n\n**适用场景**：\n- 适用于不同交易风格的投资者，根据市场节奏进行交易。\n\n---\n\n### **总结**\n不同的交易策略适用于不同的市场环境和交易需求，投资者可以结合自身资金管理和风险偏好，选择合适的策略进行交易。例如：\n- **稳健投资者**：可以选择“灵活止盈止损+分段订单”策略，控制风险并降低市场冲击。\n- **趋势交易者**：可以使用“跟踪委托+移动止盈止损”策略，最大化趋势收益。\n- **高频交易者**：可以使用“追逐限价单+网格交易”策略，提高交易频率和收益。\n\n选择合适的策略，可以在不同市场条件下提高收益、降低风险，实现长期稳定盈利。","source":"_posts/交易/交易策略总结.md","raw":"---\ntitle: 交易策略总结\ndate: 2025-03-14 10:11:15\ncategories: 交易\ntag: 交易策略\n---\n\n\n### 详细解析交易策略\n\n在金融市场交易中，合理的策略能帮助投资者控制风险、提高收益，以下是一些常见的交易策略，适用于不同的市场情况和交易目标。\n\n---\n\n### **1. 灵活的仓位止盈止损管理**\n**概念**：止盈止损是投资者在交易时设置的预定价格点，达到该点时自动平仓，以锁定利润或控制亏损。\n\n**止盈止损的方式**：\n- **根据收益设置止盈止损**：用户设定目标收益金额，系统计算出对应的止盈、止损价格。例如，投资者持有某股票，成本价为100元/股，目标收益为1000元，假设持仓10手（1000股），那么每股需要上涨10元（即110元）才可实现目标收益。\n- **根据收益率设置止盈止损**：用户设定目标收益率，系统反推止盈止损价格。例如，某股票成本价100元/股，用户设定止盈收益率为20%，那么止盈价格为120元。\n- **根据涨跌幅设置止盈止损**：用户设定价格的涨跌幅度，比如某股票当前价格100元，用户设置5%的涨幅为止盈点，10%的跌幅为止损点，则止盈点为105元，止损点为90元。\n- **部分仓位止盈止损**：针对同一仓位设定不同的止盈止损点。例如，用户买入1000股股票，目标收益率100%，可以在涨幅50%时卖出50%锁定利润，剩余部分继续持有。\n\n**应用场景**：\n- **收益翻倍后平仓50%**：例如，100元买入股票，涨到200元后卖掉50%，剩余仓位继续持有，期待更高收益。\n- **平仓后挂网格交易**：当价格达到止盈点后，自动执行网格交易策略，继续利用价格波动获利。\n\n---\n\n### **2. 跟踪委托（Trailing Stop Order）**\n**概念**：跟踪委托是一种动态止盈止损策略，市场价格上涨时调整止盈点，市场价格回落到某个回调幅度后自动触发市价卖出。\n\n**示例**：\n- 某股票当前价格100元，用户设置回调幅度5%。\n- 股票涨至120元，系统调整止盈点到114元（120 - 5%）。\n- 若价格继续上涨，止盈点也随之上移；一旦价格回调5%，在114元自动卖出。\n\n**适用场景**：\n- 捕捉趋势行情，避免因短期回调错过更大收益。\n- 适用于震荡或趋势上涨行情。\n\n---\n\n### **3. 追逐限价单**\n**概念**：一种动态调整限价单的订单类型，系统会根据市场买一或卖一价格不断调整委托价格，直至成交或取消。\n\n**示例**：\n- 某股票当前买一价100元，卖一价101元，投资者希望以最优价格买入，系统设定自动追逐限价单，在买一价调整时随之调整，避免成交价过高。\n\n**适用场景**：\n- 适用于高波动市场，确保订单快速成交且价格合理。\n\n---\n\n### **4. 移动止盈止损**\n**概念**：类似于跟踪委托，通常用于平仓，但也可以用于开仓，逻辑类似于追逐限价单。\n\n**适用场景**：\n- 适用于趋势市场，在上涨过程中逐步调整止盈点，确保利润最大化。\n\n---\n\n### **5. 分段订单（Scaled Order）**\n**概念**：在一定价格范围内自动生成多个限价单，将大单拆分成小单执行，避免对市场造成冲击。\n\n**示例**：\n- 用户希望在100~105元之间买入10000股股票，可以分成5个订单，每个价格间隔1元，每次买入2000股，降低市场冲击。\n\n**适用场景**：\n- 适用于资金量较大的投资者，减少交易影响，提高成交率。\n\n---\n\n### **6. 分时委托**\n**概念**：将大单拆分成多个小单，在固定时间间隔内执行，以市价成交，直至订单完成。\n\n**示例**：\n- 用户计划买入10万股股票，不想一次性成交导致价格剧烈波动，设置分时委托，每5分钟成交2000股。\n\n**适用场景**：\n- 适用于执行大额交易，减少市场冲击，提高成交均价的稳定性。\n\n---\n\n### **7. 冰山委托**\n**概念**：将大单拆分成多个小单，仅部分委托单对外可见，其余部分隐藏，防止市场发现大额买卖意图。\n\n**示例**：\n- 用户计划卖出10万股，但市场深度不足，一次性挂单会影响价格。因此，用户设置冰山委托，每次只显示1000股，系统在成交后自动挂出下一笔订单。\n\n**适用场景**：\n- 适用于大额交易，防止市场操纵，提高成交效率。\n\n---\n\n### **8. 网格交易**\n**概念**：通过设置多个价格区间（网格），在不同价位自动进行买入卖出，适用于震荡市场。\n\n**示例**：\n- 用户设定价格区间90~110元，每隔2元设置买入和卖出订单：\n    - 90元买入，92元卖出\n    - 92元买入，94元卖出\n    - 依次类推\n\n**适用场景**：\n- 适用于震荡市场，不需要预测市场方向，利用波动获利。\n\n---\n\n### **9. 马丁格尔交易**\n**概念**：逆势加仓策略，每次亏损后加倍投入资金，以期在价格反弹时弥补亏损并盈利。\n\n**示例**：\n- 用户在100元买入1手，跌至95元亏损时，再买入2手，跌至90元亏损时，再买入4手，最终价格反弹到95元，整体实现盈利。\n\n**风险提示**：\n- 若市场持续单边下跌，仓位会指数级增长，可能导致资金耗尽。\n\n**适用场景**：\n- 适用于短期回调市场，不适合长期单边市场。\n\n---\n\n### **10. 周期策略**\n**概念**：根据市场周期设置交易策略，分为短周期（日内策略）和长周期（日间策略）。\n\n**示例**：\n- 日内交易者可以设定每小时自动平仓，避免持仓过夜风险。\n- 长周期交易者可以基于技术指标，如均线、MACD等，设定每周执行一次交易。\n\n**适用场景**：\n- 适用于不同交易风格的投资者，根据市场节奏进行交易。\n\n---\n\n### **总结**\n不同的交易策略适用于不同的市场环境和交易需求，投资者可以结合自身资金管理和风险偏好，选择合适的策略进行交易。例如：\n- **稳健投资者**：可以选择“灵活止盈止损+分段订单”策略，控制风险并降低市场冲击。\n- **趋势交易者**：可以使用“跟踪委托+移动止盈止损”策略，最大化趋势收益。\n- **高频交易者**：可以使用“追逐限价单+网格交易”策略，提高交易频率和收益。\n\n选择合适的策略，可以在不同市场条件下提高收益、降低风险，实现长期稳定盈利。","slug":"交易/交易策略总结","published":1,"updated":"2025-03-14T02:30:10.758Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul90003uujz373ab4rfb","content":"<h3 id=\"详细解析交易策略\"><a href=\"#详细解析交易策略\" class=\"headerlink\" title=\"详细解析交易策略\"></a>详细解析交易策略</h3><p>在金融市场交易中，合理的策略能帮助投资者控制风险、提高收益，以下是一些常见的交易策略，适用于不同的市场情况和交易目标。</p>\n<hr>\n<h3 id=\"1-灵活的仓位止盈止损管理\"><a href=\"#1-灵活的仓位止盈止损管理\" class=\"headerlink\" title=\"1. 灵活的仓位止盈止损管理\"></a><strong>1. 灵活的仓位止盈止损管理</strong></h3><p><strong>概念</strong>：止盈止损是投资者在交易时设置的预定价格点，达到该点时自动平仓，以锁定利润或控制亏损。</p>\n<p><strong>止盈止损的方式</strong>：</p>\n<ul>\n<li><strong>根据收益设置止盈止损</strong>：用户设定目标收益金额，系统计算出对应的止盈、止损价格。例如，投资者持有某股票，成本价为100元&#x2F;股，目标收益为1000元，假设持仓10手（1000股），那么每股需要上涨10元（即110元）才可实现目标收益。</li>\n<li><strong>根据收益率设置止盈止损</strong>：用户设定目标收益率，系统反推止盈止损价格。例如，某股票成本价100元&#x2F;股，用户设定止盈收益率为20%，那么止盈价格为120元。</li>\n<li><strong>根据涨跌幅设置止盈止损</strong>：用户设定价格的涨跌幅度，比如某股票当前价格100元，用户设置5%的涨幅为止盈点，10%的跌幅为止损点，则止盈点为105元，止损点为90元。</li>\n<li><strong>部分仓位止盈止损</strong>：针对同一仓位设定不同的止盈止损点。例如，用户买入1000股股票，目标收益率100%，可以在涨幅50%时卖出50%锁定利润，剩余部分继续持有。</li>\n</ul>\n<p><strong>应用场景</strong>：</p>\n<ul>\n<li>**收益翻倍后平仓50%**：例如，100元买入股票，涨到200元后卖掉50%，剩余仓位继续持有，期待更高收益。</li>\n<li><strong>平仓后挂网格交易</strong>：当价格达到止盈点后，自动执行网格交易策略，继续利用价格波动获利。</li>\n</ul>\n<hr>\n<h3 id=\"2-跟踪委托（Trailing-Stop-Order）\"><a href=\"#2-跟踪委托（Trailing-Stop-Order）\" class=\"headerlink\" title=\"2. 跟踪委托（Trailing Stop Order）\"></a><strong>2. 跟踪委托（Trailing Stop Order）</strong></h3><p><strong>概念</strong>：跟踪委托是一种动态止盈止损策略，市场价格上涨时调整止盈点，市场价格回落到某个回调幅度后自动触发市价卖出。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>某股票当前价格100元，用户设置回调幅度5%。</li>\n<li>股票涨至120元，系统调整止盈点到114元（120 - 5%）。</li>\n<li>若价格继续上涨，止盈点也随之上移；一旦价格回调5%，在114元自动卖出。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>捕捉趋势行情，避免因短期回调错过更大收益。</li>\n<li>适用于震荡或趋势上涨行情。</li>\n</ul>\n<hr>\n<h3 id=\"3-追逐限价单\"><a href=\"#3-追逐限价单\" class=\"headerlink\" title=\"3. 追逐限价单\"></a><strong>3. 追逐限价单</strong></h3><p><strong>概念</strong>：一种动态调整限价单的订单类型，系统会根据市场买一或卖一价格不断调整委托价格，直至成交或取消。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>某股票当前买一价100元，卖一价101元，投资者希望以最优价格买入，系统设定自动追逐限价单，在买一价调整时随之调整，避免成交价过高。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于高波动市场，确保订单快速成交且价格合理。</li>\n</ul>\n<hr>\n<h3 id=\"4-移动止盈止损\"><a href=\"#4-移动止盈止损\" class=\"headerlink\" title=\"4. 移动止盈止损\"></a><strong>4. 移动止盈止损</strong></h3><p><strong>概念</strong>：类似于跟踪委托，通常用于平仓，但也可以用于开仓，逻辑类似于追逐限价单。</p>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于趋势市场，在上涨过程中逐步调整止盈点，确保利润最大化。</li>\n</ul>\n<hr>\n<h3 id=\"5-分段订单（Scaled-Order）\"><a href=\"#5-分段订单（Scaled-Order）\" class=\"headerlink\" title=\"5. 分段订单（Scaled Order）\"></a><strong>5. 分段订单（Scaled Order）</strong></h3><p><strong>概念</strong>：在一定价格范围内自动生成多个限价单，将大单拆分成小单执行，避免对市场造成冲击。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户希望在100~105元之间买入10000股股票，可以分成5个订单，每个价格间隔1元，每次买入2000股，降低市场冲击。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于资金量较大的投资者，减少交易影响，提高成交率。</li>\n</ul>\n<hr>\n<h3 id=\"6-分时委托\"><a href=\"#6-分时委托\" class=\"headerlink\" title=\"6. 分时委托\"></a><strong>6. 分时委托</strong></h3><p><strong>概念</strong>：将大单拆分成多个小单，在固定时间间隔内执行，以市价成交，直至订单完成。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户计划买入10万股股票，不想一次性成交导致价格剧烈波动，设置分时委托，每5分钟成交2000股。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于执行大额交易，减少市场冲击，提高成交均价的稳定性。</li>\n</ul>\n<hr>\n<h3 id=\"7-冰山委托\"><a href=\"#7-冰山委托\" class=\"headerlink\" title=\"7. 冰山委托\"></a><strong>7. 冰山委托</strong></h3><p><strong>概念</strong>：将大单拆分成多个小单，仅部分委托单对外可见，其余部分隐藏，防止市场发现大额买卖意图。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户计划卖出10万股，但市场深度不足，一次性挂单会影响价格。因此，用户设置冰山委托，每次只显示1000股，系统在成交后自动挂出下一笔订单。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于大额交易，防止市场操纵，提高成交效率。</li>\n</ul>\n<hr>\n<h3 id=\"8-网格交易\"><a href=\"#8-网格交易\" class=\"headerlink\" title=\"8. 网格交易\"></a><strong>8. 网格交易</strong></h3><p><strong>概念</strong>：通过设置多个价格区间（网格），在不同价位自动进行买入卖出，适用于震荡市场。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户设定价格区间90~110元，每隔2元设置买入和卖出订单：<ul>\n<li>90元买入，92元卖出</li>\n<li>92元买入，94元卖出</li>\n<li>依次类推</li>\n</ul>\n</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于震荡市场，不需要预测市场方向，利用波动获利。</li>\n</ul>\n<hr>\n<h3 id=\"9-马丁格尔交易\"><a href=\"#9-马丁格尔交易\" class=\"headerlink\" title=\"9. 马丁格尔交易\"></a><strong>9. 马丁格尔交易</strong></h3><p><strong>概念</strong>：逆势加仓策略，每次亏损后加倍投入资金，以期在价格反弹时弥补亏损并盈利。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户在100元买入1手，跌至95元亏损时，再买入2手，跌至90元亏损时，再买入4手，最终价格反弹到95元，整体实现盈利。</li>\n</ul>\n<p><strong>风险提示</strong>：</p>\n<ul>\n<li>若市场持续单边下跌，仓位会指数级增长，可能导致资金耗尽。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于短期回调市场，不适合长期单边市场。</li>\n</ul>\n<hr>\n<h3 id=\"10-周期策略\"><a href=\"#10-周期策略\" class=\"headerlink\" title=\"10. 周期策略\"></a><strong>10. 周期策略</strong></h3><p><strong>概念</strong>：根据市场周期设置交易策略，分为短周期（日内策略）和长周期（日间策略）。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>日内交易者可以设定每小时自动平仓，避免持仓过夜风险。</li>\n<li>长周期交易者可以基于技术指标，如均线、MACD等，设定每周执行一次交易。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于不同交易风格的投资者，根据市场节奏进行交易。</li>\n</ul>\n<hr>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a><strong>总结</strong></h3><p>不同的交易策略适用于不同的市场环境和交易需求，投资者可以结合自身资金管理和风险偏好，选择合适的策略进行交易。例如：</p>\n<ul>\n<li><strong>稳健投资者</strong>：可以选择“灵活止盈止损+分段订单”策略，控制风险并降低市场冲击。</li>\n<li><strong>趋势交易者</strong>：可以使用“跟踪委托+移动止盈止损”策略，最大化趋势收益。</li>\n<li><strong>高频交易者</strong>：可以使用“追逐限价单+网格交易”策略，提高交易频率和收益。</li>\n</ul>\n<p>选择合适的策略，可以在不同市场条件下提高收益、降低风险，实现长期稳定盈利。</p>\n","cover":false,"excerpt":"","more":"<h3 id=\"详细解析交易策略\"><a href=\"#详细解析交易策略\" class=\"headerlink\" title=\"详细解析交易策略\"></a>详细解析交易策略</h3><p>在金融市场交易中，合理的策略能帮助投资者控制风险、提高收益，以下是一些常见的交易策略，适用于不同的市场情况和交易目标。</p>\n<hr>\n<h3 id=\"1-灵活的仓位止盈止损管理\"><a href=\"#1-灵活的仓位止盈止损管理\" class=\"headerlink\" title=\"1. 灵活的仓位止盈止损管理\"></a><strong>1. 灵活的仓位止盈止损管理</strong></h3><p><strong>概念</strong>：止盈止损是投资者在交易时设置的预定价格点，达到该点时自动平仓，以锁定利润或控制亏损。</p>\n<p><strong>止盈止损的方式</strong>：</p>\n<ul>\n<li><strong>根据收益设置止盈止损</strong>：用户设定目标收益金额，系统计算出对应的止盈、止损价格。例如，投资者持有某股票，成本价为100元&#x2F;股，目标收益为1000元，假设持仓10手（1000股），那么每股需要上涨10元（即110元）才可实现目标收益。</li>\n<li><strong>根据收益率设置止盈止损</strong>：用户设定目标收益率，系统反推止盈止损价格。例如，某股票成本价100元&#x2F;股，用户设定止盈收益率为20%，那么止盈价格为120元。</li>\n<li><strong>根据涨跌幅设置止盈止损</strong>：用户设定价格的涨跌幅度，比如某股票当前价格100元，用户设置5%的涨幅为止盈点，10%的跌幅为止损点，则止盈点为105元，止损点为90元。</li>\n<li><strong>部分仓位止盈止损</strong>：针对同一仓位设定不同的止盈止损点。例如，用户买入1000股股票，目标收益率100%，可以在涨幅50%时卖出50%锁定利润，剩余部分继续持有。</li>\n</ul>\n<p><strong>应用场景</strong>：</p>\n<ul>\n<li>**收益翻倍后平仓50%**：例如，100元买入股票，涨到200元后卖掉50%，剩余仓位继续持有，期待更高收益。</li>\n<li><strong>平仓后挂网格交易</strong>：当价格达到止盈点后，自动执行网格交易策略，继续利用价格波动获利。</li>\n</ul>\n<hr>\n<h3 id=\"2-跟踪委托（Trailing-Stop-Order）\"><a href=\"#2-跟踪委托（Trailing-Stop-Order）\" class=\"headerlink\" title=\"2. 跟踪委托（Trailing Stop Order）\"></a><strong>2. 跟踪委托（Trailing Stop Order）</strong></h3><p><strong>概念</strong>：跟踪委托是一种动态止盈止损策略，市场价格上涨时调整止盈点，市场价格回落到某个回调幅度后自动触发市价卖出。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>某股票当前价格100元，用户设置回调幅度5%。</li>\n<li>股票涨至120元，系统调整止盈点到114元（120 - 5%）。</li>\n<li>若价格继续上涨，止盈点也随之上移；一旦价格回调5%，在114元自动卖出。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>捕捉趋势行情，避免因短期回调错过更大收益。</li>\n<li>适用于震荡或趋势上涨行情。</li>\n</ul>\n<hr>\n<h3 id=\"3-追逐限价单\"><a href=\"#3-追逐限价单\" class=\"headerlink\" title=\"3. 追逐限价单\"></a><strong>3. 追逐限价单</strong></h3><p><strong>概念</strong>：一种动态调整限价单的订单类型，系统会根据市场买一或卖一价格不断调整委托价格，直至成交或取消。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>某股票当前买一价100元，卖一价101元，投资者希望以最优价格买入，系统设定自动追逐限价单，在买一价调整时随之调整，避免成交价过高。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于高波动市场，确保订单快速成交且价格合理。</li>\n</ul>\n<hr>\n<h3 id=\"4-移动止盈止损\"><a href=\"#4-移动止盈止损\" class=\"headerlink\" title=\"4. 移动止盈止损\"></a><strong>4. 移动止盈止损</strong></h3><p><strong>概念</strong>：类似于跟踪委托，通常用于平仓，但也可以用于开仓，逻辑类似于追逐限价单。</p>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于趋势市场，在上涨过程中逐步调整止盈点，确保利润最大化。</li>\n</ul>\n<hr>\n<h3 id=\"5-分段订单（Scaled-Order）\"><a href=\"#5-分段订单（Scaled-Order）\" class=\"headerlink\" title=\"5. 分段订单（Scaled Order）\"></a><strong>5. 分段订单（Scaled Order）</strong></h3><p><strong>概念</strong>：在一定价格范围内自动生成多个限价单，将大单拆分成小单执行，避免对市场造成冲击。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户希望在100~105元之间买入10000股股票，可以分成5个订单，每个价格间隔1元，每次买入2000股，降低市场冲击。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于资金量较大的投资者，减少交易影响，提高成交率。</li>\n</ul>\n<hr>\n<h3 id=\"6-分时委托\"><a href=\"#6-分时委托\" class=\"headerlink\" title=\"6. 分时委托\"></a><strong>6. 分时委托</strong></h3><p><strong>概念</strong>：将大单拆分成多个小单，在固定时间间隔内执行，以市价成交，直至订单完成。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户计划买入10万股股票，不想一次性成交导致价格剧烈波动，设置分时委托，每5分钟成交2000股。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于执行大额交易，减少市场冲击，提高成交均价的稳定性。</li>\n</ul>\n<hr>\n<h3 id=\"7-冰山委托\"><a href=\"#7-冰山委托\" class=\"headerlink\" title=\"7. 冰山委托\"></a><strong>7. 冰山委托</strong></h3><p><strong>概念</strong>：将大单拆分成多个小单，仅部分委托单对外可见，其余部分隐藏，防止市场发现大额买卖意图。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户计划卖出10万股，但市场深度不足，一次性挂单会影响价格。因此，用户设置冰山委托，每次只显示1000股，系统在成交后自动挂出下一笔订单。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于大额交易，防止市场操纵，提高成交效率。</li>\n</ul>\n<hr>\n<h3 id=\"8-网格交易\"><a href=\"#8-网格交易\" class=\"headerlink\" title=\"8. 网格交易\"></a><strong>8. 网格交易</strong></h3><p><strong>概念</strong>：通过设置多个价格区间（网格），在不同价位自动进行买入卖出，适用于震荡市场。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户设定价格区间90~110元，每隔2元设置买入和卖出订单：<ul>\n<li>90元买入，92元卖出</li>\n<li>92元买入，94元卖出</li>\n<li>依次类推</li>\n</ul>\n</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于震荡市场，不需要预测市场方向，利用波动获利。</li>\n</ul>\n<hr>\n<h3 id=\"9-马丁格尔交易\"><a href=\"#9-马丁格尔交易\" class=\"headerlink\" title=\"9. 马丁格尔交易\"></a><strong>9. 马丁格尔交易</strong></h3><p><strong>概念</strong>：逆势加仓策略，每次亏损后加倍投入资金，以期在价格反弹时弥补亏损并盈利。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>用户在100元买入1手，跌至95元亏损时，再买入2手，跌至90元亏损时，再买入4手，最终价格反弹到95元，整体实现盈利。</li>\n</ul>\n<p><strong>风险提示</strong>：</p>\n<ul>\n<li>若市场持续单边下跌，仓位会指数级增长，可能导致资金耗尽。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于短期回调市场，不适合长期单边市场。</li>\n</ul>\n<hr>\n<h3 id=\"10-周期策略\"><a href=\"#10-周期策略\" class=\"headerlink\" title=\"10. 周期策略\"></a><strong>10. 周期策略</strong></h3><p><strong>概念</strong>：根据市场周期设置交易策略，分为短周期（日内策略）和长周期（日间策略）。</p>\n<p><strong>示例</strong>：</p>\n<ul>\n<li>日内交易者可以设定每小时自动平仓，避免持仓过夜风险。</li>\n<li>长周期交易者可以基于技术指标，如均线、MACD等，设定每周执行一次交易。</li>\n</ul>\n<p><strong>适用场景</strong>：</p>\n<ul>\n<li>适用于不同交易风格的投资者，根据市场节奏进行交易。</li>\n</ul>\n<hr>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a><strong>总结</strong></h3><p>不同的交易策略适用于不同的市场环境和交易需求，投资者可以结合自身资金管理和风险偏好，选择合适的策略进行交易。例如：</p>\n<ul>\n<li><strong>稳健投资者</strong>：可以选择“灵活止盈止损+分段订单”策略，控制风险并降低市场冲击。</li>\n<li><strong>趋势交易者</strong>：可以使用“跟踪委托+移动止盈止损”策略，最大化趋势收益。</li>\n<li><strong>高频交易者</strong>：可以使用“追逐限价单+网格交易”策略，提高交易频率和收益。</li>\n</ul>\n<p>选择合适的策略，可以在不同市场条件下提高收益、降低风险，实现长期稳定盈利。</p>\n"},{"title":"spring_state_machine","date":"2024-09-19T08:35:59.000Z","_content":"Spring Statemachine 是一个用于处理复杂状态机的框架，能够帮助你管理和控制状态转换。以下是如何在 Spring Boot 项目中使用 Spring Statemachine 的基本步骤：\n\n### 1. **添加依赖**\n\n首先，在你的 `pom.xml` 文件中添加 Spring Statemachine 依赖：\n\n```xml\n<dependency>\n    <groupId>org.springframework.statemachine</groupId>\n    <artifactId>spring-statemachine-core</artifactId>\n    <version>3.0.0</version> <!-- 或者使用最新版本 -->\n</dependency>\n```\n\n### 2. **定义状态和事件**\n\n在 Spring Statemachine 中，你需要定义状态和事件。这些通常是枚举类型。\n\n```java\npublic enum States {\n    START,\n    PROCESSING,\n    FINISHED,\n    ERROR\n}\n\npublic enum Events {\n    BEGIN,\n    COMPLETE,\n    FAIL\n}\n```\n\n### 3. **配置状态机**\n\n接下来，你需要配置状态机的状态和事件。你可以创建一个配置类来完成这一工作。\n\n```java\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.statemachine.config.EnableStateMachine;\nimport org.springframework.statemachine.config.builders.StateMachineBuilder;\nimport org.springframework.statemachine.config.builders.StateMachineConfigurerAdapter;\nimport org.springframework.statemachine.config.builders.StateMachineStateConfigurer;\nimport org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;\nimport org.springframework.statemachine.config.builders.StateMachineStateConfigurer;\nimport org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;\n\n@Configuration\n@EnableStateMachine\npublic class StateMachineConfig extends StateMachineConfigurerAdapter<States, Events> {\n\n    @Override\n    public void configure(StateMachineStateConfigurer<States, Events> states) throws Exception {\n        states\n            .withStates()\n                .initial(States.START)\n                .state(States.PROCESSING)\n                .state(States.FINISHED)\n                .state(States.ERROR);\n    }\n\n    @Override\n    public void configure(StateMachineTransitionConfigurer<States, Events> transitions) throws Exception {\n        transitions\n            .withExternal()\n                .source(States.START).target(States.PROCESSING).event(Events.BEGIN)\n            .and()\n            .withExternal()\n                .source(States.PROCESSING).target(States.FINISHED).event(Events.COMPLETE)\n            .and()\n            .withExternal()\n                .source(States.PROCESSING).target(States.ERROR).event(Events.FAIL);\n    }\n}\n```\n\n### 4. **使用状态机**\n\n你可以在 Spring 组件中注入状态机并使用它来处理状态转换。\n\n```java\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.statemachine.StateMachine;\nimport org.springframework.statemachine.config.StateMachineFactory;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class StateMachineService {\n\n    @Autowired\n    private StateMachine<States, Events> stateMachine;\n\n    public void startProcess() {\n        stateMachine.sendEvent(Events.BEGIN);\n    }\n\n    public void completeProcess() {\n        stateMachine.sendEvent(Events.COMPLETE);\n    }\n\n    public void failProcess() {\n        stateMachine.sendEvent(Events.FAIL);\n    }\n}\n```\n\n### 5. **运行和测试**\n\n确保你已经启动了 Spring Boot 应用程序，并且在你的服务中调用状态机的方法来触发事件和状态转换。\n\n### 6. **进一步定制**\n\nSpring Statemachine 提供了很多高级功能，比如状态持久化、事件监听器、状态机持久化等。如果你有更多复杂的需求，可以参考 [Spring Statemachine 官方文档](https://docs.spring.io/spring-statemachine/docs/current/reference/html/) 以获取详细的配置信息和示例。\n\n这些是基本的使用步骤，你可以根据实际需要进行更复杂的配置和定制。","source":"_posts/spring-boot/spring-state-machine.md","raw":"---\ntitle: spring_state_machine\ndate: 2024-09-19 16:35:59\ncategories: spring-boot\ntag: 状态机\n---\nSpring Statemachine 是一个用于处理复杂状态机的框架，能够帮助你管理和控制状态转换。以下是如何在 Spring Boot 项目中使用 Spring Statemachine 的基本步骤：\n\n### 1. **添加依赖**\n\n首先，在你的 `pom.xml` 文件中添加 Spring Statemachine 依赖：\n\n```xml\n<dependency>\n    <groupId>org.springframework.statemachine</groupId>\n    <artifactId>spring-statemachine-core</artifactId>\n    <version>3.0.0</version> <!-- 或者使用最新版本 -->\n</dependency>\n```\n\n### 2. **定义状态和事件**\n\n在 Spring Statemachine 中，你需要定义状态和事件。这些通常是枚举类型。\n\n```java\npublic enum States {\n    START,\n    PROCESSING,\n    FINISHED,\n    ERROR\n}\n\npublic enum Events {\n    BEGIN,\n    COMPLETE,\n    FAIL\n}\n```\n\n### 3. **配置状态机**\n\n接下来，你需要配置状态机的状态和事件。你可以创建一个配置类来完成这一工作。\n\n```java\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.statemachine.config.EnableStateMachine;\nimport org.springframework.statemachine.config.builders.StateMachineBuilder;\nimport org.springframework.statemachine.config.builders.StateMachineConfigurerAdapter;\nimport org.springframework.statemachine.config.builders.StateMachineStateConfigurer;\nimport org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;\nimport org.springframework.statemachine.config.builders.StateMachineStateConfigurer;\nimport org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;\n\n@Configuration\n@EnableStateMachine\npublic class StateMachineConfig extends StateMachineConfigurerAdapter<States, Events> {\n\n    @Override\n    public void configure(StateMachineStateConfigurer<States, Events> states) throws Exception {\n        states\n            .withStates()\n                .initial(States.START)\n                .state(States.PROCESSING)\n                .state(States.FINISHED)\n                .state(States.ERROR);\n    }\n\n    @Override\n    public void configure(StateMachineTransitionConfigurer<States, Events> transitions) throws Exception {\n        transitions\n            .withExternal()\n                .source(States.START).target(States.PROCESSING).event(Events.BEGIN)\n            .and()\n            .withExternal()\n                .source(States.PROCESSING).target(States.FINISHED).event(Events.COMPLETE)\n            .and()\n            .withExternal()\n                .source(States.PROCESSING).target(States.ERROR).event(Events.FAIL);\n    }\n}\n```\n\n### 4. **使用状态机**\n\n你可以在 Spring 组件中注入状态机并使用它来处理状态转换。\n\n```java\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.statemachine.StateMachine;\nimport org.springframework.statemachine.config.StateMachineFactory;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class StateMachineService {\n\n    @Autowired\n    private StateMachine<States, Events> stateMachine;\n\n    public void startProcess() {\n        stateMachine.sendEvent(Events.BEGIN);\n    }\n\n    public void completeProcess() {\n        stateMachine.sendEvent(Events.COMPLETE);\n    }\n\n    public void failProcess() {\n        stateMachine.sendEvent(Events.FAIL);\n    }\n}\n```\n\n### 5. **运行和测试**\n\n确保你已经启动了 Spring Boot 应用程序，并且在你的服务中调用状态机的方法来触发事件和状态转换。\n\n### 6. **进一步定制**\n\nSpring Statemachine 提供了很多高级功能，比如状态持久化、事件监听器、状态机持久化等。如果你有更多复杂的需求，可以参考 [Spring Statemachine 官方文档](https://docs.spring.io/spring-statemachine/docs/current/reference/html/) 以获取详细的配置信息和示例。\n\n这些是基本的使用步骤，你可以根据实际需要进行更复杂的配置和定制。","slug":"spring-boot/spring-state-machine","published":1,"updated":"2025-02-18T06:28:00.116Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul90003vujz3cpmn8e7w","content":"<p>Spring Statemachine 是一个用于处理复杂状态机的框架，能够帮助你管理和控制状态转换。以下是如何在 Spring Boot 项目中使用 Spring Statemachine 的基本步骤：</p>\n<h3 id=\"1-添加依赖\"><a href=\"#1-添加依赖\" class=\"headerlink\" title=\"1. 添加依赖\"></a>1. <strong>添加依赖</strong></h3><p>首先，在你的 <code>pom.xml</code> 文件中添加 Spring Statemachine 依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.statemachine<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-statemachine-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.0.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span> <span class=\"comment\">&lt;!-- 或者使用最新版本 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-定义状态和事件\"><a href=\"#2-定义状态和事件\" class=\"headerlink\" title=\"2. 定义状态和事件\"></a>2. <strong>定义状态和事件</strong></h3><p>在 Spring Statemachine 中，你需要定义状态和事件。这些通常是枚举类型。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">enum</span> <span class=\"title class_\">States</span> &#123;</span><br><span class=\"line\">    START,</span><br><span class=\"line\">    PROCESSING,</span><br><span class=\"line\">    FINISHED,</span><br><span class=\"line\">    ERROR</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">enum</span> <span class=\"title class_\">Events</span> &#123;</span><br><span class=\"line\">    BEGIN,</span><br><span class=\"line\">    COMPLETE,</span><br><span class=\"line\">    FAIL</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-配置状态机\"><a href=\"#3-配置状态机\" class=\"headerlink\" title=\"3. 配置状态机\"></a>3. <strong>配置状态机</strong></h3><p>接下来，你需要配置状态机的状态和事件。你可以创建一个配置类来完成这一工作。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.EnableStateMachine;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineConfigurerAdapter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineStateConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineStateConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableStateMachine</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">StateMachineConfig</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">StateMachineConfigurerAdapter</span>&lt;States, Events&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(StateMachineStateConfigurer&lt;States, Events&gt; states)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        states</span><br><span class=\"line\">            .withStates()</span><br><span class=\"line\">                .initial(States.START)</span><br><span class=\"line\">                .state(States.PROCESSING)</span><br><span class=\"line\">                .state(States.FINISHED)</span><br><span class=\"line\">                .state(States.ERROR);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(StateMachineTransitionConfigurer&lt;States, Events&gt; transitions)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        transitions</span><br><span class=\"line\">            .withExternal()</span><br><span class=\"line\">                .source(States.START).target(States.PROCESSING).event(Events.BEGIN)</span><br><span class=\"line\">            .and()</span><br><span class=\"line\">            .withExternal()</span><br><span class=\"line\">                .source(States.PROCESSING).target(States.FINISHED).event(Events.COMPLETE)</span><br><span class=\"line\">            .and()</span><br><span class=\"line\">            .withExternal()</span><br><span class=\"line\">                .source(States.PROCESSING).target(States.ERROR).event(Events.FAIL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-使用状态机\"><a href=\"#4-使用状态机\" class=\"headerlink\" title=\"4. 使用状态机\"></a>4. <strong>使用状态机</strong></h3><p>你可以在 Spring 组件中注入状态机并使用它来处理状态转换。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.StateMachine;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.StateMachineFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Service;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">StateMachineService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> StateMachine&lt;States, Events&gt; stateMachine;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startProcess</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        stateMachine.sendEvent(Events.BEGIN);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">completeProcess</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        stateMachine.sendEvent(Events.COMPLETE);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">failProcess</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        stateMachine.sendEvent(Events.FAIL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-运行和测试\"><a href=\"#5-运行和测试\" class=\"headerlink\" title=\"5. 运行和测试\"></a>5. <strong>运行和测试</strong></h3><p>确保你已经启动了 Spring Boot 应用程序，并且在你的服务中调用状态机的方法来触发事件和状态转换。</p>\n<h3 id=\"6-进一步定制\"><a href=\"#6-进一步定制\" class=\"headerlink\" title=\"6. 进一步定制\"></a>6. <strong>进一步定制</strong></h3><p>Spring Statemachine 提供了很多高级功能，比如状态持久化、事件监听器、状态机持久化等。如果你有更多复杂的需求，可以参考 <a href=\"https://docs.spring.io/spring-statemachine/docs/current/reference/html/\">Spring Statemachine 官方文档</a> 以获取详细的配置信息和示例。</p>\n<p>这些是基本的使用步骤，你可以根据实际需要进行更复杂的配置和定制。</p>\n","cover":false,"excerpt":"","more":"<p>Spring Statemachine 是一个用于处理复杂状态机的框架，能够帮助你管理和控制状态转换。以下是如何在 Spring Boot 项目中使用 Spring Statemachine 的基本步骤：</p>\n<h3 id=\"1-添加依赖\"><a href=\"#1-添加依赖\" class=\"headerlink\" title=\"1. 添加依赖\"></a>1. <strong>添加依赖</strong></h3><p>首先，在你的 <code>pom.xml</code> 文件中添加 Spring Statemachine 依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.statemachine<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-statemachine-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.0.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span> <span class=\"comment\">&lt;!-- 或者使用最新版本 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-定义状态和事件\"><a href=\"#2-定义状态和事件\" class=\"headerlink\" title=\"2. 定义状态和事件\"></a>2. <strong>定义状态和事件</strong></h3><p>在 Spring Statemachine 中，你需要定义状态和事件。这些通常是枚举类型。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">enum</span> <span class=\"title class_\">States</span> &#123;</span><br><span class=\"line\">    START,</span><br><span class=\"line\">    PROCESSING,</span><br><span class=\"line\">    FINISHED,</span><br><span class=\"line\">    ERROR</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">enum</span> <span class=\"title class_\">Events</span> &#123;</span><br><span class=\"line\">    BEGIN,</span><br><span class=\"line\">    COMPLETE,</span><br><span class=\"line\">    FAIL</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-配置状态机\"><a href=\"#3-配置状态机\" class=\"headerlink\" title=\"3. 配置状态机\"></a>3. <strong>配置状态机</strong></h3><p>接下来，你需要配置状态机的状态和事件。你可以创建一个配置类来完成这一工作。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.EnableStateMachine;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineConfigurerAdapter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineStateConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineStateConfigurer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableStateMachine</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">StateMachineConfig</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">StateMachineConfigurerAdapter</span>&lt;States, Events&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(StateMachineStateConfigurer&lt;States, Events&gt; states)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        states</span><br><span class=\"line\">            .withStates()</span><br><span class=\"line\">                .initial(States.START)</span><br><span class=\"line\">                .state(States.PROCESSING)</span><br><span class=\"line\">                .state(States.FINISHED)</span><br><span class=\"line\">                .state(States.ERROR);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configure</span><span class=\"params\">(StateMachineTransitionConfigurer&lt;States, Events&gt; transitions)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        transitions</span><br><span class=\"line\">            .withExternal()</span><br><span class=\"line\">                .source(States.START).target(States.PROCESSING).event(Events.BEGIN)</span><br><span class=\"line\">            .and()</span><br><span class=\"line\">            .withExternal()</span><br><span class=\"line\">                .source(States.PROCESSING).target(States.FINISHED).event(Events.COMPLETE)</span><br><span class=\"line\">            .and()</span><br><span class=\"line\">            .withExternal()</span><br><span class=\"line\">                .source(States.PROCESSING).target(States.ERROR).event(Events.FAIL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-使用状态机\"><a href=\"#4-使用状态机\" class=\"headerlink\" title=\"4. 使用状态机\"></a>4. <strong>使用状态机</strong></h3><p>你可以在 Spring 组件中注入状态机并使用它来处理状态转换。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.StateMachine;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.statemachine.config.StateMachineFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Service;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">StateMachineService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> StateMachine&lt;States, Events&gt; stateMachine;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startProcess</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        stateMachine.sendEvent(Events.BEGIN);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">completeProcess</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        stateMachine.sendEvent(Events.COMPLETE);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">failProcess</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        stateMachine.sendEvent(Events.FAIL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-运行和测试\"><a href=\"#5-运行和测试\" class=\"headerlink\" title=\"5. 运行和测试\"></a>5. <strong>运行和测试</strong></h3><p>确保你已经启动了 Spring Boot 应用程序，并且在你的服务中调用状态机的方法来触发事件和状态转换。</p>\n<h3 id=\"6-进一步定制\"><a href=\"#6-进一步定制\" class=\"headerlink\" title=\"6. 进一步定制\"></a>6. <strong>进一步定制</strong></h3><p>Spring Statemachine 提供了很多高级功能，比如状态持久化、事件监听器、状态机持久化等。如果你有更多复杂的需求，可以参考 <a href=\"https://docs.spring.io/spring-statemachine/docs/current/reference/html/\">Spring Statemachine 官方文档</a> 以获取详细的配置信息和示例。</p>\n<p>这些是基本的使用步骤，你可以根据实际需要进行更复杂的配置和定制。</p>\n"},{"title":"使用切面或拦截器打印异常日志","date":"2024-07-26T09:01:47.000Z","_content":"在Spring Boot中，使用切面（Aspect）或拦截器（Interceptor）来捕获异常并记录日志是一种常见的做法。下面介绍如何使用这两种方式来实现。\n\n### 1. 使用切面（Aspect）记录异常日志\n\nSpring AOP（Aspect-Oriented Programming）允许你定义横切关注点，比如日志记录、事务管理等。可以通过编写一个切面来捕获所有方法中的异常并记录日志。\n\n#### 步骤：\n\n1. **添加依赖**：\n   确保你的项目中包含Spring AOP相关依赖。如果你使用的是Maven，确保`spring-boot-starter-aop`已经在你的`pom.xml`中。\n\n    ```xml\n    <dependency>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-aop</artifactId>\n    </dependency>\n    ```\n\n2. **创建切面类**：\n\n    ```java\n    import org.aspectj.lang.annotation.AfterThrowing;\n    import org.aspectj.lang.annotation.Aspect;\n    import org.springframework.stereotype.Component;\n    import org.slf4j.Logger;\n    import org.slf4j.LoggerFactory;\n\n    @Aspect\n    @Component\n    public class ExceptionLoggingAspect {\n\n        private static final Logger logger = LoggerFactory.getLogger(ExceptionLoggingAspect.class);\n\n        // 定义一个切入点，拦截所有方法\n        @AfterThrowing(pointcut = \"execution(* com.yourpackage..*(..))\", throwing = \"exception\")\n        public void logException(Exception exception) {\n            logger.error(\"Exception caught: \", exception);\n        }\n    }\n    ```\n\n   在上述代码中，`@AfterThrowing`注解用于定义在方法抛出异常后执行的通知。`execution(* com.yourpackage..*(..))`表示拦截`com.yourpackage`包及其子包中所有类的所有方法。\n\n### 2. 使用拦截器（Interceptor）记录异常日志\n\nSpring中的拦截器允许你在HTTP请求处理的各个阶段执行一些操作，可以用来记录异常日志。\n\n#### 步骤：\n\n1. **创建拦截器类**：\n\n    ```java\n    import org.springframework.stereotype.Component;\n    import org.springframework.web.servlet.HandlerInterceptor;\n    import org.springframework.web.servlet.ModelAndView;\n\n    import javax.servlet.http.HttpServletRequest;\n    import javax.servlet.http.HttpServletResponse;\n\n    @Component\n    public class ExceptionLoggingInterceptor implements HandlerInterceptor {\n\n        @Override\n        public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n            return true;\n        }\n\n        @Override\n        public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {\n        }\n\n        @Override\n        public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n            if (ex != null) {\n                // 记录异常日志\n                Logger logger = LoggerFactory.getLogger(handler.getClass());\n                logger.error(\"Exception caught during request processing: \", ex);\n            }\n        }\n    }\n    ```\n\n2. **注册拦截器**：\n\n   在Spring Boot应用中，通过配置类注册拦截器。\n\n    ```java\n    import org.springframework.beans.factory.annotation.Autowired;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.web.servlet.config.annotation.InterceptorRegistry;\n    import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n\n    @Configuration\n    public class WebConfig implements WebMvcConfigurer {\n\n        @Autowired\n        private ExceptionLoggingInterceptor exceptionLoggingInterceptor;\n\n        @Override\n        public void addInterceptors(InterceptorRegistry registry) {\n            registry.addInterceptor(exceptionLoggingInterceptor);\n        }\n    }\n    ```\n\n### 总结\n\n这两种方式各有优劣：\n\n- **切面（Aspect）**适用于需要在方法级别捕获异常的情况，可以轻松应用于所有方法。\n- **拦截器（Interceptor）**适用于需要在请求级别捕获异常的情况，更适合Web应用程序中的HTTP请求处理。\n\n选择哪种方式取决于你的具体需求。如果你希望对所有方法的异常进行统一处理，切面可能更合适；如果你需要对HTTP请求处理的异常进行统一处理，拦截器则更为合适。","source":"_posts/spring-boot/使用切面或拦截器打印异常日志.md","raw":"---\ntitle: 使用切面或拦截器打印异常日志\ndate: 2024-07-26 17:01:47\ncategories: spring-boot\ntag: 打印异常日志\n---\n在Spring Boot中，使用切面（Aspect）或拦截器（Interceptor）来捕获异常并记录日志是一种常见的做法。下面介绍如何使用这两种方式来实现。\n\n### 1. 使用切面（Aspect）记录异常日志\n\nSpring AOP（Aspect-Oriented Programming）允许你定义横切关注点，比如日志记录、事务管理等。可以通过编写一个切面来捕获所有方法中的异常并记录日志。\n\n#### 步骤：\n\n1. **添加依赖**：\n   确保你的项目中包含Spring AOP相关依赖。如果你使用的是Maven，确保`spring-boot-starter-aop`已经在你的`pom.xml`中。\n\n    ```xml\n    <dependency>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-aop</artifactId>\n    </dependency>\n    ```\n\n2. **创建切面类**：\n\n    ```java\n    import org.aspectj.lang.annotation.AfterThrowing;\n    import org.aspectj.lang.annotation.Aspect;\n    import org.springframework.stereotype.Component;\n    import org.slf4j.Logger;\n    import org.slf4j.LoggerFactory;\n\n    @Aspect\n    @Component\n    public class ExceptionLoggingAspect {\n\n        private static final Logger logger = LoggerFactory.getLogger(ExceptionLoggingAspect.class);\n\n        // 定义一个切入点，拦截所有方法\n        @AfterThrowing(pointcut = \"execution(* com.yourpackage..*(..))\", throwing = \"exception\")\n        public void logException(Exception exception) {\n            logger.error(\"Exception caught: \", exception);\n        }\n    }\n    ```\n\n   在上述代码中，`@AfterThrowing`注解用于定义在方法抛出异常后执行的通知。`execution(* com.yourpackage..*(..))`表示拦截`com.yourpackage`包及其子包中所有类的所有方法。\n\n### 2. 使用拦截器（Interceptor）记录异常日志\n\nSpring中的拦截器允许你在HTTP请求处理的各个阶段执行一些操作，可以用来记录异常日志。\n\n#### 步骤：\n\n1. **创建拦截器类**：\n\n    ```java\n    import org.springframework.stereotype.Component;\n    import org.springframework.web.servlet.HandlerInterceptor;\n    import org.springframework.web.servlet.ModelAndView;\n\n    import javax.servlet.http.HttpServletRequest;\n    import javax.servlet.http.HttpServletResponse;\n\n    @Component\n    public class ExceptionLoggingInterceptor implements HandlerInterceptor {\n\n        @Override\n        public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n            return true;\n        }\n\n        @Override\n        public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {\n        }\n\n        @Override\n        public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n            if (ex != null) {\n                // 记录异常日志\n                Logger logger = LoggerFactory.getLogger(handler.getClass());\n                logger.error(\"Exception caught during request processing: \", ex);\n            }\n        }\n    }\n    ```\n\n2. **注册拦截器**：\n\n   在Spring Boot应用中，通过配置类注册拦截器。\n\n    ```java\n    import org.springframework.beans.factory.annotation.Autowired;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.web.servlet.config.annotation.InterceptorRegistry;\n    import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n\n    @Configuration\n    public class WebConfig implements WebMvcConfigurer {\n\n        @Autowired\n        private ExceptionLoggingInterceptor exceptionLoggingInterceptor;\n\n        @Override\n        public void addInterceptors(InterceptorRegistry registry) {\n            registry.addInterceptor(exceptionLoggingInterceptor);\n        }\n    }\n    ```\n\n### 总结\n\n这两种方式各有优劣：\n\n- **切面（Aspect）**适用于需要在方法级别捕获异常的情况，可以轻松应用于所有方法。\n- **拦截器（Interceptor）**适用于需要在请求级别捕获异常的情况，更适合Web应用程序中的HTTP请求处理。\n\n选择哪种方式取决于你的具体需求。如果你希望对所有方法的异常进行统一处理，切面可能更合适；如果你需要对HTTP请求处理的异常进行统一处理，拦截器则更为合适。","slug":"spring-boot/使用切面或拦截器打印异常日志","published":1,"updated":"2025-02-18T06:26:47.387Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul90003wujz36e4f1jpn","content":"<p>在Spring Boot中，使用切面（Aspect）或拦截器（Interceptor）来捕获异常并记录日志是一种常见的做法。下面介绍如何使用这两种方式来实现。</p>\n<h3 id=\"1-使用切面（Aspect）记录异常日志\"><a href=\"#1-使用切面（Aspect）记录异常日志\" class=\"headerlink\" title=\"1. 使用切面（Aspect）记录异常日志\"></a>1. 使用切面（Aspect）记录异常日志</h3><p>Spring AOP（Aspect-Oriented Programming）允许你定义横切关注点，比如日志记录、事务管理等。可以通过编写一个切面来捕获所有方法中的异常并记录日志。</p>\n<h4 id=\"步骤：\"><a href=\"#步骤：\" class=\"headerlink\" title=\"步骤：\"></a>步骤：</h4><ol>\n<li><p><strong>添加依赖</strong>：<br>确保你的项目中包含Spring AOP相关依赖。如果你使用的是Maven，确保<code>spring-boot-starter-aop</code>已经在你的<code>pom.xml</code>中。</p>\n <figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-aop<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>创建切面类</strong>：</p>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.AfterThrowing;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.Logger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Aspect</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ExceptionLoggingAspect</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(ExceptionLoggingAspect.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 定义一个切入点，拦截所有方法</span></span><br><span class=\"line\">    <span class=\"meta\">@AfterThrowing(pointcut = &quot;execution(* com.yourpackage..*(..))&quot;, throwing = &quot;exception&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">logException</span><span class=\"params\">(Exception exception)</span> &#123;</span><br><span class=\"line\">        logger.error(<span class=\"string\">&quot;Exception caught: &quot;</span>, exception);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在上述代码中，<code>@AfterThrowing</code>注解用于定义在方法抛出异常后执行的通知。<code>execution(* com.yourpackage..*(..))</code>表示拦截<code>com.yourpackage</code>包及其子包中所有类的所有方法。</p>\n</li>\n</ol>\n<h3 id=\"2-使用拦截器（Interceptor）记录异常日志\"><a href=\"#2-使用拦截器（Interceptor）记录异常日志\" class=\"headerlink\" title=\"2. 使用拦截器（Interceptor）记录异常日志\"></a>2. 使用拦截器（Interceptor）记录异常日志</h3><p>Spring中的拦截器允许你在HTTP请求处理的各个阶段执行一些操作，可以用来记录异常日志。</p>\n<h4 id=\"步骤：-1\"><a href=\"#步骤：-1\" class=\"headerlink\" title=\"步骤：\"></a>步骤：</h4><ol>\n<li><p><strong>创建拦截器类</strong>：</p>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ExceptionLoggingInterceptor</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">HandlerInterceptor</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">preHandle</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">postHandle</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">afterCompletion</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ex != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 记录异常日志</span></span><br><span class=\"line\">            <span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(handler.getClass());</span><br><span class=\"line\">            logger.error(<span class=\"string\">&quot;Exception caught during request processing: &quot;</span>, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>注册拦截器</strong>：</p>\n<p>在Spring Boot应用中，通过配置类注册拦截器。</p>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">WebConfig</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">WebMvcConfigurer</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ExceptionLoggingInterceptor exceptionLoggingInterceptor;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addInterceptors</span><span class=\"params\">(InterceptorRegistry registry)</span> &#123;</span><br><span class=\"line\">        registry.addInterceptor(exceptionLoggingInterceptor);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这两种方式各有优劣：</p>\n<ul>\n<li><strong>切面（Aspect）</strong>适用于需要在方法级别捕获异常的情况，可以轻松应用于所有方法。</li>\n<li><strong>拦截器（Interceptor）</strong>适用于需要在请求级别捕获异常的情况，更适合Web应用程序中的HTTP请求处理。</li>\n</ul>\n<p>选择哪种方式取决于你的具体需求。如果你希望对所有方法的异常进行统一处理，切面可能更合适；如果你需要对HTTP请求处理的异常进行统一处理，拦截器则更为合适。</p>\n","cover":false,"excerpt":"","more":"<p>在Spring Boot中，使用切面（Aspect）或拦截器（Interceptor）来捕获异常并记录日志是一种常见的做法。下面介绍如何使用这两种方式来实现。</p>\n<h3 id=\"1-使用切面（Aspect）记录异常日志\"><a href=\"#1-使用切面（Aspect）记录异常日志\" class=\"headerlink\" title=\"1. 使用切面（Aspect）记录异常日志\"></a>1. 使用切面（Aspect）记录异常日志</h3><p>Spring AOP（Aspect-Oriented Programming）允许你定义横切关注点，比如日志记录、事务管理等。可以通过编写一个切面来捕获所有方法中的异常并记录日志。</p>\n<h4 id=\"步骤：\"><a href=\"#步骤：\" class=\"headerlink\" title=\"步骤：\"></a>步骤：</h4><ol>\n<li><p><strong>添加依赖</strong>：<br>确保你的项目中包含Spring AOP相关依赖。如果你使用的是Maven，确保<code>spring-boot-starter-aop</code>已经在你的<code>pom.xml</code>中。</p>\n <figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-aop<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>创建切面类</strong>：</p>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.AfterThrowing;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.Logger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Aspect</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ExceptionLoggingAspect</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(ExceptionLoggingAspect.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 定义一个切入点，拦截所有方法</span></span><br><span class=\"line\">    <span class=\"meta\">@AfterThrowing(pointcut = &quot;execution(* com.yourpackage..*(..))&quot;, throwing = &quot;exception&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">logException</span><span class=\"params\">(Exception exception)</span> &#123;</span><br><span class=\"line\">        logger.error(<span class=\"string\">&quot;Exception caught: &quot;</span>, exception);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在上述代码中，<code>@AfterThrowing</code>注解用于定义在方法抛出异常后执行的通知。<code>execution(* com.yourpackage..*(..))</code>表示拦截<code>com.yourpackage</code>包及其子包中所有类的所有方法。</p>\n</li>\n</ol>\n<h3 id=\"2-使用拦截器（Interceptor）记录异常日志\"><a href=\"#2-使用拦截器（Interceptor）记录异常日志\" class=\"headerlink\" title=\"2. 使用拦截器（Interceptor）记录异常日志\"></a>2. 使用拦截器（Interceptor）记录异常日志</h3><p>Spring中的拦截器允许你在HTTP请求处理的各个阶段执行一些操作，可以用来记录异常日志。</p>\n<h4 id=\"步骤：-1\"><a href=\"#步骤：-1\" class=\"headerlink\" title=\"步骤：\"></a>步骤：</h4><ol>\n<li><p><strong>创建拦截器类</strong>：</p>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ExceptionLoggingInterceptor</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">HandlerInterceptor</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">preHandle</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">postHandle</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">afterCompletion</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ex != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 记录异常日志</span></span><br><span class=\"line\">            <span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(handler.getClass());</span><br><span class=\"line\">            logger.error(<span class=\"string\">&quot;Exception caught during request processing: &quot;</span>, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>注册拦截器</strong>：</p>\n<p>在Spring Boot应用中，通过配置类注册拦截器。</p>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">WebConfig</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">WebMvcConfigurer</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ExceptionLoggingInterceptor exceptionLoggingInterceptor;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addInterceptors</span><span class=\"params\">(InterceptorRegistry registry)</span> &#123;</span><br><span class=\"line\">        registry.addInterceptor(exceptionLoggingInterceptor);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>这两种方式各有优劣：</p>\n<ul>\n<li><strong>切面（Aspect）</strong>适用于需要在方法级别捕获异常的情况，可以轻松应用于所有方法。</li>\n<li><strong>拦截器（Interceptor）</strong>适用于需要在请求级别捕获异常的情况，更适合Web应用程序中的HTTP请求处理。</li>\n</ul>\n<p>选择哪种方式取决于你的具体需求。如果你希望对所有方法的异常进行统一处理，切面可能更合适；如果你需要对HTTP请求处理的异常进行统一处理，拦截器则更为合适。</p>\n"},{"title":"学习it网站推荐","date":"2024-06-26T03:06:14.000Z","_content":"\n分享一些好的网站，个人学习常用的网站，作为分享后续持续更新.\n\n## 网站资源\n\n### 技术学习网站\n- 盗版书网站：https://zh.singlelogin.re/\n- 架构师学习 [https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览](https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览 \"https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览\")\n  ![](学习it网站推荐/image_PEAqPgamQe.png)\n- 源码学习：[https://doocs.github.io/source-code-hunter/#/](https://doocs.github.io/source-code-hunter/#/ \"https://doocs.github.io/source-code-hunter/#/\")\n  ![](学习it网站推荐/image_qBL4LWSs2U.png)\n- 互联网 Java 工程师进阶知识完全扫盲:  [https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲](https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲 \"https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲\")\n  ![](学习it网站推荐/image_RtiUPlWbme.png)\n- 叶良辰の学习笔记 [https://yangzhiwen911.github.io/zh/guide/](https://yangzhiwen911.github.io/zh/guide/ \"https://yangzhiwen911.github.io/zh/guide/\")\n  ![](学习it网站推荐/image_tMLd_Cap6a.png)\n- 图灵Java架构师学习路线(点击链接看新版本) [https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map](https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map \"https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map\")\n  ![](学习it网站推荐/image_-m-m1AZh7M.png)\n- [深入架构原理与实践](https://www.thebyte.com.cn/ \"深入架构原理与实践\") [https://www.thebyte.com.cn/](https://www.thebyte.com.cn/ \"https://www.thebyte.com.cn/\");\n  ![](学习it网站推荐/image_zZOb0Uu1MN.png)\n- Kubernetes 实践指南 [https://imroc.cc/kubernetes/](https://imroc.cc/kubernetes/ \"https://imroc.cc/kubernetes/\");\n  vip破解视频  [https://share.xiaole88.com/其他东西/老齐的IT加油站](https://share.xiaole88.com/其他东西/老齐的IT加油站 \"https://share.xiaole88.com/其他东西/老齐的IT加油站\")\n  [https://share.xiaole88.com/K8渗透工具箱](https://share.xiaole88.com/K8渗透工具箱 \"https://share.xiaole88.com/K8渗透工具箱\")\n\n### 工具网站：\n\n- [https://www.flickr.com/](https://www.flickr.com/ \"https://www.flickr.com/\")   好的照片不能我一个人分享\n\n- [https://markmap.js.org/repl](https://markmap.js.org/repl \"https://markmap.js.org/repl\")  将markmap 生成图例\n  ![](学习it网站推荐/image_bUw4GOE3i3.png)\n\n- 苹果id相关：\n  \n  [https://appleid.stryun.top/](https://appleid.stryun.top/ \"https://appleid.stryun.top/\")\n  \n  [https://apple.hutaosubconverter.com/hutao](https://apple.hutaosubconverter.com/hutao \"https://apple.hutaosubconverter.com/hutao\")\n\n### 营销方向学习：\n\n- 宣传图生成 [https://design.palxp.cn/home?tempid=1188](https://design.palxp.cn/home?tempid=1188 \"https://design.palxp.cn/home?tempid=1188\")\n  \n  ![](学习it网站推荐/image_SOZXE0ImbY.png)\n","source":"_posts/分享/学习it网站推荐.md","raw":"---\n\ntitle: 学习it网站推荐\ndate: 2024-06-26 11:06:14\ncategories: 分享\ntag: 网站资源\n\n---\n\n分享一些好的网站，个人学习常用的网站，作为分享后续持续更新.\n\n## 网站资源\n\n### 技术学习网站\n- 盗版书网站：https://zh.singlelogin.re/\n- 架构师学习 [https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览](https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览 \"https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览\")\n  ![](学习it网站推荐/image_PEAqPgamQe.png)\n- 源码学习：[https://doocs.github.io/source-code-hunter/#/](https://doocs.github.io/source-code-hunter/#/ \"https://doocs.github.io/source-code-hunter/#/\")\n  ![](学习it网站推荐/image_qBL4LWSs2U.png)\n- 互联网 Java 工程师进阶知识完全扫盲:  [https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲](https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲 \"https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲\")\n  ![](学习it网站推荐/image_RtiUPlWbme.png)\n- 叶良辰の学习笔记 [https://yangzhiwen911.github.io/zh/guide/](https://yangzhiwen911.github.io/zh/guide/ \"https://yangzhiwen911.github.io/zh/guide/\")\n  ![](学习it网站推荐/image_tMLd_Cap6a.png)\n- 图灵Java架构师学习路线(点击链接看新版本) [https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map](https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map \"https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map\")\n  ![](学习it网站推荐/image_-m-m1AZh7M.png)\n- [深入架构原理与实践](https://www.thebyte.com.cn/ \"深入架构原理与实践\") [https://www.thebyte.com.cn/](https://www.thebyte.com.cn/ \"https://www.thebyte.com.cn/\");\n  ![](学习it网站推荐/image_zZOb0Uu1MN.png)\n- Kubernetes 实践指南 [https://imroc.cc/kubernetes/](https://imroc.cc/kubernetes/ \"https://imroc.cc/kubernetes/\");\n  vip破解视频  [https://share.xiaole88.com/其他东西/老齐的IT加油站](https://share.xiaole88.com/其他东西/老齐的IT加油站 \"https://share.xiaole88.com/其他东西/老齐的IT加油站\")\n  [https://share.xiaole88.com/K8渗透工具箱](https://share.xiaole88.com/K8渗透工具箱 \"https://share.xiaole88.com/K8渗透工具箱\")\n\n### 工具网站：\n\n- [https://www.flickr.com/](https://www.flickr.com/ \"https://www.flickr.com/\")   好的照片不能我一个人分享\n\n- [https://markmap.js.org/repl](https://markmap.js.org/repl \"https://markmap.js.org/repl\")  将markmap 生成图例\n  ![](学习it网站推荐/image_bUw4GOE3i3.png)\n\n- 苹果id相关：\n  \n  [https://appleid.stryun.top/](https://appleid.stryun.top/ \"https://appleid.stryun.top/\")\n  \n  [https://apple.hutaosubconverter.com/hutao](https://apple.hutaosubconverter.com/hutao \"https://apple.hutaosubconverter.com/hutao\")\n\n### 营销方向学习：\n\n- 宣传图生成 [https://design.palxp.cn/home?tempid=1188](https://design.palxp.cn/home?tempid=1188 \"https://design.palxp.cn/home?tempid=1188\")\n  \n  ![](学习it网站推荐/image_SOZXE0ImbY.png)\n","slug":"分享/学习it网站推荐","published":1,"updated":"2025-02-18T06:25:33.700Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul900040ujz3bi7q4btx","content":"<p>分享一些好的网站，个人学习常用的网站，作为分享后续持续更新.</p>\n<h2 id=\"网站资源\"><a href=\"#网站资源\" class=\"headerlink\" title=\"网站资源\"></a>网站资源</h2><h3 id=\"技术学习网站\"><a href=\"#技术学习网站\" class=\"headerlink\" title=\"技术学习网站\"></a>技术学习网站</h3><ul>\n<li>盗版书网站：<a href=\"https://zh.singlelogin.re/\">https://zh.singlelogin.re/</a></li>\n<li>架构师学习 <a href=\"https://bugstack.cn/md/other/guide-to-reading.html#%E4%B8%80%E3%80%81%E6%9C%AC%E7%AB%99%E7%9F%A5%E8%AF%86%E9%98%85%E8%A7%88\" title=\"https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览\">https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览</a></li>\n<li>源码学习：<a href=\"https://doocs.github.io/source-code-hunter/#/\" title=\"https://doocs.github.io/source-code-hunter/#/\">https://doocs.github.io/source-code-hunter/#/</a></li>\n<li>互联网 Java 工程师进阶知识完全扫盲:  <a href=\"https://doocs.github.io/advanced-java/#/?id=%E4%BA%92%E8%81%94%E7%BD%91-java-%E5%B7%A5%E7%A8%8B%E5%B8%88%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86%E5%AE%8C%E5%85%A8%E6%89%AB%E7%9B%B2\" title=\"https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲\">https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲</a></li>\n<li>叶良辰の学习笔记 <a href=\"https://yangzhiwen911.github.io/zh/guide/\" title=\"https://yangzhiwen911.github.io/zh/guide/\">https://yangzhiwen911.github.io/zh/guide/</a></li>\n<li>图灵Java架构师学习路线(点击链接看新版本) <a href=\"https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map\" title=\"https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map\">https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map</a></li>\n<li><a href=\"https://www.thebyte.com.cn/\" title=\"深入架构原理与实践\">深入架构原理与实践</a> <a href=\"https://www.thebyte.com.cn/\" title=\"https://www.thebyte.com.cn/\">https://www.thebyte.com.cn/</a>;</li>\n<li>Kubernetes 实践指南 <a href=\"https://imroc.cc/kubernetes/\" title=\"https://imroc.cc/kubernetes/\">https://imroc.cc/kubernetes/</a>;<br>vip破解视频  <a href=\"https://share.xiaole88.com/%E5%85%B6%E4%BB%96%E4%B8%9C%E8%A5%BF/%E8%80%81%E9%BD%90%E7%9A%84IT%E5%8A%A0%E6%B2%B9%E7%AB%99\" title=\"https://share.xiaole88.com/其他东西/老齐的IT加油站\">https://share.xiaole88.com/其他东西/老齐的IT加油站</a><br><a href=\"https://share.xiaole88.com/K8%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E7%AE%B1\" title=\"https://share.xiaole88.com/K8渗透工具箱\">https://share.xiaole88.com/K8渗透工具箱</a></li>\n</ul>\n<h3 id=\"工具网站：\"><a href=\"#工具网站：\" class=\"headerlink\" title=\"工具网站：\"></a>工具网站：</h3><ul>\n<li><p><a href=\"https://www.flickr.com/\" title=\"https://www.flickr.com/\">https://www.flickr.com/</a>   好的照片不能我一个人分享</p>\n</li>\n<li><p><a href=\"https://markmap.js.org/repl\" title=\"https://markmap.js.org/repl\">https://markmap.js.org/repl</a>  将markmap 生成图例</p>\n\n</li>\n<li><p>苹果id相关：</p>\n<p><a href=\"https://appleid.stryun.top/\" title=\"https://appleid.stryun.top/\">https://appleid.stryun.top/</a></p>\n<p><a href=\"https://apple.hutaosubconverter.com/hutao\" title=\"https://apple.hutaosubconverter.com/hutao\">https://apple.hutaosubconverter.com/hutao</a></p>\n</li>\n</ul>\n<h3 id=\"营销方向学习：\"><a href=\"#营销方向学习：\" class=\"headerlink\" title=\"营销方向学习：\"></a>营销方向学习：</h3><ul>\n<li><p>宣传图生成 <a href=\"https://design.palxp.cn/home?tempid=1188\" title=\"https://design.palxp.cn/home?tempid=1188\">https://design.palxp.cn/home?tempid=1188</a></p>\n</li>\n</ul>\n","cover":false,"excerpt":"","more":"<p>分享一些好的网站，个人学习常用的网站，作为分享后续持续更新.</p>\n<h2 id=\"网站资源\"><a href=\"#网站资源\" class=\"headerlink\" title=\"网站资源\"></a>网站资源</h2><h3 id=\"技术学习网站\"><a href=\"#技术学习网站\" class=\"headerlink\" title=\"技术学习网站\"></a>技术学习网站</h3><ul>\n<li>盗版书网站：<a href=\"https://zh.singlelogin.re/\">https://zh.singlelogin.re/</a></li>\n<li>架构师学习 <a href=\"https://bugstack.cn/md/other/guide-to-reading.html#%E4%B8%80%E3%80%81%E6%9C%AC%E7%AB%99%E7%9F%A5%E8%AF%86%E9%98%85%E8%A7%88\" title=\"https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览\">https://bugstack.cn/md/other/guide-to-reading.html#一、本站知识阅览</a></li>\n<li>源码学习：<a href=\"https://doocs.github.io/source-code-hunter/#/\" title=\"https://doocs.github.io/source-code-hunter/#/\">https://doocs.github.io/source-code-hunter/#/</a></li>\n<li>互联网 Java 工程师进阶知识完全扫盲:  <a href=\"https://doocs.github.io/advanced-java/#/?id=%E4%BA%92%E8%81%94%E7%BD%91-java-%E5%B7%A5%E7%A8%8B%E5%B8%88%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86%E5%AE%8C%E5%85%A8%E6%89%AB%E7%9B%B2\" title=\"https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲\">https://doocs.github.io/advanced-java/#/?id=互联网-java-工程师进阶知识完全扫盲</a></li>\n<li>叶良辰の学习笔记 <a href=\"https://yangzhiwen911.github.io/zh/guide/\" title=\"https://yangzhiwen911.github.io/zh/guide/\">https://yangzhiwen911.github.io/zh/guide/</a></li>\n<li>图灵Java架构师学习路线(点击链接看新版本) <a href=\"https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map\" title=\"https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map\">https://www.processon.com/view/link/5eccea8fe0b34d5f263038f0#map</a></li>\n<li><a href=\"https://www.thebyte.com.cn/\" title=\"深入架构原理与实践\">深入架构原理与实践</a> <a href=\"https://www.thebyte.com.cn/\" title=\"https://www.thebyte.com.cn/\">https://www.thebyte.com.cn/</a>;</li>\n<li>Kubernetes 实践指南 <a href=\"https://imroc.cc/kubernetes/\" title=\"https://imroc.cc/kubernetes/\">https://imroc.cc/kubernetes/</a>;<br>vip破解视频  <a href=\"https://share.xiaole88.com/%E5%85%B6%E4%BB%96%E4%B8%9C%E8%A5%BF/%E8%80%81%E9%BD%90%E7%9A%84IT%E5%8A%A0%E6%B2%B9%E7%AB%99\" title=\"https://share.xiaole88.com/其他东西/老齐的IT加油站\">https://share.xiaole88.com/其他东西/老齐的IT加油站</a><br><a href=\"https://share.xiaole88.com/K8%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E7%AE%B1\" title=\"https://share.xiaole88.com/K8渗透工具箱\">https://share.xiaole88.com/K8渗透工具箱</a></li>\n</ul>\n<h3 id=\"工具网站：\"><a href=\"#工具网站：\" class=\"headerlink\" title=\"工具网站：\"></a>工具网站：</h3><ul>\n<li><p><a href=\"https://www.flickr.com/\" title=\"https://www.flickr.com/\">https://www.flickr.com/</a>   好的照片不能我一个人分享</p>\n</li>\n<li><p><a href=\"https://markmap.js.org/repl\" title=\"https://markmap.js.org/repl\">https://markmap.js.org/repl</a>  将markmap 生成图例</p>\n\n</li>\n<li><p>苹果id相关：</p>\n<p><a href=\"https://appleid.stryun.top/\" title=\"https://appleid.stryun.top/\">https://appleid.stryun.top/</a></p>\n<p><a href=\"https://apple.hutaosubconverter.com/hutao\" title=\"https://apple.hutaosubconverter.com/hutao\">https://apple.hutaosubconverter.com/hutao</a></p>\n</li>\n</ul>\n<h3 id=\"营销方向学习：\"><a href=\"#营销方向学习：\" class=\"headerlink\" title=\"营销方向学习：\"></a>营销方向学习：</h3><ul>\n<li><p>宣传图生成 <a href=\"https://design.palxp.cn/home?tempid=1188\" title=\"https://design.palxp.cn/home?tempid=1188\">https://design.palxp.cn/home?tempid=1188</a></p>\n</li>\n</ul>\n"},{"title":"向量与坐标轴的夹角余弦值","date":"2025-03-19T02:11:47.000Z","_content":"求向量 $\\mathbf{a} = (a_1, a_2, a_3) $ 与坐标轴的夹角余弦值时，首先可以利用向量的定义和夹角余弦的公式。\n\n### 1. 向量与坐标轴的夹角余弦值\n\n对于向量  $ \\mathbf{a} = (a_1, a_2, a_3)  $，它与各坐标轴的夹角余弦值分别为：\n\n- 与 \\( x \\)-轴的夹角余弦值  $ \\cos \\alpha_x $：\n\n  $$ \\cos \\alpha_x = \\frac{a_1}{|\\mathbf{a}|} $$\n\n- 与 \\( y \\)-轴的夹角余弦值  $\\cos \\alpha_y $：\n\n  $$ \\cos \\alpha_y = \\frac{a_2}{|\\mathbf{a}|} $$\n\n- 与 \\( z \\)-轴的夹角余弦值  $\\cos \\alpha_z $：\n\n  $$ \\cos \\alpha_z = \\frac{a_3}{|\\mathbf{a}|} $$\n\n### 2. 向量的模（大小）\n\n向量  $ \\mathbf{a} = (a_1, a_2, a_3)  $ 的模为：\n\n$$ |\\mathbf{a}| = \\sqrt{a_1^2 + a_2^2 + a_3^2} $$\n\n### 3. 夹角余弦值的解释\n\n这些余弦值表示了向量  $ \\mathbf{a}  $ 在各坐标轴上的分量比例。例如 $\\cos \\alpha_x $ 表示向量在 \\( x \\)-轴方向上的分量占总长度的比例。","source":"_posts/数学/向量与坐标轴的夹角余弦值.md","raw":"---\ntitle: 向量与坐标轴的夹角余弦值\ndate: 2025-03-19 10:11:47\ntags:\n---\n求向量 $\\mathbf{a} = (a_1, a_2, a_3) $ 与坐标轴的夹角余弦值时，首先可以利用向量的定义和夹角余弦的公式。\n\n### 1. 向量与坐标轴的夹角余弦值\n\n对于向量  $ \\mathbf{a} = (a_1, a_2, a_3)  $，它与各坐标轴的夹角余弦值分别为：\n\n- 与 \\( x \\)-轴的夹角余弦值  $ \\cos \\alpha_x $：\n\n  $$ \\cos \\alpha_x = \\frac{a_1}{|\\mathbf{a}|} $$\n\n- 与 \\( y \\)-轴的夹角余弦值  $\\cos \\alpha_y $：\n\n  $$ \\cos \\alpha_y = \\frac{a_2}{|\\mathbf{a}|} $$\n\n- 与 \\( z \\)-轴的夹角余弦值  $\\cos \\alpha_z $：\n\n  $$ \\cos \\alpha_z = \\frac{a_3}{|\\mathbf{a}|} $$\n\n### 2. 向量的模（大小）\n\n向量  $ \\mathbf{a} = (a_1, a_2, a_3)  $ 的模为：\n\n$$ |\\mathbf{a}| = \\sqrt{a_1^2 + a_2^2 + a_3^2} $$\n\n### 3. 夹角余弦值的解释\n\n这些余弦值表示了向量  $ \\mathbf{a}  $ 在各坐标轴上的分量比例。例如 $\\cos \\alpha_x $ 表示向量在 \\( x \\)-轴方向上的分量占总长度的比例。","slug":"数学/向量与坐标轴的夹角余弦值","published":1,"updated":"2025-03-19T06:36:03.009Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul900041ujz3bp9meryf","content":"<p>求向量 $\\mathbf{a} &#x3D; (a_1, a_2, a_3) $ 与坐标轴的夹角余弦值时，首先可以利用向量的定义和夹角余弦的公式。</p>\n<h3 id=\"1-向量与坐标轴的夹角余弦值\"><a href=\"#1-向量与坐标轴的夹角余弦值\" class=\"headerlink\" title=\"1. 向量与坐标轴的夹角余弦值\"></a>1. 向量与坐标轴的夹角余弦值</h3><p>对于向量  $ \\mathbf{a} &#x3D; (a_1, a_2, a_3)  $，它与各坐标轴的夹角余弦值分别为：</p>\n<ul>\n<li><p>与 ( x )-轴的夹角余弦值  $ \\cos \\alpha_x $：</p>\n<p>$$ \\cos \\alpha_x &#x3D; \\frac{a_1}{|\\mathbf{a}|} $$</p>\n</li>\n<li><p>与 ( y )-轴的夹角余弦值  $\\cos \\alpha_y $：</p>\n<p>$$ \\cos \\alpha_y &#x3D; \\frac{a_2}{|\\mathbf{a}|} $$</p>\n</li>\n<li><p>与 ( z )-轴的夹角余弦值  $\\cos \\alpha_z $：</p>\n<p>$$ \\cos \\alpha_z &#x3D; \\frac{a_3}{|\\mathbf{a}|} $$</p>\n</li>\n</ul>\n<h3 id=\"2-向量的模（大小）\"><a href=\"#2-向量的模（大小）\" class=\"headerlink\" title=\"2. 向量的模（大小）\"></a>2. 向量的模（大小）</h3><p>向量  $ \\mathbf{a} &#x3D; (a_1, a_2, a_3)  $ 的模为：</p>\n<p>$$ |\\mathbf{a}| &#x3D; \\sqrt{a_1^2 + a_2^2 + a_3^2} $$</p>\n<h3 id=\"3-夹角余弦值的解释\"><a href=\"#3-夹角余弦值的解释\" class=\"headerlink\" title=\"3. 夹角余弦值的解释\"></a>3. 夹角余弦值的解释</h3><p>这些余弦值表示了向量  $ \\mathbf{a}  $ 在各坐标轴上的分量比例。例如 $\\cos \\alpha_x $ 表示向量在 ( x )-轴方向上的分量占总长度的比例。</p>\n","cover":false,"excerpt":"","more":"<p>求向量 $\\mathbf{a} &#x3D; (a_1, a_2, a_3) $ 与坐标轴的夹角余弦值时，首先可以利用向量的定义和夹角余弦的公式。</p>\n<h3 id=\"1-向量与坐标轴的夹角余弦值\"><a href=\"#1-向量与坐标轴的夹角余弦值\" class=\"headerlink\" title=\"1. 向量与坐标轴的夹角余弦值\"></a>1. 向量与坐标轴的夹角余弦值</h3><p>对于向量  $ \\mathbf{a} &#x3D; (a_1, a_2, a_3)  $，它与各坐标轴的夹角余弦值分别为：</p>\n<ul>\n<li><p>与 ( x )-轴的夹角余弦值  $ \\cos \\alpha_x $：</p>\n<p>$$ \\cos \\alpha_x &#x3D; \\frac{a_1}{|\\mathbf{a}|} $$</p>\n</li>\n<li><p>与 ( y )-轴的夹角余弦值  $\\cos \\alpha_y $：</p>\n<p>$$ \\cos \\alpha_y &#x3D; \\frac{a_2}{|\\mathbf{a}|} $$</p>\n</li>\n<li><p>与 ( z )-轴的夹角余弦值  $\\cos \\alpha_z $：</p>\n<p>$$ \\cos \\alpha_z &#x3D; \\frac{a_3}{|\\mathbf{a}|} $$</p>\n</li>\n</ul>\n<h3 id=\"2-向量的模（大小）\"><a href=\"#2-向量的模（大小）\" class=\"headerlink\" title=\"2. 向量的模（大小）\"></a>2. 向量的模（大小）</h3><p>向量  $ \\mathbf{a} &#x3D; (a_1, a_2, a_3)  $ 的模为：</p>\n<p>$$ |\\mathbf{a}| &#x3D; \\sqrt{a_1^2 + a_2^2 + a_3^2} $$</p>\n<h3 id=\"3-夹角余弦值的解释\"><a href=\"#3-夹角余弦值的解释\" class=\"headerlink\" title=\"3. 夹角余弦值的解释\"></a>3. 夹角余弦值的解释</h3><p>这些余弦值表示了向量  $ \\mathbf{a}  $ 在各坐标轴上的分量比例。例如 $\\cos \\alpha_x $ 表示向量在 ( x )-轴方向上的分量占总长度的比例。</p>\n"},{"title":"亿赛通电子文档安全管理系统XStream反序列化漏洞任意文件上传利用","date":"2024-09-29T09:50:52.000Z","_content":"一、产品简介\n亿赛通电子文档安全管理系统（简称：CDG）是一款电子文档安全加密软件，该系统利用驱动层透明加密技术，通过对电子文档的加密保护，防止内部员工泄密和外部人员非法窃取企业核心重要数据资产，对电子文档进行全生命周期防护，系统具有透明加密、主动加密、智能加密等多种加密方式，用户可根据部门涉密程度的不同（如核心部门和普通部门），部署力度轻重不一的梯度式文档加密防护，实现技术、管理、审计进行有机的结合，在内部构建起立体化的整体信息防泄露体系，使得成本、效率和安全三者达到平衡，实现电子文档的数据安全。\n二、漏洞描述\n亿赛通电子文档安全管理系统UploadFileFromClientServiceForClient接口处存在任意文件上传漏洞，未经授权的攻击者可通过此漏洞上传恶意后门文件，从而获取服务器权限。\n三、影响范围\n未知\n四、复现环境\nFOFA：app=“亿赛通-电子文档安全管理系统”\n五、漏洞复现\n1.访问存在漏洞网站，抓包\n2.POC\n```angular2html\nPOST /CDGServer3/UploadFileFromClientServiceForClient?AFMALANMJCEOENIBDJMKFHBANGEPKHNOFJBMIFJPFNKFOKHJNMLCOIDDJGNEIPOLOKGAFAFJHDEJPHEPLFJHDGPBNELNFIICGFNGEOEFBKCDDCGJEPIKFHJFAOOHJEPNNCLFHDAFDNCGBAEELJFFHABJPDPIEEMIBOECDMDLEPBJGBGCGLEMBDFAGOGM HTTP/1.1\nHost: IP：port\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\nAccept-Encoding: gzip, deflate, br\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nSec-Fetch-Dest: document\nSec-Fetch-Mode: navigate\nSec-Fetch-Site: none\nSec-Fetch-User: ?1\nUpgrade-Insecure-Requests: 1\n\n\n上传的文件内容\n```\n3.测试，上传成功\n4.访问ip:port/tttT.jsp\n\n\n利用源码：https://github.com/candyadmin/CDGXStreamDeserRCE\n教程：\nhttps://www.yuque.com/u34516370/hi2ux9/nibcqge2832vptra\nhttps://blog.csdn.net/uuzeray/article/details/136690493\n","source":"_posts/黑客/亿赛通电子文档安全管理系统XStream反序列化漏洞任意文件上传利用.md","raw":"---\ntitle: 亿赛通电子文档安全管理系统XStream反序列化漏洞任意文件上传利用\ndate: 2024-09-29 17:50:52\ncategories: 黑客\ntag: 漏洞\n---\n一、产品简介\n亿赛通电子文档安全管理系统（简称：CDG）是一款电子文档安全加密软件，该系统利用驱动层透明加密技术，通过对电子文档的加密保护，防止内部员工泄密和外部人员非法窃取企业核心重要数据资产，对电子文档进行全生命周期防护，系统具有透明加密、主动加密、智能加密等多种加密方式，用户可根据部门涉密程度的不同（如核心部门和普通部门），部署力度轻重不一的梯度式文档加密防护，实现技术、管理、审计进行有机的结合，在内部构建起立体化的整体信息防泄露体系，使得成本、效率和安全三者达到平衡，实现电子文档的数据安全。\n二、漏洞描述\n亿赛通电子文档安全管理系统UploadFileFromClientServiceForClient接口处存在任意文件上传漏洞，未经授权的攻击者可通过此漏洞上传恶意后门文件，从而获取服务器权限。\n三、影响范围\n未知\n四、复现环境\nFOFA：app=“亿赛通-电子文档安全管理系统”\n五、漏洞复现\n1.访问存在漏洞网站，抓包\n2.POC\n```angular2html\nPOST /CDGServer3/UploadFileFromClientServiceForClient?AFMALANMJCEOENIBDJMKFHBANGEPKHNOFJBMIFJPFNKFOKHJNMLCOIDDJGNEIPOLOKGAFAFJHDEJPHEPLFJHDGPBNELNFIICGFNGEOEFBKCDDCGJEPIKFHJFAOOHJEPNNCLFHDAFDNCGBAEELJFFHABJPDPIEEMIBOECDMDLEPBJGBGCGLEMBDFAGOGM HTTP/1.1\nHost: IP：port\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\nAccept-Encoding: gzip, deflate, br\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nSec-Fetch-Dest: document\nSec-Fetch-Mode: navigate\nSec-Fetch-Site: none\nSec-Fetch-User: ?1\nUpgrade-Insecure-Requests: 1\n\n\n上传的文件内容\n```\n3.测试，上传成功\n4.访问ip:port/tttT.jsp\n\n\n利用源码：https://github.com/candyadmin/CDGXStreamDeserRCE\n教程：\nhttps://www.yuque.com/u34516370/hi2ux9/nibcqge2832vptra\nhttps://blog.csdn.net/uuzeray/article/details/136690493\n","slug":"黑客/亿赛通电子文档安全管理系统XStream反序列化漏洞任意文件上传利用","published":1,"updated":"2025-02-18T06:27:08.573Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul910045ujz35y2hhxu0","content":"<p>一、产品简介<br>亿赛通电子文档安全管理系统（简称：CDG）是一款电子文档安全加密软件，该系统利用驱动层透明加密技术，通过对电子文档的加密保护，防止内部员工泄密和外部人员非法窃取企业核心重要数据资产，对电子文档进行全生命周期防护，系统具有透明加密、主动加密、智能加密等多种加密方式，用户可根据部门涉密程度的不同（如核心部门和普通部门），部署力度轻重不一的梯度式文档加密防护，实现技术、管理、审计进行有机的结合，在内部构建起立体化的整体信息防泄露体系，使得成本、效率和安全三者达到平衡，实现电子文档的数据安全。<br>二、漏洞描述<br>亿赛通电子文档安全管理系统UploadFileFromClientServiceForClient接口处存在任意文件上传漏洞，未经授权的攻击者可通过此漏洞上传恶意后门文件，从而获取服务器权限。<br>三、影响范围<br>未知<br>四、复现环境<br>FOFA：app&#x3D;“亿赛通-电子文档安全管理系统”<br>五、漏洞复现<br>1.访问存在漏洞网站，抓包<br>2.POC</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /CDGServer3/UploadFileFromClientServiceForClient?AFMALANMJCEOENIBDJMKFHBANGEPKHNOFJBMIFJPFNKFOKHJNMLCOIDDJGNEIPOLOKGAFAFJHDEJPHEPLFJHDGPBNELNFIICGFNGEOEFBKCDDCGJEPIKFHJFAOOHJEPNNCLFHDAFDNCGBAEELJFFHABJPDPIEEMIBOECDMDLEPBJGBGCGLEMBDFAGOGM HTTP/1.1</span><br><span class=\"line\">Host: IP：port</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Encoding: gzip, deflate, br</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Sec-Fetch-Dest: document</span><br><span class=\"line\">Sec-Fetch-Mode: navigate</span><br><span class=\"line\">Sec-Fetch-Site: none</span><br><span class=\"line\">Sec-Fetch-User: ?1</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">上传的文件内容</span><br></pre></td></tr></table></figure>\n<p>3.测试，上传成功<br>4.访问ip:port&#x2F;tttT.jsp</p>\n<p>利用源码：<a href=\"https://github.com/candyadmin/CDGXStreamDeserRCE\">https://github.com/candyadmin/CDGXStreamDeserRCE</a><br>教程：<br><a href=\"https://www.yuque.com/u34516370/hi2ux9/nibcqge2832vptra\">https://www.yuque.com/u34516370/hi2ux9/nibcqge2832vptra</a><br><a href=\"https://blog.csdn.net/uuzeray/article/details/136690493\">https://blog.csdn.net/uuzeray/article/details/136690493</a></p>\n","cover":false,"excerpt":"","more":"<p>一、产品简介<br>亿赛通电子文档安全管理系统（简称：CDG）是一款电子文档安全加密软件，该系统利用驱动层透明加密技术，通过对电子文档的加密保护，防止内部员工泄密和外部人员非法窃取企业核心重要数据资产，对电子文档进行全生命周期防护，系统具有透明加密、主动加密、智能加密等多种加密方式，用户可根据部门涉密程度的不同（如核心部门和普通部门），部署力度轻重不一的梯度式文档加密防护，实现技术、管理、审计进行有机的结合，在内部构建起立体化的整体信息防泄露体系，使得成本、效率和安全三者达到平衡，实现电子文档的数据安全。<br>二、漏洞描述<br>亿赛通电子文档安全管理系统UploadFileFromClientServiceForClient接口处存在任意文件上传漏洞，未经授权的攻击者可通过此漏洞上传恶意后门文件，从而获取服务器权限。<br>三、影响范围<br>未知<br>四、复现环境<br>FOFA：app&#x3D;“亿赛通-电子文档安全管理系统”<br>五、漏洞复现<br>1.访问存在漏洞网站，抓包<br>2.POC</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /CDGServer3/UploadFileFromClientServiceForClient?AFMALANMJCEOENIBDJMKFHBANGEPKHNOFJBMIFJPFNKFOKHJNMLCOIDDJGNEIPOLOKGAFAFJHDEJPHEPLFJHDGPBNELNFIICGFNGEOEFBKCDDCGJEPIKFHJFAOOHJEPNNCLFHDAFDNCGBAEELJFFHABJPDPIEEMIBOECDMDLEPBJGBGCGLEMBDFAGOGM HTTP/1.1</span><br><span class=\"line\">Host: IP：port</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Encoding: gzip, deflate, br</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Sec-Fetch-Dest: document</span><br><span class=\"line\">Sec-Fetch-Mode: navigate</span><br><span class=\"line\">Sec-Fetch-Site: none</span><br><span class=\"line\">Sec-Fetch-User: ?1</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">上传的文件内容</span><br></pre></td></tr></table></figure>\n<p>3.测试，上传成功<br>4.访问ip:port&#x2F;tttT.jsp</p>\n<p>利用源码：<a href=\"https://github.com/candyadmin/CDGXStreamDeserRCE\">https://github.com/candyadmin/CDGXStreamDeserRCE</a><br>教程：<br><a href=\"https://www.yuque.com/u34516370/hi2ux9/nibcqge2832vptra\">https://www.yuque.com/u34516370/hi2ux9/nibcqge2832vptra</a><br><a href=\"https://blog.csdn.net/uuzeray/article/details/136690493\">https://blog.csdn.net/uuzeray/article/details/136690493</a></p>\n"},{"title":"设信道带宽为16kHz,信噪比为30dB,则该信道的信道容量大约为","date":"2024-10-22T09:19:02.000Z","_content":"根据香农信道容量公式：\n\n\\[\nC = B \\log_2(1 + S/N)\n\\]\n\n其中：\n- \\( C \\) 是信道容量（单位：比特每秒，bps），\n- \\( B \\) 是信道带宽（单位：赫兹，Hz），\n- \\( S/N \\) 是信噪比，通常以线性值表示。\n\n### 已知条件：\n- 信道带宽 \\( B = 16 \\, \\text{kHz} = 16,000 \\, \\text{Hz} \\),\n- 信噪比 \\( \\text{S/N} = 30 \\, \\text{dB} \\).\n\n首先，将信噪比从 dB 转换为线性值：\n\\[\nS/N = 10^{30/10} = 10^3 = 1000\n\\]\n\n将这些值代入香农公式：\n\\[\nC = 16000 \\log_2(1 + 1000)\n\\]\n\n计算出 \\( \\log_2(1001) \\)，然后再乘以带宽 \\( B \\)。\n\n我们来计算这个值。\n\n根据计算结果，信道容量大约为 **159,476 bps**（比特每秒）。","source":"_posts/计算机考试/设信道带宽为16kHz-信噪比为30dB-则该信道的信道容量大约为.md","raw":"---\ntitle: 设信道带宽为16kHz,信噪比为30dB,则该信道的信道容量大约为\ndate: 2024-10-22 17:19:02\ncategories: 计算机考试\ntag: 自学公式\n---\n根据香农信道容量公式：\n\n\\[\nC = B \\log_2(1 + S/N)\n\\]\n\n其中：\n- \\( C \\) 是信道容量（单位：比特每秒，bps），\n- \\( B \\) 是信道带宽（单位：赫兹，Hz），\n- \\( S/N \\) 是信噪比，通常以线性值表示。\n\n### 已知条件：\n- 信道带宽 \\( B = 16 \\, \\text{kHz} = 16,000 \\, \\text{Hz} \\),\n- 信噪比 \\( \\text{S/N} = 30 \\, \\text{dB} \\).\n\n首先，将信噪比从 dB 转换为线性值：\n\\[\nS/N = 10^{30/10} = 10^3 = 1000\n\\]\n\n将这些值代入香农公式：\n\\[\nC = 16000 \\log_2(1 + 1000)\n\\]\n\n计算出 \\( \\log_2(1001) \\)，然后再乘以带宽 \\( B \\)。\n\n我们来计算这个值。\n\n根据计算结果，信道容量大约为 **159,476 bps**（比特每秒）。","slug":"计算机考试/设信道带宽为16kHz-信噪比为30dB-则该信道的信道容量大约为","published":1,"updated":"2025-02-18T06:24:40.777Z","comments":1,"layout":"post","photos":[],"_id":"cmiguul910047ujz3ciq03zor","content":"<p>根据香农信道容量公式：</p>\n<p>[<br>C &#x3D; B \\log_2(1 + S&#x2F;N)<br>]</p>\n<p>其中：</p>\n<ul>\n<li>( C ) 是信道容量（单位：比特每秒，bps），</li>\n<li>( B ) 是信道带宽（单位：赫兹，Hz），</li>\n<li>( S&#x2F;N ) 是信噪比，通常以线性值表示。</li>\n</ul>\n<h3 id=\"已知条件：\"><a href=\"#已知条件：\" class=\"headerlink\" title=\"已知条件：\"></a>已知条件：</h3><ul>\n<li>信道带宽 ( B &#x3D; 16 , \\text{kHz} &#x3D; 16,000 , \\text{Hz} ),</li>\n<li>信噪比 ( \\text{S&#x2F;N} &#x3D; 30 , \\text{dB} ).</li>\n</ul>\n<p>首先，将信噪比从 dB 转换为线性值：<br>[<br>S&#x2F;N &#x3D; 10^{30&#x2F;10} &#x3D; 10^3 &#x3D; 1000<br>]</p>\n<p>将这些值代入香农公式：<br>[<br>C &#x3D; 16000 \\log_2(1 + 1000)<br>]</p>\n<p>计算出 ( \\log_2(1001) )，然后再乘以带宽 ( B )。</p>\n<p>我们来计算这个值。</p>\n<p>根据计算结果，信道容量大约为 <strong>159,476 bps</strong>（比特每秒）。</p>\n","cover":false,"excerpt":"","more":"<p>根据香农信道容量公式：</p>\n<p>[<br>C &#x3D; B \\log_2(1 + S&#x2F;N)<br>]</p>\n<p>其中：</p>\n<ul>\n<li>( C ) 是信道容量（单位：比特每秒，bps），</li>\n<li>( B ) 是信道带宽（单位：赫兹，Hz），</li>\n<li>( S&#x2F;N ) 是信噪比，通常以线性值表示。</li>\n</ul>\n<h3 id=\"已知条件：\"><a href=\"#已知条件：\" class=\"headerlink\" title=\"已知条件：\"></a>已知条件：</h3><ul>\n<li>信道带宽 ( B &#x3D; 16 , \\text{kHz} &#x3D; 16,000 , \\text{Hz} ),</li>\n<li>信噪比 ( \\text{S&#x2F;N} &#x3D; 30 , \\text{dB} ).</li>\n</ul>\n<p>首先，将信噪比从 dB 转换为线性值：<br>[<br>S&#x2F;N &#x3D; 10^{30&#x2F;10} &#x3D; 10^3 &#x3D; 1000<br>]</p>\n<p>将这些值代入香农公式：<br>[<br>C &#x3D; 16000 \\log_2(1 + 1000)<br>]</p>\n<p>计算出 ( \\log_2(1001) )，然后再乘以带宽 ( B )。</p>\n<p>我们来计算这个值。</p>\n<p>根据计算结果，信道容量大约为 <strong>159,476 bps</strong>（比特每秒）。</p>\n"},{"title":"java中傲人的写法","date":"2025-11-29T09:21:06.000Z","_content":"\n```java\n@ConditionalOnExpression(\"#{ T(org.springframework.boot.system.SystemProperties).get('os.name').toLowerCase().contains('linux') }\")\n```\n","source":"_posts/java/java中傲人的写法.md","raw":"---\ntitle: java中傲人的写法\ndate: 2025-11-29 17:21:06\ncategories: Java\ntag: 傲人的写法\n---\n\n```java\n@ConditionalOnExpression(\"#{ T(org.springframework.boot.system.SystemProperties).get('os.name').toLowerCase().contains('linux') }\")\n```\n","slug":"java/java中傲人的写法","published":1,"updated":"2025-11-29T09:22:54.240Z","comments":1,"layout":"post","photos":[],"_id":"cmjgyvrnq0000kd0vfacdej24","content":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ConditionalOnExpression(&quot;#&#123; T(org.springframework.boot.system.SystemProperties).get(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;linux&#x27;) &#125;&quot;)</span></span><br></pre></td></tr></table></figure>\n","cover":false,"excerpt":"","more":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ConditionalOnExpression(&quot;#&#123; T(org.springframework.boot.system.SystemProperties).get(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;linux&#x27;) &#125;&quot;)</span></span><br></pre></td></tr></table></figure>\n"},{"title":"异构系统实时数据同步方案","date":"2025-12-22T09:40:10.000Z","_content":"这里为你编写一个基于 **Java Flink DataStream API** 的完整代码样例。\n\n这种方式（Code 模式）比单纯的 SQL 模式更适合你提到的“数据对应关系不一样”和“一对多”的复杂业务逻辑，因为它允许你编写任意的 Java 代码来处理数据转换。\n\n### 场景假设\n\n假设我们有一个**源订单表**（一条记录包含多个商品ID），需要拆分同步到**目标详情表**（每个商品一条记录）。\n\n* **源表 (MySQL - db_source.orders):**\n* `id` (INT, PK)\n* `customer_name` (VARCHAR)\n* `product_ids` (VARCHAR) -> 例如: `\"101,102,103\"`\n\n\n* **目标表 (MySQL - db_target.order_items):**\n* `id` (INT, Auto Increment PK)\n* `order_id` (INT)\n* `customer_name` (VARCHAR)\n* `single_product_id` (INT) -> 需要存 3 条记录: 101, 102, 103\n\n\n\n---\n\n### 1. Maven 依赖配置 (`pom.xml`)\n\n你需要引入 Flink 核心库、Flink CDC 连接器和 JDBC 连接器。\n\n```xml\n<dependencies>\n    <dependency>\n        <groupId>org.apache.flink</groupId>\n        <artifactId>flink-streaming-java</artifactId>\n        <version>1.17.1</version>\n    </dependency>\n    <dependency>\n        <groupId>org.apache.flink</groupId>\n        <artifactId>flink-clients</artifactId>\n        <version>1.17.1</version>\n    </dependency>\n\n    <dependency>\n        <groupId>com.ververica</groupId>\n        <artifactId>flink-connector-mysql-cdc</artifactId>\n        <version>2.4.1</version>\n    </dependency>\n\n    <dependency>\n        <groupId>org.apache.flink</groupId>\n        <artifactId>flink-connector-jdbc</artifactId>\n        <version>3.1.1-1.17</version>\n    </dependency>\n    \n    <dependency>\n        <groupId>mysql</groupId>\n        <artifactId>mysql-connector-java</artifactId>\n        <version>8.0.28</version>\n    </dependency>\n\n    <dependency>\n        <groupId>com.alibaba</groupId>\n        <artifactId>fastjson</artifactId>\n        <version>1.2.83</version>\n    </dependency>\n</dependencies>\n\n```\n\n---\n\n### 2. 完整 Java 代码实现\n\n这个程序由三个部分组成：**Source (CDC 读取)** -> **Transform (拆分逻辑)** -> **Sink (写入目标)**。\n\n```java\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONObject;\nimport com.ververica.cdc.connectors.mysql.source.MySqlSource;\nimport com.ververica.cdc.connectors.mysql.table.StartupOptions;\nimport com.ververica.cdc.debezium.JsonDebeziumDeserializationSchema;\nimport org.apache.flink.api.common.eventtime.WatermarkStrategy;\nimport org.apache.flink.api.common.functions.FlatMapFunction;\nimport org.apache.flink.connector.jdbc.JdbcConnectionOptions;\nimport org.apache.flink.connector.jdbc.JdbcExecutionOptions;\nimport org.apache.flink.connector.jdbc.JdbcSink;\nimport org.apache.flink.connector.jdbc.JdbcStatementBuilder;\nimport org.apache.flink.streaming.api.datastream.DataStreamSource;\nimport org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;\nimport org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\nimport org.apache.flink.util.Collector;\n\nimport java.sql.PreparedStatement;\nimport java.sql.SQLException;\n\n// 1. 定义目标数据的实体类 (POJO)\nclass TargetOrderItem {\n    public int orderId;\n    public String customerName;\n    public int productId;\n\n    public TargetOrderItem(int orderId, String customerName, int productId) {\n        this.orderId = orderId;\n        this.customerName = customerName;\n        this.productId = productId;\n    }\n}\n\npublic class MySqlSyncJob {\n    public static void main(String[] args) throws Exception {\n        \n        // 1. 获取执行环境\n        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n        env.setParallelism(1); // 生产环境根据数据量调整，测试用 1\n\n        // =================================================================\n        // STEP 1: 定义 Source (Flink CDC)\n        // =================================================================\n        MySqlSource<String> mySqlSource = MySqlSource.<String>builder()\n                .hostname(\"localhost\")\n                .port(3306)\n                .databaseList(\"db_source\") // 监控的数据库\n                .tableList(\"db_source.orders\") // 监控的表\n                .username(\"root\")\n                .password(\"123456\")\n                // initial() 会先读取全量历史数据，然后切换到 Binlog 读取增量\n                .startupOptions(StartupOptions.initial()) \n                .deserializer(new JsonDebeziumDeserializationSchema()) // 转成 JSON 字符串处理\n                .build();\n\n        DataStreamSource<String> rawStream = env.fromSource(\n                mySqlSource, \n                WatermarkStrategy.noWatermarks(), \n                \"MySQL CDC Source\"\n        );\n\n        // =================================================================\n        // STEP 2: Transform (核心业务逻辑：1转N)\n        // =================================================================\n        SingleOutputStreamOperator<TargetOrderItem> processedStream = rawStream.flatMap(new FlatMapFunction<String, TargetOrderItem>() {\n            @Override\n            public void flatMap(String value, Collector<TargetOrderItem> out) throws Exception {\n                try {\n                    // 1. 解析 CDC 的 JSON 数据\n                    JSONObject json = JSON.parseObject(value);\n                    \n                    // CDC JSON 结构通常包含 \"before\", \"after\", \"op\" (操作类型)\n                    // 我们主要关注 \"after\" (变更后的数据) 和 \"op\"\n                    // op: c (create), u (update), d (delete), r (read/snapshot)\n                    \n                    JSONObject after = json.getJSONObject(\"after\");\n                    String op = json.getString(\"op\");\n\n                    // 简单起见，这里只处理新增(c, r)和更新(u)，忽略删除(d)\n                    // 如果 after 为 null (例如删除操作)，则跳过\n                    if (after == null) {\n                        return;\n                    }\n\n                    // 2. 提取源字段\n                    Integer orderId = after.getInteger(\"id\");\n                    String customerName = after.getString(\"customer_name\");\n                    String productIdsStr = after.getString(\"product_ids\"); // \"101,102,103\"\n\n                    // 3. 执行 1转N 的业务逻辑\n                    if (productIdsStr != null && !productIdsStr.isEmpty()) {\n                        String[] ids = productIdsStr.split(\",\");\n                        for (String id : ids) {\n                            // 构造目标对象\n                            TargetOrderItem item = new TargetOrderItem(\n                                    orderId,\n                                    customerName,\n                                    Integer.parseInt(id.trim())\n                            );\n                            // 发送往下游\n                            out.collect(item);\n                        }\n                    }\n\n                } catch (Exception e) {\n                    // 生产环境建议记录错误日志到侧输出流(SideOutput)，不要直接抛出导致任务挂掉\n                    System.err.println(\"解析错误: \" + value);\n                    e.printStackTrace();\n                }\n            }\n        });\n\n        // =================================================================\n        // STEP 3: Sink (写入目标数据库)\n        // =================================================================\n        String insertSql = \"INSERT INTO order_items (order_id, customer_name, single_product_id) VALUES (?, ?, ?)\";\n        \n        // 如果需要幂等性（防止重复写入），建议使用 \"INSERT ... ON DUPLICATE KEY UPDATE\"\n        // String upsertSql = \"INSERT INTO order_items ... VALUES ... ON DUPLICATE KEY UPDATE ...\";\n\n        processedStream.addSink(JdbcSink.sink(\n                insertSql,\n                new JdbcStatementBuilder<TargetOrderItem>() {\n                    @Override\n                    public void accept(PreparedStatement ps, TargetOrderItem item) throws SQLException {\n                        ps.setInt(1, item.orderId);\n                        ps.setString(2, item.customerName);\n                        ps.setInt(3, item.productId);\n                    }\n                },\n                JdbcExecutionOptions.builder()\n                        .withBatchSize(100)          // 批处理大小，提高性能\n                        .withBatchIntervalMs(200)    // 批处理间隔\n                        .withMaxRetries(3)           // 重试次数\n                        .build(),\n                new JdbcConnectionOptions.JdbcConnectionOptionsBuilder()\n                        .withUrl(\"jdbc:mysql://localhost:3306/db_target\")\n                        .withDriverName(\"com.mysql.cj.jdbc.Driver\")\n                        .withUsername(\"root\")\n                        .withPassword(\"123456\")\n                        .build()\n        ));\n\n        // 4. 启动任务\n        env.execute(\"MySQL Sync Job 1-to-N\");\n    }\n}\n\n```\n\n### 关键点解析\n\n1. **JsonDebeziumDeserializationSchema**:\n* CDC 捕获的数据是复杂的 Debezium 格式。使用这个反序列化器，你会得到类似这样的 JSON 字符串：\n```json\n{\n  \"before\": null,\n  \"after\": { \"id\": 1, \"customer_name\": \"Alice\", \"product_ids\": \"101,102\" },\n  \"source\": { ... },\n  \"op\": \"c\",\n  \"ts_ms\": 16788888888\n}\n\n```\n\n\n* 在 `FlatMap` 中，我们解析 `after` 字段拿到最新的数据。\n\n\n2. **FlatMap 算子 (核心)**:\n* 这就是你实现“任意业务逻辑”的地方。\n* 你可以写 `if-else`，可以查缓存，可以做字符串 `split`，完全自由。\n* `out.collect(item)` 可以被调用多次，从而实现 **1 条源数据 -> N 条目标数据**。\n\n\n3. **Sink 性能优化**:\n* `JdbcSink` 支持 `withBatchSize`。这非常重要，它不会每来一条数据就插库一次，而是攒够比如 100 条或者过了 200ms 再批量插入，能极大提升吞吐量。\n\n\n\n### 如何运行\n\n1. **准备数据库**: 在本地 MySQL 创建好 `db_source.orders` 和 `db_target.order_items`。\n2. **开启 Binlog**: 确保源 MySQL 开启了 Binlog (`log_bin=mysql-bin`, `binlog_format=ROW`)。\n3. **运行代码**: 在 IDE 中直接运行 `main` 方法。\n4. **测试**:\n* 向 `db_source.orders` 插入一条: `INSERT INTO orders VALUES (1, 'Bob', 'A,B,C');`\n* 查看控制台无报错。\n* 查看 `db_target.order_items`，应该瞬间出现 3 条记录 (Bob-A, Bob-B, Bob-C)。\n","source":"_posts/flink/异构系统实时数据同步方案.md","raw":"---\ntitle: 异构系统实时数据同步方案\ndate: 2025-12-22 17:40:10\ncategories: flink\ntag: 实时数据同步\n---\n这里为你编写一个基于 **Java Flink DataStream API** 的完整代码样例。\n\n这种方式（Code 模式）比单纯的 SQL 模式更适合你提到的“数据对应关系不一样”和“一对多”的复杂业务逻辑，因为它允许你编写任意的 Java 代码来处理数据转换。\n\n### 场景假设\n\n假设我们有一个**源订单表**（一条记录包含多个商品ID），需要拆分同步到**目标详情表**（每个商品一条记录）。\n\n* **源表 (MySQL - db_source.orders):**\n* `id` (INT, PK)\n* `customer_name` (VARCHAR)\n* `product_ids` (VARCHAR) -> 例如: `\"101,102,103\"`\n\n\n* **目标表 (MySQL - db_target.order_items):**\n* `id` (INT, Auto Increment PK)\n* `order_id` (INT)\n* `customer_name` (VARCHAR)\n* `single_product_id` (INT) -> 需要存 3 条记录: 101, 102, 103\n\n\n\n---\n\n### 1. Maven 依赖配置 (`pom.xml`)\n\n你需要引入 Flink 核心库、Flink CDC 连接器和 JDBC 连接器。\n\n```xml\n<dependencies>\n    <dependency>\n        <groupId>org.apache.flink</groupId>\n        <artifactId>flink-streaming-java</artifactId>\n        <version>1.17.1</version>\n    </dependency>\n    <dependency>\n        <groupId>org.apache.flink</groupId>\n        <artifactId>flink-clients</artifactId>\n        <version>1.17.1</version>\n    </dependency>\n\n    <dependency>\n        <groupId>com.ververica</groupId>\n        <artifactId>flink-connector-mysql-cdc</artifactId>\n        <version>2.4.1</version>\n    </dependency>\n\n    <dependency>\n        <groupId>org.apache.flink</groupId>\n        <artifactId>flink-connector-jdbc</artifactId>\n        <version>3.1.1-1.17</version>\n    </dependency>\n    \n    <dependency>\n        <groupId>mysql</groupId>\n        <artifactId>mysql-connector-java</artifactId>\n        <version>8.0.28</version>\n    </dependency>\n\n    <dependency>\n        <groupId>com.alibaba</groupId>\n        <artifactId>fastjson</artifactId>\n        <version>1.2.83</version>\n    </dependency>\n</dependencies>\n\n```\n\n---\n\n### 2. 完整 Java 代码实现\n\n这个程序由三个部分组成：**Source (CDC 读取)** -> **Transform (拆分逻辑)** -> **Sink (写入目标)**。\n\n```java\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONObject;\nimport com.ververica.cdc.connectors.mysql.source.MySqlSource;\nimport com.ververica.cdc.connectors.mysql.table.StartupOptions;\nimport com.ververica.cdc.debezium.JsonDebeziumDeserializationSchema;\nimport org.apache.flink.api.common.eventtime.WatermarkStrategy;\nimport org.apache.flink.api.common.functions.FlatMapFunction;\nimport org.apache.flink.connector.jdbc.JdbcConnectionOptions;\nimport org.apache.flink.connector.jdbc.JdbcExecutionOptions;\nimport org.apache.flink.connector.jdbc.JdbcSink;\nimport org.apache.flink.connector.jdbc.JdbcStatementBuilder;\nimport org.apache.flink.streaming.api.datastream.DataStreamSource;\nimport org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;\nimport org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\nimport org.apache.flink.util.Collector;\n\nimport java.sql.PreparedStatement;\nimport java.sql.SQLException;\n\n// 1. 定义目标数据的实体类 (POJO)\nclass TargetOrderItem {\n    public int orderId;\n    public String customerName;\n    public int productId;\n\n    public TargetOrderItem(int orderId, String customerName, int productId) {\n        this.orderId = orderId;\n        this.customerName = customerName;\n        this.productId = productId;\n    }\n}\n\npublic class MySqlSyncJob {\n    public static void main(String[] args) throws Exception {\n        \n        // 1. 获取执行环境\n        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n        env.setParallelism(1); // 生产环境根据数据量调整，测试用 1\n\n        // =================================================================\n        // STEP 1: 定义 Source (Flink CDC)\n        // =================================================================\n        MySqlSource<String> mySqlSource = MySqlSource.<String>builder()\n                .hostname(\"localhost\")\n                .port(3306)\n                .databaseList(\"db_source\") // 监控的数据库\n                .tableList(\"db_source.orders\") // 监控的表\n                .username(\"root\")\n                .password(\"123456\")\n                // initial() 会先读取全量历史数据，然后切换到 Binlog 读取增量\n                .startupOptions(StartupOptions.initial()) \n                .deserializer(new JsonDebeziumDeserializationSchema()) // 转成 JSON 字符串处理\n                .build();\n\n        DataStreamSource<String> rawStream = env.fromSource(\n                mySqlSource, \n                WatermarkStrategy.noWatermarks(), \n                \"MySQL CDC Source\"\n        );\n\n        // =================================================================\n        // STEP 2: Transform (核心业务逻辑：1转N)\n        // =================================================================\n        SingleOutputStreamOperator<TargetOrderItem> processedStream = rawStream.flatMap(new FlatMapFunction<String, TargetOrderItem>() {\n            @Override\n            public void flatMap(String value, Collector<TargetOrderItem> out) throws Exception {\n                try {\n                    // 1. 解析 CDC 的 JSON 数据\n                    JSONObject json = JSON.parseObject(value);\n                    \n                    // CDC JSON 结构通常包含 \"before\", \"after\", \"op\" (操作类型)\n                    // 我们主要关注 \"after\" (变更后的数据) 和 \"op\"\n                    // op: c (create), u (update), d (delete), r (read/snapshot)\n                    \n                    JSONObject after = json.getJSONObject(\"after\");\n                    String op = json.getString(\"op\");\n\n                    // 简单起见，这里只处理新增(c, r)和更新(u)，忽略删除(d)\n                    // 如果 after 为 null (例如删除操作)，则跳过\n                    if (after == null) {\n                        return;\n                    }\n\n                    // 2. 提取源字段\n                    Integer orderId = after.getInteger(\"id\");\n                    String customerName = after.getString(\"customer_name\");\n                    String productIdsStr = after.getString(\"product_ids\"); // \"101,102,103\"\n\n                    // 3. 执行 1转N 的业务逻辑\n                    if (productIdsStr != null && !productIdsStr.isEmpty()) {\n                        String[] ids = productIdsStr.split(\",\");\n                        for (String id : ids) {\n                            // 构造目标对象\n                            TargetOrderItem item = new TargetOrderItem(\n                                    orderId,\n                                    customerName,\n                                    Integer.parseInt(id.trim())\n                            );\n                            // 发送往下游\n                            out.collect(item);\n                        }\n                    }\n\n                } catch (Exception e) {\n                    // 生产环境建议记录错误日志到侧输出流(SideOutput)，不要直接抛出导致任务挂掉\n                    System.err.println(\"解析错误: \" + value);\n                    e.printStackTrace();\n                }\n            }\n        });\n\n        // =================================================================\n        // STEP 3: Sink (写入目标数据库)\n        // =================================================================\n        String insertSql = \"INSERT INTO order_items (order_id, customer_name, single_product_id) VALUES (?, ?, ?)\";\n        \n        // 如果需要幂等性（防止重复写入），建议使用 \"INSERT ... ON DUPLICATE KEY UPDATE\"\n        // String upsertSql = \"INSERT INTO order_items ... VALUES ... ON DUPLICATE KEY UPDATE ...\";\n\n        processedStream.addSink(JdbcSink.sink(\n                insertSql,\n                new JdbcStatementBuilder<TargetOrderItem>() {\n                    @Override\n                    public void accept(PreparedStatement ps, TargetOrderItem item) throws SQLException {\n                        ps.setInt(1, item.orderId);\n                        ps.setString(2, item.customerName);\n                        ps.setInt(3, item.productId);\n                    }\n                },\n                JdbcExecutionOptions.builder()\n                        .withBatchSize(100)          // 批处理大小，提高性能\n                        .withBatchIntervalMs(200)    // 批处理间隔\n                        .withMaxRetries(3)           // 重试次数\n                        .build(),\n                new JdbcConnectionOptions.JdbcConnectionOptionsBuilder()\n                        .withUrl(\"jdbc:mysql://localhost:3306/db_target\")\n                        .withDriverName(\"com.mysql.cj.jdbc.Driver\")\n                        .withUsername(\"root\")\n                        .withPassword(\"123456\")\n                        .build()\n        ));\n\n        // 4. 启动任务\n        env.execute(\"MySQL Sync Job 1-to-N\");\n    }\n}\n\n```\n\n### 关键点解析\n\n1. **JsonDebeziumDeserializationSchema**:\n* CDC 捕获的数据是复杂的 Debezium 格式。使用这个反序列化器，你会得到类似这样的 JSON 字符串：\n```json\n{\n  \"before\": null,\n  \"after\": { \"id\": 1, \"customer_name\": \"Alice\", \"product_ids\": \"101,102\" },\n  \"source\": { ... },\n  \"op\": \"c\",\n  \"ts_ms\": 16788888888\n}\n\n```\n\n\n* 在 `FlatMap` 中，我们解析 `after` 字段拿到最新的数据。\n\n\n2. **FlatMap 算子 (核心)**:\n* 这就是你实现“任意业务逻辑”的地方。\n* 你可以写 `if-else`，可以查缓存，可以做字符串 `split`，完全自由。\n* `out.collect(item)` 可以被调用多次，从而实现 **1 条源数据 -> N 条目标数据**。\n\n\n3. **Sink 性能优化**:\n* `JdbcSink` 支持 `withBatchSize`。这非常重要，它不会每来一条数据就插库一次，而是攒够比如 100 条或者过了 200ms 再批量插入，能极大提升吞吐量。\n\n\n\n### 如何运行\n\n1. **准备数据库**: 在本地 MySQL 创建好 `db_source.orders` 和 `db_target.order_items`。\n2. **开启 Binlog**: 确保源 MySQL 开启了 Binlog (`log_bin=mysql-bin`, `binlog_format=ROW`)。\n3. **运行代码**: 在 IDE 中直接运行 `main` 方法。\n4. **测试**:\n* 向 `db_source.orders` 插入一条: `INSERT INTO orders VALUES (1, 'Bob', 'A,B,C');`\n* 查看控制台无报错。\n* 查看 `db_target.order_items`，应该瞬间出现 3 条记录 (Bob-A, Bob-B, Bob-C)。\n","slug":"flink/异构系统实时数据同步方案","published":1,"updated":"2025-12-22T09:41:19.360Z","comments":1,"layout":"post","photos":[],"_id":"cmjgyvrny0004kd0v4efwalqi","content":"<p>这里为你编写一个基于 <strong>Java Flink DataStream API</strong> 的完整代码样例。</p>\n<p>这种方式（Code 模式）比单纯的 SQL 模式更适合你提到的“数据对应关系不一样”和“一对多”的复杂业务逻辑，因为它允许你编写任意的 Java 代码来处理数据转换。</p>\n<h3 id=\"场景假设\"><a href=\"#场景假设\" class=\"headerlink\" title=\"场景假设\"></a>场景假设</h3><p>假设我们有一个<strong>源订单表</strong>（一条记录包含多个商品ID），需要拆分同步到<strong>目标详情表</strong>（每个商品一条记录）。</p>\n<ul>\n<li><p><strong>源表 (MySQL - db_source.orders):</strong></p>\n</li>\n<li><p><code>id</code> (INT, PK)</p>\n</li>\n<li><p><code>customer_name</code> (VARCHAR)</p>\n</li>\n<li><p><code>product_ids</code> (VARCHAR) -&gt; 例如: <code>&quot;101,102,103&quot;</code></p>\n</li>\n<li><p><strong>目标表 (MySQL - db_target.order_items):</strong></p>\n</li>\n<li><p><code>id</code> (INT, Auto Increment PK)</p>\n</li>\n<li><p><code>order_id</code> (INT)</p>\n</li>\n<li><p><code>customer_name</code> (VARCHAR)</p>\n</li>\n<li><p><code>single_product_id</code> (INT) -&gt; 需要存 3 条记录: 101, 102, 103</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"1-Maven-依赖配置-pom-xml\"><a href=\"#1-Maven-依赖配置-pom-xml\" class=\"headerlink\" title=\"1. Maven 依赖配置 (pom.xml)\"></a>1. Maven 依赖配置 (<code>pom.xml</code>)</h3><p>你需要引入 Flink 核心库、Flink CDC 连接器和 JDBC 连接器。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.flink<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flink-streaming-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.17.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.flink<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flink-clients<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.17.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.ververica<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flink-connector-mysql-cdc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.4.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.flink<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flink-connector-jdbc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.1.1-1.17<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>mysql<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>8.0.28<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.alibaba<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>fastjson<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2.83<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"2-完整-Java-代码实现\"><a href=\"#2-完整-Java-代码实现\" class=\"headerlink\" title=\"2. 完整 Java 代码实现\"></a>2. 完整 Java 代码实现</h3><p>这个程序由三个部分组成：<strong>Source (CDC 读取)</strong> -&gt; <strong>Transform (拆分逻辑)</strong> -&gt; **Sink (写入目标)**。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSON;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ververica.cdc.connectors.mysql.source.MySqlSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ververica.cdc.connectors.mysql.table.StartupOptions;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ververica.cdc.debezium.JsonDebeziumDeserializationSchema;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.api.common.eventtime.WatermarkStrategy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.connector.jdbc.JdbcConnectionOptions;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.connector.jdbc.JdbcExecutionOptions;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.connector.jdbc.JdbcSink;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.connector.jdbc.JdbcStatementBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.util.Collector;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.sql.PreparedStatement;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.sql.SQLException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 1. 定义目标数据的实体类 (POJO)</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">TargetOrderItem</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> orderId;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String customerName;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> productId;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">TargetOrderItem</span><span class=\"params\">(<span class=\"type\">int</span> orderId, String customerName, <span class=\"type\">int</span> productId)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.orderId = orderId;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.customerName = customerName;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.productId = productId;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MySqlSyncJob</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 1. 获取执行环境</span></span><br><span class=\"line\">        <span class=\"type\">StreamExecutionEnvironment</span> <span class=\"variable\">env</span> <span class=\"operator\">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class=\"line\">        env.setParallelism(<span class=\"number\">1</span>); <span class=\"comment\">// 生产环境根据数据量调整，测试用 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        <span class=\"comment\">// STEP 1: 定义 Source (Flink CDC)</span></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        MySqlSource&lt;String&gt; mySqlSource = MySqlSource.&lt;String&gt;builder()</span><br><span class=\"line\">                .hostname(<span class=\"string\">&quot;localhost&quot;</span>)</span><br><span class=\"line\">                .port(<span class=\"number\">3306</span>)</span><br><span class=\"line\">                .databaseList(<span class=\"string\">&quot;db_source&quot;</span>) <span class=\"comment\">// 监控的数据库</span></span><br><span class=\"line\">                .tableList(<span class=\"string\">&quot;db_source.orders&quot;</span>) <span class=\"comment\">// 监控的表</span></span><br><span class=\"line\">                .username(<span class=\"string\">&quot;root&quot;</span>)</span><br><span class=\"line\">                .password(<span class=\"string\">&quot;123456&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">// initial() 会先读取全量历史数据，然后切换到 Binlog 读取增量</span></span><br><span class=\"line\">                .startupOptions(StartupOptions.initial()) </span><br><span class=\"line\">                .deserializer(<span class=\"keyword\">new</span> <span class=\"title class_\">JsonDebeziumDeserializationSchema</span>()) <span class=\"comment\">// 转成 JSON 字符串处理</span></span><br><span class=\"line\">                .build();</span><br><span class=\"line\"></span><br><span class=\"line\">        DataStreamSource&lt;String&gt; rawStream = env.fromSource(</span><br><span class=\"line\">                mySqlSource, </span><br><span class=\"line\">                WatermarkStrategy.noWatermarks(), </span><br><span class=\"line\">                <span class=\"string\">&quot;MySQL CDC Source&quot;</span></span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        <span class=\"comment\">// STEP 2: Transform (核心业务逻辑：1转N)</span></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        SingleOutputStreamOperator&lt;TargetOrderItem&gt; processedStream = rawStream.flatMap(<span class=\"keyword\">new</span> <span class=\"title class_\">FlatMapFunction</span>&lt;String, TargetOrderItem&gt;() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">flatMap</span><span class=\"params\">(String value, Collector&lt;TargetOrderItem&gt; out)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 1. 解析 CDC 的 JSON 数据</span></span><br><span class=\"line\">                    <span class=\"type\">JSONObject</span> <span class=\"variable\">json</span> <span class=\"operator\">=</span> JSON.parseObject(value);</span><br><span class=\"line\">                    </span><br><span class=\"line\">                    <span class=\"comment\">// CDC JSON 结构通常包含 &quot;before&quot;, &quot;after&quot;, &quot;op&quot; (操作类型)</span></span><br><span class=\"line\">                    <span class=\"comment\">// 我们主要关注 &quot;after&quot; (变更后的数据) 和 &quot;op&quot;</span></span><br><span class=\"line\">                    <span class=\"comment\">// op: c (create), u (update), d (delete), r (read/snapshot)</span></span><br><span class=\"line\">                    </span><br><span class=\"line\">                    <span class=\"type\">JSONObject</span> <span class=\"variable\">after</span> <span class=\"operator\">=</span> json.getJSONObject(<span class=\"string\">&quot;after&quot;</span>);</span><br><span class=\"line\">                    <span class=\"type\">String</span> <span class=\"variable\">op</span> <span class=\"operator\">=</span> json.getString(<span class=\"string\">&quot;op&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 简单起见，这里只处理新增(c, r)和更新(u)，忽略删除(d)</span></span><br><span class=\"line\">                    <span class=\"comment\">// 如果 after 为 null (例如删除操作)，则跳过</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (after == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 2. 提取源字段</span></span><br><span class=\"line\">                    <span class=\"type\">Integer</span> <span class=\"variable\">orderId</span> <span class=\"operator\">=</span> after.getInteger(<span class=\"string\">&quot;id&quot;</span>);</span><br><span class=\"line\">                    <span class=\"type\">String</span> <span class=\"variable\">customerName</span> <span class=\"operator\">=</span> after.getString(<span class=\"string\">&quot;customer_name&quot;</span>);</span><br><span class=\"line\">                    <span class=\"type\">String</span> <span class=\"variable\">productIdsStr</span> <span class=\"operator\">=</span> after.getString(<span class=\"string\">&quot;product_ids&quot;</span>); <span class=\"comment\">// &quot;101,102,103&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 3. 执行 1转N 的业务逻辑</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (productIdsStr != <span class=\"literal\">null</span> &amp;&amp; !productIdsStr.isEmpty()) &#123;</span><br><span class=\"line\">                        String[] ids = productIdsStr.split(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (String id : ids) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">// 构造目标对象</span></span><br><span class=\"line\">                            <span class=\"type\">TargetOrderItem</span> <span class=\"variable\">item</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">TargetOrderItem</span>(</span><br><span class=\"line\">                                    orderId,</span><br><span class=\"line\">                                    customerName,</span><br><span class=\"line\">                                    Integer.parseInt(id.trim())</span><br><span class=\"line\">                            );</span><br><span class=\"line\">                            <span class=\"comment\">// 发送往下游</span></span><br><span class=\"line\">                            out.collect(item);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 生产环境建议记录错误日志到侧输出流(SideOutput)，不要直接抛出导致任务挂掉</span></span><br><span class=\"line\">                    System.err.println(<span class=\"string\">&quot;解析错误: &quot;</span> + value);</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        <span class=\"comment\">// STEP 3: Sink (写入目标数据库)</span></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">insertSql</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;INSERT INTO order_items (order_id, customer_name, single_product_id) VALUES (?, ?, ?)&quot;</span>;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 如果需要幂等性（防止重复写入），建议使用 &quot;INSERT ... ON DUPLICATE KEY UPDATE&quot;</span></span><br><span class=\"line\">        <span class=\"comment\">// String upsertSql = &quot;INSERT INTO order_items ... VALUES ... ON DUPLICATE KEY UPDATE ...&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        processedStream.addSink(JdbcSink.sink(</span><br><span class=\"line\">                insertSql,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">JdbcStatementBuilder</span>&lt;TargetOrderItem&gt;() &#123;</span><br><span class=\"line\">                    <span class=\"meta\">@Override</span></span><br><span class=\"line\">                    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">accept</span><span class=\"params\">(PreparedStatement ps, TargetOrderItem item)</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">                        ps.setInt(<span class=\"number\">1</span>, item.orderId);</span><br><span class=\"line\">                        ps.setString(<span class=\"number\">2</span>, item.customerName);</span><br><span class=\"line\">                        ps.setInt(<span class=\"number\">3</span>, item.productId);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                JdbcExecutionOptions.builder()</span><br><span class=\"line\">                        .withBatchSize(<span class=\"number\">100</span>)          <span class=\"comment\">// 批处理大小，提高性能</span></span><br><span class=\"line\">                        .withBatchIntervalMs(<span class=\"number\">200</span>)    <span class=\"comment\">// 批处理间隔</span></span><br><span class=\"line\">                        .withMaxRetries(<span class=\"number\">3</span>)           <span class=\"comment\">// 重试次数</span></span><br><span class=\"line\">                        .build(),</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">JdbcConnectionOptions</span>.JdbcConnectionOptionsBuilder()</span><br><span class=\"line\">                        .withUrl(<span class=\"string\">&quot;jdbc:mysql://localhost:3306/db_target&quot;</span>)</span><br><span class=\"line\">                        .withDriverName(<span class=\"string\">&quot;com.mysql.cj.jdbc.Driver&quot;</span>)</span><br><span class=\"line\">                        .withUsername(<span class=\"string\">&quot;root&quot;</span>)</span><br><span class=\"line\">                        .withPassword(<span class=\"string\">&quot;123456&quot;</span>)</span><br><span class=\"line\">                        .build()</span><br><span class=\"line\">        ));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 4. 启动任务</span></span><br><span class=\"line\">        env.execute(<span class=\"string\">&quot;MySQL Sync Job 1-to-N&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"关键点解析\"><a href=\"#关键点解析\" class=\"headerlink\" title=\"关键点解析\"></a>关键点解析</h3><ol>\n<li><strong>JsonDebeziumDeserializationSchema</strong>:</li>\n</ol>\n<ul>\n<li><p>CDC 捕获的数据是复杂的 Debezium 格式。使用这个反序列化器，你会得到类似这样的 JSON 字符串：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;before&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">null</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;after&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;id&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;customer_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Alice&quot;</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;product_ids&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;101,102&quot;</span> <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;source&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> ... <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;op&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;c&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ts_ms&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">16788888888</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n</li>\n<li><p>在 <code>FlatMap</code> 中，我们解析 <code>after</code> 字段拿到最新的数据。</p>\n</li>\n</ul>\n<ol start=\"2\">\n<li><strong>FlatMap 算子 (核心)</strong>:</li>\n</ol>\n<ul>\n<li>这就是你实现“任意业务逻辑”的地方。</li>\n<li>你可以写 <code>if-else</code>，可以查缓存，可以做字符串 <code>split</code>，完全自由。</li>\n<li><code>out.collect(item)</code> 可以被调用多次，从而实现 <strong>1 条源数据 -&gt; N 条目标数据</strong>。</li>\n</ul>\n<ol start=\"3\">\n<li><strong>Sink 性能优化</strong>:</li>\n</ol>\n<ul>\n<li><code>JdbcSink</code> 支持 <code>withBatchSize</code>。这非常重要，它不会每来一条数据就插库一次，而是攒够比如 100 条或者过了 200ms 再批量插入，能极大提升吞吐量。</li>\n</ul>\n<h3 id=\"如何运行\"><a href=\"#如何运行\" class=\"headerlink\" title=\"如何运行\"></a>如何运行</h3><ol>\n<li><strong>准备数据库</strong>: 在本地 MySQL 创建好 <code>db_source.orders</code> 和 <code>db_target.order_items</code>。</li>\n<li><strong>开启 Binlog</strong>: 确保源 MySQL 开启了 Binlog (<code>log_bin=mysql-bin</code>, <code>binlog_format=ROW</code>)。</li>\n<li><strong>运行代码</strong>: 在 IDE 中直接运行 <code>main</code> 方法。</li>\n<li><strong>测试</strong>:</li>\n</ol>\n<ul>\n<li>向 <code>db_source.orders</code> 插入一条: <code>INSERT INTO orders VALUES (1, &#39;Bob&#39;, &#39;A,B,C&#39;);</code></li>\n<li>查看控制台无报错。</li>\n<li>查看 <code>db_target.order_items</code>，应该瞬间出现 3 条记录 (Bob-A, Bob-B, Bob-C)。</li>\n</ul>\n","cover":false,"excerpt":"","more":"<p>这里为你编写一个基于 <strong>Java Flink DataStream API</strong> 的完整代码样例。</p>\n<p>这种方式（Code 模式）比单纯的 SQL 模式更适合你提到的“数据对应关系不一样”和“一对多”的复杂业务逻辑，因为它允许你编写任意的 Java 代码来处理数据转换。</p>\n<h3 id=\"场景假设\"><a href=\"#场景假设\" class=\"headerlink\" title=\"场景假设\"></a>场景假设</h3><p>假设我们有一个<strong>源订单表</strong>（一条记录包含多个商品ID），需要拆分同步到<strong>目标详情表</strong>（每个商品一条记录）。</p>\n<ul>\n<li><p><strong>源表 (MySQL - db_source.orders):</strong></p>\n</li>\n<li><p><code>id</code> (INT, PK)</p>\n</li>\n<li><p><code>customer_name</code> (VARCHAR)</p>\n</li>\n<li><p><code>product_ids</code> (VARCHAR) -&gt; 例如: <code>&quot;101,102,103&quot;</code></p>\n</li>\n<li><p><strong>目标表 (MySQL - db_target.order_items):</strong></p>\n</li>\n<li><p><code>id</code> (INT, Auto Increment PK)</p>\n</li>\n<li><p><code>order_id</code> (INT)</p>\n</li>\n<li><p><code>customer_name</code> (VARCHAR)</p>\n</li>\n<li><p><code>single_product_id</code> (INT) -&gt; 需要存 3 条记录: 101, 102, 103</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"1-Maven-依赖配置-pom-xml\"><a href=\"#1-Maven-依赖配置-pom-xml\" class=\"headerlink\" title=\"1. Maven 依赖配置 (pom.xml)\"></a>1. Maven 依赖配置 (<code>pom.xml</code>)</h3><p>你需要引入 Flink 核心库、Flink CDC 连接器和 JDBC 连接器。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.flink<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flink-streaming-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.17.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.flink<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flink-clients<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.17.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.ververica<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flink-connector-mysql-cdc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.4.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.flink<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flink-connector-jdbc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.1.1-1.17<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>mysql<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>8.0.28<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.alibaba<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>fastjson<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2.83<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"2-完整-Java-代码实现\"><a href=\"#2-完整-Java-代码实现\" class=\"headerlink\" title=\"2. 完整 Java 代码实现\"></a>2. 完整 Java 代码实现</h3><p>这个程序由三个部分组成：<strong>Source (CDC 读取)</strong> -&gt; <strong>Transform (拆分逻辑)</strong> -&gt; **Sink (写入目标)**。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSON;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ververica.cdc.connectors.mysql.source.MySqlSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ververica.cdc.connectors.mysql.table.StartupOptions;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.ververica.cdc.debezium.JsonDebeziumDeserializationSchema;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.api.common.eventtime.WatermarkStrategy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.connector.jdbc.JdbcConnectionOptions;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.connector.jdbc.JdbcExecutionOptions;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.connector.jdbc.JdbcSink;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.connector.jdbc.JdbcStatementBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.flink.util.Collector;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.sql.PreparedStatement;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.sql.SQLException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 1. 定义目标数据的实体类 (POJO)</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">TargetOrderItem</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> orderId;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String customerName;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> productId;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">TargetOrderItem</span><span class=\"params\">(<span class=\"type\">int</span> orderId, String customerName, <span class=\"type\">int</span> productId)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.orderId = orderId;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.customerName = customerName;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.productId = productId;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MySqlSyncJob</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 1. 获取执行环境</span></span><br><span class=\"line\">        <span class=\"type\">StreamExecutionEnvironment</span> <span class=\"variable\">env</span> <span class=\"operator\">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class=\"line\">        env.setParallelism(<span class=\"number\">1</span>); <span class=\"comment\">// 生产环境根据数据量调整，测试用 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        <span class=\"comment\">// STEP 1: 定义 Source (Flink CDC)</span></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        MySqlSource&lt;String&gt; mySqlSource = MySqlSource.&lt;String&gt;builder()</span><br><span class=\"line\">                .hostname(<span class=\"string\">&quot;localhost&quot;</span>)</span><br><span class=\"line\">                .port(<span class=\"number\">3306</span>)</span><br><span class=\"line\">                .databaseList(<span class=\"string\">&quot;db_source&quot;</span>) <span class=\"comment\">// 监控的数据库</span></span><br><span class=\"line\">                .tableList(<span class=\"string\">&quot;db_source.orders&quot;</span>) <span class=\"comment\">// 监控的表</span></span><br><span class=\"line\">                .username(<span class=\"string\">&quot;root&quot;</span>)</span><br><span class=\"line\">                .password(<span class=\"string\">&quot;123456&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">// initial() 会先读取全量历史数据，然后切换到 Binlog 读取增量</span></span><br><span class=\"line\">                .startupOptions(StartupOptions.initial()) </span><br><span class=\"line\">                .deserializer(<span class=\"keyword\">new</span> <span class=\"title class_\">JsonDebeziumDeserializationSchema</span>()) <span class=\"comment\">// 转成 JSON 字符串处理</span></span><br><span class=\"line\">                .build();</span><br><span class=\"line\"></span><br><span class=\"line\">        DataStreamSource&lt;String&gt; rawStream = env.fromSource(</span><br><span class=\"line\">                mySqlSource, </span><br><span class=\"line\">                WatermarkStrategy.noWatermarks(), </span><br><span class=\"line\">                <span class=\"string\">&quot;MySQL CDC Source&quot;</span></span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        <span class=\"comment\">// STEP 2: Transform (核心业务逻辑：1转N)</span></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        SingleOutputStreamOperator&lt;TargetOrderItem&gt; processedStream = rawStream.flatMap(<span class=\"keyword\">new</span> <span class=\"title class_\">FlatMapFunction</span>&lt;String, TargetOrderItem&gt;() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">flatMap</span><span class=\"params\">(String value, Collector&lt;TargetOrderItem&gt; out)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 1. 解析 CDC 的 JSON 数据</span></span><br><span class=\"line\">                    <span class=\"type\">JSONObject</span> <span class=\"variable\">json</span> <span class=\"operator\">=</span> JSON.parseObject(value);</span><br><span class=\"line\">                    </span><br><span class=\"line\">                    <span class=\"comment\">// CDC JSON 结构通常包含 &quot;before&quot;, &quot;after&quot;, &quot;op&quot; (操作类型)</span></span><br><span class=\"line\">                    <span class=\"comment\">// 我们主要关注 &quot;after&quot; (变更后的数据) 和 &quot;op&quot;</span></span><br><span class=\"line\">                    <span class=\"comment\">// op: c (create), u (update), d (delete), r (read/snapshot)</span></span><br><span class=\"line\">                    </span><br><span class=\"line\">                    <span class=\"type\">JSONObject</span> <span class=\"variable\">after</span> <span class=\"operator\">=</span> json.getJSONObject(<span class=\"string\">&quot;after&quot;</span>);</span><br><span class=\"line\">                    <span class=\"type\">String</span> <span class=\"variable\">op</span> <span class=\"operator\">=</span> json.getString(<span class=\"string\">&quot;op&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 简单起见，这里只处理新增(c, r)和更新(u)，忽略删除(d)</span></span><br><span class=\"line\">                    <span class=\"comment\">// 如果 after 为 null (例如删除操作)，则跳过</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (after == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 2. 提取源字段</span></span><br><span class=\"line\">                    <span class=\"type\">Integer</span> <span class=\"variable\">orderId</span> <span class=\"operator\">=</span> after.getInteger(<span class=\"string\">&quot;id&quot;</span>);</span><br><span class=\"line\">                    <span class=\"type\">String</span> <span class=\"variable\">customerName</span> <span class=\"operator\">=</span> after.getString(<span class=\"string\">&quot;customer_name&quot;</span>);</span><br><span class=\"line\">                    <span class=\"type\">String</span> <span class=\"variable\">productIdsStr</span> <span class=\"operator\">=</span> after.getString(<span class=\"string\">&quot;product_ids&quot;</span>); <span class=\"comment\">// &quot;101,102,103&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 3. 执行 1转N 的业务逻辑</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (productIdsStr != <span class=\"literal\">null</span> &amp;&amp; !productIdsStr.isEmpty()) &#123;</span><br><span class=\"line\">                        String[] ids = productIdsStr.split(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (String id : ids) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">// 构造目标对象</span></span><br><span class=\"line\">                            <span class=\"type\">TargetOrderItem</span> <span class=\"variable\">item</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">TargetOrderItem</span>(</span><br><span class=\"line\">                                    orderId,</span><br><span class=\"line\">                                    customerName,</span><br><span class=\"line\">                                    Integer.parseInt(id.trim())</span><br><span class=\"line\">                            );</span><br><span class=\"line\">                            <span class=\"comment\">// 发送往下游</span></span><br><span class=\"line\">                            out.collect(item);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 生产环境建议记录错误日志到侧输出流(SideOutput)，不要直接抛出导致任务挂掉</span></span><br><span class=\"line\">                    System.err.println(<span class=\"string\">&quot;解析错误: &quot;</span> + value);</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        <span class=\"comment\">// STEP 3: Sink (写入目标数据库)</span></span><br><span class=\"line\">        <span class=\"comment\">// =================================================================</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">insertSql</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;INSERT INTO order_items (order_id, customer_name, single_product_id) VALUES (?, ?, ?)&quot;</span>;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 如果需要幂等性（防止重复写入），建议使用 &quot;INSERT ... ON DUPLICATE KEY UPDATE&quot;</span></span><br><span class=\"line\">        <span class=\"comment\">// String upsertSql = &quot;INSERT INTO order_items ... VALUES ... ON DUPLICATE KEY UPDATE ...&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        processedStream.addSink(JdbcSink.sink(</span><br><span class=\"line\">                insertSql,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">JdbcStatementBuilder</span>&lt;TargetOrderItem&gt;() &#123;</span><br><span class=\"line\">                    <span class=\"meta\">@Override</span></span><br><span class=\"line\">                    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">accept</span><span class=\"params\">(PreparedStatement ps, TargetOrderItem item)</span> <span class=\"keyword\">throws</span> SQLException &#123;</span><br><span class=\"line\">                        ps.setInt(<span class=\"number\">1</span>, item.orderId);</span><br><span class=\"line\">                        ps.setString(<span class=\"number\">2</span>, item.customerName);</span><br><span class=\"line\">                        ps.setInt(<span class=\"number\">3</span>, item.productId);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                JdbcExecutionOptions.builder()</span><br><span class=\"line\">                        .withBatchSize(<span class=\"number\">100</span>)          <span class=\"comment\">// 批处理大小，提高性能</span></span><br><span class=\"line\">                        .withBatchIntervalMs(<span class=\"number\">200</span>)    <span class=\"comment\">// 批处理间隔</span></span><br><span class=\"line\">                        .withMaxRetries(<span class=\"number\">3</span>)           <span class=\"comment\">// 重试次数</span></span><br><span class=\"line\">                        .build(),</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">JdbcConnectionOptions</span>.JdbcConnectionOptionsBuilder()</span><br><span class=\"line\">                        .withUrl(<span class=\"string\">&quot;jdbc:mysql://localhost:3306/db_target&quot;</span>)</span><br><span class=\"line\">                        .withDriverName(<span class=\"string\">&quot;com.mysql.cj.jdbc.Driver&quot;</span>)</span><br><span class=\"line\">                        .withUsername(<span class=\"string\">&quot;root&quot;</span>)</span><br><span class=\"line\">                        .withPassword(<span class=\"string\">&quot;123456&quot;</span>)</span><br><span class=\"line\">                        .build()</span><br><span class=\"line\">        ));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 4. 启动任务</span></span><br><span class=\"line\">        env.execute(<span class=\"string\">&quot;MySQL Sync Job 1-to-N&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"关键点解析\"><a href=\"#关键点解析\" class=\"headerlink\" title=\"关键点解析\"></a>关键点解析</h3><ol>\n<li><strong>JsonDebeziumDeserializationSchema</strong>:</li>\n</ol>\n<ul>\n<li><p>CDC 捕获的数据是复杂的 Debezium 格式。使用这个反序列化器，你会得到类似这样的 JSON 字符串：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;before&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">null</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;after&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;id&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;customer_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Alice&quot;</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;product_ids&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;101,102&quot;</span> <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;source&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> ... <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;op&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;c&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ts_ms&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">16788888888</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n</li>\n<li><p>在 <code>FlatMap</code> 中，我们解析 <code>after</code> 字段拿到最新的数据。</p>\n</li>\n</ul>\n<ol start=\"2\">\n<li><strong>FlatMap 算子 (核心)</strong>:</li>\n</ol>\n<ul>\n<li>这就是你实现“任意业务逻辑”的地方。</li>\n<li>你可以写 <code>if-else</code>，可以查缓存，可以做字符串 <code>split</code>，完全自由。</li>\n<li><code>out.collect(item)</code> 可以被调用多次，从而实现 <strong>1 条源数据 -&gt; N 条目标数据</strong>。</li>\n</ul>\n<ol start=\"3\">\n<li><strong>Sink 性能优化</strong>:</li>\n</ol>\n<ul>\n<li><code>JdbcSink</code> 支持 <code>withBatchSize</code>。这非常重要，它不会每来一条数据就插库一次，而是攒够比如 100 条或者过了 200ms 再批量插入，能极大提升吞吐量。</li>\n</ul>\n<h3 id=\"如何运行\"><a href=\"#如何运行\" class=\"headerlink\" title=\"如何运行\"></a>如何运行</h3><ol>\n<li><strong>准备数据库</strong>: 在本地 MySQL 创建好 <code>db_source.orders</code> 和 <code>db_target.order_items</code>。</li>\n<li><strong>开启 Binlog</strong>: 确保源 MySQL 开启了 Binlog (<code>log_bin=mysql-bin</code>, <code>binlog_format=ROW</code>)。</li>\n<li><strong>运行代码</strong>: 在 IDE 中直接运行 <code>main</code> 方法。</li>\n<li><strong>测试</strong>:</li>\n</ol>\n<ul>\n<li>向 <code>db_source.orders</code> 插入一条: <code>INSERT INTO orders VALUES (1, &#39;Bob&#39;, &#39;A,B,C&#39;);</code></li>\n<li>查看控制台无报错。</li>\n<li>查看 <code>db_target.order_items</code>，应该瞬间出现 3 条记录 (Bob-A, Bob-B, Bob-C)。</li>\n</ul>\n"},{"title":"grafana+prometheus+springboot监控平台","date":"2025-12-03T03:10:13.000Z","_content":"好的，我现在提供一个完整的 Spring Boot 项目结构，您可以直接创建文件并运行。\n\n请确保您的项目使用 **Java 17+** 和 **Spring Boot 3.x**，或使用兼容的旧版本。\n\n### 1\\. 项目依赖文件：`pom.xml` (Maven)\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" \n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>3.2.0</version> <relativePath/> \n    </parent>\n    <groupId>com.example</groupId>\n    <artifactId>grafana-metric-demo</artifactId>\n    <version>0.0.1-SNAPSHOT</version>\n    <name>grafana-metric-demo</name>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-actuator</artifactId>\n        </dependency>\n        \n        <dependency>\n            <groupId>io.micrometer</groupId>\n            <artifactId>micrometer-registry-prometheus</artifactId>\n        </dependency>\n        \n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n\n</project>\n```\n\n### 2\\. 配置文件：`src/main/resources/application.properties`\n\n```properties\n# 启用所有 Actuator 端点（包括 /metrics, /prometheus 等）\nmanagement.endpoints.web.exposure.include=*\n\n# 确保 Prometheus 端点是启用的\nmanagement.endpoint.prometheus.enabled=true\n\n# 设置应用端口\nserver.port=8080\n```\n\n### 3\\. 指标服务：`src/main/java/com/example/demo/AccountMetricService.java`\n\n(假设您的包名为 `com.example.demo`)\n\n```java\npackage com.example.demo;\n\nimport io.micrometer.core.instrument.Counter;\nimport io.micrometer.core.instrument.MeterRegistry;\nimport io.micrometer.core.instrument.Tags;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class AccountMetricService {\n\n    private final MeterRegistry meterRegistry;\n\n    public AccountMetricService(MeterRegistry meterRegistry) {\n        this.meterRegistry = meterRegistry;\n    }\n\n    /**\n     * 对特定错误进行埋点计数：account.error.count\n     * * @param type 错误的分类 (例如：\"validation\", \"database\")\n     * @param errorMessage 具体的错误信息 (例如：\"UserNotFound\")\n     */\n    public void recordError(String type, String errorMessage) {\n        \n        // 使用 Counter.builder() 来创建或获取一个已注册的 Counter\n        Counter.builder(\"account.error.count\")\n               .description(\"Counts errors in the account service by type and message\")\n               // 动态添加标签 (Tags)\n               .tags(\n                   \"tag_type\", type == null ? \"unknown\" : type,\n                   \"tag_error\", errorMessage\n               )\n               .register(meterRegistry)\n               .increment(); // 执行计数加 1\n        \n        System.out.println(\"--- 埋点计数: type=\" + type + \", error=\" + errorMessage + \" ---\");\n    }\n}\n```\n\n### 4\\. 测试接口：`src/main/java/com/example/demo/MetricTestController.java`\n\n我们创建一个 Controller 来模拟业务逻辑，方便通过浏览器或 cURL 来触发计数器。\n\n```java\npackage com.example.demo;\n\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class MetricTestController {\n\n    private final AccountMetricService metricService;\n\n    public MetricTestController(AccountMetricService metricService) {\n        this.metricService = metricService;\n    }\n\n    /**\n     * 访问此接口来触发错误计数。\n     * 示例 URL: http://localhost:8080/record-error?type=database&msg=ConnectionTimeout\n     * 示例 URL: http://localhost:8080/record-error?type=validation&msg=InvalidEmail\n     */\n    @GetMapping(\"/record-error\")\n    public String recordError(\n            @RequestParam(defaultValue = \"unknown\") String type,\n            @RequestParam(defaultValue = \"generic\") String msg) {\n        \n        metricService.recordError(type, msg);\n        \n        return \"Error count recorded successfully for type: \" + type + \", message: \" + msg;\n    }\n    \n    /**\n     * 访问此接口来触发一个成功的调用 (不计数)\n     */\n    @GetMapping(\"/success\")\n    public String success() {\n        return \"Success operation.\";\n    }\n}\n```\n\n### 5\\. 启动类：`src/main/java/com/example/demo/DemoApplication.java`\n\n标准的 Spring Boot 启动类。\n\n```java\npackage com.example.demo;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\npublic class DemoApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(DemoApplication.class, args);\n    }\n\n}\n```\n\n-----\n\n### 🚀 运行与验证\n\n1.  **运行项目**：在 IDE (如 IntelliJ IDEA) 中运行 `DemoApplication.java` 的 `main` 方法，或使用 Maven 命令 `mvn spring-boot:run`。\n2.  **触发计数**：在浏览器或命令行中多次访问以下 URL，以模拟不同类型的错误：\n    * `http://localhost:8080/record-error?type=database&msg=ConnectionTimeout`\n    * `http://localhost:8080/record-error?type=validation&msg=InvalidEmail`\n    * `http://localhost:8080/record-error?type=database&msg=ConnectionTimeout` (再访问一次)\n3.  **验证指标暴露**：访问 Prometheus 端点，检查指标数据是否已生成：\n    * `http://localhost:8080/actuator/prometheus`\n\n您应该能在输出中找到类似以下格式的数据（注意名字变成了 `account_error_count_total`）：\n\n```\n# TYPE account_error_count_total counter\naccount_error_count_total{error_msg=\"ConnectionTimeout\", tag_type=\"database\"} 2.0\naccount_error_count_total{error_msg=\"InvalidEmail\", tag_type=\"validation\"} 1.0\n```\n\n现在，我们有了实际运行的数据。下一步就是 **配置 Grafana 连接到这个数据源并创建图表**\n\n\n这是一个非常重要的步骤，我们将配置 Grafana 和 Prometheus，把你的 Spring Boot 应用真正连接到可视化界面。\n\n要实现这个目标，我们必须引入中间层 **Prometheus**，它负责定时去你的 Spring Boot 应用（`http://localhost:8080/actuator/prometheus`）拉取（Scrape）数据，然后 Grafana 再从 Prometheus 获取这些时序数据。\n\n### 架构概览\n\n$$\\text{Spring Boot (Metrics Source)} \\xrightarrow{\\text{Scrape at 8080/actuator/prometheus}} \\text{Prometheus (Time-Series DB)} \\xrightarrow{\\text{Query}} \\text{Grafana (Visualization)}$$\n\n假设你已经安装了 Docker，以下是配置和查询的详细步骤。\n\n-----\n\n## 步骤一：配置 Prometheus 采集目标\n\n我们需要告诉 Prometheus 服务器，你的 Spring Boot 应用在哪里。\n\n### 1\\. 创建 Prometheus 配置文件 (`prometheus.yml`)\n\n在您的工作目录下创建一个名为 `prometheus.yml` 的文件，内容如下。这个配置将 Prometheus 服务器设置为每隔 5 秒去采集您的 Spring Boot 应用的指标。\n\n```yaml\nglobal:\n  # 每隔 5 秒评估一次规则和采集数据\n  scrape_interval: 5s \n\nscrape_configs:\n  # Prometheus 自身的监控\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090'] # Prometheus 默认端口\n      \n  # 您的 Spring Boot 应用监控\n  - job_name: 'spring-boot-app'\n    # 假设您的应用运行在本地 8080 端口\n    static_configs:\n      - targets: ['host.docker.internal:8080'] \n    # 指标路径，Actuator 默认暴露在这个路径\n    metrics_path: '/actuator/prometheus'\n```\n\n> **注意：** `host.docker.internal` 是 Docker 容器内部访问宿主机 `localhost` 的特殊地址。\n\n## 步骤二：启动 Prometheus 和 Grafana\n\n为了快速搭建环境，我们使用 Docker Compose 启动 Grafana 和 Prometheus。\n\n### 2\\. 创建 Docker Compose 文件 (`docker-compose.yml`)\n\n```yaml\nversion: '3.7'\n\nservices:\n  prometheus:\n    image: prom/prometheus:latest\n    container_name: prometheus\n    ports:\n      - \"9090:9090\"\n    volumes:\n      # 挂载我们上面创建的配置文件\n      - ./prometheus.yml:/etc/prometheus/prometheus.yml\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n    networks:\n      - monitoring-net\n\n  grafana:\n    image: grafana/grafana:latest\n    container_name: grafana\n    ports:\n      - \"3000:3000\"\n    networks:\n      - monitoring-net\n    depends_on:\n      - prometheus\n      \nnetworks:\n  monitoring-net:\n    driver: bridge\n```\n\n### 3\\. 运行容器\n\n确保你的 Spring Boot 应用正在运行（端口 `8080`），然后在 `prometheus.yml` 和 `docker-compose.yml` 所在的目录运行：\n\n```bash\ndocker-compose up -d\n```\n\n现在，环境已准备就绪：\n\n* **Spring Boot App:** `http://localhost:8080`\n* **Prometheus UI:** `http://localhost:9090`\n* **Grafana UI:** `http://localhost:3000` (默认登录：`admin`/`admin`)\n\n## 步骤三：在 Grafana 中添加数据源\n\n登录 Grafana (默认: `admin/admin`)，然后执行以下操作：\n\n1.  在左侧导航栏，点击 **Settings** (齿轮图标) -\\> **Data Sources**。\n2.  点击 **Add data source**，选择 **Prometheus**。\n3.  在 **HTTP** 部分，填写 Prometheus 服务器的 URL：\n    * **URL:** `http://prometheus:9090` (因为 Grafana 和 Prometheus 在同一个 Docker 网络中，可以直接使用服务名)\n4.  点击底部的 **Save & Test**。如果看到 \"Data source is working\" 的提示，说明连接成功。\n\n## 步骤四：创建仪表盘和可视化\n\n现在我们来创建图表，展示你的 `account.error.count` 指标。\n\n1.  在左侧导航栏，点击 **Dashboards** (四个方块图标) -\\> **New Dashboard** -\\> **Add visualization**。\n\n2.  选择你刚刚配置好的 **Prometheus** 数据源。\n\n3.  在 **Query** (查询) 区域，输入你的 PromQL 查询语句：\n\n    | 目标 | PromQL 查询语句 | 说明 |\n        | :--- | :--- | :--- |\n    | **总错误计数 (Raw Counter)** | `account_error_count_total` | 显示当前累积的总错误次数。|\n    | **每分钟新增错误数 (Rate)** | `rate(account_error_count_total[1m])` | 这是更常用的查询方式。它计算你的计数器在过去 1 分钟内的平均增长率（即每秒新增的错误数）。|\n    | **特定类型错误计数** | `sum by (tag_type) (account_error_count_total)` | 按错误类型 (`tag_type`) 分组求和，可以清楚看到哪种错误最多。|\n    | **过滤特定错误** | `rate(account_error_count_total{tag_type=\"database\"}[1m])` | 仅显示 `tag_type` 为 `database` 的错误增长率。|\n\n4.  选择一个你喜欢的可视化类型，例如 **Graph** 或 **Stat**。\n\n5.  在 Spring Boot 应用中，多访问几次你创建的 `/record-error` 接口来生成数据。\n\n6.  在 Grafana 中，你就能看到数据图表开始实时绘制！\n","source":"_posts/spring-boot/grafana-prometheus-springboot监控平台.md","raw":"---\ntitle: grafana+prometheus+springboot监控平台\ndate: 2025-12-03 11:10:13\ncategories: spring-boot\ntag: grafana,prometheus,springboot\n---\n好的，我现在提供一个完整的 Spring Boot 项目结构，您可以直接创建文件并运行。\n\n请确保您的项目使用 **Java 17+** 和 **Spring Boot 3.x**，或使用兼容的旧版本。\n\n### 1\\. 项目依赖文件：`pom.xml` (Maven)\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" \n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>3.2.0</version> <relativePath/> \n    </parent>\n    <groupId>com.example</groupId>\n    <artifactId>grafana-metric-demo</artifactId>\n    <version>0.0.1-SNAPSHOT</version>\n    <name>grafana-metric-demo</name>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-actuator</artifactId>\n        </dependency>\n        \n        <dependency>\n            <groupId>io.micrometer</groupId>\n            <artifactId>micrometer-registry-prometheus</artifactId>\n        </dependency>\n        \n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n\n</project>\n```\n\n### 2\\. 配置文件：`src/main/resources/application.properties`\n\n```properties\n# 启用所有 Actuator 端点（包括 /metrics, /prometheus 等）\nmanagement.endpoints.web.exposure.include=*\n\n# 确保 Prometheus 端点是启用的\nmanagement.endpoint.prometheus.enabled=true\n\n# 设置应用端口\nserver.port=8080\n```\n\n### 3\\. 指标服务：`src/main/java/com/example/demo/AccountMetricService.java`\n\n(假设您的包名为 `com.example.demo`)\n\n```java\npackage com.example.demo;\n\nimport io.micrometer.core.instrument.Counter;\nimport io.micrometer.core.instrument.MeterRegistry;\nimport io.micrometer.core.instrument.Tags;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class AccountMetricService {\n\n    private final MeterRegistry meterRegistry;\n\n    public AccountMetricService(MeterRegistry meterRegistry) {\n        this.meterRegistry = meterRegistry;\n    }\n\n    /**\n     * 对特定错误进行埋点计数：account.error.count\n     * * @param type 错误的分类 (例如：\"validation\", \"database\")\n     * @param errorMessage 具体的错误信息 (例如：\"UserNotFound\")\n     */\n    public void recordError(String type, String errorMessage) {\n        \n        // 使用 Counter.builder() 来创建或获取一个已注册的 Counter\n        Counter.builder(\"account.error.count\")\n               .description(\"Counts errors in the account service by type and message\")\n               // 动态添加标签 (Tags)\n               .tags(\n                   \"tag_type\", type == null ? \"unknown\" : type,\n                   \"tag_error\", errorMessage\n               )\n               .register(meterRegistry)\n               .increment(); // 执行计数加 1\n        \n        System.out.println(\"--- 埋点计数: type=\" + type + \", error=\" + errorMessage + \" ---\");\n    }\n}\n```\n\n### 4\\. 测试接口：`src/main/java/com/example/demo/MetricTestController.java`\n\n我们创建一个 Controller 来模拟业务逻辑，方便通过浏览器或 cURL 来触发计数器。\n\n```java\npackage com.example.demo;\n\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class MetricTestController {\n\n    private final AccountMetricService metricService;\n\n    public MetricTestController(AccountMetricService metricService) {\n        this.metricService = metricService;\n    }\n\n    /**\n     * 访问此接口来触发错误计数。\n     * 示例 URL: http://localhost:8080/record-error?type=database&msg=ConnectionTimeout\n     * 示例 URL: http://localhost:8080/record-error?type=validation&msg=InvalidEmail\n     */\n    @GetMapping(\"/record-error\")\n    public String recordError(\n            @RequestParam(defaultValue = \"unknown\") String type,\n            @RequestParam(defaultValue = \"generic\") String msg) {\n        \n        metricService.recordError(type, msg);\n        \n        return \"Error count recorded successfully for type: \" + type + \", message: \" + msg;\n    }\n    \n    /**\n     * 访问此接口来触发一个成功的调用 (不计数)\n     */\n    @GetMapping(\"/success\")\n    public String success() {\n        return \"Success operation.\";\n    }\n}\n```\n\n### 5\\. 启动类：`src/main/java/com/example/demo/DemoApplication.java`\n\n标准的 Spring Boot 启动类。\n\n```java\npackage com.example.demo;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\npublic class DemoApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(DemoApplication.class, args);\n    }\n\n}\n```\n\n-----\n\n### 🚀 运行与验证\n\n1.  **运行项目**：在 IDE (如 IntelliJ IDEA) 中运行 `DemoApplication.java` 的 `main` 方法，或使用 Maven 命令 `mvn spring-boot:run`。\n2.  **触发计数**：在浏览器或命令行中多次访问以下 URL，以模拟不同类型的错误：\n    * `http://localhost:8080/record-error?type=database&msg=ConnectionTimeout`\n    * `http://localhost:8080/record-error?type=validation&msg=InvalidEmail`\n    * `http://localhost:8080/record-error?type=database&msg=ConnectionTimeout` (再访问一次)\n3.  **验证指标暴露**：访问 Prometheus 端点，检查指标数据是否已生成：\n    * `http://localhost:8080/actuator/prometheus`\n\n您应该能在输出中找到类似以下格式的数据（注意名字变成了 `account_error_count_total`）：\n\n```\n# TYPE account_error_count_total counter\naccount_error_count_total{error_msg=\"ConnectionTimeout\", tag_type=\"database\"} 2.0\naccount_error_count_total{error_msg=\"InvalidEmail\", tag_type=\"validation\"} 1.0\n```\n\n现在，我们有了实际运行的数据。下一步就是 **配置 Grafana 连接到这个数据源并创建图表**\n\n\n这是一个非常重要的步骤，我们将配置 Grafana 和 Prometheus，把你的 Spring Boot 应用真正连接到可视化界面。\n\n要实现这个目标，我们必须引入中间层 **Prometheus**，它负责定时去你的 Spring Boot 应用（`http://localhost:8080/actuator/prometheus`）拉取（Scrape）数据，然后 Grafana 再从 Prometheus 获取这些时序数据。\n\n### 架构概览\n\n$$\\text{Spring Boot (Metrics Source)} \\xrightarrow{\\text{Scrape at 8080/actuator/prometheus}} \\text{Prometheus (Time-Series DB)} \\xrightarrow{\\text{Query}} \\text{Grafana (Visualization)}$$\n\n假设你已经安装了 Docker，以下是配置和查询的详细步骤。\n\n-----\n\n## 步骤一：配置 Prometheus 采集目标\n\n我们需要告诉 Prometheus 服务器，你的 Spring Boot 应用在哪里。\n\n### 1\\. 创建 Prometheus 配置文件 (`prometheus.yml`)\n\n在您的工作目录下创建一个名为 `prometheus.yml` 的文件，内容如下。这个配置将 Prometheus 服务器设置为每隔 5 秒去采集您的 Spring Boot 应用的指标。\n\n```yaml\nglobal:\n  # 每隔 5 秒评估一次规则和采集数据\n  scrape_interval: 5s \n\nscrape_configs:\n  # Prometheus 自身的监控\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090'] # Prometheus 默认端口\n      \n  # 您的 Spring Boot 应用监控\n  - job_name: 'spring-boot-app'\n    # 假设您的应用运行在本地 8080 端口\n    static_configs:\n      - targets: ['host.docker.internal:8080'] \n    # 指标路径，Actuator 默认暴露在这个路径\n    metrics_path: '/actuator/prometheus'\n```\n\n> **注意：** `host.docker.internal` 是 Docker 容器内部访问宿主机 `localhost` 的特殊地址。\n\n## 步骤二：启动 Prometheus 和 Grafana\n\n为了快速搭建环境，我们使用 Docker Compose 启动 Grafana 和 Prometheus。\n\n### 2\\. 创建 Docker Compose 文件 (`docker-compose.yml`)\n\n```yaml\nversion: '3.7'\n\nservices:\n  prometheus:\n    image: prom/prometheus:latest\n    container_name: prometheus\n    ports:\n      - \"9090:9090\"\n    volumes:\n      # 挂载我们上面创建的配置文件\n      - ./prometheus.yml:/etc/prometheus/prometheus.yml\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n    networks:\n      - monitoring-net\n\n  grafana:\n    image: grafana/grafana:latest\n    container_name: grafana\n    ports:\n      - \"3000:3000\"\n    networks:\n      - monitoring-net\n    depends_on:\n      - prometheus\n      \nnetworks:\n  monitoring-net:\n    driver: bridge\n```\n\n### 3\\. 运行容器\n\n确保你的 Spring Boot 应用正在运行（端口 `8080`），然后在 `prometheus.yml` 和 `docker-compose.yml` 所在的目录运行：\n\n```bash\ndocker-compose up -d\n```\n\n现在，环境已准备就绪：\n\n* **Spring Boot App:** `http://localhost:8080`\n* **Prometheus UI:** `http://localhost:9090`\n* **Grafana UI:** `http://localhost:3000` (默认登录：`admin`/`admin`)\n\n## 步骤三：在 Grafana 中添加数据源\n\n登录 Grafana (默认: `admin/admin`)，然后执行以下操作：\n\n1.  在左侧导航栏，点击 **Settings** (齿轮图标) -\\> **Data Sources**。\n2.  点击 **Add data source**，选择 **Prometheus**。\n3.  在 **HTTP** 部分，填写 Prometheus 服务器的 URL：\n    * **URL:** `http://prometheus:9090` (因为 Grafana 和 Prometheus 在同一个 Docker 网络中，可以直接使用服务名)\n4.  点击底部的 **Save & Test**。如果看到 \"Data source is working\" 的提示，说明连接成功。\n\n## 步骤四：创建仪表盘和可视化\n\n现在我们来创建图表，展示你的 `account.error.count` 指标。\n\n1.  在左侧导航栏，点击 **Dashboards** (四个方块图标) -\\> **New Dashboard** -\\> **Add visualization**。\n\n2.  选择你刚刚配置好的 **Prometheus** 数据源。\n\n3.  在 **Query** (查询) 区域，输入你的 PromQL 查询语句：\n\n    | 目标 | PromQL 查询语句 | 说明 |\n        | :--- | :--- | :--- |\n    | **总错误计数 (Raw Counter)** | `account_error_count_total` | 显示当前累积的总错误次数。|\n    | **每分钟新增错误数 (Rate)** | `rate(account_error_count_total[1m])` | 这是更常用的查询方式。它计算你的计数器在过去 1 分钟内的平均增长率（即每秒新增的错误数）。|\n    | **特定类型错误计数** | `sum by (tag_type) (account_error_count_total)` | 按错误类型 (`tag_type`) 分组求和，可以清楚看到哪种错误最多。|\n    | **过滤特定错误** | `rate(account_error_count_total{tag_type=\"database\"}[1m])` | 仅显示 `tag_type` 为 `database` 的错误增长率。|\n\n4.  选择一个你喜欢的可视化类型，例如 **Graph** 或 **Stat**。\n\n5.  在 Spring Boot 应用中，多访问几次你创建的 `/record-error` 接口来生成数据。\n\n6.  在 Grafana 中，你就能看到数据图表开始实时绘制！\n","slug":"spring-boot/grafana-prometheus-springboot监控平台","published":1,"updated":"2025-12-03T03:12:25.297Z","comments":1,"layout":"post","photos":[],"_id":"cmjgyvrny0005kd0v3qd2d0zi","content":"<p>好的，我现在提供一个完整的 Spring Boot 项目结构，您可以直接创建文件并运行。</p>\n<p>请确保您的项目使用 <strong>Java 17+</strong> 和 <strong>Spring Boot 3.x</strong>，或使用兼容的旧版本。</p>\n<h3 id=\"1-项目依赖文件：pom-xml-Maven\"><a href=\"#1-项目依赖文件：pom-xml-Maven\" class=\"headerlink\" title=\"1. 项目依赖文件：pom.xml (Maven)\"></a>1. 项目依赖文件：<code>pom.xml</code> (Maven)</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">modelVersion</span>&gt;</span>4.0.0<span class=\"tag\">&lt;/<span class=\"name\">modelVersion</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">parent</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-parent<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.2.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span> <span class=\"tag\">&lt;<span class=\"name\">relativePath</span>/&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">parent</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.example<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>grafana-metric-demo<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>0.0.1-SNAPSHOT<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>grafana-metric-demo<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>io.micrometer<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">project</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-配置文件：src-main-resources-application-properties\"><a href=\"#2-配置文件：src-main-resources-application-properties\" class=\"headerlink\" title=\"2. 配置文件：src/main/resources/application.properties\"></a>2. 配置文件：<code>src/main/resources/application.properties</code></h3><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启用所有 Actuator 端点（包括 /metrics, /prometheus 等）</span></span><br><span class=\"line\"><span class=\"attr\">management.endpoints.web.exposure.include</span>=<span class=\"string\">*</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"># 确保 Prometheus 端点是启用的</span></span><br><span class=\"line\"><span class=\"attr\">management.endpoint.prometheus.enabled</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"># 设置应用端口</span></span><br><span class=\"line\"><span class=\"attr\">server.port</span>=<span class=\"string\">8080</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-指标服务：src-main-java-com-example-demo-AccountMetricService-java\"><a href=\"#3-指标服务：src-main-java-com-example-demo-AccountMetricService-java\" class=\"headerlink\" title=\"3. 指标服务：src/main/java/com/example/demo/AccountMetricService.java\"></a>3. 指标服务：<code>src/main/java/com/example/demo/AccountMetricService.java</code></h3><p>(假设您的包名为 <code>com.example.demo</code>)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.demo;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> io.micrometer.core.instrument.Counter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.micrometer.core.instrument.MeterRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.micrometer.core.instrument.Tags;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Service;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AccountMetricService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MeterRegistry meterRegistry;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">AccountMetricService</span><span class=\"params\">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.meterRegistry = meterRegistry;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 对特定错误进行埋点计数：account.error.count</span></span><br><span class=\"line\"><span class=\"comment\">     * * <span class=\"doctag\">@param</span> type 错误的分类 (例如：&quot;validation&quot;, &quot;database&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> errorMessage 具体的错误信息 (例如：&quot;UserNotFound&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">recordError</span><span class=\"params\">(String type, String errorMessage)</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 使用 Counter.builder() 来创建或获取一个已注册的 Counter</span></span><br><span class=\"line\">        Counter.builder(<span class=\"string\">&quot;account.error.count&quot;</span>)</span><br><span class=\"line\">               .description(<span class=\"string\">&quot;Counts errors in the account service by type and message&quot;</span>)</span><br><span class=\"line\">               <span class=\"comment\">// 动态添加标签 (Tags)</span></span><br><span class=\"line\">               .tags(</span><br><span class=\"line\">                   <span class=\"string\">&quot;tag_type&quot;</span>, type == <span class=\"literal\">null</span> ? <span class=\"string\">&quot;unknown&quot;</span> : type,</span><br><span class=\"line\">                   <span class=\"string\">&quot;tag_error&quot;</span>, errorMessage</span><br><span class=\"line\">               )</span><br><span class=\"line\">               .register(meterRegistry)</span><br><span class=\"line\">               .increment(); <span class=\"comment\">// 执行计数加 1</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;--- 埋点计数: type=&quot;</span> + type + <span class=\"string\">&quot;, error=&quot;</span> + errorMessage + <span class=\"string\">&quot; ---&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-测试接口：src-main-java-com-example-demo-MetricTestController-java\"><a href=\"#4-测试接口：src-main-java-com-example-demo-MetricTestController-java\" class=\"headerlink\" title=\"4. 测试接口：src/main/java/com/example/demo/MetricTestController.java\"></a>4. 测试接口：<code>src/main/java/com/example/demo/MetricTestController.java</code></h3><p>我们创建一个 Controller 来模拟业务逻辑，方便通过浏览器或 cURL 来触发计数器。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.demo;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MetricTestController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AccountMetricService metricService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">MetricTestController</span><span class=\"params\">(AccountMetricService metricService)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.metricService = metricService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 访问此接口来触发错误计数。</span></span><br><span class=\"line\"><span class=\"comment\">     * 示例 URL: http://localhost:8080/record-error?type=database&amp;msg=ConnectionTimeout</span></span><br><span class=\"line\"><span class=\"comment\">     * 示例 URL: http://localhost:8080/record-error?type=validation&amp;msg=InvalidEmail</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping(&quot;/record-error&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">recordError</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">            <span class=\"meta\">@RequestParam(defaultValue = &quot;unknown&quot;)</span> String type,</span></span><br><span class=\"line\"><span class=\"params\">            <span class=\"meta\">@RequestParam(defaultValue = &quot;generic&quot;)</span> String msg)</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        metricService.recordError(type, msg);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;Error count recorded successfully for type: &quot;</span> + type + <span class=\"string\">&quot;, message: &quot;</span> + msg;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 访问此接口来触发一个成功的调用 (不计数)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping(&quot;/success&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">success</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;Success operation.&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-启动类：src-main-java-com-example-demo-DemoApplication-java\"><a href=\"#5-启动类：src-main-java-com-example-demo-DemoApplication-java\" class=\"headerlink\" title=\"5. 启动类：src/main/java/com/example/demo/DemoApplication.java\"></a>5. 启动类：<code>src/main/java/com/example/demo/DemoApplication.java</code></h3><p>标准的 Spring Boot 启动类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.demo;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.SpringApplication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SpringBootApplication</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DemoApplication</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        SpringApplication.run(DemoApplication.class, args);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"🚀-运行与验证\"><a href=\"#🚀-运行与验证\" class=\"headerlink\" title=\"🚀 运行与验证\"></a>🚀 运行与验证</h3><ol>\n<li><strong>运行项目</strong>：在 IDE (如 IntelliJ IDEA) 中运行 <code>DemoApplication.java</code> 的 <code>main</code> 方法，或使用 Maven 命令 <code>mvn spring-boot:run</code>。</li>\n<li><strong>触发计数</strong>：在浏览器或命令行中多次访问以下 URL，以模拟不同类型的错误：<ul>\n<li><code>http://localhost:8080/record-error?type=database&amp;msg=ConnectionTimeout</code></li>\n<li><code>http://localhost:8080/record-error?type=validation&amp;msg=InvalidEmail</code></li>\n<li><code>http://localhost:8080/record-error?type=database&amp;msg=ConnectionTimeout</code> (再访问一次)</li>\n</ul>\n</li>\n<li><strong>验证指标暴露</strong>：访问 Prometheus 端点，检查指标数据是否已生成：<ul>\n<li><code>http://localhost:8080/actuator/prometheus</code></li>\n</ul>\n</li>\n</ol>\n<p>您应该能在输出中找到类似以下格式的数据（注意名字变成了 <code>account_error_count_total</code>）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># TYPE account_error_count_total counter</span><br><span class=\"line\">account_error_count_total&#123;error_msg=&quot;ConnectionTimeout&quot;, tag_type=&quot;database&quot;&#125; 2.0</span><br><span class=\"line\">account_error_count_total&#123;error_msg=&quot;InvalidEmail&quot;, tag_type=&quot;validation&quot;&#125; 1.0</span><br></pre></td></tr></table></figure>\n\n<p>现在，我们有了实际运行的数据。下一步就是 <strong>配置 Grafana 连接到这个数据源并创建图表</strong></p>\n<p>这是一个非常重要的步骤，我们将配置 Grafana 和 Prometheus，把你的 Spring Boot 应用真正连接到可视化界面。</p>\n<p>要实现这个目标，我们必须引入中间层 <strong>Prometheus</strong>，它负责定时去你的 Spring Boot 应用（<code>http://localhost:8080/actuator/prometheus</code>）拉取（Scrape）数据，然后 Grafana 再从 Prometheus 获取这些时序数据。</p>\n<h3 id=\"架构概览\"><a href=\"#架构概览\" class=\"headerlink\" title=\"架构概览\"></a>架构概览</h3><p>$$\\text{Spring Boot (Metrics Source)} \\xrightarrow{\\text{Scrape at 8080&#x2F;actuator&#x2F;prometheus}} \\text{Prometheus (Time-Series DB)} \\xrightarrow{\\text{Query}} \\text{Grafana (Visualization)}$$</p>\n<p>假设你已经安装了 Docker，以下是配置和查询的详细步骤。</p>\n<hr>\n<h2 id=\"步骤一：配置-Prometheus-采集目标\"><a href=\"#步骤一：配置-Prometheus-采集目标\" class=\"headerlink\" title=\"步骤一：配置 Prometheus 采集目标\"></a>步骤一：配置 Prometheus 采集目标</h2><p>我们需要告诉 Prometheus 服务器，你的 Spring Boot 应用在哪里。</p>\n<h3 id=\"1-创建-Prometheus-配置文件-prometheus-yml\"><a href=\"#1-创建-Prometheus-配置文件-prometheus-yml\" class=\"headerlink\" title=\"1. 创建 Prometheus 配置文件 (prometheus.yml)\"></a>1. 创建 Prometheus 配置文件 (<code>prometheus.yml</code>)</h3><p>在您的工作目录下创建一个名为 <code>prometheus.yml</code> 的文件，内容如下。这个配置将 Prometheus 服务器设置为每隔 5 秒去采集您的 Spring Boot 应用的指标。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"comment\"># 每隔 5 秒评估一次规则和采集数据</span></span><br><span class=\"line\">  <span class=\"attr\">scrape_interval:</span> <span class=\"string\">5s</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\">  <span class=\"comment\"># Prometheus 自身的监控</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;prometheus&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;localhost:9090&#x27;</span>] <span class=\"comment\"># Prometheus 默认端口</span></span><br><span class=\"line\">      </span><br><span class=\"line\">  <span class=\"comment\"># 您的 Spring Boot 应用监控</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;spring-boot-app&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\"># 假设您的应用运行在本地 8080 端口</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;host.docker.internal:8080&#x27;</span>] </span><br><span class=\"line\">    <span class=\"comment\"># 指标路径，Actuator 默认暴露在这个路径</span></span><br><span class=\"line\">    <span class=\"attr\">metrics_path:</span> <span class=\"string\">&#x27;/actuator/prometheus&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>注意：</strong> <code>host.docker.internal</code> 是 Docker 容器内部访问宿主机 <code>localhost</code> 的特殊地址。</p>\n</blockquote>\n<h2 id=\"步骤二：启动-Prometheus-和-Grafana\"><a href=\"#步骤二：启动-Prometheus-和-Grafana\" class=\"headerlink\" title=\"步骤二：启动 Prometheus 和 Grafana\"></a>步骤二：启动 Prometheus 和 Grafana</h2><p>为了快速搭建环境，我们使用 Docker Compose 启动 Grafana 和 Prometheus。</p>\n<h3 id=\"2-创建-Docker-Compose-文件-docker-compose-yml\"><a href=\"#2-创建-Docker-Compose-文件-docker-compose-yml\" class=\"headerlink\" title=\"2. 创建 Docker Compose 文件 (docker-compose.yml)\"></a>2. 创建 Docker Compose 文件 (<code>docker-compose.yml</code>)</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.7&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">prom/prometheus:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;9090:9090&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"comment\"># 挂载我们上面创建的配置文件</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitoring-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">grafana:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/grafana:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3000:3000&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitoring-net</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">monitoring-net:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">bridge</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-运行容器\"><a href=\"#3-运行容器\" class=\"headerlink\" title=\"3. 运行容器\"></a>3. 运行容器</h3><p>确保你的 Spring Boot 应用正在运行（端口 <code>8080</code>），然后在 <code>prometheus.yml</code> 和 <code>docker-compose.yml</code> 所在的目录运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n<p>现在，环境已准备就绪：</p>\n<ul>\n<li><strong>Spring Boot App:</strong> <code>http://localhost:8080</code></li>\n<li><strong>Prometheus UI:</strong> <code>http://localhost:9090</code></li>\n<li><strong>Grafana UI:</strong> <code>http://localhost:3000</code> (默认登录：<code>admin</code>&#x2F;<code>admin</code>)</li>\n</ul>\n<h2 id=\"步骤三：在-Grafana-中添加数据源\"><a href=\"#步骤三：在-Grafana-中添加数据源\" class=\"headerlink\" title=\"步骤三：在 Grafana 中添加数据源\"></a>步骤三：在 Grafana 中添加数据源</h2><p>登录 Grafana (默认: <code>admin/admin</code>)，然后执行以下操作：</p>\n<ol>\n<li>在左侧导航栏，点击 <strong>Settings</strong> (齿轮图标) -&gt; <strong>Data Sources</strong>。</li>\n<li>点击 <strong>Add data source</strong>，选择 <strong>Prometheus</strong>。</li>\n<li>在 <strong>HTTP</strong> 部分，填写 Prometheus 服务器的 URL：<ul>\n<li><strong>URL:</strong> <code>http://prometheus:9090</code> (因为 Grafana 和 Prometheus 在同一个 Docker 网络中，可以直接使用服务名)</li>\n</ul>\n</li>\n<li>点击底部的 <strong>Save &amp; Test</strong>。如果看到 “Data source is working” 的提示，说明连接成功。</li>\n</ol>\n<h2 id=\"步骤四：创建仪表盘和可视化\"><a href=\"#步骤四：创建仪表盘和可视化\" class=\"headerlink\" title=\"步骤四：创建仪表盘和可视化\"></a>步骤四：创建仪表盘和可视化</h2><p>现在我们来创建图表，展示你的 <code>account.error.count</code> 指标。</p>\n<ol>\n<li><p>在左侧导航栏，点击 <strong>Dashboards</strong> (四个方块图标) -&gt; <strong>New Dashboard</strong> -&gt; <strong>Add visualization</strong>。</p>\n</li>\n<li><p>选择你刚刚配置好的 <strong>Prometheus</strong> 数据源。</p>\n</li>\n<li><p>在 <strong>Query</strong> (查询) 区域，输入你的 PromQL 查询语句：</p>\n<p>| 目标 | PromQL 查询语句 | 说明 |<br>| :— | :— | :— |<br>| <strong>总错误计数 (Raw Counter)</strong> | <code>account_error_count_total</code> | 显示当前累积的总错误次数。|<br>| <strong>每分钟新增错误数 (Rate)</strong> | <code>rate(account_error_count_total[1m])</code> | 这是更常用的查询方式。它计算你的计数器在过去 1 分钟内的平均增长率（即每秒新增的错误数）。|<br>| <strong>特定类型错误计数</strong> | <code>sum by (tag_type) (account_error_count_total)</code> | 按错误类型 (<code>tag_type</code>) 分组求和，可以清楚看到哪种错误最多。|<br>| <strong>过滤特定错误</strong> | <code>rate(account_error_count_total&#123;tag_type=&quot;database&quot;&#125;[1m])</code> | 仅显示 <code>tag_type</code> 为 <code>database</code> 的错误增长率。|</p>\n</li>\n<li><p>选择一个你喜欢的可视化类型，例如 <strong>Graph</strong> 或 <strong>Stat</strong>。</p>\n</li>\n<li><p>在 Spring Boot 应用中，多访问几次你创建的 <code>/record-error</code> 接口来生成数据。</p>\n</li>\n<li><p>在 Grafana 中，你就能看到数据图表开始实时绘制！</p>\n</li>\n</ol>\n","cover":false,"excerpt":"","more":"<p>好的，我现在提供一个完整的 Spring Boot 项目结构，您可以直接创建文件并运行。</p>\n<p>请确保您的项目使用 <strong>Java 17+</strong> 和 <strong>Spring Boot 3.x</strong>，或使用兼容的旧版本。</p>\n<h3 id=\"1-项目依赖文件：pom-xml-Maven\"><a href=\"#1-项目依赖文件：pom-xml-Maven\" class=\"headerlink\" title=\"1. 项目依赖文件：pom.xml (Maven)\"></a>1. 项目依赖文件：<code>pom.xml</code> (Maven)</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">modelVersion</span>&gt;</span>4.0.0<span class=\"tag\">&lt;/<span class=\"name\">modelVersion</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">parent</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-parent<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.2.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span> <span class=\"tag\">&lt;<span class=\"name\">relativePath</span>/&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">parent</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.example<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>grafana-metric-demo<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>0.0.1-SNAPSHOT<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>grafana-metric-demo<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>io.micrometer<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">project</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-配置文件：src-main-resources-application-properties\"><a href=\"#2-配置文件：src-main-resources-application-properties\" class=\"headerlink\" title=\"2. 配置文件：src/main/resources/application.properties\"></a>2. 配置文件：<code>src/main/resources/application.properties</code></h3><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启用所有 Actuator 端点（包括 /metrics, /prometheus 等）</span></span><br><span class=\"line\"><span class=\"attr\">management.endpoints.web.exposure.include</span>=<span class=\"string\">*</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"># 确保 Prometheus 端点是启用的</span></span><br><span class=\"line\"><span class=\"attr\">management.endpoint.prometheus.enabled</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"># 设置应用端口</span></span><br><span class=\"line\"><span class=\"attr\">server.port</span>=<span class=\"string\">8080</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-指标服务：src-main-java-com-example-demo-AccountMetricService-java\"><a href=\"#3-指标服务：src-main-java-com-example-demo-AccountMetricService-java\" class=\"headerlink\" title=\"3. 指标服务：src/main/java/com/example/demo/AccountMetricService.java\"></a>3. 指标服务：<code>src/main/java/com/example/demo/AccountMetricService.java</code></h3><p>(假设您的包名为 <code>com.example.demo</code>)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.demo;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> io.micrometer.core.instrument.Counter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.micrometer.core.instrument.MeterRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.micrometer.core.instrument.Tags;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Service;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AccountMetricService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MeterRegistry meterRegistry;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">AccountMetricService</span><span class=\"params\">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.meterRegistry = meterRegistry;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 对特定错误进行埋点计数：account.error.count</span></span><br><span class=\"line\"><span class=\"comment\">     * * <span class=\"doctag\">@param</span> type 错误的分类 (例如：&quot;validation&quot;, &quot;database&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> errorMessage 具体的错误信息 (例如：&quot;UserNotFound&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">recordError</span><span class=\"params\">(String type, String errorMessage)</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 使用 Counter.builder() 来创建或获取一个已注册的 Counter</span></span><br><span class=\"line\">        Counter.builder(<span class=\"string\">&quot;account.error.count&quot;</span>)</span><br><span class=\"line\">               .description(<span class=\"string\">&quot;Counts errors in the account service by type and message&quot;</span>)</span><br><span class=\"line\">               <span class=\"comment\">// 动态添加标签 (Tags)</span></span><br><span class=\"line\">               .tags(</span><br><span class=\"line\">                   <span class=\"string\">&quot;tag_type&quot;</span>, type == <span class=\"literal\">null</span> ? <span class=\"string\">&quot;unknown&quot;</span> : type,</span><br><span class=\"line\">                   <span class=\"string\">&quot;tag_error&quot;</span>, errorMessage</span><br><span class=\"line\">               )</span><br><span class=\"line\">               .register(meterRegistry)</span><br><span class=\"line\">               .increment(); <span class=\"comment\">// 执行计数加 1</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;--- 埋点计数: type=&quot;</span> + type + <span class=\"string\">&quot;, error=&quot;</span> + errorMessage + <span class=\"string\">&quot; ---&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-测试接口：src-main-java-com-example-demo-MetricTestController-java\"><a href=\"#4-测试接口：src-main-java-com-example-demo-MetricTestController-java\" class=\"headerlink\" title=\"4. 测试接口：src/main/java/com/example/demo/MetricTestController.java\"></a>4. 测试接口：<code>src/main/java/com/example/demo/MetricTestController.java</code></h3><p>我们创建一个 Controller 来模拟业务逻辑，方便通过浏览器或 cURL 来触发计数器。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.demo;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MetricTestController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AccountMetricService metricService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">MetricTestController</span><span class=\"params\">(AccountMetricService metricService)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.metricService = metricService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 访问此接口来触发错误计数。</span></span><br><span class=\"line\"><span class=\"comment\">     * 示例 URL: http://localhost:8080/record-error?type=database&amp;msg=ConnectionTimeout</span></span><br><span class=\"line\"><span class=\"comment\">     * 示例 URL: http://localhost:8080/record-error?type=validation&amp;msg=InvalidEmail</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping(&quot;/record-error&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">recordError</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">            <span class=\"meta\">@RequestParam(defaultValue = &quot;unknown&quot;)</span> String type,</span></span><br><span class=\"line\"><span class=\"params\">            <span class=\"meta\">@RequestParam(defaultValue = &quot;generic&quot;)</span> String msg)</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        metricService.recordError(type, msg);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;Error count recorded successfully for type: &quot;</span> + type + <span class=\"string\">&quot;, message: &quot;</span> + msg;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 访问此接口来触发一个成功的调用 (不计数)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping(&quot;/success&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">success</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;Success operation.&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-启动类：src-main-java-com-example-demo-DemoApplication-java\"><a href=\"#5-启动类：src-main-java-com-example-demo-DemoApplication-java\" class=\"headerlink\" title=\"5. 启动类：src/main/java/com/example/demo/DemoApplication.java\"></a>5. 启动类：<code>src/main/java/com/example/demo/DemoApplication.java</code></h3><p>标准的 Spring Boot 启动类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.demo;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.SpringApplication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SpringBootApplication</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DemoApplication</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        SpringApplication.run(DemoApplication.class, args);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"🚀-运行与验证\"><a href=\"#🚀-运行与验证\" class=\"headerlink\" title=\"🚀 运行与验证\"></a>🚀 运行与验证</h3><ol>\n<li><strong>运行项目</strong>：在 IDE (如 IntelliJ IDEA) 中运行 <code>DemoApplication.java</code> 的 <code>main</code> 方法，或使用 Maven 命令 <code>mvn spring-boot:run</code>。</li>\n<li><strong>触发计数</strong>：在浏览器或命令行中多次访问以下 URL，以模拟不同类型的错误：<ul>\n<li><code>http://localhost:8080/record-error?type=database&amp;msg=ConnectionTimeout</code></li>\n<li><code>http://localhost:8080/record-error?type=validation&amp;msg=InvalidEmail</code></li>\n<li><code>http://localhost:8080/record-error?type=database&amp;msg=ConnectionTimeout</code> (再访问一次)</li>\n</ul>\n</li>\n<li><strong>验证指标暴露</strong>：访问 Prometheus 端点，检查指标数据是否已生成：<ul>\n<li><code>http://localhost:8080/actuator/prometheus</code></li>\n</ul>\n</li>\n</ol>\n<p>您应该能在输出中找到类似以下格式的数据（注意名字变成了 <code>account_error_count_total</code>）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># TYPE account_error_count_total counter</span><br><span class=\"line\">account_error_count_total&#123;error_msg=&quot;ConnectionTimeout&quot;, tag_type=&quot;database&quot;&#125; 2.0</span><br><span class=\"line\">account_error_count_total&#123;error_msg=&quot;InvalidEmail&quot;, tag_type=&quot;validation&quot;&#125; 1.0</span><br></pre></td></tr></table></figure>\n\n<p>现在，我们有了实际运行的数据。下一步就是 <strong>配置 Grafana 连接到这个数据源并创建图表</strong></p>\n<p>这是一个非常重要的步骤，我们将配置 Grafana 和 Prometheus，把你的 Spring Boot 应用真正连接到可视化界面。</p>\n<p>要实现这个目标，我们必须引入中间层 <strong>Prometheus</strong>，它负责定时去你的 Spring Boot 应用（<code>http://localhost:8080/actuator/prometheus</code>）拉取（Scrape）数据，然后 Grafana 再从 Prometheus 获取这些时序数据。</p>\n<h3 id=\"架构概览\"><a href=\"#架构概览\" class=\"headerlink\" title=\"架构概览\"></a>架构概览</h3><p>$$\\text{Spring Boot (Metrics Source)} \\xrightarrow{\\text{Scrape at 8080&#x2F;actuator&#x2F;prometheus}} \\text{Prometheus (Time-Series DB)} \\xrightarrow{\\text{Query}} \\text{Grafana (Visualization)}$$</p>\n<p>假设你已经安装了 Docker，以下是配置和查询的详细步骤。</p>\n<hr>\n<h2 id=\"步骤一：配置-Prometheus-采集目标\"><a href=\"#步骤一：配置-Prometheus-采集目标\" class=\"headerlink\" title=\"步骤一：配置 Prometheus 采集目标\"></a>步骤一：配置 Prometheus 采集目标</h2><p>我们需要告诉 Prometheus 服务器，你的 Spring Boot 应用在哪里。</p>\n<h3 id=\"1-创建-Prometheus-配置文件-prometheus-yml\"><a href=\"#1-创建-Prometheus-配置文件-prometheus-yml\" class=\"headerlink\" title=\"1. 创建 Prometheus 配置文件 (prometheus.yml)\"></a>1. 创建 Prometheus 配置文件 (<code>prometheus.yml</code>)</h3><p>在您的工作目录下创建一个名为 <code>prometheus.yml</code> 的文件，内容如下。这个配置将 Prometheus 服务器设置为每隔 5 秒去采集您的 Spring Boot 应用的指标。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"comment\"># 每隔 5 秒评估一次规则和采集数据</span></span><br><span class=\"line\">  <span class=\"attr\">scrape_interval:</span> <span class=\"string\">5s</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\">  <span class=\"comment\"># Prometheus 自身的监控</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;prometheus&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;localhost:9090&#x27;</span>] <span class=\"comment\"># Prometheus 默认端口</span></span><br><span class=\"line\">      </span><br><span class=\"line\">  <span class=\"comment\"># 您的 Spring Boot 应用监控</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;spring-boot-app&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\"># 假设您的应用运行在本地 8080 端口</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;host.docker.internal:8080&#x27;</span>] </span><br><span class=\"line\">    <span class=\"comment\"># 指标路径，Actuator 默认暴露在这个路径</span></span><br><span class=\"line\">    <span class=\"attr\">metrics_path:</span> <span class=\"string\">&#x27;/actuator/prometheus&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>注意：</strong> <code>host.docker.internal</code> 是 Docker 容器内部访问宿主机 <code>localhost</code> 的特殊地址。</p>\n</blockquote>\n<h2 id=\"步骤二：启动-Prometheus-和-Grafana\"><a href=\"#步骤二：启动-Prometheus-和-Grafana\" class=\"headerlink\" title=\"步骤二：启动 Prometheus 和 Grafana\"></a>步骤二：启动 Prometheus 和 Grafana</h2><p>为了快速搭建环境，我们使用 Docker Compose 启动 Grafana 和 Prometheus。</p>\n<h3 id=\"2-创建-Docker-Compose-文件-docker-compose-yml\"><a href=\"#2-创建-Docker-Compose-文件-docker-compose-yml\" class=\"headerlink\" title=\"2. 创建 Docker Compose 文件 (docker-compose.yml)\"></a>2. 创建 Docker Compose 文件 (<code>docker-compose.yml</code>)</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.7&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">prom/prometheus:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;9090:9090&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"comment\"># 挂载我们上面创建的配置文件</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitoring-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">grafana:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/grafana:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3000:3000&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitoring-net</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">monitoring-net:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">bridge</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-运行容器\"><a href=\"#3-运行容器\" class=\"headerlink\" title=\"3. 运行容器\"></a>3. 运行容器</h3><p>确保你的 Spring Boot 应用正在运行（端口 <code>8080</code>），然后在 <code>prometheus.yml</code> 和 <code>docker-compose.yml</code> 所在的目录运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n<p>现在，环境已准备就绪：</p>\n<ul>\n<li><strong>Spring Boot App:</strong> <code>http://localhost:8080</code></li>\n<li><strong>Prometheus UI:</strong> <code>http://localhost:9090</code></li>\n<li><strong>Grafana UI:</strong> <code>http://localhost:3000</code> (默认登录：<code>admin</code>&#x2F;<code>admin</code>)</li>\n</ul>\n<h2 id=\"步骤三：在-Grafana-中添加数据源\"><a href=\"#步骤三：在-Grafana-中添加数据源\" class=\"headerlink\" title=\"步骤三：在 Grafana 中添加数据源\"></a>步骤三：在 Grafana 中添加数据源</h2><p>登录 Grafana (默认: <code>admin/admin</code>)，然后执行以下操作：</p>\n<ol>\n<li>在左侧导航栏，点击 <strong>Settings</strong> (齿轮图标) -&gt; <strong>Data Sources</strong>。</li>\n<li>点击 <strong>Add data source</strong>，选择 <strong>Prometheus</strong>。</li>\n<li>在 <strong>HTTP</strong> 部分，填写 Prometheus 服务器的 URL：<ul>\n<li><strong>URL:</strong> <code>http://prometheus:9090</code> (因为 Grafana 和 Prometheus 在同一个 Docker 网络中，可以直接使用服务名)</li>\n</ul>\n</li>\n<li>点击底部的 <strong>Save &amp; Test</strong>。如果看到 “Data source is working” 的提示，说明连接成功。</li>\n</ol>\n<h2 id=\"步骤四：创建仪表盘和可视化\"><a href=\"#步骤四：创建仪表盘和可视化\" class=\"headerlink\" title=\"步骤四：创建仪表盘和可视化\"></a>步骤四：创建仪表盘和可视化</h2><p>现在我们来创建图表，展示你的 <code>account.error.count</code> 指标。</p>\n<ol>\n<li><p>在左侧导航栏，点击 <strong>Dashboards</strong> (四个方块图标) -&gt; <strong>New Dashboard</strong> -&gt; <strong>Add visualization</strong>。</p>\n</li>\n<li><p>选择你刚刚配置好的 <strong>Prometheus</strong> 数据源。</p>\n</li>\n<li><p>在 <strong>Query</strong> (查询) 区域，输入你的 PromQL 查询语句：</p>\n<p>| 目标 | PromQL 查询语句 | 说明 |<br>| :— | :— | :— |<br>| <strong>总错误计数 (Raw Counter)</strong> | <code>account_error_count_total</code> | 显示当前累积的总错误次数。|<br>| <strong>每分钟新增错误数 (Rate)</strong> | <code>rate(account_error_count_total[1m])</code> | 这是更常用的查询方式。它计算你的计数器在过去 1 分钟内的平均增长率（即每秒新增的错误数）。|<br>| <strong>特定类型错误计数</strong> | <code>sum by (tag_type) (account_error_count_total)</code> | 按错误类型 (<code>tag_type</code>) 分组求和，可以清楚看到哪种错误最多。|<br>| <strong>过滤特定错误</strong> | <code>rate(account_error_count_total&#123;tag_type=&quot;database&quot;&#125;[1m])</code> | 仅显示 <code>tag_type</code> 为 <code>database</code> 的错误增长率。|</p>\n</li>\n<li><p>选择一个你喜欢的可视化类型，例如 <strong>Graph</strong> 或 <strong>Stat</strong>。</p>\n</li>\n<li><p>在 Spring Boot 应用中，多访问几次你创建的 <code>/record-error</code> 接口来生成数据。</p>\n</li>\n<li><p>在 Grafana 中，你就能看到数据图表开始实时绘制！</p>\n</li>\n</ol>\n"},{"title":"mac冷知识","date":"2025-12-24T06:25:07.000Z","_content":"\n修复\"打开应用程序时，提示程序损坏，扔进废纸篓！\"\n```shell\nsudo xattr -r -d com.apple.quarantine /Applications/BongoCat.app\n```\n小米手机连接无线adb\n```shell\n adb pair 172.18.6.86:43703\nEnter pairing code: 250904\nSuccessfully paired to 172.18.6.86:43703 [guid=adb-2e1ee8c4-rV5w7C]\n```","source":"_posts/mac/mac冷知识.md","raw":"---\ntitle: mac冷知识\ndate: 2025-12-24 14:25:07\ncategories: mac\ntag: 冷知识\n---\n\n修复\"打开应用程序时，提示程序损坏，扔进废纸篓！\"\n```shell\nsudo xattr -r -d com.apple.quarantine /Applications/BongoCat.app\n```\n小米手机连接无线adb\n```shell\n adb pair 172.18.6.86:43703\nEnter pairing code: 250904\nSuccessfully paired to 172.18.6.86:43703 [guid=adb-2e1ee8c4-rV5w7C]\n```","slug":"mac/mac冷知识","published":1,"updated":"2025-12-25T02:08:48.017Z","_id":"cmjjms65y0000m20vh6jzc8yi","comments":1,"layout":"post","photos":[],"content":"<p>修复”打开应用程序时，提示程序损坏，扔进废纸篓！”</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo xattr -r -d com.apple.quarantine /Applications/BongoCat.app</span><br></pre></td></tr></table></figure>\n<p>小米手机连接无线adb</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> adb pair 172.18.6.86:43703</span><br><span class=\"line\">Enter pairing code: 250904</span><br><span class=\"line\">Successfully paired to 172.18.6.86:43703 [guid=adb-2e1ee8c4-rV5w7C]</span><br></pre></td></tr></table></figure>","cover":false,"excerpt":"","more":"<p>修复”打开应用程序时，提示程序损坏，扔进废纸篓！”</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo xattr -r -d com.apple.quarantine /Applications/BongoCat.app</span><br></pre></td></tr></table></figure>\n<p>小米手机连接无线adb</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> adb pair 172.18.6.86:43703</span><br><span class=\"line\">Enter pairing code: 250904</span><br><span class=\"line\">Successfully paired to 172.18.6.86:43703 [guid=adb-2e1ee8c4-rV5w7C]</span><br></pre></td></tr></table></figure>"},{"title":"Spring Cloud集成RSocket","date":"2026-01-09T03:15:40.000Z","_content":"\n在 Spring Cloud 环境下集成 RSocket，不仅可以获得其**二进制协议、多路复用**的高性能，还能利用 Spring Cloud 的**服务发现**（如 Nacos/Eureka）来实现 RSocket 客户端的自动负载均衡。\n\n以下是实现高性能 RSocket 微服务架构的详细集成方案。\n\n---\n\n## 1. 核心依赖配置\n\n首先，在服务端和客户端的 `pom.xml` 中引入 Spring Boot 的 RSocket 启动器。由于 RSocket 是响应式的，通常建议配合 Project Reactor 使用。\n\n```xml\n<dependencies>\n    <dependency>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-rsocket</artifactId>\n    </dependency>\n    <dependency>\n        <groupId>com.alibaba.cloud</groupId>\n        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n    </dependency>\n</dependencies>\n\n```\n\n---\n\n## 2. 服务端：声明 RSocket 端口与服务\n\n在 `application.yml` 中，你需要明确 RSocket 监听的端口。注意，这个端口和 HTTP 端口是分开的。\n\n### 配置文件\n\n```yaml\nserver:\n  port: 8081 # HTTP 端口\n\nspring:\n  application:\n    name: trade-service\n  rsocket:\n    server:\n      port: 7001 # RSocket 监听端口\n      transport: tcp # 传输协议\n  cloud:\n    nacos:\n      discovery:\n        server-addr: 127.0.0.1:8848\n        # 重要：将 RSocket 端口注册到 Nacos 元数据中，方便客户端发现\n        metadata:\n          rsocket-port: 7001\n\n```\n\n### 业务代码 (Controller 风格)\n\nRSocket 使用 `@MessageMapping` 注解来处理请求。\n\n```java\n@Controller\npublic class TradeRSocketController {\n\n    @MessageMapping(\"order.create\") // 路由定义\n    public Mono<TradeResponse> createOrder(TradeRequest request) {\n        // 模拟内存处理逻辑\n        return Mono.just(new TradeResponse(\"SUCCESS\", request.getOrderId()));\n    }\n\n    @MessageMapping(\"market.stream\") // 请求-流模式：实时推送行情\n    public Flux<PriceTick> getMarketStream(String symbol) {\n        return Flux.interval(Duration.ofMillis(100))\n                   .map(i -> new PriceTick(symbol, Math.random()));\n    }\n}\n\n```\n\n---\n\n## 3. 客户端：集成服务发现与负载均衡\n\n在微服务环境下，客户端不能硬编码服务端的 IP。我们需要利用 `RSocketRequester` 配合 `LoadBalancer` 访问。\n\n### 配置类\n\n```java\n@Configuration\npublic class RSocketClientConfig {\n\n    @Bean\n    @LoadBalanced // 开启负载均衡支持\n    public RSocketRequester.Builder rsocketRequesterBuilder() {\n        return RSocketRequester.builder()\n                .rsocketStrategies(RSocketStrategies.builder()\n                        .decoder(new Pbkdf2Decoder()) // 如果使用 Protobuf，在此配置编解码器\n                        .build());\n    }\n}\n\n```\n\n### 调用服务\n\n```java\n@Service\n@RequiredArgsConstructor\npublic class TradeClientService {\n\n    private final RSocketRequester.Builder builder;\n    private final DiscoveryClient discoveryClient;\n\n    public Mono<TradeResponse> callCreateOrder(TradeRequest request) {\n        // 通过 Spring Cloud 负载均衡器定位服务\n        // 格式：discovery://服务名\n        return builder.transports(\"trade-service\", TransportType.RSOCKET) // 自动发现端口\n                .route(\"order.create\")\n                .data(request)\n                .retrieveMono(TradeResponse.class);\n    }\n}\n\n```\n\n---\n\n## 4. RSocket 的四种交互模式\n\nRSocket 相比于 Feign (只支持 Request-Response)，提供了更丰富的交互模型，非常适合交易系统：\n\n1. **Request-Response (请求-响应)：** 类似于标准的 HTTP 调用。\n2. **Fire-and-Forget (只发不管)：** 用于发送非关键日志或埋点，无需等待结果，性能最高。\n3. **Request-Stream (请求-流)：** 订阅行情。发一个请求（如产品 ID），服务端持续推送价格流。\n4. **Channel (双向通道)：** 最强的模式。客户端和服务端建立双向流，实时交换订单状态和心跳，极其适合撮合引擎与前端的实时交互。\n\n---\n\n## 5. 进阶：使用 Protobuf 代替 JSON\n\n为了实现极致性能，RSocket 建议配合 **Protobuf** 使用。你需要定义 `.proto` 文件，并在 RSocket 配置中添加消息策略：\n\n```java\n@Bean\npublic RSocketStrategies rsocketStrategies() {\n    return RSocketStrategies.builder()\n            .encoder(new ProtobufEncoder())\n            .decoder(new ProtobufDecoder())\n            .build();\n}\n\n```\n\n---\n\n## 6. 性能评估\n\n集成 RSocket 后，你的微服务体系将获得以下提升：\n\n* **长连接：** 避开了每次调用都要进行 TCP 三次握手和 TLS 握手的开销。\n* **背压支持 (Backpressure)：** 交易高峰期，如果 `Order` 服务处理慢，它可以通过 RSocket 的信号告知 `Trade` 服务减速，防止系统被压垮。\n* **二进制：** 相比 JSON，序列化性能提升约 3-10 倍，CPU 占用率大幅下降。\n\n### 总结建议\n\n* **对于查询类业务（管理后台）：** 依然保留原来的 Feign + JSON，方便调试和对接。\n* **对于核心交易链路（下单、扣费、推送）：** 全部改用 **RSocket + Protobuf**。这能让你的 Spring Cloud 架构在 2026 年依然保持顶级的竞争力和吞吐量。\n","source":"_posts/spring-boot/Spring-Cloud集成RSocket.md","raw":"---\ntitle: Spring Cloud集成RSocket\ndate: 2026-01-09 11:15:40\ncategories: spring-cloud\ntag: RSocket高性能TCP多路复用\n---\n\n在 Spring Cloud 环境下集成 RSocket，不仅可以获得其**二进制协议、多路复用**的高性能，还能利用 Spring Cloud 的**服务发现**（如 Nacos/Eureka）来实现 RSocket 客户端的自动负载均衡。\n\n以下是实现高性能 RSocket 微服务架构的详细集成方案。\n\n---\n\n## 1. 核心依赖配置\n\n首先，在服务端和客户端的 `pom.xml` 中引入 Spring Boot 的 RSocket 启动器。由于 RSocket 是响应式的，通常建议配合 Project Reactor 使用。\n\n```xml\n<dependencies>\n    <dependency>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-rsocket</artifactId>\n    </dependency>\n    <dependency>\n        <groupId>com.alibaba.cloud</groupId>\n        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n    </dependency>\n</dependencies>\n\n```\n\n---\n\n## 2. 服务端：声明 RSocket 端口与服务\n\n在 `application.yml` 中，你需要明确 RSocket 监听的端口。注意，这个端口和 HTTP 端口是分开的。\n\n### 配置文件\n\n```yaml\nserver:\n  port: 8081 # HTTP 端口\n\nspring:\n  application:\n    name: trade-service\n  rsocket:\n    server:\n      port: 7001 # RSocket 监听端口\n      transport: tcp # 传输协议\n  cloud:\n    nacos:\n      discovery:\n        server-addr: 127.0.0.1:8848\n        # 重要：将 RSocket 端口注册到 Nacos 元数据中，方便客户端发现\n        metadata:\n          rsocket-port: 7001\n\n```\n\n### 业务代码 (Controller 风格)\n\nRSocket 使用 `@MessageMapping` 注解来处理请求。\n\n```java\n@Controller\npublic class TradeRSocketController {\n\n    @MessageMapping(\"order.create\") // 路由定义\n    public Mono<TradeResponse> createOrder(TradeRequest request) {\n        // 模拟内存处理逻辑\n        return Mono.just(new TradeResponse(\"SUCCESS\", request.getOrderId()));\n    }\n\n    @MessageMapping(\"market.stream\") // 请求-流模式：实时推送行情\n    public Flux<PriceTick> getMarketStream(String symbol) {\n        return Flux.interval(Duration.ofMillis(100))\n                   .map(i -> new PriceTick(symbol, Math.random()));\n    }\n}\n\n```\n\n---\n\n## 3. 客户端：集成服务发现与负载均衡\n\n在微服务环境下，客户端不能硬编码服务端的 IP。我们需要利用 `RSocketRequester` 配合 `LoadBalancer` 访问。\n\n### 配置类\n\n```java\n@Configuration\npublic class RSocketClientConfig {\n\n    @Bean\n    @LoadBalanced // 开启负载均衡支持\n    public RSocketRequester.Builder rsocketRequesterBuilder() {\n        return RSocketRequester.builder()\n                .rsocketStrategies(RSocketStrategies.builder()\n                        .decoder(new Pbkdf2Decoder()) // 如果使用 Protobuf，在此配置编解码器\n                        .build());\n    }\n}\n\n```\n\n### 调用服务\n\n```java\n@Service\n@RequiredArgsConstructor\npublic class TradeClientService {\n\n    private final RSocketRequester.Builder builder;\n    private final DiscoveryClient discoveryClient;\n\n    public Mono<TradeResponse> callCreateOrder(TradeRequest request) {\n        // 通过 Spring Cloud 负载均衡器定位服务\n        // 格式：discovery://服务名\n        return builder.transports(\"trade-service\", TransportType.RSOCKET) // 自动发现端口\n                .route(\"order.create\")\n                .data(request)\n                .retrieveMono(TradeResponse.class);\n    }\n}\n\n```\n\n---\n\n## 4. RSocket 的四种交互模式\n\nRSocket 相比于 Feign (只支持 Request-Response)，提供了更丰富的交互模型，非常适合交易系统：\n\n1. **Request-Response (请求-响应)：** 类似于标准的 HTTP 调用。\n2. **Fire-and-Forget (只发不管)：** 用于发送非关键日志或埋点，无需等待结果，性能最高。\n3. **Request-Stream (请求-流)：** 订阅行情。发一个请求（如产品 ID），服务端持续推送价格流。\n4. **Channel (双向通道)：** 最强的模式。客户端和服务端建立双向流，实时交换订单状态和心跳，极其适合撮合引擎与前端的实时交互。\n\n---\n\n## 5. 进阶：使用 Protobuf 代替 JSON\n\n为了实现极致性能，RSocket 建议配合 **Protobuf** 使用。你需要定义 `.proto` 文件，并在 RSocket 配置中添加消息策略：\n\n```java\n@Bean\npublic RSocketStrategies rsocketStrategies() {\n    return RSocketStrategies.builder()\n            .encoder(new ProtobufEncoder())\n            .decoder(new ProtobufDecoder())\n            .build();\n}\n\n```\n\n---\n\n## 6. 性能评估\n\n集成 RSocket 后，你的微服务体系将获得以下提升：\n\n* **长连接：** 避开了每次调用都要进行 TCP 三次握手和 TLS 握手的开销。\n* **背压支持 (Backpressure)：** 交易高峰期，如果 `Order` 服务处理慢，它可以通过 RSocket 的信号告知 `Trade` 服务减速，防止系统被压垮。\n* **二进制：** 相比 JSON，序列化性能提升约 3-10 倍，CPU 占用率大幅下降。\n\n### 总结建议\n\n* **对于查询类业务（管理后台）：** 依然保留原来的 Feign + JSON，方便调试和对接。\n* **对于核心交易链路（下单、扣费、推送）：** 全部改用 **RSocket + Protobuf**。这能让你的 Spring Cloud 架构在 2026 年依然保持顶级的竞争力和吞吐量。\n","slug":"spring-boot/Spring-Cloud集成RSocket","published":1,"updated":"2026-01-09T03:16:32.937Z","comments":1,"layout":"post","photos":[],"_id":"cmk6b1k2v0000qg0vczvw7kgs","content":"<p>在 Spring Cloud 环境下集成 RSocket，不仅可以获得其<strong>二进制协议、多路复用</strong>的高性能，还能利用 Spring Cloud 的<strong>服务发现</strong>（如 Nacos&#x2F;Eureka）来实现 RSocket 客户端的自动负载均衡。</p>\n<p>以下是实现高性能 RSocket 微服务架构的详细集成方案。</p>\n<hr>\n<h2 id=\"1-核心依赖配置\"><a href=\"#1-核心依赖配置\" class=\"headerlink\" title=\"1. 核心依赖配置\"></a>1. 核心依赖配置</h2><p>首先，在服务端和客户端的 <code>pom.xml</code> 中引入 Spring Boot 的 RSocket 启动器。由于 RSocket 是响应式的，通常建议配合 Project Reactor 使用。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-rsocket<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"2-服务端：声明-RSocket-端口与服务\"><a href=\"#2-服务端：声明-RSocket-端口与服务\" class=\"headerlink\" title=\"2. 服务端：声明 RSocket 端口与服务\"></a>2. 服务端：声明 RSocket 端口与服务</h2><p>在 <code>application.yml</code> 中，你需要明确 RSocket 监听的端口。注意，这个端口和 HTTP 端口是分开的。</p>\n<h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8081</span> <span class=\"comment\"># HTTP 端口</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">application:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">trade-service</span></span><br><span class=\"line\">  <span class=\"attr\">rsocket:</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">7001</span> <span class=\"comment\"># RSocket 监听端口</span></span><br><span class=\"line\">      <span class=\"attr\">transport:</span> <span class=\"string\">tcp</span> <span class=\"comment\"># 传输协议</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">nacos:</span></span><br><span class=\"line\">      <span class=\"attr\">discovery:</span></span><br><span class=\"line\">        <span class=\"attr\">server-addr:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span><span class=\"string\">:8848</span></span><br><span class=\"line\">        <span class=\"comment\"># 重要：将 RSocket 端口注册到 Nacos 元数据中，方便客户端发现</span></span><br><span class=\"line\">        <span class=\"attr\">metadata:</span></span><br><span class=\"line\">          <span class=\"attr\">rsocket-port:</span> <span class=\"number\">7001</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"业务代码-Controller-风格\"><a href=\"#业务代码-Controller-风格\" class=\"headerlink\" title=\"业务代码 (Controller 风格)\"></a>业务代码 (Controller 风格)</h3><p>RSocket 使用 <code>@MessageMapping</code> 注解来处理请求。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TradeRSocketController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@MessageMapping(&quot;order.create&quot;)</span> <span class=\"comment\">// 路由定义</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Mono&lt;TradeResponse&gt; <span class=\"title function_\">createOrder</span><span class=\"params\">(TradeRequest request)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 模拟内存处理逻辑</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Mono.just(<span class=\"keyword\">new</span> <span class=\"title class_\">TradeResponse</span>(<span class=\"string\">&quot;SUCCESS&quot;</span>, request.getOrderId()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@MessageMapping(&quot;market.stream&quot;)</span> <span class=\"comment\">// 请求-流模式：实时推送行情</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Flux&lt;PriceTick&gt; <span class=\"title function_\">getMarketStream</span><span class=\"params\">(String symbol)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Flux.interval(Duration.ofMillis(<span class=\"number\">100</span>))</span><br><span class=\"line\">                   .map(i -&gt; <span class=\"keyword\">new</span> <span class=\"title class_\">PriceTick</span>(symbol, Math.random()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"3-客户端：集成服务发现与负载均衡\"><a href=\"#3-客户端：集成服务发现与负载均衡\" class=\"headerlink\" title=\"3. 客户端：集成服务发现与负载均衡\"></a>3. 客户端：集成服务发现与负载均衡</h2><p>在微服务环境下，客户端不能硬编码服务端的 IP。我们需要利用 <code>RSocketRequester</code> 配合 <code>LoadBalancer</code> 访问。</p>\n<h3 id=\"配置类\"><a href=\"#配置类\" class=\"headerlink\" title=\"配置类\"></a>配置类</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RSocketClientConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"meta\">@LoadBalanced</span> <span class=\"comment\">// 开启负载均衡支持</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> RSocketRequester.Builder <span class=\"title function_\">rsocketRequesterBuilder</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> RSocketRequester.builder()</span><br><span class=\"line\">                .rsocketStrategies(RSocketStrategies.builder()</span><br><span class=\"line\">                        .decoder(<span class=\"keyword\">new</span> <span class=\"title class_\">Pbkdf2Decoder</span>()) <span class=\"comment\">// 如果使用 Protobuf，在此配置编解码器</span></span><br><span class=\"line\">                        .build());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"调用服务\"><a href=\"#调用服务\" class=\"headerlink\" title=\"调用服务\"></a>调用服务</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"meta\">@RequiredArgsConstructor</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TradeClientService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> RSocketRequester.Builder builder;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> DiscoveryClient discoveryClient;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Mono&lt;TradeResponse&gt; <span class=\"title function_\">callCreateOrder</span><span class=\"params\">(TradeRequest request)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 通过 Spring Cloud 负载均衡器定位服务</span></span><br><span class=\"line\">        <span class=\"comment\">// 格式：discovery://服务名</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> builder.transports(<span class=\"string\">&quot;trade-service&quot;</span>, TransportType.RSOCKET) <span class=\"comment\">// 自动发现端口</span></span><br><span class=\"line\">                .route(<span class=\"string\">&quot;order.create&quot;</span>)</span><br><span class=\"line\">                .data(request)</span><br><span class=\"line\">                .retrieveMono(TradeResponse.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"4-RSocket-的四种交互模式\"><a href=\"#4-RSocket-的四种交互模式\" class=\"headerlink\" title=\"4. RSocket 的四种交互模式\"></a>4. RSocket 的四种交互模式</h2><p>RSocket 相比于 Feign (只支持 Request-Response)，提供了更丰富的交互模型，非常适合交易系统：</p>\n<ol>\n<li><strong>Request-Response (请求-响应)：</strong> 类似于标准的 HTTP 调用。</li>\n<li><strong>Fire-and-Forget (只发不管)：</strong> 用于发送非关键日志或埋点，无需等待结果，性能最高。</li>\n<li><strong>Request-Stream (请求-流)：</strong> 订阅行情。发一个请求（如产品 ID），服务端持续推送价格流。</li>\n<li><strong>Channel (双向通道)：</strong> 最强的模式。客户端和服务端建立双向流，实时交换订单状态和心跳，极其适合撮合引擎与前端的实时交互。</li>\n</ol>\n<hr>\n<h2 id=\"5-进阶：使用-Protobuf-代替-JSON\"><a href=\"#5-进阶：使用-Protobuf-代替-JSON\" class=\"headerlink\" title=\"5. 进阶：使用 Protobuf 代替 JSON\"></a>5. 进阶：使用 Protobuf 代替 JSON</h2><p>为了实现极致性能，RSocket 建议配合 <strong>Protobuf</strong> 使用。你需要定义 <code>.proto</code> 文件，并在 RSocket 配置中添加消息策略：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> RSocketStrategies <span class=\"title function_\">rsocketStrategies</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> RSocketStrategies.builder()</span><br><span class=\"line\">            .encoder(<span class=\"keyword\">new</span> <span class=\"title class_\">ProtobufEncoder</span>())</span><br><span class=\"line\">            .decoder(<span class=\"keyword\">new</span> <span class=\"title class_\">ProtobufDecoder</span>())</span><br><span class=\"line\">            .build();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"6-性能评估\"><a href=\"#6-性能评估\" class=\"headerlink\" title=\"6. 性能评估\"></a>6. 性能评估</h2><p>集成 RSocket 后，你的微服务体系将获得以下提升：</p>\n<ul>\n<li><strong>长连接：</strong> 避开了每次调用都要进行 TCP 三次握手和 TLS 握手的开销。</li>\n<li><strong>背压支持 (Backpressure)：</strong> 交易高峰期，如果 <code>Order</code> 服务处理慢，它可以通过 RSocket 的信号告知 <code>Trade</code> 服务减速，防止系统被压垮。</li>\n<li><strong>二进制：</strong> 相比 JSON，序列化性能提升约 3-10 倍，CPU 占用率大幅下降。</li>\n</ul>\n<h3 id=\"总结建议\"><a href=\"#总结建议\" class=\"headerlink\" title=\"总结建议\"></a>总结建议</h3><ul>\n<li><strong>对于查询类业务（管理后台）：</strong> 依然保留原来的 Feign + JSON，方便调试和对接。</li>\n<li><strong>对于核心交易链路（下单、扣费、推送）：</strong> 全部改用 <strong>RSocket + Protobuf</strong>。这能让你的 Spring Cloud 架构在 2026 年依然保持顶级的竞争力和吞吐量。</li>\n</ul>\n","cover":false,"excerpt":"","more":"<p>在 Spring Cloud 环境下集成 RSocket，不仅可以获得其<strong>二进制协议、多路复用</strong>的高性能，还能利用 Spring Cloud 的<strong>服务发现</strong>（如 Nacos&#x2F;Eureka）来实现 RSocket 客户端的自动负载均衡。</p>\n<p>以下是实现高性能 RSocket 微服务架构的详细集成方案。</p>\n<hr>\n<h2 id=\"1-核心依赖配置\"><a href=\"#1-核心依赖配置\" class=\"headerlink\" title=\"1. 核心依赖配置\"></a>1. 核心依赖配置</h2><p>首先，在服务端和客户端的 <code>pom.xml</code> 中引入 Spring Boot 的 RSocket 启动器。由于 RSocket 是响应式的，通常建议配合 Project Reactor 使用。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-rsocket<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"2-服务端：声明-RSocket-端口与服务\"><a href=\"#2-服务端：声明-RSocket-端口与服务\" class=\"headerlink\" title=\"2. 服务端：声明 RSocket 端口与服务\"></a>2. 服务端：声明 RSocket 端口与服务</h2><p>在 <code>application.yml</code> 中，你需要明确 RSocket 监听的端口。注意，这个端口和 HTTP 端口是分开的。</p>\n<h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8081</span> <span class=\"comment\"># HTTP 端口</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">application:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">trade-service</span></span><br><span class=\"line\">  <span class=\"attr\">rsocket:</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">7001</span> <span class=\"comment\"># RSocket 监听端口</span></span><br><span class=\"line\">      <span class=\"attr\">transport:</span> <span class=\"string\">tcp</span> <span class=\"comment\"># 传输协议</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">nacos:</span></span><br><span class=\"line\">      <span class=\"attr\">discovery:</span></span><br><span class=\"line\">        <span class=\"attr\">server-addr:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span><span class=\"string\">:8848</span></span><br><span class=\"line\">        <span class=\"comment\"># 重要：将 RSocket 端口注册到 Nacos 元数据中，方便客户端发现</span></span><br><span class=\"line\">        <span class=\"attr\">metadata:</span></span><br><span class=\"line\">          <span class=\"attr\">rsocket-port:</span> <span class=\"number\">7001</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"业务代码-Controller-风格\"><a href=\"#业务代码-Controller-风格\" class=\"headerlink\" title=\"业务代码 (Controller 风格)\"></a>业务代码 (Controller 风格)</h3><p>RSocket 使用 <code>@MessageMapping</code> 注解来处理请求。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TradeRSocketController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@MessageMapping(&quot;order.create&quot;)</span> <span class=\"comment\">// 路由定义</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Mono&lt;TradeResponse&gt; <span class=\"title function_\">createOrder</span><span class=\"params\">(TradeRequest request)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 模拟内存处理逻辑</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Mono.just(<span class=\"keyword\">new</span> <span class=\"title class_\">TradeResponse</span>(<span class=\"string\">&quot;SUCCESS&quot;</span>, request.getOrderId()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@MessageMapping(&quot;market.stream&quot;)</span> <span class=\"comment\">// 请求-流模式：实时推送行情</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Flux&lt;PriceTick&gt; <span class=\"title function_\">getMarketStream</span><span class=\"params\">(String symbol)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Flux.interval(Duration.ofMillis(<span class=\"number\">100</span>))</span><br><span class=\"line\">                   .map(i -&gt; <span class=\"keyword\">new</span> <span class=\"title class_\">PriceTick</span>(symbol, Math.random()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"3-客户端：集成服务发现与负载均衡\"><a href=\"#3-客户端：集成服务发现与负载均衡\" class=\"headerlink\" title=\"3. 客户端：集成服务发现与负载均衡\"></a>3. 客户端：集成服务发现与负载均衡</h2><p>在微服务环境下，客户端不能硬编码服务端的 IP。我们需要利用 <code>RSocketRequester</code> 配合 <code>LoadBalancer</code> 访问。</p>\n<h3 id=\"配置类\"><a href=\"#配置类\" class=\"headerlink\" title=\"配置类\"></a>配置类</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RSocketClientConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"meta\">@LoadBalanced</span> <span class=\"comment\">// 开启负载均衡支持</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> RSocketRequester.Builder <span class=\"title function_\">rsocketRequesterBuilder</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> RSocketRequester.builder()</span><br><span class=\"line\">                .rsocketStrategies(RSocketStrategies.builder()</span><br><span class=\"line\">                        .decoder(<span class=\"keyword\">new</span> <span class=\"title class_\">Pbkdf2Decoder</span>()) <span class=\"comment\">// 如果使用 Protobuf，在此配置编解码器</span></span><br><span class=\"line\">                        .build());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"调用服务\"><a href=\"#调用服务\" class=\"headerlink\" title=\"调用服务\"></a>调用服务</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Service</span></span><br><span class=\"line\"><span class=\"meta\">@RequiredArgsConstructor</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TradeClientService</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> RSocketRequester.Builder builder;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> DiscoveryClient discoveryClient;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Mono&lt;TradeResponse&gt; <span class=\"title function_\">callCreateOrder</span><span class=\"params\">(TradeRequest request)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 通过 Spring Cloud 负载均衡器定位服务</span></span><br><span class=\"line\">        <span class=\"comment\">// 格式：discovery://服务名</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> builder.transports(<span class=\"string\">&quot;trade-service&quot;</span>, TransportType.RSOCKET) <span class=\"comment\">// 自动发现端口</span></span><br><span class=\"line\">                .route(<span class=\"string\">&quot;order.create&quot;</span>)</span><br><span class=\"line\">                .data(request)</span><br><span class=\"line\">                .retrieveMono(TradeResponse.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"4-RSocket-的四种交互模式\"><a href=\"#4-RSocket-的四种交互模式\" class=\"headerlink\" title=\"4. RSocket 的四种交互模式\"></a>4. RSocket 的四种交互模式</h2><p>RSocket 相比于 Feign (只支持 Request-Response)，提供了更丰富的交互模型，非常适合交易系统：</p>\n<ol>\n<li><strong>Request-Response (请求-响应)：</strong> 类似于标准的 HTTP 调用。</li>\n<li><strong>Fire-and-Forget (只发不管)：</strong> 用于发送非关键日志或埋点，无需等待结果，性能最高。</li>\n<li><strong>Request-Stream (请求-流)：</strong> 订阅行情。发一个请求（如产品 ID），服务端持续推送价格流。</li>\n<li><strong>Channel (双向通道)：</strong> 最强的模式。客户端和服务端建立双向流，实时交换订单状态和心跳，极其适合撮合引擎与前端的实时交互。</li>\n</ol>\n<hr>\n<h2 id=\"5-进阶：使用-Protobuf-代替-JSON\"><a href=\"#5-进阶：使用-Protobuf-代替-JSON\" class=\"headerlink\" title=\"5. 进阶：使用 Protobuf 代替 JSON\"></a>5. 进阶：使用 Protobuf 代替 JSON</h2><p>为了实现极致性能，RSocket 建议配合 <strong>Protobuf</strong> 使用。你需要定义 <code>.proto</code> 文件，并在 RSocket 配置中添加消息策略：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> RSocketStrategies <span class=\"title function_\">rsocketStrategies</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> RSocketStrategies.builder()</span><br><span class=\"line\">            .encoder(<span class=\"keyword\">new</span> <span class=\"title class_\">ProtobufEncoder</span>())</span><br><span class=\"line\">            .decoder(<span class=\"keyword\">new</span> <span class=\"title class_\">ProtobufDecoder</span>())</span><br><span class=\"line\">            .build();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"6-性能评估\"><a href=\"#6-性能评估\" class=\"headerlink\" title=\"6. 性能评估\"></a>6. 性能评估</h2><p>集成 RSocket 后，你的微服务体系将获得以下提升：</p>\n<ul>\n<li><strong>长连接：</strong> 避开了每次调用都要进行 TCP 三次握手和 TLS 握手的开销。</li>\n<li><strong>背压支持 (Backpressure)：</strong> 交易高峰期，如果 <code>Order</code> 服务处理慢，它可以通过 RSocket 的信号告知 <code>Trade</code> 服务减速，防止系统被压垮。</li>\n<li><strong>二进制：</strong> 相比 JSON，序列化性能提升约 3-10 倍，CPU 占用率大幅下降。</li>\n</ul>\n<h3 id=\"总结建议\"><a href=\"#总结建议\" class=\"headerlink\" title=\"总结建议\"></a>总结建议</h3><ul>\n<li><strong>对于查询类业务（管理后台）：</strong> 依然保留原来的 Feign + JSON，方便调试和对接。</li>\n<li><strong>对于核心交易链路（下单、扣费、推送）：</strong> 全部改用 <strong>RSocket + Protobuf</strong>。这能让你的 Spring Cloud 架构在 2026 年依然保持顶级的竞争力和吞吐量。</li>\n</ul>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cmiguul8q0001ujz3g2zy32ge","category_id":"cmiguul8r0004ujz3hx7p5yy1","_id":"cmiguul8t000gujz3eq0mf9wo"},{"post_id":"cmiguul8r0003ujz3bl4z8g3f","category_id":"cmiguul8r0004ujz3hx7p5yy1","_id":"cmiguul8t000lujz33d7i5rfr"},{"post_id":"cmiguul8s0007ujz36okt0kms","category_id":"cmiguul8t000fujz3bzxs3h8c","_id":"cmiguul8u000sujz3h7yzcc09"},{"post_id":"cmiguul8s0009ujz37gh9hrxz","category_id":"cmiguul8t000fujz3bzxs3h8c","_id":"cmiguul8u000xujz3f99e1wfp"},{"post_id":"cmiguul8t000dujz3d3skh9w2","category_id":"cmiguul8u000rujz33syn0fsa","_id":"cmiguul8v0013ujz37ps10kal"},{"post_id":"cmiguul8u000zujz3fw7g80ha","category_id":"cmiguul8t000fujz3bzxs3h8c","_id":"cmiguul8v0019ujz35ntsfwdp"},{"post_id":"cmiguul8t000eujz3fle61rzw","category_id":"cmiguul8u000yujz3hw052vx4","_id":"cmiguul8v001dujz3fq7y1n0d"},{"post_id":"cmiguul8t000iujz39p534luh","category_id":"cmiguul8u000yujz3hw052vx4","_id":"cmiguul8v001hujz3dpgsd3p6"},{"post_id":"cmiguul8t000kujz3ceolcim4","category_id":"cmiguul8v001bujz3hsae3e8l","_id":"cmiguul8w001oujz3hc7kaszy"},{"post_id":"cmiguul8u000oujz360wfc01w","category_id":"cmiguul8v001jujz3enh4fvtk","_id":"cmiguul8w001vujz3b5vz8mmv"},{"post_id":"cmiguul8u000qujz33mc8f32g","category_id":"cmiguul8v001jujz3enh4fvtk","_id":"cmiguul8x0020ujz32bzqaj9n"},{"post_id":"cmiguul8w001wujz3h7n3dga7","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8x0025ujz363lo9kbf"},{"post_id":"cmiguul8u000uujz3czao26pv","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8x0029ujz32y6c45h2"},{"post_id":"cmiguul8w001zujz31yai962a","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8x002cujz3d3ny3vos"},{"post_id":"cmiguul8x0022ujz30hdldfmo","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8x002fujz3fx1u9spg"},{"post_id":"cmiguul8u000wujz37g866fha","category_id":"cmiguul8v001jujz3enh4fvtk","_id":"cmiguul8x002hujz3fe967pu5"},{"post_id":"cmiguul8x0024ujz3hu0neq3s","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8x002kujz391mf293l"},{"post_id":"cmiguul8x0028ujz3fww8bi9t","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8y002mujz36tbpejni"},{"post_id":"cmiguul8u0012ujz3eejm2v5o","category_id":"cmiguul8v001jujz3enh4fvtk","_id":"cmiguul8y002pujz3b7a35020"},{"post_id":"cmiguul8v0018ujz3drfd4cgv","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8y002qujz38rszdekd"},{"post_id":"cmiguul8v001cujz30jbvba0m","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8y002uujz3859fhs02"},{"post_id":"cmiguul8v001fujz3ceq92627","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8y002xujz3hfw5608o"},{"post_id":"cmiguul8v001iujz3eiv15r7k","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8y0030ujz3bkj35ag2"},{"post_id":"cmiguul8w001lujz3132c45x5","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8y0034ujz34u556346"},{"post_id":"cmiguul8w001nujz3b6di2wfv","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8y0038ujz36l712xlb"},{"post_id":"cmiguul8w001tujz3a45x7jgi","category_id":"cmiguul8w001uujz379ppgnoz","_id":"cmiguul8y003bujz32j1nbo3z"},{"post_id":"cmiguul8x002bujz39ky59nis","category_id":"cmiguul8y0037ujz3958wh7t8","_id":"cmiguul8y003eujz394ua6wfy"},{"post_id":"cmiguul8z003qujz369dofmxc","category_id":"cmiguul90003sujz35hexfwfu","_id":"cmiguul900042ujz3f1bwfdck"},{"post_id":"cmiguul8z003rujz3bti19jlv","category_id":"cmiguul90003xujz3dmc94s2y","_id":"cmiguul910049ujz30fszgleu"},{"post_id":"cmiguul90003uujz373ab4rfb","category_id":"cmiguul90003sujz35hexfwfu","_id":"cmiguul91004cujz38n0v8wgf"},{"post_id":"cmiguul90003vujz3cpmn8e7w","category_id":"cmiguul910048ujz3dpn3e4h5","_id":"cmiguul91004hujz3hw2ndbmq"},{"post_id":"cmiguul90003wujz36e4f1jpn","category_id":"cmiguul910048ujz3dpn3e4h5","_id":"cmiguul91004kujz39t5w0fc1"},{"post_id":"cmiguul900040ujz3bi7q4btx","category_id":"cmiguul91004gujz36aujff26","_id":"cmiguul91004oujz3fvdfh7dk"},{"post_id":"cmiguul910045ujz35y2hhxu0","category_id":"cmiguul91004lujz31s6paruo","_id":"cmiguul91004sujz3c8tn6jd5"},{"post_id":"cmiguul910047ujz3ciq03zor","category_id":"cmiguul91004pujz3hnnk3zrb","_id":"cmiguul91004uujz3d7rt1r83"},{"post_id":"cmjgyvrnq0000kd0vfacdej24","category_id":"cmiguul8r0004ujz3hx7p5yy1","_id":"cmjgyvrnx0002kd0v95wxh9u1"},{"post_id":"cmjgyvrny0005kd0v3qd2d0zi","category_id":"cmiguul910048ujz3dpn3e4h5","_id":"cmjgyvrnz0008kd0v4ewjfaog"},{"post_id":"cmjgyvrny0004kd0v4efwalqi","category_id":"cmjgyvrny0006kd0vh83529uf","_id":"cmjgyvrnz000bkd0v1lju8ufz"},{"post_id":"cmjjms65y0000m20vh6jzc8yi","category_id":"cmjjms6610001m20v54rk2ldo","_id":"cmjjms6660004m20v64l7awyg"},{"post_id":"cmk6b1k2v0000qg0vczvw7kgs","category_id":"cmk6b1k2x0001qg0v7jju56s8","_id":"cmk6b1k2z0004qg0vcw4le4yv"}],"PostTag":[{"post_id":"cmiguul8q0001ujz3g2zy32ge","tag_id":"cmiguul8r0005ujz350wf4mlm","_id":"cmiguul8t000cujz3h63s0wrk"},{"post_id":"cmiguul8r0003ujz3bl4z8g3f","tag_id":"cmiguul8s000bujz35rp80d92","_id":"cmiguul8t000jujz3bzui8q9d"},{"post_id":"cmiguul8s0007ujz36okt0kms","tag_id":"cmiguul8t000hujz3esla5ih9","_id":"cmiguul8u000pujz30ecaa4t7"},{"post_id":"cmiguul8s0009ujz37gh9hrxz","tag_id":"cmiguul8u000nujz3hye09ixk","_id":"cmiguul8u000vujz312q2923o"},{"post_id":"cmiguul8t000dujz3d3skh9w2","tag_id":"cmiguul8u000tujz3fbxq69x1","_id":"cmiguul8u0011ujz3b2nqhntu"},{"post_id":"cmiguul8u000zujz3fw7g80ha","tag_id":"cmiguul8t000hujz3esla5ih9","_id":"cmiguul8v0015ujz38d2s4rsk"},{"post_id":"cmiguul8t000eujz3fle61rzw","tag_id":"cmiguul8u0010ujz35bmxaa32","_id":"cmiguul8v001aujz3dmep5n5v"},{"post_id":"cmiguul8t000iujz39p534luh","tag_id":"cmiguul8v0017ujz3d6e76rst","_id":"cmiguul8v001gujz3g5t28ld8"},{"post_id":"cmiguul8t000kujz3ceolcim4","tag_id":"cmiguul8u0010ujz35bmxaa32","_id":"cmiguul8w001mujz3gosvb7pa"},{"post_id":"cmiguul8u000oujz360wfc01w","tag_id":"cmiguul8w001kujz36m7y7r3h","_id":"cmiguul8w001sujz399pwg8a3"},{"post_id":"cmiguul8u000qujz33mc8f32g","tag_id":"cmiguul8w001qujz393vn97z7","_id":"cmiguul8w001yujz338rb6ar5"},{"post_id":"cmiguul8u000uujz3czao26pv","tag_id":"cmiguul8w001xujz3gah3et1d","_id":"cmiguul8x0026ujz3aankcrh1"},{"post_id":"cmiguul8u000wujz37g866fha","tag_id":"cmiguul8w001kujz36m7y7r3h","_id":"cmiguul8x002dujz352iecxtt"},{"post_id":"cmiguul8u0012ujz3eejm2v5o","tag_id":"cmiguul8x002aujz3e61mepu1","_id":"cmiguul8x002iujz30sl76oa8"},{"post_id":"cmiguul8v0018ujz3drfd4cgv","tag_id":"cmiguul8x002gujz3gug1gq43","_id":"cmiguul8y002oujz39w7229wt"},{"post_id":"cmiguul8v001cujz30jbvba0m","tag_id":"cmiguul8x002lujz381mbg10v","_id":"cmiguul8y002tujz36cu85ivt"},{"post_id":"cmiguul8v001fujz3ceq92627","tag_id":"cmiguul8y002rujz31qm25sjs","_id":"cmiguul8y002yujz36khlexs8"},{"post_id":"cmiguul8v001iujz3eiv15r7k","tag_id":"cmiguul8y002vujz381e5638z","_id":"cmiguul8y0032ujz3a83tbutg"},{"post_id":"cmiguul8w001lujz3132c45x5","tag_id":"cmiguul8y0031ujz35a8d1i8y","_id":"cmiguul8y0036ujz3ca776lbq"},{"post_id":"cmiguul8w001nujz3b6di2wfv","tag_id":"cmiguul8y0035ujz3hjzreppm","_id":"cmiguul8y003aujz3hs020wzk"},{"post_id":"cmiguul8w001tujz3a45x7jgi","tag_id":"cmiguul8y0039ujz3ehbn2y7d","_id":"cmiguul8y003dujz3g7896lci"},{"post_id":"cmiguul8w001wujz3h7n3dga7","tag_id":"cmiguul8y0039ujz3ehbn2y7d","_id":"cmiguul8y003gujz32l6fhv00"},{"post_id":"cmiguul8w001zujz31yai962a","tag_id":"cmiguul8y003fujz34wp20aax","_id":"cmiguul8y003iujz30amy8ta8"},{"post_id":"cmiguul8x0022ujz30hdldfmo","tag_id":"cmiguul8y003hujz38adja5fr","_id":"cmiguul8y003kujz337kwdeov"},{"post_id":"cmiguul8x0024ujz3hu0neq3s","tag_id":"cmiguul8y0035ujz3hjzreppm","_id":"cmiguul8y003mujz395vb2zzx"},{"post_id":"cmiguul8x0028ujz3fww8bi9t","tag_id":"cmiguul8y003hujz38adja5fr","_id":"cmiguul8y003oujz344i0ax9q"},{"post_id":"cmiguul8x002bujz39ky59nis","tag_id":"cmiguul8y003nujz311vf1rux","_id":"cmiguul8y003pujz3b0d17vqv"},{"post_id":"cmiguul8z003qujz369dofmxc","tag_id":"cmiguul90003tujz33ikk0k3a","_id":"cmiguul90003zujz3aq5h94zk"},{"post_id":"cmiguul8z003rujz3bti19jlv","tag_id":"cmiguul90003yujz3bbpo0dzj","_id":"cmiguul910046ujz36sqs82ni"},{"post_id":"cmiguul90003uujz373ab4rfb","tag_id":"cmiguul910044ujz341fj3oqa","_id":"cmiguul91004bujz3427gg57d"},{"post_id":"cmiguul90003vujz3cpmn8e7w","tag_id":"cmiguul91004aujz32q8fbu77","_id":"cmiguul91004fujz30otogl6u"},{"post_id":"cmiguul90003wujz36e4f1jpn","tag_id":"cmiguul91004eujz3gxgv7v00","_id":"cmiguul91004jujz31dxr7d81"},{"post_id":"cmiguul900040ujz3bi7q4btx","tag_id":"cmiguul91004iujz32xym23n8","_id":"cmiguul91004nujz3hlav7ael"},{"post_id":"cmiguul910045ujz35y2hhxu0","tag_id":"cmiguul91004mujz3647f7uh9","_id":"cmiguul91004rujz39hm2aklq"},{"post_id":"cmiguul910047ujz3ciq03zor","tag_id":"cmiguul91004qujz34fow00j7","_id":"cmiguul91004tujz38skw8wub"},{"post_id":"cmjgyvrnq0000kd0vfacdej24","tag_id":"cmjgyvrnt0001kd0v3daag2fv","_id":"cmjgyvrnx0003kd0vcp81bkjr"},{"post_id":"cmjgyvrny0004kd0v4efwalqi","tag_id":"cmjgyvrny0007kd0vhdva192l","_id":"cmjgyvrnz000akd0v2uwhe8gc"},{"post_id":"cmjgyvrny0005kd0v3qd2d0zi","tag_id":"cmjgyvrnz0009kd0v5kvp4uez","_id":"cmjgyvrnz000ckd0v2oj6fksf"},{"post_id":"cmjjms65y0000m20vh6jzc8yi","tag_id":"cmjjms6650002m20v31a087co","_id":"cmjjms6660003m20v15wnalcg"},{"post_id":"cmk6b1k2v0000qg0vczvw7kgs","tag_id":"cmk6b1k2y0002qg0v1i2c450v","_id":"cmk6b1k2z0003qg0v1tnvgtbu"}],"Tag":[{"name":"并发","_id":"cmiguul8r0005ujz350wf4mlm"},{"name":"JNI","_id":"cmiguul8s000bujz35rp80d92"},{"name":"学习笔记","_id":"cmiguul8t000hujz3esla5ih9"},{"name":"docker部署","_id":"cmiguul8u000nujz3hye09ixk"},{"name":"k8s","_id":"cmiguul8u000tujz3fbxq69x1"},{"name":"chrome","_id":"cmiguul8u0010ujz35bmxaa32"},{"name":"命令","_id":"cmiguul8v0017ujz3d6e76rst"},{"name":"备份","_id":"cmiguul8w001kujz36m7y7r3h"},{"name":"事务","_id":"cmiguul8w001qujz393vn97z7"},{"name":"docker","_id":"cmiguul8w001xujz3gah3et1d"},{"name":"表设计","_id":"cmiguul8x002aujz3e61mepu1"},{"name":"git","_id":"cmiguul8x002gujz3gug1gq43"},{"name":"常用命令","_id":"cmiguul8x002lujz381mbg10v"},{"name":"开机自启","_id":"cmiguul8y002rujz31qm25sjs"},{"name":"报警","_id":"cmiguul8y002vujz381e5638z"},{"name":"查找进程","_id":"cmiguul8y0031ujz35a8d1i8y"},{"name":"nginx","_id":"cmiguul8y0035ujz3hjzreppm"},{"name":"openvpn","_id":"cmiguul8y0039ujz3ehbn2y7d"},{"name":"网络","_id":"cmiguul8y003fujz34wp20aax"},{"name":"扩容磁盘","_id":"cmiguul8y003hujz38adja5fr"},{"name":"翻墙","_id":"cmiguul8y003nujz311vf1rux"},{"name":"账户资金","_id":"cmiguul90003tujz33ikk0k3a"},{"name":"lua表达式","_id":"cmiguul90003yujz3bbpo0dzj"},{"name":"交易策略","_id":"cmiguul910044ujz341fj3oqa"},{"name":"状态机","_id":"cmiguul91004aujz32q8fbu77"},{"name":"打印异常日志","_id":"cmiguul91004eujz3gxgv7v00"},{"name":"网站资源","_id":"cmiguul91004iujz32xym23n8"},{"name":"漏洞","_id":"cmiguul91004mujz3647f7uh9"},{"name":"自学公式","_id":"cmiguul91004qujz34fow00j7"},{"name":"傲人的写法","_id":"cmjgyvrnt0001kd0v3daag2fv"},{"name":"实时数据同步","_id":"cmjgyvrny0007kd0vhdva192l"},{"name":"grafana,prometheus,springboot","_id":"cmjgyvrnz0009kd0v5kvp4uez"},{"name":"冷知识","_id":"cmjjms6650002m20v31a087co"},{"name":"RSocket高性能TCP多路复用","_id":"cmk6b1k2y0002qg0v1i2c450v"}]}}